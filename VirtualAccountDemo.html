<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BankB Ebank | Virtual Account Management v2.1</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bankb: {
                            primary: '#006B68', // BankB Green
                            accent: '#FFC62F',  // BankB Yellow
                            red: '#D0202E',     // BankB Red
                        }
                    }
                }
            }
        }
    </script>
    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Ensure React and ReactDOM are available
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect, useMemo } = React;
        
        // --- TRANSLATION RESOURCES ---
        const resources = {
            vi: {
                app_name: "BankB Ebank",
                app_name_full: "BankB Ebank | Virtual Account v2.1",
                subtitle: "QL Tài khoản định danh",
                welcome: "Xin chào",
                reset_demo: "Reset Dữ Liệu",
                menu: {
                    dashboard: "Tổng Quan",
                    onboarding: "Hồ Sơ Doanh Nghiệp",
                    lifecycle: "Quản Lý VA (N Cấp)",
                    identifiers: "Định Danh & Routing",
                    transactions_group: "Giao dịch VA",
                    tx_incoming: "Nạp tiền vào VA",
                    tx_outgoing: "Chi tiền từ VA",
                    tx_internal: "Điều Chuyển (Internal)",
                    reports: "Báo Cáo",
                    reconciliation: "Đối Soát & Xử Lý", 
                    guide: "Hướng Dẫn & Quy Trình"
                },
                dashboard: {
                    title: "Dashboard Tổng Quan",
                    total_real: "Tổng Số Dư Thực (Real)",
                    total_rollup: "Tổng Số Dư Roll-up (Root)",
                    active_vas: "VA Hoạt động",
                    tx_today: "Giao dịch hôm nay",
                    dda_info: "Tài khoản thực (DDA)",
                    account_no: "Số Tài Khoản",
                    cif: "CIF",
                    real_balance: "Số Dư Thực",
                    status: "Trạng Thái"
                },
                reconciliation: {
                    title: "Đối Soát Số Liệu (Reconciliation)",
                    desc: "Màn hình này so sánh số dư thực tế tại Core Banking (DDA) và tổng số dư chi tiết của các tài khoản ảo (VA Ledger) để phát hiện chênh lệch.",
                    card_dda: "SỐ DƯ DDA (CORE)",
                    card_va: "TỔNG SỐ DƯ VA (LEDGER)",
                    card_diff: "CHÊNH LỆCH (DELTA)",
                    status_matched: "KHỚP ĐÚNG",
                    status_unmatched: "LỆCH SỐ LIỆU",
                    simulate_btn: "Giả lập lệch (Nạp tiền vào DDA nhưng mất tin)",
                    fix_btn: "Tự động xử lý (Auto-Adjustment)",
                    detail_table: "Chi Tiết Đối Soát Theo DDA Master",
                    col_dda_acc: "TK Master",
                    col_core_bal: "Số Dư Core",
                    col_va_bal: "Tổng Dư VA",
                    col_diff: "Chênh Lệch",
                    col_status: "Trạng Thái",
                    col_action: "Hành Động"
                },
                onboarding: {
                    title: "Hồ Sơ Doanh Nghiệp",
                    cif_label: "Mã CIF (Core)",
                    name_label: "Tên Doanh Nghiệp",
                    corp_id_label: "Corporate ID",
                    segment_label: "Phân khúc",
                    dda_list: "DS Tài khoản DDA",
                    edit: "Chỉnh Sửa",
                    save: "Lưu"
                },
                lifecycle: {
                    title: "Cây Phân Cấp VA & Số Dư",
                    add_btn: "Thêm VA",
                    table_code: "Mã VA",
                    table_name: "Tên TK",
                    table_real_bal: "Số Dư Thực (Own)",
                    table_rollup_bal: "Số Dư Cộng Dồn (Roll-up)",
                    table_status: "TT",
                    table_dda: "DDA Liên Kết",
                    table_meta: "Metadata",
                    modal_title_create: "Tạo Virtual Account Mới",
                    modal_title_edit: "Cập Nhật Virtual Account",
                    modal_parent: "VA Cha",
                    modal_dda: "Liên kết DDA (Master Account)",
                    modal_meta_title: "METADATA",
                    btn_cancel: "Hủy",
                    btn_create: "Tạo",
                    btn_update: "Cập Nhật",
                    action_edit: "Sửa"
                },
                identifiers: {
                    map_title: "Map Định Danh",
                    type_label: "Loại",
                    value_label: "Giá Trị",
                    target_va_label: "Map vào VA nào?",
                    btn_add: "Thêm Map",
                    btn_update: "Cập Nhật",
                    list_title: "DS Routing Rules",
                    table_action: "Hành Động",
                    action_edit: "Sửa",
                    action_delete: "Xóa"
                },
                transactions: {
                    title_incoming: "Giao Dịch Nạp Tiền Vào VA",
                    title_outgoing: "Giao Dịch Chi Tiền Từ VA",
                    title_internal: "Điều Chuyển Nội Bộ / Cấp Vốn",
                    desc_incoming: "Bổ sung giao dịch thu (Shadow Credit).",
                    desc_outgoing: "Bổ sung giao dịch chi (Shadow Debit).",
                    desc_internal: "Điều chuyển tiền giữa các VA.",
                    routing_content: "Nội dung GD (Reference)",
                    va_label: "Tài Khoản Ảo",
                    amount_label: "Số Tiền",
                    beneficiary_label: "Thụ Hưởng",
                    payment_content: "Nội dung chi",
                    btn_credit: "Ghi Có (Shadow Credit)",
                    btn_debit: "Lập Lệnh Chi (POBO)",
                    btn_transfer: "Thực Hiện Điều Chuyển",
                    history_title: "Lịch sử Giao dịch",
                    table_time: "TG",
                    table_type: "Loại",
                    table_content: "Nội dung",
                    mode_vava: "Nội bộ (VA ↔ VA)",
                    mode_ddava: "Cấp/Thu Vốn (DDA ↔ VA)",
                    source_va: "VA Nguồn (Chuyển đi)",
                    dest_va: "VA Đích (Nhận tiền)",
                    source_dda: "DDA Nguồn (Tài khoản thực)",
                    dest_dda: "DDA Đích",
                    direction: "Hướng Điều Chuyển",
                    dir_fund: "Cấp Vốn (DDA → VA)",
                    dir_sweep: "Thu Hồi (VA → DDA)",
                    bal_hint: "Dư thực: "
                },
                reports: {
                    summary_title: "Báo Cáo Tổng Hợp",
                    statement_title: "Tra Cứu Sao Kê",
                    select_va: "Chọn Tài Khoản VA",
                    include_child: "Gộp giao dịch cấp dưới (Roll-up)",
                    level: "Cấp",
                    total_in: "Tổng Thu",
                    total_out: "Tổng Chi",
                    no_tx: "Không có giao dịch nào trong kỳ."
                },
                guide: {
                    title: "Hướng Dẫn & Quy Trình",
                    intro_text: "Phiên bản v2.1 bổ sung chức năng Đối soát (Reconciliation) để phát hiện và xử lý chênh lệch số dư.",
                    glossary_title: "Giải Thích Thuật Ngữ",
                    guide_title: "Quy Trình Xử Lý Giao Dịch Chi Tiết",
                    tech_title: "Cơ Chế Quản Lý Số Dư Kép",
                    dual_balance: {
                        why_title: "Tại sao cần 2 loại số dư?",
                        why_desc: "Quản lý dòng tiền tập trung yêu cầu tách biệt tiền thực (Real) và quyền hạn (Roll-up).",
                        real_title: "1. Số dư thực (Real Balance)",
                        real_desc: "Số dư hiển thị khi sao kê.",
                        rollup_title: "2. Số dư cộng dồn (Roll-up Balance)",
                        rollup_desc: "Tổng nguồn lực quản trị."
                    },
                    legacy_process: {
                        title: "BÁO CÁO TÓM TẮT: QUY TRÌNH THANH TOÁN LIÊN NGÂN HÀNG 247 (VA & ALIAS)",
                        def_title: "1. ĐỊNH NGHĨA VÀ PHẠM VI",
                        def_intro: "Trước khi đi vào quy trình, cần phân biệt rõ hai đối tượng tài khoản được xử lý:",
                        def_items: [
                            { term: "Alias (Bí danh)", desc: "Là dãy số/chữ được chủ tài khoản dùng thay thế cho số tài khoản thực trong giao dịch.", sub: "Đặc điểm: Chỉ đóng vai trò 'mặt nạ' định danh. Giao dịch chuyển đến Alias là giao dịch chuyển tiền thông thường, không có quy trình xử lý gạch nợ phía sau." },
                            { term: "Virtual Account (VA - Tài khoản ảo)", desc: "Là tài khoản quản trị logic (không tồn tại vật lý trong Core Banking) được tạo bởi hệ thống VA Engine.", sub: "Mục đích: Phân loại và theo dõi dòng tiền chi tiết theo từng thực thể con (dự án, hợp đồng, hộ kinh doanh...).\nCơ chế: VA được liên kết với một Tài khoản thực (Real Account). Giao dịch được ghi nhận qua cơ chế shadow posting, sử dụng bộ định danh ảo để tự động định tuyến, phục vụ đối soát và phân tích dòng tiền chuyên sâu." }
                        ],
                        flow_title: "2. QUY TRÌNH XỬ LÝ VIRTUAL ACCOUNT HIỆN TẠI",
                        flow_intro: "Quy trình này chia làm 2 giai đoạn chính: Giai đoạn Vấn tin (Kiểm tra thông tin) và Giai đoạn Hạch toán (Thực hiện giao dịch). Dưới đây là mô tả chi tiết theo luồng đi của dữ liệu:",
                        phases: [
                            {
                                name: "GIAI ĐOẠN 1: VẤN TIN (Kiểm tra thông tin người thụ hưởng)",
                                purpose: "Mục đích: Xác thực thông tin tài khoản đích và số tiền trước khi chuyển.",
                                steps: [
                                    "Bước 1: Khởi tạo:\nKhách hàng tại Ngân hàng ngoài (NH chuyển) bắt đầu thực hiện giao dịch chuyển tiền 247. Họ nhập thông tin tài khoản thụ hưởng và yêu cầu vấn tin.",
                                    "Bước 2: Kiểm tra định dạng (Tại Chương trình 247):\nHệ thống tiếp nhận yêu cầu và kiểm tra định dạng tài khoản hưởng.\n- Nếu là tài khoản thường -> Chuyển luồng Core Banking.\n- Nếu là VA/Alias -> Chuyển sang hệ thống Paygate.",
                                    "Bước 3: Xử lý tại Paygate:\nPaygate kiểm tra loại tài khoản và bóc tách thông tin.\n- Nếu là VA: Gửi yêu cầu sang NCCDV/Kho dữ liệu lấy thông tin cước.\n- Nếu là Alias: Phản hồi tên và số DDA liên kết.",
                                    "Bước 4: Tổng hợp thông tin (Tại Chương trình 247):\n- Gọi Core Banking truy vấn trạng thái DDA liên kết.\n- Lưu thông tin tạm thời (Cache): Tên người hưởng, số tiền, Billid (với VA)...",
                                    "Bước 5: Phản hồi khách hàng:\nKết quả được gửi trả về Ngân hàng ngoài để khách hàng kiểm tra."
                                ]
                            },
                            {
                                name: "GIAI ĐOẠN 2: HẠCH TOÁN (Thực hiện chuyển tiền)",
                                purpose: "Mục đích: Ghi nhận dòng tiền và gạch nợ.",
                                steps: [
                                    "Bước 1: Xác nhận giao dịch:\nKhách hàng xác nhận. Yêu cầu hạch toán được gửi đi.",
                                    "Bước 2: Định tuyến lại (Tại Chương trình 247):\nKiểm tra lại định dạng. Nếu là VA/Alias -> Lấy lại thông tin Cache từ bước Vấn tin.",
                                    "Bước 3: Xử lý Hạch toán:\n- Nhánh Alias: Gửi lệnh vào Core để ghi CÓ trực tiếp vào DDA khách hàng.\n- Nhánh VA: Kiểm tra tham số (số tiền, nợ cước) -> Gửi lệnh ghi CÓ vào tài khoản chuyên thu của NCC tại Core.",
                                    "Bước 4: Gạch nợ và Hoàn tất:\n- Sau khi Core trả kết quả thành công:\n- Với VA: Hệ thống gửi yêu cầu sang NCCDV/Kho dữ liệu để Gạch nợ hóa đơn.\n- Ghi nhận thành công.",
                                    "Bước 5: Kết thúc:\nGửi kết quả cuối cùng về Ngân hàng ngoài."
                                ]
                            }
                        ],
                        summary: "Tóm tắt các hệ thống tham gia:\n- Ngân hàng ngoài: Nơi khởi tạo giao dịch.\n- Chương trình 247: Bộ điều phối chính, quyết định luồng đi (Router).\n- Paygate: Cổng xử lý logic cho VA/Alias, giao tiếp với đối tác.\n- Core Banking: Hệ thống lõi quản lý tài khoản tiền và hạch toán.\n- NCCDV/Kho dữ liệu: Hệ thống của đơn vị cung cấp dịch vụ lưu trữ hóa đơn."
                    },
                    new_feature_process: {
                        title: "3. TÍNH NĂNG VÀ QUY TRÌNH VIRTUAL ACCOUNT MỚI",
                        intro: "I. MÔ HÌNH 2 LỰA CHỌN GIAO DỊCH CHO DỊCH VỤ VIRTUAL ACCOUNT.\nKhi khách hàng đăng ký sử dụng VA, ngân hàng cung cấp hai lựa chọn giao dịch:",
                        options: [
                            {
                                name: "OPTION 1 – Giao dịch trực tiếp bằng số VA (Virtual Account)",
                                desc: "Khách hàng nhập số VA khi thực hiện giao dịch. Hệ thống sẽ kiểm tra VA trước, nếu hợp lệ mới cho phép thực hiện hạch toán thật vào tài khoản gốc (DDA).",
                                benefits: [
                                    "Nếu VA sai → giao dịch bị từ chối ngay.",
                                    "Mọi khoản tiền vào đều chắc chắn thuộc đúng VA.",
                                    "Tài khoản gốc (DDA) chỉ nhận các khoản tiền hợp lệ từ VA."
                                ],
                                suitable_for: "GPMB, thu ngân sách, dự án Nhà nước. Doanh nghiệp có yêu cầu quản lý dòng tiền chặt chẽ.",
                                flow_title: "Luồng xử lý Option 1 (VA-first)",
                                steps: [
                                    "Bước 1 – Kênh nhận giao dịch: Khách hàng nhập số VA (thay vì số DDA), số tiền và nội dung.",
                                    "Bước 2 – Kiểm tra VA: Hệ thống kiểm tra VA (tồn tại, hoạt động, hiệu lực, kênh...). Nếu không hợp lệ → báo lỗi ngay.",
                                    "Bước 3 – Hạch toán thật vào DDA: Nếu VA hợp lệ, xác định TK gốc và ghi có. Nếu lỗi → dừng.",
                                    "Bước 4 – Ghi sổ cho VA (shadow posting): Tạo bút toán ảo, cập nhật số dư VA và Roll-up."
                                ]
                            },
                            {
                                name: "OPTION 2 – Giao dịch bằng số DDA, VA xử lý sau dựa trên nội dung giao dịch (DDA-first)",
                                desc: "Khách hàng không nhập số VA, chỉ nhập số DDA như bình thường. Thông tin nhận diện VA sẽ nằm trong ghi chú/remark. Hệ thống chỉ thực hiện “VA hạch toán ảo” sau khi DDA đã nhận tiền.",
                                benefits: [
                                    "Không làm thay đổi thói quen doanh nghiệp.",
                                    "Vẫn giữ nguyên các luồng chuyển khoản liên ngân hàng.",
                                    "Tận dụng VA để tự động phân bổ giao dịch sau này."
                                ],
                                flow_title: "Luồng xử lý Option 2 (DDA-first)",
                                steps: [
                                    "Bước 1 – Kênh nhận giao dịch: Khách hàng chuyển tiền vào số DDA (có/không ghi chú).",
                                    "Bước 2 – Hạch toán thật vào DDA: Ghi có DDA như thường. Nếu lỗi → dừng.",
                                    "Bước 3 – Kiểm tra DDA có đăng ký dịch vụ VA hay không: Nếu có → tiếp tục, không → xong.",
                                    "Bước 4 – Xác định khoản tiền này thuộc VA nào: Đọc nội dung (mã hộ, hđ...), tìm VA. (4A: Tìm được -> B5; 4B: Không tìm được -> Chưa nhận diện; 4C: Nhiều VA -> Quy tắc ưu tiên).",
                                    "Bước 5 – Ghi sổ cho VA (shadow posting): Tạo bút toán ảo, cập nhật số dư, ghi lịch sử truy vết."
                                ]
                            }
                        ],
                        comparison_title: "III. Sơ đồ so sánh ngắn gọn hai lựa chọn",
                        comparison_table: {
                            headers: ["Nội dung", "Option 1 – Dùng VA", "Option 2 – Dùng DDA & remark"],
                            rows: [
                                ["Cách khách hàng nhập", "Nhập số VA", "Nhập số DDA"],
                                ["Kiểm tra VA", "Kiểm tra trước khi hạch toán", "Kiểm tra sau khi DDA nhận tiền"],
                                ["Đảm bảo đúng VA", "Rất cao", "Phụ thuộc vào ghi chú & quy tắc"],
                                ["Rủi ro không tìm được VA", "Không có", "Có (được đưa vào danh sách chờ xử lý)"],
                                ["Phù hợp cho", "Thu ngân sách, GPMB, kiểm soát chặt", "Doanh nghiệp quen dùng DDA, GD liên ngân hàng"],
                                ["Độ tương thích hệ thống", "Cần chỉnh giao diện kênh", "Hoàn toàn giữ nguyên giao diện hiện tại"]
                            ]
                        }
                    },
                    terms: {
                        RealBalance: "Số dư thực (Own Balance).",
                        RollupBalance: "Số dư cộng dồn (Roll-up Balance).",
                        VA: "Virtual Account.",
                        Reconciliation: "Đối soát. Quá trình so sánh số dư tổng hợp của VA với DDA Master."
                    },
                    processes: [
                        {
                            title: "1. Quy trình Onboarding (Thiết lập ban đầu)",
                            steps: [
                                "Bước 1 (Tại Quầy/Core): Mở mã CIF khách hàng doanh nghiệp và Tài khoản thanh toán (DDA) thực.",
                                "Bước 2 (Trên VA System - Menu 'Hồ Sơ Doanh Nghiệp'): Tạo hồ sơ doanh nghiệp mới, nhập CIF.",
                                "Bước 3: Liên kết (Link) các tài khoản DDA thực vào hệ thống VA để làm tài khoản Master (Tài khoản tổng).",
                                "Bước 4: Phân quyền user quản trị và phê duyệt hạn mức (nếu có)."
                            ]
                        },
                        {
                            title: "2. Quy trình Quản lý Cây Thư mục VA (VA Lifecycle)",
                            steps: [
                                "Bước 1 (Menu 'Quản Lý VA'): Tạo VA Gốc (Root) gắn với DDA Master.",
                                "Bước 2: Tạo các VA cấp con (Level 1, Level 2...) theo cơ cấu tổ chức (Phòng ban, Dự án, Chi nhánh).",
                                "Bước 3: Thiết lập Metadata cho từng VA (Mã dự án, Mã hợp đồng) để phục vụ định danh sau này."
                            ]
                        },
                        {
                            title: "3. Quy trình Định danh & Routing (Smart Mapper)",
                            steps: [
                                "Mục đích: Giúp hệ thống tự động nhận diện tiền vào VA nào dựa trên nội dung chuyển khoản.",
                                "Bước 1 (Menu 'Định Danh & Routing'): Chọn loại định danh (Mã số thuế, Số hợp đồng, Mã căn hộ...).",
                                "Bước 2: Nhập giá trị định danh (VD: HD-001) và chọn VA đích (VD: VA_Project_A).",
                                "Bước 3: Lưu quy tắc. Từ giờ, mọi món tiền vào DDA mẹ có nội dung chứa 'HD-001' sẽ tự động ghi có cho VA_Project_A."
                            ]
                        },
                        {
                            title: "4. Quy trình Giao dịch Tiền vào (Incoming Credit)",
                            steps: [
                                "Luồng tiền: Khách hàng chuyển tiền -> DDA Mẹ (Core) -> VA System.",
                                "Bước 1: Core Banking ghi có vào DDA Mẹ.",
                                "Bước 2: VA System nhận webhook/message từ Core.",
                                "Bước 3: Routing Engine phân tích nội dung -> Tìm thấy Rule đã map ở Mục 3.",
                                "Bước 4: Ghi tăng 'Số dư thực' (Real Balance) tại VA đích.",
                                "Bước 5: Ghi tăng 'Số dư cộng dồn' (Roll-up Balance) cho VA đích và toàn bộ VA cha."
                            ]
                        },
                        {
                            title: "5. Quy trình Chi hộ (Outgoing POBO)",
                            steps: [
                                "Luồng tiền: User lập lệnh từ VA -> Hệ thống trừ tiền DDA Mẹ -> Người thụ hưởng.",
                                "Bước 1 (Menu 'Chi Hộ'): Nhập thông tin thụ hưởng và số tiền.",
                                "Bước 2: Hệ thống kiểm tra 'Số dư thực' (Real Balance) của VA. Nếu đủ -> Tiếp tục.",
                                "Bước 3: Gửi lệnh Debit DDA Mẹ xuống Core Banking.",
                                "Bước 4: Nếu Core thành công -> Ghi giảm (Debit) số dư VA (cả Real và Roll-up)."
                            ]
                        },
                        {
                            title: "6. Quy trình Điều chuyển & Cấp vốn (Internal & Fund Mgt)",
                            steps: [
                                "Điều chuyển nội bộ (VA <-> VA): Chuyển tiền ảo giữa các VA. Chỉ thay đổi số dư VA, không sinh giao dịch trên DDA mẹ.",
                                "Cấp vốn (DDA -> VA): Phân bổ hạn mức từ Quỹ chung (DDA) xuống VA con để chi tiêu.",
                                "Thu vốn (VA -> DDA): Gom tiền từ VA con về Quỹ chung (Sweep)."
                            ]
                        },
                        {
                            title: "7. Báo cáo & Đối soát (Reconciliation)",
                            steps: [
                                "Báo cáo Sao kê (Statement): Liệt kê chi tiết giao dịch của từng VA (giống tài khoản thật).",
                                "Báo cáo Tổng hợp (Summary): Xem tổng số dư Roll-up theo từng cấp.",
                                "Đối soát cuối ngày: Tổng số dư Real của tất cả VA con phải bằng (=) Số dư thực tế trên DDA Mẹ tại Core."
                            ]
                        }
                    ]
                }
            },
            en: {
                app_name: "BankB Ebank",
                app_name_full: "BankB Ebank | Virtual Account v2.1",
                subtitle: "Virtual Account System",
                welcome: "Hi",
                reset_demo: "Reset Data",
                menu: {
                    dashboard: "Dashboard",
                    onboarding: "Corp Profile",
                    lifecycle: "VA Management",
                    identifiers: "Routing",
                    transactions_group: "Shadow Transactions",
                    tx_incoming: "Funds Top-up to VA",
                    tx_outgoing: "Payout from VA",
                    tx_internal: "Internal Transfer",
                    reports: "Reports",
                    reconciliation: "Reconciliation",
                    guide: "Guide & Process"
                },
                dashboard: {
                    title: "Dashboard",
                    total_real: "Total Real Bal",
                    total_rollup: "Total Roll-up Bal",
                    active_vas: "Active VAs",
                    tx_today: "Tx Today",
                    dda_info: "Real Account (DDA)",
                    account_no: "Acct No",
                    cif: "CIF",
                    real_balance: "Real Bal",
                    status: "Status"
                },
                reconciliation: {
                    title: "Reconciliation & Adjustment",
                    desc: "This screen compares the actual balance at Core Banking (DDA) with the aggregated detailed balances of Virtual Accounts (VA Ledger) to detect discrepancies.",
                    card_dda: "DDA BALANCE (CORE)",
                    card_va: "TOTAL VA BALANCE (LEDGER)",
                    card_diff: "DIFFERENCE (DELTA)",
                    status_matched: "MATCHED",
                    status_unmatched: "DISCREPANCY",
                    simulate_btn: "Simulate Error (Credit DDA only)",
                    fix_btn: "Auto-Reconcile",
                    detail_table: "Reconciliation Details by Master DDA",
                    col_dda_acc: "Master Account",
                    col_core_bal: "Core Balance",
                    col_va_bal: "Aggregated VA Bal",
                    col_diff: "Difference",
                    col_status: "Status",
                    col_action: "Action"
                },
                onboarding: {
                    title: "Corporate Profile",
                    cif_label: "CIF Code",
                    name_label: "Corp Name",
                    corp_id_label: "Corp ID",
                    segment_label: "Segment",
                    dda_list: "Linked DDA",
                    edit: "Edit",
                    save: "Save"
                },
                lifecycle: {
                    title: "VA Hierarchy & Balances",
                    add_btn: "Add VA",
                    table_code: "Code",
                    table_name: "Name",
                    table_real_bal: "Real Balance",
                    table_rollup_bal: "Roll-up Balance",
                    table_status: "Sts",
                    table_dda: "Linked DDA",
                    table_meta: "Meta",
                    modal_title_create: "Create New VA",
                    modal_title_edit: "Edit Virtual Account",
                    modal_parent: "Parent",
                    modal_dda: "Link DDA (Master)",
                    modal_meta_title: "META",
                    btn_cancel: "Cancel",
                    btn_create: "Create",
                    btn_update: "Update",
                    action_edit: "Edit"
                },
                identifiers: {
                    map_title: "Map ID",
                    type_label: "Type",
                    value_label: "Value",
                    target_va_label: "Target VA",
                    btn_add: "Add",
                    btn_update: "Update",
                    list_title: "Rules",
                    table_action: "Act",
                    action_edit: "Edit",
                    action_delete: "Del"
                },
                transactions: {
                    title_incoming: "Funds Top-up to VA Transaction",
                    title_outgoing: "Payout from VA Transaction",
                    title_internal: "Internal / Allocation",
                    desc_incoming: "Add missing incoming transactions (shadow posting).",
                    desc_outgoing: "Add missing outgoing transactions (shadow posting).",
                    desc_internal: "Transfer funds between VAs.",
                    routing_content: "Routing Ref",
                    va_label: "Target VA",
                    amount_label: "Amount",
                    beneficiary_label: "Bene",
                    payment_content: "Desc",
                    btn_credit: "Credit",
                    btn_debit: "Debit",
                    btn_transfer: "Execute Transfer",
                    history_title: "History",
                    table_time: "Time",
                    table_type: "Type",
                    table_content: "Desc",
                    mode_vava: "VA to VA",
                    mode_ddava: "DDA <-> VA",
                    source_va: "Source VA",
                    dest_va: "Dest VA",
                    source_dda: "Source DDA",
                    dest_dda: "Dest DDA",
                    direction: "Direction",
                    dir_fund: "Allocation (DDA -> VA)",
                    dir_sweep: "Sweep (VA -> DDA)",
                    bal_hint: "Real: "
                },
                reports: {
                    summary_title: "Summary Rpt",
                    statement_title: "Statement Lookup",
                    select_va: "Select Account",
                    include_child: "Include Child Txs",
                    level: "Lvl",
                    total_in: "In",
                    total_out: "Out",
                    no_tx: "No transactions found."
                },
                guide: {
                    title: "User Guide & Process",
                    intro_text: "Version v2.1 adds Reconciliation features to detect and handle balance discrepancies.",
                    glossary_title: "Glossary",
                    guide_title: "Transaction Logic Flows",
                    tech_title: "Dual Balance Mechanism",
                    dual_balance: {
                        why_title: "Why 2 types of balances?",
                        why_desc: "Separate Real Balance (actual) and Roll-up Balance (authority).",
                        real_title: "1. Real Balance",
                        real_desc: "Shown on statement.",
                        rollup_title: "2. Roll-up Balance",
                        rollup_desc: "Total resources."
                    },
                    legacy_process: { 
                        title: "INTERBANK 247 PAYMENT PROCESS",
                        def_title: "1. DEFINITION",
                        def_intro: "Alias vs VA.",
                        def_items: [],
                        flow_title: "2. PROCESS",
                        flow_intro: "Inquiry -> Posting.",
                        phases: [],
                        summary: ""
                    },
                    // Placeholder for new feature in EN
                    new_feature_process: {
                        title: "3. NEW VIRTUAL ACCOUNT FEATURES & PROCESS",
                        intro: "I. TWO TRANSACTION MODELS FOR VIRTUAL ACCOUNT SERVICE",
                        options: [
                            {
                                name: "OPTION 1 – Transaction via VA Number (VA-first)",
                                desc: "Customer inputs VA number. System validates VA before crediting Real Account (DDA).",
                                benefits: ["Rejects invalid VA immediately.", "Ensures correct routing.", "Clean DDA ledger."],
                                suitable_for: "State budget, strict cash flow control.",
                                flow_title: "Option 1 Flow (VA-first)",
                                steps: ["Input VA", "Validate VA", "Credit DDA", "Shadow Post to VA"]
                            },
                            {
                                name: "OPTION 2 – Transaction via DDA Number (DDA-first)",
                                desc: "Customer inputs DDA number. VA logic is applied after DDA is credited based on remarks.",
                                benefits: ["No behavior change.", "Standard interbank flow.", "Post-processing allocation."],
                                flow_title: "Option 2 Flow (DDA-first)",
                                steps: ["Input DDA", "Credit DDA", "Check VA Registry", "Identify VA from Remark", "Shadow Post to VA"]
                            }
                        ],
                        comparison_title: "III. Comparison",
                        comparison_table: {
                            headers: ["Content", "Option 1 (VA)", "Option 2 (DDA)"],
                            rows: [
                                ["Input", "VA Number", "DDA Number"],
                                ["Validation", "Pre-posting", "Post-posting"],
                                ["Accuracy", "High", "Dependent on Remark"]
                            ]
                        }
                    },
                    terms: {
                        RealBalance: "Real Balance (Own Funds).",
                        RollupBalance: "Roll-up Balance.",
                        VA: "Virtual Account.",
                        Reconciliation: "Comparing aggregated VA balances vs Master DDA."
                    },
                    processes: [
                        {
                            title: "End-of-Day Reconciliation Process",
                            steps: [
                                "Step 1: System fetches EOD balance of Master DDA from Core.",
                                "Step 2: System sums 'Real Balance' of all child VAs.",
                                "Step 3: Compare: If DDA = Sum VA => Matched.",
                                "Step 4: If Unmatched => Check for Suspense transactions or dropped packets.",
                                "Step 5: Execute Adjustment entry to Suspense VA to balance books."
                            ]
                        }
                    ]
                }
            }
        };

        // --- ICONS ---
        const Icons = {
            LayoutDashboard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Building2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>,
            GitFork: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><circle cx="18" cy="6" r="3"/><path d="M18 9v1a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V9"/><path d="M12 12v3"/></svg>,
            Tag: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l5 5a2 2 0 0 0 2.828 0l7.172-7.172a2 2 0 0 0 0-2.828z"/><path d="M7 7h.01"/></svg>,
            ArrowRightLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></svg>,
            FileBarChart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 18v-1"/><path d="M12 18v-6"/><path d="M16 18v-3"/></svg>,
            Wallet: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            CheckCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>,
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            BookOpen: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Globe: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Menu: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Filter: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            Repeat: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>,
            Info: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            ChevronDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            ArrowDownRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m7 7 10 10"/><path d="M17 7v10H7"/></svg>,
            ArrowUpRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 17 17 7"/><path d="M7 7h10v10"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Layers: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Scale: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
            AlertTriangle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        };

        const IconWrapper = ({ name, size = 18, className = "" }) => {
            const IconComp = Icons[name] || Icons.Activity;
            return <IconComp width={size} height={size} className={className} />;
        };

        // --- UTILITIES ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatDate = (date) => new Date(date).toLocaleDateString('vi-VN') + ' ' + new Date(date).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
        const loadState = (key, initialValue) => {
            try { return localStorage.getItem(key) ? JSON.parse(localStorage.getItem(key)) : initialValue; } 
            catch { return initialValue; }
        };
        const saveState = (key, value) => localStorage.setItem(key, JSON.stringify(value));

        // Helper: Get path to root (Ancestors + Self)
        const getPathToRoot = (vaId, allVas) => {
            const path = [];
            let current = allVas.find(v => v.id === vaId);
            while (current) {
                path.push(current);
                if (!current.parentId) break;
                current = allVas.find(v => v.id === current.parentId);
            }
            return path;
        };

        // Helper: Get all descendants
        const getDescendants = (vaId, allVas) => {
            let descendants = [];
            const directChildren = allVas.filter(v => v.parentId === vaId);
            descendants = [...directChildren];
            directChildren.forEach(child => {
                descendants = [...descendants, ...getDescendants(child.id, allVas)];
            });
            return descendants;
        };

        // --- MOCK INITIAL DATA ---
        const initialCorporate = {
            id: 'CORP001',
            cif: 'CIF888999',
            name: 'TỔNG CÔNG TY XÂY DỰNG ĐS',
            segment: 'CORPORATE',
            ddaAccounts: [
                { id: 'DDA001', accountNo: '11110000123456', balance: 25000000000, currency: 'VND' }, // Matches Sum of VAs initially
                { id: 'DDA002', accountNo: '22220000987654', balance: 15000000000, currency: 'VND' }
            ]
        };

        const initialVAs = [
            { id: 'VA_ROOT', code: 'VA000', name: 'TK Tổng Tập Đoàn', parentId: null, level: 0, realBalance: 15000000000, rollupBalance: 25000000000, status: 'ACTIVE', ddaId: 'DDA001', metadata: {} },
            { id: 'VA_PROJ_A', code: 'VA001', name: 'DA Cao tốc Bắc Nam - CP1', parentId: 'VA_ROOT', level: 1, realBalance: 0, rollupBalance: 10000000000, status: 'ACTIVE', ddaId: 'DDA001', metadata: { project_code: 'PJ-BN-01' } },
            { id: 'VA_BLOCK_1', code: 'VA001-B1', name: 'Gói thầu XL01 - Licochu', parentId: 'VA_PROJ_A', level: 2, realBalance: 4000000000, rollupBalance: 4000000000, status: 'ACTIVE', ddaId: 'DDA001', metadata: { contractor: 'Licochu' } },
            { id: 'VA_BLOCK_2', code: 'VA001-B2', name: 'Gói thầu XL02 - Cầu Hưng Hà', parentId: 'VA_PROJ_A', level: 2, realBalance: 6000000000, rollupBalance: 6000000000, status: 'ACTIVE', ddaId: 'DDA001', metadata: { contractor: 'Cienco' } }
        ];

        const initialTx = [
            { id: 'TX001', date: new Date().toISOString(), type: 'CREDIT', vaId: 'VA_BLOCK_1', vaCode: 'VA001-B1', vaName: 'Gói thầu XL01 - Licochu', amount: 4000000000, reference: 'Tam ung hop dong dot 1', beneficiary: '', status: 'SUCCESS' }
        ];

        const initialIdentifiers = [
            { id: 'ID001', type: 'CONTRACT_NO', value: 'HD-XL01-2024', vaId: 'VA_BLOCK_1', status: 'ACTIVE' },
            { id: 'ID002', type: 'TAX_CODE', value: '0100100099-001', vaId: 'VA_PROJ_A', status: 'ACTIVE' }
        ];

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('DASHBOARD');
            const [lang, setLang] = useState('vi'); 
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [txMenuOpen, setTxMenuOpen] = useState(true); 
            
            // Global State with version key to reset old data if needed
            const [corporate, setCorporate] = useState(() => loadState('BANKB_CORP_V2.1', initialCorporate));
            const [virtualAccounts, setVirtualAccounts] = useState(() => loadState('BANKB_VAS_V2.1', initialVAs));
            const [transactions, setTransactions] = useState(() => loadState('BANKB_TXS_V2.1', initialTx));
            const [identifiers, setIdentifiers] = useState(() => loadState('BANKB_IDS_V2.1', initialIdentifiers));
            const [notifications, setNotifications] = useState([]);

            useEffect(() => saveState('BANKB_CORP_V2.1', corporate), [corporate]);
            useEffect(() => saveState('BANKB_VAS_V2.1', virtualAccounts), [virtualAccounts]);
            useEffect(() => saveState('BANKB_TXS_V2.1', transactions), [transactions]);
            useEffect(() => saveState('BANKB_IDS_V2.1', identifiers), [identifiers]);

            const notify = (msg, type = 'info') => {
                const id = generateId();
                setNotifications(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 3000);
            };

            const handleResetData = () => {
                if (confirm(lang === 'vi' ? 'Bạn có chắc chắn muốn xóa dữ liệu?' : 'Are you sure you want to reset data?')) {
                    localStorage.clear();
                    window.location.reload();
                }
            };

            const t = (section, key) => {
                try { return resources[lang][section][key] || key; } 
                catch { return key; }
            };

            const toggleLang = () => setLang(prev => prev === 'vi' ? 'en' : 'vi');
            const handleTabChange = (tab) => { setActiveTab(tab); setMobileMenuOpen(false); }

            const renderContent = () => {
                switch (activeTab) {
                    case 'DASHBOARD': return <Dashboard corporate={corporate} vas={virtualAccounts} txs={transactions} t={t} />;
                    case 'ONBOARDING': return <CorporateOnboarding corporate={corporate} setCorporate={setCorporate} notify={notify} t={t} />;
                    case 'VA_LIFECYCLE': return <VALifecycle vas={virtualAccounts} setVas={setVirtualAccounts} notify={notify} corporate={corporate} t={t} />;
                    
                    case 'TRANSACTIONS_INCOMING': return <TransactionHub mode="CREDIT" vas={virtualAccounts} setVas={setVirtualAccounts} txs={transactions} setTxs={setTransactions} corporate={corporate} notify={notify} identifiers={identifiers} t={t} />;
                    case 'TRANSACTIONS_OUTGOING': return <TransactionHub mode="DEBIT" vas={virtualAccounts} setVas={setVirtualAccounts} txs={transactions} setTxs={setTransactions} corporate={corporate} notify={notify} identifiers={identifiers} t={t} />;
                    case 'TRANSACTIONS_INTERNAL': return <TransactionHub mode="INTERNAL" vas={virtualAccounts} setVas={setVirtualAccounts} txs={transactions} setTxs={setTransactions} corporate={corporate} notify={notify} identifiers={identifiers} t={t} />;
                    
                    case 'IDENTIFIERS': return <IdentifierManager identifiers={identifiers} setIdentifiers={setIdentifiers} vas={virtualAccounts} notify={notify} t={t} />;
                    case 'REPORTS': return <Reporting vas={virtualAccounts} txs={transactions} t={t} />;
                    case 'RECONCILIATION': return <Reconciliation corporate={corporate} setCorporate={setCorporate} vas={virtualAccounts} setVas={setVirtualAccounts} notify={notify} t={t} />;
                    case 'GUIDE': return <UserGuide t={t} lang={lang} />;
                    default: return <Dashboard corporate={corporate} vas={virtualAccounts} txs={transactions} t={t} />;
                }
            };

            return (
                <div className="min-h-screen flex flex-col font-sans text-gray-800">
                    {/* Header */}
                    <header className="bg-bankb-primary text-white p-3 md:p-4 shadow-md flex justify-between items-center relative overflow-hidden z-20">
                        <div className="absolute bottom-0 left-0 w-full h-1 bg-bankb-accent"></div>
                        <div className="flex items-center gap-2 md:gap-3 z-10">
                            <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="lg:hidden p-1.5 rounded hover:bg-white/20">
                                <IconWrapper name={mobileMenuOpen ? "X" : "Menu"} size={24} />
                            </button>
                            <img src="https://logos-world.net/wp-content/uploads/2023/02/BIDV-Logo-500x281.png" alt="BIDV Logo" className="h-8 md:h-10 w-auto object-contain bg-white rounded-lg px-1 shadow" />
                            <div className="hidden md:block">
                                <h1 className="font-bold text-lg tracking-wide">{resources[lang].app_name_full}</h1>
                                <p className="text-xs opacity-90 text-bankb-accent">{resources[lang].subtitle}</p>
                            </div>
                            <h1 className="font-bold text-base md:hidden tracking-wide ml-2">{resources[lang].app_name}</h1>
                        </div>
                        <div className="flex items-center gap-2 md:gap-4 text-sm z-10">
                            <button onClick={toggleLang} className="flex items-center gap-1 px-2 py-1 bg-white/10 hover:bg-white/20 rounded border border-white/20 transition-all"><IconWrapper name="Globe" size={14} /><span className="font-bold">{lang.toUpperCase()}</span></button>
                            <button onClick={handleResetData} className="hidden md:flex items-center gap-1 px-3 py-1 bg-red-800 hover:bg-red-700 text-white rounded text-xs transition-colors border border-red-600"><IconWrapper name="Trash2" size={14} /> {resources[lang].reset_demo}</button>
                            <div className="hidden md:block"><span className="opacity-75 block text-right text-xs">{resources[lang].welcome},</span><span className="font-semibold text-white">Admin</span></div>
                        </div>
                    </header>

                    {/* Layout */}
                    <div className="flex flex-1 overflow-hidden relative">
                        {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 lg:hidden" onClick={() => setMobileMenuOpen(false)}></div>}
                        
                        <nav className={`fixed inset-y-0 left-0 z-40 w-64 bg-white border-r border-gray-200 flex flex-col shadow-lg transform transition-transform duration-300 ease-in-out lg:static lg:shadow-sm lg:translate-x-0 ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider flex justify-between items-center">Apps / Modules <button onClick={() => setMobileMenuOpen(false)} className="lg:hidden text-gray-500"><IconWrapper name="X" size={18}/></button></div>
                            <div className="flex-1 overflow-y-auto">
                                <NavButton active={activeTab === 'DASHBOARD'} onClick={() => handleTabChange('DASHBOARD')} icon="LayoutDashboard" label={t('menu', 'dashboard')} color="text-bankb-primary" />
                                <NavButton active={activeTab === 'ONBOARDING'} onClick={() => handleTabChange('ONBOARDING')} icon="Building2" label={t('menu', 'onboarding')} color="text-blue-600" />
                                <NavButton active={activeTab === 'VA_LIFECYCLE'} onClick={() => handleTabChange('VA_LIFECYCLE')} icon="GitFork" label={t('menu', 'lifecycle')} color="text-purple-600" />
                                
                                {/* Transaction Group Menu */}
                                <div>
                                    <button onClick={() => setTxMenuOpen(!txMenuOpen)} className="flex items-center justify-between w-full px-6 py-3.5 text-sm font-medium text-gray-600 hover:bg-gray-50 border-l-4 border-transparent transition-all">
                                        <div className="flex items-center gap-3">
                                            <IconWrapper name="ArrowRightLeft" size={20} className="text-green-600" />
                                            {t('menu', 'transactions_group')}
                                        </div>
                                        <IconWrapper name={txMenuOpen ? "ChevronDown" : "ChevronRight"} size={16} />
                                    </button>
                                    {txMenuOpen && (
                                        <div className="bg-gray-50/50">
                                            <NavSubButton active={activeTab === 'TRANSACTIONS_INCOMING'} onClick={() => handleTabChange('TRANSACTIONS_INCOMING')} label={t('menu', 'tx_incoming')} icon="ArrowDownRight" />
                                            <NavSubButton active={activeTab === 'TRANSACTIONS_OUTGOING'} onClick={() => handleTabChange('TRANSACTIONS_OUTGOING')} label={t('menu', 'tx_outgoing')} icon="ArrowUpRight" />
                                            <NavSubButton active={activeTab === 'TRANSACTIONS_INTERNAL'} onClick={() => handleTabChange('TRANSACTIONS_INTERNAL')} label={t('menu', 'tx_internal')} icon="Repeat" />
                                        </div>
                                    )}
                                </div>

                                <NavButton active={activeTab === 'IDENTIFIERS'} onClick={() => handleTabChange('IDENTIFIERS')} icon="Tag" label={t('menu', 'identifiers')} color="text-orange-500" />
                                <NavButton active={activeTab === 'REPORTS'} onClick={() => handleTabChange('REPORTS')} icon="FileBarChart" label={t('menu', 'reports')} color="text-indigo-600" />
                                <NavButton active={activeTab === 'RECONCILIATION'} onClick={() => handleTabChange('RECONCILIATION')} icon="Scale" label={t('menu', 'reconciliation')} color="text-rose-600" />
                                
                                <div className="mt-4 pt-4 border-t border-gray-100"><NavButton active={activeTab === 'GUIDE'} onClick={() => handleTabChange('GUIDE')} icon="BookOpen" label={t('menu', 'guide')} color="text-gray-600" /></div>
                                <div className="md:hidden p-4"><button onClick={handleResetData} className="w-full flex justify-center items-center gap-1 px-3 py-2 bg-red-100 text-red-800 rounded text-sm transition-colors border border-red-200"><IconWrapper name="Trash2" size={16} /> {resources[lang].reset_demo}</button></div>
                            </div>
                            <div className="p-4 text-[10px] text-gray-400 text-center border-t">© 2024 BankB Ebank<br/>Bản quyền Trương Hồng Quân</div>
                        </nav>

                        <main className="flex-1 overflow-auto bg-gray-50 p-3 md:p-6 relative w-full">
                            {renderContent()}
                            <div className="fixed bottom-4 right-4 flex flex-col gap-2 z-50">{notifications.map(n => <div key={n.id} className={`p-3 rounded shadow-lg text-white text-sm animate-bounce-in flex items-center gap-2 ${n.type === 'error' ? 'bg-bankb-red' : 'bg-bankb-primary'}`}><IconWrapper name={n.type === 'error' ? 'Activity' : 'CheckCircle'} size={16} />{n.msg}</div>)}</div>
                        </main>
                    </div>
                </div>
            );
        };

        const NavButton = ({ active, onClick, icon, label, color }) => (
            <button onClick={onClick} className={`flex items-center gap-3 px-6 py-3.5 text-sm font-medium transition-all w-full text-left border-l-4 ${active ? 'bg-green-50 text-bankb-primary border-bankb-primary' : 'text-gray-600 hover:bg-gray-50 border-transparent'}`}><IconWrapper name={icon} size={20} className={active ? 'text-bankb-primary' : color} />{label}</button>
        );

        const NavSubButton = ({ active, onClick, label, icon }) => (
            <button onClick={onClick} className={`flex items-center gap-3 pl-14 pr-6 py-2.5 text-xs font-medium transition-all w-full text-left border-l-4 ${active ? 'text-bankb-primary border-bankb-primary bg-white' : 'text-gray-500 hover:text-gray-700 border-transparent'}`}>
                <IconWrapper name={icon} size={14} /> {label}
            </button>
        );

        const StatCard = ({ title, value, icon, color, bgColor }) => (
            <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-start justify-between hover:shadow-md transition-shadow h-full">
                <div className="flex-1 min-w-0 pr-2">
                    <p className="text-xs font-bold text-gray-500 uppercase mb-1 truncate" title={title}>{title}</p>
                    <div className="text-lg md:text-xl font-bold text-gray-800 break-words leading-tight">
                        {value}
                    </div>
                </div>
                <div className={`p-3 rounded-full shrink-0 ${bgColor} ${color}`}>
                    <IconWrapper name={icon} size={20} />
                </div>
            </div>
        );

        const Dashboard = ({ corporate, vas, txs, t }) => {
            const totalReal = vas ? vas.reduce((sum, v) => sum + (v.realBalance || 0), 0) : 0;
            const roots = vas.filter(v => !v.parentId);
            const totalRollup = roots.reduce((sum, v) => sum + (v.rollupBalance || 0), 0);
            const activeVAs = vas ? vas.filter(v => v.status === 'ACTIVE').length : 0;
            const txToday = txs ? txs.length : 0;
            const formatMoney = (amount) => (<span>{amount.toLocaleString()} <span className="text-sm font-normal text-gray-500">VND</span></span>);

            return (
                <div className="space-y-4 md:space-y-6">
                    <h2 className="text-xl md:text-2xl font-bold text-gray-800">{t('dashboard', 'title')}</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title={t('dashboard', 'total_real')} value={formatMoney(totalReal)} icon="Wallet" color="text-emerald-600" bgColor="bg-emerald-100" />
                        <StatCard title={t('dashboard', 'total_rollup')} value={formatMoney(totalRollup)} icon="Layers" color="text-indigo-600" bgColor="bg-indigo-100" />
                        <StatCard title={t('dashboard', 'active_vas')} value={activeVAs} icon="CheckCircle" color="text-blue-600" bgColor="bg-blue-100" />
                        <StatCard title={t('dashboard', 'tx_today')} value={txToday} icon="Activity" color="text-purple-600" bgColor="bg-purple-100" />
                    </div>
                    <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 className="font-semibold mb-4 text-bankb-primary flex items-center gap-2 text-sm md:text-base"><IconWrapper name="Building2" size={20} /> {t('dashboard', 'dda_info')}</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-xs md:text-sm text-left min-w-[500px]">
                                <thead className="bg-gray-50 text-gray-600 uppercase"><tr><th className="px-3 py-2 md:px-4 md:py-3">{t('dashboard', 'account_no')}</th><th className="px-3 py-2 md:px-4 md:py-3">{t('dashboard', 'cif')}</th><th className="px-3 py-2 md:px-4 md:py-3">{t('dashboard', 'real_balance')}</th><th className="px-3 py-2 md:px-4 md:py-3">{t('dashboard', 'status')}</th></tr></thead>
                                <tbody>{corporate?.ddaAccounts.map(dda => <tr key={dda.id} className="border-b last:border-0 hover:bg-gray-50 transition-colors"><td className="px-3 py-2 md:px-4 md:py-3 font-medium text-gray-800">{dda.accountNo}</td><td className="px-3 py-2 md:px-4 md:py-3 text-gray-500">{corporate.cif}</td><td className="px-3 py-2 md:px-4 md:py-3 font-bold text-bankb-primary">{dda.balance.toLocaleString()} {dda.currency}</td><td className="px-3 py-2 md:px-4 md:py-3"><span className="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">ACTIVE</span></td></tr>)}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const Reconciliation = ({ corporate, setCorporate, vas, setVas, notify, t }) => {
            const getVaSumForDda = (ddaId) => {
                return vas.filter(v => v.ddaId === ddaId).reduce((sum, v) => sum + (v.realBalance || 0), 0);
            };

            const RecRow = ({ dda }) => {
                const vaSum = getVaSumForDda(dda.id);
                const diff = dda.balance - vaSum;
                const isMatched = diff === 0;

                const handleSimulateError = () => {
                    const newDdas = corporate.ddaAccounts.map(d => d.id === dda.id ? { ...d, balance: d.balance + 500000 } : d);
                    setCorporate({ ...corporate, ddaAccounts: newDdas });
                    notify('Simulated: DDA increased by 500k, VA unchanged.', 'error');
                };

                const handleAutoFix = () => {
                    if (isMatched) return;
                    let suspenseVa = vas.find(v => v.name.includes('SUSPENSE_ADJUSTMENT'));
                    let newVas = [...vas];

                    if (!suspenseVa) {
                        suspenseVa = {
                            id: 'VA_SUSPENSE',
                            code: 'VA-ADJ-001',
                            name: 'SUSPENSE_ADJUSTMENT',
                            parentId: 'VA_ROOT',
                            level: 1,
                            realBalance: 0,
                            rollupBalance: 0,
                            status: 'ACTIVE',
                            ddaId: dda.id,
                            metadata: { type: 'system_correction' }
                        };
                        newVas.push(suspenseVa);
                    }

                    newVas = newVas.map(v => {
                        if (v.id === suspenseVa.id) return { ...v, realBalance: v.realBalance + diff };
                        if (v.id === 'VA_ROOT') return { ...v, rollupBalance: v.rollupBalance + diff };
                        return v;
                    });

                    setVas(newVas);
                    notify('System auto-adjusted via Suspense Account.', 'info');
                };

                return (
                    <tr className="border-b last:border-0 hover:bg-gray-50">
                        <td className="p-3 font-medium">{dda.accountNo}</td>
                        <td className="p-3 font-mono text-blue-700">{dda.balance.toLocaleString()}</td>
                        <td className="p-3 font-mono text-emerald-700">{vaSum.toLocaleString()}</td>
                        <td className={`p-3 font-bold ${isMatched ? 'text-gray-400' : 'text-red-600'}`}>{diff > 0 ? '+' : ''}{diff.toLocaleString()}</td>
                        <td className="p-3">
                            <span className={`px-2 py-1 rounded text-xs font-bold ${isMatched ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {isMatched ? t('reconciliation', 'status_matched') : t('reconciliation', 'status_unmatched')}
                            </span>
                        </td>
                        <td className="p-3 flex gap-2">
                            <button onClick={handleSimulateError} className="p-1.5 bg-gray-100 hover:bg-red-50 text-red-600 rounded border border-gray-300" title={t('reconciliation', 'simulate_btn')}>
                                <IconWrapper name="Zap" size={16} />
                            </button>
                            {!isMatched && (
                                <button onClick={handleAutoFix} className="p-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded border border-blue-300 animate-pulse" title={t('reconciliation', 'fix_btn')}>
                                    <IconWrapper name="Repeat" size={16} />
                                </button>
                            )}
                        </td>
                    </tr>
                );
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-col gap-2">
                        <h2 className="text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <IconWrapper name="Scale" className="text-rose-600" />
                            {t('reconciliation', 'title')}
                        </h2>
                        <p className="text-sm text-gray-600">{t('reconciliation', 'desc')}</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-lg shadow-sm border border-l-4 border-blue-500 flex flex-col justify-between">
                            <span className="text-xs font-bold text-gray-400 uppercase">{t('reconciliation', 'card_dda')}</span>
                            <div className="text-2xl font-bold text-blue-700 mt-2">{corporate.ddaAccounts[0].balance.toLocaleString()}</div>
                            <div className="text-xs text-gray-500 mt-1">{corporate.ddaAccounts[0].accountNo}</div>
                        </div>

                        <div className="bg-white p-6 rounded-lg shadow-sm border border-l-4 border-emerald-500 flex flex-col justify-between">
                            <span className="text-xs font-bold text-gray-400 uppercase">{t('reconciliation', 'card_va')}</span>
                            <div className="text-2xl font-bold text-emerald-700 mt-2">{getVaSumForDda(corporate.ddaAccounts[0].id).toLocaleString()}</div>
                            <div className="text-xs text-gray-500 mt-1">Aggregated from {vas.filter(v=>v.ddaId===corporate.ddaAccounts[0].id).length} VAs</div>
                        </div>

                         <div className={`bg-white p-6 rounded-lg shadow-sm border border-l-4 flex flex-col justify-between ${ (corporate.ddaAccounts[0].balance - getVaSumForDda(corporate.ddaAccounts[0].id)) === 0 ? 'border-gray-300' : 'border-red-500 bg-red-50' }`}>
                            <span className="text-xs font-bold text-gray-400 uppercase">{t('reconciliation', 'card_diff')}</span>
                            <div className={`text-2xl font-bold mt-2 ${(corporate.ddaAccounts[0].balance - getVaSumForDda(corporate.ddaAccounts[0].id)) === 0 ? 'text-gray-700' : 'text-red-600'}`}>
                                {(corporate.ddaAccounts[0].balance - getVaSumForDda(corporate.ddaAccounts[0].id)).toLocaleString()}
                            </div>
                            <div className="text-xs font-bold mt-1">
                                {(corporate.ddaAccounts[0].balance - getVaSumForDda(corporate.ddaAccounts[0].id)) === 0 ? 
                                    <span className="text-green-600 flex items-center gap-1"><IconWrapper name="CheckCircle" size={14}/> {t('reconciliation', 'status_matched')}</span> : 
                                    <span className="text-red-600 flex items-center gap-1"><IconWrapper name="AlertTriangle" size={14}/> {t('reconciliation', 'status_unmatched')}</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div className="p-4 bg-gray-50 border-b font-bold text-gray-700">{t('reconciliation', 'detail_table')}</div>
                        <table className="w-full text-sm text-left">
                            <thead className="bg-white text-gray-500 border-b">
                                <tr>
                                    <th className="p-3">{t('reconciliation', 'col_dda_acc')}</th>
                                    <th className="p-3">{t('reconciliation', 'col_core_bal')}</th>
                                    <th className="p-3">{t('reconciliation', 'col_va_bal')}</th>
                                    <th className="p-3">{t('reconciliation', 'col_diff')}</th>
                                    <th className="p-3">{t('reconciliation', 'col_status')}</th>
                                    <th className="p-3">{t('reconciliation', 'col_action')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {corporate.ddaAccounts.map(dda => <RecRow key={dda.id} dda={dda} />)}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const CorporateOnboarding = ({ corporate, setCorporate, notify, t }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState(corporate);
            const handleSave = () => { setCorporate(formData); setIsEditing(false); notify('Success'); };
            return (
                <div className="max-w-4xl mx-auto bg-white p-4 md:p-8 rounded-lg shadow-sm border border-gray-200">
                    <div className="flex justify-between items-center mb-4 md:mb-6 pb-2 md:pb-4 border-b"><h2 className="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2"><IconWrapper name="Building2" className="text-bankb-primary" />{t('onboarding', 'title')}</h2><button onClick={() => isEditing ? handleSave() : setIsEditing(true)} className={`px-3 py-1.5 md:px-4 md:py-2 rounded text-white text-xs md:text-sm font-medium transition-colors ${isEditing ? 'bg-bankb-primary' : 'bg-gray-600'}`}>{isEditing ? t('onboarding', 'save') : t('onboarding', 'edit')}</button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6"><InputGroup label={t('onboarding', 'cif_label')} value={formData.cif} onChange={e => setFormData({...formData, cif: e.target.value})} disabled={!isEditing} /><InputGroup label={t('onboarding', 'name_label')} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} disabled={!isEditing} /><InputGroup label={t('onboarding', 'corp_id_label')} value={formData.id} disabled={true} /><InputGroup label={t('onboarding', 'segment_label')} value={formData.segment} onChange={e => setFormData({...formData, segment: e.target.value})} disabled={!isEditing} type="select" options={['CORPORATE', 'SME', 'FDI', 'LDC/UBND']} /></div>
                    <div className="mt-6 md:mt-8"><h3 className="text-sm md:text-md font-semibold text-gray-700 mb-3 border-b pb-2">{t('onboarding', 'dda_list')}</h3>{formData.ddaAccounts.map((dda, idx) => <div key={idx} className="flex flex-col md:flex-row gap-2 md:gap-4 items-start md:items-end mb-4 bg-gray-50 p-4 rounded border border-gray-100"><InputGroup label={t('dashboard', 'account_no')} value={dda.accountNo} disabled={true} /><InputGroup label={t('dashboard', 'real_balance')} value={dda.balance.toLocaleString()} disabled={true} /><InputGroup label="Currency" value={dda.currency} disabled={true} /></div>)}</div>
                </div>
            );
        };

        const VALifecycle = ({ vas, setVas, notify, corporate, t }) => {
            const [showModal, setShowModal] = useState(false);
            const [editingVA, setEditingVA] = useState(null);
            const [formData, setFormData] = useState({ name: '', parentId: '', ddaId: '', metadata: { project_code: '', household_id: '', end_date: '' } });

            const treeData = useMemo(() => {
                const map = {}; const roots = []; const nodeList = JSON.parse(JSON.stringify(vas));
                nodeList.forEach((node, i) => { map[node.id] = i; nodeList[i].children = []; });
                nodeList.forEach(node => { if (node.parentId !== null && map[node.parentId] !== undefined) nodeList[map[node.parentId]].children.push(node); else roots.push(node); });
                return roots;
            }, [vas]);

            const handleOpenModal = (va = null) => {
                if (va) {
                    setEditingVA(va);
                    setFormData({ name: va.name, parentId: va.parentId || '', ddaId: va.ddaId || '', metadata: { ...va.metadata } });
                } else {
                    setEditingVA(null);
                    setFormData({ name: '', parentId: '', ddaId: '', metadata: { project_code: '', household_id: '', end_date: '' } });
                }
                setShowModal(true);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.parentId && !editingVA && vas.length > 0) return notify('Select Parent!', 'error');

                if (editingVA) {
                    const updatedVas = vas.map(v => v.id === editingVA.id ? { ...v, name: formData.name, parentId: formData.parentId, ddaId: formData.ddaId, metadata: formData.metadata } : v);
                    setVas(updatedVas);
                    notify('Updated successfully');
                } else {
                    const parent = vas.find(v => v.id === formData.parentId);
                    const code = parent ? parent.code + '-' + generateId().substring(0,3).toUpperCase() : 'VA000';
                    const level = parent ? parent.level + 1 : 0;
                    const createdVA = { id: 'VA_' + generateId(), code, name: formData.name, parentId: formData.parentId, level, realBalance: 0, rollupBalance: 0, status: 'ACTIVE', ddaId: formData.ddaId, metadata: { ...formData.metadata } };
                    setVas([...vas, createdVA]);
                    notify(`Created ${code}`);
                }
                setShowModal(false);
            };

            const VARow = ({ node, depth }) => {
                const ddaInfo = corporate.ddaAccounts.find(d => d.id === node.ddaId);
                return (
                    <>
                        <tr className="hover:bg-gray-50 group border-b border-gray-100 text-xs md:text-sm transition-colors">
                            <td className="p-2 md:p-3 pl-2 md:pl-4"><div style={{ marginLeft: depth * (window.innerWidth < 768 ? 10 : 24) + 'px' }} className="flex items-center gap-1 md:gap-2">{depth > 0 && <span className="text-gray-300 font-light">└</span>}<span className="font-mono text-[10px] md:text-xs bg-blue-50 text-blue-700 px-1 md:px-2 py-0.5 md:py-1 rounded border border-blue-100 truncate">{node.code}</span></div></td>
                            <td className="p-2 md:p-3 font-medium text-gray-800 truncate max-w-[100px] md:max-w-none">{node.name}</td>
                            <td className="p-2 md:p-3 text-right font-bold text-emerald-600 bg-emerald-50/30">{node.realBalance?.toLocaleString()}</td>
                            <td className="p-2 md:p-3 text-right font-bold text-indigo-600">{node.rollupBalance?.toLocaleString()}</td>
                            <td className="p-2 md:p-3 hidden md:table-cell"><span className={`px-2 py-1 rounded-full text-xs font-bold ${node.status === 'ACTIVE' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{node.status}</span></td>
                            <td className="p-2 md:p-3 text-xs text-gray-500 hidden lg:table-cell">{ddaInfo ? ddaInfo.accountNo : node.ddaId}</td>
                            <td className="p-2 md:p-3 text-xs text-gray-500 hidden lg:table-cell">{Object.entries(node.metadata).filter(([_,v])=>v).map(([k,v]) => <div key={k} className="truncate max-w-[120px]"><span className="font-semibold">{k}:</span> {v}</div>)}</td>
                            <td className="p-2 md:p-3"><button onClick={() => handleOpenModal(node)} className="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1"><IconWrapper name="Edit" size={14}/> {t('lifecycle', 'action_edit')}</button></td>
                        </tr>
                        {node.children && node.children.map(child => <VARow key={child.id} node={child} depth={depth + 1} />)}
                    </>
                );
            }
            
            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-end"><h2 className="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-2"><IconWrapper name="GitFork" className="text-purple-600" />{t('lifecycle', 'title')}</h2><button onClick={() => handleOpenModal()} className="bg-bankb-primary text-white px-3 py-1.5 md:px-4 md:py-2 rounded shadow flex items-center gap-2 text-xs md:text-sm font-medium"><IconWrapper name="Plus" size={16} /> {t('lifecycle', 'add_btn')}</button></div>
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full min-w-[350px]">
                                <thead className="bg-gray-50 text-gray-500 text-xs uppercase font-bold tracking-wider">
                                    <tr>
                                        <th className="p-2 md:p-3 text-left w-1/5">{t('lifecycle', 'table_code')}</th>
                                        <th className="p-2 md:p-3 text-left w-1/5">{t('lifecycle', 'table_name')}</th>
                                        <th className="p-2 md:p-3 text-right text-emerald-700 bg-emerald-100/50">{t('lifecycle', 'table_real_bal')}</th>
                                        <th className="p-2 md:p-3 text-right text-indigo-700">{t('lifecycle', 'table_rollup_bal')}</th>
                                        <th className="p-2 md:p-3 text-left hidden md:table-cell">{t('lifecycle', 'table_status')}</th>
                                        <th className="p-2 md:p-3 text-left hidden lg:table-cell">{t('lifecycle', 'table_dda')}</th>
                                        <th className="p-2 md:p-3 text-left hidden lg:table-cell">{t('lifecycle', 'table_meta')}</th>
                                        <th className="p-2 md:p-3"></th>
                                    </tr>
                                </thead>
                                <tbody>{treeData.map(node => <VARow key={node.id} node={node} depth={0} />)}</tbody>
                            </table>
                        </div>
                    </div>
                    {showModal && (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm p-4"><div className="bg-white p-4 md:p-6 rounded-lg w-full max-w-md shadow-2xl animate-bounce-in"><h3 className="text-lg font-bold mb-4 border-b pb-2 text-bankb-primary">{editingVA ? t('lifecycle', 'modal_title_edit') : t('lifecycle', 'modal_title_create')}</h3><form onSubmit={handleSubmit} className="space-y-4"><InputGroup label={t('lifecycle', 'table_name')} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('lifecycle', 'modal_parent')}</label><select value={formData.parentId} onChange={e => setFormData({...formData, parentId: e.target.value})} className="border border-gray-300 p-2 rounded text-sm bg-white focus:ring-1 focus:ring-bankb-primary outline-none"><option value="">-- Select --</option>{vas.filter(v => v.status !== 'CLOSED' && v.id !== (editingVA?.id)).map(v => <option key={v.id} value={v.id}>{'--'.repeat(v.level)} {v.name} ({v.code})</option>)}</select></div><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('lifecycle', 'modal_dda')}</label><select value={formData.ddaId} onChange={e => setFormData({...formData, ddaId: e.target.value})} className="border border-gray-300 p-2 rounded text-sm bg-white focus:ring-1 focus:ring-bankb-primary outline-none"><option value="">-- Select DDA --</option>{corporate.ddaAccounts.map(dda => <option key={dda.id} value={dda.id}>{dda.accountNo} - {dda.balance.toLocaleString()} {dda.currency}</option>)}</select></div><div className="border-t pt-2 mt-2"><p className="text-xs font-bold text-gray-500 mb-2">{t('lifecycle', 'modal_meta_title')}</p><div className="grid grid-cols-2 gap-2"><InputGroup label="Project" value={formData.metadata.project_code} onChange={e => setFormData({...formData, metadata: {...formData.metadata, project_code: e.target.value}})} /><InputGroup label="Household" value={formData.metadata.household_id} onChange={e => setFormData({...formData, metadata: {...formData.metadata, household_id: e.target.value}})} /></div></div><div className="flex justify-end gap-2 mt-4 pt-4 border-t"><button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">{t('lifecycle', 'btn_cancel')}</button><button type="submit" className="px-4 py-2 text-sm bg-bankb-primary text-white rounded hover:bg-teal-700 shadow-sm">{editingVA ? t('lifecycle', 'btn_update') : t('lifecycle', 'btn_create')}</button></div></form></div></div>)}</div>
            );
        };

        const IdentifierManager = ({ identifiers, setIdentifiers, vas, notify, t }) => {
            const [formData, setFormData] = useState({ type: 'TAX_CODE', value: '', vaId: '' });
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = () => {
                if (!formData.value || !formData.vaId) return notify('Missing info', 'error');
                
                if (editingId) {
                    const updated = identifiers.map(i => i.id === editingId.id ? { ...i, ...formData } : i);
                    setIdentifiers(updated);
                    setEditingId(null);
                    notify('Updated successfully');
                } else {
                    setIdentifiers([...identifiers, { ...formData, id: generateId(), status: 'ACTIVE' }]);
                    notify('Mapped successfully');
                }
                setFormData({ type: 'TAX_CODE', value: '', vaId: '' });
            };

            const handleEdit = (item) => {
                setEditingId(item);
                setFormData({ type: item.type, value: item.value, vaId: item.vaId });
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6"><div className="col-span-1 bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200 h-fit"><h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><IconWrapper name="Tag" className="text-orange-500" /> {t('identifiers', 'map_title')}</h3><div className="space-y-4"><InputGroup label={t('identifiers', 'type_label')} type="select" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} options={['TAX_CODE', 'CONTRACT_NO', 'INVOICE_NO']} /><InputGroup label={t('identifiers', 'value_label')} value={formData.value} onChange={e => setFormData({...formData, value: e.target.value})} /><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('identifiers', 'target_va_label')}</label><select value={formData.vaId} onChange={e => setFormData({...formData, vaId: e.target.value})} className="border p-2 rounded text-sm bg-white border-gray-300 outline-none"><option value="">-- Select VA --</option>{vas.filter(v => v.status === 'ACTIVE').map(v => <option key={v.id} value={v.id}>{v.code} - {v.name}</option>)}</select></div><button onClick={handleSubmit} className="w-full py-2 bg-bankb-primary text-white rounded text-sm font-bold shadow-sm">{editingId ? t('identifiers', 'btn_update') : t('identifiers', 'btn_add')}</button>{editingId && <button onClick={() => {setEditingId(null); setFormData({ type: 'TAX_CODE', value: '', vaId: '' })}} className="w-full py-2 text-gray-500 text-xs underline">Cancel Edit</button>}</div></div><div className="col-span-2 bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200"><div className="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 className="font-bold text-gray-700">{t('identifiers', 'list_title')}</h3><span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-semibold border border-blue-200 hidden md:inline">Exact Match</span></div><div className="overflow-x-auto"><table className="w-full text-sm text-left min-w-[400px]"><thead className="bg-white text-gray-500 border-b"><tr><th className="p-3">{t('identifiers', 'type_label')}</th><th className="p-3">{t('identifiers', 'value_label')}</th><th className="p-3">VA</th><th className="p-3">{t('identifiers', 'table_action')}</th></tr></thead><tbody>{identifiers.map(i => <tr key={i.id} className="border-b"><td className="p-3 font-mono text-xs">{i.type}</td><td className="p-3 font-bold">{i.value}</td><td className="p-3 text-bankb-primary">{vas.find(v=>v.id===i.vaId)?.code}</td><td className="p-3 flex gap-2"><button onClick={() => handleEdit(i)} className="text-blue-500 hover:underline">{t('identifiers', 'action_edit')}</button><button onClick={() => setIdentifiers(identifiers.filter(x => x.id !== i.id))} className="text-red-500 hover:underline">{t('identifiers', 'action_delete')}</button></td></tr>)}</tbody></table></div></div></div>
            );
        };

        const TransactionHub = ({ vas, setVas, txs, setTxs, corporate, notify, identifiers, t, mode }) => {
            const [subMode, setSubMode] = useState('VA_VA'); 
            const [direction, setDirection] = useState('DDA_TO_VA'); 
            const [formData, setFormData] = useState({ sourceId: '', destId: '', vaId: '', amount: '', reference: '', beneficiary: '' });

            const updateBalances = (list, targetId, amount) => {
                const ancestors = getPathToRoot(targetId, list);
                return list.map(v => {
                    let newV = { ...v };
                    if (v.id === targetId) newV.realBalance = (newV.realBalance || 0) + amount;
                    if (ancestors.some(a => a.id === v.id)) newV.rollupBalance = (newV.rollupBalance || 0) + amount;
                    return newV;
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const amountNum = parseInt(formData.amount.replace(/[^0-9]/g, ''));
                if (!amountNum) return notify('Invalid Amount', 'error');

                let updatedVas = [...vas];
                let newTx = null;

                if (mode === 'CREDIT' || mode === 'DEBIT') {
                    if (!formData.vaId) return notify('Select VA', 'error');
                    const targetVa = vas.find(v => v.id === formData.vaId);
                    if (mode === 'DEBIT' && (targetVa.realBalance < amountNum)) return notify('Insufficient Real Balance', 'error');
                    
                    const signedAmount = mode === 'CREDIT' ? amountNum : -amountNum;
                    updatedVas = updateBalances(updatedVas, formData.vaId, signedAmount);
                    if (mode === 'DEBIT') corporate.ddaAccounts[0].balance -= amountNum; 
                    else corporate.ddaAccounts[0].balance += amountNum;

                    newTx = { id: 'TX'+generateId(), date: new Date().toISOString(), type: mode, vaId: formData.vaId, vaCode: targetVa.code, amount: amountNum, reference: formData.reference };
                
                } else if (mode === 'INTERNAL') {
                    if (subMode === 'VA_VA') {
                        if (!formData.sourceId || !formData.destId) return notify('Select Source and Dest VA', 'error');
                        if (formData.sourceId === formData.destId) return notify('Source must differ from Dest', 'error');
                        const srcVa = vas.find(v => v.id === formData.sourceId);
                        const destVa = vas.find(v => v.id === formData.destId);
                        if (srcVa.realBalance < amountNum) return notify('Source VA Insufficient Real Balance', 'error');

                        updatedVas = updateBalances(updatedVas, formData.sourceId, -amountNum);
                        updatedVas = updateBalances(updatedVas, formData.destId, amountNum);
                        newTx = { id: 'TX'+generateId(), date: new Date().toISOString(), type: 'INTERNAL', vaId: formData.destId, vaCode: `${srcVa.code} -> ${destVa.code}`, amount: amountNum, reference: formData.reference || 'Internal Transfer' };
                    
                    } else if (subMode === 'DDA_VA') {
                        if (direction === 'DDA_TO_VA') {
                            if (!formData.destId) return notify('Select Target VA', 'error');
                            updatedVas = updateBalances(updatedVas, formData.destId, amountNum);
                            newTx = { id: 'TX'+generateId(), date: new Date().toISOString(), type: 'FUNDING', vaId: formData.destId, vaCode: "DDA -> VA", amount: amountNum, reference: formData.reference || 'Allocation' };
                        
                        } else {
                            if (!formData.sourceId) return notify('Select Source VA', 'error');
                            const srcVa = vas.find(v => v.id === formData.sourceId);
                            if (srcVa.realBalance < amountNum) return notify('VA Insufficient Real Balance', 'error');
                            updatedVas = updateBalances(updatedVas, formData.sourceId, -amountNum);
                            newTx = { id: 'TX'+generateId(), date: new Date().toISOString(), type: 'SWEEP', vaId: formData.sourceId, vaCode: "VA -> DDA", amount: amountNum, reference: formData.reference || 'Sweep' };
                        }
                    }
                }
                
                setVas(updatedVas);
                if(newTx) setTxs([newTx, ...txs]);
                notify('Transaction Success'); 
                setFormData({ ...formData, amount: '', reference: '' });
            };

            const resolveRef = () => {
                const found = identifiers.find(i => formData.reference.includes(i.value));
                if(found) { setFormData(p => ({...p, vaId: found.vaId})); notify('Routing Found!'); } else notify('No Route Found');
            };

            const renderVAOption = (v) => <option key={v.id} value={v.id}>{v.code} - {v.name} (Real: {v.realBalance?.toLocaleString()})</option>;

            return (
                <div className="space-y-6">
                    <div className="flex flex-col gap-6">
                        <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 className="text-lg font-bold mb-4 text-bankb-primary pb-2 border-b">
                                {mode === 'CREDIT' && t('transactions', 'title_incoming')}
                                {mode === 'DEBIT' && t('transactions', 'title_outgoing')}
                                {mode === 'INTERNAL' && t('transactions', 'title_internal')}
                            </h2>
                            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 text-sm text-gray-700 italic">
                                {mode === 'CREDIT' && t('transactions', 'desc_incoming')}
                                {mode === 'DEBIT' && t('transactions', 'desc_outgoing')}
                                {mode === 'INTERNAL' && t('transactions', 'desc_internal')}
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {(mode === 'CREDIT' || mode === 'DEBIT') && (
                                    <div className="animate-bounce-in">
                                        {mode === 'CREDIT' && <div className="flex gap-2 items-end"><InputGroup label={t('transactions', 'routing_content')} value={formData.reference} onChange={e => setFormData({...formData, reference: e.target.value})} /><button type="button" onClick={resolveRef} className="mb-0.5 p-2.5 bg-gray-100 border border-gray-300 rounded"><IconWrapper name="Search" /></button></div>}
                                        <div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('transactions', 'va_label')}</label><select value={formData.vaId} onChange={e => setFormData({...formData, vaId: e.target.value})} className="border border-gray-300 p-2.5 rounded text-sm bg-white"><option value="">-- Select --</option>{vas.filter(v => v.status === 'ACTIVE').map(renderVAOption)}</select></div>
                                        <InputGroup label={t('transactions', 'amount_label')} value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} type="number" />
                                        {mode === 'DEBIT' && <InputGroup label={t('transactions', 'payment_content')} value={formData.reference} onChange={e => setFormData({...formData, reference: e.target.value})} />}
                                        <button type="submit" className={`w-full py-2.5 text-white font-bold rounded shadow-sm ${mode === 'CREDIT' ? 'bg-bankb-primary' : 'bg-bankb-red'}`}>{mode === 'CREDIT' ? t('transactions', 'btn_credit') : t('transactions', 'btn_debit')}</button>
                                    </div>
                                )}
                                {mode === 'INTERNAL' && (
                                    <div className="animate-bounce-in">
                                        <div className="flex gap-2 mb-4">
                                            <button type="button" onClick={() => setSubMode('VA_VA')} className={`flex-1 py-1.5 text-xs font-bold rounded border ${subMode === 'VA_VA' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'border-gray-200 text-gray-500'}`}>{t('transactions', 'mode_vava')}</button>
                                            <button type="button" onClick={() => setSubMode('DDA_VA')} className={`flex-1 py-1.5 text-xs font-bold rounded border ${subMode === 'DDA_VA' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'border-gray-200 text-gray-500'}`}>{t('transactions', 'mode_ddava')}</button>
                                        </div>
                                        {subMode === 'VA_VA' && (<><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('transactions', 'source_va')}</label><select value={formData.sourceId} onChange={e => setFormData({...formData, sourceId: e.target.value})} className="border border-gray-300 p-2.5 rounded text-sm bg-white"><option value="">-- Select Source --</option>{vas.filter(v => v.status === 'ACTIVE').map(renderVAOption)}</select></div><div className="flex justify-center"><IconWrapper name="ArrowRightLeft" className="text-gray-400 rotate-90" /></div><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('transactions', 'dest_va')}</label><select value={formData.destId} onChange={e => setFormData({...formData, destId: e.target.value})} className="border border-gray-300 p-2.5 rounded text-sm bg-white"><option value="">-- Select Dest --</option>{vas.filter(v => v.status === 'ACTIVE' && v.id !== formData.sourceId).map(renderVAOption)}</select></div></>)}
                                        {subMode === 'DDA_VA' && (<><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('transactions', 'direction')}</label><select value={direction} onChange={e => setDirection(e.target.value)} className="border border-gray-300 p-2.5 rounded text-sm bg-white font-bold text-blue-700"><option value="DDA_TO_VA">{t('transactions', 'dir_fund')}</option><option value="VA_TO_DDA">{t('transactions', 'dir_sweep')}</option></select></div>{direction === 'DDA_TO_VA' ? (<><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('transactions', 'source_dda')}</label><select className="border border-gray-300 p-2.5 rounded text-sm bg-gray-100" disabled><option>{corporate.ddaAccounts[0].accountNo}</option></select></div><div className="flex justify-center text-green-600"><IconWrapper name="Repeat" className="rotate-90" /></div><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('transactions', 'dest_va')}</label><select value={formData.destId} onChange={e => setFormData({...formData, destId: e.target.value})} className="border border-gray-300 p-2.5 rounded text-sm bg-white"><option value="">-- Select Dest --</option>{vas.filter(v => v.status === 'ACTIVE').map(renderVAOption)}</select></div></>) : (<><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('transactions', 'source_va')}</label><select value={formData.sourceId} onChange={e => setFormData({...formData, sourceId: e.target.value})} className="border border-gray-300 p-2.5 rounded text-sm bg-white"><option value="">-- Select Source --</option>{vas.filter(v => v.status === 'ACTIVE').map(renderVAOption)}</select></div><div className="flex justify-center text-red-500"><IconWrapper name="Repeat" className="rotate-90" /></div><div className="flex flex-col gap-1 w-full"><label className="text-xs font-bold text-gray-500 uppercase">{t('transactions', 'dest_dda')}</label><select className="border border-gray-300 p-2.5 rounded text-sm bg-gray-100" disabled><option>{corporate.ddaAccounts[0].accountNo}</option></select></div></>)}</>)}
                                        <InputGroup label={t('transactions', 'amount_label')} value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} type="number" />
                                        <InputGroup label={t('transactions', 'payment_content')} value={formData.reference} onChange={e => setFormData({...formData, reference: e.target.value})} />
                                        <button type="submit" className="w-full py-2.5 text-white font-bold rounded shadow-sm bg-blue-600 hover:bg-blue-700">{t('transactions', 'btn_transfer')}</button>
                                    </div>
                                )}
                            </form>
                        </div>
                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col">
                            <div className="p-4 border-b bg-gray-50 flex items-center gap-2"><IconWrapper name="FileBarChart" className="text-indigo-600" /><h3 className="font-bold text-gray-700">{t('transactions', 'history_title')}</h3></div>
                            <div className="flex-1 overflow-auto">
                                <table className="w-full text-sm text-left min-w-[500px]"><thead className="bg-white text-gray-500 sticky top-0 border-b"><tr><th className="p-3">{t('transactions', 'table_time')}</th><th className="p-3">{t('transactions', 'table_type')}</th><th className="p-3">VA Code</th><th className="p-3">{t('transactions', 'table_content')}</th><th className="p-3 text-right">{t('transactions', 'amount_label')}</th></tr></thead><tbody>{txs.map(tx => <tr key={tx.id} className="border-b"><td className="p-3 text-xs">{formatDate(tx.date)}</td><td className="p-3 font-bold text-xs">{tx.type}</td><td className="p-3 font-medium">{tx.vaCode}</td><td className="p-3 text-xs truncate max-w-[100px] md:max-w-[150px]">{tx.reference}</td><td className={`p-3 text-right font-bold ${tx.type === 'CREDIT' || tx.type === 'FUNDING' ? 'text-green-600' : (tx.type === 'INTERNAL' ? 'text-blue-600' : 'text-red-600')}`}>{tx.type === 'CREDIT' || tx.type === 'FUNDING' ? '+' : '-'}{tx.amount.toLocaleString()}</td></tr>)}</tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Reporting = ({ vas, txs, t }) => {
            const [selectedVa, setSelectedVa] = useState('');
            const [includeChild, setIncludeChild] = useState(false);
            const stats = useMemo(() => {
                const l = {}; vas.forEach(v => { if(!l[v.level]) l[v.level] = {c:0,b:0}; l[v.level].c++; l[v.level].b += (v.realBalance || 0); }); return l;
            }, [vas]);
            const filteredTxs = useMemo(() => {
                if (!selectedVa) return [];
                let targetIds = [selectedVa];
                if (includeChild) targetIds = [...targetIds, ...getDescendants(selectedVa, vas).map(d => d.id)];
                return txs.filter(tx => targetIds.includes(tx.vaId));
            }, [selectedVa, includeChild, txs, vas]);

            return (
                <div className="space-y-8">
                    <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 className="text-lg md:text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><IconWrapper name="Activity" className="text-bankb-primary" />{t('reports', 'summary_title')}</h2>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">{Object.entries(stats).map(([l, d]) => <div key={l} className="bg-gray-50 p-4 rounded border"><p className="text-xs font-bold text-gray-500">{t('reports', 'level')} {l}</p><p className="text-xl md:text-2xl font-bold text-emerald-600">{d.b.toLocaleString()}</p><p className="text-xs text-gray-400 mt-1">Total Real Bal</p></div>)}</div>
                    </div>
                    <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 className="text-lg md:text-xl font-bold text-gray-800 mb-4">{t('reports', 'statement_title')}</h2>
                        <div className="flex flex-col md:flex-row gap-4 mb-6 bg-gray-50 p-4 rounded"><div className="flex-1"><label className="block text-xs font-bold text-gray-500 uppercase mb-1">{t('reports', 'select_va')}</label><select value={selectedVa} onChange={e => setSelectedVa(e.target.value)} className="w-full border p-2 rounded text-sm"><option value="">-- Select --</option>{vas.map(v => <option key={v.id} value={v.id}>{v.code} - {v.name}</option>)}</select></div><div className="flex items-center pt-5"><label className="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" checked={includeChild} onChange={e => setIncludeChild(e.target.checked)} className="w-4 h-4 text-bankb-primary rounded focus:ring-bankb-primary" /><span className="text-sm font-medium text-gray-700">{t('reports', 'include_child')}</span></label></div></div>
                        <div className="overflow-x-auto"><table className="w-full text-sm min-w-[600px]"><thead className="bg-gray-100 border-b font-semibold"><tr><th className="p-3">{t('transactions', 'table_time')}</th><th className="p-3">{t('transactions', 'table_type')}</th><th className="p-3">VA Code</th><th className="p-3">{t('transactions', 'table_content')}</th><th className="p-3 text-right">{t('transactions', 'amount_label')}</th></tr></thead><tbody>{filteredTxs.length > 0 ? filteredTxs.map(tx => <tr key={tx.id} className="border-b hover:bg-gray-50"><td className="p-3 text-xs">{formatDate(tx.date)}</td><td className="p-3 font-bold text-xs">{tx.type}</td><td className="p-3 font-mono text-xs">{tx.vaCode}</td><td className="p-3">{tx.reference}</td><td className={`p-3 text-right font-bold ${tx.type === 'CREDIT' || tx.type === 'FUNDING' ? 'text-green-600' : (tx.type === 'INTERNAL' ? 'text-blue-600' : 'text-red-600')}`}>{tx.type === 'CREDIT' || tx.type === 'FUNDING' ? '+' : '-'}{tx.amount.toLocaleString()}</td></tr>) : <tr><td colSpan="5" className="p-6 text-center text-gray-400 italic">{t('reports', 'no_tx')}</td></tr>}</tbody></table></div>
                    </div>
                </div>
            );
        };

        const UserGuide = ({ t, lang }) => {
            const terms = resources[lang].guide.terms;
            const processes = resources[lang].guide.processes || [];
            const legacy = resources[lang].guide.legacy_process; 
            const dualBal = resources[lang].guide.dual_balance;
            const newFeature = resources[lang].guide.new_feature_process; // NEW

            return (
                <div className="space-y-6 md:space-y-8 pb-10">
                    <h2 className="text-xl md:text-2xl font-bold text-gray-800">{t('guide', 'title')}</h2>
                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded text-sm md:text-base text-gray-700 italic">{t('guide', 'intro_text')}</div>
                    
                    <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 className="text-base md:text-lg font-bold mb-4 text-bankb-primary flex items-center gap-2"><IconWrapper name="BookOpen" /> {t('guide', 'glossary_title')}</h3>
                        <div className="grid gap-3 md:gap-4 grid-cols-1 md:grid-cols-2">{Object.entries(terms).map(([key, desc]) => <div key={key} className="p-3 md:p-4 bg-gray-50 rounded border border-gray-100"><span className="font-bold text-blue-700 block mb-1 text-sm md:text-base">{key}</span><p className="text-xs md:text-sm text-gray-600 leading-relaxed">{desc}</p></div>)}</div>
                    </div>

                    <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 className="text-base md:text-lg font-bold mb-4 text-bankb-primary flex items-center gap-2">
                            <IconWrapper name="GitFork" /> {t('guide', 'tech_title')}
                        </h3>
                        <div className="space-y-4 text-sm text-gray-700 leading-relaxed">
                            <p className="font-bold">{dualBal.why_title}</p>
                            <p>{dualBal.why_desc}</p>
                            <div className="grid md:grid-cols-2 gap-4 mt-4">
                                <div className="p-3 bg-emerald-50 rounded border border-emerald-100">
                                    <span className="font-bold text-emerald-800 block mb-2">{dualBal.real_title}</span>
                                    <p className="text-xs text-gray-600">{dualBal.real_desc}</p>
                                </div>
                                <div className="p-3 bg-indigo-50 rounded border border-indigo-100">
                                    <span className="font-bold text-indigo-800 block mb-2">{dualBal.rollup_title}</span>
                                    <p className="text-xs text-gray-600">{dualBal.rollup_desc}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {legacy && (
                        <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200 border-l-4 border-l-purple-500">
                            <h3 className="text-base md:text-lg font-bold mb-4 text-purple-700 flex items-center gap-2">
                                <IconWrapper name="Repeat" /> {legacy.flow_title}
                            </h3>
                            <div className="space-y-6 text-sm text-gray-700">
                                <p className="italic">{legacy.flow_intro}</p>
                                <div>
                                    <div className="space-y-4">
                                        {legacy.phases.map((phase, i) => (
                                            <div key={i} className="border border-gray-200 rounded p-3">
                                                <div className="font-bold text-blue-700 mb-1">{phase.name}</div>
                                                <div className="text-xs italic text-gray-500 mb-2">{phase.purpose}</div>
                                                <ul className="list-none pl-2 space-y-2">
                                                    {phase.steps.map((step, k) => (
                                                        <li key={k} className="whitespace-pre-line text-xs bg-gray-50 p-2 rounded border border-gray-100">{step}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-gray-100 p-3 rounded text-xs border border-gray-300 whitespace-pre-line">
                                    <strong>{legacy.summary.split(':')[0]}:</strong>
                                    {legacy.summary.substring(legacy.summary.indexOf(':') + 1)}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* NEW FEATURE SECTION */}
                    {newFeature && (
                        <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200 border-l-4 border-l-teal-500">
                            <h3 className="text-base md:text-lg font-bold mb-4 text-teal-700 flex items-center gap-2">
                                <IconWrapper name="Zap" /> {newFeature.title}
                            </h3>
                            <p className="mb-4 text-sm font-semibold text-gray-800 whitespace-pre-line">{newFeature.intro}</p>
                            
                            <div className="space-y-6">
                                {newFeature.options.map((opt, idx) => (
                                    <div key={idx} className="bg-gray-50 p-4 rounded border border-gray-200">
                                        <h4 className="font-bold text-bankb-primary text-sm md:text-base mb-2">{opt.name}</h4>
                                        <p className="text-sm text-gray-700 mb-2 italic">{opt.desc}</p>
                                        <ul className="list-disc pl-5 text-sm text-gray-600 mb-3 space-y-1">
                                            {opt.benefits.map((b, i) => <li key={i}>{b}</li>)}
                                        </ul>
                                        <p className="text-sm text-gray-700 mb-3"><span className="font-bold">Phù hợp:</span> {opt.suitable_for}</p>
                                        
                                        <div className="bg-white p-3 rounded border border-gray-100">
                                            <span className="font-bold text-xs uppercase text-gray-500 block mb-2">{opt.flow_title}</span>
                                            <div className="space-y-2">
                                                {opt.steps.map((s, i) => (
                                                    <div key={i} className="text-xs md:text-sm flex gap-2">
                                                        <span className="font-bold text-teal-600 min-w-[50px]">B{i+1}:</span>
                                                        <span>{s}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="mt-6 overflow-x-auto">
                                <h4 className="font-bold text-gray-800 mb-2 text-sm md:text-base">{newFeature.comparison_title}</h4>
                                <table className="w-full text-xs md:text-sm text-left border-collapse min-w-[600px]">
                                    <thead>
                                        <tr className="bg-teal-50 text-teal-800">
                                            {newFeature.comparison_table.headers.map((h, i) => <th key={i} className="p-2 border border-teal-100">{h}</th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {newFeature.comparison_table.rows.map((row, i) => (
                                            <tr key={i} className="border-b">
                                                {row.map((c, j) => <td key={j} className="p-2 border border-gray-100">{c}</td>)}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                     <div className="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200">
                         <h3 className="text-base md:text-lg font-bold mb-4 md:mb-6 text-gray-700 flex items-center gap-2"><IconWrapper name="Activity" className="text-orange-500" />{t('guide', 'guide_title')}</h3>
                         <div className="space-y-6">
                            {processes.map((proc, index) => (
                                <div key={index} className="border-l-4 border-bankb-primary pl-4">
                                    <h4 className="font-bold text-gray-800 mb-2 text-sm md:text-base">{proc.title}</h4>
                                    <ul className="list-none space-y-2">
                                        {proc.steps.map((step, idx) => <li key={idx} className="text-xs md:text-sm text-gray-600 flex gap-2"><span className="text-bankb-primary font-bold min-w-[10px]">•</span><span>{step}</span></li>)}
                                    </ul>
                                </div>
                            ))}
                         </div>
                    </div>
                </div>
            );
        };

        const InputGroup = ({ label, value, onChange, disabled, type = 'text', options = [] }) => (
            <div className="flex flex-col gap-1 w-full">
                <label className="text-xs font-bold text-gray-500 uppercase tracking-wide">{label}</label>
                {type === 'select' ? <select disabled={disabled} value={value} onChange={onChange} className="border border-gray-300 p-2.5 rounded text-sm bg-white outline-none focus:border-bankb-primary w-full">{options.map(o => <option key={o} value={o}>{o}</option>)}</select> : <input type={type} value={value} onChange={onChange} disabled={disabled} className="border border-gray-300 p-2.5 rounded text-sm outline-none focus:border-bankb-primary disabled:bg-gray-100 w-full" />}
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
