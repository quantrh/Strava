<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√¨ x√¨ 2026 - T·∫øt B√≠nh Ng·ªç</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Montserrat', 'Segoe UI', sans-serif;
            overflow: hidden; 
            background: url('https://raw.githubusercontent.com/quantrh/Strava/main/Picture/nenquayso.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.2); }
        ::-webkit-scrollbar-thumb { background: #d32f2f; border-radius: 4px; }

        .wheel-shadow { box-shadow: 0 0 25px rgba(0,0,0,0.15); }

        .pointer {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 0; height: 0; 
            border-top: 25px solid transparent;
            border-bottom: 25px solid transparent;
            border-right: 50px solid #c62828;
            z-index: 10;
            filter: drop-shadow(-2px 2px 2px rgba(0,0,0,0.3));
        }

        @media (max-width: 768px) {
            body { 
                overflow-y: auto;
                height: auto;
                min-height: 100vh;
            }
            #wheel-container { padding-right: 35px !important; }
            #view-game { height: auto !important; min-height: 100vh; display: block; }
        }

        .view-section { display: none; width: 100%; height: 100%; overflow-y: auto; }
        .view-section.active { display: flex; flex-direction: column; }

        .modal { transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: auto; }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 100;
            display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #d32f2f;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dropdown custom style */
        .custom-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-top: 4px;
            display: none;
        }
        .custom-dropdown-list.show {
            display: block;
        }
        .custom-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.875rem;
        }
        .custom-dropdown-item:hover {
            background-color: #fee2e2;
        }
    </style>
</head>
<body class="h-screen w-screen text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner mb-2"></div>
        <p class="text-red-600 font-bold">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</p>
    </div>

    <!-- View 1: HOME SCREEN -->
    <div id="view-home" class="view-section active items-center justify-center p-4">
        <div class="bg-white/95 backdrop-blur-sm rounded-[2rem] shadow-2xl w-full max-w-[480px] p-6 md:p-8 border border-white/50 relative overflow-visible mt-8 md:mt-0">
            
            <div class="absolute -top-10 left-1/2 transform -translate-x-1/2">
                <div class="w-20 h-20 md:w-24 md:h-24 bg-gradient-to-br from-orange-500 to-yellow-400 rounded-full flex items-center justify-center text-white text-3xl md:text-4xl shadow-xl floating-icon glow-effect border-4 border-white">
                    <i class="fas fa-gift"></i>
                </div>
            </div>

            <div class="text-center mt-10 md:mt-12 mb-6 md:mb-8">
                <h1 class="text-3xl md:text-4xl font-extrabold text-red-800 mb-1 tracking-tight">L√å X√å 2026</h1>
                <p class="text-gray-500 font-medium text-xs md:text-sm uppercase tracking-wider mb-2">H·ªá th·ªëng quay th∆∞·ªüng & qu·∫£n l√Ω l√¨ x√¨</p>
                <p class="text-xs text-orange-600 font-serif italic">‚ÄúCh√∫c m·ª´ng nƒÉm m·ªõi ‚Äì V·∫°n s·ª± nh∆∞ √Ω‚Äù</p>
            </div>
            
            <div class="space-y-3 md:space-y-4">
                <button onclick="showView('view-organizer')" class="group w-full py-3 bg-white border-2 border-red-100 text-red-700 rounded-xl font-bold hover:bg-red-50 hover:border-red-200 transition-all flex items-center justify-center gap-3 shadow-sm hover:shadow text-sm md:text-base">
                    <div class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center group-hover:bg-red-100 transition-colors"><i class="fas fa-user-tie text-lg"></i></div>
                    <span>T√îI L√Ä NG∆Ø·ªúI T·ªî CH·ª®C</span>
                </button>

                <button onclick="showView('view-player-login')" class="w-full py-4 bg-gradient-to-r from-red-600 to-orange-500 text-white rounded-2xl font-extrabold text-base md:text-lg shadow-lg hover:shadow-orange-500/40 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-3 transform">
                    <i class="fas fa-gamepad text-xl md:text-2xl animate-pulse"></i>
                    THAM GIA QUAY S·ªê
                </button>

                <button onclick="startInstantPlay()" class="group w-full py-3 bg-white border-2 border-green-500 text-green-600 rounded-xl font-bold hover:bg-green-50 transition-all flex items-center justify-center gap-3 shadow-sm hover:shadow text-sm md:text-base">
                    <i class="fas fa-rocket text-lg md:text-xl group-hover:-translate-y-0.5 transition-transform"></i>
                    CH∆†I NGAY (KH√îNG C·∫¶N ƒêƒÇNG K√ù)
                </button>

                <!-- Guide Button -->
                <button onclick="openGuideModal()" class="w-full py-2 text-gray-500 hover:text-blue-600 font-semibold text-xs md:text-sm flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-question-circle"></i> H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG
                </button>
            </div>

            <div class="mt-4 md:mt-6 pt-4 border-t border-gray-100 text-center">
                <span class="inline-block px-3 py-1 bg-red-50 text-red-600 text-[10px] font-bold uppercase tracking-wider rounded-full border border-red-100 mb-2">
                    üßß T·∫øt B√≠nh Ng·ªç 2026
                </span>
                <div class="mt-2 flex justify-center items-center gap-2 text-[10px] text-gray-500 bg-gray-50 py-1 px-3 rounded-full mx-auto w-fit">
                    <i class="fas fa-eye text-blue-400"></i>
                    <span>L∆∞·ª£t truy c·∫≠p: <b id="visit-count">...</b></span>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 font-medium">¬© Tr∆∞∆°ng H·ªìng Qu√¢n (Quantrhvn@gmail.com)</p>
            </div>
        </div>
    </div>

    <!-- View 2: ORGANIZER DASHBOARD -->
    <div id="view-organizer" class="view-section bg-gray-50/90 backdrop-blur-sm h-full">
        <nav class="bg-white shadow p-3 md:p-4 flex justify-between items-center sticky top-0 z-20">
            <button onclick="showView('view-home')" class="text-gray-600 hover:text-red-500 font-medium flex items-center gap-2 text-sm md:text-base"><i class="fas fa-arrow-left"></i> <span class="hidden md:inline">Trang ch·ªß</span></button>
            <h2 class="font-bold text-base md:text-lg text-red-800">Qu·∫£n l√Ω ƒê·ª£t L√¨ X√¨</h2>
            <button onclick="openCreateSessionModal()" class="bg-red-600 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg hover:bg-red-700 text-xs md:text-sm font-bold shadow flex items-center gap-2"><i class="fas fa-plus"></i> <span class="hidden md:inline">T·∫°o ƒë·ª£t m·ªõi</span><span class="md:hidden">T·∫°o m·ªõi</span></button>
        </nav>

        <div class="container mx-auto p-4 max-w-4xl h-full flex flex-col">
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="orgSearchInput" oninput="handleOrgSearch()" class="w-full pl-10 p-3 rounded-xl border shadow-sm focus:ring-2 focus:ring-red-500 outline-none text-sm md:text-base" placeholder="T√¨m ki·∫øm ƒë·ª£t l√¨ x√¨...">
                    <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                </div>
            </div>

            <div id="session-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20 overflow-y-auto"></div>
            <div id="empty-session-msg" class="text-center text-gray-400 mt-20 hidden">
                <i class="fas fa-folder-open text-3xl mb-2"></i>
                <p>Ch∆∞a c√≥ ƒë·ª£t l√¨ x√¨ n√†o. H√£y t·∫°o m·ªõi!</p>
            </div>
        </div>
    </div>

    <!-- View 3: PLAYER LOGIN -->
    <div id="view-player-login" class="view-section items-center justify-center p-4">
        <div class="bg-white/95 backdrop-blur rounded-2xl shadow-xl w-full max-w-2xl p-6 md:p-8 relative mt-10 md:mt-0">
            <button onclick="showView('view-home')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            
            <div class="text-center mb-6">
                <h2 class="text-xl md:text-2xl font-extrabold text-red-700">ƒêƒÉng Nh·∫≠p Quay S·ªë</h2>
                <p class="text-xs md:text-sm text-gray-500 mt-1">Nh·∫≠p th√¥ng tin ƒë·ªÉ nh·∫≠n L√¨ X√¨</p>
            </div>

            <form id="playerForm" onsubmit="handlePlayerLogin(event)" class="space-y-4">
                
                <div class="relative">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ch·ªçn ƒë·ª£t l√¨ x√¨</label>
                    <div class="relative">
                        <input type="text" id="sessionSearchInput" class="w-full p-3 pl-10 border border-gray-300 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-red-500 transition-all text-sm md:text-base cursor-pointer" placeholder="T√¨m ho·∫∑c ch·ªçn ƒë·ª£t..." autocomplete="off">
                        <input type="hidden" id="loginSessionId">
                        <i class="fas fa-gift absolute left-3 top-3.5 text-gray-400"></i>
                        <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                        <div id="sessionDropdownList" class="custom-dropdown-list"></div>
                    </div>
                </div>
                
                <div id="sessionInfoDisplay" class="hidden bg-orange-50 p-3 rounded-lg border border-orange-200 text-sm text-gray-700 mb-2 flex gap-2">
                    <i class="fas fa-info-circle text-orange-500 mt-0.5"></i>
                    <span id="sessionDescText"></span>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">M√£ PIN tham gia</label>
                    <div class="relative">
                        <input type="password" id="loginPin" class="w-full p-3 pl-10 border border-gray-300 rounded-xl outline-none focus:ring-2 focus:ring-red-500 transition-all text-sm md:text-base" placeholder="Nh·∫≠p m√£ PIN BTC cung c·∫•p" required>
                        <i class="fas fa-key absolute left-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-1">H·ªç v√† T√™n</label>
                        <div class="relative">
                            <input type="text" id="loginName" class="w-full p-3 pl-10 border border-gray-300 rounded-xl outline-none focus:ring-2 focus:ring-red-500 transition-all text-sm md:text-base" placeholder="VD: Nguyen Van A" required>
                            <i class="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Ng√¢n h√†ng</label>
                        <div class="relative">
                            <input type="text" id="bankSearchInput" class="w-full p-3 pl-10 border border-gray-300 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-red-500 transition-all text-sm md:text-base cursor-pointer" placeholder="T√¨m ng√¢n h√†ng..." autocomplete="off">
                            <input type="hidden" id="loginBank">
                            <i class="fas fa-university absolute left-3 top-3.5 text-gray-400"></i>
                            <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 text-xs pointer-events-none"></i>
                            <div id="bankDropdownList" class="custom-dropdown-list"></div>
                        </div>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-bold text-gray-700 mb-1">S·ªë t√†i kho·∫£n</label>
                        <div class="relative">
                            <input type="text" id="loginAccount" class="w-full p-3 pl-10 border border-gray-300 rounded-xl outline-none focus:ring-2 focus:ring-red-500 transition-all text-sm md:text-base" placeholder="Nh·∫≠p STK" required>
                            <i class="fas fa-credit-card absolute left-3 top-3.5 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full py-3.5 md:py-4 bg-gradient-to-r from-red-600 to-orange-500 text-white font-bold rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all mt-6 text-sm md:text-base">
                    X√ÅC NH·∫¨N V√ÄO QUAY
                </button>
            </form>
        </div>
    </div>

    <!-- View 4: GAME INTERFACE -->
    <div id="view-game" class="view-section flex-col h-full bg-white/30">
        <nav class="bg-white/90 backdrop-blur-md shadow-sm p-3 flex justify-between items-center z-20 sticky top-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold border border-green-200 shadow-sm">
                    <i class="fas fa-user text-sm md:text-base"></i>
                </div>
                <div class="flex flex-col">
                    <span class="font-bold text-gray-800 text-sm md:text-base" id="gamePlayerName">Player</span>
                    <span class="text-[10px] md:text-xs text-gray-500 uppercase tracking-wide" id="gameSessionName">Session</span>
                </div>
            </div>
            <button onclick="exitGame()" class="text-red-500 font-bold hover:bg-red-50 px-3 py-1.5 md:px-4 md:py-2 rounded-lg transition-colors flex items-center gap-2 text-sm md:text-base">
                <i class="fas fa-sign-out-alt"></i> Tho√°t
            </button>
        </nav>

        <div class="flex flex-col md:flex-row flex-1 relative w-full h-full md:overflow-hidden overflow-y-auto">
            <div class="w-full md:w-3/5 flex items-center justify-center relative p-4 shrink-0 bg-transparent min-h-[350px] md:min-h-full" id="wheel-container">
                <div class="relative w-[280px] h-[280px] sm:w-[350px] sm:h-[350px] md:w-[500px] md:h-[500px] lg:w-[600px] lg:h-[600px] max-w-full max-h-full transition-all">
                    <canvas id="wheelCanvas" class="w-full h-full cursor-pointer wheel-shadow rounded-full border-4 border-white/50"></canvas>
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 md:w-20 md:h-20 bg-white rounded-full shadow-lg border-4 border-red-100 z-10 flex items-center justify-center pointer-events-none">
                        <div class="w-12 h-12 md:w-16 md:h-16 bg-red-50 rounded-full overflow-hidden flex items-center justify-center">
                             <span class="text-2xl md:text-3xl">üßß</span>
                        </div>
                    </div>
                    <div class="pointer"></div>
                </div>
                <div id="spin-instruction" class="absolute bottom-4 md:bottom-10 bg-white/90 backdrop-blur text-red-600 px-4 py-2 md:px-6 md:py-3 rounded-full text-xs md:text-sm font-bold shadow-lg pointer-events-none animate-bounce border border-red-100 text-center whitespace-nowrap">
                    <i class="fas fa-hand-pointer mr-2"></i> Ch·∫°m ƒë·ªÉ quay!
                </div>
            </div>

            <div class="w-full md:w-2/5 bg-white/80 backdrop-blur-md shadow-[0_-10px_20px_rgba(0,0,0,0.1)] md:shadow-2xl z-10 flex flex-col md:border-l border-white/50 min-h-[40vh] md:h-full p-4 md:p-6 rounded-t-[2rem] md:rounded-none relative">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4 md:hidden"></div>

                <div id="gamePlayerInfo" class="hidden">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-id-card text-orange-500"></i> Th√¥ng tin ng∆∞·ªùi nh·∫≠n
                    </h3>
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 mb-4 shadow-sm">
                        <p class="text-xs text-gray-500 uppercase font-semibold">H·ªç t√™n</p>
                        <p class="font-bold text-base md:text-lg text-blue-900 mb-2" id="displayPlayerName">...</p>
                        <div class="h-px bg-blue-200 my-2"></div>
                        <p class="text-xs text-gray-500 uppercase font-semibold">T√†i kho·∫£n nh·∫≠n</p>
                        <p class="font-mono font-bold text-base md:text-lg text-blue-900 tracking-wider" id="displayPlayerAcc">...</p>
                    </div>
                </div>

                <div id="instantControls" class="hidden flex-col h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base md:text-lg font-bold text-gray-800">C√†i ƒë·∫∑t v√≤ng quay</h3>
                        <button id="instantModeBtn" onclick="toggleInstantMode()" class="px-3 py-1.5 text-xs bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 font-bold transition-colors shadow-sm">
                            <i class="fas fa-sync-alt mr-1"></i> ƒê·ªïi ch·∫ø ƒë·ªô
                        </button>
                    </div>
                    <div id="nameInputContainer" class="flex-1 flex flex-col min-h-[150px]">
                        <label class="text-xs font-bold text-gray-500 mb-2 uppercase" id="inputLabel">Danh s√°ch gi·∫£i th∆∞·ªüng</label>
                        <div class="relative flex-1">
                            <textarea id="instantInput" class="w-full h-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none text-sm md:text-base font-sans bg-white/50" placeholder="..."></textarea>
                            <div class="absolute bottom-3 right-3 text-xs bg-white px-2 py-1 rounded shadow text-gray-500 font-medium" id="nameCount">0 m·ª•c</div>
                        </div>
                    </div>
                </div>
                
                <div id="prizeListContainer" class="flex-1 overflow-y-auto mt-2 pr-2 hidden max-h-[300px] md:max-h-none">
                    <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2" id="listTitle">
                        <i class="fas fa-list-ul text-red-500"></i> C∆° c·∫•u gi·∫£i th∆∞·ªüng
                    </h4>
                    <ul class="space-y-2 text-sm text-gray-600 pb-10 md:pb-0" id="prizeListDisplay"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Create, Edit, Auth, Stats, QR, Guide) -->
    <!-- MODAL: Create Session -->
    <div id="createSessionModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 h-[80vh] md:h-[90vh] flex flex-col">
            <h3 class="text-lg md:text-xl font-extrabold text-red-800 mb-4 border-b pb-2">T·∫°o ƒê·ª£t L√¨ X√¨ M·ªõi</h3>
            <form onsubmit="handleCreateSession(event)" class="space-y-4 flex-1 flex flex-col overflow-hidden">
                <div class="overflow-y-auto pr-2 space-y-4 flex-1">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">T√™n ƒë·ª£t (Duy nh·∫•t)</label>
                        <input type="text" name="name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm" placeholder="VD: L√¨ x√¨ Team Tech 2026" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">M√£ PIN b·∫£o v·ªá (T√πy ch·ªçn)</label>
                        <input type="text" name="pin" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm" placeholder="VD: 1234">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Th·ªÉ l·ªá / L·ªùi ch√∫c</label>
                        <textarea name="description" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm" rows="2" placeholder="Nh·∫≠p n·ªôi dung hi·ªÉn th·ªã cho ng∆∞·ªùi ch∆°i..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Danh s√°ch gi·∫£i th∆∞·ªüng</label>
                        <textarea name="prizes" id="sessionPrizeInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none font-mono text-xs md:text-sm" rows="6"></textarea>
                        <p class="text-[10px] md:text-xs text-gray-500 mt-1">G·ª£i √Ω: Nh·∫≠p ƒë√∫ng "500.000 VND" ƒë·ªÉ hi·ªán ·∫£nh ti·ªÅn.</p>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-4 pt-4 border-t shrink-0">
                    <button type="button" onclick="closeModal('createSessionModal')" class="px-4 py-2 md:px-5 md:py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg font-medium text-sm">H·ªßy</button>
                    <button type="submit" class="px-4 py-2 md:px-5 md:py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-lg text-sm">T·∫°o ngay</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Edit Session -->
    <div id="editSessionModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 h-[80vh] md:h-[90vh] flex flex-col">
            <h3 class="text-lg md:text-xl font-extrabold text-blue-800 mb-4 border-b pb-2">Ch·ªânh S·ª≠a ƒê·ª£t L√¨ X√¨</h3>
            <form onsubmit="handleEditSession(event)" class="space-y-4 flex-1 flex flex-col overflow-hidden">
                <input type="hidden" id="editSessionId" name="id">
                <div class="overflow-y-auto pr-2 space-y-4 flex-1">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">T√™n ƒë·ª£t</label>
                        <input type="text" id="editName" name="name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">M√£ PIN b·∫£o v·ªá</label>
                        <input type="text" id="editPin" name="pin" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Th·ªÉ l·ªá / L·ªùi ch√∫c</label>
                        <textarea id="editDescription" name="description" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Danh s√°ch gi·∫£i th∆∞·ªüng</label>
                        <textarea id="editPrizes" name="prizes" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs md:text-sm" rows="6"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-4 pt-4 border-t shrink-0">
                    <button type="button" onclick="closeModal('editSessionModal')" class="px-4 py-2 md:px-5 md:py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg font-medium text-sm">H·ªßy</button>
                    <button type="submit" class="px-4 py-2 md:px-5 md:py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-lg text-sm">C·∫≠p nh·∫≠t</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Authentication -->
    <div id="authModal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-all scale-100">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600 text-xl mx-auto mb-3">
                    <i class="fas fa-lock"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800">Y√™u c·∫ßu x√°c th·ª±c</h3>
                <p class="text-xs text-gray-500 mt-1">Nh·∫≠p PIN c·ªßa ƒë·ª£t quay</p>
            </div>
            <input type="password" id="authPinInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-center text-lg tracking-widest mb-4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="flex gap-2">
                <button onclick="closeModal('authModal')" class="flex-1 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm font-bold">H·ªßy</button>
                <button onclick="confirmAuth()" class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-bold shadow">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Statistics -->
    <div id="statsModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">
            <div class="p-4 md:p-5 border-b bg-gray-50 flex justify-between items-center">
                <div>
                    <h3 class="text-lg md:text-xl font-extrabold text-gray-800" id="statsTitle">Th·ªëng k√™</h3>
                    <p class="text-xs md:text-sm text-gray-500 mt-1" id="statsSubtitle">...</p>
                </div>
                <button onclick="closeModal('statsModal')" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-red-100 hover:text-red-500 flex items-center justify-center transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-4 md:p-6 bg-white">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 md:p-6 rounded-xl border border-green-100 shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-lg md:text-xl"><i class="fas fa-users"></i></div>
                            <div>
                                <p class="text-xs md:text-sm text-gray-500 font-medium uppercase">T·ªïng ng∆∞·ªùi ch∆°i</p>
                                <p class="text-2xl md:text-3xl font-extrabold text-green-700" id="statsTotalPlayers">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 md:p-6 rounded-xl border border-blue-100 shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-lg md:text-xl"><i class="fas fa-coins"></i></div>
                            <div>
                                <p class="text-xs md:text-sm text-gray-500 font-medium uppercase">T·ªïng ti·ªÅn s·∫Ω trao</p>
                                <p class="text-2xl md:text-3xl font-extrabold text-blue-700" id="statsTotalMoney">0 VND</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-200">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-xs uppercase tracking-wider font-bold">
                                <th class="p-3 md:p-4 border-b">Th·ªùi gian</th>
                                <th class="p-3 md:p-4 border-b">H·ªç T√™n</th>
                                <th class="p-3 md:p-4 border-b">Ng√¢n h√†ng & STK</th>
                                <th class="p-3 md:p-4 border-b text-right">Gi·∫£i th∆∞·ªüng</th>
                                <th class="p-3 md:p-4 border-b text-center">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody" class="text-sm text-gray-700 divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="exportToCSV()" class="px-4 py-2 md:px-5 md:py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow flex items-center gap-2 text-sm md:text-base">
                    <i class="fas fa-file-excel"></i> Xu·∫•t CSV
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: QR Display -->
    <div id="qrModal" class="modal fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-[bounceIn_0.3s_ease-out]">
            <div class="p-4 border-b flex justify-between items-center bg-blue-600 text-white">
                <h3 class="text-lg font-bold">M√£ QR Chuy·ªÉn Kho·∫£n</h3>
                <button onclick="closeModal('qrModal')" class="text-white hover:text-blue-200"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 flex flex-col items-center">
                <div class="relative group w-full mb-4">
                    <img id="qrImage" src="" alt="QR Code" class="w-full rounded-lg border border-gray-200 shadow-sm">
                    <div id="qrLoading" class="absolute inset-0 bg-white/80 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mb-4 text-center">Qu√©t m√£ b·∫±ng ·ª©ng d·ª•ng ng√¢n h√†ng ƒë·ªÉ chuy·ªÉn kho·∫£n</p>
                <button id="downloadQrBtn" class="w-full py-2 bg-blue-100 text-blue-700 rounded-lg font-bold hover:bg-blue-200 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> T·∫£i ·∫£nh QR
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: Guide -->
    <div id="guideModal" class="modal fixed inset-0 z-[70] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[85vh] flex flex-col overflow-hidden animate-[bounceIn_0.3s_ease-out]">
            <div class="p-5 border-b bg-red-50 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-extrabold text-red-800">H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG</h3>
                    <p class="text-xs text-red-600 mt-1">L√¨ x√¨ 2026 - T·∫øt B√≠nh Ng·ªç</p>
                </div>
                <button onclick="closeModal('guideModal')" class="w-8 h-8 rounded-full bg-white hover:bg-red-200 text-red-500 hover:text-red-700 flex items-center justify-center transition-colors shadow-sm"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-6 bg-white space-y-8 text-gray-700">
                <div>
                    <h4 class="flex items-center gap-2 font-bold text-lg text-blue-800 mb-3">
                        <span class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-sm">1</span>
                        D√†nh cho Ng∆∞·ªùi T·ªï Ch·ª©c (Admin)
                    </h4>
                    <ul class="list-disc pl-12 space-y-2 text-sm">
                        <li><strong>T·∫°o ƒë·ª£t m·ªõi:</strong> B·∫•m v√†o n√∫t <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-bold">T√¥i l√† ng∆∞·ªùi t·ªï ch·ª©c</span>, sau ƒë√≥ ch·ªçn <strong>"T·∫°o ƒë·ª£t m·ªõi"</strong>.</li>
                        <li><strong>Thi·∫øt l·∫≠p:</strong> Nh·∫≠p t√™n ƒë·ª£t (b·∫Øt bu·ªôc, kh√¥ng tr√πng), m√£ PIN (ƒë·ªÉ b·∫£o v·ªá khi s·ª≠a/x√≥a) v√† danh s√°ch gi·∫£i th∆∞·ªüng.</li>
                        <li><strong>Qu·∫£n l√Ω:</strong> B·∫°n c√≥ th·ªÉ xem th·ªëng k√™ ng∆∞·ªùi tr√∫ng, s·ª≠a th√¥ng tin ho·∫∑c x√≥a ƒë·ª£t l√¨ x√¨ (c·∫ßn nh·∫≠p ƒë√∫ng m√£ PIN ƒë√£ t·∫°o).</li>
                        <li><strong>Chuy·ªÉn ti·ªÅn th∆∞·ªüng:</strong> Sau khi quay xong, v√†o m·ª•c <strong>Th·ªëng k√™</strong>, b·∫•m n√∫t <strong>QR</strong> ·ªü c·ªôt H√†nh ƒë·ªông ƒë·ªÉ t·∫°o m√£ QR chuy·ªÉn kho·∫£n nhanh cho ng∆∞·ªùi tr√∫ng.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="flex items-center gap-2 font-bold text-lg text-orange-700 mb-3">
                        <span class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-sm">2</span>
                        D√†nh cho Ng∆∞·ªùi Ch∆°i
                    </h4>
                    <ul class="list-disc pl-12 space-y-2 text-sm">
                        <li><strong>B∆∞·ªõc 1:</strong> B·∫•m <span class="bg-orange-100 text-orange-800 px-2 py-0.5 rounded text-xs font-bold">Tham gia quay s·ªë</span> t·ª´ m√†n h√¨nh ch√≠nh.</li>
                        <li><strong>B∆∞·ªõc 2:</strong> Ch·ªçn t√™n ƒë·ª£t l√¨ x√¨ m√† b·∫°n tham gia (c√≥ th·ªÉ t√¨m ki·∫øm).</li>
                        <li><strong>B∆∞·ªõc 3:</strong> Nh·∫≠p <strong>M√£ PIN</strong> (n·∫øu BTC y√™u c·∫ßu), <strong>H·ªç t√™n</strong>, <strong>Ng√¢n h√†ng</strong> v√† <strong>S·ªë t√†i kho·∫£n</strong>.</li>
                        <li><strong>B∆∞·ªõc 4:</strong> B·∫•m x√°c nh·∫≠n ƒë·ªÉ v√†o m√†n h√¨nh quay. Ch·∫°m v√†o v√≤ng quay ƒë·ªÉ th·ª≠ v·∫≠n may.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="flex items-center gap-2 font-bold text-lg text-green-700 mb-3">
                        <span class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-sm">3</span>
                        Ch·∫ø ƒë·ªô Ch∆°i T·ª± Do
                    </h4>
                    <p class="pl-12 text-sm mb-2">D√†nh cho kh√°ch v√£ng lai ho·∫∑c ch∆°i vui v·∫ª, kh√¥ng c·∫ßn l∆∞u k·∫øt qu·∫£.</p>
                    <ul class="list-disc pl-12 space-y-2 text-sm">
                        <li>B·∫•m <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold">Ch∆°i ngay</span>.</li>
                        <li>B·∫°n c√≥ th·ªÉ t·ª± do ch·ªânh s·ª≠a c√°c √¥ tr√™n v√≤ng quay (nh·∫≠p t√™n ng∆∞·ªùi ho·∫∑c m·ªánh gi√° ti·ªÅn t√πy th√≠ch).</li>
                    </ul>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="closeModal('guideModal')" class="px-6 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow transition-colors">ƒê√£ Hi·ªÉu</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Winner Celebration (Enhanced) -->
    <div id="winnerModal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl transform scale-100 w-full max-w-lg overflow-hidden animate-[bounceIn_0.5s_ease-out] relative flex flex-col max-h-[90vh]">
            <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/confetti.png')] pointer-events-none"></div>
            
            <!-- Step 1: Animation & Prize -->
            <div id="winnerStep1" class="w-full flex flex-col">
                <div class="relative bg-gradient-to-b from-red-600 to-red-500 p-6 md:p-8 text-center text-white shrink-0">
                    <div class="w-14 h-14 md:w-16 md:h-16 bg-yellow-400 rounded-full flex items-center justify-center text-red-600 text-2xl md:text-3xl mx-auto mb-3 md:mb-4 shadow-lg border-4 border-white/30">
                        <i class="fas fa-star"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-extrabold mb-1">CH√öC M·ª™NG!</h2>
                    <div class="text-red-100 text-xs md:text-sm font-medium" id="winSubtext">L·ªôc xu√¢n ƒë√£ v·ªÅ v√≠ c·ªßa b·∫°n</div>
                </div>
                
                <div class="p-6 md:p-8 text-center bg-white flex-1 overflow-y-auto">
                    <div class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-orange-500 mb-6 break-words leading-tight" id="winnerText">...</div>
                    <div id="winnerImageContainer" class="mb-6 md:mb-8 flex justify-center h-32 md:h-40">
                         <img id="winnerImage" src="" class="h-full shadow-xl rounded-lg object-contain border-4 border-yellow-100 transform hover:scale-105 transition-transform duration-300">
                    </div>
                    <button onclick="showWinnerActions()" class="w-full py-3 md:py-4 bg-red-600 text-white font-bold text-base md:text-lg rounded-xl hover:bg-red-700 shadow-xl shadow-red-200 transition-all transform hover:-translate-y-1">
                        NH·∫¨N QU√Ä NGAY
                    </button>
                </div>
            </div>

            <!-- Step 2: QR & Share (Hidden by default) -->
            <div id="winnerStep2" class="w-full flex-col hidden h-full">
                <div class="p-4 bg-red-600 text-white text-center font-bold text-lg shrink-0">
                    <i class="fas fa-gift mr-2"></i> NH·∫¨N L√å X√å
                </div>
                
                <div class="p-6 overflow-y-auto bg-white flex-1">
                    <!-- QR Section -->
                    <div id="winnerQrSection" class="text-center mb-6">
                        <p class="text-sm text-gray-600 mb-3 font-medium">ƒê∆∞a m√£ n√†y cho Admin ƒë·ªÉ nh·∫≠n ti·ªÅn:</p>
                        <div class="relative group w-48 mx-auto">
                            <img id="winnerQrImage" src="" alt="QR Nh·∫≠n Ti·ªÅn" class="w-full rounded-lg border-2 border-red-100 shadow-lg p-1">
                            <div id="winnerQrLoading" class="absolute inset-0 bg-white/80 flex items-center justify-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 italic">Ng√¢n h√†ng: <span id="winnerBankName" class="font-bold text-gray-600"></span></p>
                    </div>

                    <div id="winnerNoQrMessage" class="hidden text-center mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-yellow-800 text-sm">
                        <i class="fas fa-hand-holding-heart text-2xl mb-2 block"></i>
                        Vui l√≤ng li√™n h·ªá tr·ª±c ti·∫øp v·ªõi ng∆∞·ªùi t·ªï ch·ª©c ƒë·ªÉ nh·∫≠n ph·∫ßn qu√† hi·ªán v·∫≠t n√†y!
                    </div>

                    <!-- Share Section -->
                    <div class="border-t border-gray-100 pt-5">
                        <p class="text-center text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">Chia s·∫ª ni·ªÅm vui</p>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="shareWin('zalo')" class="flex flex-col items-center gap-1 group">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                    <i class="fas fa-comment-dots"></i>
                                </div>
                                <span class="text-[10px] text-gray-500 font-medium">Zalo</span>
                            </button>
                            <button onclick="shareWin('copy')" class="flex flex-col items-center gap-1 group">
                                <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center text-lg group-hover:bg-gray-600 group-hover:text-white transition-colors">
                                    <i class="fas fa-link"></i>
                                </div>
                                <span class="text-[10px] text-gray-500 font-medium">Sao ch√©p</span>
                            </button>
                             <button onclick="shareWin('download')" class="flex flex-col items-center gap-1 group">
                                <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-lg group-hover:bg-green-600 group-hover:text-white transition-colors">
                                    <i class="fas fa-download"></i>
                                </div>
                                <span class="text-[10px] text-gray-500 font-medium">L∆∞u ·∫£nh</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-gray-50 border-t shrink-0">
                    <button onclick="finishGameAndExit()" class="w-full py-3 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-900 shadow transition-all">
                        Ho√†n t·∫•t & Tho√°t
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script>
        // --- SUPABASE CONFIG ---
        const supabaseUrl = 'https://rmbsxccrwrktbjlnezpu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';
        // Changed variable name to avoid conflict
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- ASSETS ---
        const baseUrl = "https://raw.githubusercontent.com/quantrh/Strava/main/Picture/";
        const moneyImageFiles = {
            "N·ª• h√¥n": baseUrl + "hon.jpg", "R∆∞·ª£u": baseUrl + "ruou.jpg",
            "1.000 VND": baseUrl + "1k.jpg", "2.000 VND": baseUrl + "2k.jpg", "5.000 VND": baseUrl + "5K.jpg",
            "10.000 VND": baseUrl + "10k.jpg", "20.000 VND": baseUrl + "20K.jpg", "50.000 VND": baseUrl + "50k.jpg",
            "100.000 VND": baseUrl + "100k.jpg", "200.000 VND": baseUrl + "200K.jpg", "500.000 VND": baseUrl + "500K.jpg" 
        };
        const defaultMoneyList = ["N·ª• h√¥n", "5.000 VND", "10.000 VND", "20.000 VND", "R∆∞·ª£u", "50.000 VND", "100.000 VND", "200.000 VND", "500.000 VND"];
        const defaultNameList = ['Lan', 'Hoa', 'Tuan', 'Hung', 'Mai', 'Linh', 'Dat', 'Cuong'];
        const segmentColors = ["#e53935", "#fb8c00", "#fdd835", "#43a047", "#1e88e5", "#8e24aa", "#ffb74d", "#ef5350"];

        // --- VIETQR CONFIG ---
        const VIETQR_BANKS_API = 'https://api.vietqr.io/v2/banks';
        let cachedBanks = [];

        // --- DATABASE HELPERS ---
        function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

        async function fetchBanks() {
            try {
                const response = await fetch(VIETQR_BANKS_API);
                const data = await response.json();
                if (data.code === "00") {
                    cachedBanks = data.data;
                    cachedBanks.sort((a, b) => {
                        if (a.code === 'BIDV') return -1;
                        if (b.code === 'BIDV') return 1;
                        return a.shortName.localeCompare(b.shortName);
                    });
                    setupSearchableDropdown('bankSearchInput', 'loginBank', 'bankDropdownList', cachedBanks, 'shortName', 'code', 'BIDV');
                }
            } catch (error) {
                console.error("Error fetching banks:", error);
            }
        }

        // --- SEARCHABLE DROPDOWN LOGIC ---
        function setupSearchableDropdown(inputId, hiddenId, listId, data, labelKey, valueKey, defaultValue) {
            const input = document.getElementById(inputId);
            const hidden = document.getElementById(hiddenId);
            const list = document.getElementById(listId);
            
            if (defaultValue && data.length > 0) {
                const defaultItem = data.find(item => item[valueKey] === defaultValue);
                if (defaultItem) {
                    input.value = `${defaultItem[labelKey]} - ${defaultItem.name || ''}`;
                    hidden.value = defaultValue;
                }
            }

            function renderList(filterText = '') {
                list.innerHTML = '';
                const filtered = data.filter(item => {
                    const text = `${item[labelKey]} ${item.name || ''}`.toLowerCase();
                    return text.includes(filterText.toLowerCase());
                });

                if (filtered.length === 0) {
                    list.innerHTML = '<div class="custom-dropdown-item text-gray-500">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
                    return;
                }

                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'custom-dropdown-item';
                    div.textContent = `${item[labelKey]} - ${item.name || ''}`;
                    div.onclick = () => {
                        input.value = `${item[labelKey]} - ${item.name || ''}`;
                        hidden.value = item[valueKey];
                        list.classList.remove('show');
                        
                        if (hiddenId === 'loginSessionId') {
                            const infoBox = document.getElementById('sessionInfoDisplay');
                            if (item.description) {
                                document.getElementById('sessionDescText').innerText = item.description;
                                infoBox.classList.remove('hidden');
                            } else {
                                infoBox.classList.add('hidden');
                            }
                        }
                    };
                    list.appendChild(div);
                });
            }

            input.addEventListener('focus', () => {
                renderList(input.value.trim()); 
                list.classList.add('show');
            });

            input.addEventListener('input', (e) => {
                renderList(e.target.value.trim());
                list.classList.add('show');
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.classList.remove('show');
                }
            });
        }

        async function fetchSessionsFromSupabase() {
            showLoading();
            const { data, error } = await supabaseClient.from('lixi_sessions').select('*, lixi_winners(*)').order('created_at', { ascending: false });
            hideLoading();
            if (error) { console.error(error); return []; }
            return data.map(s => ({
                id: s.id,
                name: s.name,
                pin: s.pin,
                description: s.description,
                prizes: s.prizes || [],
                createdAt: s.created_at,
                winners: s.lixi_winners.map(w => ({
                    name: w.name,
                    account: w.account, // Stored as BANK_CODE::ACCOUNT_NO
                    prize: w.prize,
                    time: w.created_at
                }))
            }));
        }

        async function insertSessionToSupabase(session) {
            showLoading();
            const { error } = await supabaseClient.from('lixi_sessions').insert({
                name: session.name,
                pin: session.pin,
                description: session.description,
                prizes: session.prizes
            });
            hideLoading();
            return !error;
        }

        async function updateSessionInSupabase(id, data) {
            showLoading();
            const { error } = await supabaseClient.from('lixi_sessions').update(data).eq('id', id);
            hideLoading();
            return !error;
        }

        async function insertWinnerToSupabase(sessionId, winner) {
            const { error } = await supabaseClient.from('lixi_winners').insert({
                session_id: sessionId,
                name: winner.name,
                account: winner.account,
                prize: winner.prize
            });
            if(error) console.error("Error saving winner:", error);
        }

        async function checkHasPlayed(sessionId, account) {
            showLoading();
            const { data, error } = await supabaseClient.from('lixi_winners')
                .select('account')
                .eq('session_id', sessionId);
            hideLoading();
            if (error || !data) return false;
            const cleanInput = account.replace(/\s/g, '');
            return data.some(row => {
                const parts = row.account.split('::');
                const storedAcc = parts.length > 1 ? parts[1] : parts[0];
                return storedAcc.replace(/\s/g, '') === cleanInput;
            });
        }

        async function deleteSessionFromSupabase(id) {
            showLoading();
            await supabaseClient.from('lixi_winners').delete().eq('session_id', id);
            const { error } = await supabaseClient.from('lixi_sessions').delete().eq('id', id);
            hideLoading();
            return !error;
        }

        async function updateLoginStats() {
            const { data, error } = await supabaseClient.from('lixi_stats').select('login_count').eq('id', 1).single();
            if (data) {
                const newCount = (data.login_count || 0) + 1;
                await supabaseClient.from('lixi_stats').update({ login_count: newCount }).eq('id', 1);
                document.getElementById('visit-count').innerText = newCount.toLocaleString();
            }
        }

        // --- GLOBAL STATE ---
        let currentSession = null;
        let currentPlayer = null;
        let isMoneyMode = true; 
        let currentWheelItems = [];
        let customMoneyList = [...defaultMoneyList];
        let customNameList = [...defaultNameList];
        let cachedSessions = [];
        let authPendingAction = null; 
        let authTargetId = null;
        let currentWinnerPrize = null; // Store for sharing

        // --- VIEW NAVIGATION ---
        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if (viewId === 'view-organizer') loadOrganizerData(); 
            if (viewId === 'view-player-login') loadSessionDropdown();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openGuideModal() {
            document.getElementById('guideModal').classList.add('active');
        }

        // --- ORGANIZER LOGIC ---
        async function loadOrganizerData() {
            const sessions = await fetchSessionsFromSupabase();
            cachedSessions = sessions;
            renderSessionCards(sessions);
        }

        function handleOrgSearch() {
            const term = document.getElementById('orgSearchInput').value.toLowerCase();
            const filtered = cachedSessions.filter(s => s.name.toLowerCase().includes(term));
            renderSessionCards(filtered);
        }

        function openCreateSessionModal() {
            document.getElementById('createSessionModal').classList.add('active');
            document.getElementById('sessionPrizeInput').value = defaultMoneyList.join('\n');
        }

        async function handleCreateSession(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name').trim();
            const prizes = (formData.get('prizes') || "").split('\n').filter(n => n.trim() !== '');

            if (!name) { alert("Vui l√≤ng nh·∫≠p t√™n ƒë·ª£t l√¨ x√¨!"); return; }
            if (prizes.length === 0) { alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt gi·∫£i th∆∞·ªüng!"); return; }

            showLoading();
            const { data: existingSessions, error: checkError } = await supabaseClient
                .from('lixi_sessions').select('id').ilike('name', name); 
            hideLoading();

            if (checkError || (existingSessions && existingSessions.length > 0)) {
                alert("L·ªói ho·∫∑c t√™n ƒë·ª£t l√¨ x√¨ ƒë√£ t·ªìn t·∫°i!"); return;
            }

            const success = await insertSessionToSupabase({
                name: name,
                pin: formData.get('pin'),
                description: formData.get('description'),
                prizes: prizes
            });
            
            if (success) {
                e.target.reset();
                closeModal('createSessionModal');
                loadOrganizerData(); 
            } else {
                alert("L·ªói khi t·∫°o ƒë·ª£t l√¨ x√¨.");
            }
        }

        function renderSessionCards(sessions) {
            const container = document.getElementById('session-list');
            const emptyMsg = document.getElementById('empty-session-msg');
            container.innerHTML = '';
            if (sessions.length === 0) { emptyMsg.classList.remove('hidden'); return; }
            emptyMsg.classList.add('hidden');

            sessions.forEach(s => {
                const date = new Date(s.createdAt).toLocaleString('vi-VN');
                const playerCount = s.winners.length;
                let totalMoney = 0;
                s.winners.forEach(w => {
                    const num = parseInt(w.prize.replace(/\D/g, '')) || 0;
                    totalMoney += num;
                });

                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-xl border border-gray-100 hover:shadow-lg transition-shadow";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-base md:text-lg text-gray-800">${s.name}</h3>
                        <span class="bg-gray-100 text-[10px] md:text-xs font-semibold px-2 py-1 rounded text-gray-500">${date}</span>
                    </div>
                    <p class="text-xs md:text-sm text-gray-500 mb-4 line-clamp-2 h-8 md:h-10">${s.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                    <div class="flex justify-between items-center text-xs md:text-sm mb-5 bg-gray-50 p-3 rounded-lg">
                        <div class="flex items-center gap-1 font-semibold text-gray-700"><i class="fas fa-users text-blue-500"></i> ${playerCount}</div>
                        <div class="flex items-center gap-1 font-bold text-yellow-600"><i class="fas fa-coins text-yellow-500"></i> ${totalMoney.toLocaleString('vi-VN')} ƒë</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="requestAction('viewStats', '${s.id}')" class="flex-1 py-2.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold text-xs md:text-sm transition-colors"><i class="fas fa-chart-bar mr-1"></i> Th·ªëng k√™</button>
                        <button onclick="requestAction('edit', '${s.id}')" class="px-3 py-2 text-orange-500 hover:bg-orange-50 rounded-lg transition-colors border border-orange-200"><i class="fas fa-edit"></i></button>
                         <button onclick="requestAction('delete', '${s.id}')" class="px-3 py-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors border border-red-200"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- AUTH & EDIT/DELETE LOGIC ---
        function requestAction(action, sessionId) {
            authPendingAction = action;
            authTargetId = sessionId;
            document.getElementById('authPinInput').value = '';
            document.getElementById('authModal').classList.add('active');
        }

        function confirmAuth() {
            const inputPin = document.getElementById('authPinInput').value;
            const session = cachedSessions.find(s => s.id === authTargetId);
            if (!session) return;
            if (inputPin === session.pin) {
                closeModal('authModal');
                if (authPendingAction === 'delete') performDelete(authTargetId);
                else if (authPendingAction === 'edit') openEditModal(authTargetId);
                else if (authPendingAction === 'viewStats') viewStats(authTargetId);
            } else {
                alert("M√£ PIN kh√¥ng ch√≠nh x√°c!");
            }
        }

        async function performDelete(id) {
            await deleteSessionFromSupabase(id);
            loadOrganizerData(); 
        }

        function openEditModal(sessionId) {
            const session = cachedSessions.find(s => s.id === sessionId);
            if(!session) return;
            document.getElementById('editSessionId').value = session.id;
            document.getElementById('editName').value = session.name;
            document.getElementById('editPin').value = session.pin || '';
            document.getElementById('editDescription').value = session.description || '';
            document.getElementById('editPrizes').value = session.prizes.join('\n');
            document.getElementById('editSessionModal').classList.add('active');
        }

        async function handleEditSession(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const id = formData.get('id');
            const name = formData.get('name').trim();
            const prizes = (formData.get('prizes') || "").split('\n').filter(n => n.trim() !== '');

            if (!name) { alert("Vui l√≤ng nh·∫≠p t√™n ƒë·ª£t l√¨ x√¨!"); return; }
            if (prizes.length === 0) { alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt gi·∫£i th∆∞·ªüng!"); return; }

            showLoading();
            const { data: existingSessions, error: checkError } = await supabaseClient
                .from('lixi_sessions').select('id').ilike('name', name).neq('id', id); 
            hideLoading();

            if (checkError || (existingSessions && existingSessions.length > 0)) {
                alert("L·ªói ho·∫∑c t√™n ƒë√£ t·ªìn t·∫°i!"); return;
            }

            const success = await updateSessionInSupabase(id, {
                name: name,
                pin: formData.get('pin'),
                description: formData.get('description'),
                prizes: prizes
            });

            if (success) {
                closeModal('editSessionModal');
                loadOrganizerData(); 
            } else {
                alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!");
            }
        }

        // --- STATS & QR LOGIC (ADMIN) ---
        let currentStatsSessionId = null;

        async function viewStats(sessionId) {
            currentStatsSessionId = sessionId;
            const sessions = await fetchSessionsFromSupabase(); 
            cachedSessions = sessions;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            document.getElementById('statsTitle').innerText = session.name;
            document.getElementById('statsSubtitle').innerText = session.description || "Chi ti·∫øt k·∫øt qu·∫£ quay th∆∞·ªüng";
            document.getElementById('statsTotalPlayers').innerText = session.winners.length;

            let totalMoney = 0;
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';

            [...session.winners].reverse().forEach(w => {
                 const num = parseInt(w.prize.replace(/\D/g, '')) || 0;
                 totalMoney += num;
                 let bankCode = '';
                 let accNum = w.account;
                 if (w.account.includes('::')) {
                     const parts = w.account.split('::');
                     bankCode = parts[0];
                     accNum = parts[1];
                 }

                 const tr = document.createElement('tr');
                 tr.className = "border-b border-gray-50 hover:bg-gray-50";
                 tr.innerHTML = `
                    <td class="p-3 md:p-4 text-gray-500 text-[10px] md:text-xs">
                        <div class="font-semibold">${new Date(w.time).toLocaleDateString()}</div>
                        <div>${new Date(w.time).toLocaleTimeString()}</div>
                    </td>
                    <td class="p-3 md:p-4 font-bold text-gray-800 text-xs md:text-sm">${w.name}</td>
                    <td class="p-3 md:p-4 text-xs md:text-sm">
                        <span class="font-bold text-blue-700">${bankCode}</span>
                        <div class="font-mono text-gray-600">${accNum}</div>
                    </td>
                    <td class="p-3 md:p-4 text-right font-extrabold text-red-600 text-xs md:text-sm">${w.prize}</td>
                    <td class="p-3 md:p-4 text-center">
                        ${num > 0 && bankCode ? 
                            `<button onclick="showQR('${bankCode}', '${accNum}', ${num}, 'Chuc mung nam moi An Khang Thinh Vuong')" class="bg-blue-100 text-blue-600 hover:bg-blue-200 p-2 rounded-lg transition-colors text-xs font-bold"><i class="fas fa-qrcode"></i> QR</button>` : 
                            `<span class="text-gray-300">-</span>`
                        }
                    </td>
                 `;
                 tbody.appendChild(tr);
            });

            document.getElementById('statsTotalMoney').innerText = totalMoney.toLocaleString('vi-VN') + ' VND';
            document.getElementById('statsModal').classList.add('active');
        }

        function showQR(bankCode, accNum, amount, content) {
            const qrModal = document.getElementById('qrModal');
            const qrImage = document.getElementById('qrImage');
            const qrLoading = document.getElementById('qrLoading');
            const downloadBtn = document.getElementById('downloadQrBtn');
            
            qrModal.classList.add('active');
            qrLoading.classList.remove('hidden');
            
            const url = `https://img.vietqr.io/image/${bankCode}-${accNum}-compact.png?amount=${amount}&addInfo=${encodeURIComponent(content)}`;
            
            qrImage.onload = () => { qrLoading.classList.add('hidden'); };
            qrImage.src = url;

            downloadBtn.onclick = async () => {
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = objectUrl;
                    link.download = `QR_Lixi_${accNum}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(objectUrl);
                } catch (err) { alert("L·ªói t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i!"); }
            };
        }

        function exportToCSV() {
            if (!currentStatsSessionId) return;
            const session = cachedSessions.find(s => s.id === currentStatsSessionId);
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Thoi gian,Ho Ten,Ngan Hang,So Tai Khoan,Giai Thuong\n"; 

            session.winners.forEach(w => {
                let bankCode = '', accNum = w.account;
                if (w.account.includes('::')) {
                    const parts = w.account.split('::');
                    bankCode = parts[0];
                    accNum = parts[1];
                }
                const row = [new Date(w.time).toLocaleString('vi-VN'), `"${w.name}"`, `"${bankCode}"`, `"${accNum}"`, `"${w.prize}"`].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Lixi_Report_${session.name}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- PLAYER LOGIC ---
        async function loadSessionDropdown() {
            const sessions = await fetchSessionsFromSupabase();
            cachedSessions = sessions;
            setupSearchableDropdown('sessionSearchInput', 'loginSessionId', 'sessionDropdownList', sessions, 'name', 'id', null);
        }

        async function handlePlayerLogin(e) {
            e.preventDefault();
            const sessionId = document.getElementById('loginSessionId').value;
            const pin = document.getElementById('loginPin').value;
            const name = document.getElementById('loginName').value.trim();
            const bank = document.getElementById('loginBank').value;
            const accountNo = document.getElementById('loginAccount').value.trim();

            if (!sessionId || !bank || !accountNo) { alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!"); return; }
            
            const session = cachedSessions.find(s => s.id === sessionId);
            if (!session) { alert("ƒê·ª£t l√¨ x√¨ kh√¥ng h·ª£p l·ªá"); return; }
            if (session.pin && session.pin !== pin) { alert("M√£ PIN kh√¥ng ch√≠nh x√°c!"); return; }
            
            const played = await checkHasPlayed(sessionId, accountNo);
            if (played) { alert(`TK ${accountNo} ƒë√£ tham gia r·ªìi!`); return; }

            currentSession = session;
            const combinedAccount = `${bank}::${accountNo}`;
            currentPlayer = { name, account: combinedAccount, displayAccount: `${bank} - ${accountNo}`, bankCode: bank, accountNo: accountNo };
            
            currentWheelItems = (session.prizes && session.prizes.length > 0) ? session.prizes : [...defaultMoneyList];
            isMoneyMode = true; 
            startGame();
        }

        function startInstantPlay() {
            currentSession = { id: null, name: "Kh√°ch - Ch∆°i T·ª± Do" };
            currentPlayer = { name: "Kh√°ch", account: "Vui ch∆°i", displayAccount: "Kh√¥ng l∆∞u" };
            isMoneyMode = true; 
            currentWheelItems = [...customMoneyList];
            startGame();
        }

        // --- GAME LOGIC ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        let currentRotation = 0;
        let isSpinning = false;
        let loadedMoneyImages = {};

        function preloadImages() {
             for (const [key, src] of Object.entries(moneyImageFiles)) {
                if (!loadedMoneyImages[key]) {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => { loadedMoneyImages[key] = img; };
                    img.src = src;
                }
            }
        }
        preloadImages();

        function toggleInstantMode() {
            isMoneyMode = !isMoneyMode;
            if (isMoneyMode) { currentWheelItems = [...customMoneyList]; } 
            else { currentWheelItems = [...customNameList]; }
            updateGameUI();
            drawWheel();
        }
        
        document.getElementById('instantInput').addEventListener('input', (e) => {
            const val = e.target.value;
            const list = val.split('\n').filter(n => n.trim() !== '');
            currentWheelItems = list;
            if (isMoneyMode) { customMoneyList = list; } else { customNameList = list; }
            document.getElementById('nameCount').innerText = `${list.length} m·ª•c`;
            drawWheel();
        });

        function startGame() {
            document.getElementById('gamePlayerName').innerText = currentPlayer.name;
            document.getElementById('gameSessionName').innerText = currentSession.name;
            document.getElementById('displayPlayerName').innerText = currentPlayer.name;
            document.getElementById('displayPlayerAcc').innerText = currentPlayer.displayAccount || currentPlayer.account;
            
            if (currentSession.id === null) {
                document.getElementById('gamePlayerInfo').classList.add('hidden');
                document.getElementById('instantControls').classList.remove('hidden');
                document.getElementById('instantControls').classList.add('flex');
                document.getElementById('prizeListContainer').classList.add('hidden');
            } else {
                document.getElementById('gamePlayerInfo').classList.remove('hidden');
                document.getElementById('instantControls').classList.add('hidden');
                document.getElementById('instantControls').classList.remove('flex');
                document.getElementById('prizeListContainer').classList.remove('hidden');
            }

            showView('view-game');
            updateGameUI();
            setTimeout(() => { resizeCanvas(); drawWheel(); }, 100);
            canvas.onclick = startSpin;
        }

        function updateGameUI() {
            const btn = document.getElementById('instantModeBtn');
            const inputLabel = document.getElementById('inputLabel');
            const textArea = document.getElementById('instantInput');
            const prizeListDisplay = document.getElementById('prizeListDisplay');

            if (currentSession.id) {
                prizeListDisplay.innerHTML = '';
                currentWheelItems.forEach(m => {
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2 p-2 bg-gray-50 rounded border border-gray-100";
                    li.innerHTML = `<i class="fas fa-gift text-green-500 mr-2"></i> <span class="font-bold text-gray-700">${m}</span>`;
                    prizeListDisplay.appendChild(li);
                });
                return;
            }

            if (isMoneyMode) {
                btn.innerHTML = '<i class="fas fa-font"></i> Chuy·ªÉn Quay T√™n';
                inputLabel.innerText = "Danh s√°ch gi·∫£i th∆∞·ªüng";
                textArea.value = customMoneyList.join('\n');
            } else {
                btn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Chuy·ªÉn Quay Ti·ªÅn';
                inputLabel.innerText = "Danh s√°ch t√™n ng∆∞·ªùi ch∆°i";
                textArea.value = customNameList.join('\n');
            }
            document.getElementById('nameCount').innerText = `${currentWheelItems.length} m·ª•c`;
        }

        function resizeCanvas() {
            const container = document.getElementById('wheel-container');
            const size = Math.min(container.clientWidth, container.clientHeight) * 0.9;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0) return;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
        }
        window.onresize = () => { if(document.getElementById('view-game').classList.contains('active')) { resizeCanvas(); drawWheel(); }};

        function drawWheel() {
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0) return;
            const width = rect.width;
            const height = rect.height;
            const centerX = width / 2;
            const centerY = height / 2;
            let radius = width / 2 - 10; 
            if (radius <= 0) return;

            const items = currentWheelItems;
            ctx.clearRect(0, 0, width, height);
            if (items.length === 0) return;

            const step = (2 * Math.PI) / items.length;
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(currentRotation);

            for (let i = 0; i < items.length; i++) {
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, i * step, (i + 1) * step);
                ctx.closePath();
                ctx.fillStyle = segmentColors[i % segmentColors.length];
                ctx.fill();
                ctx.lineWidth = 1;
                ctx.strokeStyle = "#fff";
                ctx.stroke();

                ctx.save();
                ctx.rotate(i * step + step / 2);
                
                const val = items[i];
                if (loadedMoneyImages[val]) {
                    const img = loadedMoneyImages[val];
                    const aspectRatio = img.width / img.height;
                    const drawHeight = radius * 0.35; 
                    const drawWidth = drawHeight * aspectRatio;
                    const startX = radius * 0.2;
                    let finalWidth = drawWidth; let finalHeight = drawHeight;
                    if (startX + finalWidth > radius - 10) { const scale = (radius - 10 - startX) / finalWidth; finalWidth *= scale; finalHeight *= scale; }
                    ctx.drawImage(img, startX, -finalHeight/2, finalWidth, finalHeight);
                } else {
                    ctx.textAlign = "right";
                    ctx.fillStyle = "#fff";
                    const fontSize = Math.min(20 + 200/items.length, 28);
                    ctx.font = `bold ${fontSize}px Montserrat, Arial`;
                    ctx.shadowColor = "rgba(0,0,0,0.3)";
                    ctx.shadowBlur = 2;
                    ctx.fillText(val, radius - 20, 8);
                }
                ctx.restore();
            }
            ctx.restore();
        }

        function startSpin() {
            if (isSpinning || currentWheelItems.length === 0) return;
            isSpinning = true;
            document.getElementById('spin-instruction').style.opacity = '0';
            
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            function playTick() {
                 const osc = audioCtx.createOscillator();
                 const gain = audioCtx.createGain();
                 osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                 gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                 gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                 osc.connect(gain); gain.connect(audioCtx.destination);
                 osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            }

            const duration = 7000; 
            const startTimestamp = performance.now();
            const randomOffset = Math.random() * 2 * Math.PI;
            const totalRotationNeeded = (15 * Math.PI * 2) + randomOffset; 
            const startAngle = currentRotation;
            let lastSegmentIndex = -1;

            function animate(timestamp) {
                const elapsed = timestamp - startTimestamp;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                
                const prevRotation = currentRotation;
                currentRotation = startAngle + (totalRotationNeeded * ease);

                const itemsCount = currentWheelItems.length;
                const step = (2 * Math.PI) / itemsCount;
                const normalizedRot = currentRotation % (2 * Math.PI);
                const currentIndex = Math.floor((2 * Math.PI - normalizedRot) / step) % itemsCount;
                
                if (currentIndex !== lastSegmentIndex && progress < 1) { playTick(); lastSegmentIndex = currentIndex; }

                drawWheel();

                if (progress < 1) { requestAnimationFrame(animate); } else { isSpinning = false; finishSpin(); }
            }
            requestAnimationFrame(animate);
        }

        // --- NEW: Winner Celebration & Share Logic ---
        function finishSpin() {
            const items = currentWheelItems;
            const step = (2 * Math.PI) / items.length;
            const normalizedRotation = currentRotation % (2 * Math.PI);
            let winningIndex = Math.floor(((2 * Math.PI) - normalizedRotation) / step) % items.length;
            if (winningIndex < 0) winningIndex += items.length;

            const prize = items[winningIndex];
            currentWinnerPrize = prize;
            
            if (currentSession && currentSession.id) {
                const winnerData = {
                    name: currentPlayer.name,
                    account: currentPlayer.account,
                    prize: prize
                };
                insertWinnerToSupabase(currentSession.id, winnerData);
            }

            // Reset modal to step 1
            document.getElementById('winnerStep1').classList.remove('hidden');
            document.getElementById('winnerStep2').classList.add('hidden');
            document.getElementById('winnerStep2').classList.remove('flex');
            
            document.getElementById('winnerText').innerText = prize;
            const imgContainer = document.getElementById('winnerImageContainer');
            if (isMoneyMode && loadedMoneyImages[prize]) {
                document.getElementById('winnerImage').src = loadedMoneyImages[prize].src;
                imgContainer.classList.remove('hidden');
            } else { imgContainer.classList.add('hidden'); }
            
            document.getElementById('winnerModal').classList.add('active');
            confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 }, colors: ['#e53935', '#ffeb3b', '#43a047'] });
        }

        function showWinnerActions() {
            document.getElementById('winnerStep1').classList.add('hidden');
            document.getElementById('winnerStep2').classList.remove('hidden');
            document.getElementById('winnerStep2').classList.add('flex');
            
            // Generate QR for Winner's Account so Organizer can scan
            const amount = parseInt(currentWinnerPrize.replace(/\D/g, '')) || 0;
            const qrSection = document.getElementById('winnerQrSection');
            const noQrMsg = document.getElementById('winnerNoQrMessage');

            if (amount > 0 && currentPlayer && currentPlayer.bankCode) {
                qrSection.classList.remove('hidden');
                noQrMsg.classList.add('hidden');
                document.getElementById('winnerBankName').innerText = `${currentPlayer.bankCode} - ${currentPlayer.accountNo}`;
                
                const qrImage = document.getElementById('winnerQrImage');
                const qrLoading = document.getElementById('winnerQrLoading');
                qrLoading.classList.remove('hidden');
                
                const content = "Chuc mung nam moi An Khang Thinh Vuong";
                const url = `https://img.vietqr.io/image/${currentPlayer.bankCode}-${currentPlayer.accountNo}-compact.png?amount=${amount}&addInfo=${encodeURIComponent(content)}`;
                
                qrImage.onload = () => qrLoading.classList.add('hidden');
                qrImage.src = url;
            } else {
                qrSection.classList.add('hidden');
                noQrMsg.classList.remove('hidden');
            }
        }

        function shareWin(type) {
            const text = `T√¥i v·ª´a tr√∫ng ${currentWinnerPrize} t·∫°i L√¨ x√¨ 2026! Ch√∫c m·ª´ng nƒÉm m·ªõi!`;
            const url = window.location.href;

            if (type === 'zalo') {
                window.open(`https://zalo.me/share/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(text)}`);
            } else if (type === 'facebook') {
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`);
            } else if (type === 'copy') {
                navigator.clipboard.writeText(text + " " + url);
                alert("ƒê√£ sao ch√©p n·ªôi dung!");
            } else if (type === 'download') {
                // Download QR
                const img = document.getElementById('winnerQrImage');
                if (img.src) {
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.download = `Lixi_QR_${currentPlayer.accountNo}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert("Kh√¥ng c√≥ m√£ QR ƒë·ªÉ t·∫£i!");
                }
            }
        }

        function finishGameAndExit() {
            document.getElementById('winnerModal').classList.remove('active');
            if (currentSession.id) { exitGame(); } else { document.getElementById('spin-instruction').style.opacity = '1'; }
        }

        function exitGame() {
            currentSession = null;
            currentPlayer = null;
            isSpinning = false;
            document.getElementById('spin-instruction').style.opacity = '1';
            showView('view-home');
            document.getElementById('playerForm').reset();
        }

        // Init App
        updateLoginStats();
        resizeCanvas();
        fetchBanks(); 
    </script>
</body>
</html>
