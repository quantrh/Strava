<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Quản lý Thành tích Chạy bộ - FOR RUNNER LOVER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- REMOVED: <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> -->
    <!-- Thêm thư viện Marked.js để phân tích Markdown thành HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Define BIDV brand colors */
        :root {
            --bidv-green: #006b68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Adjust primary button to BIDV green */
        .btn-primary {
            background-color: var(--bidv-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: #005653; /* Slightly darker green on hover */
        }

        /* Custom styles for the scroll-to-top button */
        #scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--bidv-green);
            color: white;
            border: none;
            /* Make it circular */
            border-radius: 50%; /* Changed from 0.5rem to 50% */
            width: 40px; /* Added fixed width */
            height: 40px; /* Added fixed height */
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }

        #scroll-to-top.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Custom styles for collapsible sections */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #e0e0e0;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 1rem;
            background-color: #fff;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .collapsible-content.expanded {
            max-height: 1000px; /* A large enough value to accommodate content */
            padding: 1rem;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(90deg);
        }

        /* Style for loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s linear;
        }

        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--bidv-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom styles for recent activities table */
        #recent-activities-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        #recent-activities-table th,
        #recent-activities-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #recent-activities-table th {
            background-color: var(--bidv-green);
            color: white;
        }

        #recent-activities-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #recent-activities-table tr:hover {
            background-color: #ddd;
        }

        /* Responsive table behavior */
        @media screen and (max-width: 768px) {
            #recent-activities-table thead {
                display: none; /* Hide table headers on small screens */
            }

            #recent-activities-table,
            #recent-activities-table tbody,
            #recent-activities-table tr,
            #recent-activities-table td {
                display: block; /* Make table elements behave like block elements */
            }

            #recent-activities-table tr {
                margin-bottom: 0.625em;
                border: 1px solid #ddd;
                border-radius: 0.5rem;
            }

            #recent-activities-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }

            #recent-activities-table td::before {
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }

            /* Assign data-title to each td for responsive display */
            #recent-activities-table td:nth-of-type(1):before { content: "Tên hoạt động:"; }
            #recent-activities-table td:nth-of-type(2):before { content: "Ngày:"; }
            #recent-activities-table td:nth-of-type(3):before { content: "Cự ly:"; }
            #recent-activities-table td:nth-of-type(4):before { content: "Thời gian:"; }
            #recent-activities-table td:nth-of-type(5):before { content: "Tốc độ trung bình:"; }
            #recent-activities-table td:nth-of-type(6):before { content: "Độ cao:"; }
            #recent-activities-table td:nth-of-type(7):before { content: "Hoạt động Strava:"; }
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="loading-overlay" id="loading-overlay">
        <div class="loader"></div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top" aria-label="Scroll to top">&#9650;</button>

    <header class="bg-bidv-green text-white p-4 shadow-md">
        <div class="container flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold text-bidv-yellow mb-2 md:mb-0">Ứng dụng Quản lý Thành tích Chạy bộ</h1>
            <nav>
                <a href="#" class="text-white hover:text-bidv-yellow mx-2">Trang chủ</a>
                <a href="#" class="text-white hover:text-bidv-yellow mx-2">Thống kê</a>
                <a href="#" class="text-white hover:text-bidv-yellow mx-2">Liên hệ</a>
            </nav>
        </div>
    </header>

    <main class="container py-8">
        <!-- Connect Strava Section -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8 text-center">
            <h2 class="text-2xl font-semibold mb-4 text-bidv-green">Kết nối Strava của bạn</h2>
            <!-- Retain Strava Connect image -->
            <img id="connect-strava-btn" src="btn_strava_connect_with_white.png"
                 alt="Connect with Strava" class="block mx-auto cursor-pointer w-48 h-auto rounded-lg shadow-md hover:opacity-90 transition duration-300 ease-in-out mb-4" />
            <p class="text-gray-600">Đăng nhập vào tài khoản Strava của bạn để bắt đầu.</p>
        </section>

        <!-- Instructions Section -->
        <section id="instruction-section" class="bg-white p-0 rounded-lg shadow-md mb-8">
            <div class="collapsible-header">
                <h2 class="text-xl font-semibold text-bidv-green">Hướng dẫn sử dụng</h2>
                <span class="toggle-icon">&#9654;</span> <!-- Right-pointing triangle -->
            </div>
            <div class="collapsible-content" id="instruction-content">
                <!-- Content will be loaded here by JavaScript -->
            </div>
        </section>

        <!-- Recent Activities Section -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-bidv-green">Hoạt động gần đây</h2>
            <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
                <div class="flex-1 mb-4 md:mb-0">
                    <label for="runner-select" class="block text-gray-700 text-sm font-bold mb-2">Chọn vận động viên:</label>
                    <select id="runner-select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="flex-1 mb-4 md:mb-0">
                    <label for="club-select" class="block text-gray-700 text-sm font-bold mb-2">Chọn câu lạc bộ (tùy chọn):</label>
                    <select id="club-select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Tất cả câu lạc bộ</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
                <button id="load-recent-activities-btn" class="btn-primary flex-1 mb-4 md:mb-0">
                    Tải hoạt động gần đây
                </button>
                <!-- Move analyze-activities-btn below load-recent-activities-btn -->
                <button id="analyze-activities-btn" class="btn-primary flex-1">
                    Phân tích hoạt động
                </button>
            </div>


            <div id="recent-activities-summary" class="bg-gray-50 p-4 rounded-lg shadow-inner mb-4 hidden">
                <p class="text-lg font-medium text-gray-700">Tổng số hoạt động: <span id="total-activities" class="font-bold text-bidv-green">0</span></p>
                <p class="text-lg font-medium text-gray-700">Tổng quãng đường: <span id="total-distance" class="font-bold text-bidv-green">0 km</span></p>
            </div>

            <div id="recent-activities-display" class="overflow-x-auto">
                <table id="recent-activities-table" class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr>
                            <th>Tên hoạt động</th>
                            <th>Ngày</th>
                            <th>Cự ly</th>
                            <th>Thời gian</th>
                            <th>Tốc độ trung bình</th>
                            <th>Độ cao</th>
                            <th>Hoạt động Strava</th>
                        </tr>
                    </thead>
                    <tbody id="activities-table-body">
                        <!-- Activities will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Weekly Stats Section -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-bidv-green">Thống kê hàng tuần</h2>
            <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
                <div class="flex-1 mb-4 md:mb-0">
                    <label for="club-stats-filter" class="block text-gray-700 text-sm font-bold mb-2">Chọn câu lạc bộ (thống kê):</label>
                    <select id="club-stats-filter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Tất cả câu lạc bộ</option>
                        <!-- Club options will be populated here -->
                    </select>
                </div>
                <div class="flex-1 mb-4 md:mb-0">
                    <label for="runner-stats-filter" class="block text-gray-700 text-sm font-bold mb-2">Chọn vận động viên (thống kê):</label>
                    <select id="runner-stats-filter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Runner options will be populated here based on club selection -->
                    </select>
                </div>
            </div>
            <button id="load-weekly-stats-btn" class="btn-primary w-full mb-4">
                Tải thống kê hàng tuần
            </button>
            <div id="weekly-stats-chart" class="w-full h-96">
                <!-- D3.js bubble chart will be rendered here -->
            </div>
            <p id="chart-message" class="text-center text-gray-600 mt-4"></p>
        </section>

        <!-- Download Activities for Others Section -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-bidv-green">Tải hoạt động Strava của người khác hộ</h2>
            <p class="text-gray-600 mb-4">
                Sử dụng chức năng này để hỗ trợ tải hoạt động của vận động viên khác trong câu lạc bộ hoặc từ Strava,
                trong trường hợp họ gặp khó khăn trong việc kết nối.
            </p>
            <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
                <div class="flex-1 mb-4 md:mb-0">
                    <label for="runner-download-select" class="block text-gray-700 text-sm font-bold mb-2">Chọn vận động viên để tải:</label>
                    <select id="runner-download-select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Runner options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="flex-1 mb-4 md:mb-0">
                    <label for="club-download-select" class="block text-gray-700 text-sm font-bold mb-2">Chọn câu lạc bộ (tùy chọn):</label>
                    <select id="club-download-select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Tất cả câu lạc bộ</option>
                        <!-- Club options will be populated by JavaScript -->
                    </select>
                </div>
            </div>
            <button id="download-activities-for-other-btn" class="btn-primary w-full">
                Tải hoạt động Strava hộ
            </button>
        </section>

        <!-- Message Box -->
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center relative">
                <h3 id="message-title" class="text-xl font-bold mb-4 text-bidv-green"></h3>
                <p id="message-content" class="text-gray-700 mb-6"></p>
                <button id="message-close-btn" class="btn-primary px-6 py-2">Đóng</button>
            </div>
        </div>

    </main>

    <!-- Original Footer -->
    <footer class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container" style="color: var(--bidv-yellow);">
            &copy; 2025 Trương Hồng Quân - BIDV Running Club. All rights reserved (Dev by AIs - Gemini, GPT).
            <br>
            <img src="PowerStrava.png" alt="PowerStrava Logo" style="height: 28px; margin: 5px auto 0 auto; display: block;">
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Corrected Supabase import for module scripts
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/module/supabase-js.mjs";


        // Firebase configuration and initialization
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        // Supabase configuration (replace with your actual URL and Key)
        // Ensure these are secure and not exposed directly in a production client-side app
        const SUPABASE_URL = 'https://hnnyiqrzuxgslhyrzljj.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhubnlpcXJ6dXhnc2xoeXJ6bGpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTkwODIzNjYsImV4cCI6MTczNDk2ODM2Nn0.8mIeW9b2D9i8mG11e9z9o72wMh1gV0gLzP30oJ6gA0A'; // Replace with your Supabase Anon Key

        // Corrected Supabase client initialization
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const connectStravaBtn = document.getElementById('connect-strava-btn');
        const loadRecentActivitiesBtn = document.getElementById('load-recent-activities-btn');
        const analyzeActivitiesBtn = document.getElementById('analyze-activities-btn');
        const recentActivitiesDisplay = document.getElementById('recent-activities-display');
        const activitiesTableBody = document.getElementById('activities-table-body');
        const totalActivitiesSpan = document.getElementById('total-activities');
        const totalDistanceSpan = document.getElementById('total-distance');
        const recentActivitiesSummary = document.getElementById('recent-activities-summary');
        const runnerSelect = document.getElementById('runner-select');
        const clubSelect = document.getElementById('club-select');
        const loadWeeklyStatsBtn = document.getElementById('load-weekly-stats-btn');
        const weeklyStatsChart = document.getElementById('weekly-stats-chart');
        const chartMessage = document.getElementById('chart-message');
        const runnerStatsFilter = document.getElementById('runner-stats-filter');
        const clubStatsFilter = document.getElementById('club-stats-filter');
        const downloadActivitiesForOtherBtn = document.getElementById('download-activities-for-other-btn');
        const runnerDownloadSelect = document.getElementById('runner-download-select');
        const clubDownloadSelect = document.getElementById('club-download-select');

        // Message Box Elements
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        const messageCloseBtn = document.getElementById('message-close-btn');

        // Collapsible instruction section
        const instructionSection = document.getElementById('instruction-section');
        const instructionContent = document.getElementById('instruction-content');

        // Loading overlay
        const loadingOverlay = document.getElementById('loading-overlay');

        // Global variables for data
        let allRunners = [];
        let allClubs = [];
        let activitiesData = [];
        let weeklyStatsData = [];
        let selectedRunnerIdForActivities = '';
        let selectedClubIdForActivities = '';
        let selectedRunnerIdForStats = '';
        let selectedClubIdForStats = '';
        let selectedRunnerIdForDownload = '';
        let selectedClubIdForDownload = '';
        let currentAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Utility Functions ---

        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        function showMessage(title, content) {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageBox.classList.remove('hidden');
        }

        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        function toggleCollapsible(contentElement, iconElement, initialCollapse = false) {
            if (initialCollapse) {
                contentElement.classList.remove('expanded');
                iconElement.classList.remove('rotated');
            } else {
                contentElement.classList.toggle('expanded');
                iconElement.classList.toggle('rotated');
            }
        }

        // Helper to format duration from seconds to HH:MM:SS
        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s]
                .map(v => v < 10 ? '0' + v : v)
                .filter((v, i) => v !== '00' || i > 0)
                .join(':') || '00:00';
        }

        // Helper to format pace from m/s to min/km
        function formatPace(metersPerSecond) {
            if (metersPerSecond === 0) return '0:00 /km';
            const kmPerHour = metersPerSecond * 3.6;
            const minutesPerKm = 60 / kmPerHour;
            const minutes = Math.floor(minutesPerKm);
            const seconds = Math.round((minutesPerKm - minutes) * 60);
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds} /km`;
        }

        // --- Firebase Firestore Operations ---

        /**
         * Fetches all runners from the 'runners' subcollection for the current app.
         * @returns {Promise<Array>} A promise that resolves to an array of runner objects.
         */
        async function fetchRunners() {
            showLoading();
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/runners`));
                const querySnapshot = await getDocs(q);
                const runners = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                return runners;
            } catch (error) {
                console.error("Error fetching runners:", error);
                showMessage("Lỗi", "Không thể tải danh sách vận động viên.");
                return [];
            } finally {
                hideLoading();
            }
        }

        /**
         * Fetches all clubs from the 'clubs' subcollection for the current app.
         * @returns {Promise<Array>} A promise that resolves to an array of club objects.
         */
        async function fetchClubs() {
            showLoading();
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/clubs`));
                const querySnapshot = await getDocs(q);
                const clubs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                return clubs;
            } catch (error) {
                console.error("Error fetching clubs:", error);
                showMessage("Lỗi", "Không thể tải danh sách câu lạc bộ.");
                return [];
            } finally {
                hideLoading();
            }
        }

        /**
         * Saves activity data for a specific runner.
         * @param {string} runnerId - The ID of the runner.
         * @param {Array} activities - An array of activity objects to save.
         */
        async function saveActivitiesToFirestore(runnerId, activities) {
            showLoading();
            try {
                // Activities will be saved under:
                // `artifacts/${appId}/users/${runnerId}/activities`
                const runnerActivitiesDocRef = doc(db, `artifacts/${appId}/users/${runnerId}/activities/user_activities`);
                await setDoc(runnerActivitiesDocRef, { activities: JSON.stringify(activities) }, { merge: true }); // Store as JSON string
                console.log(`Activities for ${runnerId} saved to Firestore.`);
            } catch (error) {
                console.error("Error saving activities to Firestore:", error);
                showMessage("Lỗi", "Không thể lưu hoạt động lên Firestore.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Fetches activity data for a specific runner from Firestore.
         * @param {string} runnerId - The ID of the runner.
         * @returns {Promise<Array>} A promise that resolves to an array of activity objects.
         */
        async function fetchActivitiesFromFirestore(runnerId) {
            showLoading();
            try {
                // Activities are fetched from:
                // `artifacts/${appId}/users/${runnerId}/activities`
                const runnerActivitiesDocRef = doc(db, `artifacts/${appId}/users/${runnerId}/activities/user_activities`);
                const docSnap = await getDoc(runnerActivitiesDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    return data.activities ? JSON.parse(data.activities) : []; // Parse JSON string back to array
                } else {
                    console.log(`No activities found for runner: ${runnerId}`);
                    return [];
                }
            } catch (error) {
                console.error("Error fetching activities from Firestore:", error);
                showMessage("Lỗi", "Không thể tải hoạt động từ Firestore.");
                return [];
            } finally {
                hideLoading();
            }
        }

        /**
         * Saves weekly stats data for a specific runner.
         * @param {string} runnerId - The ID of the runner.
         * @param {Array} stats - An array of weekly stat objects to save.
         */
        async function saveWeeklyStatsToFirestore(runnerId, stats) {
            showLoading();
            try {
                const runnerStatsDocRef = doc(db, `artifacts/${appId}/users/${runnerId}/weekly_stats/user_weekly_stats`);
                await setDoc(runnerStatsDocRef, { stats: JSON.stringify(stats) }, { merge: true });
                console.log(`Weekly stats for ${runnerId} saved to Firestore.`);
            } catch (error) {
                console.error("Error saving weekly stats to Firestore:", error);
                showMessage("Lỗi", "Không thể lưu thống kê hàng tuần lên Firestore.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Fetches weekly stats data for a specific runner from Firestore.
         * @param {string} runnerId - The ID of the runner.
         * @returns {Promise<Array>} A promise that resolves to an array of weekly stat objects.
         */
        async function fetchWeeklyStatsFromFirestore(runnerId) {
            showLoading();
            try {
                const runnerStatsDocRef = doc(db, `artifacts/${appId}/users/${runnerId}/weekly_stats/user_weekly_stats`);
                const docSnap = await getDoc(runnerStatsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    return data.stats ? JSON.parse(data.stats) : [];
                } else {
                    console.log(`No weekly stats found for runner: ${runnerId}`);
                    return [];
                }
            } catch (error) {
                console.error("Error fetching weekly stats from Firestore:", error);
                showMessage("Lỗi", "Không thể tải thống kê hàng tuần từ Firestore.");
                return [];
            } finally {
                hideLoading();
            }
        }

        // --- Strava API Interaction ---

        /**
         * Exchanges the authorization code for an access token using a serverless function (or similar backend).
         * In a real application, this should happen on a secure backend server.
         * For this demo, we'll simulate it or use a proxy if available.
         * @param {string} code - The authorization code received from Strava.
         * @returns {Promise<Object>} A promise that resolves to the token data.
         */
        async function exchangeCodeForToken(code) {
            showLoading();
            try {
                // This is a placeholder for a backend call.
                // In a real app, you'd send the code to your server, which then securely
                // exchanges it with Strava using your client_secret.
                // For demonstration, we'll use a public API proxy if allowed by Strava's terms,
                // or simulate the success.
                // IMPORTANT: Directly exposing client_secret on the frontend is a SECURITY VULNERABILITY.
                // Assuming a secure backend endpoint `/api/strava-token-exchange` exists.

                // Using Supabase Edge Function to handle the token exchange securely
                const { data, error } = await supabase.functions.invoke('exchange-strava-token', {
                    body: { code },
                });

                if (error) throw error;

                if (data && data.access_token) {
                    // Save the athlete's details and token information to Firestore for the current user
                    // This data should be associated with the currentUserId (Firebase Auth UID)
                    const athleteData = {
                        id: data.athlete.id,
                        username: data.athlete.username,
                        firstname: data.athlete.firstname,
                        lastname: data.athlete.lastname,
                        profile: data.athlete.profile,
                        // DO NOT store access_token directly for security reasons in client-side.
                        // Store it securely on backend or refresh token for future use.
                        // For this demo, we'll store refresh_token and athlete_id for simplicity.
                        refresh_token: data.refresh_token,
                        expires_at: data.expires_at, // Unix timestamp when the access token expires
                        access_token_retrieved_at: Date.now() / 1000 // Custom timestamp for when we got it
                    };
                    await setDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/strava_auth/token`), athleteData, { merge: true });

                    // Add/Update runner in the public 'runners' collection
                    await setDoc(doc(db, `artifacts/${appId}/public/data/runners`, String(data.athlete.id)), {
                        id: data.athlete.id,
                        name: `${data.athlete.firstname} ${data.athlete.lastname}`,
                        profile_picture: data.athlete.profile,
                        // Optionally link to Firebase UID if useful for querying
                        firebase_uid: currentUserId
                    }, { merge: true });

                    showMessage("Thành công", "Kết nối Strava thành công! Bạn có thể tải hoạt động của mình.");
                    await populateRunnerAndClubFilters(); // Refresh filters
                    loadRecentActivitiesBtn.click(); // Automatically load activities
                    return data;
                } else {
                    showMessage("Lỗi", "Không nhận được token từ Strava.");
                    return null;
                }
            } catch (error) {
                console.error("Error exchanging code for token:", error);
                showMessage("Lỗi", "Không thể kết nối với Strava. Vui lòng thử lại.");
                return null;
            } finally {
                hideLoading();
            }
        }

        /**
         * Fetches a new access token using the refresh token.
         * @param {string} refreshToken - The refresh token.
         * @returns {Promise<Object>} A promise that resolves to the new token data.
         */
        async function refreshStravaToken(refreshToken) {
            showLoading();
            try {
                const { data, error } = await supabase.functions.invoke('refresh-strava-token', {
                    body: { refresh_token: refreshToken },
                });

                if (error) throw error;

                if (data && data.access_token) {
                    const athleteData = {
                        refresh_token: data.refresh_token || refreshToken, // Use new refresh token if provided
                        expires_at: data.expires_at,
                        access_token_retrieved_at: Date.now() / 1000
                    };
                    await setDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/strava_auth/token`), athleteData, { merge: true });
                    console.log("Strava token refreshed successfully.");
                    return data.access_token;
                } else {
                    console.error("Failed to refresh token:", data);
                    showMessage("Lỗi", "Không thể làm mới token Strava. Vui lòng kết nối lại.");
                    return null;
                }
            } catch (error) {
                console.error("Error refreshing Strava token:", error);
                showMessage("Lỗi", "Không thể làm mới token Strava. Vui lòng kết nối lại.");
                return null;
            } finally {
                hideLoading();
            }
        }

        /**
         * Gets the current valid Strava access token for the logged-in user.
         * Refreshes it if expired.
         * @returns {Promise<string|null>} The access token or null if unavailable/failed.
         */
        async function getValidStravaAccessToken() {
            if (!currentUserId) {
                showMessage("Lỗi", "Vui lòng đăng nhập để thực hiện chức năng này.");
                return null;
            }

            const stravaAuthDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/strava_auth/token`);
            const docSnap = await getDoc(stravaAuthDocRef);

            if (!docSnap.exists()) {
                showMessage("Thông báo", "Bạn chưa kết nối Strava. Vui lòng kết nối để tải hoạt động.");
                return null;
            }

            const tokenData = docSnap.data();
            const now = Date.now() / 1000; // current time in seconds since epoch

            if (tokenData.expires_at > now) {
                // Token is still valid
                // We need the actual access_token, which is not stored in Firestore for security.
                // In a real app, this would mean the backend manages sessions and direct token use.
                // For this demo, let's assume if expires_at is valid, we can trigger a refresh
                // to get a fresh access_token for client-side use, or rely on a pre-fetched one.
                // This part is tricky due to not storing access_token directly.
                // A better approach: store access_token in a short-lived, client-side only session variable
                // and only refresh when needed.
                // For simplicity in this demo, if it's expired, we always refresh to get a new one.
                console.log("Strava access token is still valid. Attempting to refresh anyway for client-side usage.");
                return await refreshStravaToken(tokenData.refresh_token);
            } else {
                // Token expired, refresh it
                console.log("Strava access token expired. Refreshing...");
                return await refreshStravaToken(tokenData.refresh_token);
            }
        }

        /**
         * Fetches activities from Strava for a given athlete.
         * @param {string} accessToken - The Strava access token.
         * @param {number} athleteId - The Strava athlete ID.
         * @param {number} page - The page number for pagination.
         * @param {number} perPage - Activities per page.
         * @returns {Promise<Array>} A promise that resolves to an array of Strava activities.
         */
        async function fetchActivitiesFromStrava(accessToken, athleteId, page = 1, perPage = 30) {
            showLoading();
            try {
                // Use Supabase Edge Function for proxying Strava API calls
                const { data, error } = await supabase.functions.invoke('get-strava-activities', {
                    body: {
                        accessToken: accessToken,
                        athleteId: athleteId,
                        page: page,
                        perPage: perPage
                    },
                });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error("Error fetching activities from Strava:", error);
                if (error.status === 401 || error.message.includes("401")) { // Check for Unauthorized error
                    showMessage("Lỗi xác thực", "Token Strava của bạn đã hết hạn hoặc không hợp lệ. Vui lòng kết nối lại Strava.");
                    // Optionally, trigger re-authentication here
                } else {
                    showMessage("Lỗi", `Không thể tải hoạt động từ Strava. Lỗi: ${error.message || error.status}`);
                }
                return [];
            } finally {
                hideLoading();
            }
        }

        // --- Data Processing and Rendering ---

        /**
         * Populates the runner and club dropdowns for recent activities and download sections.
         */
        async function populateRunnerAndClubFilters() {
            allRunners = await fetchRunners();
            allClubs = await fetchClubs(); // Ensure clubs are fetched

            // Clear existing options
            runnerSelect.innerHTML = '';
            clubSelect.innerHTML = '<option value="">Tất cả câu lạc bộ</option>';
            runnerDownloadSelect.innerHTML = '';
            clubDownloadSelect.innerHTML = '<option value="">Tất cả câu lạc bộ</option>';

            // Populate runner select for activities and download
            allRunners.forEach(runner => {
                const option = document.createElement('option');
                option.value = runner.id;
                option.textContent = runner.name;
                runnerSelect.appendChild(option);

                const downloadOption = document.createElement('option');
                downloadOption.value = runner.id;
                downloadOption.textContent = runner.name;
                runnerDownloadSelect.appendChild(downloadOption);
            });

            // Populate club selects
            allClubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club.id;
                option.textContent = club.name;
                clubSelect.appendChild(option.cloneNode(true)); // Clone for activity filter
                clubDownloadSelect.appendChild(option); // Use original for download filter
            });

            // Set initial selected values based on global state
            if (selectedRunnerIdForActivities) {
                runnerSelect.value = selectedRunnerIdForActivities;
            } else if (allRunners.length > 0) {
                // If no runner selected, default to the first one available
                selectedRunnerIdForActivities = String(allRunners[0].id);
                runnerSelect.value = selectedRunnerIdForActivities;
            }

            if (selectedClubIdForActivities) {
                clubSelect.value = selectedClubIdForActivities;
            }

            if (selectedRunnerIdForDownload) {
                runnerDownloadSelect.value = selectedRunnerIdForDownload;
            } else if (allRunners.length > 0) {
                selectedRunnerIdForDownload = String(allRunners[0].id);
                runnerDownloadSelect.value = selectedRunnerIdForDownload;
            }

            if (selectedClubIdForDownload) {
                clubDownloadSelect.value = selectedClubIdForDownload;
            }

            // Populate runner stats filter (initial call)
            populateRunnerStatsFilter();
        }

        /**
         * Populates the runner select dropdown for the stats section based on the selected club.
         */
        function populateRunnerStatsFilter() {
            runnerStatsFilter.innerHTML = ''; // Clear existing options
            const allRunnersOption = document.createElement('option');
            allRunnersOption.value = '';
            allRunnersOption.textContent = 'Tất cả vận động viên';
            runnerStatsFilter.appendChild(allRunnersOption);

            let filteredRunners = allRunners;
            if (selectedClubIdForStats) {
                const selectedClub = allClubs.find(club => club.id === selectedClubIdForStats);
                if (selectedClub && selectedClub.runner_ids) {
                    filteredRunners = allRunners.filter(runner => selectedClub.runner_ids.includes(Number(runner.id)));
                } else {
                    filteredRunners = [];
                }
            }

            filteredRunners.forEach(runner => {
                const option = document.createElement('option');
                option.value = runner.id;
                option.textContent = runner.name;
                runnerStatsFilter.appendChild(option);
            });

            // Set initial selection
            if (selectedRunnerIdForStats && filteredRunners.some(r => String(r.id) === selectedRunnerIdForStats)) {
                runnerStatsFilter.value = selectedRunnerIdForStats;
            } else {
                runnerStatsFilter.value = ''; // Default to "All runners" if previous selection is not in filtered list
                selectedRunnerIdForStats = '';
            }
        }

        /**
         * Renders the recent activities table.
         * @param {Array} activities - An array of activity objects.
         */
        function renderRecentActivities(activities) {
            activitiesTableBody.innerHTML = ''; // Clear previous activities

            if (activities.length === 0) {
                activitiesTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Không có hoạt động nào được tìm thấy.</td></tr>';
                recentActivitiesSummary.classList.add('hidden');
                return;
            }

            let totalDistance = 0;
            activities.forEach(activity => {
                const row = activitiesTableBody.insertRow();
                totalDistance += activity.distance; // distance in meters

                row.innerHTML = `
                    <td>${activity.name}</td>
                    <td>${new Date(activity.start_date).toLocaleDateString('vi-VN')}</td>
                    <td>${(activity.distance / 1000).toFixed(2)} km</td>
                    <td>${formatDuration(activity.elapsed_time)}</td>
                    <td>${formatPace(activity.average_speed)}</td>
                    <td>${activity.total_elevation_gain.toFixed(0)} m</td>
                    <td><a href="https://www.strava.com/activities/${activity.id}" target="_blank" class="text-bidv-green hover:underline">Xem trên Strava</a></td>
                `;
            });

            totalActivitiesSpan.textContent = activities.length;
            totalDistanceSpan.textContent = `${(totalDistance / 1000).toFixed(2)} km`;
            recentActivitiesSummary.classList.remove('hidden');
        }

        /**
         * Analyzes activities and calculates weekly statistics.
         * @param {Array} activities - An array of activity objects.
         * @returns {Array} An array of weekly statistics.
         */
        function analyzeActivitiesForWeeklyStats(activities) {
            const weeklyStats = {};

            activities.forEach(activity => {
                const date = new Date(activity.start_date);
                // Calculate week number (simple approach: start of week is Monday)
                const dayOfWeek = (date.getDay() + 6) % 7; // 0 for Monday, 6 for Sunday
                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() - dayOfWeek);
                startOfWeek.setHours(0, 0, 0, 0);

                const weekKey = startOfWeek.toISOString().slice(0, 10); //YYYY-MM-DD for start of week

                if (!weeklyStats[weekKey]) {
                    weeklyStats[weekKey] = {
                        week: weekKey,
                        totalDistance: 0,
                        totalDuration: 0,
                        activityCount: 0,
                        maxDistanceActivity: null
                    };
                }

                weeklyStats[weekKey].totalDistance += activity.distance; // meters
                weeklyStats[weekKey].totalDuration += activity.elapsed_time; // seconds
                weeklyStats[weekKey].activityCount++;

                if (!weeklyStats[weekKey].maxDistanceActivity || activity.distance > weeklyStats[weekKey].maxDistanceActivity.distance) {
                    weeklyStats[weekKey].maxDistanceActivity = {
                        name: activity.name,
                        distance: activity.distance
                    };
                }
            });

            // Convert to array and sort by week
            const sortedStats = Object.values(weeklyStats).sort((a, b) => new Date(a.week) - new Date(b.week));

            // Convert distance to km, duration to hours, calculate average pace
            return sortedStats.map(stat => ({
                week: stat.week,
                totalDistanceKm: stat.totalDistance / 1000,
                totalDurationHours: stat.totalDuration / 3600,
                activityCount: stat.activityCount,
                averagePaceMinPerKm: stat.totalDistance > 0 ? (stat.totalDuration / 60) / (stat.totalDistance / 1000) : 0,
                maxDistanceActivityName: stat.maxDistanceActivity ? stat.maxDistanceActivity.name : 'N/A',
                maxDistanceActivityKm: stat.maxDistanceActivity ? stat.maxDistanceActivity.distance / 1000 : 0
            }));
        }

        /**
         * Renders the D3.js bubble chart for weekly statistics.
         * @param {Array} data - Processed weekly statistics data.
         */
        function renderBubbleChart(data) {
            weeklyStatsChart.innerHTML = ''; // Clear previous chart
            chartMessage.textContent = ''; // Clear any previous messages

            if (data.length === 0) {
                chartMessage.textContent = 'Không có dữ liệu thống kê hàng tuần để hiển thị.';
                return;
            }

            // Ensure data is sorted by week
            data.sort((a, b) => new Date(a.week) - new Date(b.week));

            const margin = { top: 20, right: 30, bottom: 60, left: 70 };
            const width = weeklyStatsChart.clientWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#weekly-stats-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleBand()
                .domain(data.map(d => d.week))
                .range([0, width])
                .padding(0.2);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.totalDistanceKm) * 1.1]) // 10% buffer for max distance
                .range([height, 0]);

            const r = d3.scaleSqrt()
                .domain([0, d3.max(data, d => d.activityCount)])
                .range([5, 30]); // Min and max radius for bubbles

            const color = d3.scaleSequential(d3.interpolateViridis)
                .domain([0, d3.max(data, d => d.totalDurationHours)]);

            // Axes
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b %d"))) // Format date as Month Day
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => `${d} km`));

            // Axis Labels
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .text("Tuần (Bắt đầu từ Thứ Hai)");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .text("Tổng quãng đường (km)");

            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background-color", "white")
                .style("border", "1px solid #ccc")
                .style("padding", "8px")
                .style("border-radius", "4px")
                .style("pointer-events", "none")
                .style("opacity", 0);

            // Bubbles
            svg.selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.week) + x.bandwidth() / 2)
                .attr("cy", d => y(d.totalDistanceKm))
                .attr("r", d => r(d.activityCount))
                .style("fill", d => color(d.totalDurationHours))
                .style("opacity", 0.7)
                .style("stroke", "black")
                .style("stroke-width", 1)
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    tooltip.html(`
                        <strong>Tuần:</strong> ${new Date(d.week).toLocaleDateString('vi-VN', { year: 'numeric', month: 'short', day: 'numeric' })}<br>
                        <strong>Tổng quãng đường:</strong> ${d.totalDistanceKm.toFixed(2)} km<br>
                        <strong>Tổng thời gian:</strong> ${d.totalDurationHours.toFixed(2)} giờ<br>
                        <strong>Số hoạt động:</strong> ${d.activityCount}<br>
                        <strong>Tốc độ trung bình:</strong> ${d.averagePaceMinPerKm.toFixed(2)} phút/km<br>
                        <strong>Hoạt động dài nhất:</strong> ${d.maxDistanceActivityName} (${d.maxDistanceActivityKm.toFixed(2)} km)
                    `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        }

        // --- Event Handlers ---

        connectStravaBtn.onclick = () => {
            // Strava OAuth URL (replace client_id with your Strava API client ID)
            // Ensure this CLIENT_ID is registered on Strava
            const CLIENT_ID = '123533'; // Replace with your actual Strava Client ID
            const REDIRECT_URI = window.location.origin; // Dynamically get current origin
            const SCOPE = 'activity:read_all'; // Requesting permission to read all activities

            const stravaAuthUrl = `https://www.strava.com/oauth/authorize?` +
                `client_id=${CLIENT_ID}&` +
                `response_type=code&` +
                `redirect_uri=${REDIRECT_URI}&` +
                `scope=${SCOPE}`;

            window.location.href = stravaAuthUrl;
        };

        loadRecentActivitiesBtn.onclick = async () => {
            if (!currentUserId) {
                showMessage("Lỗi", "Vui lòng đăng nhập để tải hoạt động.");
                return;
            }

            const athleteDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/strava_auth/token`);
            const docSnap = await getDoc(athleteDocRef);
            let athleteId = null;

            if (docSnap.exists()) {
                athleteId = docSnap.data().id;
            } else {
                showMessage("Lỗi", "Không tìm thấy thông tin vận động viên Strava. Vui lòng kết nối lại.");
                return;
            }

            if (!athleteId) {
                showMessage("Lỗi", "Không tìm thấy ID vận động viên Strava.");
                return;
            }

            selectedRunnerIdForActivities = runnerSelect.value;
            selectedClubIdForActivities = clubSelect.value;

            // Determine which runner's activities to load
            let runnerIdToLoad = selectedRunnerIdForActivities;
            let sourceOfActivities = 'firestore'; // Default to Firestore

            // If a different runner is selected than the current authenticated user,
            // we should try to fetch from Firestore first.
            // If the selected runner is the authenticated user, we can fetch from Strava directly.
            if (athleteId === Number(selectedRunnerIdForActivities)) {
                // This is the authenticated user's own Strava activities
                const accessToken = await getValidStravaAccessToken();
                if (accessToken) {
                    activitiesData = await fetchActivitiesFromStrava(accessToken, athleteId);
                    if (activitiesData.length > 0) {
                        await saveActivitiesToFirestore(String(athleteId), activitiesData); // Save to current user's activities
                    }
                    sourceOfActivities = 'strava';
                } else {
                    activitiesData = await fetchActivitiesFromFirestore(String(athleteId)); // Fallback to Firestore if token fails
                    sourceOfActivities = 'firestore_fallback';
                }
            } else {
                // Loading another runner's activities (from Firestore)
                activitiesData = await fetchActivitiesFromFirestore(runnerIdToLoad);
            }

            // Filter activities by club if a club is selected
            let filteredActivities = activitiesData;
            if (selectedClubIdForActivities) {
                const selectedClub = allClubs.find(club => club.id === selectedClubIdForActivities);
                if (selectedClub && selectedClub.runner_ids && selectedClub.runner_ids.includes(Number(runnerIdToLoad))) {
                    // Activities are already specific to the runner.
                    // This club filter primarily applies if activities data somehow contained activities from multiple runners
                    // (which it shouldn't if fetched correctly per runner).
                    // For simplicity, assuming `activitiesData` is already for `runnerIdToLoad`.
                    // The club filter is more relevant for `analyze-activities-btn` which might aggregate.
                } else if (selectedClub) {
                    showMessage("Thông báo", `Vận động viên này không thuộc câu lạc bộ đã chọn.`);
                    filteredActivities = []; // Clear activities if runner not in selected club
                }
            }

            renderRecentActivities(filteredActivities);
            if (sourceOfActivities === 'strava') {
                showMessage("Tải thành công", `Đã tải ${activitiesData.length} hoạt động gần đây nhất từ Strava.`);
            } else if (sourceOfActivities === 'firestore') {
                showMessage("Tải thành công", `Đã tải ${activitiesData.length} hoạt động gần đây nhất từ Firestore.`);
            } else {
                showMessage("Tải thành công", `Không thể tải từ Strava, đã tải ${activitiesData.length} hoạt động từ bộ nhớ đệm.`);
            }
        };

        analyzeActivitiesBtn.onclick = async () => {
            showLoading();
            try {
                // If activitiesData is empty, try to load it first
                if (activitiesData.length === 0) {
                    await loadRecentActivitiesBtn.onclick(); // Trigger loading of recent activities first
                    if (activitiesData.length === 0) {
                        showMessage("Thông báo", "Không có hoạt động nào để phân tích. Vui lòng tải hoạt động trước.");
                        return;
                    }
                }

                // Use the currently loaded activitiesData
                weeklyStatsData = analyzeActivitiesForWeeklyStats(activitiesData);
                renderBubbleChart(weeklyStatsData);
                showMessage("Thành công", `Đã phân tích ${weeklyStatsData.length} tuần hoạt động.`);

                // Optionally save the weekly stats back to Firestore for the selected runner
                if (selectedRunnerIdForActivities) {
                    await saveWeeklyStatsToFirestore(selectedRunnerIdForActivities, weeklyStatsData);
                }
            } catch (error) {
                console.error("Error analyzing activities:", error);
                showMessage("Lỗi", "Không thể phân tích hoạt động.");
            } finally {
                hideLoading();
            }
        };

        loadWeeklyStatsBtn.onclick = async () => {
            showLoading();
            try {
                selectedRunnerIdForStats = runnerStatsFilter.value;
                selectedClubIdForStats = clubStatsFilter.value;

                let statsToLoad = [];
                if (selectedRunnerIdForStats) {
                    // Load stats for a specific runner
                    statsToLoad = await fetchWeeklyStatsFromFirestore(selectedRunnerIdForStats);
                } else if (selectedClubIdForStats) {
                    // Aggregate stats for all runners in the selected club
                    let allClubActivities = [];
                    const selectedClub = allClubs.find(club => club.id === selectedClubIdForStats);
                    if (selectedClub && selectedClub.runner_ids) {
                        for (const runnerId of selectedClub.runner_ids) {
                            const runnerActivities = await fetchActivitiesFromFirestore(String(runnerId));
                            allClubActivities = allClubActivities.concat(runnerActivities);
                        }
                    }
                    statsToLoad = analyzeActivitiesForWeeklyStats(allClubActivities);
                } else {
                    // Aggregate stats for all runners in the system (potentially very large)
                    let allSystemActivities = [];
                    for (const runner of allRunners) {
                        const runnerActivities = await fetchActivitiesFromFirestore(runner.id);
                        allSystemActivities = allSystemActivities.concat(runnerActivities);
                    }
                    statsToLoad = analyzeActivitiesForWeeklyStats(allSystemActivities);
                }
                weeklyStatsData = statsToLoad; // Update global variable
                renderBubbleChart(weeklyStatsData);
                showMessage("Thành công", `Đã tải thống kê hàng tuần.`);
            } catch (error) {
                console.error("Error loading weekly stats:", error);
                showMessage("Lỗi", "Không thể tải thống kê hàng tuần.");
            } finally {
                hideLoading();
            }
        };

        downloadActivitiesForOtherBtn.onclick = async () => {
            showLoading();
            try {
                selectedRunnerIdForDownload = runnerDownloadSelect.value;
                selectedClubIdForDownload = clubDownloadSelect.value; // Not directly used for single runner download, but kept for context

                if (!selectedRunnerIdForDownload) {
                    showMessage("Lỗi", "Vui lòng chọn vận động viên để tải hoạt động hộ.");
                    return;
                }

                // Ensure the authenticated user has a valid Strava token to perform the proxying if needed
                const accessToken = await getValidStravaAccessToken();
                if (!accessToken) {
                    showMessage("Lỗi", "Bạn cần kết nối Strava để có thể tải hoạt động hộ cho người khác.");
                    return;
                }

                // Assume we have the Strava ID of the runner selected in `runnerDownloadSelect`
                // This would typically come from `allRunners` where `runner.id` is the Strava ID.
                const runnerToDownload = allRunners.find(r => String(r.id) === selectedRunnerIdForDownload);
                if (!runnerToDownload) {
                    showMessage("Lỗi", "Không tìm thấy vận động viên được chọn.");
                    return;
                }

                // Here, we're using the *authenticated user's* access token to fetch activities
                // for *another athlete ID* (runnerToDownload.id). This is typically not how Strava API works
                // unless you have special permissions (e.g., admin app).
                // A more realistic scenario would be:
                // 1. Authenticated user has 'view_private' scope if they own the other athlete's data
                // 2. Or, the other athlete has authorized *this app* (via your backend) and you stored their token securely.
                // For this demo's purpose, we'll proceed assuming the authenticated user's token *can* proxy.
                // NOTE: This might hit Strava API limitations or terms of service if not an official partner app.
                console.log(`Attempting to download activities for Strava Athlete ID: ${runnerToDownload.id}`);
                const downloadedActivities = await fetchActivitiesFromStrava(accessToken, Number(runnerToDownload.id));

                if (downloadedActivities.length > 0) {
                    await saveActivitiesToFirestore(selectedRunnerIdForDownload, downloadedActivities);
                    showMessage("Thành công", `Đã tải ${downloadedActivities.length} hoạt động cho vận động viên ${runnerToDownload.name} và lưu vào Firestore.`);
                    // Optionally, re-populate recent activities section with this runner's data
                    runnerSelect.value = selectedRunnerIdForDownload;
                    loadRecentActivitiesBtn.click();
                } else {
                    showMessage("Thông báo", `Không có hoạt động nào được tải về cho vận động viên ${runnerToDownload.name}.`);
                }

            } catch (error) {
                console.error("Error downloading activities for other runner:", error);
                showMessage("Lỗi", "Không thể tải hoạt động hộ. Vui lòng kiểm tra lại quyền hoặc thử lại sau.");
            } finally {
                hideLoading();
            }
        };

        // --- Initial Load and Event Listeners ---
        window.onload = async () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Firebase Authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Firebase authenticated. User ID:", currentUserId);
                    isAuthReady = true;

                    // If a custom token was provided, sign in with it once
                    if (currentAuthToken) {
                        try {
                            await signInWithCustomToken(auth, currentAuthToken);
                            console.log("Signed in with custom token.");
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            // Fallback to anonymous if custom token fails
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously due to custom token failure.");
                        } finally {
                            currentAuthToken = null; // Clear token after use
                        }
                    }

                    // Populate filters only after authentication is ready
                    await populateRunnerAndClubFilters();

                    // Load instruction content
                    const instructionDocRef = doc(db, `artifacts/${appId}/public/data/instructions/usage_guide`);
                    const docSnap = await getDoc(instructionDocRef);
                    if (docSnap.exists()) {
                        const markdownContent = docSnap.data().content;
                        instructionContent.innerHTML = marked.parse(markdownContent);
                    } else {
                        instructionContent.innerHTML = '<p>Không tìm thấy hướng dẫn sử dụng.</p>';
                    }

                    // Trigger initial load of recent activities and detailed stats after all setup
                    loadRecentActivitiesBtn.click(); // Load current user's activities by default
                    loadWeeklyStatsBtn.click(); // Load weekly stats for the default selected runner/club

                } else {
                    // No user signed in, sign in anonymously if no custom token
                    if (!currentAuthToken) {
                        try {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            showMessage("Lỗi đăng nhập", "Không thể đăng nhập. Vui lòng thử lại.");
                        }
                    }
                }
            });
        };

        // Event listeners for UI interactions
        messageCloseBtn.addEventListener('click', hideMessageBox);
        instructionSection.addEventListener('click', () => {
            toggleCollapsible(instructionContent, instructionSection.querySelector('.toggle-icon'));
        });

        // Scroll to top button logic
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 200) { // Show button after scrolling 200px
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Event listener for the runner filter for activities
        runnerSelect.addEventListener('change', loadRecentActivitiesBtn.click);

        // Event listener for the club filter for activities
        clubSelect.addEventListener('change', loadRecentActivitiesBtn.click);

        // Add event listener for the runner stats filter
        runnerStatsFilter.addEventListener('change', () => {
            selectedRunnerIdForStats = runnerStatsFilter.value;
            if (weeklyStatsData.length > 0) { // Only re-render if data already exists
                renderBubbleChart(weeklyStatsData);
            }
        });
        // NEW: Add event listener for the club stats filter
        clubStatsFilter.addEventListener('change', () => {
            selectedClubIdForStats = clubStatsFilter.value;
            // When club filter changes, also update the runner filter for stats
            populateRunnerStatsFilter();
            if (weeklyStatsData.length > 0) { // Only re-render if data already exists
                renderBubbleChart(weeklyStatsData);
            }
        });

        // Add event listener for the new "Download Strava hộ" button
        // The onclick handler is already defined above, attach it here.
        downloadActivitiesForOtherBtn.addEventListener('click', downloadActivitiesForOtherBtn.onclick);

        // Initial collapse instruction section
        toggleCollapsible(instructionContent, instructionSection.querySelector('.toggle-icon'), true);

    </script>
</body>
</html>
