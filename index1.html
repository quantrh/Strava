<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strava Activity Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .section-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            @apply bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition duration-300 ease-in-out shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-300 ease-in-out shadow-md;
        }
        .btn-danger {
            @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out shadow-md;
        }
        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.875rem;
            line-height: 1.25;
            z-index: 10;
        }
        /* Custom styles for bubble chart SVG elements */
        .bubble {
            cursor: pointer;
        }
        .bubble-text {
            text-anchor: middle;
            font-size: 0.75rem; /* Default for mobile, adjusted in JS for larger screens */
            font-weight: bold;
        }
        @media (min-width: 768px) {
            .bubble-text {
                font-size: 1rem; /* Adjust for desktop */
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="container bg-white p-6 rounded-xl shadow-lg my-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">Strava Activity Dashboard</h1>

        <!-- Credential Management Section -->
        <div class="card">
            <h2 class="section-header flex justify-between items-center">
                Quản lý thông tin đăng nhập Strava
                <button id="add-credential-btn" class="btn-primary">Thêm thông tin mới</button>
            </h2>
            <div id="credentials-list" class="space-y-4">
                <!-- Credentials will be loaded here -->
                <p class="text-gray-500 text-center" id="no-credentials-message">Không có thông tin đăng nhập nào được lưu.</p>
            </div>
            <p id="loading-credentials" class="text-gray-500 text-center hidden">Đang tải thông tin...</p>
            <p id="error-credentials" class="text-red-500 text-center hidden">Lỗi khi tải thông tin.</p>
        </div>

        <!-- Strava Login Section -->
        <div class="card">
            <h2 class="section-header">Đăng nhập Strava</h2>
            <div class="mb-4">
                <label for="runner-select" class="block text-gray-700 text-sm font-bold mb-2">Chọn Runner để đăng nhập:</label>
                <select id="runner-select" class="form-input">
                    <option value="">-- Chọn Runner --</option>
                </select>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="strava-login-btn" class="btn-primary flex-grow">Đăng nhập với Strava</button>
                <button id="strava-logout-btn" class="btn-secondary flex-grow" style="display: none;">Đăng xuất Strava</button>
            </div>
            <p id="login-status" class="mt-4 text-center text-sm text-gray-600">Chưa đăng nhập.</p>
            <p id="current-runner" class="mt-2 text-center text-sm text-gray-600" style="display: none;">Đang đăng nhập với: <span class="font-semibold" id="current-runner-name"></span></p>
        </div>

        <!-- Activity Data & Visualization Section -->
        <div class="card">
            <h2 class="section-header">Dữ liệu hoạt động & Biểu đồ</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="download-activities-btn" class="btn-primary flex-grow" style="display: none;">Tải hoạt động mới nhất</button>
            </div>
            <p id="activity-status" class="mt-2 text-center text-sm text-gray-600">Chưa có dữ liệu hoạt động.</p>
            <div id="bubble-chart-container" class="w-full overflow-hidden mt-6 bg-gray-50 rounded-lg p-2 md:p-4 min-h-[300px] flex items-center justify-center">
                <!-- Bubble chart will be rendered here by D3.js -->
                <p class="text-gray-500 text-center">Biểu đồ sẽ hiển thị sau khi tải dữ liệu hoạt động.</p>
            </div>
        </div>
    </div>

    <!-- Credential Modal -->
    <div id="credential-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal-btn">&times;</span>
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">Thêm thông tin đăng nhập</h3>
            <form id="credential-form" class="space-y-4">
                <div>
                    <label for="runner-name" class="block text-gray-700 text-sm font-bold mb-2">Tên Runner:</label>
                    <input type="text" id="runner-name" class="form-input" placeholder="Ví dụ: MyRunningAccount" required>
                </div>
                <div>
                    <label for="client-id" class="block text-gray-700 text-sm font-bold mb-2">Client ID:</label>
                    <input type="text" id="client-id" class="form-input" placeholder="Nhập Strava Client ID" required>
                </div>
                <div>
                    <label for="client-secret" class="block text-gray-700 text-sm font-bold mb-2">Client Secret:</label>
                    <input type="password" id="client-secret" class="form-input" placeholder="Nhập Strava Client Secret" required>
                </div>
                <div>
                    <label for="refresh-token" class="block text-gray-700 text-sm font-bold mb-2">Refresh Token:</label>
                    <input type="password" id="refresh-token" class="form-input" placeholder="Nhập Strava Refresh Token" required>
                </div>
                <div>
                    <label for="redirect-uri" class="block text-gray-700 text-sm font-bold mb-2">Redirect URI:</label>
                    <input type="text" id="redirect-uri" class="form-input" placeholder="Nhập Strava Redirect URI" required>
                </div>
                <input type="hidden" id="credential-id">
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" id="cancel-modal-btn" class="btn-secondary">Hủy</button>
                    <button type="submit" class="btn-primary">Lưu thông tin</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Cấu hình Supabase - THAY THẾ BẰNG CHI TIẾT SUPABASE THỰC TẾ CỦA BẠN
        // Bạn có thể tìm thấy các thông tin này trong cài đặt dự án Supabase -> API
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // ví dụ: 'https://abcde12345.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // ví dụ: 'eyJhbGciOiJIUzI1NiI...'

        let supabaseClientInstance; // Khai báo biến client Supabase

        // Các phần tử DOM
        const addCredentialBtn = document.getElementById('add-credential-btn');
        const credentialsList = document.getElementById('credentials-list');
        const noCredentialsMessage = document.getElementById('no-credentials-message');
        const loadingCredentials = document.getElementById('loading-credentials');
        const errorCredentials = document.getElementById('error-credentials');

        const credentialModal = document.getElementById('credential-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const credentialForm = document.getElementById('credential-form');
        const runnerNameInput = document.getElementById('runner-name');
        const clientIdInput = document.getElementById('client-id');
        const clientSecretInput = document.getElementById('client-secret');
        const refreshTokenInput = document.getElementById('refresh-token');
        const redirectUriInput = document.getElementById('redirect-uri');
        const credentialIdInput = document.getElementById('credential-id');

        const runnerSelect = document.getElementById('runner-select');
        const stravaLoginBtn = document.getElementById('strava-login-btn');
        const stravaLogoutBtn = document.getElementById('strava-logout-btn');
        const loginStatus = document.getElementById('login-status');
        const currentRunnerDisplay = document.getElementById('current-runner');
        const currentRunnerNameSpan = document.getElementById('current-runner-name');
        const downloadActivitiesBtn = document.getElementById('download-activities-btn');
        const activityStatus = document.getElementById('activity-status');
        const bubbleChartContainer = document.getElementById('bubble-chart-container');

        let weeklyStatsData = []; // Biến toàn cục để lưu trữ dữ liệu hoạt động đã xử lý cho việc hiển thị biểu đồ

        // --- Hàm tiện ích ---

        /**
         * Chuyển đổi định dạng tuần ISO (YYYY-WW) thành đối tượng Date.
         * Ngày trả về là thứ Hai của tuần đó.
         * @param {string} w - Chuỗi tuần ở định dạng ISO-WW.
         * @returns {Date} Đối tượng Date đại diện cho thứ Hai của tuần đã cho.
         */
        function getDateFromISOWeek(w) {
            const [year, week] = w.split('-W').map(Number);
            const date = new Date(year, 0, 1 + (week - 1) * 7); // Bắt đầu năm, sau đó thêm tuần
            // Điều chỉnh về ngày đầu tiên của tuần (thứ Hai)
            const dayOfWeek = date.getDay(); // 0 cho Chủ Nhật, 1 cho thứ Hai, v.v.
            const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Điều chỉnh cho thứ Hai
            return new Date(date.setDate(diff));
        }

        /**
         * Định dạng thời lượng theo giây thành chuỗi dễ đọc (Hh Mm Ss).
         * @param {number} totalSeconds - Tổng thời lượng theo giây.
         * @returns {string} Chuỗi thời lượng đã định dạng.
         */
        function formatDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);

            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds > 0 || parts.length === 0) parts.push(`${seconds}s`); // Đảm bảo ít nhất giây được hiển thị

            return parts.join(' ');
        }

        /**
         * Hiển thị hộp thông báo đơn giản (thay thế alert()).
         * @param {string} message - Thông báo để hiển thị.
         * @param {string} type - 'success', 'error', 'info'.
         */
        function showMessageBox(message, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-[1001] transition-opacity duration-300 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            }`;
            messageBox.textContent = message;
            document.body.appendChild(messageBox);

            setTimeout(() => {
                messageBox.style.opacity = '0';
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000); // Thông báo biến mất sau 3 giây
        }

        // --- Quản lý thông tin đăng nhập Supabase ---

        /**
         * Lấy và hiển thị thông tin đăng nhập Strava từ Supabase.
         */
        async function displayCredentials() {
            loadingCredentials.classList.remove('hidden');
            errorCredentials.classList.add('hidden');
            credentialsList.innerHTML = '';
            noCredentialsMessage.classList.add('hidden');

            try {
                const { data, error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('*')
                    .order('runner_name', { ascending: true });

                if (error) throw error;

                if (data.length === 0) {
                    noCredentialsMessage.classList.remove('hidden');
                    runnerSelect.innerHTML = '<option value="">-- Chọn Runner --</option>'; // Xóa các tùy chọn chọn
                } else {
                    noCredentialsMessage.classList.add('hidden');
                    runnerSelect.innerHTML = '<option value="">-- Chọn Runner --</option>'; // Đặt lại trước khi điền

                    data.forEach(cred => {
                        // Thêm vào danh sách thông tin đăng nhập
                        const maskedSecret = '*'.repeat(cred.client_secret.length);
                        const maskedRefresh = '*'.repeat(cred.refresh_token.length);
                        const maskedRedirectUri = cred.redirect_uri ? '*'.repeat(cred.redirect_uri.length) : 'N/A'; // Mask redirect URI

                        const credDiv = document.createElement('div');
                        credDiv.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3';
                        credDiv.innerHTML = `
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${cred.runner_name}</p>
                                <p class="text-sm text-gray-600">Client ID: <span class="font-mono">${cred.client_id}</span></p>
                                <p class="text-sm text-gray-600">Client Secret: <span class="font-mono">${maskedSecret}</span></p>
                                <p class="text-sm text-gray-600">Refresh Token: <span class="font-mono">${maskedRefresh}</span></p>
                                <p class="text-sm text-gray-600">Redirect URI: <span class="font-mono">${maskedRedirectUri}</span></p>
                            </div>
                            <div class="flex flex-row gap-2 mt-2 sm:mt-0">
                                <button class="btn-secondary btn-edit" data-id="${cred.id}">Sửa</button>
                                <button class="btn-danger btn-delete" data-id="${cred.id}">Xóa</button>
                            </div>
                        `;
                        credentialsList.appendChild(credDiv);

                        // Thêm vào dropdown chọn runner
                        const option = document.createElement('option');
                        option.value = cred.client_id; // Sử dụng client_id làm giá trị để đăng nhập
                        option.textContent = cred.runner_name;
                        option.dataset.id = cred.id; // Lưu ID Supabase
                        runnerSelect.appendChild(option);
                    });
                    
                    // Gắn trình nghe sự kiện cho các nút chỉnh sửa và xóa
                    document.querySelectorAll('.btn-edit').forEach(button => {
                        button.onclick = (e) => openCredentialModal(e.target.dataset.id);
                    });
                    document.querySelectorAll('.btn-delete').forEach(button => {
                        button.onclick = async (e) => {
                            const confirmed = window.confirm('Bạn có chắc chắn muốn xóa thông tin đăng nhập này không?'); // Sử dụng window.confirm để giữ nguyên hành vi đơn giản
                            if (confirmed) {
                                await deleteCredential(e.target.dataset.id);
                            }
                        };
                    });
                }
            }
            catch (error) {
                console.error('Lỗi khi lấy thông tin đăng nhập:', error.message);
                errorCredentials.textContent = `Lỗi: ${error.message}`;
                errorCredentials.classList.remove('hidden');
                showMessageBox(`Lỗi khi tải thông tin: ${error.message}`, 'error');
            }
            finally {
                loadingCredentials.classList.add('hidden');
            }
        }

        /**
         * Mở modal để thêm hoặc chỉnh sửa thông tin đăng nhập.
         * @param {string|null} id - ID của thông tin đăng nhập để chỉnh sửa, hoặc null cho thông tin mới.
         */
        async function openCredentialModal(id = null) {
            credentialForm.reset();
            credentialIdInput.value = '';
            modalTitle.textContent = 'Thêm thông tin đăng nhập';

            if (id) {
                modalTitle.textContent = 'Sửa thông tin đăng nhập';
                try {
                    const { data, error } = await supabaseClientInstance
                        .from('runner_credentials')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    runnerNameInput.value = data.runner_name;
                    clientIdInput.value = data.client_id;
                    clientSecretInput.value = data.client_secret; // Để chỉnh sửa, hiển thị giá trị thực
                    refreshTokenInput.value = data.refresh_token; // Để chỉnh sửa, hiển thị giá trị thực
                    redirectUriInput.value = data.redirect_uri; // Điền trường mới
                    credentialIdInput.value = data.id;
                } catch (error) {
                    console.error('Lỗi khi lấy thông tin đăng nhập để chỉnh sửa:', error.message);
                    showMessageBox(`Lỗi khi tải chi tiết: ${error.message}`, 'error');
                }
            }
            credentialModal.style.display = 'flex';
        }

        /**
         * Lưu (thêm hoặc cập nhật) thông tin đăng nhập vào Supabase.
         * @param {Event} event - Sự kiện gửi biểu mẫu.
         */
        async function saveCredential(event) {
            event.preventDefault();

            const id = credentialIdInput.value;
            const runnerName = runnerNameInput.value.trim();
            const clientId = clientIdInput.value.trim();
            const clientSecret = clientSecretInput.value.trim();
            const refreshToken = refreshTokenInput.value.trim();
            const redirectUri = redirectUriInput.value.trim(); // Lấy giá trị trường mới

            if (!runnerName || !clientId || !clientSecret || !refreshToken || !redirectUri) {
                showMessageBox('Vui lòng điền đầy đủ tất cả các trường.', 'error');
                return;
            }

            const newCredential = {
                runner_name: runnerName,
                client_id: clientId,
                client_secret: clientSecret,
                refresh_token: refreshToken,
                redirect_uri: redirectUri // Thêm redirect_uri vào payload
            };

            try {
                let error = null;
                if (id) {
                    // Cập nhật thông tin đăng nhập hiện có
                    const { error: updateError } = await supabaseClientInstance
                        .from('runner_credentials')
                        .update(newCredential)
                        .eq('id', id);
                    error = updateError;
                    showMessageBox('Cập nhật thông tin thành công!', 'success');
                } else {
                    // Thêm thông tin đăng nhập mới
                    const { error: insertError } = await supabaseClientInstance
                        .from('runner_credentials')
                        .insert([newCredential]);
                    error = insertError;
                    showMessageBox('Thêm thông tin mới thành công!', 'success');
                }

                if (error) throw error;

                credentialModal.style.display = 'none';
                await displayCredentials(); // Làm mới danh sách
            } catch (error) {
                console.error('Lỗi khi lưu thông tin đăng nhập:', error.message);
                showMessageBox(`Lỗi khi lưu thông tin: ${error.message}`, 'error');
            }
        }

        /**
         * Xóa thông tin đăng nhập khỏi Supabase.
         * @param {string} id - ID của thông tin đăng nhập để xóa.
         */
        async function deleteCredential(id) {
            try {
                const { error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showMessageBox('Xóa thông tin thành công!', 'success');
                await displayCredentials(); // Làm mới danh sách
            } catch (error) {
                console.error('Lỗi khi xóa thông tin đăng nhập:', error.message);
                showMessageBox(`Lỗi khi xóa thông tin: ${error.message}`, 'error');
            }
        }

        // --- Xác thực Strava & Tương tác API ---

        /**
         * Kiểm tra trạng thái xác thực Strava hiện tại và cập nhật UI.
         */
        async function checkAuthState() {
            const accessToken = localStorage.getItem('strava_access_token');
            const expiresAt = localStorage.getItem('strava_expires_at');
            const refreshToken = localStorage.getItem('strava_refresh_token');
            const runnerName = localStorage.getItem('strava_runner_name');

            console.log('checkAuthState - Kiểm tra trạng thái xác thực...');
            console.log('  accessToken:', accessToken ? 'Có' : 'Không');
            console.log('  expiresAt:', expiresAt ? new Date(parseInt(expiresAt, 10)) : 'Không');
            console.log('  refreshToken:', refreshToken ? 'Có' : 'Không');
            console.log('  runnerName:', runnerName);

            if (accessToken && expiresAt && refreshToken) {
                const now = Date.now();
                if (now < parseInt(expiresAt, 10)) {
                    console.log('  Token hợp lệ. Đã đăng nhập.');
                    loginStatus.textContent = 'Đã đăng nhập.';
                    currentRunnerNameSpan.textContent = runnerName || 'Không rõ';
                    currentRunnerDisplay.style.display = 'block';
                    stravaLoginBtn.style.display = 'none';
                    stravaLogoutBtn.style.display = 'inline-block';
                    downloadActivitiesBtn.style.display = 'inline-block';
                    runnerSelect.value = runnerSelect.querySelector(`option[data-id="${localStorage.getItem('strava_credential_id')}"]`)?.value || ''; // Chọn runner hiện tại trong dropdown

                    // Thử tải hoạt động nếu có sẵn
                    const storedWeeklyStats = localStorage.getItem('weekly_stats_data');
                    if (storedWeeklyStats) {
                        weeklyStatsData = JSON.parse(storedWeeklyStats);
                        renderBubbleChart(weeklyStatsData);
                        activityStatus.textContent = `Đã tải ${weeklyStatsData.length} tuần dữ liệu hoạt động.`;
                        console.log('  Đã tải dữ liệu hoạt động từ LocalStorage.');
                    } else {
                        activityStatus.textContent = 'Đã đăng nhập. Tải hoạt động để xem biểu đồ.';
                        console.log('  Chưa có dữ liệu hoạt động được lưu trữ.');
                    }

                    return true;
                } else {
                    // Mã truy cập đã hết hạn, thử làm mới
                    console.log('  Token đã hết hạn. Đang thử làm mới...');
                    activityStatus.textContent = 'Token đã hết hạn, đang làm mới...';
                    try {
                        const success = await refreshTokenCall(refreshToken);
                        if (success) {
                            showMessageBox('Token đã được làm mới thành công!', 'success');
                            checkAuthState(); // Kiểm tra lại trạng thái sau khi làm mới
                            return true;
                        } else {
                            throw new Error('Làm mới token thất bại.');
                        }
                    } catch (err) {
                        console.error('Lỗi làm mới token:', err);
                        showMessageBox(`Lỗi làm mới token: ${err.message}. Vui lòng đăng nhập lại.`, 'error');
                        clearStravaSession();
                        checkAuthState();
                        return false;
                    }
                }
            } else {
                console.log('  Chưa đăng nhập hoặc thiếu thông tin token.');
                clearStravaSession(); // Đảm bảo tất cả các mục liên quan đã được xóa
                loginStatus.textContent = 'Chưa đăng nhập.';
                currentRunnerDisplay.style.display = 'none';
                stravaLoginBtn.style.display = 'inline-block';
                stravaLogoutBtn.style.display = 'none';
                downloadActivitiesBtn.style.display = 'none';
                bubbleChartContainer.innerHTML = '<p class="text-gray-500 text-center">Biểu đồ sẽ hiển thị sau khi tải dữ liệu hoạt động.</p>';
                weeklyStatsData = [];
                activityStatus.textContent = 'Chưa có dữ liệu hoạt động.';
                return false;
            }
        }

        /**
         * Xóa tất cả dữ liệu phiên Strava khỏi bộ nhớ cục bộ.
         */
        function clearStravaSession() {
            console.log('clearStravaSession - Đang xóa dữ liệu phiên Strava khỏi localStorage.');
            localStorage.removeItem('strava_access_token');
            localStorage.removeItem('strava_refresh_token');
            localStorage.removeItem('strava_expires_at');
            localStorage.removeItem('strava_athlete_id');
            localStorage.removeItem('strava_runner_name');
            localStorage.removeItem('strava_credential_id_selected'); // Xóa ID thông tin đăng nhập đã chọn
            localStorage.removeItem('strava_client_id_selected'); // Xóa Client ID đã chọn
            localStorage.removeItem('weekly_stats_data'); // Xóa dữ liệu hoạt động luôn
        }

        /**
         * Làm mới mã truy cập Strava bằng cách sử dụng mã làm mới.
         * @param {string} refreshToken - Mã làm mới hiện tại.
         * @returns {Promise<boolean>} True nếu làm mới thành công, ngược lại là false.
         */
        async function refreshTokenCall(refreshToken) {
            console.log('refreshTokenCall - Đang gọi API làm mới token...');
            try {
                const storedRunnerName = localStorage.getItem('strava_runner_name');
                const credentialId = localStorage.getItem('strava_credential_id_selected'); // Lấy ID thông tin đăng nhập đã chọn
                
                if (!storedRunnerName || !credentialId) {
                    throw new Error('Không tìm thấy tên runner hoặc ID thông tin đăng nhập để làm mới token.');
                }
                
                console.log('  Lấy client_id và client_secret cho runner:', storedRunnerName, 'với ID:', credentialId);
                const { data: credData, error: credError } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('client_id, client_secret')
                    .eq('id', credentialId) // Sử dụng ID để tìm kiếm chính xác
                    .single();

                if (credError || !credData) {
                    throw new Error(`Không tìm thấy thông tin đăng nhập phù hợp cho ID ${credentialId} để làm mới token.`);
                }

                console.log('  Đã tìm thấy thông tin đăng nhập:', credData);

                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: credData.client_id,
                        client_secret: credData.client_secret,
                        refresh_token: refreshToken,
                        grant_type: 'refresh_token'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('  Phản hồi lỗi từ API làm mới token:', errorData);
                    throw new Error(`Làm mới token thất bại: ${errorData.message || response.statusText}`);
                }

                const data = await response.json();
                console.log('  Phản hồi thành công từ API làm mới token:', data);
                localStorage.setItem('strava_access_token', data.access_token);
                localStorage.setItem('strava_refresh_token', data.refresh_token);
                localStorage.setItem('strava_expires_at', data.expires_at * 1000);
                return true;
            } catch (error) {
                console.error('Lỗi khi làm mới token:', error.message);
                return false;
            }
        }

        /**
         * Chuyển hướng đến Strava để ủy quyền OAuth.
         * @param {string} clientId - Client ID của Strava để sử dụng cho ủy quyền.
         */
        async function authorizeStrava(clientId) {
            console.log('authorizeStrava - Đang bắt đầu ủy quyền Strava với Client ID:', clientId);

            const selectedOption = runnerSelect.options[runnerSelect.selectedIndex];
            const selectedCredentialId = selectedOption ? selectedOption.dataset.id : null;

            if (!selectedCredentialId) {
                showMessageBox('Vui lòng chọn một Runner để đăng nhập.', 'error');
                return;
            }

            // Lưu trữ client_id và id thông tin đăng nhập đã chọn vào localStorage TRƯỚC KHI chuyển hướng
            localStorage.setItem('strava_client_id_selected', clientId);
            localStorage.setItem('strava_credential_id_selected', selectedCredentialId);
            console.log('  Đã lưu Client ID và Credential ID vào localStorage trước khi chuyển hướng.');

            // Lấy redirect_uri từ Supabase dựa trên credentialId đã chọn
            try {
                const { data: credData, error: credError } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('redirect_uri')
                    .eq('id', selectedCredentialId)
                    .single();

                if (credError) {
                    console.error('Lỗi khi lấy URI chuyển hướng để ủy quyền:', credError.message);
                    showMessageBox(`Lỗi: Không tìm thấy Redirect URI cho Client ID đã chọn.`, 'error');
                    return;
                }
                if (!credData || !credData.redirect_uri) {
                    showMessageBox('Lỗi: Không tìm thấy Redirect URI cho Client ID đã chọn.', 'error');
                    return;
                }
                const redirectUri = credData.redirect_uri;
                console.log('  Đã lấy Redirect URI từ Supabase:', redirectUri);

                const scope = 'activity:read_all'; // Yêu cầu phạm vi để đọc tất cả hoạt động
                const authUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&approval_prompt=auto&scope=${scope}`;
                
                console.log('  Chuyển hướng đến URL ủy quyền Strava:', authUrl);
                window.open(authUrl, '_blank'); // Mở trang ủy quyền Strava trong một tab mới
            } catch (error) {
                console.error('Lỗi trong authorizeStrava:', error.message);
                showMessageBox(`Lỗi trong quá trình ủy quyền: ${error.message}`, 'error');
            }
        }

        /**
         * Xử lý callback OAuth từ Strava, trao đổi mã để lấy mã truy cập.
         */
        async function handleStravaCallback() {
            console.log('handleStravaCallback - Bắt đầu xử lý callback Strava...');
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            console.log('  URL params: code =', code, ', error =', error);

            if (error) {
                showMessageBox(`Lỗi từ Strava: ${error}`, 'error');
                clearStravaSession(); // Xóa phiên nếu có lỗi
                history.replaceState({}, document.title, window.location.pathname); // Dọn dẹp URL
                return;
            }

            if (code) {
                activityStatus.textContent = 'Đang trao đổi mã ủy quyền...';
                try {
                    const clientIdFromLocalStorage = localStorage.getItem('strava_client_id_selected');
                    const credentialIdFromLocalStorage = localStorage.getItem('strava_credential_id_selected');

                    console.log('  Đã lấy từ localStorage: client_id =', clientIdFromLocalStorage, ', credential_id =', credentialIdFromLocalStorage);

                    if (!clientIdFromLocalStorage || !credentialIdFromLocalStorage) {
                        const msg = 'Lỗi: Không tìm thấy Client ID hoặc Credential ID trong localStorage. Vui lòng chọn Runner và đăng nhập lại.';
                        showMessageBox(msg, 'error');
                        console.error(msg);
                        history.replaceState({}, document.title, window.location.pathname); // Dọn dẹp URL
                        return;
                    }

                    // Lấy client secret, refresh token và redirect_uri cho ID thông tin đăng nhập đã chọn từ Supabase
                    const { data: credData, error: credError } = await supabaseClientInstance
                        .from('runner_credentials')
                        .select('client_secret, refresh_token, runner_name, redirect_uri')
                        .eq('id', credentialIdFromLocalStorage) // Sử dụng ID để tìm kiếm chính xác
                        .single();

                    console.log('  Dữ liệu thông tin đăng nhập từ Supabase:', credData);
                    if (credError) throw credError;
                    if (!credData) throw new Error(`Không tìm thấy thông tin đăng nhập cho ID ${credentialIdFromLocalStorage} đã chọn.`);

                    console.log('  Đang trao đổi mã với Strava API...');
                    const response = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            client_id: clientIdFromLocalStorage, // Sử dụng ID từ localStorage
                            client_secret: credData.client_secret,
                            code: code,
                            grant_type: 'authorization_code',
                            redirect_uri: credData.redirect_uri // Chuyển redirect_uri để trao đổi token
                        })
                    });

                    console.log('  Phản hồi từ /oauth/token:', response);
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('  Phản hồi lỗi từ /oauth/token API:', errorData);
                        throw new Error(`Trao đổi mã thất bại: ${errorData.message || response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('  Phản hồi thành công từ /oauth/token API (Dữ liệu token):', data);

                    // Lưu trữ token vào localStorage
                    localStorage.setItem('strava_access_token', data.access_token);
                    localStorage.setItem('strava_refresh_token', data.refresh_token); // Lưu refresh token mới
                    localStorage.setItem('strava_expires_at', data.expires_at * 1000); // Chuyển đổi sang mili giây
                    localStorage.setItem('strava_athlete_id', data.athlete.id);
                    localStorage.setItem('strava_runner_name', credData.runner_name); // Lưu tên runner liên quan
                    console.log('  Đã lưu token và thông tin runner vào localStorage.');

                    showMessageBox('Đăng nhập Strava thành công!', 'success');
                    history.replaceState({}, document.title, window.location.pathname); // Dọn dẹp URL khỏi các tham số OAuth
                    await checkAuthState(); // Cập nhật UI và kiểm tra trạng thái
                    downloadActivitiesBtn.click(); // Tự động kích hoạt tải hoạt động
                } catch (err) {
                    console.error('Lỗi khi xử lý Strava callback:', err);
                    activityStatus.textContent = 'Lỗi đăng nhập Strava.';
                    showMessageBox(`Lỗi đăng nhập Strava: ${err.message}`, 'error');
                    clearStravaSession(); // Xóa phiên nếu có lỗi
                    history.replaceState({}, document.title, window.location.pathname); // Dọn dẹp URL
                }
            } else {
                console.log('  Không có mã ủy quyền trong URL. Không có hành động nào được thực hiện.');
            }
        }

        /**
         * Lấy tất cả hoạt động cho vận động viên đã xác thực từ Strava.
         * @returns {Promise<Array>} Mảng các đối tượng hoạt động.
         */
        async function fetchActivities() {
            activityStatus.textContent = 'Đang tải hoạt động... Vui lòng chờ.';
            downloadActivitiesBtn.disabled = true;
            bubbleChartContainer.innerHTML = '<p class="text-gray-500 text-center">Đang tải dữ liệu hoạt động...</p>';

            const accessToken = localStorage.getItem('strava_access_token');
            if (!accessToken) {
                showMessageBox('Bạn cần đăng nhập Strava trước.', 'error');
                activityStatus.textContent = 'Chưa đăng nhập.';
                downloadActivitiesBtn.disabled = false;
                return;
            }

            let allActivities = [];
            let page = 1;
            const perPage = 200; // Tối đa mỗi trang
            let hasMore = true;

            try {
                while (hasMore) {
                    const response = await fetch(`https://www.strava.com/api/v3/athlete/activities?page=${page}&per_page=${perPage}`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status === 401) {
                            // Token có thể đã hết hạn mặc dù checkAuthState, buộc làm mới và thử lại hoặc đăng xuất
                            showMessageBox('Token Strava không hợp lệ hoặc đã hết hạn. Đang thử làm mới...', 'info');
                            const refreshed = await refreshTokenCall(localStorage.getItem('strava_refresh_token'));
                            if (refreshed) {
                                // Nếu làm mới thành công, thử lại lấy hoạt động
                                return await fetchActivities();
                            } else {
                                throw new Error('Token hết hạn và làm mới thất bại. Vui lòng đăng nhập lại.');
                            }
                        }
                        throw new Error(`Lỗi khi tải hoạt động: ${errorData.message || response.statusText}`);
                    }

                    const activities = await response.json();
                    allActivities = allActivities.concat(activities);

                    if (activities.length < perPage) {
                        hasMore = false; // Không còn hoạt động nào để lấy
                    } else {
                        page++;
                    }
                    activityStatus.textContent = `Đã tải ${allActivities.length} hoạt động...`;
                }

                if (allActivities.length === 0) {
                    activityStatus.textContent = 'Không tìm thấy hoạt động nào.';
                    bubbleChartContainer.innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu hoạt động để hiển thị.</p>';
                    return;
                }

                const runningActivities = allActivities.filter(activity => activity.type === 'Run');
                weeklyStatsData = processActivitiesToWeeklyStats(runningActivities);
                localStorage.setItem('weekly_stats_data', JSON.stringify(weeklyStatsData)); // Lưu vào bộ nhớ cục bộ

                activityStatus.textContent = `Đã tải ${runningActivities.length} hoạt động chạy. Đã tạo ${weeklyStatsData.length} tuần dữ liệu thống kê.`;
                renderBubbleChart(weeklyStatsData);
                showMessageBox('Tải hoạt động thành công!', 'success');

            } catch (error) { 
                console.error('Lỗi khi tải hoạt động:', error);
                activityStatus.textContent = `Lỗi khi tải hoạt động: ${error.message}`;
                showMessageBox(`Lỗi khi tải hoạt động: ${error.message}`, 'error');
                bubbleChartContainer.innerHTML = '<p class="text-red-500 text-center">Lỗi khi tải dữ liệu hoạt động.</p>';
            } finally {
                downloadActivitiesBtn.disabled = false;
            }
        }

        /**
         * Xử lý các hoạt động thô của Strava thành số liệu thống kê hàng tuần.
         * @param {Array<Object>} activities - Mảng các đối tượng hoạt động của Strava.
         * @returns {Array<Object>} Mảng các số liệu thống kê hàng tuần: [{ week: 'YYYY-WW', totalDistance: ..., totalTime: ... }]
         */
        function processActivitiesToWeeklyStats(activities) {
            const weeklyStats = new Map(); // Khóa: ISO-WW

            activities.forEach(activity => {
                const startDate = new Date(activity.start_date);
                const year = startDate.getFullYear();
                // Tính số tuần ISO
                const jan1 = new Date(year, 0, 1);
                const days = Math.floor((startDate - jan1) / (24 * 60 * 60 * 1000));
                const week = Math.ceil((days + jan1.getDay() + 1) / 7); // Điều chỉnh cho tuần ISO (Thứ Hai là đầu tuần)
                const isoWeek = `${year}-W${String(week).padStart(2, '0')}`;

                if (!weeklyStats.has(isoWeek)) {
                    weeklyStats.set(isoWeek, { week: isoWeek, totalDistance: 0, totalTime: 0 });
                }
                const currentWeek = weeklyStats.get(isoWeek);
                currentWeek.totalDistance += activity.distance || 0; // khoảng cách tính bằng mét
                currentWeek.totalTime += activity.moving_time || 0; // thời gian di chuyển tính bằng giây
            });

            return Array.from(weeklyStats.values()).sort((a, b) => a.week.localeCompare(b.week));
        }

        // --- Biểu đồ bong bóng D3.js ---

        /**
         * Hàm vẽ biểu đồ bong bóng dựa trên dữ liệu chạy hàng tuần.
         * @param {Array<Object>} data - Mảng các số liệu thống kê hàng tuần: [{ week: 'YYYY-WW', totalDistance: ..., totalTime: ... }]
         */
        function renderBubbleChart(data) {
            // 1. Chuyển đổi dữ liệu: Nhóm theo tháng
            const monthlyDataMap = new Map();

            data.forEach(d => {
                const dateInWeek = getDateFromISOWeek(d.week);
                const monthKey = dateInWeek.getFullYear() + '-' + String(dateInWeek.getMonth() + 1).padStart(2, '0'); // ISO-MM

                if (!monthlyDataMap.has(monthKey)) {
                    monthlyDataMap.set(monthKey, { month: monthKey, weeks: [] });
                }
                monthlyDataMap.get(monthKey).weeks.push(d);
            });

            // Chuyển đổi bản đồ thành mảng và sắp xếp các tháng (mới nhất trước)
            const monthlyData = Array.from(monthlyDataMap.values()).sort((a, b) => b.month.localeCompare(a.month));

            // 2. Thiết lập SVG
            const container = document.getElementById('bubble-chart-container');
            container.innerHTML = ''; // Xóa biểu đồ trước đó

            if (!monthlyData || monthlyData.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Không có dữ liệu thống kê để hiển thị biểu đồ.</p>';
                return;
            }

            const width = container.clientWidth;
            // Tính toán chiều cao động dựa trên số tháng và kích thước màn hình
            const monthBandHeight = width < 768 ? 120 : 180; // Tăng chiều cao để khoảng cách tốt hơn
            const topPaddingForChart = width < 768 ? 70 : 100; // Tăng khoảng đệm ban đầu

            const totalSvgContentHeight = (monthlyData.length * monthBandHeight) + topPaddingForChart;
            const svgHeight = Math.max(container.clientHeight, totalSvgContentHeight); // Đảm bảo đạt chiều cao tối thiểu

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", svgHeight) // Đặt chiều cao SVG để chứa tất cả nội dung
                .attr("viewBox", `0 0 ${width} ${svgHeight}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            // Định nghĩa tỷ lệ
            const maxDistance = d3.max(data, d => d.totalDistance);
            const minDistance = d3.min(data, d => d.totalDistance);

            // Tỷ lệ bán kính động dựa trên chiều rộng vùng chứa
            const maxRadius = width < 768 ? 30 : 60; // Bán kính tối đa nhỏ hơn cho màn hình nhỏ
            const minRadius = width < 768 ? 8 : 15; // Bán kính tối thiểu nhỏ hơn cho màn hình nhỏ

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxDistance])
                .range([minRadius, maxRadius]); // Bán kính tối thiểu và tối đa cho bong bóng

            // Thang màu: khoảng cách lớn hơn -> màu tối hơn (sử dụng Viridis, đảo ngược)
            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxDistance, minDistance]); // Miền đảo ngược cho màu tối hơn trên các giá trị lớn hơn

            // Thông số bố cục
            const bubbleHorizontalPadding = width < 768 ? 10 : 20; // Khoảng đệm nhỏ hơn cho thiết bị di động
            const bubbleVerticalOffset = monthBandHeight / 2; // Căn giữa bong bóng theo chiều dọc trong dải của chúng

            let currentYOffset = topPaddingForChart; // Bắt đầu bù Y với khoảng đệm đã thêm

            // Tạo một div tooltip (nếu chưa tồn tại)
            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }


            // Vẽ dải của mỗi tháng
            monthlyData.forEach((monthObj, monthIndex) => {
                const monthGroup = svg.append("g")
                    .attr("transform", `translate(0, ${currentYOffset})`);

                // Thêm nhãn tháng
                monthGroup.append("text")
                    .attr("x", 20) // Khoảng đệm trái
                    .attr("y", 25) // Đặt nhãn hơi dưới đầu dải tháng
                    .attr("font-size", width < 768 ? "1rem" : "1.2rem") // Cỡ chữ nhỏ hơn cho thiết bị di động
                    .attr("font-weight", "bold")
                    .attr("fill", "#555")
                    .text(`Tháng ${monthObj.month.substring(5)}/${monthObj.month.substring(0, 4)}`);

                // Sắp xếp các tuần trong tháng (cũ nhất trước để luồng từ trái sang phải)
                monthObj.weeks.sort((a, b) => a.week.localeCompare(b.week));

                let currentX = 20; // Bắt đầu X cho bong bóng đầu tiên trong dải tháng

                // Tính toán vị trí và bán kính cho tất cả các bong bóng trong tháng này trước
                const positionedWeeks = monthObj.weeks.map(d => {
                    const r = radiusScale(d.totalDistance);
                    const cx = currentX + r;
                    currentX += (r * 2) + bubbleHorizontalPadding;
                    return { ...d, r, cx, cy: bubbleVerticalOffset + (width < 768 ? 20 : 30) }; // Bù bong bóng xa hơn bên dưới nhãn tháng
                });

                // Vẽ các vòng tròn
                monthGroup.selectAll(".bubble")
                    .data(positionedWeeks)
                    .enter().append("circle")
                    .attr("class", "bubble")
                    .attr("cx", d => d.cx)
                    .attr("cy", d => d.cy)
                    .attr("r", d => d.r)
                    .attr("fill", d => colorScale(d.totalDistance)) // Áp dụng màu dựa trên khoảng cách
                    .attr("stroke", "#fff") // Đường viền màu trắng để tương phản
                    .attr("stroke-width", 2)
                    .on("mouseover", function(event, d) {
                        d3.select(this).attr("stroke", "orange").attr("stroke-width", 3); // Làm nổi bật khi di chuột qua
                        tooltip.style("opacity", 1)
                            .html(`Tuần: ${d.week}<br>
                                   Quãng đường: ${(d.totalDistance / 1000).toFixed(2)} km<br>
                                   Thời gian: ${formatDuration(d.totalTime)}`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this).attr("stroke", "#fff").attr("stroke-width", 2); // Khôi phục đường viền
                        tooltip.style("opacity", 0);
                    });

                // Thêm nhãn văn bản vào bong bóng
                monthGroup.selectAll(".bubble-text")
                    .data(positionedWeeks)
                    .enter().append("text")
                    .attr("class", "bubble-text")
                    .attr("x", d => d.cx)
                    .attr("y", d => d.cy)
                    .text(d => d.r > (width < 768 ? 15 : 25) ? d.week.split('-W')[1] : '') // Chỉ hiển thị số tuần nếu bong bóng đủ lớn (ngưỡng động)
                    .attr("dy", "0.35em")
                    .attr("fill", "white") // Màu văn bản
                    .attr("pointer-events", "none");

                currentYOffset += monthBandHeight; // Di chuyển đến Y bắt đầu của tháng tiếp theo
            });
        }

        // Logic thực thi chính được bọc trong một IIFE bất đồng bộ
        window.onload = async () => { // Đảm bảo tất cả DOM và script đã tải
            // Kiểm tra xem window.supabase có được định nghĩa không (đối tượng toàn cục từ CDN)
            if (typeof window.supabase === 'undefined') {
                showMessageBox('Lỗi: Thư viện Supabase không được tải. Vui lòng kiểm tra kết nối internet hoặc URL CDN.', 'error');
                console.error('Thư viện Supabase không được định nghĩa. Vui lòng kiểm tra thẻ script CDN Supabase.');
                return; // Dừng thực thi nếu Supabase không khả dụng
            }

            // Khởi tạo phiên bản client Supabase bằng phương thức createClient từ đối tượng 'supabase' toàn cục
            supabaseClientInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Trình nghe sự kiện
            addCredentialBtn.addEventListener('click', () => openCredentialModal());
            closeModalBtn.addEventListener('click', () => credentialModal.style.display = 'none');
            cancelModalBtn.addEventListener('click', () => credentialModal.style.display = 'none');
            credentialForm.addEventListener('submit', saveCredential);

            runnerSelect.addEventListener('change', () => {
                const selectedOption = runnerSelect.options[runnerSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.id) {
                    localStorage.setItem('strava_credential_id', selectedOption.dataset.id);
                    localStorage.setItem('strava_client_id_for_auth', selectedOption.value); // Lưu Client ID đã chọn
                } else {
                    localStorage.removeItem('strava_credential_id');
                    localStorage.removeItem('strava_client_id_for_auth');
                }
            });

            stravaLoginBtn.addEventListener('click', () => {
                const selectedClientId = runnerSelect.value;
                if (!selectedClientId) {
                    showMessageBox('Vui lòng chọn một Runner để đăng nhập.', 'error');
                    return;
                }
                authorizeStrava(selectedClientId);
            });

            stravaLogoutBtn.addEventListener('click', () => {
                clearStravaSession();
                checkAuthState();
                showMessageBox('Đăng xuất Strava thành công!', 'success');
            });

            downloadActivitiesBtn.addEventListener('click', fetchActivities);

            // Tải ban đầu
            await displayCredentials(); // Tải thông tin đăng nhập Supabase trước
            await handleStravaCallback(); // Kiểm tra và xử lý callback từ Strava
            await checkAuthState(); // Kiểm tra trạng thái xác thực ban đầu (phụ thuộc vào thông tin đăng nhập)
            
            // Thêm trình nghe sự kiện thay đổi kích thước để vẽ lại biểu đồ
            window.addEventListener('resize', () => {
                if (weeklyStatsData && weeklyStatsData.length > 0) {
                    renderBubbleChart(weeklyStatsData);
                }
            });
        }; // Kết thúc window.onload
    </script>
</body>
</html>
