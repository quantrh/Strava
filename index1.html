<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Quản lý Thành tích Chạy bộ - FOR RUNNER LOVER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Thêm thư viện Marked.js để phân tích Markdown thành HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Define BIDV brand colors */
        :root {
            --bidv-green: #006b68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Adjust primary button to BIDV green */
        .btn-primary {
            background-color: var(--bidv-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: #005a57; /* Darker green on hover */
        }

        /* Adjust secondary button to BIDV yellow */
        .btn-secondary {
            background-color: var(--bidv-yellow);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background-color: #e6b32a; /* Darker yellow on hover */
        }

        .btn-danger {
            @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out shadow-md;
        }

        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500;
        }
        
        /* Custom styles for multi-select */
        .multi-select-container {
            position: relative;
        }

        .multi-select-selected-items {
            @apply w-full p-2 border border-gray-300 rounded-md bg-white cursor-pointer flex flex-wrap gap-1;
            min-height: 42px; /* Ensure consistent height */
            align-items: center;
        }

        .multi-select-selected-item {
            @apply bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full flex items-center gap-1;
        }

        .multi-select-selected-item span {
            cursor: pointer;
            font-weight: bold;
        }

        .multi-select-options {
            @apply absolute w-full border border-gray-300 rounded-md bg-white shadow-lg z-10;
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            @apply p-2 cursor-pointer hover:bg-gray-100;
        }

        .multi-select-option.selected {
            @apply bg-blue-100 font-semibold;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        /* Styling for the bubble chart container */
        #bubble-chart-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden; /* Hide horizontal overflow */
            overflow-y: auto; /* Allow vertical scrolling */
            background-color: #f9fafb; /* Light background for chart */
            border-radius: 0.5rem;
            min-height: 300px;
        }

        .bubble {
           /* stroke: var(--bidv-green); 
            stroke-width: 2px; remove*/
            fill-opacity: 0.7;
            cursor: pointer;
            transition: fill-opacity 0.3s ease;
        }

        .bubble:hover {
            fill-opacity: 1;
        }

        .bubble-text {
            font-size: 0.8rem;
            text-anchor: middle;
            fill: white;
            pointer-events: none; /* Allow clicks to pass through text to bubble */
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.9rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .flex-wrap > .btn-primary, .flex-wrap > .btn-secondary {
                flex-basis: 100%; /* Full width for buttons on small screens */
            }
        }

        /* Loading spinner for LLM analysis */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid var(--bidv-green); /* BIDV Green */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Collapsible Section Styles */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .collapsible-header h2 {
            margin-bottom: 0;
        }

        .collapsible-content {
            overflow: hidden;
            /* Transition will apply to max-height for divs, but for tbody we'll use display none/table-row-group */
            transition: max-height 0.3s ease-out; 
            max-height: 1000px; /* Large enough to show content for divs */
        }

        .collapsible-content.collapsed {
            max-height: 0; /* For div collapsibles */
            display: none; /* Force hide for tbody elements */
        }

        .toggle-icon {
            transition: transform 0.3s ease-out;
        }

        .toggle-icon.rotate {
            transform: rotate(90deg);
        }

        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        .data-table th {
            background-color: var(--bidv-green);
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .data-table tbody tr:hover {
            background-color: #f0f2f5;
        }
        .data-table .total-row {
            background-color: #e0f2f1; /* Light green for total rows */
            font-weight: bold;
        }
        .data-table .summary-row {
            background-color: #d1e7dd; /* Slightly darker green for summary */
            font-weight: bold;
        }
        .data-table .missing-row {
            background-color: #fee2e2; /* Light red for missing info */
            color: #ef4444;
            font-weight: bold;
        }
        /* Style for the tbody containing summary and total, make it look like a cohesive row */
        .data-table .runner-summary-group {
             border-bottom: 2px solid var(--bidv-green); /* Visual separator */
        }
        /* No border between total and summary row within the same tbody */
        .data-table .runner-summary-group .total-row td,
        .data-table .runner-summary-group .summary-row td {
            border-bottom: none;
        }
        .data-table .runner-summary-group .summary-row td {
            border-top: none;
        }
        .data-table .runner-summary-group .total-row {
            border-bottom: 1px solid #e2e8f0; /* Add a subtle line between total and summary */
        }


        /* Date picker styles */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        input[type="date"] {
            position: relative;
        }
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-clear-button {
            display: none;
        }

        /* Scroll-to-top button styles */
        #scroll-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--bidv-green);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }

        #scroll-to-top-btn:hover {
            background-color: #005a57;
        }
    </style>
</head>
<body>
    <header class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="Running-Management-logo.png" alt="Logo BIDV Running Club" class="h-20 w-auto rounded-md">
                <h1 class="text-2xl font-bold text-white">Running Management with AI✨</h1>
            </div>
            <nav>
                <span id="app-user-status" class="text-white text-sm"></span>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <!-- Application Authentication Section (Supabase Auth) -->
        <section id="app-auth-section" class="card mb-8">
            <div class="collapsible-header" data-target="app-auth-content">
                <h2 class="text-xl font-semibold">Đăng nhập/Đăng ký Ứng dụng</h2>
                <svg class="toggle-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
            <div id="app-auth-content" class="collapsible-content">
                <div id="logged-out-view">
                    <form id="auth-form" class="space-y-4 mb-4">
                        <div>
                            <label for="auth-email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="auth-email" class="form-input" placeholder="example@email.com" required>
                        </div>
                        <div>
                            <label for="auth-password" class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu:</label>
                            <input type="password" id="auth-password" class="form-input" placeholder="Mật khẩu của bạn" required>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="submit" id="signup-btn" class="btn-primary">Đăng ký</button>
                            <button type="submit" id="signin-btn" class="btn-primary">Đăng nhập</button>
                        </div>
                    </form>
                    <div class="text-center">
                        <p class="text-sm text-gray-600 mb-2">Hoặc:</p>
                        <button id="guest-login-btn" class="btn-primary">Tiếp tục với tư cách Khách</button>
                    </div>
                    <div id="auth-message" class="mt-4 text-sm text-center text-red-500"></div>
                </div>
                <div id="logged-in-view" class="hidden text-center">
                    <p class="mb-4 text-lg font-medium">Chào mừng, <span id="current-app-user-email"></span>!</p>
                    <button id="signout-btn" class="btn-danger">Đăng xuất Ứng dụng</button>
                </div>
            </div>
        </section>

        <!-- Credential Management Section -->
        <section class="card mb-8 hidden" id="credential-management-section">
            <div class="collapsible-header" data-target="credential-management-content">
                <h2 class="text-xl font-semibold">Quản lý Runner (Thông tin đăng nhập Strava)</h2>
                <div class="flex items-center gap-2">
                    <button id="add-credential-btn" class="btn-primary text-sm px-3 py-1">Thêm Runner mới</button>
                    <svg class="toggle-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>
            </div>
            <div id="credential-management-content" class="collapsible-content">
                <div id="credentials-list" class="space-y-4">
                    <!-- Credentials will be loaded here -->
                    <p class="text-gray-500 text-center" id="no-credentials-message">Không có runner nào được lưu.</p>
                </div>
                <p id="loading-credentials" class="text-gray-500 text-center hidden">Đang tải thông tin runner...</p>
                <p id="error-credentials" class="text-red-500 text-center hidden">Lỗi khi tải thông tin runner.</p>
            </div>
        </section>

        <!-- Strava Login Section (Adjusted) -->
        <section id="strava-auth-section" class="card mb-8 text-center hidden">
            <div class="collapsible-header" data-target="strava-auth-content">
                <h2 class="text-xl font-semibold">Kết nối tài khoản Strava của bạn</h2>
                <svg class="toggle-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
            <div id="strava-auth-content" class="collapsible-content">
                <p class="mb-6">Để theo dõi thành tích chạy bộ, vui lòng chọn một runner và kết nối với Strava.</p>
                
                <div class="mb-4">
                    <label for="runner-select" class="block text-gray-700 text-sm font-bold mb-2">Chọn Runner để đăng nhập:</label>
                    <select id="runner-select" class="form-input">
                        <option value="">-- Chọn Runner --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Chọn runner đã thêm ở trên để kết nối với Strava.</p>
                </div>

                <!-- UPDATED: Replaced button with image and added centering classes -->
                <img id="connect-strava-btn" 
                     src="btn_strava_connect_with_white.png" 
                     alt="Connect with Strava" 
                     class="block mx-auto cursor-pointer w-48 h-auto rounded-lg shadow-md hover:opacity-90 transition duration-300 ease-in-out mb-4" /> 
                <!-- Added mb-4 for spacing below the image button -->

                <button id="disconnect-strava-btn" class="btn-primary ml-4">
                    Đăng xuất Strava
                </button>
                <div id="auth-status" class="mt-4 text-sm text-gray-600"></div>
                <p id="current-runner-display" class="mt-2 text-center text-sm text-gray-600 hidden">Đang đăng nhập với: <span class="font-semibold" id="current-runner-name"></span></p>
            </div>
        </section>

        <!-- Activity Data & Visualization Section -->
        <section id="data-section" class="card mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Dữ liệu thành tích chạy bộ</h2>
            <p id="user-info" class="mb-4 text-lg font-medium"></p>
            <div class="mb-4">
                <label for="activities-limit" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Số lượng hoạt động muốn tải từ Strava (mặc định 60, max 200):</label>
                <input type="number" id="activities-limit" class="form-input" value="60" min="1" step="1" max="200">
            </div>

            <div class="flex flex-wrap gap-4 mb-6">
                <button id="fetch-activities-btn" class="btn-primary">
                    Tải/Cập nhật dữ liệu từ Strava
                </button>
                
            </div>
            
            <!-- Collapsible section for "Download Strava hộ" -->
            <section id="download-for-other-section" class="mt-6 border-t pt-4">
                <div class="collapsible-header" data-target="download-for-other-content">
                    <h3 class="text-lg font-semibold">Tải dữ liệu Strava cho các Runner khác</h3>
                    <svg class="toggle-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>
                <div id="download-for-other-content" class="collapsible-content">
                    <div class="mb-4">
                        <label for="download-runner-select" class="block text-gray-700 text-sm font-bold mb-2">Chọn Runner để tải hộ:</label>
                        <select id="download-runner-select" class="form-input">
                            <option value="">-- Chọn Runner --</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Chọn một Runner đã thêm để tải các hoạt động Strava của họ.</p>
                    </div>
                    <button id="download-activities-for-other-btn" class="btn-primary">
                        Download Strava hộ
                    </button>
                    <div id="download-for-other-status" class="mt-4 text-sm text-gray-600"></div>
                </div>
            </section>

            <div id="data-status" class="mt-4 text-sm text-gray-600"></div>

            <div id="activities-list-section" class="mt-6 border-t pt-4">
                <h3 class="text-lg font-semibold mb-3">Các hoạt động gần đây:</h3>
                <div class="mb-4">
                    <label for="num-recent-activities" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Số lượng hoạt động gần đây muốn hiển thị (mặc định 10):</label>
                    <input type="number" id="num-recent-activities" class="form-input" value="10" min="1" step="1">
                </div>
                
                <!-- Dropdown for filtering recent activities by runner -->
                <div class="mb-4">
                    <label for="runner-recent-activities-filter" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Lọc hoạt động theo Runner:</label>
                    <select id="runner-recent-activities-filter" class="form-input">
                        <option value="all">Tất cả Runner</option>
                        <!-- Runner options will be populated by JS -->
                    </select>
                </div>

                <!-- NEW: Dropdown for filtering recent activities by club -->
                <div class="mb-4">
                    <label for="club-recent-activities-filter" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Lọc hoạt động theo Câu lạc bộ:</label>
                    <select id="club-recent-activities-filter" class="form-input">
                        <option value="all">Tất cả Câu lạc bộ</option>
                        <!-- Club options will be populated by JS -->
                    </select>
                </div>

                <!-- Moved Activity Type Filter for Recent Activities -->
                <div class="mb-4">
                    <label for="activity-type-filter-recent" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Lọc theo loại hoạt động:</label>
                    <div class="multi-select-container">
                        <div id="multi-select-display-recent" class="multi-select-selected-items">
                            <span class="text-gray-500">Chọn loại hoạt động</span>
                        </div>
                        <div id="multi-select-options-recent" class="multi-select-options hidden">
                            <!-- Options will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Moved Date Range Filter for Recent Activities -->
                <div class="mb-4 flex gap-4">
                    <div class="flex-1">
                        <label for="start-date-recent" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Từ ngày:</label>
                        <input type="date" id="start-date-recent" class="form-input">
                    </div>
                    <div class="flex-1">
                        <label for="end-date-recent" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Đến ngày:</label>
                        <input type="date" id="end-date-recent" class="form-input">
                    </div>
                </div>

                <!-- MOVED this button down -->
                <button id="load-recent-activities-btn" class="btn-primary mb-4">
                    Tải hoạt động gần đây
                </button>
                <button id="analyze-activities-btn" class="btn-primary">
                    ✨ Phân tích hoạt động (AI)
                </button>
                <!-- Changed from ul to div for multi-column layout -->
                <div id="recent-activities-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="card p-4 text-gray-500 text-center col-span-full">Nhấn "Tải hoạt động gần đây" để xem.</div>
                </div>
                <div id="recent-activities-status" class="mt-2 text-sm text-gray-600"></div>
            </div>

            <div id="llm-analysis-section" class="mt-6 border-t pt-4 hidden">
                <h3 class="text-lg font-semibold mb-3">Phân tích hoạt động của bạn:</h3>
                <div id="llm-analysis-content" class="bg-gray-100 p-4 rounded-md text-sm">
                    <p class="text-gray-500">Nhấn "✨ Phân tích hoạt động (AI)" để nhận phân tích từ AI.</p>
                </div>
                <div id="llm-analysis-status" class="mt-2 text-sm text-gray-600"></div>
            </div>

        </section>

        <!-- New Detailed Stats Section -->
        <section id="detailed-stats-section" class="card hidden mb-8">
            <h3 class="text-xl font-semibold mb-4">Thống kê chi tiết & Tiền phạt/Thưởng</h3>
            <div class="mb-4 flex gap-4 items-end">
                <div class="flex-1">
                    <label for="penalty-per-km-gt10" class="block text-gray-700 text-sm font-bold mb-2">Số tiền nộp cho 1KM (nghìn VNĐ) khi thiếu > 10KM:</label>
                    <input type="number" id="penalty-per-km-gt10" class="form-input bg-yellow-100" value="30" min="0" step="1">
                </div>
                <div class="flex-1">
                    <label for="penalty-per-km-lte10" class="block text-gray-700 text-sm font-bold mb-2">Số tiền nộp cho 1KM (nghìn VNĐ) khi thiếu <= 10KM:</label>
                    <input type="number" id="penalty-per-km-lte10" class="form-input bg-yellow-100" value="20" min="0" step="1">
                </div>
                <div class="flex-1">
                    <label for="target-km-per-week" class="block text-gray-700 text-sm font-bold mb-2">Số KM một tuần (KM):</label>
                    <input type="number" id="target-km-per-week" class="form-input bg-yellow-100" value="25" min="0" step="1">
                </div>
            </div>
            <div id="detailed-stats-table-container" class="overflow-x-auto">
                <table id="detailed-stats-table" class="data-table">
                    <thead>
                        <tr>
                            <th>Tên Runner</th>
                            <th>Ngày chạy</th>
                            <th>Loại hoạt động</th>
                            <th>Quãng đường (KM)</th>
                            <th>Pace</th>
                            <th>Nhịp tim TB</th>
                            <th>Độ cao tăng</th>
                            <th>Thời gian chạy</th>
                        </tr>
                    </thead>
                    <!-- The tbodies for each runner will be inserted here dynamically by JS -->
                    <tbody></tbody> <!-- This empty tbody will be selected by JS and filled with content -->
                </table>
                <p id="detailed-stats-status" class="mt-4 text-sm text-gray-600 text-center">Chưa có dữ liệu để hiển thị.</p>
            </div>
        </section>

        <section id="stats-section" class="card hidden">
            <h2 class="text-xl font-semibold mb-4">Thống kê thành tích theo tuần</h2>
            <!-- Runner Filter for Stats Section -->
            <div class="mb-4">
                <label for="runner-stats-filter" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Chọn Runner để xem thống kê:</label>
                <select id="runner-stats-filter" class="form-input">
                    <option value="">Tất cả Runner</option>
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <!-- NEW: Club Filter for Stats Section -->
            <div class="mb-4">
                <label for="club-stats-filter" class="block text-gray-700 text-sm font-bold mb-2" style="background-color: #FFFACD; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Chọn Câu lạc bộ để xem thống kê:</label>
                <select id="club-stats-filter" class="form-input">
                    <option value="">Tất cả Câu lạc bộ</option>
                    <!-- Club options will be populated by JS -->
                </select>
            </div>

            <!-- Moved view-stats-btn here -->
            <button id="view-stats-btn" class="btn-primary mb-4">
                Xem thống kê theo tuần
            </button>

            <div id="bubble-chart-container">
                <p class="text-gray-500 text-center">Nhấn "Xem thống kê theo tuần" để hiển thị biểu đồ.</p>
            </div>
            <div id="chart-status" class="mt-4 text-sm text-gray-600"></div>
        </section>

        <!-- Instruction Section -->
        <section id="instruction-section" class="card mb-8">
            <div class="collapsible-header" data-target="instruction-content">
                <h2 class="text-xl font-semibold">Hướng dẫn sử dụng ứng dụng</h2>
                <svg class="toggle-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
            <div id="instruction-content" class="collapsible-content">
                <div class="space-y-4 text-gray-700 max-h-96 overflow-y-auto pr-2">
                    <p>Chào mừng bạn đến với Ứng dụng Quản lý Thành tích Chạy bộ - FOR RUNNER LOVER!</p>
                    <h3 class="font-bold text-lg text-bidv-green">1. Đăng nhập/Đăng ký Ứng dụng:</h3>
                    <ul class="list-disc ml-6 space-y-1">
                        <li>Bạn có thể đăng ký tài khoản mới bằng Email và Mật khẩu.</li>
                        <li>Đăng nhập nếu đã có tài khoản.</li>
                        <li>Hoặc chọn "Tiếp tục với tư cách Khách" để sử dụng các chức năng cơ bản mà không cần đăng ký.</li>
                    </ul>
                    <h3 class="font-bold text-lg text-bidv-green">2. Quản lý Runner (Kết nối với Strava):</h3>
                    <ul class="list-disc ml-6 space-y-1">
                        <li>Để thêm một Runner mới và kết nối với tài khoản Strava của họ, nhấn "Thêm Runner mới".</li>
                        <li>Bạn sẽ được yêu cầu nhập tên cho Runner và sau đó được chuyển hướng đến trang ủy quyền của Strava.</li>
                        <li>Sau khi cấp quyền thành công, thông tin Runner và Strava Athlete ID sẽ được lưu lại.</li>
                        <li>Chỉ chủ sở hữu của thông tin runner mới có thể sửa hoặc xóa thông tin đó.</li>
                        <li>Lưu ý: Bạn không cần phải tự tạo ứng dụng Strava API hay nhập Client ID/Secret nữa.</li>
                    </ul>
                    <h3 class="font-bold text-lg text-bidv-green">3. Chọn Runner để làm việc:</h3>
                    <ul class="list-disc ml-6 space-y-1">
                        <li>Chọn một Runner từ danh sách "Chọn Runner để đăng nhập" để tải và quản lý dữ liệu cho Runner đó.</li>
                        <li>Ứng dụng sẽ tự động làm mới token và giữ kết nối với Strava cho Runner đã chọn.</li>
                        <li>Sử dụng "Đăng xuất Strava" để ngắt kết nối với Runner hiện tại.</li>
                    </ul>
                    <h3 class="font-bold text-lg text-bidv-green">4. Dữ liệu thành tích chạy bộ:</h3>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Tải/Cập nhật dữ liệu từ Strava:</strong> Tải các hoạt động chạy bộ từ tài khoản Strava đang kết nối về cơ sở dữ liệu của ứng dụng. Bạn có thể giới hạn số lượng hoạt động muốn tải.</li>
                        <li><strong>Lọc theo loại hoạt động:</strong> Chọn một hoặc nhiều loại hoạt động (ví dụ: Run, Ride, Swim) để lọc dữ liệu hiển thị.</li>
                        <li><strong>Lọc theo thời gian "Từ ngày đến ngày":</strong> Chọn khoảng thời gian để lọc các hoạt động.</li>
                        <li><strong>Các hoạt động gần đây:</strong> Hiển thị danh sách các hoạt động gần đây nhất đã được tải về, có thể tùy chỉnh số lượng hiển thị và lọc theo Runner.</li>
                        <li><strong>Phân tích hoạt động (AI):</strong> Sử dụng AI để phân tích các hoạt động gần đây của bạn, đưa ra cái nhìn tổng quan về hiệu suất. Phân tích này sẽ tính đến các bộ lọc hiện có.</li>
                    </ul>
                    <h3 class="font-bold text-lg text-bidv-green">5. Thống kê thành tích theo tuần:</h3>
                    <ul class="list-disc ml-6 space-y-1">
                        <li>Hiển thị biểu đồ bong bóng thống kê tổng quãng đường chạy theo tuần cho Runner đã chọn. Kích thước bong bóng tương ứng với quãng đường.</li>
                        <li>Click vào bong bóng để xem chi tiết các hoạt động trong tuần đó.</li>
                    </ul>
                    <h3 class="font-bold text-lg text-bidv-green">6. Thống kê chi tiết & Tiền phạt/Thưởng:</h3>
                    <ul class="list-disc ml-6 space-y-1">
                        <li>Khu vực này cho phép bạn theo dõi chi tiết từng hoạt động và tính toán các khoản "tiền phạt" nếu không đạt mục tiêu KM hàng tuần.</li>
                        <li>Nhập "Số tiền phạt 1KM" và "Số KM một tuần" theo mục tiêu của bạn.</li>
                        <li>Bảng sẽ tự động cập nhật để hiển thị thông tin chi tiết từng hoạt động đã lọc và tính toán tổng kết cho từng runner, bao gồm số KM thiếu và số tiền thiếu.</li>
                    </ul>
                    <p class="mt-4">Chúc bạn có những trải nghiệm tuyệt vời với ứng dụng!</p>
                </div>
            </div>
        </section>

    </main>

<footer class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
    <div class="container" style="color: var(--bidv-yellow);">
        &copy; 2025 Trương Hồng Quân - BIDV Running Club. All rights reserved (Dev by AIs - Gemini, GPT).
        <br>
        <img src="PowerStrava.png" alt="PowerStrava Logo" style="height: 28px; margin: 5px auto 0 auto; display: block;">
    </div>
</footer>

    <!-- Scroll to top button -->
    <button id="scroll-to-top-btn" title="Go to top">▲</button>


    <!-- Credential Modal -->
    <div id="credential-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal-btn">&times;</span>
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">Thêm thông tin đăng nhập Runner</h3>
            <form id="credential-form" class="space-y-4">
                <div>
                    <label for="runner-name" class="block text-gray-700 text-sm font-bold mb-2 text-red-500">Tên Runner (Duy nhất):<span class="text-red-500">*</span></label>
                    <input type="text" id="runner-name" class="form-input" placeholder="Ví dụ: MyRunningAccount" required>
                </div>
                <!-- NEW FIELDS ADDED BELOW -->
                <div>
                    <label for="runner-full-name" class="block text-gray-700 text-sm font-bold mb-2">Họ và tên chính thức:</label>
                    <input type="text" id="runner-full-name" class="form-input" placeholder="Ví dụ: Nguyễn Văn A">
                </div>
                <div>
                    <label for="runner-phone-number" class="block text-gray-700 text-sm font-bold mb-2">Số điện thoại:</label>
                    <input type="tel" id="runner-phone-number" class="form-input" placeholder="Ví dụ: 0912345678">
                </div>
                <div>
                    <label for="runner-email" class="block text-gray-700 text-sm font-bold mb-2 text-red-500">Email Runner:<span class="text-red-500">*</span></label>
                    <input type="email" id="runner-email" class="form-input border-red-500 focus:ring-red-500" placeholder="Ví dụ: runner@example.com" required>
                </div>
                <div>
                    <label for="runner-date-of-birth" class="block text-gray-700 text-sm font-bold mb-2">Ngày sinh:</label>
                    <input type="date" id="runner-date-of-birth" class="form-input">
                </div>
                <div>
                    <label for="runner-weight-kg" class="block text-gray-700 text-sm font-bold mb-2">Cân nặng (kg):</label>
                    <input type="number" id="runner-weight-kg" class="form-input" placeholder="Ví dụ: 65" min="1">
                </div>
                <div>
                    <label for="runner-shirt-size" class="block text-gray-700 text-sm font-bold mb-2">Cỡ áo:</label>
                    <select id="runner-shirt-size" class="form-input">
                        <option value="">-- Chọn cỡ áo --</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                        <option value="XXXL">XXXL</option>
                    </select>
                </div>
                <div>
                    <label for="runner-team" class="block text-gray-700 text-sm font-bold mb-2 text-red-500">Đội chạy:<span class="text-red-500">*</span></label>
                    <select id="runner-team" class="form-input border-red-500 focus:ring-red-500" required>
                        <option value="">-- Chọn đội chạy --</option>
                        <!-- Club options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="runner-gender" class="block text-gray-700 text-sm font-bold mb-2 text-red-500">Giới tính:<span class="text-red-500">*</span></label>
                    <select id="runner-gender" class="form-input border-red-500 focus:ring-red-500" required>
                        <option value="">-- Chọn giới tính --</option>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <!-- END NEW FIELDS -->

                <!-- REMOVED: client-id, client-secret, refresh-token inputs -->
                <!-- client_id, client_secret now come from ENV variables on Edge Function side -->
                <!-- refresh_token will be obtained during OAuth flow -->
                
                <div>
                    <label for="redirect-uri" class="block text-gray-700 text-sm font-bold mb-2">Redirect URI:</label>
                    <!-- Value is now fixed and input is readonly -->
                    <input type="text" id="redirect-uri" class="form-input" value="https://quantrh.github.io/Strava/index1.html" readonly required>
                    <p class="text-xs text-gray-500 mt-1">URI này là cố định cho ứng dụng và được dùng trong quá trình ủy quyền Strava.</p>
                </div>
                <input type="hidden" id="credential-id">
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" id="cancel-modal-btn" class="btn-primary">Hủy</button>
                    <button type="submit" class="btn-primary">Lưu thông tin</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Weekly Activities Modal -->
    <div id="weekly-activities-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="close-weekly-activities-modal-btn">&times;</span>
            <h3 id="weekly-activities-title" class="text-2xl font-bold mb-4 text-gray-800">Hoạt động trong tuần:</h3>
            <div class="max-h-96 overflow-y-auto border rounded-md p-2">
                <ul id="weekly-activities-list" class="space-y-2 text-sm">
                    <!-- Activities will be loaded here -->
                </ul>
            </div>
            <p id="weekly-activities-status" class="mt-4 text-sm text-gray-600"></p>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modals -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="alert-message" class="mb-4 text-lg"></p>
            <button id="alert-ok-btn" class="btn-primary">OK</button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="mb-4 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button type="button" id="confirm-cancel-btn" class="btn-primary">Hủy</button>
                <button type="button" id="confirm-ok-btn" class="btn-danger">Đồng ý</button>
            </div>
        </div>
    </div>

    <script>
        // Function to display custom alert instead of alert()
        function showAlert(message) {
            const customAlert = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');

            alertOkBtn.onclick = () => {
                customAlert.classList.add('hidden');
            };
        }

        // Function to display custom confirm dialog instead of window.confirm()
        function showConfirm(message) {
            return new Promise((resolve) => {
                const customConfirm = document.getElementById('custom-confirm-modal');
                const confirmMessage = document.getElementById('confirm-message');
                const confirmOkBtn = document.getElementById('confirm-ok-btn'); 
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                confirmMessage.textContent = message;
                customConfirm.classList.remove('hidden');

                const cleanup = () => {
                    customConfirm.classList.add('hidden');
                    confirmOkBtn.onclick = null;
                    confirmCancelBtn.onclick = null;
                };

                confirmOkBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                confirmCancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        // Your Supabase configuration
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Your Supabase project URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Your public anon key for Supabase
        const STRAVA_OAUTH_CALLBACK_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/strava-oauth-callback';
        const FETCH_ACTIVITIES_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/fetch-strava-activities';
        const GET_STATS_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/get-user-activities';
        // New Edge Function URL for AI analysis
        const ANALYZE_ACTIVITIES_FUNCTION_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/analyze-activities-with-gemini'; 

        // Add the application's global Strava Client ID for OAuth flow
        // You MUST replace 'YOUR_APP_STRAVA_CLIENT_ID' with your actual application's Client ID
        const APP_STRAVA_CLIENT_ID = '55949'; 
        // The Redirect URI must match what you configured in your Strava API Application settings
        const APP_STRAVA_REDIRECT_URI = 'https://quantrh.github.io/Strava/index1.html';


        // Global variables to store user status and activity data
        let currentRunnerCredentialId = null; // This will store the Supabase runner_credentials.id (UUID)
        let isAuthenticated = false; // Tracks if Strava is authenticated (for the *selected* runner)
        let userActivities = []; // New variable to store all loaded activities (for detailed stats)
        let weeklyStatsData = []; // Store weekly stats data globally (for bubble chart)
        let currentAthleteId = null; // Stores Strava athlete ID for API calls and for activities.user_id (of the currently logged-in Strava runner)
        let currentRunnerName = null; // Stores the name of the currently logged-in runner
        let currentAppUserId = null; // Stores Supabase Auth user ID (UUID)
        const ALL_ACTIVITY_TYPES = [
            'Run', 'Walk', 'Ride', 'Swim', 'Hike', 'NordicSki', 'AlpineSki', 'Workout', 'Yoga', 
            'WeightTraining', 'Elliptical', 'StairStepper', 'Rowing', 'Crossfit', 'Canoeing', 
            'Kayaking', 'StandUpPaddling', 'VirtualRide', 'VirtualRun', 'Wheelchair', 'Handcycle', 
            'RollerSki', 'IceSkate', 'Snowboard', 'Snowshoe', 'BackcountrySki', 'EMountainBikeRide', 
            'EBikeRide', 'MountainBikeRide', 'GravelRide', 'Velomobile', 'Kitesurf', 'Windsurf', 
            'RockClimbing', 'Alpinism', 'Badminton', 'Squash', 'TableTennis', 'Tennis', 'Volleyball', 
            'Surfing', 'Pilates', 'Golf', 'WaterSport', 'Soccer', 'Basketball'
        ].sort(); // Sort activity types alphabetically

        let allRunnerCredentials = []; // Store all fetched runner credentials for the current app user
        let allClubs = []; // NEW: Store all fetched clubs

        // Initialize Supabase client instance
        let supabaseClientInstance;

        // DOM elements
        const appUserStatus = document.getElementById('app-user-status');
        const appAuthSection = document.getElementById('app-auth-section');
        const loggedOutView = document.getElementById('logged-out-view');
        const loggedInView = document.getElementById('logged-in-view');
        const currentAppUserEmail = document.getElementById('current-app-user-email');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password'); 
        const signupBtn = document.getElementById('signup-btn');
        const signinBtn = document.getElementById('signin-btn');
        const guestLoginBtn = document.getElementById('guest-login-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const authMessage = document.getElementById('auth-message');

        const credentialManagementSection = document.getElementById('credential-management-section');
        const stravaAuthSection = document.getElementById('strava-auth-section');
        const detailedStatsSection = document.getElementById('detailed-stats-section'); // New DOM element

        const addCredentialBtn = document.getElementById('add-credential-btn');
        const credentialsList = document.getElementById('credentials-list');
        const noCredentialsMessage = document.getElementById('no-credentials-message');
        const loadingCredentials = document.getElementById('loading-credentials');
        const errorCredentials = document.getElementById('error-credentials');
        const credentialModal = document.getElementById('credential-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const credentialForm = document.getElementById('credential-form');
        const runnerNameInput = document.getElementById('runner-name');
        const redirectUriInput = document.getElementById('redirect-uri');
        const credentialIdInput = document.getElementById('credential-id');
        const runnerSelect = document.getElementById('runner-select');
        const connectStravaBtn = document.getElementById('connect-strava-btn'); // This is now the <img> element
        const disconnectStravaBtn = document.getElementById('disconnect-strava-btn');
        const authStatus = document.getElementById('auth-status');
        const currentRunnerDisplay = document.getElementById('current-runner-display');
        const currentRunnerNameSpan = document.getElementById('current-runner-name');
        const fetchActivitiesBtn = document.getElementById('fetch-activities-btn');
        const viewStatsBtn = document.getElementById('view-stats-btn');
        const analyzeActivitiesBtn = document.getElementById('analyze-activities-btn');
        const dataSection = document.getElementById('data-section');
        const userInfo = document.getElementById('user-info');
        const activitiesLimitInput = document.getElementById('activities-limit');
        const numRecentActivitiesInput = document.getElementById('num-recent-activities');
        const loadRecentActivitiesBtn = document.getElementById('load-recent-activities-btn');
        const recentActivitiesContainer = document.getElementById('recent-activities-container'); // Changed from recentActivitiesList
        const recentActivitiesStatus = document.getElementById('recent-activities-status');
        const statsSection = document.getElementById('stats-section');

        // New DOM elements for weekly activities modal
        const weeklyActivitiesModal = document.getElementById('weekly-activities-modal');
        const closeWeeklyActivitiesModalBtn = document.getElementById('close-weekly-activities-modal-btn');
        const weeklyActivitiesTitle = document.getElementById('weekly-activities-title');
        const weeklyActivitiesList = document.getElementById('weekly-activities-list');
        const weeklyActivitiesStatus = document.getElementById('weekly-activities-status');

        // Filter elements
        const multiSelectDisplayRecent = document.getElementById('multi-select-display-recent');
        const multiSelectOptionsRecent = document.getElementById('multi-select-options-recent');
        // Runner filter for recent activities
        const runnerRecentActivitiesFilter = document.getElementById('runner-recent-activities-filter');

        // NEW: Club filter DOM elements
        const runnerTeamSelect = document.getElementById('runner-team'); // Select element in credential modal
        const clubRecentActivitiesFilter = document.getElementById('club-recent-activities-filter');
        const clubStatsFilter = document.getElementById('club-stats-filter');

        let selectedActivityTypesRecent = [];
        let selectedActivityTypesStats = []; 
        let selectedRunnerIdForStats = ''; // Variable for stats runner filter
        let selectedClubIdForStats = ''; // NEW: Variable for stats club filter
        let selectedRunnerIdForRecentActivities = 'all'; // Default to 'all' for recent activities filter
        let selectedClubNameForRecentActivities = 'all'; // NEW: Default to 'all' for recent activities club filter


        // Date filter elements
        const startDateRecent = document.getElementById('start-date-recent');
        const endDateRecent = document.getElementById('end-date-recent');

        // New elements for detailed stats table
        const penaltyPerKmGt10Input = document.getElementById('penalty-per-km-gt10'); // Changed ID
        const penaltyPerKmLte10Input = document.getElementById('penalty-per-km-lte10'); // New input
        const targetKmPerWeekInput = document.getElementById('target-km-per-week');
        const detailedStatsTable = document.getElementById('detailed-stats-table'); // Reference to the whole table
        const detailedStatsStatus = document.getElementById('detailed-stats-status');

        // Collapsible elements
        const appAuthContent = document.getElementById('app-auth-content');
        const credentialManagementContent = document.getElementById('credential-management-content');
        const stravaAuthContent = document.getElementById('strava-auth-content');
        const instructionSection = document.getElementById('instruction-section');
        const instructionContent = document.getElementById('instruction-content');

        // DOM element for runner stats filter
        const runnerStatsFilter = document.getElementById('runner-stats-filter');

        // DOM elements for "Download Strava hộ" feature
        const downloadForOtherSection = document.getElementById('download-for-other-section'); // Reference to the new collapsible section
        const downloadForOtherContent = document.getElementById('download-for-other-content'); // Reference to the content within the new collapsible section
        const downloadRunnerSelect = document.getElementById('download-runner-select');
        const downloadActivitiesForOtherBtn = document.getElementById('download-activities-for-other-btn');
        const downloadForOtherStatus = document.getElementById('download-for-other-status');

        // LLM analysis DOM elements
        const llmAnalysisSection = document.getElementById('llm-analysis-section');
        const llmAnalysisContent = document.getElementById('llm-analysis-content');
        const llmAnalysisStatus = document.getElementById('llm-analysis-status');
        
        // Scroll to top button
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');


        // --- Helper functions for UI and data transformation ---

        /**
         * Toggles the collapsible state of a section.
         * @param {HTMLElement} contentElement - The content div/tbody to collapse/expand.
         * @param {HTMLElement} toggleIcon - The icon element (SVG or span with text).
         * @param {boolean} [forceCollapse] - If true, force collapse. If false, force expand. If undefined, toggles.
         */
        function toggleCollapsible(contentElement, toggleIcon, forceCollapse) {
            const isCollapsed = contentElement.classList.contains('collapsed');

            let shouldCollapse;
            if (forceCollapse !== undefined) {
                shouldCollapse = forceCollapse;
            } else {
                shouldCollapse = !isCollapsed;
            }

            if (shouldCollapse) {
                contentElement.classList.add('collapsed');
                if (toggleIcon.tagName === 'SVG') {
                    toggleIcon.classList.remove('rotate'); // For SVG (main sections)
                } else { // Assume it's a text element (span) for the detailed stats table
                    toggleIcon.textContent = '▶'; // Right-pointing triangle
                }
            } else {
                contentElement.classList.remove('collapsed');
                if (toggleIcon.tagName === 'SVG') {
                    toggleIcon.classList.add('rotate'); // For SVG (main sections)
                } else { // Assume it's a text element (span) for the detailed stats table
                    toggleIcon.textContent = '▼'; // Down-pointing triangle
                }
            }
        }

        /**
         * Populates the multi-select filter dropdowns.
         */
        function populateActivityTypeFilters() {
            const optionsContainer = document.getElementById('multi-select-options-recent');
            optionsContainer.innerHTML = ''; 
            ALL_ACTIVITY_TYPES.forEach(type => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.textContent = type;
                optionDiv.dataset.value = type;
                optionsContainer.appendChild(optionDiv);
            });
        }

        /**
         * Updates the display of selected items in the multi-select.
         * @param {HTMLElement} displayElement - The element to show selected tags.
         * @param {string[]} selectedTypes - Array of selected activity types.
         * @param {HTMLElement} optionsContainer - The container for options to update their 'selected' class.
         */
        function updateMultiSelectDisplay(displayElement, selectedTypes, optionsContainer) {
            displayElement.innerHTML = '';
            if (selectedTypes.length === 0) {
                displayElement.innerHTML = '<span class="text-gray-500">Chọn loại hoạt động</span>';
            } else {
                selectedTypes.forEach(type => {
                    const itemSpan = document.createElement('span');
                    itemSpan.className = 'multi-select-selected-item';
                    itemSpan.innerHTML = `${type} <span data-value="${type}" class="remove-item-btn">&times;</span>`;
                    displayElement.appendChild(itemSpan);
                });
            }

            Array.from(optionsContainer.children).forEach(optionDiv => {
                if (selectedTypes.includes(optionDiv.dataset.value)) {
                    optionDiv.classList.add('selected');
                } else {
                    optionDiv.classList.remove('selected');
                }
            });
        }

        /**
         * Toggles an activity type in the selected list.
         * @param {string} type - The activity type to toggle.
         * @param {string[]} selectedTypesArray - The array to modify (e.g., selectedActivityTypesRecent).
         * @param {HTMLElement} displayElement - The display element for this filter.
         * @param {HTMLElement} optionsContainer - The options container for this filter.
         */
        function toggleActivityType(type, selectedTypesArray, displayElement, optionsContainer) {
            const index = selectedTypesArray.indexOf(type);
            if (index > -1) {
                selectedTypesArray.splice(index, 1); // Remove if already exists
            } else {
                selectedTypesArray.push(type); // Add if not exists
                selectedTypesArray.sort(); // Keep sorted alphabetically
            }
            updateMultiSelectDisplay(displayElement, selectedTypesArray, optionsContainer);
        }

        // Event delegation for multi-select options
        document.addEventListener('click', (event) => {
            // Toggle options visibility
            if (event.target.closest('#multi-select-display-recent')) {
                document.getElementById('multi-select-options-recent').classList.toggle('hidden');
            } else {
                // Click outside to close options
                if (!event.target.closest('.multi-select-options')) {
                    document.getElementById('multi-select-options-recent').classList.add('hidden');
                }
            }

            // Handle option selection/deselection
            if (event.target.classList.contains('multi-select-option')) {
                const type = event.target.dataset.value;
                if (event.target.closest('#multi-select-options-recent')) {
                    toggleActivityType(type, selectedActivityTypesRecent, multiSelectDisplayRecent, document.getElementById('multi-select-options-recent'));
                }
            } else if (event.target.classList.contains('remove-item-btn')) {
                const type = event.target.dataset.value;
                if (event.target.closest('#multi-select-display-recent')) {
                    toggleActivityType(type, selectedActivityTypesRecent, multiSelectDisplayRecent, document.getElementById('multi-select-options-recent'));
                }
            }
        });


        /**
         * Formats duration from seconds to HH:MM:SS.
         * @param {number} seconds - Duration in seconds.
         * @returns {string} Formatted duration string.
         */
        function formatDuration(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s].map(v => v < 10 ? "0" + v : v).filter((v, i) => v !== "00" || i > 0).join(":");
        }

        /**
         * Converts average speed (m/s) to pace (min/km).
         * @param {number} metersPerSecond - Average speed in meters per second.
         * @returns {string} Formatted pace string (MM:SS /km) or 'N/A'.
         */
        function formatPace(metersPerSecond) {
            if (typeof metersPerSecond !== 'number' || isNaN(metersPerSecond) || metersPerSecond <= 0) return 'N/A';
            // 1 m/s = 3.6 km/h
            // Pace (min/km) = 60 / (speed in km/h)
            // Pace (min/km) = 60 / (metersPerSecond * 3.6)
            const kmPerHour = (metersPerSecond * 3.6); 
            if (kmPerHour === 0) return 'N/A'; // Avoid division by zero
            const minutesPerKm = 60 / kmPerHour; 
            const minutes = Math.floor(minutesPerKm);
            const seconds = Math.round((minutesPerKm - minutes) * 60);
            return `${minutes}:${String(seconds).padStart(2, '0')} /km`;
        }

        /**
         * Formats elevation gain in meters.
         * @param {number} meters - Elevation in meters.
         * @returns {string} Formatted string (e.g., "150 m").
         */
        function formatElevationGain(meters) {
            if (typeof meters !== 'number' || isNaN(meters)) return 'N/A';
            return `${meters.toFixed(0)} m`;
        }


        // --- Supabase App Authentication Functions ---

        /**
         * Updates the UI based on the current Supabase Authentication state.
         * @param {Object|null} user - The Supabase user object or null if logged out.
         */
        async function updateAppAuthUI(user) {
            const appAuthHeader = appAuthSection.querySelector('.collapsible-header');
            const appAuthToggleIcon = appAuthHeader.querySelector('.toggle-icon');

            if (user) {
                currentAppUserId = user.id;
                appUserStatus.textContent = `Đã đăng nhập: ${user.email || 'Khách'}`;
                currentAppUserEmail.textContent = user.email || 'Khách';
                loggedOutView.classList.add('hidden');
                loggedInView.classList.remove('hidden');
                
                // Show sections dependent on app authentication
                credentialManagementSection.classList.remove('hidden');
                stravaAuthSection.classList.remove('hidden');
                dataSection.classList.remove('hidden');
                statsSection.classList.remove('hidden');
                detailedStatsSection.classList.remove('hidden'); // Show new detailed stats section
                instructionSection.classList.remove('hidden'); // Show instruction section
                llmAnalysisSection.classList.remove('hidden'); // Show LLM analysis section

                // Collapse app auth section if logged in
                toggleCollapsible(appAuthContent, appAuthToggleIcon, true); 

                // Re-fetch credentials and check Strava auth state after app user is authenticated
                await fetchAndSetRunnerCredentials(); // Fetch data
                await renderCredentialsUI(); // Render UI from fetched data
                await checkStravaAuthState();
                populateRunnerStatsFilter(); // Populate runner stats filter on app auth change
                populateDownloadRunnerSelect(); // Populate the new download runner select
                populateRunnerRecentActivitiesFilter(); // NEW: Populate runner filter for recent activities
                populateClubDropdowns(); // NEW: Populate club dropdowns after app auth and credential load

            } else {
                currentAppUserId = null;
                appUserStatus.textContent = 'Chưa đăng nhập';
                loggedOutView.classList.remove('hidden');
                loggedInView.classList.add('hidden');

                // Expand app auth section if logged out
                toggleCollapsible(appAuthContent, appAuthToggleIcon, false);

                // Hide sections dependent on app authentication
                credentialManagementSection.classList.add('hidden');
                stravaAuthSection.classList.add('hidden');
                dataSection.classList.add('hidden');
                statsSection.classList.add('hidden');
                detailedStatsSection.classList.add('hidden'); // Hide new detailed stats section
                instructionSection.classList.add('hidden'); // Hide instruction section
                llmAnalysisSection.classList.add('hidden'); // Hide LLM analysis section

                clearStravaSession(); // Clear Strava session if app user logs out
                await fetchAndSetRunnerCredentials(); // Clear global state data
                await renderCredentialsUI(); // Clear credentials list UI
                checkStravaAuthState(); // Reset Strava UI
                populateRunnerStatsFilter(); // Clear runner stats filter
                populateDownloadRunnerSelect(); // Clear the new download runner select
                populateRunnerRecentActivitiesFilter(); // NEW: Clear runner filter for recent activities
                populateClubDropdowns(); // Clear club dropdowns
            }
        }

        /**
         * Handles user sign-up or sign-in.
         * @param {Event} event - Form submission event.
         */
        async function handleAuth(event) {
            event.preventDefault();
            authMessage.textContent = '';
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();

            if (!email || !password) {
                showAlert('Vui lòng nhập Email và Mật khẩu.');
                return;
            }

            try {
                if (event.submitter.id === 'signup-btn') {
                    const { data, error } = await supabaseClientInstance.auth.signUp({ email, password });
                    if (error) throw error;
                    showAlert('Đăng ký thành công! Vui lòng kiểm tra email của bạn để xác nhận.');
                    authMessage.textContent = 'Đăng ký thành công! Vui lòng kiểm tra email của bạn để xác nhận.';
                } else if (event.submitter.id === 'signin-btn') {
                    const { data, error } = await supabaseClientInstance.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    showAlert('Đăng nhập thành công!');
                    authMessage.textContent = ''; // Clear message on success
                }
            } catch (error) {
                console.error('Lỗi xác thực ứng dụng:', error.message);
                authMessage.textContent = `Lỗi: ${error.message}`;
                showAlert(`Lỗi xác thực: ${error.message}`);
            }
        }

        /**
         * Handles guest login (anonymous sign-in with Supabase).
         */
        async function handleGuestLogin() {
            try {
                const { data, error } = await supabaseClientInstance.auth.signInAnonymously();
                if (error) throw error;
                showAlert('Đăng nhập với tư cách Khách thành công!');
                authMessage.textContent = ''; // Clear message on success
            } catch (error) {
                console.error('Lỗi đăng nhập khách:', error.message);
                authMessage.textContent = `Lỗi đăng nhập khách: ${error.message}`;
                showAlert(`Lỗi đăng nhập khách: ${error.message}`);
            }
        }

        /**
         * Handles user sign-out from the application.
         */
        async function handleSignOut() {
            try {
                const { error } = await supabaseClientInstance.auth.signOut();
                if (error) throw error;
                showAlert('Đăng xuất ứng dụng thành công!');
                authMessage.textContent = ''; // Clear message on success
                clearStravaSession(); // Clear Strava session on app logout
                updateAppAuthUI(null); // Update UI to logged-out state
            } catch (error) {
                console.error('Lỗi đăng xuất ứng dụng:', error.message);
                showAlert(`Lỗi đăng xuất: ${error.message}`);
            }
        }


        // --- Credential Management Functions ---

        /**
         * Fetches runner credentials from Supabase and updates the global `allRunnerCredentials` array.
         */
        async function fetchAndSetRunnerCredentials() {
            if (!currentAppUserId) {
                allRunnerCredentials = []; // Clear global state if no app user
                console.log('fetchAndSetRunnerCredentials: No app user, clearing credentials.');
                return;
            }
            console.log('fetchAndSetRunnerCredentials: Attempting to fetch credentials for user:', currentAppUserId);
            loadingCredentials.classList.remove('hidden'); // Show loading state
            errorCredentials.classList.add('hidden'); // Hide previous errors
            try {
                const { data, error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('*')
                   .order('runner_name', { ascending: true });
                if (error) throw error;
                allRunnerCredentials = data; // Update global variable
                console.log('fetchAndSetRunnerCredentials: Successfully fetched', data.length, 'credentials.');
            } catch (error) {
                console.error('Error fetching runner credentials:', error.message);
                errorCredentials.textContent = `Lỗi: ${error.message}`;
                errorCredentials.classList.remove('hidden');
                showAlert(`Lỗi khi tải thông tin runner: ${error.message}`);
                allRunnerCredentials = []; // Clear on error too
            } finally {
                loadingCredentials.classList.add('hidden'); // Hide loading state
            }
        }

        /**
         * Renders the runner credentials from the global `allRunnerCredentials` array into the UI.
         */
        async function renderCredentialsUI() {
            credentialsList.innerHTML = ''; // Always clear before rendering
            noCredentialsMessage.classList.add('hidden');
            runnerSelect.innerHTML = '<option value="">-- Chọn Runner --</option>'; // Clear existing options
            downloadRunnerSelect.innerHTML = '<option value="">-- Chọn Runner --</option>'; // Clear for new select
            runnerRecentActivitiesFilter.innerHTML = '<option value="all">Tất cả Runner</option>'; // NEW: Clear for new select

            if (allRunnerCredentials.length === 0) {
                noCredentialsMessage.classList.remove('hidden');
                toggleCollapsible(credentialManagementContent, credentialManagementSection.querySelector('.toggle-icon'), false);
            } else {
                noCredentialsMessage.classList.add('hidden');
                toggleCollapsible(credentialManagementContent, credentialManagementSection.querySelector('.toggle-icon'), true);

                allRunnerCredentials.forEach(cred => {
                    const credDiv = document.createElement('div');
                    credDiv.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3';
                    
                    // Conditionally render Edit/Delete buttons
                    const ownerButtons = (currentAppUserId && cred.owner_uid === currentAppUserId)
                        ? `
                        <div class="flex flex-row gap-2 mt-2 sm:mt-0">
                            <button class="btn-primary btn-edit" data-id="${cred.id}">Sửa</button>
                            <button class="btn-danger btn-delete" data-id="${cred.id}">Xóa</button>
                        </div>
                        `
                        : '';

                    credDiv.innerHTML = `
                        <div>
                            <p class="text-lg font-semibold text-gray-800">${cred.runner_name}</p>
                            ${cred.athlete_id ? `<p class="text-sm text-gray-600">Strava Athlete ID: <span class="font-mono">${cred.athlete_id}</span></p>` : `<p class="text-sm text-gray-600 text-red-500">Chưa kết nối Strava</p>`}
                        </div>
                        ${ownerButtons}
                    `;
                    credentialsList.appendChild(credDiv);

                    const option = document.createElement('option');
                    option.value = cred.id; // Use the Supabase credential ID as the value
                    option.textContent = cred.runner_name;
                    option.dataset.redirectUri = cred.redirect_uri; // Still useful for the OAuth flow from frontend
                    option.dataset.athleteId = cred.athlete_id || ''; // Store athlete ID
                    runnerSelect.appendChild(option.cloneNode(true)); // Clone for runnerSelect
                    downloadRunnerSelect.appendChild(option.cloneNode(true)); // Clone for downloadRunnerSelect
                    // NEW: Add to runnerRecentActivitiesFilter only if athlete_id exists
                    if (cred.athlete_id) {
                        const recentFilterOption = document.createElement('option');
                        recentFilterOption.value = String(cred.athlete_id);
                        recentFilterOption.textContent = cred.runner_name;
                        runnerRecentActivitiesFilter.appendChild(recentFilterOption);
                    }
                });
                
                document.querySelectorAll('.btn-edit').forEach(button => {
                    button.onclick = (e) => openCredentialModal(e.target.dataset.id);
                });
                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.onclick = async (e) => {
                        const confirmed = await showConfirm('Bạn có chắc chắn muốn xóa thông tin đăng nhập này không?'); // Using custom confirm
                        if (confirmed) {
                            await deleteCredential(e.target.dataset.id);
                        }
                    };
                });
            }
        }

        /**
         * Opens the modal for adding or editing runner credentials.
         * @param {string|null} id - ID of the credential to edit, or null for new.
         */
        async function openCredentialModal(id = null) {
            credentialForm.reset();
            credentialIdInput.value = '';
            modalTitle.textContent = 'Thêm Runner mới'; 
            runnerNameInput.readOnly = false; // Ensure it's editable for new runner

            // Set default redirect URI to the fixed value
            redirectUriInput.value = APP_STRAVA_REDIRECT_URI; 

            // Populate clubs dropdown before setting value for edit mode
            await fetchClubs(); // Ensure clubs are loaded
            populateClubDropdowns(); // Populate the runnerTeamSelect

            if (id) {
                modalTitle.textContent = 'Sửa thông tin Runner'; 
                try {
                    // Fetch all relevant columns for editing
                    const { data, error } = await supabaseClientInstance
                        .from('runner_credentials')
                        .select('runner_name, id, full_name, phone_number, runner_email, date_of_birth, weight_kg, shirt_size, running_team, gender')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    runnerNameInput.value = data.runner_name;
                    document.getElementById('runner-full-name').value = data.full_name || '';
                    document.getElementById('runner-phone-number').value = data.phone_number || '';
                    document.getElementById('runner-email').value = data.runner_email || '';
                    document.getElementById('runner-date-of-birth').value = data.date_of_birth ? data.date_of_birth.split('T')[0] : ''; // Format for date input
                    document.getElementById('runner-weight-kg').value = data.weight_kg || '';
                    document.getElementById('runner-shirt-size').value = data.shirt_size || '';
                    runnerTeamSelect.value = data.running_team || ''; // Set value for the select
                    document.getElementById('runner-gender').value = data.gender || '';

                    credentialIdInput.value = data.id;
                    runnerNameInput.readOnly = false; // Make sure it's editable
                } catch (error) {
                    console.error('Lỗi khi lấy thông tin đăng nhập để chỉnh sửa:', error.message);
                    showAlert(`Lỗi khi tải chi tiết runner: ${error.message}. Bạn chỉ có thể sửa runner của mình.`);
                }
            }
            credentialModal.style.display = 'flex';
        }

        /**
         * Saves (adds or updates) runner credentials to Supabase.
         * For new runners, it initiates the Strava OAuth flow.
         * For existing runners, it only updates the name and other details.
         * @param {Event} event - Form submission event.
         */
        async function saveCredential(event) {
            event.preventDefault();

            if (!currentAppUserId) {
                showAlert('Lỗi: Bạn phải đăng nhập ứng dụng để thêm hoặc sửa Runner.');
                console.error('Attempted to save credential but app user is not authenticated.');
                return;
            }

            const id = credentialIdInput.value;
            const runnerName = runnerNameInput.value.trim();
            const redirectUri = redirectUriInput.value; // Use the fixed value

            // Get new field values
            const fullName = document.getElementById('runner-full-name').value.trim();
            const phoneNumber = document.getElementById('runner-phone-number').value.trim();
            const runnerEmail = document.getElementById('runner-email').value.trim();
            const dateOfBirth = document.getElementById('runner-date-of-birth').value; //YYYY-MM-DD format
            const weightKg = parseFloat(document.getElementById('runner-weight-kg').value);
            const shirtSize = document.getElementById('runner-shirt-size').value;
            const runningTeam = runnerTeamSelect.value; // Get value from the select dropdown
            const gender = document.getElementById('runner-gender').value;


            if (!runnerName) {
                showAlert('Vui lòng nhập Tên Runner.');
                return;
            }
            // Validate new required fields
            if (!runnerEmail || !gender || !runningTeam) {
                showAlert('Vui lòng nhập đầy đủ Email Runner, Giới tính và Đội chạy.');
                return;
            }


            try {
                if (id) {
                    // This is an EDIT operation (update existing runner details)
                    const { error: updateError } = await supabaseClientInstance
                        .from('runner_credentials')
                        .update({ 
                            runner_name: runnerName, 
                            full_name: fullName,
                            phone_number: phoneNumber,
                            runner_email: runnerEmail,
                            date_of_birth: dateOfBirth || null, // Allow null if not provided
                            weight_kg: isNaN(weightKg) ? null : weightKg, // Allow null if not a valid number
                            shirt_size: shirtSize || null, // Allow null if not selected
                            running_team: runningTeam,
                            gender: gender,
                        })
                        .eq('id', id)
                        .eq('owner_uid', currentAppUserId); // Ensure only owner can update

                    if (updateError) throw updateError;
                    showAlert('Cập nhật thông tin runner thành công!');

                } else {
                    // This is an ADD operation (new runner, initiate OAuth)
                    // First, save a placeholder runner_credential in DB with name and owner_uid
                    // We need this ID to pass to the OAuth callback
                    const { data: insertData, error: insertError } = await supabaseClientInstance
                        .from('runner_credentials')
                        .insert([{
                            runner_name: runnerName,
                            owner_uid: currentAppUserId,
                            redirect_uri: redirectUri, // Save redirect_uri for consistent callback
                            full_name: fullName,
                            phone_number: phoneNumber,
                            runner_email: runnerEmail,
                            date_of_birth: dateOfBirth || null, 
                            weight_kg: isNaN(weightKg) ? null : weightKg, 
                            shirt_size: shirtSize || null, 
                            running_team: runningTeam,
                            gender: gender,
                            // access_token, refresh_token, athlete_id, expires_at will be null initially
                            // and populated by the strava-oauth-callback Edge Function
                        }])
                        .select('id') // Select the ID of the newly inserted row
                        .single();

                    if (insertError) throw insertError;
                    const newRunnerCredentialId = insertData.id;

                    showAlert('Thêm Runner thành công! Chuyển hướng đến Strava để ủy quyền...');
                    credentialModal.style.display = 'none'; // Close modal immediately

                    // Store the newly created credential ID for the OAuth callback
                    localStorage.setItem('strava_runner_credential_id_pending', newRunnerCredentialId);
                    localStorage.setItem('strava_runner_name_pending', runnerName);

                    // Redirect to Strava for OAuth authorization using the APP's Client ID
                    const scope = 'activity:read_all';
                    const state = encodeURIComponent(JSON.stringify({ 
                        credentialId: newRunnerCredentialId // Pass the newly created DB ID
                    }));
                    const authUrl = `https://www.strava.com/oauth/authorize?client_id=${APP_STRAVA_CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(APP_STRAVA_REDIRECT_URI)}&approval_prompt=auto&scope=${scope}&state=${state}`;
                    
                    window.location.href = authUrl;
                    return; // Exit function after redirect
                }

                credentialModal.style.display = 'none';
                await fetchAndSetRunnerCredentials(); // Refresh the list data
                await renderCredentialsUI(); // Refresh the list UI
                populateRunnerStatsFilter(); // Refresh runner stats filter as well
                populateDownloadRunnerSelect(); // Refresh the new download runner select
                populateRunnerRecentActivitiesFilter(); // NEW: Refresh runner filter for recent activities
                checkStravaAuthState(); // Re-check Strava auth status to ensure UI is consistent
            } catch (error) {
                console.error('Lỗi khi lưu thông tin đăng nhập runner:', error.message);
                showAlert(`Lỗi khi lưu thông tin runner: ${error.message}`);
            }
        }

        /**
         * Deletes a runner credential from Supabase.
         * @param {string} id - ID of the credential to delete.
         */
        async function deleteCredential(id) {
            if (!currentAppUserId) {
                showAlert('Lỗi: Bạn phải đăng nhập ứng dụng để xóa Runner.');
                return;
            }
            try {
                const { error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .delete()
                    .eq('id', id)
                    .eq('owner_uid', currentAppUserId); // Ensure only owner can delete
            
                if (error) throw error;

                showAlert('Xóa thông tin runner thành công!');
                // If the deleted runner was the current logged-in one, log out
                if (currentRunnerCredentialId === id) {
                    clearStravaSession();
                    checkStravaAuthState(); // Reset Strava auth UI
                }
                await fetchAndSetRunnerCredentials(); // Refresh the list data
                await renderCredentialsUI(); // Refresh the list UI
                populateRunnerStatsFilter(); // Refresh runner stats filter as well
                populateDownloadRunnerSelect(); // Refresh the new download runner select
                populateRunnerRecentActivitiesFilter(); // NEW: Refresh runner filter for recent activities
            } catch (error) {
                console.error('Lỗi khi xóa thông tin đăng nhập runner:', error.message);
                showAlert(`Lỗi khi xóa thông tin runner: ${error.message}`);
            }
        }


        // --- Strava Authentication & API Interaction ---

        /**
         * Checks the current Strava authentication status from localStorage and updates the UI.
         */
        async function checkStravaAuthState() {
            // This function confirms that saving the session to localStorage works as requested.
            currentRunnerCredentialId = localStorage.getItem('strava_runner_credential_id'); 
            isAuthenticated = localStorage.getItem('strava_authenticated') === 'true';
            currentAthleteId = localStorage.getItem('strava_athlete_id');
            currentRunnerName = localStorage.getItem('strava_runner_name');

            console.log('checkStravaAuthState - Checking Strava auth state from localStorage...');
            console.log('  isAuthenticated (Strava):', isAuthenticated);
            console.log('  currentRunnerCredentialId (Credential ID):', currentRunnerCredentialId);
            console.log('  currentAthleteId (Strava ID):', currentAthleteId);
            console.log('  currentRunnerName:', currentRunnerName);

            const stravaAuthHeader = stravaAuthSection.querySelector('.collapsible-header');
            const stravaAuthToggleIcon = stravaAuthHeader.querySelector('.toggle-icon');


            if (isAuthenticated && currentRunnerCredentialId && currentAthleteId && currentRunnerName) {
                await fetchAndSetRunnerCredentials();
                await renderCredentialsUI(); 
                await fetchClubs();
                populateClubDropdowns();

                const expiresAt = localStorage.getItem('strava_expires_at');
                const now = Date.now();
                if (expiresAt && now < parseInt(expiresAt, 10)) {
                    console.log('  Valid Strava token found. Logged into Strava.');
                    authStatus.textContent = 'Đã đăng nhập với Strava.';
                    currentRunnerNameSpan.textContent = currentRunnerName;
                    currentRunnerDisplay.classList.remove('hidden');
                    connectStravaBtn.style.display = 'none'; // Explicitly hide the image
                    disconnectStravaBtn.classList.remove('hidden');
                    dataSection.classList.remove('hidden');
                    statsSection.classList.remove('hidden');
                    detailedStatsSection.classList.remove('hidden'); 
                    instructionSection.classList.remove('hidden'); 
                    llmAnalysisSection.classList.remove('hidden'); 
                    userInfo.textContent = `Chào mừng, Runner: ${currentRunnerName} (Strava ID: ${currentAthleteId})`; 
                    
                    runnerSelect.value = currentRunnerCredentialId;
                    toggleCollapsible(stravaAuthContent, stravaAuthToggleIcon, true);

                } else {
                    console.log('  Strava token has expired or is missing. Re-authentication may be needed.');
                    authStatus.textContent = 'Token Strava đã hết hạn, vui lòng làm mới hoặc đăng nhập lại.';
                    showAlert('Phiên Strava đã hết hạn. Vui lòng đăng xuất và chọn lại Runner để kết nối.');
                    clearStravaSession();
                    checkStravaAuthState(); // Re-check to reset UI
                }
            } else {
                console.log('  Not logged into Strava or session info is missing.');
                clearStravaSession(); 
                await fetchAndSetRunnerCredentials(); 
                await renderCredentialsUI();
                await fetchClubs(); 
                populateClubDropdowns(); 
                authStatus.textContent = 'Vui lòng chọn Runner và đăng nhập với Strava.';
                currentRunnerDisplay.classList.add('hidden');
                connectStravaBtn.style.display = 'block'; // Explicitly show the image
                disconnectStravaBtn.classList.add('hidden');
                dataSection.classList.add('hidden');
                statsSection.classList.add('hidden');
                detailedStatsSection.classList.add('hidden'); 
                instructionSection.classList.add('hidden'); 
                llmAnalysisSection.classList.add('hidden'); 
                userInfo.textContent = ''; 
                recentActivitiesContainer.innerHTML = '<div class="card p-4 text-gray-500 text-center col-span-full">Nhấn "Tải hoạt động gần đây" để xem.</div>';
                document.getElementById('bubble-chart-container').innerHTML = '<p class="text-gray-500 text-center">Nhấn "Xem thống kê theo tuần" để hiển thị biểu đồ.</p>';
                const table = document.getElementById('detailed-stats-table');
                Array.from(table.children).forEach(child => {
                    if (child.tagName === 'TBODY') { 
                        table.removeChild(child);
                    }
                });
                const newTbody = document.createElement('tbody');
                table.appendChild(newTbody);
                detailedStatsStatus.textContent = 'Chưa có dữ liệu để hiển thị.';

                toggleCollapsible(stravaAuthContent, stravaAuthToggleIcon, false);
            }
        }

        /**
         * Clears all Strava session data from local storage.
         * This logs the user out of Strava within the app.
         */
        function clearStravaSession() {
            console.log('clearStravaSession - Removing Strava session data from localStorage.');
            localStorage.removeItem('strava_access_token');
            localStorage.removeItem('strava_refresh_token');
            localStorage.removeItem('strava_expires_at');
            localStorage.removeItem('strava_athlete_id');
            localStorage.removeItem('strava_runner_name');
            localStorage.removeItem('strava_runner_credential_id');
            localStorage.removeItem('strava_authenticated');
            localStorage.removeItem('strava_runner_credential_id_pending');
            localStorage.removeItem('strava_runner_name_pending');
        }

        /**
         * Initiates the Strava OAuth authorization flow.
         */
        connectStravaBtn.addEventListener('click', async () => {
            if (!currentAppUserId) {
                showAlert('Lỗi: Bạn phải đăng nhập ứng dụng để kết nối với Strava.');
                return;
            }

            const selectedOption = runnerSelect.options[runnerSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                showAlert('Vui lòng chọn một Runner từ danh sách để đăng nhập Strava.');
                return;
            }

            const credentialId = selectedOption.value; // Supabase runner_credential ID (UUID)
            const runnerName = selectedOption.textContent;

            const selectedRunner = allRunnerCredentials.find(cred => cred.id === credentialId);
            if (selectedRunner && selectedRunner.athlete_id) {
                const confirmed = await showConfirm(`Runner "${runnerName}" đã được kết nối với Strava (ID: ${selectedRunner.athlete_id}). Bạn có muốn kết nối lại không? Điều này sẽ cập nhật token mới.`);
                if (!confirmed) {
                    return; // User cancelled
                }
            }

            localStorage.setItem('strava_runner_credential_id_pending', credentialId);
            localStorage.setItem('strava_runner_name_pending', runnerName);
            
            const scope = 'activity:read_all';
            const state = encodeURIComponent(JSON.stringify({ 
                credentialId: credentialId
            }));

            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${APP_STRAVA_CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(APP_STRAVA_REDIRECT_URI)}&approval_prompt=auto&scope=${scope}&state=${state}`;
            
            window.location.href = authUrl;
        });

        /**
         * Handles the Strava OAuth callback, exchanging code for tokens via Edge Function.
         */
        async function handleStravaCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const stateParam = urlParams.get('state'); 
            const errorParam = urlParams.get('error');

            if (errorParam) {
                showAlert(`Lỗi từ Strava: ${errorParam}. Vui lòng thử lại.`);
                console.error('Strava OAuth Error:', errorParam);
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (code) { 
                authStatus.textContent = 'Đang xử lý kết nối Strava ...';
                let runnerCredentialId = null;
                let runnerNameForCallback = null;
                let ownerUidForCallback = null;

                if (stateParam) {
                    try {
                        const parsedState = JSON.parse(decodeURIComponent(stateParam));
                        runnerCredentialId = parsedState.credentialId;
                    } catch (e) {
                        console.error('Lỗi giải mã tham số "state":', e);
                    }
                }

                if (!runnerCredentialId) {
                    runnerCredentialId = localStorage.getItem('strava_runner_credential_id_pending');
                    if (!runnerCredentialId) {
                        console.error('Không tìm thấy runnerCredentialId trong state hoặc localStorage.');
                        showAlert('Lỗi: Thông tin phiên không hợp lệ hoặc thiếu Runner ID. Vui lòng đăng nhập lại Strava.');
                        window.history.replaceState({}, document.title, window.location.pathname);
                        return;
                    }
                }
                
                runnerNameForCallback = localStorage.getItem('strava_runner_name_pending');
                if (!runnerNameForCallback) {
                     console.error('Không tìm thấy runnerName trong localStorage.');
                     const existingRunner = allRunnerCredentials.find(rc => rc.id === runnerCredentialId);
                     if (existingRunner) {
                         runnerNameForCallback = existingRunner.runner_name;
                     } else {
                         showAlert('Lỗi: Không tìm thấy tên Runner. Vui lòng thử lại quá trình kết nối.');
                         window.history.replaceState({}, document.title, window.location.pathname);
                         return;
                     }
                }

                const { data: { user }, error: authError } = await supabaseClientInstance.auth.getUser();
                if (authError || !user) {
                    showAlert('Lỗi: Không tìm thấy phiên đăng nhập ứng dụng. Vui lòng đăng nhập lại ứng dụng.');
                    console.error('Không tìm thấy người dùng ứng dụng khi xử lý callback Strava:', authError);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                ownerUidForCallback = user.id;

                try {
                    console.log(`[Client] Calling strava-oauth-callback Edge Function for runnerCredentialId: ${runnerCredentialId}`);
                    const response = await fetch(STRAVA_OAUTH_CALLBACK_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${(await supabaseClientInstance.auth.getSession()).data.session?.access_token || ''}`
                        },
                        body: JSON.stringify({
                            code: code,
                            runnerCredentialId: runnerCredentialId,
                            client_id: APP_STRAVA_CLIENT_ID,
                            redirect_uri: APP_STRAVA_REDIRECT_URI,
                            runnerName: runnerNameForCallback, 
                            ownerUid: ownerUidForCallback 
                        }),
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Store tokens and athlete info from Edge Function response into localStorage
                        localStorage.setItem('strava_access_token', result.access_token);
                        localStorage.setItem('strava_refresh_token', result.refresh_token);
                        localStorage.setItem('strava_expires_at', result.expires_at);
                        localStorage.setItem('strava_athlete_id', result.athlete_id);
                        localStorage.setItem('strava_runner_name', result.runner_name); 
                        localStorage.setItem('strava_runner_credential_id', result.runnerCredentialId); 
                        localStorage.setItem('strava_authenticated', 'true'); 

                        showAlert('Đăng nhập Strava thành công! Bạn có thể tải dữ liệu hoạt động ngay bây giờ.');
                        window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
                        checkStravaAuthState(); // Update UI
                    } else {
                        console.error('[Client] Error from Edge Function:', result.error);
                        showAlert(`Lỗi đăng nhập Strava: ${result.error || 'Không xác định'}`);
                        clearStravaSession();
                        checkStravaAuthState();
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (err) {
                    console.error('Lỗi khi gọi Edge Function strava-oauth-callback:', err);
                    showAlert(`Lỗi mạng hoặc máy chủ khi xử lý đăng nhập Strava: ${err.message}`);
                    clearStravaSession();
                    checkStravaAuthState();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } else {
                console.log('Không có mã ủy quyền hoặc tham số "state" trong URL. Không có hành động nào được thực hiện.');
            }
        }

        /**
         * Disconnects Strava account from the current runner.
         */
        disconnectStravaBtn.addEventListener('click', () => {
            clearStravaSession();
            checkStravaAuthState();
            showAlert('Đã đăng xuất Strava.');
        });


        // --- Data Fetching & Management ---

        /**
         * Handles the main "Tải/Cập nhật dữ liệu từ Strava" button click.
         */
        fetchActivitiesBtn.addEventListener('click', async () => {
            if (!currentAppUserId || !isAuthenticated || !currentRunnerCredentialId || !currentAthleteId) {
                showAlert('Vui lòng đăng nhập ứng dụng và kết nối với Strava trước khi thực hiện chức năng này.');
                return;
            }

            const dataStatus = document.getElementById('data-status');
            dataStatus.textContent = 'Đang tải dữ liệu hoạt động từ Strava ...';

            const activitiesLimit = parseInt(activitiesLimitInput.value, 10);

            if (isNaN(activitiesLimit) || activitiesLimit <= 0 || activitiesLimit > 200) {
                showAlert('Vui lòng nhập số lượng hoạt động hợp lệ (1-200). Strava chỉ hỗ trợ tải tối đa 200 hoạt động.');
                dataStatus.textContent = '';
                return;
            }
            
            console.log('Fetching activities:');
            console.log('  currentRunnerCredentialId (Supabase Credential ID to send):', currentRunnerCredentialId);
            console.log('  currentAthleteId (Strava Athlete ID - for local logging):', currentAthleteId); 

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    showAlert('Lỗi: Không tìm thấy phiên đăng nhập Supabase. Vui lòng đăng nhập lại.');
                    dataStatus.textContent = 'Lỗi xác thực: Không tìm thấy phiên đăng nhập.';
                    return;
                }

                const response = await fetch(FETCH_ACTIVITIES_API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ 
                        runnerCredentialId: currentRunnerCredentialId,
                        limit: activitiesLimit 
                    }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    dataStatus.textContent = `Đã tải và lưu ${result.count} hoạt động thành công!`;
                    showAlert(`Đã tải và lưu ${result.count} hoạt động thành công!`);
                    await loadRecentActivitiesBtn.click(); 
                } else {
                    dataStatus.textContent = `Lỗi khi tải hoạt động: ${result.error || 'Không xác định'}`;
                    showAlert(`Lỗi khi tải hoạt động: ${result.error || 'Không xác định'}`);
                }
            } catch (error) {
                console.error('Lỗi khi tải hoạt động:', error);
                dataStatus.textContent = 'Lỗi mạng hoặc máy chủ khi tải hoạt động.';
                showAlert('Lỗi mạng hoặc máy chủ khi tải hoạt động.');
            }
        });

        /**
         * Handles the new "Download Strava hộ" button click.
         */
        downloadActivitiesForOtherBtn.addEventListener('click', async () => {
            if (!currentAppUserId) {
                showAlert('Vui lòng đăng nhập ứng dụng để sử dụng chức năng này.');
                return;
            }

            const selectedOption = downloadRunnerSelect.options[downloadRunnerSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                showAlert('Vui lòng chọn một Runner từ danh sách để tải hộ.');
                return;
            }

            const runnerToDownloadId = selectedOption.value;
            const runnerToDownloadName = selectedOption.textContent;

            const activitiesLimit = parseInt(activitiesLimitInput.value, 10);
            if (isNaN(activitiesLimit) || activitiesLimit <= 0 || activitiesLimit > 200) {
                showAlert('Vui lòng nhập số lượng hoạt động hợp lệ (1-200) trong ô giới hạn hoạt động. Strava chỉ hỗ trợ tải tối đa 200 hoạt động.');
                return;
            }

            downloadForOtherStatus.textContent = `Đang tải dữ liệu hoạt động cho ${runnerToDownloadName} từ Strava ...`;

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    showAlert('Lỗi: Không tìm thấy phiên đăng nhập Supabase. Vui lòng đăng nhập lại.');
                    downloadForOtherStatus.textContent = 'Lỗi xác thực: Không tìm thấy phiên đăng nhập.';
                    return;
                }

                console.log(`[Download hộ] Calling fetch-strava-activities for runner: ${runnerToDownloadName} (Credential ID: ${runnerToDownloadId})`);

                const response = await fetch(FETCH_ACTIVITIES_API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ 
                        runnerCredentialId: runnerToDownloadId,
                        limit: activitiesLimit 
                    }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    downloadForOtherStatus.textContent = `Đã tải và lưu ${result.count} hoạt động cho ${runnerToDownloadName} thành công!`;
                    showAlert(`Đã tải và lưu ${result.count} hoạt động cho ${runnerToDownloadName} thành công!`);
                } else {
                    downloadForOtherStatus.textContent = `Lỗi khi tải hoạt động cho ${runnerToDownloadName}: ${result.error || 'Không xác định'}`;
                    showAlert(`Lỗi khi tải hoạt động cho ${runnerToDownloadName}: ${result.error || 'Không xác định'}`);
                }
            } catch (error) {
                console.error(`Lỗi khi tải hoạt động cho ${runnerToDownloadName}:`, error);
                downloadForOtherStatus.textContent = 'Lỗi mạng hoặc máy chủ khi tải hoạt động.';
                showAlert('Lỗi mạng hoặc máy chủ khi tải hoạt động.');
            }
        });

        /**
         * Populates the dropdown for "Download Strava hộ" with all saved runner credentials.
         */
        function populateDownloadRunnerSelect() {
            downloadRunnerSelect.innerHTML = '<option value="">-- Chọn Runner --</option>'; 
            allRunnerCredentials.forEach(cred => {
                const option = document.createElement('option');
                option.value = cred.id;
                option.textContent = cred.runner_name;
                downloadRunnerSelect.appendChild(option);
            });
        }

        /**
         * Populates the runner filter dropdown for recent activities.
         */
        function populateRunnerRecentActivitiesFilter() {
            runnerRecentActivitiesFilter.innerHTML = '<option value="all">Tất cả Runner</option>'; 
            allRunnerCredentials.forEach(cred => {
                if (cred.athlete_id) { 
                    const option = document.createElement('option');
                    option.value = String(cred.athlete_id);
                    option.textContent = cred.runner_name;
                    runnerRecentActivitiesFilter.appendChild(option);
                }
            });
            if (selectedRunnerIdForRecentActivities && 
                Array.from(runnerRecentActivitiesFilter.options).some(opt => opt.value === selectedRunnerIdForRecentActivities)) {
                runnerRecentActivitiesFilter.value = selectedRunnerIdForRecentActivities;
            } else {
                selectedRunnerIdForRecentActivities = 'all';
                runnerRecentActivitiesFilter.value = 'all';
            }
        }


        /**
         * Fetches all athlete IDs for the current logged-in app user from their runner credentials.
         * @returns {Promise<string[]>} An array of athlete IDs (as strings).
         */
        async function getAllAthleteIdsForCurrentUser() {
            if (!currentAppUserId) {
                console.warn('getAllAthleteIdsForCurrentUser: currentAppUserId is null. Cannot fetch runner credentials.');
                return [];
            }

            await fetchAndSetRunnerCredentials();

            const athleteIds = allRunnerCredentials
                .filter(cred => cred.athlete_id)
                .map(cred => String(cred.athlete_id));

            console.log('getAllAthleteIdsForCurrentUser: Fetched athlete IDs for current app user:', athleteIds);
            return athleteIds;
        }

        /**
         * Loads recent activities from Supabase for all connected runners and displays them.
         */
        loadRecentActivitiesBtn.addEventListener('click', async () => {
            if (!currentAppUserId) { 
                showAlert('Vui lòng đăng nhập ứng dụng để thực hiện chức năng này.');
                return;
            }

            recentActivitiesStatus.textContent = 'Đang tải hoạt động gần đây ...';
            recentActivitiesContainer.innerHTML = ''; 

            let runnerCredentialsToFilter = allRunnerCredentials;
            if (selectedClubNameForRecentActivities !== 'all') {
                runnerCredentialsToFilter = allRunnerCredentials.filter(
                    cred => cred.running_team === selectedClubNameForRecentActivities
                );
            }

            const selectedRunnerId = runnerRecentActivitiesFilter.value;
            let actualAthleteIdsToFilter = [];

            if (selectedRunnerId === 'all') {
                actualAthleteIdsToFilter = runnerCredentialsToFilter
                    .filter(cred => cred.athlete_id)
                    .map(cred => String(cred.athlete_id));
            } else {
                const specificRunner = runnerCredentialsToFilter.find(cred => String(cred.athlete_id) === selectedRunnerId);
                if (specificRunner) {
                    actualAthleteIdsToFilter = [selectedRunnerId];
                } else {
                    actualAthleteIdsToFilter = [];
                }
            }

            if (actualAthleteIdsToFilter.length === 0) {
                recentActivitiesContainer.innerHTML = '<div class="card p-4 text-gray-500 text-center col-span-full">Không tìm thấy hoạt động nào phù hợp với các bộ lọc đã chọn. Vui lòng thêm và kết nối runner hoặc điều chỉnh bộ lọc.</div>';
                recentActivitiesStatus.textContent = 'Không có hoạt động nào để hiển thị.';
                userActivities = [];
                renderDetailedStatsTable();
                return;
            }

            console.log('Loading recent activities for filtered athlete IDs:', actualAthleteIdsToFilter, 'and club:', selectedClubNameForRecentActivities);

            const numActivitiesToDisplay = parseInt(numRecentActivitiesInput.value, 10) || 10;
            const selectedTypes = selectedActivityTypesRecent;
            
            const startDateInput = startDateRecent.value;
            const endDateInput = endDateRecent.value;

            let filterStartDate = null;
            let filterEndDate = null;

            if (startDateInput) {
                const parts = startDateInput.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[2]);
                const localStartDate = new Date(year, month, day);
                filterStartDate = localStartDate.toISOString();
            }

            if (endDateInput) {
                const parts = endDateInput.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[2]);
                const localEndDate = new Date(year, month, day);
                localEndDate.setDate(localEndDate.getDate() + 1); 
                filterEndDate = localEndDate.toISOString();
            }

            try {
                let query = supabaseClientInstance
                    .from('activities')
                    .select('strava_activity_id, name, type, distance, moving_time, total_elevation_gain, start_date, average_speed, average_heartrate, user_id');
                    
                query = query.in('user_id', actualAthleteIdsToFilter); 

                if (selectedTypes.length > 0) {
                    query = query.in('type', selectedTypes); 
                }
                if (filterStartDate) {
                    query = query.gte('start_date', filterStartDate);
                }
                if (filterEndDate) {
                    query = query.lt('start_date', filterEndDate);
                }

                const { data, error } = await query
                    .order('start_date', { ascending: false })
                    .limit(numActivitiesToDisplay);

                if (error) {
                    console.error('Lỗi khi tải hoạt động gần đây từ Supabase:', error);
                    recentActivitiesStatus.textContent = `Lỗi khi tải hoạt động: ${error.message}`;
                    showAlert(`Lỗi khi tải hoạt động gần đây: ${error.message}`);
                    return; 
                }
                
                console.log('Data returned from Supabase for recent activities (all runners):', data);

                if (data && data.length > 0) {
                    userActivities = data;
                    data.forEach(activity => {
                        const activityCard = document.createElement('div');
                        activityCard.className = 'card p-4 text-sm space-y-1 border border-gray-200 rounded-lg shadow-sm';
                        const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                        const runnerNameForDisplay = runner ? runner.runner_name : `Runner ID: ${activity.user_id || 'Unknown'}`;
                        const runnerClubForDisplay = runner ? runner.running_team : 'N/A';


                        activityCard.innerHTML = `
                            <p class="font-bold text-base text-bidv-green">${runnerNameForDisplay} <span class="text-gray-500 text-xs">(${runnerClubForDisplay})</span></p>
                            <p class="font-semibold">${activity.name} (${activity.type})</p>
                            <p>Ngày: ${new Date(activity.start_date).toLocaleDateString('vi-VN')}</p>
                            <p>Quãng đường: ${(activity.distance / 1000).toFixed(2)} km</p>
                            <p>Thời gian: ${formatDuration(activity.moving_time)}</p>
                            <p>Pace: ${formatPace(activity.average_speed)}</p>
                            <p>Nhịp tim TB: ${activity.average_heartrate ? `${activity.average_heartrate.toFixed(0)} bpm` : 'N/A'}</p>
                            <p>Độ cao tăng: ${formatElevationGain(activity.total_elevation_gain)}</p>
                            ${activity.strava_activity_id ? `<button class="btn-primary mt-2 text-sm px-3 py-1 view-map-btn" style="font-weight: bold; text-decoration: underline; background-color: #FC5200; color: white;" data-activity-id="${activity.strava_activity_id}">View on Strava</button>` : ''}
                        `;
                        recentActivitiesContainer.appendChild(activityCard);
                    });
                    recentActivitiesStatus.textContent = `Đã tải ${data.length} hoạt động gần đây cho các runner đã chọn.`;

                    document.querySelectorAll('.view-map-btn').forEach(button => {
                        button.onclick = (e) => {
                            const activityId = e.target.dataset.activityId;
                            if (activityId) {
                                window.open(`https://www.strava.com/activities/${activityId}`, '_blank');
                            }
                        };
                    });

                } else {
                    recentActivitiesContainer.innerHTML = '<div class="card p-4 text-gray-500 text-center col-span-full">Không tìm thấy hoạt động nào gần đây cho các runner hoặc với bộ lọc đã chọn.</div>';
                    recentActivitiesStatus.textContent = 'Không có hoạt động nào để hiển thị.';
                    userActivities = [];
                }
                renderDetailedStatsTable();
            } catch (error) {
                console.error('Lỗi khi tải hoạt động gần đây từ Supabase:', error);
                recentActivitiesStatus.textContent = `Lỗi khi tải hoạt động: ${error.message}`;
                showAlert(`Lỗi khi tải hoạt động gần đây: ${error.message}`);
            }
        });

        // Event listener for "Xem thống kê theo tuần" button
        viewStatsBtn.addEventListener('click', async () => {
            if (!currentAppUserId) { 
                showAlert('Vui lòng đăng nhập ứng dụng để xem thống kê.');
                return;
            }

            const chartStatus = document.getElementById('chart-status');
            chartStatus.textContent = 'Đang tải thống kê theo tuần ...';
            weeklyStatsData = []; 

            let runnerCredentialsToFetch = allRunnerCredentials.filter(cred => cred.athlete_id);
            if (selectedClubIdForStats !== '') {
                runnerCredentialsToFetch = runnerCredentialsToFetch.filter(
                    cred => cred.running_team === selectedClubIdForStats
                );
            }
            if (selectedRunnerIdForStats !== '') {
                 runnerCredentialsToFetch = runnerCredentialsToFetch.filter(
                    cred => String(cred.athlete_id) === selectedRunnerIdForStats
                );
            }


            if (runnerCredentialsToFetch.length === 0) {
                chartStatus.textContent = 'Không tìm thấy runner nào được kết nối với tài khoản Strava hoặc phù hợp với bộ lọc. Vui lòng thêm và kết nối runner.';
                document.getElementById('bubble-chart-container').innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu thống kê để hiển thị biểu đồ.</p>';
                weeklyStatsData = [];
                renderDetailedStatsTable(); 
                return;
            }

            console.log('Fetching weekly stats for runners:', runnerCredentialsToFetch.map(r => r.runner_name), 'and club:', selectedClubIdForStats);

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                const headers = { 'Content-Type': 'application/json' };
                if (session?.access_token) {
                    headers['Authorization'] = `Bearer ${session.access_token}`;
                } else {
                    showAlert('Lỗi: Không tìm thấy phiên đăng nhập. Vui lòng đăng nhập lại để xem thống kê.');
                    chartStatus.textContent = 'Lỗi xác thực: Không tìm thấy phiên đăng nhập.';
                    return;
                }

                const fetchPromises = runnerCredentialsToFetch.map(async (runner) => {
                    const runnerId = runner.id;
                    if (!runnerId) {
                        console.error(`Skipping fetch for runner ${runner.runner_name || 'Unknown'} due to missing or invalid credential ID.`);
                        return { weeklyStats: [], detailedActivities: [] };
                    }
                    const payload = { runnerCredentialId: runnerId };
                    console.log(`[viewStatsBtn] Sending payload to ${GET_STATS_API_URL}:`, payload);
                    try {
                        const response = await fetch(GET_STATS_API_URL, {
                            method: 'POST',
                            headers: headers, 
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        if (response.ok && result.success) {
                            const enrichedWeeklyStats = result.weekly_stats.map(s => ({
                                ...s,
                                athlete_id: runner.athlete_id,
                                running_team: runner.running_team
                            }));
                            return { 
                                weeklyStats: enrichedWeeklyStats, 
                                detailedActivities: result.detailed_activities 
                            };
                        } else {
                            console.error(`Lỗi khi tải thống kê cho ${runner.runner_name} (credential ID: ${runnerId}):`, result.error || 'Không xác định');
                            showAlert(`Lỗi khi tải thống kê cho ${runner.runner_name}: ${result.error || 'Không xác định'}`);
                            return { weeklyStats: [], detailedActivities: [] };
                        }
                    } catch (error) {
                        console.error(`Lỗi mạng/máy chủ khi tải thống kê cho ${runner.runner_name} (credential ID: ${runnerId}):`, error);
                        showAlert(`Lỗi mạng/máy chủ khi tải thống kê cho ${runner.runner_name}: ${error.message}`);
                        return { weeklyStats: [], detailedActivities: [] };
                    }
                });

                const allResults = await Promise.all(fetchPromises);

                allResults.forEach(res => {
                    weeklyStatsData.push(...res.weeklyStats);
                });

                chartStatus.textContent = `Đã tải thống kê cho ${runnerCredentialsToFetch.length} runner. Tổng cộng ${weeklyStatsData.length} tuần.`;
                renderBubbleChart(weeklyStatsData); 
            } catch (error) {
                console.error('Lỗi chung khi tải thống kê theo tuần:', error);
                chartStatus.textContent = 'Lỗi mạng hoặc máy chủ khi tải thống kê.';
                showAlert('Lỗi mạng hoặc máy chủ khi tải thống kê.');
            }
        });

        /**
         * Renders the detailed statistics table based on userActivities.
         */
        function renderDetailedStatsTable() {
            const table = document.getElementById('detailed-stats-table');
            let currentTbody = table.lastElementChild;
            while (currentTbody && currentTbody.tagName === 'TBODY') {
                table.removeChild(currentTbody);
                currentTbody = table.lastElementChild;
            }

            detailedStatsStatus.textContent = '';

            const activitiesToDisplay = userActivities; 

            if (!activitiesToDisplay || activitiesToDisplay.length === 0) {
                detailedStatsStatus.textContent = 'Chưa có dữ liệu để hiển thị.';
                return;
            }

            const penaltyPerKmGt10 = parseFloat(penaltyPerKmGt10Input.value) || 0;
            const penaltyPerKmLte10 = parseFloat(penaltyPerKmLte10Input.value) || 0;
            const targetKmPerWeek = parseFloat(targetKmPerWeekInput.value) || 0;

            const activitiesByAthlete = activitiesToDisplay.reduce((acc, activity) => {
                const athleteId = String(activity.user_id);
                if (!acc[athleteId]) {
                    acc[athleteId] = [];
                }
                acc[athleteId].push(activity);
                return acc;
            }, {});

            const runnerInfoMap = new Map();
            allRunnerCredentials.forEach(cred => {
                if (cred.athlete_id) {
                    runnerInfoMap.set(String(cred.athlete_id), {
                        name: cred.runner_name,
                        team: cred.running_team
                    });
                }
            });
            console.log('renderDetailedStatsTable: Runner info map:', runnerInfoMap); 
            console.log('renderDetailedStatsTable: Activities grouped by athlete (filtered):', activitiesByAthlete); 

            const sortedAthleteIds = Object.keys(activitiesByAthlete).sort((a, b) => {
                const nameA = runnerInfoMap.get(a)?.name || `Runner ID: ${a}`;
                const nameB = runnerInfoMap.get(b)?.name || `Runner ID: ${b}`;
                return nameA.localeCompare(nameB);
            });

            sortedAthleteIds.forEach(athleteId => {
                const runnerName = runnerInfoMap.get(athleteId)?.name || `Runner ID: ${athleteId}`;
                const runnerTeam = runnerInfoMap.get(athleteId)?.team || 'N/A';
                console.log(`renderDetailedStatsTable: Processing runner: ${runnerName} (athleteId: ${athleteId}, team: ${runnerTeam})`);

                const runnerActivities = activitiesByAthlete[athleteId];
                let totalRunnerDistanceKm = 0;
                let totalRunnerTime = 0;

                runnerActivities.forEach(activity => {
                    totalRunnerDistanceKm += (activity.distance / 1000);
                    totalRunnerTime += activity.moving_time;
                });

                const summaryTbody = document.createElement('tbody');
                summaryTbody.className = 'runner-summary-group';

                const totalRow = summaryTbody.insertRow();
                totalRow.className = 'total-row';
                totalRow.innerHTML = `
                    <td colspan="3" class="font-bold text-lg text-bidv-green">
                        Tổng cộng cho ${runnerName} <span class="text-gray-500 text-base">(${runnerTeam})</span>
                        <span class="toggle-icon detailed-stats-toggle-icon ml-2 cursor-pointer" data-target-id="detailed-activities-for-${athleteId}">▶</span>
                    </td>
                    <td>${totalRunnerDistanceKm.toFixed(2)}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>${formatDuration(totalRunnerTime)}</td>
                `;
                const toggleIcon = totalRow.querySelector('.detailed-stats-toggle-icon');
                if (toggleIcon) {
                    toggleIcon.addEventListener('click', () => {
                        const targetId = toggleIcon.dataset.targetId;
                        const contentElement = document.getElementById(targetId);
                        toggleCollapsible(contentElement, toggleIcon);
                    });
                }

                const kmDifference = totalRunnerDistanceKm - targetKmPerWeek;
                
                let kmMessage = '';
                let amountMessage = '';
                if (kmDifference < 0) {
                    const deficitKm = Math.abs(kmDifference);
                    let penaltyRate = 0;
                    if (deficitKm <= 10) {
                        penaltyRate = penaltyPerKmLte10;
                    } else {
                        penaltyRate = penaltyPerKmGt10;
                    }
                    const penaltyAmount = deficitKm * penaltyRate;
                    kmMessage = `Số KM thiếu (Mục tiêu ${targetKmPerWeek}KM): <strong>${deficitKm.toFixed(2)} KM</strong>`;
                    amountMessage = `Số tiền phạt (Phạt ${penaltyRate}K/KM): <strong>${penaltyAmount.toLocaleString('vi-VN')} nghìn VNĐ</strong>`;
                } else {
                    const surplusKm = kmDifference;
                    const bonusAmount = surplusKm * (penaltyPerKmGt10 || 0);
                    kmMessage = `Số KM vượt mục tiêu (Mục tiêu ${targetKmPerWeek}KM): <strong>${surplusKm.toFixed(2)} KM</strong>`;
                    amountMessage = `Tiền thưởng (Thưởng ${(penaltyPerKmGt10 || 0)}K/KM): <strong>${bonusAmount.toLocaleString('vi-VN')} nghìn VNĐ</strong>`;
                }

                const summaryRow = summaryTbody.insertRow();
                summaryRow.className = kmDifference < 0 ? 'missing-row' : 'summary-row';
                summaryRow.innerHTML = `
                    <td colspan="4">${kmMessage}</td>
                    <td colspan="4">${amountMessage}</td>
                `;

                table.appendChild(summaryTbody);


                const detailedActivitiesTbody = document.createElement('tbody');
                detailedActivitiesTbody.id = `detailed-activities-for-${athleteId}`;
                detailedActivitiesTbody.className = 'collapsible-content';
                detailedActivitiesTbody.classList.add('collapsed');

                runnerActivities.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));

                runnerActivities.forEach(activity => {
                    const distanceKm = (activity.distance / 1000);
                    const row = detailedActivitiesTbody.insertRow();
                    row.innerHTML = `
                        <td></td>
                        <td>${new Date(activity.start_date).toLocaleDateString('vi-VN')}</td>
                        <td>${activity.type}</td>
                        <td>${distanceKm.toFixed(2)}</td>
                        <td>${formatPace(activity.average_speed)}</td>
                        <td>${activity.average_heartrate ? `${activity.average_heartrate.toFixed(0)}` : 'N/A'}</td>
                        <td>${formatElevationGain(activity.total_elevation_gain)}</td>
                        <td>${formatDuration(activity.moving_time)}</td>
                    `;
                });
                
                table.appendChild(detailedActivitiesTbody);

                const spacerTbody = document.createElement('tbody');
                spacerTbody.innerHTML = `<tr class="h-4 bg-gray-100"><td colspan="8"></td></tr>`;
                table.appendChild(spacerTbody);
            });

            detailedStatsStatus.textContent = '';
            if (sortedAthleteIds.length === 0) {
                detailedStatsStatus.textContent = 'Chưa có dữ liệu để hiển thị.';
            }
        }

        /**
         * Fetches clubs from Supabase and updates the global `allClubs` array.
         * @returns {Promise<Object[]>} Array of club objects.
         */
        async function fetchClubs() {
            if (!supabaseClientInstance) {
                console.error('Supabase client is not initialized for fetching clubs.');
                return [];
            }
            try {
                const { data, error } = await supabaseClientInstance
                    .from('clubs')
                    .select('*')
                    .order('name', { ascending: true });
                if (error) throw error;
                allClubs = data;
                console.log('Fetched clubs:', allClubs);
                return allClubs;
            } catch (error) {
                console.error('Error fetching clubs:', error.message);
                showAlert(`Lỗi khi tải danh sách câu lạc bộ: ${error.message}`);
                allClubs = [];
                return [];
            }
        }

        /**
         * Populates the club filter dropdowns and the runner-team select in the modal.
         */
        function populateClubDropdowns() {
            runnerTeamSelect.innerHTML = '<option value="">-- Chọn đội chạy --</option>';
            allClubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club.name;
                option.textContent = club.name;
                runnerTeamSelect.appendChild(option);
            });

            clubRecentActivitiesFilter.innerHTML = '<option value="all">Tất cả Câu lạc bộ</option>';
            allClubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club.name;
                option.textContent = club.name;
                clubRecentActivitiesFilter.appendChild(option);
            });
            if (Array.from(clubRecentActivitiesFilter.options).some(opt => opt.value === selectedClubNameForRecentActivities)) {
                clubRecentActivitiesFilter.value = selectedClubNameForRecentActivities;
            } else {
                selectedClubNameForRecentActivities = 'all';
                clubRecentActivitiesFilter.value = 'all';
            }


            clubStatsFilter.innerHTML = '<option value="">Tất cả Câu lạc bộ</option>'; 
            allClubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club.name;
                option.textContent = club.name;
                clubStatsFilter.appendChild(option);
            });
            if (Array.from(clubStatsFilter.options).some(opt => opt.value === selectedClubIdForStats)) {
                clubStatsFilter.value = selectedClubIdForStats;
            } else {
                selectedClubIdForStats = '';
                clubStatsFilter.value = '';
            }
        }


        /**
         * Populates the runner filter dropdown for the stats section.
         */
        function populateRunnerStatsFilter() {
            runnerStatsFilter.innerHTML = '<option value="">Tất cả Runner</option>';
            
            let filteredRunners = allRunnerCredentials;

            if (selectedClubIdForStats !== '') {
                filteredRunners = filteredRunners.filter(cred => cred.running_team === selectedClubIdForStats);
            }

            filteredRunners.forEach(cred => {
                if (cred.athlete_id) {
                    const option = document.createElement('option');
                    option.value = String(cred.athlete_id);
                    option.textContent = cred.runner_name;
                    runnerStatsFilter.appendChild(option);
                }
            });
            if (selectedRunnerIdForStats && 
                Array.from(runnerStatsFilter.options).some(opt => opt.value === selectedRunnerIdForStats)) {
                runnerStatsFilter.value = selectedRunnerIdForStats;
            } else {
                selectedRunnerIdForStats = '';
                runnerStatsFilter.value = '';
            }
        }

        /**
         * Converts an ISO week string (YYYY-WNN) to a Date object, representing the start of that week (Monday).
         * @param {string} w - The ISO week string (e.g., "2023-W01").
         * @returns {Date} A Date object for the Monday of the given ISO week.
         */
        function getDateFromISOWeek(w) {
            const year = parseInt(w.substring(0, 4), 10);
            const week = parseInt(w.substring(6), 10);
            const date = new Date(year, 0, 1 + (week - 1) * 7);
            date.setDate(date.getDate() + (1 - date.getDay() + (date.getDay() === 0 ? -6 : 1))); 
            return date;
        }

        /**
         * Fetches and displays detailed activities for a specific week and athlete ID.
         * @param {string} isoWeek - The ISO week string (e.g., "2023-W01").
         * @param {string} athleteId - The Strava athlete ID.
         */
        async function fetchActivitiesForWeek(isoWeek, athleteId) {
            weeklyActivitiesList.innerHTML = '';
            weeklyActivitiesStatus.textContent = 'Đang tải hoạt động cho tuần này...';
            weeklyActivitiesModal.style.display = 'flex';

            try {
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(athleteId));
                if (!runner) {
                    weeklyActivitiesStatus.textContent = 'Không tìm thấy thông tin runner.';
                    showAlert('Không tìm thấy thông tin runner cho Athlete ID này.');
                    return;
                }

                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                const headers = { 'Content-Type': 'application/json' };
                if (session?.access_token) {
                    headers['Authorization'] = `Bearer ${session.access_token}`;
                } else {
                    weeklyActivitiesStatus.textContent = 'Lỗi xác thực: Vui lòng đăng nhập lại.';
                    showAlert('Lỗi: Không tìm thấy phiên đăng nhập. Vui lòng đăng nhập lại để xem chi tiết hoạt động.');
                    return;
                }

                const payload = { 
                    runnerCredentialId: runner.id,
                    isoWeek: isoWeek
                };

                const response = await fetch(GET_STATS_API_URL, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success && result.detailed_activities) {
                    const activitiesInWeek = result.detailed_activities.filter(act => 
                        String(act.user_id) === String(athleteId) && 
                        getISOWeekString(new Date(act.start_date)) === isoWeek
                    );

                    if (activitiesInWeek.length > 0) {
                        activitiesInWeek.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
                        activitiesInWeek.forEach(activity => {
                            const li = document.createElement('li');
                            li.className = 'border-b last:border-b-0 py-2';
                            li.innerHTML = `
                                <p class="font-semibold">${activity.name} (${activity.type})</p>
                                <p class="text-sm text-gray-600">Ngày: ${new Date(activity.start_date).toLocaleDateString('vi-VN')}</p>
                                <p class="text-sm text-gray-600">Quãng đường: ${(activity.distance / 1000).toFixed(2)} km</p>
                                <p class="text-sm text-gray-600">Thời gian: ${formatDuration(activity.moving_time)}</p>
                                <p class="text-sm text-gray-600">Pace: ${formatPace(activity.average_speed)}</p>
                                ${activity.strava_activity_id ? `<button class="btn-primary mt-2 text-xs px-2 py-1 view-map-btn" data-activity-id="${activity.strava_activity_id}">Xem bản đồ</button>` : ''}
                            `;
                            weeklyActivitiesList.appendChild(li);
                        });
                        weeklyActivitiesStatus.textContent = `Đã tải ${activitiesInWeek.length} hoạt động cho tuần này.`;
                        document.querySelectorAll('#weekly-activities-modal .view-map-btn').forEach(button => {
                            button.onclick = (e) => {
                                const activityId = e.target.dataset.activityId;
                                if (activityId) {
                                    window.open(`https://www.strava.com/activities/${activityId}`, '_blank');
                                }
                            };
                        });
                    } else {
                        weeklyActivitiesStatus.textContent = 'Không tìm thấy hoạt động nào cho tuần này.';
                    }
                } else {
                    console.error('Lỗi khi tải hoạt động chi tiết cho tuần:', result.error || 'Không xác định');
                    weeklyActivitiesStatus.textContent = `Lỗi: ${result.error || 'Không xác định'}`;
                    showAlert(`Lỗi khi tải hoạt động chi tiết: ${result.error || 'Không xác định'}`);
                }
            } catch (error) {
                console.error('Lỗi mạng hoặc máy chủ khi tải hoạt động chi tiết:', error);
                weeklyActivitiesStatus.textContent = 'Lỗi mạng hoặc máy chủ khi tải hoạt động.';
                showAlert(`Lỗi mạng hoặc máy chủ khi tải hoạt động: ${error.message}`);
            }
        }

        /**
         * Helper to get ISO week string (YYYY-WNN) from a Date object.
         * @param {Date} d - The Date object.
         * @returns {string} ISO week string.
         */
        function getISOWeekString(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }
        
        // Function to draw the bubble chart
        function renderBubbleChart(data) {
            console.log('renderBubbleChart: Input data:', data);

            const monthlyDataMap = new Map();
            let filteredData = data;
            if (selectedRunnerIdForStats !== '') { 
                filteredData = filteredData.filter(d => String(d.athlete_id) === selectedRunnerIdForStats);
            }
            if (selectedClubIdForStats !== '') {
                filteredData = filteredData.filter(d => {
                    const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(d.athlete_id));
                    return runner && runner.running_team === selectedClubIdForStats;
                });
            }

            if (filteredData.length === 0) {
                document.getElementById('bubble-chart-container').innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu thống kê để hiển thị biểu đồ cho các bộ lọc đã chọn.</p>';
                console.log('renderBubbleChart: No monthly data to draw chart for selected filters.');
                return;
            }

            filteredData.forEach(d => {
                const dateInWeek = getDateFromISOWeek(d.week);
                const monthYear = dateInWeek.getFullYear() + '-' + String(dateInWeek.getMonth() + 1).padStart(2, '0');
                const monthTotalDistance = d.totalDistance;

                if (!monthlyDataMap.has(monthYear)) {
                    monthlyDataMap.set(monthYear, { month: monthYear, weeks: [], totalMonthlyDistance: 0 });
                }
                monthlyDataMap.get(monthYear).weeks.push(d);
                monthlyDataMap.get(monthYear).totalMonthlyDistance += d.totalDistance;
            });

            const monthlyData = Array.from(monthlyDataMap.values()).sort((a, b) => b.month.localeCompare(a.month));

            const container = document.getElementById('bubble-chart-container');
            container.innerHTML = ''; 

            if (!monthlyData || monthlyData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu thống kê để hiển thị biểu đồ. Vui lòng tải dữ liệu từ Strava hoặc chọn bộ lọc khác.</p>';
                console.log('renderBubbleChart: No monthly data to draw chart.');
                return;
            }

            const width = container.clientWidth;
            const monthBandHeight = width < 768 ? 120 : 180;
            const topPaddingForChart = width < 768 ? 70 : 100;

            const totalSvgContentHeight = (monthlyData.length * monthBandHeight) + topPaddingForChart;
            const svgHeight = Math.max(container.clientHeight, totalSvgContentHeight);

            console.log(`renderBubbleChart: SVG dimensions - Width: ${width}, Height: ${svgHeight}`);
            if (width <= 0 || svgHeight <= 0) {
                console.error('renderBubbleChart Error: Invalid chart dimensions. Width or Height <= 0.');
                container.innerHTML = '<p class="text-red-500">Lỗi: Kích thước biểu đồ không hợp lệ. Vui lòng thử lại hoặc đảm bảo khung chứa hiển thị.</p>';
                return;
            }


            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", svgHeight)
                .attr("viewBox", `0 0 ${width} ${svgHeight}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxDistance = d3.max(filteredData, d => d.totalDistance);
            const minDistance = d3.min(filteredData, d => d.totalDistance);

            console.log(`renderBubbleChart: Min Distance: ${minDistance}, Max Distance: ${maxDistance}`);
            
            const maxRadius = width < 768 ? 30 : 60;
            const minRadius = width < 768 ? 8 : 15;

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxDistance || 1])
                .range([minRadius, maxRadius]);

            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxDistance || 1, minDistance || 0]);


            const bubbleHorizontalPadding = width < 768 ? 10 : 20;
            const bubbleVerticalOffset = monthBandHeight / 2;

            let currentYOffset = topPaddingForChart;

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            monthlyData.forEach((monthObj) => {
                const monthGroup = svg.append("g")
                    .attr("transform", `translate(0, ${currentYOffset})`);

                const monthDisplay = `Tháng ${monthObj.month.substring(5)}/${monthObj.month.substring(0, 4)}`;
                const totalMonthlyKm = (monthObj.totalMonthlyDistance / 1000).toFixed(1);

                monthGroup.append("text")
                    .attr("x", 20)
                    .attr("y", 25)
                    .attr("font-size", width < 768 ? "1rem" : "1.2rem")
                    .attr("font-weight", "bold")
                    .attr("fill", "#555")
                    .text(`${monthDisplay} (${totalMonthlyKm}KM)`);

                monthObj.weeks.sort((a, b) => a.week.localeCompare(b.week));

                let currentX = 20;

                const positionedWeeks = monthObj.weeks.map(d => {
                    const r = radiusScale(d.totalDistance);
                    const cx = currentX + r;
                    currentX += (r * 2) + bubbleHorizontalPadding;
                    return { ...d, r, cx, cy: bubbleVerticalOffset + (width < 768 ? 0 : 10) };
                });

                console.log('renderBubbleChart: positionedWeeks for month', monthObj.month, ':', positionedWeeks);

                monthGroup.selectAll(".bubble")
                    .data(positionedWeeks)
                    .enter().append("circle")
                    .attr("class", "bubble")
                    .attr("cx", d => d.cx)
                    .attr("cy", d => d.cy)
                    .attr("r", d => d.r)
                    .attr("fill", d => colorScale(d.totalDistance))
                    .attr("stroke-width", 2)
                    .on("click", function(event, d) {
                        fetchActivitiesForWeek(d.week, d.athlete_id); 
                        weeklyActivitiesTitle.textContent = `Hoạt động của ${allRunnerCredentials.find(rc => String(rc.athlete_id) === String(d.athlete_id))?.runner_name || `Runner ID: ${d.athlete_id}`} trong tuần ${d.week.split('-W')[1]} (${d.week.split('-W')[0]}):`;
                    });

                monthGroup.selectAll(".bubble-text")
                    .data(positionedWeeks)
                    .enter().append("text")
                    .attr("class", "bubble-text")
                    .attr("x", d => d.cx)
                    .attr("y", d => d.cy)
                    .text(d => d.r > (width < 768 ? 15 : 25) ? `${(d.totalDistance / 1000).toFixed(1)}km` : '')
                    .attr("dy", "0.35em")
                    .attr("fill", "white")
                    .attr("pointer-events", "none");

                currentYOffset += monthBandHeight;
            });
        }

        /**
         * Handles the "Analyze Activities (AI)" button click.
         */
        analyzeActivitiesBtn.addEventListener('click', async () => {
            if (!currentAppUserId) {
                showAlert('Vui lòng đăng nhập ứng dụng để sử dụng chức năng phân tích AI.');
                return;
            }
            if (userActivities.length === 0) {
                showAlert('Không có hoạt động nào để phân tích. Vui lòng tải hoạt động từ Strava trước.');
                return;
            }

            llmAnalysisSection.classList.remove('hidden');
            llmAnalysisContent.innerHTML = '<div class="loader"></div> Đang phân tích hoạt động của bạn với AI...';
            llmAnalysisStatus.textContent = '';

            llmAnalysisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    showAlert('Lỗi: Không tìm thấy phiên đăng nhập. Vui lòng đăng nhập lại để phân tích AI.');
                    llmAnalysisContent.innerHTML = '<p class="text-red-500">Lỗi xác thực: Không tìm thấy phiên đăng nhập.</p>';
                    return;
                }

                const activitiesForLLM = userActivities.map(activity => ({
                    id: activity.strava_activity_id,
                    name: activity.name,
                    type: activity.type,
                    distance_m: activity.distance,
                    moving_time_s: activity.moving_time,
                    elevation_gain_m: activity.total_elevation_gain,
                    start_date: activity.start_date,
                    average_speed_mps: activity.average_speed,
                    average_heartrate_bpm: activity.average_heartrate,
                    runner_id: activity.user_id
                }));
                
                const response = await fetch(ANALYZE_ACTIVITIES_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ 
                        activities: activitiesForLLM
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    let analysisContent = result.analysis;
                    if (typeof analysisContent === 'string') {
                        try {
                            const parsedAnalysis = JSON.parse(analysisContent);
                            if (parsedAnalysis.analysis) {
                                analysisContent = parsedAnalysis.analysis;
                            }
                        } catch (e) {
                            console.warn("Analysis content was a string but not a JSON object, using as-is.");
                        }
                    }

                    if (analysisContent) {
                        const msRegex = /(\d+\.?\d*)\s*m\/s/g;
                        analysisContent = analysisContent.replace(msRegex, (match, value) => {
                            const speedInMs = parseFloat(value);
                            if (!isNaN(speedInMs)) {
                                return formatPace(speedInMs);
                            }
                            return match;
                        });

                        llmAnalysisContent.innerHTML = marked.parse(analysisContent); 
                        llmAnalysisStatus.textContent = 'Phân tích AI hoàn tất.';
                    } else {
                        llmAnalysisContent.innerHTML = `<p class="text-red-500">Không thể nhận được nội dung phân tích từ AI.</p>`;
                        llmAnalysisStatus.textContent = 'Lỗi: Nội dung phân tích trống.';
                    }
                } else {
                    llmAnalysisContent.innerHTML = `<p class="text-red-500">Không thể nhận được phân tích từ AI. Lỗi: ${result.error || 'Không xác định'}. Vui lòng thử lại.</p>`;
                    llmAnalysisStatus.textContent = 'Lỗi khi nhận phân tích từ AI.';
                    console.error('Lỗi từ Edge Function hoặc cấu trúc phản hồi AI không mong đợi:', result);
                }

            } catch (error) {
                console.error('Lỗi khi gọi Edge Function phân tích AI:', error);
                llmAnalysisContent.innerHTML = `<p class="text-red-500">Lỗi mạng hoặc máy chủ khi phân tích AI: ${error.message}</p>`;
                llmAnalysisStatus.textContent = 'Lỗi trong quá trình phân tích AI.';
            }
        });


        // When the page loads
        window.onload = async () => {
            if (typeof window.supabase === 'undefined') {
                showAlert('Lỗi: Thư viện Supabase không được tải. Vui lòng kiểm tra kết nối internet hoặc URL CDN.');
                console.error('Thư viện Supabase không được định nghĩa. Vui lòng kiểm tra thẻ script CDN Supabase.');
                return;
            }
            supabaseClientInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            console.log('Supabase URL:', SUPABASE_URL);
            console.log('Supabase Anon Key (first 10 chars):', SUPABASE_ANON_KEY.substring(0, 10) + '...');

            // Supabase Auth Listener
            supabaseClientInstance.auth.onAuthStateChange((event, session) => {
                console.log('Supabase Auth state changed:', event, session);
                updateAppAuthUI(session?.user || null);
            });

            // Set up event listeners for app authentication forms
            authForm.addEventListener('submit', handleAuth);
            guestLoginBtn.addEventListener('click', handleGuestLogin);
            signoutBtn.addEventListener('click', handleSignOut);


            // Set up event listeners for credential management
            addCredentialBtn.addEventListener('click', () => openCredentialModal());
            closeModalBtn.addEventListener('click', () => credentialModal.style.display = 'none');
            cancelModalBtn.addEventListener('click', () => credentialModal.style.display = 'none');
            credentialForm.addEventListener('submit', saveCredential);
            
            // Set up event listener for Strava disconnect button
            disconnectStravaBtn.addEventListener('click', () => {
                clearStravaSession();
                checkStravaAuthState();
                showAlert('Đã đăng xuất Strava.');
            });

            // Set up event listener for weekly activities modal close button
            closeWeeklyActivitiesModalBtn.addEventListener('click', () => weeklyActivitiesModal.style.display = 'none');

            // Handle initial Strava OAuth callback if any
            await handleStravaCallback(); 

            // Auto-fill date filters
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];
            endDateRecent.value = endDate;

            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            const startDate = sevenDaysAgo.toISOString().split('T')[0];
            startDateRecent.value = startDate;

            // Add resize event listener to redraw the chart
            window.addEventListener('resize', () => {
                if (weeklyStatsData && weeklyStatsData.length > 0) {
                    renderBubbleChart(weeklyStatsData);
                }
            });

            // Initialize activity type filters
            populateActivityTypeFilters();
            updateMultiSelectDisplay(multiSelectDisplayRecent, selectedActivityTypesRecent, document.getElementById('multi-select-options-recent'));
            
            runnerRecentActivitiesFilter.addEventListener('change', () => {
                selectedRunnerIdForRecentActivities = runnerRecentActivitiesFilter.value;
                loadRecentActivitiesBtn.click();
            });
            clubRecentActivitiesFilter.addEventListener('change', () => {
                selectedClubNameForRecentActivities = clubRecentActivitiesFilter.value;
                loadRecentActivitiesBtn.click();
            });


            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    const contentElement = document.getElementById(targetId);
                    const toggleIcon = header.querySelector('.toggle-icon');
                    toggleCollapsible(contentElement, toggleIcon);
                });
            });
            toggleCollapsible(downloadForOtherContent, downloadForOtherSection.querySelector('.toggle-icon'), true);


            penaltyPerKmGt10Input.addEventListener('input', renderDetailedStatsTable); 
            penaltyPerKmLte10Input.addEventListener('input', renderDetailedStatsTable); 
            targetKmPerWeekInput.addEventListener('input', renderDetailedStatsTable);

            startDateRecent.addEventListener('change', () => loadRecentActivitiesBtn.click());
            endDateRecent.addEventListener('change', () => loadRecentActivitiesBtn.click());

            runnerStatsFilter.addEventListener('change', () => {
                selectedRunnerIdForStats = runnerStatsFilter.value;
                if (weeklyStatsData.length > 0) {
                    renderBubbleChart(weeklyStatsData);
                }
            });
            clubStatsFilter.addEventListener('change', () => {
                selectedClubIdForStats = clubStatsFilter.value;
                populateRunnerStatsFilter(); 
                if (weeklyStatsData.length > 0) {
                    renderBubbleChart(weeklyStatsData);
                }
            });

            // Initial collapse instruction section
            toggleCollapsible(instructionContent, instructionSection.querySelector('.toggle-icon'), true);
            
            // Scroll-to-top button logic
            window.onscroll = function() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollToTopBtn.style.display = "block";
                } else {
                    scrollToTopBtn.style.display = "none";
                }
            };
            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });

            // Trigger initial load of recent activities and detailed stats after all setup
            // This is triggered by onAuthStateChange now
        };
    </script>
</body>
</html>
