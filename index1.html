<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Quản lý Thành tích Chạy bộ - FOR RUNNER LOVER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Define BIDV brand colors */
        :root {
            --bidv-green: #006b68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Adjust primary button to BIDV green */
        .btn-primary {
            background-color: var(--bidv-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: #005a57; /* Darker green on hover */
        }

        /* Adjust secondary button to BIDV yellow */
        .btn-secondary {
            background-color: var(--bidv-yellow);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background-color: #e6b32a; /* Darker yellow on hover */
        }

        .btn-danger {
            @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out shadow-md;
        }

        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        /* Styling for the bubble chart container */
        #bubble-chart-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden; /* Hide horizontal overflow */
            overflow-y: auto; /* Allow vertical scrolling */
            background-color: #f9fafb; /* Light background for chart */
            border-radius: 0.5rem;
            min-height: 300px;
        }

        .bubble {
            stroke: var(--bidv-green);
            stroke-width: 2px;
            fill-opacity: 0.7;
            cursor: pointer;
            transition: fill-opacity 0.3s ease;
        }

        .bubble:hover {
            fill-opacity: 1;
        }

        .bubble-text {
            font-size: 0.8rem;
            text-anchor: middle;
            fill: white;
            pointer-events: none; /* Allow clicks to pass through text to bubble */
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.9rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .flex-wrap > .btn-primary, .flex-wrap > .btn-secondary {
                flex-basis: 100%; /* Full width for buttons on small screens */
            }
        }

        /* Loading spinner for LLM analysis */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid var(--bidv-green); /* BIDV Green */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-bidv-green p-4 shadow-md">
        <div class="container flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://placehold.co/50x50/006B68/FFC62F?text=BIDV" alt="Logo BIDV Running Club" class="h-12 w-auto rounded-md">
                <h1 class="text-2xl font-bold text-bidv-yellow">🏃‍♂️‍➡️Running Lovers with AI✨</h1>
            </div>
            <nav>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <!-- Credential Management Section (Restored) -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
                Quản lý Runner (Thông tin đăng nhập Strava)
                <button id="add-credential-btn" class="btn-primary">Thêm Runner mới</button>
            </h2>
            <div id="credentials-list" class="space-y-4">
                <!-- Credentials will be loaded here -->
                <p class="text-gray-500 text-center" id="no-credentials-message">Không có runner nào được lưu.</p>
            </div>
            <p id="loading-credentials" class="text-gray-500 text-center hidden">Đang tải thông tin runner...</p>
            <p id="error-credentials" class="text-red-500 text-center hidden">Lỗi khi tải thông tin runner.</p>
        </div>

        <!-- Strava Login Section (Adjusted) -->
        <section id="auth-section" class="card mb-8 text-center">
            <h2 class="text-xl font-semibold mb-4">Kết nối tài khoản Strava của bạn</h2>
            <p class="mb-6">Để theo dõi thành tích chạy bộ, vui lòng chọn một runner và kết nối với Strava.</p>
            
            <div class="mb-4">
                <label for="runner-select" class="block text-gray-700 text-sm font-bold mb-2">Chọn Runner để đăng nhập:</label>
                <select id="runner-select" class="form-input">
                    <option value="">-- Chọn Runner --</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Chọn runner đã thêm ở trên để kết nối với Strava.</p>
            </div>

            <button id="connect-strava-btn" class="btn-primary">
                Đăng nhập với Strava
            </button>
            <button id="disconnect-strava-btn" class="btn-secondary hidden ml-4">
                Đăng xuất Strava
            </button>
            <div id="auth-status" class="mt-4 text-sm text-gray-600"></div>
            <p id="current-runner-display" class="mt-2 text-center text-sm text-gray-600 hidden">Đang đăng nhập với: <span class="font-semibold" id="current-runner-name"></span></p>
        </section>

        <!-- Activity Data & Visualization Section -->
        <section id="data-section" class="card mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Dữ liệu thành tích chạy bộ</h2>
            <p id="user-info" class="mb-4 text-lg font-medium"></p>
            <div class="mb-4">
                <label for="activities-limit" class="block text-gray-700 text-sm font-bold mb-2">Số lượng hoạt động muốn tải từ Strava (mặc định 60):</label>
                <input type="number" id="activities-limit" class="form-input" value="60" min="1" step="1">
            </div>
            <div class="flex flex-wrap gap-4 mb-6">
                <button id="fetch-activities-btn" class="btn-primary">
                    Tải/Cập nhật dữ liệu từ Strava
                </button>
                <button id="view-stats-btn" class="btn-secondary">
                    Xem thống kê theo tuần
                </button>
                <button id="analyze-activities-btn" class="btn-primary">
                    ✨ Phân tích hoạt động (AI)
                </button>
            </div>
            <div id="data-status" class="mt-4 text-sm text-gray-600"></div>

            <div id="activities-list-section" class="mt-6 border-t pt-4">
                <h3 class="text-lg font-semibold mb-3">Các hoạt động gần đây:</h3>
                <div class="mb-4">
                    <label for="num-recent-activities" class="block text-gray-700 text-sm font-bold mb-2">Số lượng hoạt động gần đây muốn hiển thị (mặc định 10):</label>
                    <input type="number" id="num-recent-activities" class="form-input" value="10" min="1" step="1">
                </div>
                <button id="load-recent-activities-btn" class="btn-secondary mb-4">
                    Tải hoạt động gần đây
                </button>
                <ul id="recent-activities" class="space-y-2 text-sm">
                    <li class="text-gray-500">Nhấn "Tải hoạt động gần đây" để xem.</li>
                </ul>
                <div id="recent-activities-status" class="mt-2 text-sm text-gray-600"></div>
            </div>

            <div id="llm-analysis-section" class="mt-6 border-t pt-4 hidden">
                <h3 class="text-lg font-semibold mb-3">Phân tích hoạt động của bạn:</h3>
                <div id="llm-analysis-content" class="bg-gray-100 p-4 rounded-md text-sm">
                    <p class="text-gray-500">Nhấn "✨ Phân tích hoạt động (AI)" để nhận phân tích từ AI.</p>
                </div>
                <div id="llm-analysis-status" class="mt-2 text-sm text-gray-600"></div>
            </div>

        </section>

        <section id="stats-section" class="card hidden">
            <h2 class="text-xl font-semibold mb-4">Thống kê thành tích theo tuần</h2>
            <div id="bubble-chart-container">
                <p class="text-gray-500 text-center">Nhấn "Xem thống kê theo tuần" để hiển thị biểu đồ.</p>
            </div>
            <div id="chart-status" class="mt-4 text-sm text-gray-600"></div>
        </section>
    </main>

    <footer class="bg-bidv-green text-white p-4 text-center text-sm">
        <div class="container" style="color: var(--bidv-yellow);">
            &copy; 2025 Trương Hồng Quân - BIDV Running Club. All rights reserved (Dev by AIs - Gemini, GPT).
        </div>
    </footer>

    <!-- Credential Modal -->
    <div id="credential-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal-btn">&times;</span>
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">Thêm thông tin đăng nhập Runner</h3>
            <form id="credential-form" class="space-y-4">
                <div>
                    <label for="runner-name" class="block text-gray-700 text-sm font-bold mb-2">Tên Runner:</label>
                    <input type="text" id="runner-name" class="form-input" placeholder="Ví dụ: MyRunningAccount" required>
                </div>
                <div>
                    <label for="client-id" class="block text-gray-700 text-sm font-bold mb-2">Client ID:</label>
                    <input type="text" id="client-id" class="form-input" placeholder="Nhập Strava Client ID" required>
                </div>
                <div>
                    <label for="client-secret" class="block text-gray-700 text-sm font-bold mb-2">Client Secret:</label>
                    <input type="password" id="client-secret" class="form-input" placeholder="Nhập Strava Client Secret" required>
                </div>
                <div>
                    <label for="refresh-token" class="block text-gray-700 text-sm font-bold mb-2">Refresh Token:</label>
                    <input type="password" id="refresh-token" class="form-input" placeholder="Nhập Strava Refresh Token" required>
                </div>
                <div>
                    <label for="redirect-uri" class="block text-gray-700 text-sm font-bold mb-2">Redirect URI:</label>
                    <input type="text" id="redirect-uri" class="form-input" value="https://quantrh.github.io/Strava/" readonly required>
                </div>
                <input type="hidden" id="credential-id">
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" id="cancel-modal-btn" class="btn-secondary">Hủy</button>
                    <button type="submit" class="btn-primary">Lưu thông tin</button>
                </div>
            </form>
        </div>
    </div>

    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="alert-message" class="mb-4 text-lg"></p>
            <button id="alert-ok-btn" class="btn-primary">OK</button>
        </div>
    </div>

    <script>
        // Function to display custom alert instead of alert()
        function showAlert(message) {
            const customAlert = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');

            alertOkBtn.onclick = () => {
                customAlert.classList.add('hidden');
            };
        }

        // Your Strava and Supabase configuration
        const STRAVA_CLIENT_ID = '55949'; // Get from Strava API application
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Your Supabase project URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Your public anon key for Supabase
        // URL of the Edge Function to handle OAuth callback
        const STRAVA_OAUTH_CALLBACK_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/strava-oauth-callback';
        // URL of the Edge Function to fetch activity data
        const FETCH_ACTIVITIES_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/fetch-strava-activities';
        // URL of the Edge Function to get statistics data
        const GET_STATS_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/get-user-activities';


        // Global variables to store user status and activity data
        let currentRunnerCredentialId = null; // This will store the Supabase runner_credentials.id (UUID)
        let isAuthenticated = false;
        let userActivities = []; // New variable to store all loaded activities
        let weeklyStatsData = []; // Store weekly stats data globally
        let currentAthleteId = null; // Stores Strava athlete ID for API calls and for activities.user_id
        let currentRunnerName = null; // Stores the name of the currently logged-in runner

        // Initialize Supabase client instance
        let supabaseClientInstance;

        // DOM elements
        const addCredentialBtn = document.getElementById('add-credential-btn');
        const credentialsList = document.getElementById('credentials-list');
        const noCredentialsMessage = document.getElementById('no-credentials-message');
        const loadingCredentials = document.getElementById('loading-credentials');
        const errorCredentials = document.getElementById('error-credentials');
        const credentialModal = document.getElementById('credential-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const credentialForm = document.getElementById('credential-form');
        const runnerNameInput = document.getElementById('runner-name');
        const clientIdInput = document.getElementById('client-id');
        const clientSecretInput = document.getElementById('client-secret');
        const refreshTokenInput = document.getElementById('refresh-token');
        const redirectUriInput = document.getElementById('redirect-uri');
        const credentialIdInput = document.getElementById('credential-id');
        const runnerSelect = document.getElementById('runner-select');
        const connectStravaBtn = document.getElementById('connect-strava-btn');
        const disconnectStravaBtn = document.getElementById('disconnect-strava-btn');
        const authStatus = document.getElementById('auth-status');
        const currentRunnerDisplay = document.getElementById('current-runner-display');
        const currentRunnerNameSpan = document.getElementById('current-runner-name');
        const fetchActivitiesBtn = document.getElementById('fetch-activities-btn');
        const viewStatsBtn = document.getElementById('view-stats-btn');
        const analyzeActivitiesBtn = document.getElementById('analyze-activities-btn');
        const dataSection = document.getElementById('data-section');
        const authSection = document.getElementById('auth-section');
        const statsSection = document.getElementById('stats-section');
        const userInfo = document.getElementById('user-info');
        const activitiesLimitInput = document.getElementById('activities-limit');
        const numRecentActivitiesInput = document.getElementById('num-recent-activities');
        const loadRecentActivitiesBtn = document.getElementById('load-recent-activities-btn');
        const recentActivitiesList = document.getElementById('recent-activities');
        const recentActivitiesStatus = document.getElementById('recent-activities-status');


        // --- Credential Management Functions ---

        /**
         * Fetches and displays runner credentials from Supabase.
         * Populates the credentials list and the runner selection dropdown.
         */
        async function displayCredentials() {
            loadingCredentials.classList.remove('hidden');
            errorCredentials.classList.add('hidden');
            credentialsList.innerHTML = '';
            noCredentialsMessage.classList.add('hidden');
            runnerSelect.innerHTML = '<option value="">-- Chọn Runner --</option>'; // Clear existing options

            try {
                const { data, error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('*')
                    .order('runner_name', { ascending: true });

                if (error) throw error;

                if (data.length === 0) {
                    noCredentialsMessage.classList.remove('hidden');
                } else {
                    noCredentialsMessage.classList.add('hidden');
                    data.forEach(cred => {
                        const maskedSecret = '*'.repeat(cred.client_secret.length);
                        const maskedRefresh = '*'.repeat(cred.refresh_token.length);
                        const maskedRedirectUri = cred.redirect_uri ? '*'.repeat(cred.redirect_uri.length) : 'N/A';

                        const credDiv = document.createElement('div');
                        credDiv.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3';
                        credDiv.innerHTML = `
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${cred.runner_name}</p>
                                <p class="text-sm text-gray-600">Client ID: <span class="font-mono">${cred.client_id}</span></p>
                                <p class="text-sm text-gray-600">Client Secret: <span class="font-mono">${maskedSecret}</span></p>
                                <p class="text-sm text-gray-600">Refresh Token: <span class="font-mono">${maskedRefresh}</span></p>
                                <p class="text-sm text-gray-600">Redirect URI: <span class="font-mono">${maskedRedirectUri}</span></p>
                                ${cred.athlete_id ? `<p class="text-sm text-gray-600">Athlete ID: <span class="font-mono">${cred.athlete_id}</span></p>` : ''}
                            </div>
                            <div class="flex flex-row gap-2 mt-2 sm:mt-0">
                                <button class="btn-secondary btn-edit" data-id="${cred.id}">Sửa</button>
                                <button class="btn-danger btn-delete" data-id="${cred.id}">Xóa</button>
                            </div>
                        `;
                        credentialsList.appendChild(credDiv);

                        const option = document.createElement('option');
                        option.value = cred.id; // Use the Supabase credential ID as the value
                        option.textContent = cred.runner_name;
                        option.dataset.clientId = cred.client_id; // Store client ID for OAuth flow
                        option.dataset.clientSecret = cred.client_secret; // Store client secret for OAuth flow
                        option.dataset.refreshToken = cred.refresh_token; // Store refresh token for OAuth flow
                        option.dataset.redirectUri = cred.redirect_uri; // Store redirect URI
                        option.dataset.athleteId = cred.athlete_id || ''; // Store athlete ID
                        runnerSelect.appendChild(option);
                    });
                    
                    document.querySelectorAll('.btn-edit').forEach(button => {
                        button.onclick = (e) => openCredentialModal(e.target.dataset.id);
                    });
                    document.querySelectorAll('.btn-delete').forEach(button => {
                        button.onclick = async (e) => {
                            const confirmed = window.confirm('Bạn có chắc chắn muốn xóa thông tin đăng nhập này không?'); 
                            if (confirmed) {
                                await deleteCredential(e.target.dataset.id);
                            }
                        };
                    });
                }
            }
            catch (error) {
                console.error('Lỗi khi lấy thông tin đăng nhập runner:', error.message);
                errorCredentials.textContent = `Lỗi: ${error.message}`;
                errorCredentials.classList.remove('hidden');
                showAlert(`Lỗi khi tải thông tin runner: ${error.message}`);
            }
            finally {
                loadingCredentials.classList.add('hidden');
            }
        }

        /**
         * Opens the modal for adding or editing runner credentials.
         * @param {string|null} id - ID of the credential to edit, or null for new.
         */
        async function openCredentialModal(id = null) {
            credentialForm.reset();
            credentialIdInput.value = '';
            modalTitle.textContent = 'Thêm thông tin đăng nhập Runner';
            // Set default redirect URI
            redirectUriInput.value = window.location.origin + '/Strava/'; 

            if (id) {
                modalTitle.textContent = 'Sửa thông tin đăng nhập Runner';
                try {
                    const { data, error } = await supabaseClientInstance
                        .from('runner_credentials')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    runnerNameInput.value = data.runner_name;
                    clientIdInput.value = data.client_id;
                    clientSecretInput.value = data.client_secret; 
                    refreshTokenInput.value = data.refresh_token; 
                    redirectUriInput.value = data.redirect_uri; 
                    credentialIdInput.value = data.id;
                } catch (error) {
                    console.error('Lỗi khi lấy thông tin đăng nhập để chỉnh sửa:', error.message);
                    showAlert(`Lỗi khi tải chi tiết runner: ${error.message}`);
                }
            }
            credentialModal.style.display = 'flex';
        }

        /**
         * Saves (adds or updates) runner credentials to Supabase.
         * @param {Event} event - Form submission event.
         */
        async function saveCredential(event) {
            event.preventDefault();

            const id = credentialIdInput.value;
            const runnerName = runnerNameInput.value.trim();
            const clientId = clientIdInput.value.trim();
            const clientSecret = clientSecretInput.value.trim();
            const refreshToken = refreshTokenInput.value.trim();
            const redirectUri = redirectUriInput.value.trim();

            if (!runnerName || !clientId || !clientSecret || !refreshToken || !redirectUri) {
                showAlert('Vui lòng điền đầy đủ tất cả các trường bắt buộc.');
                return;
            }

            const newCredential = {
                runner_name: runnerName,
                client_id: clientId,
                client_secret: clientSecret,
                refresh_token: refreshToken,
                redirect_uri: redirectUri
                // athlete_id will be set during OAuth callback
            };

            try {
                let error = null;
                if (id) {
                    const { error: updateError } = await supabaseClientInstance
                        .from('runner_credentials')
                        .update(newCredential)
                        .eq('id', id);
                    error = updateError;
                    showAlert('Cập nhật thông tin runner thành công!');
                } else {
                    const { error: insertError } = await supabaseClientInstance
                        .from('runner_credentials')
                        .insert([newCredential]);
                    error = insertError;
                    showAlert('Thêm runner mới thành công!');
                }

                if (error) throw error;

                credentialModal.style.display = 'none';
                await displayCredentials(); // Refresh the list and dropdown
            } catch (error) {
                console.error('Lỗi khi lưu thông tin đăng nhập runner:', error.message);
                showAlert(`Lỗi khi lưu thông tin runner: ${error.message}`);
            }
        }

        /**
         * Deletes a runner credential from Supabase.
         * @param {string} id - ID of the credential to delete.
         */
        async function deleteCredential(id) {
            try {
                const { error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showAlert('Xóa thông tin runner thành công!');
                // If the deleted runner was the current logged-in one, log out
                if (currentRunnerCredentialId === id) {
                    clearStravaSession();
                    checkAuthState();
                }
                await displayCredentials(); // Refresh the list and dropdown
            } catch (error) {
                console.error('Lỗi khi xóa thông tin đăng nhập runner:', error.message);
                showAlert(`Lỗi khi xóa thông tin runner: ${error.message}`);
            }
        }


        // --- Strava Authentication & API Interaction ---

        /**
         * Checks the current Strava authentication status and updates the UI.
         */
        async function checkAuthState() {
            // currentRunnerCredentialId stores the Supabase runner_credentials.id (UUID)
            currentRunnerCredentialId = localStorage.getItem('strava_runner_credential_id'); 
            isAuthenticated = localStorage.getItem('strava_authenticated') === 'true';
            currentAthleteId = localStorage.getItem('strava_athlete_id'); // Strava athlete ID (number) for activities.user_id
            currentRunnerName = localStorage.getItem('strava_runner_name'); // Runner name (string)

            console.log('checkAuthState - Kiểm tra trạng thái xác thực...');
            console.log('  isAuthenticated:', isAuthenticated);
            console.log('  currentRunnerCredentialId (Credential ID):', currentRunnerCredentialId);
            console.log('  currentAthleteId (Strava ID):', currentAthleteId);
            console.log('  currentRunnerName:', currentRunnerName);

            if (isAuthenticated && currentRunnerCredentialId && currentAthleteId && currentRunnerName) {
                const expiresAt = localStorage.getItem('strava_expires_at');
                const refreshToken = localStorage.getItem('strava_refresh_token');

                const now = Date.now();
                if (expiresAt && now < parseInt(expiresAt, 10)) {
                    console.log('  Token hợp lệ. Đã đăng nhập.');
                    authStatus.textContent = 'Đã đăng nhập với Strava.';
                    currentRunnerNameSpan.textContent = currentRunnerName;
                    currentRunnerDisplay.classList.remove('hidden');
                    connectStravaBtn.classList.add('hidden');
                    disconnectStravaBtn.classList.remove('hidden');
                    dataSection.classList.remove('hidden');
                    statsSection.classList.remove('hidden');
                    userInfo.textContent = `Chào mừng, Runner: ${currentRunnerName} (Strava ID: ${currentAthleteId})`; 
                    
                    // Select the logged-in runner in the dropdown
                    runnerSelect.value = currentRunnerCredentialId;

                } else {
                    console.log('  Token đã hết hạn hoặc không có. Đang thử làm mới...');
                    authStatus.textContent = 'Token đã hết hạn, đang làm mới...';
                    try {
                        const success = await refreshTokenCall(refreshToken, currentRunnerCredentialId); // Pass credential ID
                        if (success) {
                            showAlert('Token đã được làm mới thành công!');
                            checkAuthState(); // Re-check state after refresh
                        } else {
                            throw new Error('Làm mới token thất bại. Vui lòng đăng nhập lại.');
                        }
                    } catch (err) {
                        console.error('Lỗi làm mới token:', err);
                        showAlert(`Lỗi làm mới token: ${err.message}. Vui lòng đăng nhập lại.`);
                        clearStravaSession();
                        checkAuthState();
                    }
                }
            } else {
                console.log('  Chưa đăng nhập hoặc thiếu thông tin phiên.');
                clearStravaSession(); // Ensure all related items are cleared
                authStatus.textContent = 'Vui lòng chọn Runner và đăng nhập với Strava.';
                currentRunnerDisplay.classList.add('hidden');
                connectStravaBtn.classList.remove('hidden');
                disconnectStravaBtn.classList.add('hidden');
                dataSection.classList.add('hidden');
                statsSection.classList.add('hidden');
                userInfo.textContent = ''; // Clear user info
                // Reset content if not authenticated
                recentActivitiesList.innerHTML = '<li class="text-gray-500">Nhấn "Tải hoạt động gần đây" để xem.</li>';
                document.getElementById('bubble-chart-container').innerHTML = '<p class="text-gray-500 text-center">Nhấn "Xem thống kê theo tuần" để hiển thị biểu đồ.</p>';
            }
        }

        /**
         * Clears all Strava session data from local storage.
         * This logs the user out of Strava within the app.
         */
        function clearStravaSession() {
            console.log('clearStravaSession - Đang xóa dữ liệu phiên Strava khỏi localStorage.');
            localStorage.removeItem('strava_access_token');
            localStorage.removeItem('strava_refresh_token');
            localStorage.removeItem('strava_expires_at');
            localStorage.removeItem('strava_athlete_id');
            localStorage.removeItem('strava_runner_name');
            localStorage.removeItem('strava_runner_credential_id'); // Clear the credential ID used for login
        }

        /**
         * Refreshes the Strava access token using the refresh token.
         * @param {string} refreshToken - The current refresh token.
         * @param {string} credentialId - The Supabase UUID of the runner credential.
         * @returns {Promise<boolean>} True if refresh successful, false otherwise.
         */
        async function refreshTokenCall(refreshToken, credentialId) {
            console.log('refreshTokenCall - Đang gọi API làm mới token...');
            try {
                // Fetch client_id and client_secret for the given credentialId from Supabase
                const { data: credData, error: credError } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('client_id, client_secret')
                    .eq('id', credentialId)
                    .single();

                if (credError || !credData) {
                    throw new Error(`Không tìm thấy thông tin đăng nhập phù hợp cho ID ${credentialId} để làm mới token.`);
                }

                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: credData.client_id,
                        client_secret: credData.client_secret,
                        refresh_token: refreshToken,
                        grant_type: 'refresh_token'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Làm mới token thất bại: ${errorData.message || response.statusText}`);
                }

                const data = await response.json();
                localStorage.setItem('strava_access_token', data.access_token);
                localStorage.setItem('strava_refresh_token', data.refresh_token);
                localStorage.setItem('strava_expires_at', data.expires_at * 1000);
                // Also update the athlete_id in runner_credentials if it changed or wasn't set
                await supabaseClientInstance
                    .from('runner_credentials')
                    .update({ athlete_id: data.athlete.id })
                    .eq('id', credentialId);

                return true;
            } catch (error) {
                console.error('Lỗi khi làm mới token:', error.message);
                return false;
            }
        }

        /**
         * Initiates the Strava OAuth authorization flow.
         */
        connectStravaBtn.addEventListener('click', () => {
            const selectedOption = runnerSelect.options[runnerSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                showAlert('Vui lòng chọn một Runner từ danh sách trước khi kết nối Strava.');
                return;
            }

            const credentialId = selectedOption.value; // Supabase credential ID (UUID)
            const clientId = selectedOption.dataset.clientId;
            const redirectUri = selectedOption.dataset.redirectUri;
            const runnerName = selectedOption.textContent;

            if (!clientId || !redirectUri) {
                showAlert('Thiếu thông tin Client ID hoặc Redirect URI cho Runner đã chọn. Vui lòng kiểm tra lại thông tin đăng nhập.');
                return;
            }
            
            // Store selected runner's basic info for callback processing
            localStorage.setItem('strava_runner_credential_id_pending', credentialId);
            localStorage.setItem('strava_runner_name_pending', runnerName);
            localStorage.setItem('strava_client_id_pending', clientId);
            localStorage.setItem('strava_redirect_uri_pending', redirectUri);

            const scope = 'activity:read_all';
            // Pass credentialId and current client info in 'state' to the callback function via URL
            const state = encodeURIComponent(JSON.stringify({ 
                credentialId: credentialId,
                clientId: clientId,
                redirectUri: redirectUri
            }));
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&approval_prompt=auto&scope=${scope}&state=${state}`;
            
            window.location.href = authUrl;
        });

        /**
         * Handles the Strava OAuth callback, exchanging code for tokens via Edge Function.
         */
        async function handleStravaCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const stateParam = urlParams.get('state'); // Contains runnerCredentialId, clientId, redirectUri
            const errorParam = urlParams.get('error');

            if (errorParam) {
                showAlert(`Lỗi từ Strava: ${errorParam}. Vui lòng thử lại.`);
                console.error('Strava OAuth Error:', errorParam);
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (code && stateParam) {
                authStatus.textContent = 'Đang xử lý kết nối Strava...';
                let parsedState;
                let runnerCredentialId;
                try {
                    parsedState = JSON.parse(decodeURIComponent(stateParam));
                    runnerCredentialId = parsedState.credentialId;
                    if (!runnerCredentialId) {
                        throw new Error('Thiếu thông tin runnerCredentialId trong tham số "state".');
                    }
                } catch (e) {
                    console.error('Lỗi giải mã tham số "state" hoặc thiếu runnerCredentialId:', e);
                    showAlert('Lỗi khi xử lý kết nối Strava: Thông tin phiên không hợp lệ hoặc thiếu Runner ID.');
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }

                try {
                    // GỌI EDGE FUNCTION để trao đổi mã lấy token
                    console.log(`[Client] Calling strava-oauth-callback Edge Function for runnerCredentialId: ${runnerCredentialId}`);
                    const response = await fetch(STRAVA_OAUTH_CALLBACK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: code,
                            runnerCredentialId: runnerCredentialId
                        }),
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Lưu các token và athlete info từ phản hồi của Edge Function vào localStorage
                        localStorage.setItem('strava_access_token', result.access_token);
                        localStorage.setItem('strava_refresh_token', result.refresh_token);
                        localStorage.setItem('strava_expires_at', result.expires_at); // expires_at đã là mili giây từ EF
                        localStorage.setItem('strava_athlete_id', result.athlete_id);
                        localStorage.setItem('strava_runner_name', result.runner_name); 
                        localStorage.setItem('strava_runner_credential_id', result.runnerCredentialId); 
                        localStorage.setItem('strava_authenticated', 'true'); 

                        showAlert('Đăng nhập Strava thành công! Bạn có thể tải dữ liệu hoạt động ngay bây giờ.');
                        window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
                        checkAuthState(); // Update UI
                    } else {
                        console.error('[Client] Error from Edge Function:', result.error);
                        showAlert(`Lỗi đăng nhập Strava: ${result.error || 'Không xác định'}`);
                        clearStravaSession();
                        checkAuthState();
                        window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
                    }
                } catch (err) {
                    console.error('Lỗi khi gọi Edge Function strava-oauth-callback:', err);
                    showAlert(`Lỗi mạng hoặc máy chủ khi xử lý đăng nhập Strava: ${err.message}`);
                    clearStravaSession();
                    checkAuthState();
                    window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
                }
            } else {
                console.log('Không có mã ủy quyền hoặc tham số "state" trong URL. Không có hành động nào được thực hiện.');
            }
        }


        // --- Data Fetching & Management ---

        /**
         * Fetches activities from Strava API and saves them to Supabase.
         */
        fetchActivitiesBtn.addEventListener('click', async () => {
            if (!isAuthenticated || !currentRunnerCredentialId || !currentAthleteId) {
                showAlert('Vui lòng đăng nhập với Strava trước khi thực hiện chức năng này.');
                return;
            }

            const dataStatus = document.getElementById('data-status');
            dataStatus.textContent = 'Đang tải dữ liệu hoạt động từ Strava...';

            const activitiesLimit = parseInt(activitiesLimitInput.value, 10) || 60;
            // The user_id for the activities table will be the Strava Athlete ID
            const activitiesTableUserId = currentAthleteId; 
            
            console.log('Fetching activities:');
            console.log('  currentRunnerCredentialId (Supabase Credential ID to send):', currentRunnerCredentialId);
            console.log('  currentAthleteId (Strava Athlete ID - for local logging):', currentAthleteId); 

            try {
                const response = await fetch(FETCH_ACTIVITIES_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        runnerCredentialId: currentRunnerCredentialId, // Gửi ID của runner credential
                        limit: activitiesLimit 
                    }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    dataStatus.textContent = `Đã tải và lưu ${result.count} hoạt động thành công!`;
                    showAlert(`Đã tải và lưu ${result.count} hoạt động thành công!`);
                } else {
                    dataStatus.textContent = `Lỗi khi tải hoạt động: ${result.error || 'Không xác định'}`;
                    showAlert(`Lỗi khi tải hoạt động: ${result.error || 'Không xác định'}`);
                }
            } catch (error) {
                console.error('Lỗi khi tải hoạt động:', error);
                dataStatus.textContent = 'Lỗi mạng hoặc máy chủ khi tải hoạt động.';
                showAlert('Lỗi mạng hoặc máy chủ khi tải hoạt động.');
            }
        });

       /**
         * Loads recent activities from Supabase and displays them.
         */
        loadRecentActivitiesBtn.addEventListener('click', async () => {
            if (!isAuthenticated || !currentRunnerCredentialId || !currentAthleteId) {
                showAlert('Vui lòng đăng nhập với Strava trước khi thực hiện chức năng này.');
                return;
            }

            recentActivitiesStatus.textContent = 'Đang tải hoạt động gần đây...';
            recentActivitiesList.innerHTML = ''; // Clear previous list

            // SỬ DỤNG currentAthleteId (BIGINT) để truy vấn bảng activities
            const activitiesTableUserId = currentAthleteId; 
           
            console.log('Loading recent activities:');
            console.log('  Querying Supabase for activities.user_id (Strava Athlete ID):', activitiesTableUserId);

            const numActivitiesToDisplay = parseInt(numRecentActivitiesInput.value, 10) || 10;

            try {
                const { data, error } = await supabaseClientInstance
                    .from('activities')
                    .select('*')
                    .eq('user_id', activitiesTableUserId) // Filter by Strava Athlete ID
                    .order('start_date', { ascending: false })
                    .limit(numActivitiesToDisplay);

                if (error) throw error;
                
                console.log('Data returned from Supabase for recent activities:', data); // Log the raw data

                if (data && data.length > 0) {
                    const activitiesToDisplay = data; 
                    userActivities = activitiesToDisplay;

                    activitiesToDisplay.forEach(activity => {
                        const li = document.createElement('li');
                        li.className = 'border-b last:border-b-0 py-2';
                        li.innerHTML = `
                            <p class="font-semibold">${activity.name} (${activity.type})</p>
                            <p>Ngày: ${new Date(activity.start_date).toLocaleDateString('vi-VN')}</p>
                            <p>Quãng đường: ${(activity.distance / 1000).toFixed(2)} km</p>
                            <p>Thời gian: ${formatDuration(activity.moving_time)}</p>
                        `;
                        recentActivitiesList.appendChild(li);
                    });
                    recentActivitiesStatus.textContent = `Đã tải ${activitiesToDisplay.length} hoạt động gần đây.`;
                } else {
                    recentActivitiesList.innerHTML = '<li class="text-gray-500">Không tìm thấy hoạt động nào gần đây cho runner này.</li>';
                    recentActivitiesStatus.textContent = 'Không có hoạt động nào để hiển thị.';
                    userActivities = [];
                }
            } catch (error) {
                console.error('Lỗi khi tải hoạt động gần đây từ Supabase:', error);
                recentActivitiesStatus.textContent = `Lỗi khi tải hoạt động: ${error.message}`;
                showAlert(`Lỗi khi tải hoạt động gần đây: ${error.message}`);
            }
        });

        // Function to format duration (seconds to HH:MM:SS)
        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return [h, m, s].map(v => v < 10 ? "0" + v : v).filter((v, i) => v !== "00" || i > 0).join(":");
        }

        // --- Statistics and visualization of results ---
        viewStatsBtn.addEventListener('click', async () => {
            if (!isAuthenticated || !currentRunnerCredentialId || !currentAthleteId) {
                showAlert('Vui lòng đăng nhập với Strava trước khi thực hiện chức năng này.');
                return;
            }

            const chartStatus = document.getElementById('chart-status');
            chartStatus.textContent = 'Đang tải dữ liệu thống kê...';
            document.getElementById('bubble-chart-container').innerHTML = '<p class="text-gray-500 text-center">Đang tải dữ liệu thống kê...</p>';

            const activitiesTableUserId = currentAthleteId; // Use Strava Athlete ID for activities table
            
            console.log('Loading stats:');
            console.log('  Querying Supabase for activities.user_id (Strava Athlete ID):', activitiesTableUserId);

            try {
                const response = await fetch(GET_STATS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: activitiesTableUserId }), // Pass Strava Athlete ID
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    chartStatus.textContent = 'Đã tải dữ liệu thống kê thành công.';
                    weeklyStatsData = result.weeklyStats; // Store data globally
                    if (weeklyStatsData && weeklyStatsData.length > 0) {
                        renderBubbleChart(weeklyStatsData); // Draw chart
                    } else {
                        document.getElementById('bubble-chart-container').innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu chạy bộ để tạo biểu đồ thống kê.</p>';
                        chartStatus.textContent = 'Không có dữ liệu chạy bộ để tạo biểu đồ thống kê.';
                    }
                } else {
                    chartStatus.textContent = `Lỗi khi tải thống kê: ${result.error || 'Không xác định'}`;
                    showAlert(`Lỗi khi tải thống kê: ${result.error || 'Không xác định'}`);
                }
            } catch (error) {
                console.error('Lỗi khi tải thống kê:', error);
                chartStatus.textContent = 'Lỗi mạng hoặc máy chủ khi tải thống kê.';
                showAlert('Lỗi mạng hoặc máy chủ khi tải thống kê.');
            }
        });

        // Helper function to convert ISO week string (YYYY-WW) to a Date object
        function getDateFromISOWeek(yearWeek) {
            const [yearStr, weekStr] = yearWeek.split('-W');
            const year = parseInt(yearStr);
            const week = parseInt(weekStr);

            const jan1 = new Date(year, 0, 1);
            const dayOfWeekJan1 = jan1.getDay();
            const firstThursday = new Date(year, 0, 1 + (4 - dayOfWeekJan1 + 7) % 7);
            const date = new Date(firstThursday.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);
            return date;
        }

        // Function to draw the bubble chart
        function renderBubbleChart(data) {
            const monthlyDataMap = new Map();

            data.forEach(d => {
                const dateInWeek = getDateFromISOWeek(d.week);
                const monthKey = dateInWeek.getFullYear() + '-' + String(dateInWeek.getMonth() + 1).padStart(2, '0');

                if (!monthlyDataMap.has(monthKey)) {
                    monthlyDataMap.set(monthKey, { month: monthKey, weeks: [] });
                }
                monthlyDataMap.get(monthKey).weeks.push(d);
            });

            const monthlyData = Array.from(monthlyDataMap.values()).sort((a, b) => b.month.localeCompare(a.month));

            const container = document.getElementById('bubble-chart-container');
            container.innerHTML = ''; 

            if (!monthlyData || monthlyData.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Không có dữ liệu thống kê để hiển thị biểu đồ.</p>';
                return;
            }

            const width = container.clientWidth;
            const monthBandHeight = width < 768 ? 120 : 180;
            const topPaddingForChart = width < 768 ? 70 : 100;

            const totalSvgContentHeight = (monthlyData.length * monthBandHeight) + topPaddingForChart;
            const svgHeight = Math.max(container.clientHeight, totalSvgContentHeight);

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", svgHeight)
                .attr("viewBox", `0 0 ${width} ${svgHeight}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxDistance = d3.max(data, d => d.totalDistance);
            const minDistance = d3.min(data, d => d.totalDistance);

            const maxRadius = width < 768 ? 30 : 60;
            const minRadius = width < 768 ? 8 : 15;

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxDistance])
                .range([minRadius, maxRadius]);

            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxDistance, minDistance]);

            const bubbleHorizontalPadding = width < 768 ? 10 : 20;
            const bubbleVerticalOffset = monthBandHeight / 2;

            let currentYOffset = topPaddingForChart;

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            monthlyData.forEach((monthObj) => {
                const monthGroup = svg.append("g")
                    .attr("transform", `translate(0, ${currentYOffset})`);

                monthGroup.append("text")
                    .attr("x", 20)
                    .attr("y", 25)
                    .attr("font-size", width < 768 ? "1rem" : "1.2rem")
                    .attr("font-weight", "bold")
                    .attr("fill", "#555")
                    .text(`Tháng ${monthObj.month.substring(5)}/${monthObj.month.substring(0, 4)}`);

                monthObj.weeks.sort((a, b) => a.week.localeCompare(b.week));

                let currentX = 20;

                const positionedWeeks = monthObj.weeks.map(d => {
                    const r = radiusScale(d.totalDistance);
                    const cx = currentX + r;
                    currentX += (r * 2) + bubbleHorizontalPadding;
                    return { ...d, r, cx, cy: bubbleVerticalOffset + (width < 768 ? 20 : 30) };
                });

                monthGroup.selectAll(".bubble")
                    .data(positionedWeeks)
                    .enter().append("circle")
                    .attr("class", "bubble")
                    .attr("cx", d => d.cx)
                    .attr("cy", d => d.cy)
                    .attr("r", d => d.r)
                    .attr("fill", d => colorScale(d.totalDistance))
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2)
                    .on("mouseover", function(event, d) {
                        d3.select(this).attr("stroke", "orange").attr("stroke-width", 3);
                        tooltip.style("opacity", 1)
                            .html(`Tuần: ${d.week}<br>
                                   Quãng đường: ${(d.totalDistance / 1000).toFixed(2)} km<br>
                                   Thời gian: ${formatDuration(d.totalTime)}`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this).attr("stroke", "#fff").attr("stroke-width", 2);
                        tooltip.style("opacity", 0);
                    });

                monthGroup.selectAll(".bubble-text")
                    .data(positionedWeeks)
                    .enter().append("text")
                    .attr("class", "bubble-text")
                    .attr("x", d => d.cx)
                    .attr("y", d => d.cy)
                    .text(d => d.r > (width < 768 ? 15 : 25) ? d.week.split('-W')[1] : '')
                    .attr("dy", "0.35em")
                    .attr("fill", "white")
                    .attr("pointer-events", "none");

                currentYOffset += monthBandHeight;
            });
        }


        // Function to convert basic Markdown to HTML for LLM analysis
        function markdownToHtml(markdownText) {
            let htmlText = markdownText;
            htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            htmlText = htmlText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            htmlText = htmlText.replace(/\n/g, '<br>');
            return htmlText;
        }

        // --- LLM activity analysis feature ---
        analyzeActivitiesBtn.addEventListener('click', async () => {
            if (!isAuthenticated || !currentRunnerCredentialId || !currentAthleteId) {
                showAlert('Vui lòng đăng nhập với Strava trước khi thực hiện chức năng này.');
                return;
            }

            const llmAnalysisSection = document.getElementById('llm-analysis-section');
            const llmAnalysisContent = document.getElementById('llm-analysis-content');
            const llmAnalysisStatus = document.getElementById('llm-analysis-status');

            llmAnalysisSection.classList.remove('hidden');
            llmAnalysisContent.innerHTML = '<p class="text-gray-500">Đang phân tích hoạt động của bạn... <span class="loader"></span></p>';
            llmAnalysisStatus.textContent = '';

            const activitiesTableUserId = currentAthleteId; 

            console.log('Analyzing activities:');
            console.log('  activitiesTableUserId (Strava Athlete ID):', activitiesTableUserId);

            try {
                // Fetch recent activities from Supabase to send to LLM
                const { data: recentActivitiesFromDB, error: fetchError } = await supabaseClientInstance
                    .from('activities')
                    .select('*')
                    .eq('user_id', activitiesTableUserId)
                    .order('start_date', { ascending: false })
                    .limit(50); // Limit activities for LLM analysis to avoid large payloads

                if (fetchError) throw fetchError;

                if (!recentActivitiesFromDB || recentActivitiesFromDB.length === 0) {
                    llmAnalysisContent.innerHTML = '<p class="text-gray-500">Không có hoạt động nào trong cơ sở dữ liệu để phân tích. Vui lòng tải dữ liệu từ Strava trước.</p>';
                    return;
                }

                // Prepare activity data to send to LLM
                const activitiesForLLM = recentActivitiesFromDB.map(activity => ({
                    name: activity.name,
                    distance_km: (activity.distance / 1000).toFixed(2),
                    moving_time_seconds: activity.moving_time,
                    start_date: new Date(activity.start_date).toISOString().split('T')[0]
                }));

                // Prompt for the LLM
                const prompt = `Phân tích dữ liệu hoạt động chạy bộ sau đây và cung cấp cái nhìn sâu sắc, xu hướng, hoặc đề xuất cá nhân hóa.
                Dữ liệu hoạt động: ${JSON.stringify(activitiesForLLM)}`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                };

                llmAnalysisStatus.textContent = 'Đang gọi AI để phân tích...';

                const apiKey = ""; // Canvas will automatically provide the API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const analysisText = result.candidates[0].content.parts[0].text;
                    llmAnalysisContent.innerHTML = markdownToHtml(analysisText);
                    llmAnalysisStatus.textContent = 'Phân tích hoàn tất!';
                } else {
                    llmAnalysisContent.innerHTML = '<p class="text-red-500">Không thể nhận được phân tích từ AI.</p>';
                    llmAnalysisStatus.textContent = 'Lỗi phân tích AI.';
                }
            } catch (error) {
                console.error('Error during LLM analysis:', error);
                llmAnalysisContent.innerHTML = '<p class="text-red-500">Đã xảy ra lỗi trong quá trình phân tích AI.</p>';
                llmAnalysisStatus.textContent = `Lỗi: ${error.message}`;
            }
        });

        // When the page loads
        window.onload = async () => {
            if (typeof window.supabase === 'undefined') {
                showAlert('Lỗi: Thư viện Supabase không được tải. Vui lòng kiểm tra kết nối internet hoặc URL CDN.');
                console.error('Thư viện Supabase không được định nghĩa. Vui lòng kiểm tra thẻ script CDN Supabase.');
                return;
            }
            supabaseClientInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Set up event listeners for credential management
            addCredentialBtn.addEventListener('click', () => openCredentialModal());
            closeModalBtn.addEventListener('click', () => credentialModal.style.display = 'none');
            cancelModalBtn.addEventListener('click', () => credentialModal.style.display = 'none');
            credentialForm.addEventListener('submit', saveCredential);
            
            // Set up event listener for disconnect button
            disconnectStravaBtn.addEventListener('click', () => {
                clearStravaSession();
                checkAuthState();
                showAlert('Đã đăng xuất Strava.');
            });


            // Initial load of credentials and check auth state
            await displayCredentials(); // Must load credentials first to populate runnerSelect
            await handleStravaCallback(); // Process any OAuth callback that might be in the URL
            await checkAuthState(); // Update UI based on current auth state

            // Add resize event listener to redraw the chart
            window.addEventListener('resize', () => {
                if (weeklyStatsData && weeklyStatsData.length > 0) {
                    renderBubbleChart(weeklyStatsData);
                }
            });
        };
    </script>
</body>
</html>
