<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Thống kê Chạy bộ - BIDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define BIDV brand colors as CSS variables for easy use */
        :root {
            --bidv-green: #006B68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Custom Tailwind classes using CSS variables */
        .bg-bidv-green { background-color: var(--bidv-green); }
        .text-bidv-green { color: var(--bidv-green); }
        .border-bidv-green { border-color: var(--bidv-green); }
        .hover\:bg-bidv-green-darker:hover { background-color: #005A58; } /* Slightly darker green for hover */

        .bg-bidv-yellow { background-color: var(--bidv-yellow); }
        .text-bidv-yellow { color: var(--bidv-yellow); }
        .border-bidv-yellow { border-color: var(--bidv-yellow); }
        .hover\:bg-bidv-yellow-darker:hover { background-color: #E6B32C; } /* Slightly darker yellow for hover */

        .focus\:ring-bidv-green:focus { --tw-ring-color: var(--bidv-green); }
        .focus\:ring-bidv-yellow:focus { --tw-ring-color: var(--bidv-yellow); }

        /* Loading spinner styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #006B68;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl w-full bg-white shadow-lg rounded-xl p-6 sm:p-8 space-y-8">
        <header class="text-center flex flex-col items-center">
            <img src="https://placehold.co/150x50/006B68/FFFFFF?text=BIDV+Logo" alt="BIDV Logo Placeholder" class="h-16 mb-4 rounded-md">
            <h1 class="text-3xl sm:text-4xl font-bold text-bidv-green mb-2">Thống kê Thành tích Câu lạc bộ Chạy bộ BIDV</h1>
            <p class="text-lg text-gray-600">Phân loại và theo dõi thành tích chạy bộ của các thành viên</p>
        </header>

        <section class="bg-bidv-green bg-opacity-10 p-6 rounded-lg border border-bidv-green border-opacity-30">
            <h2 class="text-2xl font-semibold text-bidv-green mb-4">Kết nối Strava</h2>
            <p class="text-gray-700 mb-4">
                Để lấy dữ liệu thành tích của câu lạc bộ, bạn cần kết nối tài khoản Strava.
                <br><strong class="text-red-600">CẢNH BÁO: Đây là phiên bản học tập cục bộ không bảo mật. Không triển khai công khai!</strong>
            </p>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="strava-club-id-input" placeholder="Nhập ID Câu lạc bộ Strava" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-bidv-green focus:border-bidv-green transition duration-150 ease-in-out">
            </div>
            <button id="connect-strava-btn" class="w-full bg-bidv-green hover:bg-bidv-green-darker text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-bidv-green focus:ring-opacity-50">
                Tải Dữ liệu Strava
            </button>
            <div id="strava-status" class="mt-2 text-sm text-gray-600 text-center"></div>
        </section>

        <section class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800">Cài đặt Thống kê</h2>

            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label for="week-select" class="text-gray-700 text-lg font-medium">Chọn tuần:</label>
                <select id="week-select" class="flex-grow sm:max-w-xs p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-bidv-green focus:border-bidv-green transition duration-150 ease-in-out">
                    <option value="week-current">Tuần hiện tại (26/05 - 01/06)</option>
                    <option value="week-1">Tuần trước (19/05 - 25/05)</option>
                    <option value="week-2">2 tuần trước (12/05 - 18/05)</option>
                </select>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Tiêu chí Phân loại theo KM/tuần</h3>
                <div class="space-y-4">
                    <div class="flex items-center space-x-3">
                        <input type="radio" id="classify25km" name="classificationType" value="25" class="form-radio h-4 w-4 text-bidv-green focus:ring-bidv-green" checked>
                        <label for="classify25km" class="text-gray-700">Phân loại theo 25 KM/tuần</label>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input type="radio" id="classifyCustomKm" name="classificationType" value="custom" class="form-radio h-4 w-4 text-bidv-green focus:ring-bidv-green">
                        <label for="classifyCustomKm" class="text-gray-700">Phân loại theo số KM/tuần tùy ý:</label>
                        <input type="number" id="customKmInput" class="ml-2 px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-yellow focus:border-bidv-yellow sm:text-sm w-24" placeholder="KM" disabled>
                    </div>
                </div>
                <div class="mt-6">
                    <label for="penaltyPerKm" class="block text-sm font-medium text-gray-700 mb-1">Số tiền phạt/KM (VNĐ):</label>
                    <input type="number" id="penaltyPerKm" value="30000" class="mt-1 block w-full sm:w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-yellow focus:border-bidv-yellow sm:text-sm">
                </div>

                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Lọc theo loại hình hoạt động</h3>
                    <div id="activity-type-filters" class="flex flex-wrap gap-4">
                        </div>
                </div>

                <button id="classifyBtn" class="mt-6 w-full bg-bidv-yellow text-bidv-green font-semibold py-2 px-4 rounded-md hover:bg-bidv-yellow-darker focus:outline-none focus:ring-2 focus:ring-bidv-yellow focus:ring-offset-2 transition duration-150 ease-in-out shadow-md">
                    Phân loại Thành tích
                </button>
            </div>
        </section>

        <section class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800">Thống kê Thành tích Câu lạc bộ</h2>

            <div class="bg-white p-6 rounded-lg shadow-md border border-bidv-green border-opacity-30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-bidv-green">Vận động viên Đạt mục tiêu <span id="goal-met-threshold"></span></h3>
                    <button id="export-goal-met-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xuất Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="goal-met-table">
                        <thead class="bg-bidv-green text-white">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    Tên Vận động viên
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Tổng KM Tuần
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Số buổi
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    Hành động
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="goal-met-table-body">
                            <tr>
                                <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    Chưa có vận động viên nào đạt mục tiêu.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Vận động viên Chưa đạt mục tiêu <span id="goal-not-met-threshold"></span></h3>
                    <button id="export-goal-not-met-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xuất Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="goal-not-met-table">
                        <thead class="bg-gray-200 text-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    Tên Vận động viên
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Tổng KM Tuần
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Số buổi
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Số KM còn thiếu
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Số tiền phạt
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    Hành động
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="goal-not-met-table-body">
                            <tr>
                                <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    Tất cả vận động viên đều đã đạt mục tiêu.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-red-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-red-600">Các hoạt động không hợp lệ (Pace <= 4 hoặc >= 14 phút/KM cho Chạy bộ/Đi bộ)</h3>
                    <button id="export-invalid-activities-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xuất Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="invalid-activities-table">
                        <thead class="bg-red-100 text-red-800">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    Tên Vận động viên
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Ngày
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Loại hình
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Quãng đường (KM)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Thời gian (phút)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Pace (phút/KM)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    Lý do
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="invalid-activities-table-body">
                            <tr>
                                <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    Không có hoạt động không hợp lệ nào.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div id="llm-analysis-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 sm:p-8 space-y-6 relative">
                <h2 class="text-3xl font-bold text-bidv-green text-center mb-4">Phân tích Thành tích AI ✨</h2>
                <button id="close-llm-analysis-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition duration-150 ease-in-out">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <div id="llm-analysis-content" class="space-y-4 max-h-96 overflow-y-auto pr-2 text-gray-700">
                    <div class="flex flex-col justify-center items-center h-full">
                        <div class="spinner"></div>
                        <p class="ml-3 text-lg font-medium">Đang tạo phân tích...</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-8">
            &copy; 2025 Trương Hồng Quân - Câu lạc bộ Chạy bộ BIDV. Tất cả quyền được bảo lưu.
        </footer>
    </div>

    <script type="module">
        // Import configuration from config.js (Removed for security, now using Supabase Edge Function)
        // import { STRAVA_CLIENT_ID, STRAVA_CLUB_ID, STRAVA_ACCESS_TOKEN } from './config.js';

        // ** Thay thế bằng URL Edge Function của bạn sau khi triển khai lên Supabase **
        const SUPABASE_EDGE_FUNCTION_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/rapid-api'; 
        // Ví dụ: const SUPABASE_EDGE_FUNCTION_URL = 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/strava-proxy';


        let currentUserId = null; // No longer used for Firebase auth, but kept for potential future expansion

        // Firebase authentication (Removed as it's not strictly necessary for this app's core functionality)
        async function authenticateFirebase() {
            // This function is now a no-op, but retained to avoid breaking calls in DOMContentLoaded
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        const LOCAL_STORAGE_KEY = 'bidvRunningClubData';

        function saveRunsToLocalStorage(runs) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(runs));
                console.log("Data saved to localStorage.");
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                displayMessageModal('Lỗi lưu trữ', 'Không thể lưu dữ liệu vào bộ nhớ cục bộ.');
            }
        }

        function loadRunsFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (data) {
                    console.log("Data loaded from localStorage.");
                    return JSON.parse(data);
                }
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                displayMessageModal('Lỗi tải dữ liệu', 'Không thể tải dữ liệu từ bộ nhớ cục bộ. Dữ liệu mẫu sẽ được sử dụng.');
            }
            // If no data or error, return default example data
            const defaultData = [
                { runnerName: 'Nguyễn Văn A', runs: [
                    { date: '2025-05-20', distance: 10.5, time: 50, type: 'Chạy bộ' }, // Pace: 4.76
                    { date: '2025-05-22', distance: 8.0, time: 40, type: 'Chạy bộ' }, // Pace: 5.0
                    { date: '2025-05-24', distance: 7.0, time: 35, type: 'Chạy bộ' }  // Pace: 5.0
                ]},
                { runnerName: 'Trần Thị B', runs: [
                    { date: '2025-05-21', distance: 12.0, time: 60, type: 'Chạy bộ' }, // Pace: 5.0
                    { date: '2025-05-23', distance: 10.0, time: 50, type: 'Chạy bộ' }, // Pace: 5.0
                    { date: '2025-05-25', distance: 5.0, time: 25, type: 'Đi bộ' }  // Pace: 5.0
                ]},
                { runnerName: 'Lê Văn C', runs: [
                    { date: '2025-05-20', distance: 15.0, time: 70, type: 'Chạy bộ' }, // Pace: 4.67
                    { date: '2025-05-22', distance: 10.0, time: 45, type: 'Chạy bộ' }, // Pace: 4.5
                    { date: '2025-05-24', distance: 12.0, time: 55, type: 'Đạp xe' }, // Pace: 4.58 (not subject to pace rule)
                    { date: '2025-05-26', distance: 8.0, time: 40, type: 'Chạy bộ' }  // Pace: 5.0
                ]},
                { runnerName: 'Phạm Thị D', runs: [
                    { date: '2025-05-21', distance: 6.0, time: 30, type: 'Đi bộ' }, // Pace: 5.0
                    { date: '2025-05-23', distance: 7.5, time: 38, type: 'Đi bộ' }, // Pace: 5.07
                    { date: '2025-05-24', distance: 1.0, time: 15, type: 'Đi bộ' }  // Pace: 15.0 (Invalid)
                ]},
                { runnerName: 'Vũ Minh E', runs: [
                    { date: '2025-05-20', distance: 2.0, time: 15, type: 'Chạy bộ' }, // Pace: 7.5
                    { date: '2025-05-25', distance: 3.0, time: 20, type: 'Đi bộ' }, // Pace: 6.67
                    { date: '2025-05-26', distance: 5.0, time: 10, type: 'Bơi lội' }  // Pace: 2.0 (not subject to pace rule)
                ]},
                { runnerName: 'Đặng Thị F', runs: [
                    { date: '2025-05-27', distance: 20.0, time: 40, type: 'Đạp xe' }, // Pace: 2.0 (not subject to pace rule)
                    { date: '2025-05-28', distance: 1.0, time: 20, type: 'Đi bộ' } // Pace: 20.0 (Invalid)
                ]},
                { runnerName: 'Nguyễn Thanh G', runs: [
                    { date: '2025-05-20', distance: 1.0, time: 5, type: 'Bơi lội' },
                    { date: '2025-05-22', distance: 10.0, time: 25, type: 'Đạp xe' },
                    { date: '2025-05-24', distance: 0.5, time: 30, type: 'Yoga' }
                ]},
                { runnerName: 'Hoàng Văn H', runs: [
                    { date: '2025-05-21', distance: 8.0, time: 40, type: 'Chạy bộ' },
                    { date: '2025-05-23', distance: 3.0, time: 45, type: 'Đi bộ' }, // Pace: 15.0 (Invalid)
                    { date: '2025-05-25', distance: 15.0, time: 30, type: 'Đạp xe' }
                ]},
                { runnerName: 'Võ Trọng I', runs: [
                    { date: '2025-05-28', distance: 5.0, time: 20, type: 'Chạy bộ' },
                    { date: '2025-05-29', distance: 2.0, time: 10, type: 'Đi bộ' },
                    { date: '2025-05-30', distance: 1.0, time: 60, type: 'Leo núi' } // New activity type
                ]}
            ];
            // Save default data to localStorage if it's being used for the first time
            saveRunsToLocalStorage(defaultData);
            return defaultData;
        }

        // Mapping for activity types to emojis
        const activityTypeEmojis = {
            'Chạy bộ': '🏃‍♂️',
            'Đi bộ': '🚶‍♀️',
            'Đạp xe': '🚴‍♂️',
            'Bơi lội': '🏊‍♀️',
            'Yoga': '🧘‍♀️',
            'Leo núi': '🧗‍♂️',
            'Khác': '❓'
        };

        // Mapping for Strava activity types to internal application types (Vietnamese)
        const STRAVA_TYPE_TO_APP_TYPE = {
            'Run': 'Chạy bộ',
            'Walk': 'Đi bộ',
            'Ride': 'Đạp xe',
            'Swim': 'Bơi lội',
            'Hike': 'Leo núi',
            'Yoga': 'Yoga',
            // Thêm các loại hình Strava khác nếu cần
            'VirtualRun': 'Chạy bộ', // Ví dụ: Strava có thể có 'VirtualRun'
            'Canoeing': 'Khác',
            'Kayaking': 'Khác',
            'Rowing': 'Khác',
            'NordicSki': 'Khác',
            'AlpineSki': 'Khác',
            'BackcountrySki': 'Khác',
            'Snowboard': 'Khác',
            'Snowshoe': 'Khác',
            'IceSkate': 'Khác',
            'RollerSki': 'Khác',
            'InlineSkate': 'Khác',
            'Crossfit': 'Khác',
            'Elliptical': 'Khác',
            'StairStepper': 'Khác',
            'WeightTraining': 'Khác',
            'Workout': 'Khác',
            'Wheelchair': 'Khác',
            'Handcycle': 'Khác',
            'EBikeRide': 'Đạp xe',
            'Velomobile': 'Đạp xe',
            'Golf': 'Khác',
            'RockClimbing': 'Leo núi',
            'StandUpPaddling': 'Khác',
            'Surfing': 'Khác',
            'Windsurf': 'Khác',
            'Kitesurf': 'Khác',
            'Badminton': 'Khác',
            'Squash': 'Khác',
            'TableTennis': 'Khác',
            'Tennis': 'Khác',
            'Racquetball': 'Khác',
            'Pickleball': 'Khác',
            'WaterSport': 'Khác',
            'IceSkate': 'Khác',
            'RollerSki': 'Khác',
            'InlineSkate': 'Khác',
            'Crossfit': 'Khác',
            'Elliptical': 'Khác',
            'StairStepper': 'Khác',
            'WeightTraining': 'Khác',
            'Workout': 'Khác',
            'Wheelchair': 'Khác',
            'Handcycle': 'Khác',
            'EBikeRide': 'Đạp xe',
            'Velomobile': 'Đạp xe',
            'Golf': 'Khác',
            'RockClimbing': 'Leo núi',
            'StandUpPaddling': 'Khác',
            'Surfing': 'Khác',
            'Windsurf': 'Khác',
            'Kitesurf': 'Khác',
            'Badminton': 'Khác',
            'Squash': 'Khác',
            'TableTennis': 'Khác',
            'Tennis': 'Khác',
            'Racquetball': 'Khác',
            'Pickleball': 'Khác',
            'WaterSport': 'Khác',
            'Kayaking': 'Khác',
            'Canoeing': 'Khác',
            'Rowing': 'Khác',
            'CrossCountrySkiing': 'Khác',
            'BackcountrySkiing': 'Khác',
            'AlpineSkiing': 'Khác',
            'Snowboarding': 'Khác',
            'Snowshoeing': 'Khác',
            'IceSkating': 'Khác',
            'RollerSkiing': 'Khác',
            'InlineSkating': 'Khác',
            'NordicSkiing': 'Khác',
            'Workout': 'Khác',
            'WeightTraining': 'Khác',
            'Elliptical': 'Khác',
            'StairStepper': 'Khác',
            'Handcycle': 'Khác',
            'Wheelchair': 'Khác',
            'VirtualRide': 'Đạp xe',
            'VirtualRun': 'Chạy bộ',
            'Swim': 'Bơi lội',
            'Run': 'Chạy bộ',
            'Ride': 'Đạp xe',
            'Walk': 'Đi bộ',
            'Hike': 'Leo núi',
            'Alpinism': 'Leo núi',
            'BackcountrySki': 'Khác',
            'Canoeing': 'Khác',
            'Crossfit': 'Khác',
            'EBikeRide': 'Đạp xe',
            'Elliptical': 'Khác',
            'Golf': 'Khác',
            'Handcycle': 'Khác',
            'IceSkate': 'Khác',
            'InlineSkate': 'Khác',
            'Kayaking': 'Khác',
            'Kitesurf': 'Khác',
            'MountainBikeRide': 'Đạp xe',
            'NordicSki': 'Khác',
            'Pickleball': 'Khác',
            'Racquetball': 'Khác',
            'RockClimbing': 'Leo núi',
            'RollerSki': 'Khác',
            'Rowing': 'Khác',
            'Ski': 'Khác',
            'Snowboard': 'Khác',
            'Snowshoe': 'Khác',
            'Soccer': 'Khác',
            'Squash': 'Khác',
            'StairStepper': 'Khác',
            'StandUpPaddling': 'Khác',
            'Surfing': 'Khác',
            'Swim': 'Bơi lội',
            'TableTennis': 'Khác',
            'Tennis': 'Khác',
            'Velomobile': 'Đạp xe',
            'VirtualRide': 'Đạp xe',
            'VirtualRun': 'Chạy bộ',
            'WaterSport': 'Khác',
            'WeightTraining': 'Khác',
            'Wheelchair': 'Khác',
            'Windsurf': 'Khác',
            'Workout': 'Khác',
            'Yoga': 'Yoga',
            // Thêm các loại hình Strava khác nếu cần
        };


        // Function to generate activity type checkboxes dynamically
        function generateActivityTypeFilters(allClubData) {
            const activityTypeFilterDiv = document.getElementById('activity-type-filters');
            activityTypeFilterDiv.innerHTML = ''; // Clear existing filters

            const uniqueActivityTypes = new Set();
            allClubData.forEach(member => {
                member.runs.forEach(run => {
                    uniqueActivityTypes.add(run.type);
                });
            });

            // Ensure common types are always available, even if not in current data
            // These common types are in Vietnamese, matching the mapped types
            const commonTypes = ['Chạy bộ', 'Đi bộ', 'Đạp xe', 'Bơi lội', 'Yoga', 'Leo núi', 'Khác'];
            commonTypes.forEach(type => uniqueActivityTypes.add(type));

            const sortedTypes = Array.from(uniqueActivityTypes).sort();

            sortedTypes.forEach(type => {
                const label = document.createElement('label');
                label.className = 'flex items-center';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'activityType';
                checkbox.value = type;
                checkbox.className = 'form-checkbox h-5 w-5 text-bidv-green rounded';

                // Default check for 'Chạy bộ' and 'Đi bộ'
                if (type === 'Chạy bộ' || type === 'Đi bộ') {
                    checkbox.checked = true;
                }

                const span = document.createElement('span');
                span.className = 'ml-2 text-gray-700';
                span.textContent = `${activityTypeEmojis[type] || ''} ${type}`;

                label.appendChild(checkbox);
                label.appendChild(span);
                activityTypeFilterDiv.appendChild(label);

                // Attach event listener immediately
                checkbox.addEventListener('change', () => {
                    loadAndClassifyData();
                });
            });
        }


        // Function to process and display runs based on classification
        function loadAndClassifyData() {
            const classificationType = document.querySelector('input[name="classificationType"]:checked').value;
            let threshold = 25; // Default to 25 KM

            // Enable/disable custom KM input based on radio button selection
            const customKmInput = document.getElementById('customKmInput');
            if (classificationType === 'custom') {
                customKmInput.disabled = false; // Enable input
                const customValue = parseFloat(customKmInput.value);
                // If custom is selected but value is invalid, use default 25 for calculation
                // The error message will be shown when classifyBtn is clicked, not here.
                if (!isNaN(customValue) && customValue > 0) {
                    threshold = customValue;
                } else {
                    threshold = 25; // Use a fallback threshold for display/initial calculation
                }
            } else {
                customKmInput.disabled = true; // Disable input
            }


            const penaltyPerKmInput = document.getElementById('penaltyPerKm');
            let penaltyPerKm = parseFloat(penaltyPerKmInput.value);
            if (isNaN(penaltyPerKm) || penaltyPerKm < 0) {
                displayMessageModal('Lỗi nhập liệu', 'Vui lòng nhập một giá trị tiền phạt hợp lệ (số không âm).');
                penaltyPerKm = 30000;
                penaltyPerKmInput.value = 30000;
            }

            // Get selected activity types
            let selectedActivityTypes = Array.from(document.querySelectorAll('input[name="activityType"]:checked')).map(cb => cb.value);
            if (selectedActivityTypes.length === 0) {
                // This block handles the case where user unchecks all boxes
                displayMessageModal('Lỗi lọc hoạt động', 'Vui lòng chọn ít nhất một loại hình hoạt động để thống kê. Mặc định sẽ sử dụng "Chạy bộ" và "Đi bộ" cho việc phân loại.');
                // For classification logic, use default types if none are selected by the user
                selectedActivityTypes = ['Chạy bộ', 'Đi bộ'];
                // DO NOT attempt to set .checked = true here, as it causes the error.
                // The UI state should be managed by user interaction or initial generation.
            }


            document.getElementById('goal-met-threshold').textContent = `(Mục tiêu: ${threshold} KM)`;
            document.getElementById('goal-not-met-threshold').textContent = `(Mục tiêu: ${threshold} KM)`;

            const allClubData = loadRunsFromLocalStorage(); // Load data from localStorage

            const goalMetMembers = [];
            const goalNotMetMembers = [];
            const invalidActivities = []; // New array for invalid activities (all types, but pace rule only for running/walking)

            // Process each member's runs
            allClubData.forEach(member => {
                let memberValidRunsForSelectedTypes = []; // Runs that are valid pace-wise AND of selected types
                let totalDistanceForSelectedTypes = 0;
                let totalSessionsForSelectedTypes = 0;

                member.runs.forEach(run => {
                    const pace = run.distance > 0 ? (run.time / run.distance) : 0; // Calculate pace, handle distance=0

                    // Check for invalid pace ONLY for 'Chạy bộ' and 'Đi bộ'
                    const isRunningOrWalking = (run.type === 'Chạy bộ' || run.type === 'Đi bộ');
                    const isPaceInvalid = (pace <= 4 || pace >= 14);

                    if (isRunningOrWalking && isPaceInvalid) {
                        invalidActivities.push({
                            runnerName: member.runnerName,
                            date: run.date,
                            type: run.type, // Include type in invalid activities
                            distance: run.distance,
                            time: run.time,
                            pace: pace.toFixed(2),
                            reason: pace <= 4 ? 'Pace quá nhanh (<4 phút/KM)' : 'Pace quá chậm (>14 phút/KM)'
                        });
                    } else {
                        // Activity is valid pace-wise (or not subject to pace rule)
                        // Now check if it's one of the selected activity types for main tables
                        if (selectedActivityTypes.includes(run.type)) {
                            memberValidRunsForSelectedTypes.push(run);
                            totalDistanceForSelectedTypes += run.distance;
                            totalSessionsForSelectedTypes++;
                        }
                    }
                });

                // Only add to goal tables if there are valid runs for the member for selected types
                // A member is included if they have any valid runs for the selected types, even if total distance is 0
                if (memberValidRunsForSelectedTypes.length > 0) {
                    const memberStats = {
                        runnerName: member.runnerName,
                        totalDistance: totalDistanceForSelectedTypes.toFixed(1),
                        totalSessions: totalSessionsForSelectedTypes,
                        rawRuns: memberValidRunsForSelectedTypes // Store only valid runs (pace-wise & type-wise) for LLM analysis
                    };

                    if (totalDistanceForSelectedTypes >= threshold) {
                        goalMetMembers.push(memberStats);
                    } else {
                        const kmDeficit = threshold - totalDistanceForSelectedTypes;
                        memberStats.kmDeficit = (kmDeficit > 0 ? kmDeficit : 0).toFixed(1);
                        memberStats.penaltyAmount = (kmDeficit > 0 ? kmDeficit : 0) * penaltyPerKm;
                        goalNotMetMembers.push(memberStats);
                    }
                }
            });

            renderTable(document.getElementById('goal-met-table-body'), goalMetMembers, 'Chưa có vận động viên nào đạt mục tiêu.', threshold, false);
            renderTable(document.getElementById('goal-not-met-table-body'), goalNotMetMembers, 'Tất cả vận động viên đều đã đạt mục tiêu.', threshold, true);
            renderInvalidActivitiesTable(document.getElementById('invalid-activities-table-body'), invalidActivities, 'Không có hoạt động không hợp lệ nào.');
        }

        // Helper function to render a table (for goal-met and goal-not-met)
        function renderTable(tableBodyElement, data, emptyMessage, threshold, includePenaltyAndDeficitColumns) {
            tableBodyElement.innerHTML = ''; // Clear previous rows

            const tableElement = tableBodyElement.closest('table');
            const tableHeadRow = tableElement.querySelector('thead tr');

            if (!tableHeadRow) {
                console.error("Error: Thead row not found for table.", tableElement);
                return;
            }

            // Define base headers for the goal tables
            const baseHeaders = [
                { text: 'Tên Vận động viên', class: 'rounded-tl-lg' },
                { text: 'Tổng KM Tuần' },
                { text: 'Số buổi' }
            ];
            const actionHeader = { text: 'Hành động', class: 'rounded-tr-lg' }; // Always present, always last

            // Clear existing headers to rebuild them correctly
            tableHeadRow.innerHTML = '';

            // Add base headers
            baseHeaders.forEach(header => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = `px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${header.class || ''}`;
                th.textContent = header.text;
                tableHeadRow.appendChild(th);
            });

            // Add dynamic headers if required
            if (includePenaltyAndDeficitColumns) {
                const kmDeficitHeader = document.createElement('th');
                kmDeficitHeader.scope = 'col';
                kmDeficitHeader.className = 'px-6 py-3 text-left text-xs font-medium uppercase tracking-wider';
                kmDeficitHeader.textContent = 'Số KM còn thiếu';
                tableHeadRow.appendChild(kmDeficitHeader);

                const penaltyHeader = document.createElement('th');
                penaltyHeader.scope = 'col';
                penaltyHeader.className = 'px-6 py-3 text-left text-xs font-medium uppercase tracking-wider';
                penaltyHeader.textContent = 'Số tiền phạt';
                tableHeadRow.appendChild(penaltyHeader);
            }

            // Add action header (always last)
            const thAction = document.createElement('th');
            thAction.scope = 'col';
            thAction.className = `px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${actionHeader.class || ''}`;
            thAction.textContent = actionHeader.text;
            tableHeadRow.appendChild(thAction);


            if (data.length === 0) {
                const noDataRow = document.createElement('tr');
                // Calculate colspan based on whether dynamic columns are included
                const colspan = includePenaltyAndDeficitColumns ? 6 : 4;
                noDataRow.innerHTML = `
                    <td colspan="${colspan}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        ${emptyMessage}
                    </td>
                `;
                tableBodyElement.appendChild(noDataRow);
            } else {
                data.forEach(member => {
                    const row = document.createElement('tr');
                    let dynamicCells = '';
                    if (includePenaltyAndDeficitColumns) {
                        dynamicCells = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.kmDeficit} KM</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${member.penaltyAmount.toLocaleString('vi-VN')} VNĐ</td>
                        `;
                    }
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.runnerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.totalDistance} KM</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.totalSessions}</td>
                        ${dynamicCells}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <button class="analyze-btn bg-bidv-green text-white px-3 py-1 rounded-md text-xs hover:bg-bidv-green-darker transition duration-150 ease-in-out"
                                data-runner-name="${member.runnerName}"
                                data-total-km="${member.totalDistance}"
                                data-total-sessions="${member.totalSessions}"
                                data-threshold="${threshold}"
                                data-raw-runs='${JSON.stringify(member.rawRuns)}'
                            >
                                ✨ Phân tích
                            </button>
                        </td>
                    `;
                    tableBodyElement.appendChild(row);
                });
            }
            attachAnalyzeButtonListeners();
        }

        // Helper function to render the Invalid Activities table
        function renderInvalidActivitiesTable(tableBodyElement, data, emptyMessage) {
            tableBodyElement.innerHTML = ''; // Clear previous rows

            // Update the header for the invalid activities table to include "Loại hình"
            const tableElement = tableBodyElement.closest('table');
            const tableHeadRow = tableElement.querySelector('thead tr');
            // Rebuild headers for invalid activities table for consistency
            tableHeadRow.innerHTML = `
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                    Tên Vận động viên
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Ngày
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Loại hình
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Quãng đường (KM)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Thời gian (phút)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Pace (phút/KM)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                    Lý do
                </th>
            `;


            if (data.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        ${emptyMessage}
                    </td>
                `;
                tableBodyElement.appendChild(noDataRow);
            } else {
                data.forEach(activity => {
                    const row = document.createElement('tr');
                    const emoji = activityTypeEmojis[activity.type] || ''; // Get emoji for type
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${activity.runnerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${emoji} ${activity.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.distance} KM</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.time} phút</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${activity.pace}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.reason}</td>
                    `;
                    tableBodyElement.appendChild(row);
                });
            }
        }

        // Function to attach event listeners to "Analyze" buttons
        function attachAnalyzeButtonListeners() {
            document.querySelectorAll('.analyze-btn').forEach(button => {
                button.removeEventListener('click', handleAnalyzeClick); // Prevent duplicate listeners
                button.addEventListener('click', handleAnalyzeClick);
            });
        }

        // Handle click on "Analyze" button
        async function handleAnalyzeClick(event) {
            const runnerName = event.target.dataset.runnerName;
            const totalKm = event.target.dataset.totalKm;
            const totalSessions = event.target.dataset.totalSessions;
            const threshold = event.target.dataset.threshold;
            const rawRuns = JSON.parse(event.target.dataset.rawRuns);

            const llmAnalysisModal = document.getElementById('llm-analysis-modal');
            const llmAnalysisContent = document.getElementById('llm-analysis-content');

            // Show modal and loading spinner
            llmAnalysisModal.classList.remove('hidden');
            llmAnalysisContent.innerHTML = `
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="spinner"></div>
                    <p class="ml-3 text-lg font-medium">Đang tạo phân tích...</p>
                </div>
            `;

            // Construct prompt for LLM
            let prompt = `Bạn là một huấn luyện viên chạy bộ AI. Hãy phân tích thành tích chạy bộ hàng tuần của vận động viên ${runnerName} và đưa ra lời khuyên cá nhân hóa.

            Thông tin thành tích tuần:
            - Tổng quãng đường: ${totalKm} KM
            - Tổng số buổi chạy: ${totalSessions} buổi
            - Mục tiêu KM tuần: ${threshold} KM

            Chi tiết các buổi chạy hợp lệ (đã lọc pace không hợp lệ):
            `;
            if (rawRuns && rawRuns.length > 0) {
                rawRuns.forEach(run => {
                    const emoji = activityTypeEmojis[run.type] || '';
                    prompt += `- Ngày ${run.date}: ${run.distance} KM trong ${run.time} phút (${emoji} ${run.type}).\n`;
                });
            } else {
                prompt += `- Không có chi tiết buổi chạy cụ thể hợp lệ trong các loại hình đã chọn.\n`;
            }

            if (parseFloat(totalKm) >= parseFloat(threshold)) {
                prompt += `\nVận động viên này đã đạt hoặc vượt mục tiêu ${threshold} KM/tuần. Hãy đưa ra lời khen ngợi và gợi ý để duy trì hoặc nâng cao thành tích một cách bền vững.`;
            } else {
                prompt += `\nVận động viên này chưa đạt mục tiêu ${threshold} KM/tuần. Hãy đưa ra lời động viên, phân tích nguyên nhân tiềm ẩn (nếu có thể suy luận từ dữ liệu), và gợi ý các bước cụ thể để cải thiện thành tích trong tuần tới.`;
            }

            prompt += `\nHãy viết câu trả lời bằng tiếng Việt, thân thiện, dễ hiểu, và tập trung vào việc khuyến khích, động viên.`;

            // Call Gemini API
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y"; // Leave this as-is; Canvas will provide the key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    llmAnalysisContent.innerHTML = `<p class="whitespace-pre-wrap">${text}</p>`; // Use pre-wrap to preserve formatting
                } else {
                    llmAnalysisContent.innerHTML = '<p class="text-red-500">Không thể tạo phân tích. Cấu trúc phản hồi không mong muốn.</p>';
                    console.error("Unexpected LLM response structure:", result);
                }
            } catch (error) {
                llmAnalysisContent.innerHTML = `<p class="text-red-500">Đã xảy ra lỗi khi tạo phân tích: ${error.message}.</p>`;
                console.error("Error calling Gemini API:", error);
            }
        }

        // Close LLM Analysis Modal
        document.getElementById('close-llm-analysis-btn').addEventListener('click', () => {
            document.getElementById('llm-analysis-modal').classList.add('hidden');
        });

        // Hide modal if clicked outside
        document.getElementById('llm-analysis-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('llm-analysis-modal')) {
                document.getElementById('llm-analysis-modal').remove();
            }
        });

        // Custom message box function (instead of alert)
        function displayMessageModal(title, message) {
            const modalHtml = `
                <div id="custom-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[9999]">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4 relative">
                        <h3 class="text-xl font-bold text-bidv-green mb-2">${title}</h3>
                        <p class="text-gray-700">${message}</p>
                        <button id="close-custom-message-btn" class="w-full bg-bidv-green text-white py-2 px-4 rounded-md hover:bg-bidv-green-darker focus:outline-none focus:ring-2 focus:ring-bidv-green focus:ring-offset-2 transition duration-150 ease-in-out">
                            Đóng
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('close-custom-message-btn').addEventListener('click', () => {
                document.getElementById('custom-message-modal').remove();
            });

            document.getElementById('custom-message-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('custom-message-modal')) {
                    document.getElementById('custom-message-modal').remove();
                }
            });
        }

        // --- EXPORT TO CSV FUNCTIONALITY ---
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                console.error(`Table with ID "${tableId}" not found.`);
                displayMessageModal('Lỗi xuất file', `Không tìm thấy bảng để xuất dữ liệu.`);
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll('tr');

            // Get headers
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                let headers = Array.from(headerRow.querySelectorAll('th'))
                               .map(th => `"${th.textContent.trim().replace(/"/g, '""')}"`);
                csv.push(headers.join(','));
            }

            // Get data rows
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                // Skip empty message row
                if (row.querySelector('td[colspan]')) {
                    return;
                }
                let rowData = Array.from(row.querySelectorAll('td'))
                               .map(td => {
                                   let text = td.textContent.trim();
                                   // Remove emojis for cleaner CSV output if desired, or keep them
                                   text = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
                                   // Handle commas and quotes in data
                                   return `"${text.replace(/"/g, '""')}"`;
                               });
                csv.push(rowData.join(','));
            });

            const csvString = csv.join('\n');
            // Prepend UTF-8 BOM
            const BOM = "\uFEFF"; // UTF-8 Byte Order Mark
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                displayMessageModal('Lỗi xuất file', 'Trình duyệt của bạn không hỗ trợ tải file trực tiếp.');
            }
        }

        // --- NEW STRAVA API CALL LOGIC (via Supabase Edge Function) ---
        async function fetchStravaClubActivities(clubId) {
            const stravaStatus = document.getElementById('strava-status');
            stravaStatus.textContent = 'Đang tải dữ liệu từ Strava qua Supabase Edge Function...';

            if (SUPABASE_EDGE_FUNCTION_URL === 'YOUR_SUPABASE_EDGE_FUNCTION_URL') {
                displayMessageModal('Lỗi cấu hình', 'Vui lòng thay thế YOUR_SUPABASE_EDGE_FUNCTION_URL bằng URL Edge Function thực tế của bạn.');
                stravaStatus.textContent = 'Lỗi cấu hình Edge Function URL.';
                return null;
            }

            try {
                const response = await fetch(SUPABASE_EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ clubId: clubId }),
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Lỗi từ Edge Function: ${response.status} - ${errorDetails.error || 'Unknown error'}`);
                }

                const data = await response.json();
                const activities = data.activities; // Edge Function trả về đối tượng { activities: [...] }
                console.log("Fetched Strava Activities via Edge Function:", activities);

                // Process these activities into the format expected by loadRunsFromLocalStorage
                const processedData = {}; // Object to group runs by runner name

                activities.forEach(activity => {
                    try {
                        // Detailed validation for critical fields
                        if (!activity.athlete) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): Missing athlete object.`, activity);
                            return;
                        }
                        if (!activity.athlete.firstname || !activity.athlete.lastname) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): Missing athlete name.`, activity);
                            return;
                        }
                        if (typeof activity.distance === 'undefined' || activity.distance === null) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): Missing or null distance.`, activity);
                            return;
                        }
                        if (typeof activity.moving_time === 'undefined' || activity.moving_time === null) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): Missing or null moving_time.`, activity);
                            return;
                        }
                        if (!activity.type) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): Missing activity type.`, activity);
                            return;
                        }

                        const runnerName = `${activity.athlete.firstname} ${activity.athlete.lastname}`;
                        const activityType = activity.type; // e.g., 'Run', 'Ride', 'Swim'

                        // Ensure distance and time are valid numbers before processing
                        const distanceMeters = parseFloat(activity.distance);
                        const movingTimeSeconds = parseFloat(activity.moving_time);

                        if (isNaN(distanceMeters)) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): Non-numeric distance.`, activity);
                            return;
                        }
                        if (isNaN(movingTimeSeconds)) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): Non-numeric moving time.`, activity);
                            return;
                        }

                        const distanceKm = (distanceMeters / 1000).toFixed(1); // Convert meters to KM
                        const timeMinutes = (movingTimeSeconds / 60).toFixed(0); // Convert seconds to minutes

                        let formattedDate;
                        if (!activity.start_date_local) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): start_date_local is missing or empty.`);
                            return; // Skip if date string is missing
                        }
                        try {
                            const date = new Date(activity.start_date_local);
                            if (isNaN(date.getTime())) {
                                throw new Error('Invalid date format');
                            }
                            formattedDate = date.toISOString().split('T')[0]; //YYYY-MM-DD
                        } catch (dateError) {
                            console.warn(`Skipping activity (ID: ${activity.id || 'N/A'}): Invalid date string for start_date_local: '${activity.start_date_local}'. Error: ${dateError.message}`, activity);
                            return; // Skip if date parsing fails
                        }

                        if (!processedData[runnerName]) {
                            processedData[runnerName] = { runnerName: runnerName, runs: [] };
                        }

                        // Map Strava activity type to application's Vietnamese type
                        const mappedActivityType = STRAVA_TYPE_TO_APP_TYPE[activityType] || 'Khác';

                        processedData[runnerName].runs.push({
                            date: formattedDate,
                            distance: parseFloat(distanceKm),
                            time: parseFloat(timeMinutes),
                            type: mappedActivityType // Use the mapped type
                        });
                    } catch (activityError) {
                        console.error(`Error processing single activity (ID: ${activity.id || 'N/A'}):`, activityError, activity);
                    }
                });

                // Convert processedData object back to array format
                const finalClubData = Object.values(processedData);
                console.log("Final processed club data:", finalClubData); // Log final data

                stravaStatus.textContent = 'Đã tải dữ liệu thành công từ Strava!';
                return finalClubData;

            } catch (error) {
                console.error("Lỗi khi tải dữ liệu Strava qua Edge Function:", error);
                stravaStatus.textContent = `Lỗi: ${error.message}. Vui lòng kiểm tra Edge Function và cấu hình Strava.`;
                displayMessageModal('Lỗi tải dữ liệu Strava', `Không thể tải dữ liệu: ${error.message}. Vui lòng kiểm tra Edge Function và cấu hình Strava.`);
                return null; // Return null on error
            }
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Initial load from local storage (will be mock data if no real data fetched yet)
            const initialClubData = loadRunsFromLocalStorage();
            generateActivityTypeFilters(initialClubData);
            loadAndClassifyData();

            const classifyBtn = document.getElementById('classifyBtn');
            const classifyCustomKm = document.getElementById('classifyCustomKm');
            const customKmInput = document.getElementById('customKmInput');
            const classify25km = document.getElementById('classify25km');
            const penaltyPerKmInput = document.getElementById('penaltyPerKm');
            const weekSelect = document.getElementById('week-select');
            const connectStravaBtn = document.getElementById('connect-strava-btn'); // Get the Strava connect button
            const stravaStatus = document.getElementById('strava-status');
            const stravaClubIdInput = document.getElementById('strava-club-id-input');


            const exportGoalMetBtn = document.getElementById('export-goal-met-btn');
            const exportGoalNotMetBtn = document.getElementById('export-goal-not-met-btn');
            const exportInvalidActivitiesBtn = document.getElementById('export-invalid-activities-btn');

            // Handle Strava connection button click
            connectStravaBtn.addEventListener('click', async () => {
                const clubId = stravaClubIdInput.value.trim();
                if (!clubId) {
                    displayMessageModal('Thiếu ID Câu lạc bộ', 'Vui lòng nhập ID Câu lạc bộ Strava của bạn.');
                    return;
                }

                // Call the function to fetch data directly
                const fetchedData = await fetchStravaClubActivities(clubId);

                if (fetchedData) {
                    saveRunsToLocalStorage(fetchedData); // Save fetched data to local storage
                    generateActivityTypeFilters(fetchedData); // Regenerate filters based on new data
                    loadAndClassifyData(); // Re-classify data
                } else {
                    // If fetch failed, fallback to mock data or clear tables
                    stravaStatus.textContent = 'Không thể tải dữ liệu Strava. Đang sử dụng dữ liệu mẫu.';
                    const allClubData = loadRunsFromLocalStorage(); // Load mock data
                    generateActivityTypeFilters(allClubData);
                    loadAndClassifyData();
                }
            });


            // Toggle custom KM input based on radio button selection
            classifyCustomKm.addEventListener('change', () => {
                customKmInput.disabled = !classifyCustomKm.checked;
                if (classifyCustomKm.checked) {
                    customKmInput.focus();
                }
                // No need to call loadAndClassifyData here, it will be called by classifyBtn click or other changes
            });

            classify25km.addEventListener('change', () => {
                customKmInput.disabled = true;
                // No need to call loadAndClassifyData here
            });

            // Re-classify data when penalty amount changes
            penaltyPerKmInput.addEventListener('input', () => {
                loadAndClassifyData();
            });

            // Re-classify data when week selection changes
            weekSelect.addEventListener('change', () => {
                loadAndClassifyData();
            });

            // Handle classify button click with validation for custom KM
            classifyBtn.addEventListener('click', () => {
                const classificationType = document.querySelector('input[name="classificationType"]:checked').value;
                const customKmInput = document.getElementById('customKmInput');

                if (classificationType === 'custom') {
                    const customValue = parseFloat(customKmInput.value);
                    if (isNaN(customValue) || customValue <= 0) {
                        displayMessageModal('Lỗi nhập liệu', 'Vui lòng nhập một giá trị KM hợp lệ và lớn hơn 0 cho tiêu chí tùy chỉnh.');
                        // Prevent classification if invalid
                        return;
                    }
                }
                loadAndClassifyData(); // Proceed with classification if valid
            });

            // Export button listeners
            exportGoalMetBtn.addEventListener('click', () => {
                exportTableToCSV('goal-met-table', 'thanh_tich_dat_muc_tieu.csv');
            });
            exportGoalNotMetBtn.addEventListener('click', () => {
                exportTableToCSV('goal-not-met-table', 'thanh_tich_chua_dat_muc_tieu.csv');
            });
            exportInvalidActivitiesBtn.addEventListener('click', () => {
                exportTableToCSV('invalid-activities-table', 'hoat_dong_khong_hop_le.csv');
            });
        });
    </script>
</body>
</html>
