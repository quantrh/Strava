<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Thống kê Chạy bộ - BIDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define BIDV brand colors as CSS variables for easy use */
        :root {
            --bidv-green: #006B68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Custom Tailwind classes using CSS variables */
        .bg-bidv-green { background-color: var(--bidv-green); }
        .text-bidv-green { color: var(--bidv-green); }
        .border-bidv-green { border-color: var(--bidv-green); }
        .hover\:bg-bidv-green-darker:hover { background-color: #005A58; } /* Slightly darker green for hover */

        .bg-bidv-yellow { background-color: var(--bidv-yellow); }
        .text-bidv-yellow { color: var(--bidv-yellow); }
        .border-bidv-yellow { border-color: var(--bidv-yellow); }
        .hover\:bg-bidv-yellow-darker:hover { background-color: #E6B32C; } /* Slightly darker yellow for hover */

        .focus\:ring-bidv-green:focus { --tw-ring-color: var(--bidv-green); }
        .focus\:ring-bidv-yellow:focus { --tw-ring-color: var(--bidv-yellow); }

        /* Loading spinner styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #006B68;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl w-full bg-white shadow-lg rounded-xl p-6 sm:p-8 space-y-8">
        <header class="text-center flex flex-col items-center">
            <img src="https://placehold.co/150x50/006B68/FFFFFF?text=BIDV+Logo" alt="BIDV Logo Placeholder" class="h-16 mb-4 rounded-md">
            <h1 class="text-3xl sm:text-4xl font-bold text-bidv-green mb-2">Thống kê Thành tích Câu lạc bộ Chạy bộ BIDV</h1>
            <p class="text-lg text-gray-600">Phân loại và theo dõi thành tích chạy bộ của các thành viên</p>
        </header>

        <section class="bg-bidv-green bg-opacity-10 p-6 rounded-lg border border-bidv-green border-opacity-30">
            <h2 class="text-2xl font-semibold text-bidv-green mb-4">Kết nối Strava</h2>
            <p class="text-gray-700 mb-4">
                Để lấy dữ liệu thành tích của câu lạc bộ, bạn cần kết nối tài khoản Strava.
                <br><strong class="text-red-600">Lưu ý: Ứng dụng này gọi đến một hàm serverless để bảo mật thông tin Strava API.</strong>
            </p>
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <label for="stravaClubIdInput" class="text-gray-700 text-lg font-medium">ID Câu lạc bộ Strava:</label>
                <input type="text" id="stravaClubIdInput" class="flex-grow sm:max-w-xs p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-bidv-green focus:border-bidv-green transition duration-150 ease-in-out" placeholder="Nhập ID câu lạc bộ">
            </div>
            <button id="connect-strava-btn" class="w-full bg-bidv-green hover:bg-bidv-green-darker text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-bidv-green focus:ring-opacity-50">
                Tải Dữ liệu Strava
            </button>
            <div id="strava-status" class="mt-2 text-sm text-gray-600 text-center"></div>
        </section>

        <section class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800">Cài đặt Thống kê</h2>

            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label for="week-select" class="text-gray-700 text-lg font-medium">Chọn tuần:</label>
                <select id="week-select" class="flex-grow sm:max-w-xs p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-bidv-green focus:border-bidv-green transition duration-150 ease-in-out">
                    <option value="week-current">Tuần hiện tại (26/05 - 01/06)</option>
                    <option value="week-1">Tuần trước (19/05 - 25/05)</option>
                    <option value="week-2">2 tuần trước (12/05 - 18/05)</option>
                </select>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Tiêu chí Phân loại theo KM/tuần</h3>
                <div class="space-y-4">
                    <div class="flex items-center space-x-3">
                        <input type="radio" id="classify25km" name="classificationType" value="25" class="form-radio h-4 w-4 text-bidv-green focus:ring-bidv-green" checked>
                        <label for="classify25km" class="text-gray-700">Phân loại theo 25 KM/tuần</label>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input type="radio" id="classifyCustomKm" name="classificationType" value="custom" class="form-radio h-4 w-4 text-bidv-green focus:ring-bidv-green">
                        <label for="classifyCustomKm" class="text-gray-700">Phân loại theo số KM/tuần tùy ý:</label>
                        <input type="number" id="customKmInput" class="ml-2 px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-yellow focus:border-bidv-yellow sm:text-sm w-24" placeholder="KM" disabled>
                    </div>
                </div>
                <div class="mt-6">
                    <label for="penaltyPerKm" class="block text-sm font-medium text-gray-700 mb-1">Số tiền phạt/KM (VNĐ):</label>
                    <input type="number" id="penaltyPerKm" value="30000" class="mt-1 block w-full sm:w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-yellow focus:border-bidv-yellow sm:text-sm">
                </div>

                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Lọc theo loại hình hoạt động</h3>
                    <div id="activity-type-filters" class="flex flex-wrap gap-4">
                        </div>
                </div>

                <button id="classifyBtn" class="mt-6 w-full bg-bidv-yellow text-bidv-green font-semibold py-2 px-4 rounded-md hover:bg-bidv-yellow-darker focus:outline-none focus:ring-2 focus:ring-bidv-yellow focus:ring-offset-2 transition duration-150 ease-in-out shadow-md">
                    Phân loại Thành tích
                </button>
            </div>
        </section>

        <section class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800">Thống kê Thành tích Câu lạc bộ</h2>

            <div class="bg-white p-6 rounded-lg shadow-md border border-bidv-green border-opacity-30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-bidv-green">Vận động viên Đạt mục tiêu <span id="goal-met-threshold"></span></h3>
                    <button id="export-goal-met-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xuất Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="goal-met-table">
                        <thead class="bg-bidv-green text-white">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    Tên Vận động viên
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Tổng KM Tuần
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Số buổi
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    Hành động
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="goal-met-table-body">
                            <tr>
                                <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    Chưa có vận động viên nào đạt mục tiêu.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Vận động viên Chưa đạt mục tiêu <span id="goal-not-met-threshold"></span></h3>
                    <button id="export-goal-not-met-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xuất Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="goal-not-met-table">
                        <thead class="bg-gray-200 text-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    Tên Vận động viên
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Tổng KM Tuần
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Số buổi
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Số KM còn thiếu
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Số tiền phạt
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    Hành động
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="goal-not-met-table-body">
                            <tr>
                                <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    Tất cả vận động viên đều đã đạt mục tiêu.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-red-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-red-600">Các hoạt động không hợp lệ (Pace <= 4 hoặc >= 14 phút/KM cho Chạy bộ/Đi bộ)</h3>
                    <button id="export-invalid-activities-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xuất Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="invalid-activities-table">
                        <thead class="bg-red-100 text-red-800">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    Tên Vận động viên
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Ngày
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Loại hình
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Quãng đường (KM)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Thời gian (phút)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Pace (phút/KM)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    Lý do
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="invalid-activities-table-body">
                            <tr>
                                <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    Không có hoạt động không hợp lệ nào.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div id="llm-analysis-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 sm:p-8 space-y-6 relative">
                <h2 class="text-3xl font-bold text-bidv-green text-center mb-4">Phân tích Thành tích AI ✨</h2>
                <button id="close-llm-analysis-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition duration-150 ease-in-out">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <div id="llm-analysis-content" class="space-y-4 max-h-96 overflow-y-auto pr-2 text-gray-700">
                    <div class="flex flex-col justify-center items-center h-full">
                        <div class="spinner"></div>
                        <p class="ml-3 text-lg font-medium">Đang tạo phân tích...</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-8">
            &copy; 2025 Trương Hồng Quân - Câu lạc bộ Chạy bộ BIDV. Tất cả quyền được bảo lưu.
        </footer>
    </div>

    <script type="module">
        // Để chạy ứng dụng này cục bộ, bạn cần sử dụng một máy chủ web.
        // Ví dụ: Mở terminal trong thư mục này và chạy `python -m http.server`
        // hoặc cài đặt `serve` bằng `npm install -g serve` và chạy `serve`.

        // Import Firebase modules (not directly used for data persistence in this version)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // REMOVED: import { STRAVA_CLIENT_ID, STRAVA_CLUB_ID, STRAVA_ACCESS_TOKEN } from './config.js';
        // Lý do: Các thông tin nhạy cảm này sẽ được xử lý an toàn ở phía serverless function (index.ts).

        // Firebase configuration (provided globally by Canvas environment)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null; // To store the authenticated user ID

        // Authenticate user
        async function authenticateFirebase() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase authentication successful.");
            } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        }

        // Listen for auth state changes to get the user ID
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("User ID:", currentUserId);
                // No need to load data immediately after firebase auth, it's now triggered by Strava button
            } else {
                currentUserId = null;
                console.log("No user signed in.");
                // Clear tables if no user, or keep mock data
                document.getElementById('goal-met-table-body').innerHTML = '<tr><td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Chưa có dữ liệu. Vui lòng tải dữ liệu Strava.</td></tr>';
                document.getElementById('goal-not-met-table-body').innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Chưa có dữ liệu. Vui lòng tải dữ liệu Strava.</td></tr>';
                document.getElementById('invalid-activities-table-body').innerHTML = '<tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Chưa có dữ liệu. Vui lòng tải dữ liệu Strava.</td></tr>';
            }
        });

        // --- LOCAL STORAGE FUNCTIONS ---
        const LOCAL_STORAGE_KEY = 'bidvRunningClubData';

        function saveRunsToLocalStorage(runs) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(runs));
                console.log("Data saved to localStorage.");
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                displayMessageModal('Lỗi lưu trữ', 'Không thể lưu dữ liệu vào bộ nhớ cục bộ.');
            }
        }

        function loadRunsFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (data) {
                    console.log("Data loaded from localStorage.");
                    return JSON.parse(data);
                }
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                displayMessageModal('Lỗi tải dữ liệu', 'Không thể tải dữ liệu từ bộ nhớ cục bộ. Dữ liệu mẫu sẽ được sử dụng.');
            }
            // If no data or error, return default example data
            const defaultData = [
                { runnerName: 'Nguyễn Văn A', runs: [
                    { date: '2025-05-20', distance: 10.5, time: 50, type: 'Chạy bộ' }, // Pace: 4.76
                    { date: '2025-05-22', distance: 8.0, time: 40, type: 'Chạy bộ' }, // Pace: 5.0
                    { date: '2025-05-24', distance: 7.0, time: 35, type: 'Chạy bộ' }  // Pace: 5.0
                ]},
                { runnerName: 'Trần Thị B', runs: [
                    { date: '2025-05-21', distance: 12.0, time: 60, type: 'Chạy bộ' }, // Pace: 5.0
                    { date: '2025-05-23', distance: 10.0, time: 50, type: 'Chạy bộ' }, // Pace: 5.0
                    { date: '2025-05-25', distance: 5.0, time: 25, type: 'Đi bộ' }  // Pace: 5.0
                ]},
                { runnerName: 'Lê Văn C', runs: [
                    { date: '2025-05-20', distance: 15.0, time: 70, type: 'Chạy bộ' }, // Pace: 4.67
                    { date: '2025-05-22', distance: 10.0, time: 45, type: 'Chạy bộ' }, // Pace: 4.5
                    { date: '2025-05-24', distance: 12.0, time: 55, type: 'Đạp xe' }, // Pace: 4.58 (not subject to pace rule)
                    { date: '2025-05-26', distance: 8.0, time: 40, type: 'Chạy bộ' }  // Pace: 5.0
                ]},
                { runnerName: 'Phạm Thị D', runs: [
                    { date: '2025-05-21', distance: 6.0, time: 30, type: 'Đi bộ' }, // Pace: 5.0
                    { date: '2025-05-23', distance: 7.5, time: 38, type: 'Đi bộ' }, // Pace: 5.07
                    { date: '2025-05-24', distance: 1.0, time: 15, type: 'Đi bộ' }  // Pace: 15.0 (Invalid)
                ]},
                { runnerName: 'Vũ Minh E', runs: [
                    { date: '2025-05-20', distance: 2.0, time: 15, type: 'Chạy bộ' }, // Pace: 7.5
                    { date: '2025-05-25', distance: 3.0, time: 20, type: 'Đi bộ' }, // Pace: 6.67
                    { date: '2025-05-26', distance: 5.0, time: 10, type: 'Bơi lội' }  // Pace: 2.0 (not subject to pace rule)
                ]},
                { runnerName: 'Đặng Thị F', runs: [
                    { date: '2025-05-27', distance: 20.0, time: 40, type: 'Đạp xe' }, // Pace: 2.0 (not subject to pace rule)
                    { date: '2025-05-28', distance: 1.0, time: 20, type: 'Đi bộ' } // Pace: 20.0 (Invalid)
                ]},
                { runnerName: 'Nguyễn Thanh G', runs: [
                    { date: '2025-05-20', distance: 1.0, time: 5, type: 'Bơi lội' },
                    { date: '2025-05-22', distance: 10.0, time: 25, type: 'Đạp xe' },
                    { date: '2025-05-24', distance: 0.5, time: 30, type: 'Yoga' }
                ]},
                { runnerName: 'Hoàng Văn H', runs: [
                    { date: '2025-05-21', distance: 8.0, time: 40, type: 'Chạy bộ' },
                    { date: '2025-05-23', distance: 3.0, time: 45, type: 'Đi bộ' }, // Pace: 15.0 (Invalid)
                    { date: '2025-05-25', distance: 15.0, time: 30, type: 'Đạp xe' }
                ]},
                { runnerName: 'Võ Trọng I', runs: [
                    { date: '2025-05-28', distance: 5.0, time: 20, type: 'Chạy bộ' },
                    { date: '2025-05-29', distance: 2.0, time: 10, type: 'Đi bộ' },
                    { date: '2025-05-30', distance: 1.0, time: 60, type: 'Leo núi' } // New activity type
                ]}
            ];
            // Save default data to localStorage if it's being used for the first time
            saveRunsToLocalStorage(defaultData);
            return defaultData;
        }

        // Mapping for activity types to emojis
        const activityTypeEmojis = {
            'Chạy bộ': '🏃‍♂️',
            'Đi bộ': '🚶‍♀️',
            'Đạp xe': '🚴‍♂️',
            'Bơi lội': '🏊‍♀️',
            'Yoga': '🧘‍♀️',
            'Leo núi': '🧗‍♂️',
            'Khác': '❓'
        };

        // Function to generate activity type checkboxes dynamically
        function generateActivityTypeFilters(allClubData) {
            const activityTypeFilterDiv = document.getElementById('activity-type-filters');
            activityTypeFilterDiv.innerHTML = ''; // Clear existing filters

            const uniqueActivityTypes = new Set();
            allClubData.forEach(member => {
                member.runs.forEach(run => {
                    uniqueActivityTypes.add(run.type);
                });
            });

            // Ensure common types are always available, even if not in current data
            const commonTypes = ['Chạy bộ', 'Đi bộ', 'Đạp xe', 'Bơi lội', 'Yoga', 'Leo núi', 'Khác'];
            commonTypes.forEach(type => uniqueActivityTypes.add(type));

            const sortedTypes = Array.from(uniqueActivityTypes).sort();

            sortedTypes.forEach(type => {
                const label = document.createElement('label');
                label.className = 'flex items-center';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'activityType';
                checkbox.value = type;
                checkbox.className = 'form-checkbox h-5 w-5 text-bidv-green rounded';

                // Default check for 'Chạy bộ' and 'Đi bộ'
                if (type === 'Chạy bộ' || type === 'Đi bộ') {
                    checkbox.checked = true;
                }

                const span = document.createElement('span');
                span.className = 'ml-2 text-gray-700';
                span.textContent = `${activityTypeEmojis[type] || ''} ${type}`;

                label.appendChild(checkbox);
                label.appendChild(span);
                activityTypeFilterDiv.appendChild(label);

                // Attach event listener immediately
                checkbox.addEventListener('change', () => {
                    loadAndClassifyData();
                });
            });
        }


        // Function to process and display runs based on classification
        function loadAndClassifyData() {
            const classificationType = document.querySelector('input[name="classificationType"]:checked').value;
            let threshold = 25; // Default to 25 KM

            // Enable/disable custom KM input based on radio button selection
            const customKmInput = document.getElementById('customKmInput');
            if (classificationType === 'custom') {
                customKmInput.disabled = false; // Enable input
                const customValue = parseFloat(customKmInput.value);
                // If custom is selected but value is invalid, use default 25 for calculation
                // The error message will be shown when classifyBtn is clicked, not here.
                if (!isNaN(customValue) && customValue > 0) {
                    threshold = customValue;
                } else {
                    threshold = 25; // Use a fallback threshold for display/initial calculation
                }
            } else {
                customKmInput.disabled = true; // Disable input
            }


            const penaltyPerKmInput = document.getElementById('penaltyPerKm');
            let penaltyPerKm = parseFloat(penaltyPerKmInput.value);
            if (isNaN(penaltyPerKm) || penaltyPerKm < 0) {
                displayMessageModal('Lỗi nhập liệu', 'Vui lòng nhập một giá trị tiền phạt hợp lệ (số không âm).');
                penaltyPerKm = 30000;
                penaltyPerKmInput.value = 30000;
            }

            // Get selected activity types
            let selectedActivityTypes = Array.from(document.querySelectorAll('input[name="activityType"]:checked')).map(cb => cb.value);
            if (selectedActivityTypes.length === 0) {
                // This block handles the case where user unchecks all boxes
                displayMessageModal('Lỗi lọc hoạt động', 'Vui lòng chọn ít nhất một loại hình hoạt động để thống kê. Mặc định sẽ sử dụng "Chạy bộ" và "Đi bộ" cho việc phân loại.');
                // For classification logic, use default types if none are selected by the user
                selectedActivityTypes = ['Chạy bộ', 'Đi bộ'];
                // DO NOT attempt to set .checked = true here, as it causes the error.
                // The UI state should be managed by user interaction or initial generation.
            }


            document.getElementById('goal-met-threshold').textContent = `(Mục tiêu: ${threshold} KM)`;
            document.getElementById('goal-not-met-threshold').textContent = `(Mục tiêu: ${threshold} KM)`;

            const allClubData = loadRunsFromLocalStorage(); // Load data from localStorage

            const goalMetMembers = [];
            const goalNotMetMembers = [];
            const invalidActivities = []; // New array for invalid activities (all types, but pace rule only for running/walking)

            // Process each member's runs
            allClubData.forEach(member => {
                let memberValidRunsForSelectedTypes = []; // Runs that are valid pace-wise AND of selected types
                let totalDistanceForSelectedTypes = 0;
                let totalSessionsForSelectedTypes = 0;

                member.runs.forEach(run => {
                    const pace = run.distance > 0 ? (run.time / run.distance) : 0; // Calculate pace, handle distance=0

                    // Check for invalid pace ONLY for 'Chạy bộ' and 'Đi bộ'
                    const isRunningOrWalking = (run.type === 'Chạy bộ' || run.type === 'Đi bộ');
                    const isPaceInvalid = (pace <= 4 || pace >= 14);

                    if (isRunningOrWalking && isPaceInvalid) {
                        invalidActivities.push({
                            runnerName: member.runnerName,
                            date: run.date,
                            type: run.type, // Include type in invalid activities
                            distance: run.distance,
                            time: run.time,
                            pace: pace.toFixed(2),
                            reason: pace <= 4 ? 'Pace quá nhanh (<4 phút/KM)' : 'Pace quá chậm (>14 phút/KM)'
                        });
                    } else {
                        // Activity is valid pace-wise (or not subject to pace rule)
                        // Now check if it's one of the selected activity types for main tables
                        if (selectedActivityTypes.includes(run.type)) {
                            memberValidRunsForSelectedTypes.push(run);
                            totalDistanceForSelectedTypes += run.distance;
                            totalSessionsForSelectedTypes++;
                        }
                    }
                });

                // Only add to goal tables if there are valid runs for the member for selected types
                // A member is included if they have any valid runs for the selected types, even if total distance is 0
                if (memberValidRunsForSelectedTypes.length > 0) {
                    const memberStats = {
                        runnerName: member.runnerName,
                        totalDistance: totalDistanceForSelectedTypes.toFixed(1),
                        totalSessions: totalSessionsForSelectedTypes,
                        rawRuns: memberValidRunsForSelectedTypes // Store only valid runs (pace-wise & type-wise) for LLM analysis
                    };

                    if (totalDistanceForSelectedTypes >= threshold) {
                        goalMetMembers.push(memberStats);
                    } else {
                        const kmDeficit = threshold - totalDistanceForSelectedTypes;
                        memberStats.kmDeficit = (kmDeficit > 0 ? kmDeficit : 0).toFixed(1);
                        memberStats.penaltyAmount = (kmDeficit > 0 ? kmDeficit : 0) * penaltyPerKm;
                        goalNotMetMembers.push(memberStats);
                    }
                }
            });

            renderTable(document.getElementById('goal-met-table-body'), goalMetMembers, 'Chưa có vận động viên nào đạt mục tiêu.', threshold, false);
            renderTable(document.getElementById('goal-not-met-table-body'), goalNotMetMembers, 'Tất cả vận động viên đều đã đạt mục tiêu.', threshold, true);
            renderInvalidActivitiesTable(document.getElementById('invalid-activities-table-body'), invalidActivities, 'Không có hoạt động không hợp lệ nào.');
        }

        // Helper function to render a table (for goal-met and goal-not-met)
        function renderTable(tableBodyElement, data, emptyMessage, threshold, includePenaltyAndDeficitColumns) {
            tableBodyElement.innerHTML = ''; // Clear previous rows

            const tableElement = tableBodyElement.closest('table');
            const tableHeadRow = tableElement.querySelector('thead tr');

            if (!tableHeadRow) {
                console.error("Error: Thead row not found for table.", tableElement);
                return;
            }

            // Define base headers for the goal tables
            const baseHeaders = [
                { text: 'Tên Vận động viên', class: 'rounded-tl-lg' },
                { text: 'Tổng KM Tuần' },
                { text: 'Số buổi' }
            ];
            const actionHeader = { text: 'Hành động', class: 'rounded-tr-lg' }; // Always present, always last

            // Clear existing headers to rebuild them correctly
            tableHeadRow.innerHTML = '';

            // Add base headers
            baseHeaders.forEach(header => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = `px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${header.class || ''}`;
                th.textContent = header.text;
                tableHeadRow.appendChild(th);
            });

            // Add dynamic headers if required
            if (includePenaltyAndDeficitColumns) {
                const kmDeficitHeader = document.createElement('th');
                kmDeficitHeader.scope = 'col';
                kmDeficitHeader.className = 'px-6 py-3 text-left text-xs font-medium uppercase tracking-wider';
                kmDeficitHeader.textContent = 'Số KM còn thiếu';
                tableHeadRow.appendChild(kmDeficitHeader);

                const penaltyHeader = document.createElement('th');
                penaltyHeader.scope = 'col';
                penaltyHeader.className = 'px-6 py-3 text-left text-xs font-medium uppercase tracking-wider';
                penaltyHeader.textContent = 'Số tiền phạt';
                tableHeadRow.appendChild(penaltyHeader);
            }

            // Add action header (always last)
            const thAction = document.createElement('th');
            thAction.scope = 'col';
            thAction.className = `px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${actionHeader.class || ''}`;
            thAction.textContent = actionHeader.text;
            tableHeadRow.appendChild(thAction);


            if (data.length === 0) {
                const noDataRow = document.createElement('tr');
                // Calculate colspan based on whether dynamic columns are included
                const colspan = includePenaltyAndDeficitColumns ? 6 : 4;
                noDataRow.innerHTML = `
                    <td colspan="${colspan}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        ${emptyMessage}
                    </td>
                `;
                tableBodyElement.appendChild(noDataRow);
            } else {
                data.forEach(member => {
                    const row = document.createElement('tr');
                    let dynamicCells = '';
                    if (includePenaltyAndDeficitColumns) {
                        dynamicCells = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.kmDeficit} KM</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${member.penaltyAmount.toLocaleString('vi-VN')} VNĐ</td>
                        `;
                    }
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.runnerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.totalDistance} KM</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.totalSessions}</td>
                        ${dynamicCells}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <button class="analyze-btn bg-bidv-green text-white px-3 py-1 rounded-md text-xs hover:bg-bidv-green-darker transition duration-150 ease-in-out"
                                data-runner-name="${member.runnerName}"
                                data-total-km="${member.totalDistance}"
                                data-total-sessions="${member.totalSessions}"
                                data-threshold="${threshold}"
                                data-raw-runs='${JSON.stringify(member.rawRuns)}'
                            >
                                ✨ Phân tích
                            </button>
                        </td>
                    `;
                    tableBodyElement.appendChild(row);
                });
            }
            attachAnalyzeButtonListeners();
        }

        // Helper function to render the Invalid Activities table
        function renderInvalidActivitiesTable(tableBodyElement, data, emptyMessage) {
            tableBodyElement.innerHTML = ''; // Clear previous rows

            // Update the header for the invalid activities table to include "Loại hình"
            const tableElement = tableBodyElement.closest('table');
            const tableHeadRow = tableElement.querySelector('thead tr');
            // Rebuild headers for invalid activities table for consistency
            tableHeadRow.innerHTML = `
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                    Tên Vận động viên
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Ngày
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Loại hình
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Quãng đường (KM)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Thời gian (phút)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Pace (phút/KM)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                    Lý do
                </th>
            `;


            if (data.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        ${emptyMessage}
                    </td>
                `;
                tableBodyElement.appendChild(noDataRow);
            } else {
                data.forEach(activity => {
                    const row = document.createElement('tr');
                    const emoji = activityTypeEmojis[activity.type] || ''; // Get emoji for type
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${activity.runnerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${emoji} ${activity.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.distance} KM</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.time} phút</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${activity.pace}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.reason}</td>
                    `;
                    tableBodyElement.appendChild(row);
                });
            }
        }

        // Function to attach event listeners to "Analyze" buttons
        function attachAnalyzeButtonListeners() {
            document.querySelectorAll('.analyze-btn').forEach(button => {
                button.removeEventListener('click', handleAnalyzeClick); // Prevent duplicate listeners
                button.addEventListener('click', handleAnalyzeClick);
            });
        }

        // Handle click on "Analyze" button
        async function handleAnalyzeClick(event) {
            const runnerName = event.target.dataset.runnerName;
            const totalKm = event.target.dataset.totalKm;
            const totalSessions = event.target.dataset.totalSessions;
            const threshold = event.target.dataset.threshold;
            const rawRuns = JSON.parse(event.target.dataset.rawRuns);

            const llmAnalysisModal = document.getElementById('llm-analysis-modal');
            const llmAnalysisContent = document.getElementById('llm-analysis-content');

            // Show modal and loading spinner
            llmAnalysisModal.classList.remove('hidden');
            llmAnalysisContent.innerHTML = `
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="spinner"></div>
                    <p class="ml-3 text-lg font-medium text-gray-700 mt-4">Đang tạo phân tích...</p>
                </div>
            `;

            // Construct prompt for LLM
            let prompt = `Bạn là một huấn luyện viên chạy bộ AI. Hãy phân tích thành tích chạy bộ hàng tuần của vận động viên ${runnerName} và đưa ra lời khuyên cá nhân hóa.

            Thông tin thành tích tuần:
            - Tổng quãng đường: ${totalKm} KM
            - Tổng số buổi chạy: ${totalSessions} buổi
            - Mục tiêu KM tuần: ${threshold} KM

            Chi tiết các buổi chạy hợp lệ (đã lọc pace không hợp lệ):
            `;
            if (rawRuns && rawRuns.length > 0) {
                rawRuns.forEach(run => {
                    const emoji = activityTypeEmojis[run.type] || '';
                    prompt += `- Ngày ${run.date}: ${run.distance} KM trong ${run.time} phút (${emoji} ${run.type}).\n`;
                });
            } else {
                prompt += `- Không có chi tiết buổi chạy cụ thể hợp lệ trong các loại hình đã chọn.\n`;
            }

            if (parseFloat(totalKm) >= parseFloat(threshold)) {
                prompt += `\nVận động viên này đã đạt hoặc vượt mục tiêu ${threshold} KM/tuần. Hãy đưa ra lời khen ngợi và gợi ý để duy trì hoặc nâng cao thành tích một cách bền vững.`;
            } else {
                prompt += `\nVận động viên này chưa đạt mục tiêu ${threshold} KM/tuần. Hãy đưa ra lời động viên, phân tích nguyên nhân tiềm ẩn (nếu có thể suy luận từ dữ liệu), và gợi ý các bước cụ thể để cải thiện thành tích trong tuần tới.`;
            }

            prompt += `\nHãy viết câu trả lời bằng tiếng Việt, thân thiện, dễ hiểu, và tập trung vào việc khuyến khích, động viên.`;

            // Call Gemini API
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Leave this as-is; Canvas will provide the key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    llmAnalysisContent.innerHTML = `<p class="whitespace-pre-wrap">${text}</p>`; // Use pre-wrap to preserve formatting
                } else {
                    llmAnalysisContent.innerHTML = '<p class="text-red-500">Không thể tạo phân tích. Cấu trúc phản hồi không mong muốn.</p>';
                    console.error("Unexpected LLM response structure:", result);
                }
            } catch (error) {
                llmAnalysisContent.innerHTML = `<p class="text-red-500">Đã xảy ra lỗi khi tạo phân tích: ${error.message}.</p>`;
                console.error("Error calling Gemini API:", error);
            }
        }

        // Close LLM Analysis Modal
        document.getElementById('close-llm-analysis-btn').addEventListener('click', () => {
            document.getElementById('llm-analysis-modal').classList.add('hidden');
        });

        // Hide modal if clicked outside
        document.getElementById('llm-analysis-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('llm-analysis-modal')) {
                document.getElementById('llm-analysis-modal').classList.add('hidden');
            }
        });

        // Custom message box function (instead of alert)
        function displayMessageModal(title, message) {
            const modalHtml = `
                <div id="custom-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[9999]">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4 relative">
                        <h3 class="text-xl font-bold text-bidv-green mb-2">${title}</h3>
                        <p class="text-gray-700">${message}</p>
                        <button id="close-custom-message-btn" class="w-full bg-bidv-green text-white py-2 px-4 rounded-md hover:bg-bidv-green-darker focus:outline-none focus:ring-2 focus:ring-bidv-green focus:ring-offset-2 transition duration-150 ease-in-out">
                            Đóng
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('close-custom-message-btn').addEventListener('click', () => {
                document.getElementById('custom-message-modal').remove();
            });

            document.getElementById('custom-message-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('custom-message-modal')) {
                    document.getElementById('custom-message-modal').remove();
                }
            });
        }

        // --- EXPORT TO CSV FUNCTIONALITY ---
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                console.error(`Table with ID "${tableId}" not found.`);
                displayMessageModal('Lỗi xuất file', `Không tìm thấy bảng để xuất dữ liệu.`);
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll('tr');

            // Get headers
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                let headers = Array.from(headerRow.querySelectorAll('th'))
                               .map(th => `"${th.textContent.trim().replace(/"/g, '""')}"`);
                csv.push(headers.join(','));
            }

            // Get data rows
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                // Skip empty message row
                if (row.querySelector('td[colspan]')) {
                    return;
                }
                let rowData = Array.from(row.querySelectorAll('td'))
                               .map(td => {
                                   let text = td.textContent.trim();
                                   // Remove emojis for cleaner CSV output if desired, or keep them
                                   text = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
                                   // Handle commas and quotes in data
                                   return `"${text.replace(/"/g, '""')}"`;
                               });
                csv.push(rowData.join(','));
            });

            const csvString = csv.join('\n');
            // Prepend UTF-8 BOM
            const BOM = "\uFEFF"; // UTF-8 Byte Order Mark
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                displayMessageModal('Lỗi xuất file', 'Trình duyệt của bạn không hỗ trợ tải file trực tiếp.');
            }
        }

        // --- UPDATED STRAVA API CALL LOGIC TO USE EDGE FUNCTION ---
        // Function to fetch club activities from Supabase Edge Function
        async function fetchStravaClubActivitiesFromEdgeFunction(clubId) {
            const stravaStatus = document.getElementById('strava-status');
            stravaStatus.textContent = 'Đang tải dữ liệu từ Strava (qua Edge Function)...';

            // Replace with the actual URL of your deployed Supabase Edge Function
            // Example: https://your-project-ref.supabase.co/functions/v1/strava-api
            const EDGE_FUNCTION_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/rapid-api'; // <<< Cần thay thế

            if (EDGE_FUNCTION_URL === 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/rapid-api' || !clubId) {
                displayMessageModal('Lỗi cấu hình', 'Vui lòng nhập ID câu lạc bộ Strava và thay thế https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/rapid-api bằng URL Edge Function thật của bạn.');
                stravaStatus.textContent = 'Lỗi cấu hình hoặc thiếu ID câu lạc bộ.';
                return null;
            }

            try {
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ clubId: clubId }) // Gửi clubId qua body POST
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Lỗi tải dữ liệu từ Edge Function: ${response.status} - ${errorDetails.error || 'Unknown error'}`);
                }

                const data = await response.json();
                // data.activities sẽ chứa danh sách hoạt động từ Edge Function
                // data.members sẽ chứa danh sách thành viên từ Edge Function
                // Bạn cần ánh xạ dữ liệu này sang định dạng mà loadRunsFromLocalStorage mong đợi.
                // Dữ liệu mẫu dưới đây là ví dụ về cách bạn có thể chuyển đổi.

                // Chuyển đổi dữ liệu nhận được từ Edge Function sang định dạng của bạn
                // Đây là một ví dụ đơn giản, bạn cần điều chỉnh cho phù hợp với cấu trúc dữ liệu Strava thực tế
                // và cách bạn muốn lưu trữ nó.
                const processedData = processStravaData(data.activities, data.members);

                stravaStatus.textContent = 'Đã tải dữ liệu thành công từ Strava (qua Edge Function)!';
                return processedData;

            } catch (error) {
                console.error("Lỗi khi tải dữ liệu Strava từ Edge Function:", error);
                stravaStatus.textContent = `Lỗi: ${error.message}. Kiểm tra URL Edge Function hoặc ID câu lạc bộ.`;
                displayMessageModal('Lỗi tải dữ liệu Strava', `Không thể tải dữ liệu: ${error.message}.`);
                return null; // Return null on error
            }
        }

        // Hàm giả định để xử lý dữ liệu từ Strava API (qua Edge Function)
        // Bạn cần điều chỉnh hàm này để phù hợp với cấu trúc dữ liệu thực tế từ Strava API
        // và cách bạn muốn tổ chức dữ liệu cho ứng dụng của mình.
        function processStravaData(stravaActivities, stravaMembers) {
            const processedClubData = [];
            const memberMap = new Map(); // Map athlete ID to runnerName

            // Populate member map
            stravaMembers.forEach(member => {
                memberMap.set(member.athlete.id, `${member.athlete.firstname} ${member.athlete.lastname}`);
            });

            // Aggregate activities by runner
            const runnerActivities = new Map();

            stravaActivities.forEach(activity => {
                const runnerId = activity.athlete.id;
                const runnerName = memberMap.get(runnerId) || `${activity.athlete.firstname} ${activity.athlete.lastname}`; // Fallback if not in members list

                if (!runnerActivities.has(runnerName)) {
                    runnerActivities.set(runnerName, []);
                }

                // Convert meters to KM and seconds to minutes
                const distanceKm = activity.distance / 1000;
                const timeMinutes = activity.moving_time / 60;
                const activityType = activity.type === 'Run' ? 'Chạy bộ' :
                                     activity.type === 'Walk' ? 'Đi bộ' :
                                     activity.type === 'Ride' ? 'Đạp xe' :
                                     activity.type === 'Swim' ? 'Bơi lội' :
                                     'Khác'; // Map Strava types to your types

                runnerActivities.get(runnerName).push({
                    date: activity.start_date.split('T')[0], // Get just the date part
                    distance: parseFloat(distanceKm.toFixed(1)),
                    time: parseFloat(timeMinutes.toFixed(1)),
                    type: activityType
                });
            });

            // Convert map to array format
            runnerActivities.forEach((runs, runnerName) => {
                processedClubData.push({
                    runnerName: runnerName,
                    runs: runs
                });
            });

            // If no data from Strava, or for initial load, use mock data
            if (processedClubData.length === 0) {
                console.warn("No data processed from Strava, falling back to mock data.");
                return [
                    { runnerName: 'Nguyễn Văn A', runs: [
                        { date: '2025-05-20', distance: 10.5, time: 50, type: 'Chạy bộ' },
                        { date: '2025-05-22', distance: 8.0, time: 40, type: 'Chạy bộ' },
                        { date: '2025-05-24', distance: 7.0, time: 35, type: 'Chạy bộ' }
                    ]},
                    { runnerName: 'Trần Thị B', runs: [
                        { date: '2025-05-21', distance: 12.0, time: 60, type: 'Chạy bộ' },
                        { date: '2025-05-23', distance: 10.0, time: 50, type: 'Chạy bộ' },
                        { date: '2025-05-25', distance: 5.0, time: 25, type: 'Đi bộ' }
                    ]},
                    { runnerName: 'Lê Văn C', runs: [
                        { date: '2025-05-20', distance: 15.0, time: 70, type: 'Chạy bộ' },
                        { date: '2025-05-22', distance: 10.0, time: 45, type: 'Chạy bộ' },
                        { date: '2025-05-24', distance: 12.0, time: 55, type: 'Đạp xe' },
                        { date: '2025-05-26', distance: 8.0, time: 40, type: 'Chạy bộ' }
                    ]},
                    { runnerName: 'Phạm Thị D', runs: [
                        { date: '2025-05-21', distance: 6.0, time: 30, type: 'Đi bộ' },
                        { date: '2025-05-23', distance: 7.5, time: 38, type: 'Đi bộ' },
                        { date: '2025-05-24', distance: 1.0, time: 15, type: 'Đi bộ' }
                    ]},
                    { runnerName: 'Vũ Minh E', runs: [
                        { date: '2025-05-20', distance: 2.0, time: 15, type: 'Chạy bộ' },
                        { date: '2025-05-25', distance: 3.0, time: 20, type: 'Đi bộ' },
                        { date: '2025-05-26', distance: 5.0, time: 10, type: 'Bơi lội' }
                    ]},
                    { runnerName: 'Đặng Thị F', runs: [
                        { date: '2025-05-27', distance: 20.0, time: 40, type: 'Đạp xe' },
                        { date: '2025-05-28', distance: 1.0, time: 20, type: 'Đi bộ' }
                    ]},
                    { runnerName: 'Nguyễn Thanh G', runs: [
                        { date: '2025-05-20', distance: 1.0, time: 5, type: 'Bơi lội' },
                        { date: '2025-05-22', distance: 10.0, time: 25, type: 'Đạp xe' },
                        { date: '2025-05-24', distance: 0.5, time: 30, type: 'Yoga' }
                    ]},
                    { runnerName: 'Hoàng Văn H', runs: [
                        { date: '2025-05-21', distance: 8.0, time: 40, type: 'Chạy bộ' },
                        { date: '2025-05-23', distance: 3.0, time: 45, type: 'Đi bộ' },
                        { date: '2025-05-25', distance: 15.0, time: 30, type: 'Đạp xe' }
                    ]},
                    { runnerName: 'Võ Trọng I', runs: [
                        { date: '2025-05-28', distance: 5.0, time: 20, type: 'Chạy bộ' },
                        { date: '2025-05-29', distance: 2.0, time: 10, type: 'Đi bộ' },
                        { date: '2025-05-30', distance: 1.0, time: 60, type: 'Leo núi' }
                    ]}
                ];
            }

            return processedClubData;
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await authenticateFirebase();
            const allClubData = loadRunsFromLocalStorage(); // Load data once on DOMContentLoaded
            generateActivityTypeFilters(allClubData); // Generate filters based on loaded data
            loadAndClassifyData(); // Initial load of data and classification

            const classifyBtn = document.getElementById('classifyBtn');
            const classifyCustomKm = document.getElementById('classifyCustomKm');
            const customKmInput = document.getElementById('customKmInput');
            const classify25km = document.getElementById('classify25km');
            const penaltyPerKmInput = document.getElementById('penaltyPerKm');
            const weekSelect = document.getElementById('week-select');
            const connectStravaBtn = document.getElementById('connect-strava-btn'); // Get the Strava connect button
            const stravaStatus = document.getElementById('strava-status');
            const stravaClubIdInput = document.getElementById('stravaClubIdInput'); // New input for Club ID


            const exportGoalMetBtn = document.getElementById('export-goal-met-btn');
            const exportGoalNotMetBtn = document.getElementById('export-goal-not-met-btn');
            const exportInvalidActivitiesBtn = document.getElementById('export-invalid-activities-btn');

            // Handle Strava connection button click
            connectStravaBtn.addEventListener('click', async () => {
                const clubId = stravaClubIdInput.value.trim();
                if (!clubId) {
                    displayMessageModal('Lỗi nhập liệu', 'Vui lòng nhập ID câu lạc bộ Strava.');
                    return;
                }

                // Call the function to fetch data from Edge Function
                const fetchedData = await fetchStravaClubActivitiesFromEdgeFunction(clubId);

                if (fetchedData) {
                    saveRunsToLocalStorage(fetchedData); // Save fetched data to local storage
                    generateActivityTypeFilters(fetchedData); // Regenerate filters based on new data
                    loadAndClassifyData(); // Re-classify data
                } else {
                    // If fetch failed, fallback to mock data or clear tables
                    stravaStatus.textContent = 'Không thể tải dữ liệu Strava. Đang sử dụng dữ liệu mẫu.';
                    const allClubData = loadRunsFromLocalStorage(); // Load mock data
                    generateActivityTypeFilters(allClubData);
                    loadAndClassifyData();
                }
            });


            // Toggle custom KM input based on radio button selection
            classifyCustomKm.addEventListener('change', () => {
                customKmInput.disabled = !classifyCustomKm.checked;
                if (classifyCustomKm.checked) {
                    customKmInput.focus();
                }
                // No need to call loadAndClassifyData here, it will be called by classifyBtn click or other changes
            });

            classify25km.addEventListener('change', () => {
                customKmInput.disabled = true;
                // No need to call loadAndClassifyData here
            });

            // Re-classify data when penalty amount changes
            penaltyPerKmInput.addEventListener('input', () => {
                loadAndClassifyData();
            });

            // Re-classify data when week selection changes
            weekSelect.addEventListener('change', () => {
                loadAndClassifyData();
            });

            // Handle classify button click with validation for custom KM
            classifyBtn.addEventListener('click', () => {
                const classificationType = document.querySelector('input[name="classificationType"]:checked').value;
                const customKmInput = document.getElementById('customKmInput');

                if (classificationType === 'custom') {
                    const customValue = parseFloat(customKmInput.value);
                    if (isNaN(customValue) || customValue <= 0) {
                        displayMessageModal('Lỗi nhập liệu', 'Vui lòng nhập một giá trị KM hợp lệ và lớn hơn 0 cho tiêu chí tùy chỉnh.');
                        // Prevent classification if invalid
                        return;
                    }
                }
                loadAndClassifyData(); // Proceed with classification if valid
            });

            // Export button listeners
            exportGoalMetBtn.addEventListener('click', () => {
                exportTableToCSV('goal-met-table', 'thanh_tich_dat_muc_tieu.csv');
            });
            exportGoalNotMetBtn.addEventListener('click', () => {
                exportTableToCSV('goal-not-met-table', 'thanh_tich_chua_dat_muc_tieU.csv');
            });
            exportInvalidActivitiesBtn.addEventListener('click', () => {
                exportTableToCSV('invalid-activities-table', 'hoat_dong_khong_hop_le.csv');
            });
        });
    </script>
</body>
</html>
