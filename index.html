import { serve } from 'https://deno.land/std@0.177.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// Định nghĩa các biến môi trường cần thiết
const STRAVA_CLIENT_ID = Deno.env.get('STRAVA_CLIENT_ID')
const STRAVA_CLIENT_SECRET = Deno.env.get('STRAVA_CLIENT_SECRET')
let STRAVA_REFRESH_TOKEN = Deno.env.get('STRAVA_REFRESH_TOKEN') // Sẽ được cập nhật nếu làm mới thành công

// Hàm để làm mới Strava Access Token
async function refreshStravaAccessToken(refreshToken: string): Promise<string | null> {
  const tokenUrl = 'https://www.strava.com/oauth/token'
  const params = new URLSearchParams({
    client_id: STRAVA_CLIENT_ID!,
    client_secret: STRAVA_CLIENT_SECRET!,
    refresh_token: refreshToken,
    grant_type: 'refresh_token',
  })

  try {
    const response = await fetch(tokenUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: params.toString(),
    })

    if (!response.ok) {
      const errorData = await response.json()
      console.error('Lỗi làm mới token Strava:', errorData)
      return null
    }

    const data = await response.json()
    console.log('Token Strava đã được làm mới thành công.')
    // Cập nhật refresh token nếu Strava trả về một cái mới (thường không xảy ra với refresh_token grant_type)
    if (data.refresh_token && data.refresh_token !== refreshToken) {
        STRAVA_REFRESH_TOKEN = data.refresh_token; // Cập nhật biến môi trường cục bộ
        // TODO: Trong một ứng dụng thực tế, bạn sẽ cần lưu refresh_token mới này vào database an toàn
        // hoặc một dịch vụ quản lý bí mật. Với Supabase, bạn có thể cân nhắc cập nhật nó trong một bảng.
        console.log('Refresh Token Strava đã được cập nhật.');
    }
    return data.access_token
  } catch (error) {
    console.error('Lỗi khi gọi API làm mới token Strava:', error)
    return null
  }
}

// Hàm chính của Edge Function
serve(async (req) => {
  if (req.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Chỉ chấp nhận phương thức POST' }), {
      headers: { 'Content-Type': 'application/json' },
      status: 405,
    })
  }

  const { clubId } = await req.json()

  if (!clubId) {
    return new Response(JSON.stringify({ error: 'Thiếu clubId' }), {
      headers: { 'Content-Type': 'application/json' },
      status: 400,
    })
  }

  if (!STRAVA_CLIENT_ID || !STRAVA_CLIENT_SECRET || !STRAVA_REFRESH_TOKEN) {
    console.error('Thiếu biến môi trường Strava.')
    return new Response(JSON.stringify({ error: 'Lỗi cấu hình server: Thiếu thông tin xác thực Strava.' }), {
      headers: { 'Content-Type': 'application/json' },
      status: 500,
    })
  }

  // 1. Làm mới Access Token
  const accessToken = await refreshStravaAccessToken(STRAVA_REFRESH_TOKEN)

  if (!accessToken) {
    return new Response(JSON.stringify({ error: 'Không thể làm mới Strava Access Token.' }), {
      headers: { 'Content-Type': 'application/json' },
      status: 500,
    })
  }

  // 2. Gọi Strava API để lấy hoạt động của câu lạc bộ
  try {
    const stravaApiUrl = `https://www.strava.com/api/v3/clubs/${clubId}/activities?per_page=200`
    const stravaResponse = await fetch(stravaApiUrl, {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      },
    })

    if (!stravaResponse.ok) {
      const errorData = await stravaResponse.json()
      console.error('Lỗi gọi API Strava:', errorData)
      return new Response(JSON.stringify({ error: `Lỗi từ Strava API: ${errorData.message || 'Unknown error'}` }), {
        headers: { 'Content-Type': 'application/json' },
        status: stravaResponse.status,
      })
    }

    const activities = await stravaResponse.json()
    return new Response(JSON.stringify({ activities }), {
      headers: { 'Content-Type': 'application/json' },
      status: 200,
    })
  } catch (error) {
    console.error('Lỗi khi gọi API Strava:', error)
    return new Response(JSON.stringify({ error: `Lỗi server khi lấy dữ liệu Strava: ${error.message}` }), {
      headers: { 'Content-Type': 'application/json' },
      status: 500,
    })
  }
})
