<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng Th·ªëng k√™ Ch·∫°y b·ªô - BIDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define BIDV brand colors as CSS variables for easy use */
        :root {
            --bidv-green: #006B68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Custom Tailwind classes using CSS variables */
        .bg-bidv-green { background-color: var(--bidv-green); }
        .text-bidv-green { color: var(--bidv-green); }
        .border-bidv-green { border-color: var(--bidv-green); }
        .hover\:bg-bidv-green-darker:hover { background-color: #005A58; } /* Slightly darker green for hover */

        .bg-bidv-yellow { background-color: var(--bidv-yellow); }
        .text-bidv-yellow { color: var(--bidv-yellow); }
        .border-bidv-yellow { border-color: var(--bidv-yellow); }
        .hover\:bg-bidv-yellow-darker:hover { background-color: #E6B32C; } /* Slightly darker yellow for hover */

        .focus\:ring-bidv-green:focus { --tw-ring-color: var(--bidv-green); }
        .focus\:ring-bidv-yellow:focus { --tw-ring-color: var(--bidv-yellow); }

        /* Loading spinner styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #006B68;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl w-full bg-white shadow-lg rounded-xl p-6 sm:p-8 space-y-8">
        <header class="text-center flex flex-col items-center">
            <img src="https://placehold.co/150x50/006B68/FFFFFF?text=BIDV+Logo" alt="BIDV Logo Placeholder" class="h-16 mb-4 rounded-md">
            <h1 class="text-3xl sm:text-4xl font-bold text-bidv-green mb-2">Th·ªëng k√™ Th√†nh t√≠ch C√¢u l·∫°c b·ªô Ch·∫°y b·ªô BIDV</h1>
            <p class="text-lg text-gray-600">Ph√¢n lo·∫°i v√† theo d√µi th√†nh t√≠ch ch·∫°y b·ªô c·ªßa c√°c th√†nh vi√™n</p>
        </header>

        <section class="bg-bidv-green bg-opacity-10 p-6 rounded-lg border border-bidv-green border-opacity-30">
            <h2 class="text-2xl font-semibold text-bidv-green mb-4">K·∫øt n·ªëi Strava</h2>
            <p class="text-gray-700 mb-4">
                ƒê·ªÉ l·∫•y d·ªØ li·ªáu th√†nh t√≠ch c·ªßa c√¢u l·∫°c b·ªô, b·∫°n c·∫ßn k·∫øt n·ªëi t√†i kho·∫£n Strava.
                <br><strong class="text-red-600">L∆∞u √Ω: ·ª®ng d·ª•ng n√†y g·ªçi ƒë·∫øn m·ªôt h√†m serverless ƒë·ªÉ b·∫£o m·∫≠t th√¥ng tin Strava API.</strong>
            </p>
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <label for="stravaClubIdInput" class="text-gray-700 text-lg font-medium">ID C√¢u l·∫°c b·ªô Strava:</label>
                <input type="text" id="stravaClubIdInput" class="flex-grow sm:max-w-xs p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-bidv-green focus:border-bidv-green transition duration-150 ease-in-out" placeholder="Nh·∫≠p ID c√¢u l·∫°c b·ªô">
            </div>
            <button id="connect-strava-btn" class="w-full bg-bidv-green hover:bg-bidv-green-darker text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-bidv-green focus:ring-opacity-50">
                T·∫£i D·ªØ li·ªáu Strava
            </button>
            <div id="strava-status" class="mt-2 text-sm text-gray-600 text-center"></div>
        </section>

        <section class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800">C√†i ƒë·∫∑t Th·ªëng k√™</h2>

            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label for="week-select" class="text-gray-700 text-lg font-medium">Ch·ªçn tu·∫ßn:</label>
                <select id="week-select" class="flex-grow sm:max-w-xs p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-bidv-green focus:border-bidv-green transition duration-150 ease-in-out">
                    <option value="week-current">Tu·∫ßn hi·ªán t·∫°i (26/05 - 01/06)</option>
                    <option value="week-1">Tu·∫ßn tr∆∞·ªõc (19/05 - 25/05)</option>
                    <option value="week-2">2 tu·∫ßn tr∆∞·ªõc (12/05 - 18/05)</option>
                </select>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Ti√™u ch√≠ Ph√¢n lo·∫°i theo KM/tu·∫ßn</h3>
                <div class="space-y-4">
                    <div class="flex items-center space-x-3">
                        <input type="radio" id="classify25km" name="classificationType" value="25" class="form-radio h-4 w-4 text-bidv-green focus:ring-bidv-green" checked>
                        <label for="classify25km" class="text-gray-700">Ph√¢n lo·∫°i theo 25 KM/tu·∫ßn</label>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input type="radio" id="classifyCustomKm" name="classificationType" value="custom" class="form-radio h-4 w-4 text-bidv-green focus:ring-bidv-green">
                        <label for="classifyCustomKm" class="text-gray-700">Ph√¢n lo·∫°i theo s·ªë KM/tu·∫ßn t√πy √Ω:</label>
                        <input type="number" id="customKmInput" class="ml-2 px-3 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-yellow focus:border-bidv-yellow sm:text-sm w-24" placeholder="KM" disabled>
                    </div>
                </div>
                <div class="mt-6">
                    <label for="penaltyPerKm" class="block text-sm font-medium text-gray-700 mb-1">S·ªë ti·ªÅn ph·∫°t/KM (VNƒê):</label>
                    <input type="number" id="penaltyPerKm" value="30000" class="mt-1 block w-full sm:w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-yellow focus:border-bidv-yellow sm:text-sm">
                </div>

                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">L·ªçc theo lo·∫°i h√¨nh ho·∫°t ƒë·ªông</h3>
                    <div id="activity-type-filters" class="flex flex-wrap gap-4">
                        </div>
                </div>

                <button id="classifyBtn" class="mt-6 w-full bg-bidv-yellow text-bidv-green font-semibold py-2 px-4 rounded-md hover:bg-bidv-yellow-darker focus:outline-none focus:ring-2 focus:ring-bidv-yellow focus:ring-offset-2 transition duration-150 ease-in-out shadow-md">
                    Ph√¢n lo·∫°i Th√†nh t√≠ch
                </button>
            </div>
        </section>

        <section class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800">Th·ªëng k√™ Th√†nh t√≠ch C√¢u l·∫°c b·ªô</h2>

            <div class="bg-white p-6 rounded-lg shadow-md border border-bidv-green border-opacity-30">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-bidv-green">V·∫≠n ƒë·ªông vi√™n ƒê·∫°t m·ª•c ti√™u <span id="goal-met-threshold"></span></h3>
                    <button id="export-goal-met-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xu·∫•t Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="goal-met-table">
                        <thead class="bg-bidv-green text-white">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    T√™n V·∫≠n ƒë·ªông vi√™n
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    T·ªïng KM Tu·∫ßn
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    S·ªë bu·ªïi
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    H√†nh ƒë·ªông
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="goal-met-table-body">
                            <tr>
                                <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    Ch∆∞a c√≥ v·∫≠n ƒë·ªông vi√™n n√†o ƒë·∫°t m·ª•c ti√™u.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">V·∫≠n ƒë·ªông vi√™n Ch∆∞a ƒë·∫°t m·ª•c ti√™u <span id="goal-not-met-threshold"></span></h3>
                    <button id="export-goal-not-met-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xu·∫•t Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="goal-not-met-table">
                        <thead class="bg-gray-200 text-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    T√™n V·∫≠n ƒë·ªông vi√™n
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    T·ªïng KM Tu·∫ßn
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    S·ªë bu·ªïi
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    S·ªë KM c√≤n thi·∫øu
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    S·ªë ti·ªÅn ph·∫°t
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    H√†nh ƒë·ªông
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="goal-not-met-table-body">
                            <tr>
                                <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    T·∫•t c·∫£ v·∫≠n ƒë·ªông vi√™n ƒë·ªÅu ƒë√£ ƒë·∫°t m·ª•c ti√™u.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-red-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-red-600">C√°c ho·∫°t ƒë·ªông kh√¥ng h·ª£p l·ªá (Pace <= 4 ho·∫∑c >= 14 ph√∫t/KM cho Ch·∫°y b·ªô/ƒêi b·ªô)</h3>
                    <button id="export-invalid-activities-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm hover:bg-gray-300 transition duration-150 ease-in-out">
                        Xu·∫•t Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="invalid-activities-table">
                        <thead class="bg-red-100 text-red-800">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                                    T√™n V·∫≠n ƒë·ªông vi√™n
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Ng√†y
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Lo·∫°i h√¨nh
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Qu√£ng ƒë∆∞·ªùng (KM)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Th·ªùi gian (ph√∫t)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                    Pace (ph√∫t/KM)
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                                    L√Ω do
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="invalid-activities-table-body">
                            <tr>
                                <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    Kh√¥ng c√≥ ho·∫°t ƒë·ªông kh√¥ng h·ª£p l·ªá n√†o.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div id="llm-analysis-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 sm:p-8 space-y-6 relative">
                <h2 class="text-3xl font-bold text-bidv-green text-center mb-4">Ph√¢n t√≠ch Th√†nh t√≠ch AI ‚ú®</h2>
                <button id="close-llm-analysis-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition duration-150 ease-in-out">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <div id="llm-analysis-content" class="space-y-4 max-h-96 overflow-y-auto pr-2 text-gray-700">
                    <div class="flex flex-col justify-center items-center h-full">
                        <div class="spinner"></div>
                        <p class="ml-3 text-lg font-medium">ƒêang t·∫°o ph√¢n t√≠ch...</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-8">
            &copy; 2025 Tr∆∞∆°ng H·ªìng Qu√¢n - C√¢u l·∫°c b·ªô Ch·∫°y b·ªô BIDV. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.
        </footer>
    </div>

    <script type="module">
        // ƒê·ªÉ ch·∫°y ·ª©ng d·ª•ng n√†y c·ª•c b·ªô, b·∫°n c·∫ßn s·ª≠ d·ª•ng m·ªôt m√°y ch·ªß web.
        // V√≠ d·ª•: M·ªü terminal trong th∆∞ m·ª•c n√†y v√† ch·∫°y `python -m http.server`
        // ho·∫∑c c√†i ƒë·∫∑t `serve` b·∫±ng `npm install -g serve` v√† ch·∫°y `serve`.

        // Import Firebase modules (not directly used for data persistence in this version)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // REMOVED: import { STRAVA_CLIENT_ID, STRAVA_CLUB_ID, STRAVA_ACCESS_TOKEN } from './config.js';
        // L√Ω do: C√°c th√¥ng tin nh·∫°y c·∫£m n√†y s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω an to√†n ·ªü ph√≠a serverless function (index.ts).

        // Firebase configuration (provided globally by Canvas environment)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null; // To store the authenticated user ID

        // Authenticate user
        async function authenticateFirebase() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase authentication successful.");
            } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        }

        // Listen for auth state changes to get the user ID
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("User ID:", currentUserId);
                // No need to load data immediately after firebase auth, it's now triggered by Strava button
            } else {
                currentUserId = null;
                console.log("No user signed in.");
                // Clear tables if no user, or keep mock data
                document.getElementById('goal-met-table-body').innerHTML = '<tr><td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i d·ªØ li·ªáu Strava.</td></tr>';
                document.getElementById('goal-not-met-table-body').innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i d·ªØ li·ªáu Strava.</td></tr>';
                document.getElementById('invalid-activities-table-body').innerHTML = '<tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i d·ªØ li·ªáu Strava.</td></tr>';
            }
        });

        // --- LOCAL STORAGE FUNCTIONS ---
        const LOCAL_STORAGE_KEY = 'bidvRunningClubData';

        function saveRunsToLocalStorage(runs) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(runs));
                console.log("Data saved to localStorage.");
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                displayMessageModal('L·ªói l∆∞u tr·ªØ', 'Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu v√†o b·ªô nh·ªõ c·ª•c b·ªô.');
            }
        }

        function loadRunsFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (data) {
                    console.log("Data loaded from localStorage.");
                    return JSON.parse(data);
                }
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                displayMessageModal('L·ªói t·∫£i d·ªØ li·ªáu', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ c·ª•c b·ªô. D·ªØ li·ªáu m·∫´u s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.');
            }
            // If no data or error, return default example data
            const defaultData = [
                { runnerName: 'Nguy·ªÖn VƒÉn A', runs: [
                    { date: '2025-05-20', distance: 10.5, time: 50, type: 'Ch·∫°y b·ªô' }, // Pace: 4.76
                    { date: '2025-05-22', distance: 8.0, time: 40, type: 'Ch·∫°y b·ªô' }, // Pace: 5.0
                    { date: '2025-05-24', distance: 7.0, time: 35, type: 'Ch·∫°y b·ªô' }  // Pace: 5.0
                ]},
                { runnerName: 'Tr·∫ßn Th·ªã B', runs: [
                    { date: '2025-05-21', distance: 12.0, time: 60, type: 'Ch·∫°y b·ªô' }, // Pace: 5.0
                    { date: '2025-05-23', distance: 10.0, time: 50, type: 'Ch·∫°y b·ªô' }, // Pace: 5.0
                    { date: '2025-05-25', distance: 5.0, time: 25, type: 'ƒêi b·ªô' }  // Pace: 5.0
                ]},
                { runnerName: 'L√™ VƒÉn C', runs: [
                    { date: '2025-05-20', distance: 15.0, time: 70, type: 'Ch·∫°y b·ªô' }, // Pace: 4.67
                    { date: '2025-05-22', distance: 10.0, time: 45, type: 'Ch·∫°y b·ªô' }, // Pace: 4.5
                    { date: '2025-05-24', distance: 12.0, time: 55, type: 'ƒê·∫°p xe' }, // Pace: 4.58 (not subject to pace rule)
                    { date: '2025-05-26', distance: 8.0, time: 40, type: 'Ch·∫°y b·ªô' }  // Pace: 5.0
                ]},
                { runnerName: 'Ph·∫°m Th·ªã D', runs: [
                    { date: '2025-05-21', distance: 6.0, time: 30, type: 'ƒêi b·ªô' }, // Pace: 5.0
                    { date: '2025-05-23', distance: 7.5, time: 38, type: 'ƒêi b·ªô' }, // Pace: 5.07
                    { date: '2025-05-24', distance: 1.0, time: 15, type: 'ƒêi b·ªô' }  // Pace: 15.0 (Invalid)
                ]},
                { runnerName: 'V≈© Minh E', runs: [
                    { date: '2025-05-20', distance: 2.0, time: 15, type: 'Ch·∫°y b·ªô' }, // Pace: 7.5
                    { date: '2025-05-25', distance: 3.0, time: 20, type: 'ƒêi b·ªô' }, // Pace: 6.67
                    { date: '2025-05-26', distance: 5.0, time: 10, type: 'B∆°i l·ªôi' }  // Pace: 2.0 (not subject to pace rule)
                ]},
                { runnerName: 'ƒê·∫∑ng Th·ªã F', runs: [
                    { date: '2025-05-27', distance: 20.0, time: 40, type: 'ƒê·∫°p xe' }, // Pace: 2.0 (not subject to pace rule)
                    { date: '2025-05-28', distance: 1.0, time: 20, type: 'ƒêi b·ªô' } // Pace: 20.0 (Invalid)
                ]},
                { runnerName: 'Nguy·ªÖn Thanh G', runs: [
                    { date: '2025-05-20', distance: 1.0, time: 5, type: 'B∆°i l·ªôi' },
                    { date: '2025-05-22', distance: 10.0, time: 25, type: 'ƒê·∫°p xe' },
                    { date: '2025-05-24', distance: 0.5, time: 30, type: 'Yoga' }
                ]},
                { runnerName: 'Ho√†ng VƒÉn H', runs: [
                    { date: '2025-05-21', distance: 8.0, time: 40, type: 'Ch·∫°y b·ªô' },
                    { date: '2025-05-23', distance: 3.0, time: 45, type: 'ƒêi b·ªô' }, // Pace: 15.0 (Invalid)
                    { date: '2025-05-25', distance: 15.0, time: 30, type: 'ƒê·∫°p xe' }
                ]},
                { runnerName: 'V√µ Tr·ªçng I', runs: [
                    { date: '2025-05-28', distance: 5.0, time: 20, type: 'Ch·∫°y b·ªô' },
                    { date: '2025-05-29', distance: 2.0, time: 10, type: 'ƒêi b·ªô' },
                    { date: '2025-05-30', distance: 1.0, time: 60, type: 'Leo n√∫i' } // New activity type
                ]}
            ];
            // Save default data to localStorage if it's being used for the first time
            saveRunsToLocalStorage(defaultData);
            return defaultData;
        }

        // Mapping for activity types to emojis
        const activityTypeEmojis = {
            'Ch·∫°y b·ªô': 'üèÉ‚Äç‚ôÇÔ∏è',
            'ƒêi b·ªô': 'üö∂‚Äç‚ôÄÔ∏è',
            'ƒê·∫°p xe': 'üö¥‚Äç‚ôÇÔ∏è',
            'B∆°i l·ªôi': 'üèä‚Äç‚ôÄÔ∏è',
            'Yoga': 'üßò‚Äç‚ôÄÔ∏è',
            'Leo n√∫i': 'üßó‚Äç‚ôÇÔ∏è',
            'Kh√°c': '‚ùì'
        };

        // Function to generate activity type checkboxes dynamically
        function generateActivityTypeFilters(allClubData) {
            const activityTypeFilterDiv = document.getElementById('activity-type-filters');
            activityTypeFilterDiv.innerHTML = ''; // Clear existing filters

            const uniqueActivityTypes = new Set();
            allClubData.forEach(member => {
                member.runs.forEach(run => {
                    uniqueActivityTypes.add(run.type);
                });
            });

            // Ensure common types are always available, even if not in current data
            const commonTypes = ['Ch·∫°y b·ªô', 'ƒêi b·ªô', 'ƒê·∫°p xe', 'B∆°i l·ªôi', 'Yoga', 'Leo n√∫i', 'Kh√°c'];
            commonTypes.forEach(type => uniqueActivityTypes.add(type));

            const sortedTypes = Array.from(uniqueActivityTypes).sort();

            sortedTypes.forEach(type => {
                const label = document.createElement('label');
                label.className = 'flex items-center';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'activityType';
                checkbox.value = type;
                checkbox.className = 'form-checkbox h-5 w-5 text-bidv-green rounded';

                // Default check for 'Ch·∫°y b·ªô' and 'ƒêi b·ªô'
                if (type === 'Ch·∫°y b·ªô' || type === 'ƒêi b·ªô') {
                    checkbox.checked = true;
                }

                const span = document.createElement('span');
                span.className = 'ml-2 text-gray-700';
                span.textContent = `${activityTypeEmojis[type] || ''} ${type}`;

                label.appendChild(checkbox);
                label.appendChild(span);
                activityTypeFilterDiv.appendChild(label);

                // Attach event listener immediately
                checkbox.addEventListener('change', () => {
                    loadAndClassifyData();
                });
            });
        }


        // Function to process and display runs based on classification
        function loadAndClassifyData() {
            const classificationType = document.querySelector('input[name="classificationType"]:checked').value;
            let threshold = 25; // Default to 25 KM

            // Enable/disable custom KM input based on radio button selection
            const customKmInput = document.getElementById('customKmInput');
            if (classificationType === 'custom') {
                customKmInput.disabled = false; // Enable input
                const customValue = parseFloat(customKmInput.value);
                // If custom is selected but value is invalid, use default 25 for calculation
                // The error message will be shown when classifyBtn is clicked, not here.
                if (!isNaN(customValue) && customValue > 0) {
                    threshold = customValue;
                } else {
                    threshold = 25; // Use a fallback threshold for display/initial calculation
                }
            } else {
                customKmInput.disabled = true; // Disable input
            }


            const penaltyPerKmInput = document.getElementById('penaltyPerKm');
            let penaltyPerKm = parseFloat(penaltyPerKmInput.value);
            if (isNaN(penaltyPerKm) || penaltyPerKm < 0) {
                displayMessageModal('L·ªói nh·∫≠p li·ªáu', 'Vui l√≤ng nh·∫≠p m·ªôt gi√° tr·ªã ti·ªÅn ph·∫°t h·ª£p l·ªá (s·ªë kh√¥ng √¢m).');
                penaltyPerKm = 30000;
                penaltyPerKmInput.value = 30000;
            }

            // Get selected activity types
            let selectedActivityTypes = Array.from(document.querySelectorAll('input[name="activityType"]:checked')).map(cb => cb.value);
            if (selectedActivityTypes.length === 0) {
                // This block handles the case where user unchecks all boxes
                displayMessageModal('L·ªói l·ªçc ho·∫°t ƒë·ªông', 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt lo·∫°i h√¨nh ho·∫°t ƒë·ªông ƒë·ªÉ th·ªëng k√™. M·∫∑c ƒë·ªãnh s·∫Ω s·ª≠ d·ª•ng "Ch·∫°y b·ªô" v√† "ƒêi b·ªô" cho vi·ªác ph√¢n lo·∫°i.');
                // For classification logic, use default types if none are selected by the user
                selectedActivityTypes = ['Ch·∫°y b·ªô', 'ƒêi b·ªô'];
                // DO NOT attempt to set .checked = true here, as it causes the error.
                // The UI state should be managed by user interaction or initial generation.
            }


            document.getElementById('goal-met-threshold').textContent = `(M·ª•c ti√™u: ${threshold} KM)`;
            document.getElementById('goal-not-met-threshold').textContent = `(M·ª•c ti√™u: ${threshold} KM)`;

            const allClubData = loadRunsFromLocalStorage(); // Load data from localStorage

            const goalMetMembers = [];
            const goalNotMetMembers = [];
            const invalidActivities = []; // New array for invalid activities (all types, but pace rule only for running/walking)

            // Process each member's runs
            allClubData.forEach(member => {
                let memberValidRunsForSelectedTypes = []; // Runs that are valid pace-wise AND of selected types
                let totalDistanceForSelectedTypes = 0;
                let totalSessionsForSelectedTypes = 0;

                member.runs.forEach(run => {
                    const pace = run.distance > 0 ? (run.time / run.distance) : 0; // Calculate pace, handle distance=0

                    // Check for invalid pace ONLY for 'Ch·∫°y b·ªô' and 'ƒêi b·ªô'
                    const isRunningOrWalking = (run.type === 'Ch·∫°y b·ªô' || run.type === 'ƒêi b·ªô');
                    const isPaceInvalid = (pace <= 4 || pace >= 14);

                    if (isRunningOrWalking && isPaceInvalid) {
                        invalidActivities.push({
                            runnerName: member.runnerName,
                            date: run.date,
                            type: run.type, // Include type in invalid activities
                            distance: run.distance,
                            time: run.time,
                            pace: pace.toFixed(2),
                            reason: pace <= 4 ? 'Pace qu√° nhanh (<4 ph√∫t/KM)' : 'Pace qu√° ch·∫≠m (>14 ph√∫t/KM)'
                        });
                    } else {
                        // Activity is valid pace-wise (or not subject to pace rule)
                        // Now check if it's one of the selected activity types for main tables
                        if (selectedActivityTypes.includes(run.type)) {
                            memberValidRunsForSelectedTypes.push(run);
                            totalDistanceForSelectedTypes += run.distance;
                            totalSessionsForSelectedTypes++;
                        }
                    }
                });

                // Only add to goal tables if there are valid runs for the member for selected types
                // A member is included if they have any valid runs for the selected types, even if total distance is 0
                if (memberValidRunsForSelectedTypes.length > 0) {
                    const memberStats = {
                        runnerName: member.runnerName,
                        totalDistance: totalDistanceForSelectedTypes.toFixed(1),
                        totalSessions: totalSessionsForSelectedTypes,
                        rawRuns: memberValidRunsForSelectedTypes // Store only valid runs (pace-wise & type-wise) for LLM analysis
                    };

                    if (totalDistanceForSelectedTypes >= threshold) {
                        goalMetMembers.push(memberStats);
                    } else {
                        const kmDeficit = threshold - totalDistanceForSelectedTypes;
                        memberStats.kmDeficit = (kmDeficit > 0 ? kmDeficit : 0).toFixed(1);
                        memberStats.penaltyAmount = (kmDeficit > 0 ? kmDeficit : 0) * penaltyPerKm;
                        goalNotMetMembers.push(memberStats);
                    }
                }
            });

            renderTable(document.getElementById('goal-met-table-body'), goalMetMembers, 'Ch∆∞a c√≥ v·∫≠n ƒë·ªông vi√™n n√†o ƒë·∫°t m·ª•c ti√™u.', threshold, false);
            renderTable(document.getElementById('goal-not-met-table-body'), goalNotMetMembers, 'T·∫•t c·∫£ v·∫≠n ƒë·ªông vi√™n ƒë·ªÅu ƒë√£ ƒë·∫°t m·ª•c ti√™u.', threshold, true);
            renderInvalidActivitiesTable(document.getElementById('invalid-activities-table-body'), invalidActivities, 'Kh√¥ng c√≥ ho·∫°t ƒë·ªông kh√¥ng h·ª£p l·ªá n√†o.');
        }

        // Helper function to render a table (for goal-met and goal-not-met)
        function renderTable(tableBodyElement, data, emptyMessage, threshold, includePenaltyAndDeficitColumns) {
            tableBodyElement.innerHTML = ''; // Clear previous rows

            const tableElement = tableBodyElement.closest('table');
            const tableHeadRow = tableElement.querySelector('thead tr');

            if (!tableHeadRow) {
                console.error("Error: Thead row not found for table.", tableElement);
                return;
            }

            // Define base headers for the goal tables
            const baseHeaders = [
                { text: 'T√™n V·∫≠n ƒë·ªông vi√™n', class: 'rounded-tl-lg' },
                { text: 'T·ªïng KM Tu·∫ßn' },
                { text: 'S·ªë bu·ªïi' }
            ];
            const actionHeader = { text: 'H√†nh ƒë·ªông', class: 'rounded-tr-lg' }; // Always present, always last

            // Clear existing headers to rebuild them correctly
            tableHeadRow.innerHTML = '';

            // Add base headers
            baseHeaders.forEach(header => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = `px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${header.class || ''}`;
                th.textContent = header.text;
                tableHeadRow.appendChild(th);
            });

            // Add dynamic headers if required
            if (includePenaltyAndDeficitColumns) {
                const kmDeficitHeader = document.createElement('th');
                kmDeficitHeader.scope = 'col';
                kmDeficitHeader.className = 'px-6 py-3 text-left text-xs font-medium uppercase tracking-wider';
                kmDeficitHeader.textContent = 'S·ªë KM c√≤n thi·∫øu';
                tableHeadRow.appendChild(kmDeficitHeader);

                const penaltyHeader = document.createElement('th');
                penaltyHeader.scope = 'col';
                penaltyHeader.className = 'px-6 py-3 text-left text-xs font-medium uppercase tracking-wider';
                penaltyHeader.textContent = 'S·ªë ti·ªÅn ph·∫°t';
                tableHeadRow.appendChild(penaltyHeader);
            }

            // Add action header (always last)
            const thAction = document.createElement('th');
            thAction.scope = 'col';
            thAction.className = `px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${actionHeader.class || ''}`;
            thAction.textContent = actionHeader.text;
            tableHeadRow.appendChild(thAction);


            if (data.length === 0) {
                const noDataRow = document.createElement('tr');
                // Calculate colspan based on whether dynamic columns are included
                const colspan = includePenaltyAndDeficitColumns ? 6 : 4;
                noDataRow.innerHTML = `
                    <td colspan="${colspan}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        ${emptyMessage}
                    </td>
                `;
                tableBodyElement.appendChild(noDataRow);
            } else {
                data.forEach(member => {
                    const row = document.createElement('tr');
                    let dynamicCells = '';
                    if (includePenaltyAndDeficitColumns) {
                        dynamicCells = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.kmDeficit} KM</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${member.penaltyAmount.toLocaleString('vi-VN')} VNƒê</td>
                        `;
                    }
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.runnerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.totalDistance} KM</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.totalSessions}</td>
                        ${dynamicCells}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <button class="analyze-btn bg-bidv-green text-white px-3 py-1 rounded-md text-xs hover:bg-bidv-green-darker transition duration-150 ease-in-out"
                                data-runner-name="${member.runnerName}"
                                data-total-km="${member.totalDistance}"
                                data-total-sessions="${member.totalSessions}"
                                data-threshold="${threshold}"
                                data-raw-runs='${JSON.stringify(member.rawRuns)}'
                            >
                                ‚ú® Ph√¢n t√≠ch
                            </button>
                        </td>
                    `;
                    tableBodyElement.appendChild(row);
                });
            }
            attachAnalyzeButtonListeners();
        }

        // Helper function to render the Invalid Activities table
        function renderInvalidActivitiesTable(tableBodyElement, data, emptyMessage) {
            tableBodyElement.innerHTML = ''; // Clear previous rows

            // Update the header for the invalid activities table to include "Lo·∫°i h√¨nh"
            const tableElement = tableBodyElement.closest('table');
            const tableHeadRow = tableElement.querySelector('thead tr');
            // Rebuild headers for invalid activities table for consistency
            tableHeadRow.innerHTML = `
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tl-lg">
                    T√™n V·∫≠n ƒë·ªông vi√™n
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Ng√†y
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Lo·∫°i h√¨nh
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Qu√£ng ƒë∆∞·ªùng (KM)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Th·ªùi gian (ph√∫t)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                    Pace (ph√∫t/KM)
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider rounded-tr-lg">
                    L√Ω do
                </th>
            `;


            if (data.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        ${emptyMessage}
                    </td>
                `;
                tableBodyElement.appendChild(noDataRow);
            } else {
                data.forEach(activity => {
                    const row = document.createElement('tr');
                    const emoji = activityTypeEmojis[activity.type] || ''; // Get emoji for type
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${activity.runnerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${emoji} ${activity.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.distance} KM</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.time} ph√∫t</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${activity.pace}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${activity.reason}</td>
                    `;
                    tableBodyElement.appendChild(row);
                });
            }
        }

        // Function to attach event listeners to "Analyze" buttons
        function attachAnalyzeButtonListeners() {
            document.querySelectorAll('.analyze-btn').forEach(button => {
                button.removeEventListener('click', handleAnalyzeClick); // Prevent duplicate listeners
                button.addEventListener('click', handleAnalyzeClick);
            });
        }

        // Handle click on "Analyze" button
        async function handleAnalyzeClick(event) {
            const runnerName = event.target.dataset.runnerName;
            const totalKm = event.target.dataset.totalKm;
            const totalSessions = event.target.dataset.totalSessions;
            const threshold = event.target.dataset.threshold;
            const rawRuns = JSON.parse(event.target.dataset.rawRuns);

            const llmAnalysisModal = document.getElementById('llm-analysis-modal');
            const llmAnalysisContent = document.getElementById('llm-analysis-content');

            // Show modal and loading spinner
            llmAnalysisModal.classList.remove('hidden');
            llmAnalysisContent.innerHTML = `
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="spinner"></div>
                    <p class="ml-3 text-lg font-medium text-gray-700 mt-4">ƒêang t·∫°o ph√¢n t√≠ch...</p>
                </div>
            `;

            // Construct prompt for LLM
            let prompt = `B·∫°n l√† m·ªôt hu·∫•n luy·ªán vi√™n ch·∫°y b·ªô AI. H√£y ph√¢n t√≠ch th√†nh t√≠ch ch·∫°y b·ªô h√†ng tu·∫ßn c·ªßa v·∫≠n ƒë·ªông vi√™n ${runnerName} v√† ƒë∆∞a ra l·ªùi khuy√™n c√° nh√¢n h√≥a.

            Th√¥ng tin th√†nh t√≠ch tu·∫ßn:
            - T·ªïng qu√£ng ƒë∆∞·ªùng: ${totalKm} KM
            - T·ªïng s·ªë bu·ªïi ch·∫°y: ${totalSessions} bu·ªïi
            - M·ª•c ti√™u KM tu·∫ßn: ${threshold} KM

            Chi ti·∫øt c√°c bu·ªïi ch·∫°y h·ª£p l·ªá (ƒë√£ l·ªçc pace kh√¥ng h·ª£p l·ªá):
            `;
            if (rawRuns && rawRuns.length > 0) {
                rawRuns.forEach(run => {
                    const emoji = activityTypeEmojis[run.type] || '';
                    prompt += `- Ng√†y ${run.date}: ${run.distance} KM trong ${run.time} ph√∫t (${emoji} ${run.type}).\n`;
                });
            } else {
                prompt += `- Kh√¥ng c√≥ chi ti·∫øt bu·ªïi ch·∫°y c·ª• th·ªÉ h·ª£p l·ªá trong c√°c lo·∫°i h√¨nh ƒë√£ ch·ªçn.\n`;
            }

            if (parseFloat(totalKm) >= parseFloat(threshold)) {
                prompt += `\nV·∫≠n ƒë·ªông vi√™n n√†y ƒë√£ ƒë·∫°t ho·∫∑c v∆∞·ª£t m·ª•c ti√™u ${threshold} KM/tu·∫ßn. H√£y ƒë∆∞a ra l·ªùi khen ng·ª£i v√† g·ª£i √Ω ƒë·ªÉ duy tr√¨ ho·∫∑c n√¢ng cao th√†nh t√≠ch m·ªôt c√°ch b·ªÅn v·ªØng.`;
            } else {
                prompt += `\nV·∫≠n ƒë·ªông vi√™n n√†y ch∆∞a ƒë·∫°t m·ª•c ti√™u ${threshold} KM/tu·∫ßn. H√£y ƒë∆∞a ra l·ªùi ƒë·ªông vi√™n, ph√¢n t√≠ch nguy√™n nh√¢n ti·ªÅm ·∫©n (n·∫øu c√≥ th·ªÉ suy lu·∫≠n t·ª´ d·ªØ li·ªáu), v√† g·ª£i √Ω c√°c b∆∞·ªõc c·ª• th·ªÉ ƒë·ªÉ c·∫£i thi·ªán th√†nh t√≠ch trong tu·∫ßn t·ªõi.`;
            }

            prompt += `\nH√£y vi·∫øt c√¢u tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát, th√¢n thi·ªán, d·ªÖ hi·ªÉu, v√† t·∫≠p trung v√†o vi·ªác khuy·∫øn kh√≠ch, ƒë·ªông vi√™n.`;

            // Call Gemini API
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Leave this as-is; Canvas will provide the key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    llmAnalysisContent.innerHTML = `<p class="whitespace-pre-wrap">${text}</p>`; // Use pre-wrap to preserve formatting
                } else {
                    llmAnalysisContent.innerHTML = '<p class="text-red-500">Kh√¥ng th·ªÉ t·∫°o ph√¢n t√≠ch. C·∫•u tr√∫c ph·∫£n h·ªìi kh√¥ng mong mu·ªën.</p>';
                    console.error("Unexpected LLM response structure:", result);
                }
            } catch (error) {
                llmAnalysisContent.innerHTML = `<p class="text-red-500">ƒê√£ x·∫£y ra l·ªói khi t·∫°o ph√¢n t√≠ch: ${error.message}.</p>`;
                console.error("Error calling Gemini API:", error);
            }
        }

        // Close LLM Analysis Modal
        document.getElementById('close-llm-analysis-btn').addEventListener('click', () => {
            document.getElementById('llm-analysis-modal').classList.add('hidden');
        });

        // Hide modal if clicked outside
        document.getElementById('llm-analysis-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('llm-analysis-modal')) {
                document.getElementById('llm-analysis-modal').classList.add('hidden');
            }
        });

        // Custom message box function (instead of alert)
        function displayMessageModal(title, message) {
            const modalHtml = `
                <div id="custom-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[9999]">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4 relative">
                        <h3 class="text-xl font-bold text-bidv-green mb-2">${title}</h3>
                        <p class="text-gray-700">${message}</p>
                        <button id="close-custom-message-btn" class="w-full bg-bidv-green text-white py-2 px-4 rounded-md hover:bg-bidv-green-darker focus:outline-none focus:ring-2 focus:ring-bidv-green focus:ring-offset-2 transition duration-150 ease-in-out">
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('close-custom-message-btn').addEventListener('click', () => {
                document.getElementById('custom-message-modal').remove();
            });

            document.getElementById('custom-message-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('custom-message-modal')) {
                    document.getElementById('custom-message-modal').remove();
                }
            });
        }

        // --- EXPORT TO CSV FUNCTIONALITY ---
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                console.error(`Table with ID "${tableId}" not found.`);
                displayMessageModal('L·ªói xu·∫•t file', `Kh√¥ng t√¨m th·∫•y b·∫£ng ƒë·ªÉ xu·∫•t d·ªØ li·ªáu.`);
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll('tr');

            // Get headers
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                let headers = Array.from(headerRow.querySelectorAll('th'))
                               .map(th => `"${th.textContent.trim().replace(/"/g, '""')}"`);
                csv.push(headers.join(','));
            }

            // Get data rows
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                // Skip empty message row
                if (row.querySelector('td[colspan]')) {
                    return;
                }
                let rowData = Array.from(row.querySelectorAll('td'))
                               .map(td => {
                                   let text = td.textContent.trim();
                                   // Remove emojis for cleaner CSV output if desired, or keep them
                                   text = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').trim();
                                   // Handle commas and quotes in data
                                   return `"${text.replace(/"/g, '""')}"`;
                               });
                csv.push(rowData.join(','));
            });

            const csvString = csv.join('\n');
            // Prepend UTF-8 BOM
            const BOM = "\uFEFF"; // UTF-8 Byte Order Mark
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                displayMessageModal('L·ªói xu·∫•t file', 'Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ t·∫£i file tr·ª±c ti·∫øp.');
            }
        }

        // --- UPDATED STRAVA API CALL LOGIC TO USE EDGE FUNCTION ---
        // Function to fetch club activities from Supabase Edge Function
        async function fetchStravaClubActivitiesFromEdgeFunction(clubId) {
            const stravaStatus = document.getElementById('strava-status');
            stravaStatus.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Strava (qua Edge Function)...';

            // Replace with the actual URL of your deployed Supabase Edge Function
            // Example: https://your-project-ref.supabase.co/functions/v1/strava-api
            const EDGE_FUNCTION_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/rapid-api'; // <<< C·∫ßn thay th·∫ø

            if (EDGE_FUNCTION_URL === 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/rapid-api' || !clubId) {
                displayMessageModal('L·ªói c·∫•u h√¨nh', 'Vui l√≤ng nh·∫≠p ID c√¢u l·∫°c b·ªô Strava v√† thay th·∫ø https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/rapid-api b·∫±ng URL Edge Function th·∫≠t c·ªßa b·∫°n.');
                stravaStatus.textContent = 'L·ªói c·∫•u h√¨nh ho·∫∑c thi·∫øu ID c√¢u l·∫°c b·ªô.';
                return null;
            }

            try {
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ clubId: clubId }) // G·ª≠i clubId qua body POST
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu t·ª´ Edge Function: ${response.status} - ${errorDetails.error || 'Unknown error'}`);
                }

                const data = await response.json();
                // data.activities s·∫Ω ch·ª©a danh s√°ch ho·∫°t ƒë·ªông t·ª´ Edge Function
                // data.members s·∫Ω ch·ª©a danh s√°ch th√†nh vi√™n t·ª´ Edge Function
                // B·∫°n c·∫ßn √°nh x·∫° d·ªØ li·ªáu n√†y sang ƒë·ªãnh d·∫°ng m√† loadRunsFromLocalStorage mong ƒë·ª£i.
                // D·ªØ li·ªáu m·∫´u d∆∞·ªõi ƒë√¢y l√† v√≠ d·ª• v·ªÅ c√°ch b·∫°n c√≥ th·ªÉ chuy·ªÉn ƒë·ªïi.

                // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c t·ª´ Edge Function sang ƒë·ªãnh d·∫°ng c·ªßa b·∫°n
                // ƒê√¢y l√† m·ªôt v√≠ d·ª• ƒë∆°n gi·∫£n, b·∫°n c·∫ßn ƒëi·ªÅu ch·ªânh cho ph√π h·ª£p v·ªõi c·∫•u tr√∫c d·ªØ li·ªáu Strava th·ª±c t·∫ø
                // v√† c√°ch b·∫°n mu·ªën l∆∞u tr·ªØ n√≥.
                const processedData = processStravaData(data.activities, data.members);

                stravaStatus.textContent = 'ƒê√£ t·∫£i d·ªØ li·ªáu th√†nh c√¥ng t·ª´ Strava (qua Edge Function)!';
                return processedData;

            } catch (error) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu Strava t·ª´ Edge Function:", error);
                stravaStatus.textContent = `L·ªói: ${error.message}. Ki·ªÉm tra URL Edge Function ho·∫∑c ID c√¢u l·∫°c b·ªô.`;
                displayMessageModal('L·ªói t·∫£i d·ªØ li·ªáu Strava', `Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}.`);
                return null; // Return null on error
            }
        }

        // H√†m gi·∫£ ƒë·ªãnh ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ Strava API (qua Edge Function)
        // B·∫°n c·∫ßn ƒëi·ªÅu ch·ªânh h√†m n√†y ƒë·ªÉ ph√π h·ª£p v·ªõi c·∫•u tr√∫c d·ªØ li·ªáu th·ª±c t·∫ø t·ª´ Strava API
        // v√† c√°ch b·∫°n mu·ªën t·ªï ch·ª©c d·ªØ li·ªáu cho ·ª©ng d·ª•ng c·ªßa m√¨nh.
        function processStravaData(stravaActivities, stravaMembers) {
            const processedClubData = [];
            const memberMap = new Map(); // Map athlete ID to runnerName

            // Populate member map
            stravaMembers.forEach(member => {
                memberMap.set(member.athlete.id, `${member.athlete.firstname} ${member.athlete.lastname}`);
            });

            // Aggregate activities by runner
            const runnerActivities = new Map();

            stravaActivities.forEach(activity => {
                const runnerId = activity.athlete.id;
                const runnerName = memberMap.get(runnerId) || `${activity.athlete.firstname} ${activity.athlete.lastname}`; // Fallback if not in members list

                if (!runnerActivities.has(runnerName)) {
                    runnerActivities.set(runnerName, []);
                }

                // Convert meters to KM and seconds to minutes
                const distanceKm = activity.distance / 1000;
                const timeMinutes = activity.moving_time / 60;
                const activityType = activity.type === 'Run' ? 'Ch·∫°y b·ªô' :
                                     activity.type === 'Walk' ? 'ƒêi b·ªô' :
                                     activity.type === 'Ride' ? 'ƒê·∫°p xe' :
                                     activity.type === 'Swim' ? 'B∆°i l·ªôi' :
                                     'Kh√°c'; // Map Strava types to your types

                runnerActivities.get(runnerName).push({
                    date: activity.start_date.split('T')[0], // Get just the date part
                    distance: parseFloat(distanceKm.toFixed(1)),
                    time: parseFloat(timeMinutes.toFixed(1)),
                    type: activityType
                });
            });

            // Convert map to array format
            runnerActivities.forEach((runs, runnerName) => {
                processedClubData.push({
                    runnerName: runnerName,
                    runs: runs
                });
            });

            // If no data from Strava, or for initial load, use mock data
            if (processedClubData.length === 0) {
                console.warn("No data processed from Strava, falling back to mock data.");
                return [
                    { runnerName: 'Nguy·ªÖn VƒÉn A', runs: [
                        { date: '2025-05-20', distance: 10.5, time: 50, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-22', distance: 8.0, time: 40, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-24', distance: 7.0, time: 35, type: 'Ch·∫°y b·ªô' }
                    ]},
                    { runnerName: 'Tr·∫ßn Th·ªã B', runs: [
                        { date: '2025-05-21', distance: 12.0, time: 60, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-23', distance: 10.0, time: 50, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-25', distance: 5.0, time: 25, type: 'ƒêi b·ªô' }
                    ]},
                    { runnerName: 'L√™ VƒÉn C', runs: [
                        { date: '2025-05-20', distance: 15.0, time: 70, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-22', distance: 10.0, time: 45, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-24', distance: 12.0, time: 55, type: 'ƒê·∫°p xe' },
                        { date: '2025-05-26', distance: 8.0, time: 40, type: 'Ch·∫°y b·ªô' }
                    ]},
                    { runnerName: 'Ph·∫°m Th·ªã D', runs: [
                        { date: '2025-05-21', distance: 6.0, time: 30, type: 'ƒêi b·ªô' },
                        { date: '2025-05-23', distance: 7.5, time: 38, type: 'ƒêi b·ªô' },
                        { date: '2025-05-24', distance: 1.0, time: 15, type: 'ƒêi b·ªô' }
                    ]},
                    { runnerName: 'V≈© Minh E', runs: [
                        { date: '2025-05-20', distance: 2.0, time: 15, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-25', distance: 3.0, time: 20, type: 'ƒêi b·ªô' },
                        { date: '2025-05-26', distance: 5.0, time: 10, type: 'B∆°i l·ªôi' }
                    ]},
                    { runnerName: 'ƒê·∫∑ng Th·ªã F', runs: [
                        { date: '2025-05-27', distance: 20.0, time: 40, type: 'ƒê·∫°p xe' },
                        { date: '2025-05-28', distance: 1.0, time: 20, type: 'ƒêi b·ªô' }
                    ]},
                    { runnerName: 'Nguy·ªÖn Thanh G', runs: [
                        { date: '2025-05-20', distance: 1.0, time: 5, type: 'B∆°i l·ªôi' },
                        { date: '2025-05-22', distance: 10.0, time: 25, type: 'ƒê·∫°p xe' },
                        { date: '2025-05-24', distance: 0.5, time: 30, type: 'Yoga' }
                    ]},
                    { runnerName: 'Ho√†ng VƒÉn H', runs: [
                        { date: '2025-05-21', distance: 8.0, time: 40, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-23', distance: 3.0, time: 45, type: 'ƒêi b·ªô' },
                        { date: '2025-05-25', distance: 15.0, time: 30, type: 'ƒê·∫°p xe' }
                    ]},
                    { runnerName: 'V√µ Tr·ªçng I', runs: [
                        { date: '2025-05-28', distance: 5.0, time: 20, type: 'Ch·∫°y b·ªô' },
                        { date: '2025-05-29', distance: 2.0, time: 10, type: 'ƒêi b·ªô' },
                        { date: '2025-05-30', distance: 1.0, time: 60, type: 'Leo n√∫i' }
                    ]}
                ];
            }

            return processedClubData;
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await authenticateFirebase();
            const allClubData = loadRunsFromLocalStorage(); // Load data once on DOMContentLoaded
            generateActivityTypeFilters(allClubData); // Generate filters based on loaded data
            loadAndClassifyData(); // Initial load of data and classification

            const classifyBtn = document.getElementById('classifyBtn');
            const classifyCustomKm = document.getElementById('classifyCustomKm');
            const customKmInput = document.getElementById('customKmInput');
            const classify25km = document.getElementById('classify25km');
            const penaltyPerKmInput = document.getElementById('penaltyPerKm');
            const weekSelect = document.getElementById('week-select');
            const connectStravaBtn = document.getElementById('connect-strava-btn'); // Get the Strava connect button
            const stravaStatus = document.getElementById('strava-status');
            const stravaClubIdInput = document.getElementById('stravaClubIdInput'); // New input for Club ID


            const exportGoalMetBtn = document.getElementById('export-goal-met-btn');
            const exportGoalNotMetBtn = document.getElementById('export-goal-not-met-btn');
            const exportInvalidActivitiesBtn = document.getElementById('export-invalid-activities-btn');

            // Handle Strava connection button click
            connectStravaBtn.addEventListener('click', async () => {
                const clubId = stravaClubIdInput.value.trim();
                if (!clubId) {
                    displayMessageModal('L·ªói nh·∫≠p li·ªáu', 'Vui l√≤ng nh·∫≠p ID c√¢u l·∫°c b·ªô Strava.');
                    return;
                }

                // Call the function to fetch data from Edge Function
                const fetchedData = await fetchStravaClubActivitiesFromEdgeFunction(clubId);

                if (fetchedData) {
                    saveRunsToLocalStorage(fetchedData); // Save fetched data to local storage
                    generateActivityTypeFilters(fetchedData); // Regenerate filters based on new data
                    loadAndClassifyData(); // Re-classify data
                } else {
                    // If fetch failed, fallback to mock data or clear tables
                    stravaStatus.textContent = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Strava. ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u.';
                    const allClubData = loadRunsFromLocalStorage(); // Load mock data
                    generateActivityTypeFilters(allClubData);
                    loadAndClassifyData();
                }
            });


            // Toggle custom KM input based on radio button selection
            classifyCustomKm.addEventListener('change', () => {
                customKmInput.disabled = !classifyCustomKm.checked;
                if (classifyCustomKm.checked) {
                    customKmInput.focus();
                }
                // No need to call loadAndClassifyData here, it will be called by classifyBtn click or other changes
            });

            classify25km.addEventListener('change', () => {
                customKmInput.disabled = true;
                // No need to call loadAndClassifyData here
            });

            // Re-classify data when penalty amount changes
            penaltyPerKmInput.addEventListener('input', () => {
                loadAndClassifyData();
            });

            // Re-classify data when week selection changes
            weekSelect.addEventListener('change', () => {
                loadAndClassifyData();
            });

            // Handle classify button click with validation for custom KM
            classifyBtn.addEventListener('click', () => {
                const classificationType = document.querySelector('input[name="classificationType"]:checked').value;
                const customKmInput = document.getElementById('customKmInput');

                if (classificationType === 'custom') {
                    const customValue = parseFloat(customKmInput.value);
                    if (isNaN(customValue) || customValue <= 0) {
                        displayMessageModal('L·ªói nh·∫≠p li·ªáu', 'Vui l√≤ng nh·∫≠p m·ªôt gi√° tr·ªã KM h·ª£p l·ªá v√† l·ªõn h∆°n 0 cho ti√™u ch√≠ t√πy ch·ªânh.');
                        // Prevent classification if invalid
                        return;
                    }
                }
                loadAndClassifyData(); // Proceed with classification if valid
            });

            // Export button listeners
            exportGoalMetBtn.addEventListener('click', () => {
                exportTableToCSV('goal-met-table', 'thanh_tich_dat_muc_tieu.csv');
            });
            exportGoalNotMetBtn.addEventListener('click', () => {
                exportTableToCSV('goal-not-met-table', 'thanh_tich_chua_dat_muc_tieU.csv');
            });
            exportInvalidActivitiesBtn.addEventListener('click', () => {
                exportTableToCSV('invalid-activities-table', 'hoat_dong_khong_hop_le.csv');
            });
        });
    </script>
</body>
</html>
