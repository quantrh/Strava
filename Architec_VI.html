<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiến Trúc Tổng Thể Hệ Thống Virtual Account (VA)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; color: #1f2937; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #ffffff; box-shadow: 0 0 20px rgba(0, 0, 0, 0.05); }

        /* Smooth scrolling for anchor links */
        html {
            scroll-behavior: smooth;
        }

        /* Custom Header Styles */
        .main-header { 
            color: #047857; 
            font-weight: 800; 
            text-transform: uppercase; 
            font-size: 1.75rem; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            margin-top: 0.5rem; 
            margin-bottom: 1.5rem; 
            border-bottom: 4px solid #10b981; 
            padding-bottom: 1rem;
        }
        
        .sub-header {
            font-size: 1.35rem; 
            font-weight: 700; 
            color: #1f2937; 
            margin-top: 2.5rem; 
            margin-bottom: 1rem; 
            border-left: 5px solid #3b82f6; 
            padding-left: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header {
            font-size: 1.15rem; 
            font-weight: 600; 
            color: #374151; 
            margin-top: 1.5rem; 
            margin-bottom: 0.5rem; 
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
            scroll-margin-top: 20px; /* Offset for scroll anchor */
        }

        /* Image Box Styles */
        .image-container {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative; /* For hover effect context */
        }
        
        .image-container img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
            cursor: zoom-in; /* Indicate zoomable */
        }

        .image-container:hover img {
            opacity: 0.95;
        }

        .image-caption {
            background-color: #f9fafb;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
            font-style: italic;
        }

        /* Modal / Lightbox Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            padding-top: 50px; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.85); 
            backdrop-filter: blur(5px);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 1200px;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation-name: zoom;
            animation-duration: 0.3s;
        }

        @keyframes zoom {
            from {transform:scale(0.8); opacity: 0;} 
            to {transform:scale(1); opacity: 1;}
        }

        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 1001;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        /* Caption inside modal */
        #caption {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            text-align: center;
            color: #ccc;
            padding: 10px 0;
            height: 150px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }

        .summary-block {
            background-color: #ecfdf5;
            border: 2px solid #10b981;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        .summary-title {
            color: #047857;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed #6ee7b7;
        }

        .group-title {
            color: #1d4ed8;
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .diagram-list li {
            margin-left: 1.5rem;
            list-style: disc;
            margin-top: 0.25rem;
        }
        
        /* Link styles in summary */
        .diagram-link:hover {
            text-decoration: underline;
            cursor: pointer;
            opacity: 0.8;
        }

        /* Scroll Up Button */
        #scrollUpBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: #3b82f6;
            color: white;
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, transform 0.3s;
        }

        #scrollUpBtn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        
        /* Table of Contents */
        .toc-container {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .toc-link {
            color: #475569;
            font-size: 0.95rem;
            transition: color 0.2s;
            display: block;
            padding: 2px 0;
        }
        .toc-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }
		
		
		  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; line-height: 1.6; }
        .container { max-width: 1100px; margin: 0 auto; padding: 24px; background-color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 100vh; }
        
        /* Typography Header */
        h1.main-title {
            color: #065f46; /* emerald-800 */
            font-size: 1.6rem;
            font-weight: 800;
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            border-bottom: 4px solid #10b981;
            padding-bottom: 1rem;
            line-height: 1.4;
        }
        
        /* Section Styling */
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e3a8a; /* blue-900 */
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 5px solid #3b82f6;
            padding-left: 1rem;
        }

        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            height: 100%;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #93c5fd;
            transform: translateY(-2px);
        }

        .feature-list li {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .feature-list li::before {
            content: "•";
            color: #10b981;
            font-weight: bold;
            position: absolute;
            left: 0;
            font-size: 1.2rem;
            line-height: 1.5rem;
        }

        /* Logic Card for Sub-services */
        .logic-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #6366f1; /* Indigo left border default */
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        .logic-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .logic-card h4 { font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem; }

        /* Scroll to top */
        #scrollUpBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            background-color: #059669;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #scrollUpBtn:hover { background-color: #047857; }
        
        /* Badges */
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; margin-left: auto; }
        .badge-core { background-color: #fee2e2; color: #991b1b; } /* Red */
        
        /* TOC */
        .toc-container { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem; }
        .toc-link { color: #475569; font-size: 0.95rem; transition: color 0.2s; display: block; padding: 2px 0; }
        .toc-link:hover { color: #2563eb; text-decoration: underline; }
		
		
		
		
    </style>
</head>
<body>

<div class="container relative">

    <!-- Scroll Up Button -->
    <button onclick="topFunction()" id="scrollUpBtn" title="Go to top">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>

    <!-- LANGUAGE SWITCHER -->
    <!-- Khi bấm sẽ chuyển trang sang file English -->
    <div class="flex justify-end pt-4 px-4 gap-2">
        <button class="text-xs font-bold px-2 py-1 rounded bg-green-200 text-green-800 cursor-default">Tiếng Việt</button>
        <a href="Architec_EN.html" class="text-xs font-bold px-2 py-1 rounded bg-gray-200 hover:bg-blue-100 text-gray-700 decoration-0">English</a>
    </div>

    <!-- ==================================================================================== -->
    <!-- CONTENT VIETNAMESE ONLY -->
    <!-- ==================================================================================== -->
    <div id="content-vi">
        <header class="text-center py-6">
            <h1 class="main-header justify-center">Thiết Kế Kiến Trúc Hệ Thống Virtual Account</h1>
        </header>

        <!-- TABLE OF CONTENTS (MỤC LỤC) -->
        <div class="toc-container">
            <h2 class="text-lg font-bold text-gray-800 mb-3 border-b border-gray-300 pb-2 flex items-center gap-2">
                <i data-lucide="list" class="w-5 h-5 text-gray-500"></i> Mục Lục
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                <div>
                    <div class="font-semibold text-indigo-700 mb-2 mt-1">I. Nhóm Macro Architecture</div>
                    <ul class="space-y-1 pl-2 border-l-2 border-indigo-200">
                        <li><a href="#diagram-1" class="toc-link">1. Sơ đồ 1 – Overall System Landscape</a></li>
                        <li><a href="#diagram-2" class="toc-link">2. Sơ đồ 2 – Logical Architecture</a></li>
                        <li><a href="#diagram-10" class="toc-link">3. Sơ đồ 10 – Data Model VA (ERD)</a></li>
                        <li><a href="#diagram-11" class="toc-link">4. Sơ đồ 11 – Deployment Architecture</a></li>
                        <li><a href="#diagram-12" class="toc-link">5. Sơ đồ 12 – Integration Architecture</a></li>
                    </ul>
                </div>
                <div>
                    <div class="font-semibold text-rose-700 mb-2 mt-1 md:mt-1">II. Nhóm Logic & Nghiệp vụ</div>
                    <ul class="space-y-1 pl-2 border-l-2 border-rose-200">
                        <li><a href="#diagram-3" class="toc-link">6. Sơ đồ 3 – VA-first Incoming Flow</a></li>
                        <li><a href="#diagram-4" class="toc-link">7. Sơ đồ 4 – DDA-first Incoming Flow</a></li>
                        <li><a href="#diagram-5" class="toc-link">8. Sơ đồ 5 – Outgoing từ VA</a></li>
                        <li><a href="#diagram-6" class="toc-link">9. Sơ đồ 6 – Interest Allocation Flow</a></li>
                        <li><a href="#diagram-7" class="toc-link">10. Sơ đồ 7 – Sequence VA-first</a></li>
                        <li><a href="#diagram-8" class="toc-link">11. Sơ đồ 8 – Sequence Outgoing VA</a></li>
                        <li><a href="#diagram-9" class="toc-link">12. Sơ đồ 9 – Sequence Interest Allocation</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- KHỐI NỘI DUNG TỔNG HỢP -->
        <div class="summary-block">
            <div class="summary-title">TỔNG HỢP KIẾN THỨC VỀ 12 SƠ ĐỒ KIẾN TRÚC & QUY TRÌNH</div>
            <p class="text-gray-700 mb-4">
                Toàn bộ 12 sơ đồ được chia thành <strong>2 nhóm lớn</strong> theo mục đích:
            </p>
            
            <div class="group-title text-indigo-700">I. Nhóm 1 – Sơ đồ Tổng Thể (Macro Architecture)</div>
            <p class="text-sm text-gray-600 italic">Gồm 4 sơ đồ: Sơ đồ #1, #2, #10, #11</p>
            <div class="text-gray-700">
                <p class="font-medium mt-2">1. Mục đích của nhóm</p>
                <ul class="diagram-list">
                    <li>Trình bày bức tranh tổng thể hệ thống (landscape)</li>
                    <li>Thể hiện ranh giới giữa Core Banking và Deposit Core Hub</li>
                    <li>Là cơ sở để Hội đồng Kiến trúc và Ban Lãnh đạo phê duyệt hướng thiết kế</li>
                    <li>Giúp tất cả đội kỹ thuật (Core, Integration, Digital Channels, BA/Dev/QA) hiểu cách hệ thống vận hành ở mức kiến trúc</li>
                </ul>
                <p class="font-medium mt-2">2. Danh sách sơ đồ trong nhóm</p>
                <ul class="diagram-list">
                    <li><a href="#diagram-1" class="diagram-link"><span class="font-semibold text-green-700">Sơ đồ số 1 – Overall System Landscape / Core Banking Super Layer:</span></a> Giới thiệu BIG PICTURE toàn hệ thống. Các lớp: Channels → API Gateway → Routing Hub → Deposit Core Hub → Core Banking → Data Layer. Chỉ rõ VA thuộc lớp nào và Core làm nhiệm vụ gì. Must-have.</li>
                    <li><a href="#diagram-2" class="diagram-link"><span class="font-semibold text-green-700">Sơ đồ số 2 – Logical Architecture (Deposit Core Hub + VA):</span></a> Mô tả các module chính: Routing Hub, VA Engine, DDA Handler, Interest Engine. Ranh giới logic giữa lớp Hub và Core. Giải thích trách nhiệm từng thành phần. Must-have.</li>
                    <li><a href="#diagram-10" class="diagram-link"><span class="font-semibold text-green-700">Sơ đồ số 10 – Data Model VA (ERD):</span></a> ERD tổng quan: VA, VA Ledger, VA Balance, Hierarchy, Enrollment, Identifier… Cho thấy cách dữ liệu VA được tổ chức. Must-have.</li>
                    <li><a href="#diagram-11" class="diagram-link"><span class="font-semibold text-green-700">Sơ đồ số 11 – Logical ERD Chi tiết:</span></a> Phiên bản chi tiết chuyên sâu hơn của ERD tổng quan (Sơ đồ #10). Thể hiện đầy đủ quan hệ giữa các bảng, các module logic. Rất hữu ích cho đội Data, BA, và Dev. Should-have.</li>
                </ul>
            </div>

            <div class="group-title text-indigo-700">II. Nhóm 2 – Sơ đồ Kiến trúc Logic & Luồng Xử lý Nghiệp vụ</div>
            <p class="text-sm text-gray-600 italic">Gồm 8 sơ đồ: #3 → #9 + #12 (Trong đó, #7, #8, #9 là Sequence Diagram)</p>
            <div class="text-gray-700">
                <p class="font-medium mt-2">1. Mục đích của nhóm</p>
                <ul class="diagram-list">
                    <li>Mô tả chi tiết từng luồng nghiệp vụ mà Virtual Account phải hỗ trợ</li>
                    <li>Thể hiện tương tác giữa system components</li>
                    <li>Giúp đội BA/Dev/QA xây dựng, test, và báo cáo hệ thống</li>
                    <li>Đảm bảo các case nghiệp vụ đáp ứng chuẩn quốc tế về VA</li>
                </ul>
                <p class="font-medium mt-2">2. Danh sách sơ đồ trong nhóm</p>
                <ul class="diagram-list">
                    <li><a href="#diagram-3" class="diagram-link"><span class="font-semibold text-red-700">Sơ đồ số 3 – VA-first Incoming Flow:</span></a> Luồng khi khách hàng nhập số VA trực tiếp. Routing → Validate VA → Core hạch toán → Event → Shadow Posting. Chuẩn quốc tế, đảm bảo không lạc VA. Must-have.</li>
                    <li><a href="#diagram-4" class="diagram-link"><span class="font-semibold text-red-700">Sơ đồ số 4 – DDA-first Incoming Flow:</span></a> Khi khách hàng chỉ nhập số DDA + remark. Core ghi có trước → Routing Hub tìm VA → VA ghi shadow. Hỗ trợ kênh liên ngân hàng không hỗ trợ VA. Must-have.</li>
                    <li><a href="#diagram-5" class="diagram-link"><span class="font-semibold text-red-700">Sơ đồ số 5 – Outgoing từ VA:</span></a> VA kiểm soát số dư → Shadow Debit → Core Debit DDA → Confirm. Phù hợp POBO, chi hộ, chuyển khoản từ VA. Must-have.</li>
                    <li><a href="#diagram-6" class="diagram-link"><span class="font-semibold text-red-700">Sơ đồ số 6 – Interest Allocation Flow:</span></a> Core tính lãi trên DDA → Routing Hub → VA Alloc Engine → Shadow Posting. Hỗ trợ mô hình chia lãi theo dự án/hộ gia đình/đơn vị. Should-have (nhưng quan trọng).</li>
                    <li><a href="#diagram-7" class="diagram-link"><span class="font-semibold text-red-700">Sơ đồ số 7 – Sequence VA-first:</span></a> Sequence Diagram mô tả tuần tự tương tác (của Sơ đồ #3). Phục vụ Dev/QA xây dựng API & xử lý lỗi. Should-have.</li>
                    <li><a href="#diagram-8" class="diagram-link"><span class="font-semibold text-red-700">Sơ đồ số 8 – Sequence Outgoing VA:</span></a> Toàn bộ logic chi từ VA theo dòng tuần tự (của Sơ đồ #5). Giúp đội kỹ thuật kiểm soát pending/confirmed debit. Should-have.</li>
                    <li><a href="#diagram-9" class="diagram-link"><span class="font-semibold text-red-700">Sơ đồ số 9 – Sequence Interest Allocation:</span></a> Chi tiết tính toán và phân bổ lãi (của Sơ đồ #6). Hỗ trợ kiểm toán, reconciliation. Should-have.</li>
                    <li><a href="#diagram-12" class="diagram-link"><span class="font-semibold text-red-700">Sơ đồ số 12 – Integration & Deployment Architecture:</span></a> Mô tả triển khai thực tế: container, scaling, HA/DR. Quan trọng cho DevOps, hạ tầng. Must-have.</li>
                </ul>
            </div>
        </div>

        <h2 class="sub-header">
            <i data-lucide="layout-grid" class="w-6 h-6 text-blue-500"></i>
            I. Nhóm 1 – Sơ đồ Tổng Thể (Macro Architecture)
        </h2>
        <p class="pl-2 text-gray-700 italic">Các sơ đồ này trình bày bức tranh tổng thể hệ thống, kiến trúc logic và lớp dữ liệu (Sơ đồ #1, #2, #10, #11).</p>

        <!-- Sơ đồ số 1 -->
        <div id="diagram-1" class="section-header">1. Sơ đồ số 1 – Overall System Landscape / Core Banking Super Layer</div>
        <div class="image-container">
            <img class="zoomable-image" src="./Picture/01_Overall_System_Landscape.png" alt="Overall System Landscape">
            <div class="image-caption">Sơ đồ 1/12: Overall System Landscape / Core Banking Super Layer (Click để phóng to)</div>
        </div>
        
   <!-- 1. FRONTEND - API GATEWAY -->
    <section id="sec-1">
        <h2 class="section-title">
            <i data-lucide="monitor" class="text-blue-600"></i>
            (1). Lớp Người dùng – FrontEnd – API Gateway
        </h2>
        <div class="card bg-gray-50 border-gray-200">
            <p class="mb-2 text-gray-700">Người dùng (Doanh nghiệp, Nội bộ, H2H, File upload) truy cập hệ thống qua Internet/LAN vào các Portal FE.</p>
            <ul class="feature-list text-sm text-gray-600">
                <li>Toàn bộ yêu cầu được tiêu chuẩn hóa, xác thực và điều phối thông qua <strong>API Gateway/ESB</strong>, trước khi đi vào lớp Deposit Core Hub.</li>
                <li>Một số nghiệp vụ batch/file được FE chuyển trực tiếp đến S3 để xử lý qua ETL/MIS hoặc tiến trình backend.</li>
            </ul>
        </div>
    </section>

    <!-- 2. DEPOSIT CORE HUB -->
    <section id="sec-2">
        <h2 class="section-title">
            <i data-lucide="layers" class="text-blue-600"></i>
            (2). Deposit Core Hub – Domain Service Layer
        </h2>
        <div class="bg-indigo-50 p-4 rounded-lg mb-6 border border-indigo-200">
            <h3 class="font-bold text-indigo-900 text-lg mb-1 flex items-center gap-2">
                <i data-lucide="disc" class="w-5 h-5"></i> Trung tâm của kiến trúc
            </h3>
            <p class="text-sm text-gray-700">Được thiết kế như một domain service độc lập, gồm nhiều microservices chuyên trách nghiệp vụ. Các microservices phối hợp với nhau để xử lý đồng bộ luồng giao dịch, quản lý sản phẩm, quản lý dữ liệu và đảm bảo tính toàn vẹn nghiệp vụ.</p>
        </div>

        <div class="grid grid-cols-1 gap-4">
            
            <!-- 2.1 Sub-Account Service -->
            <div id="sec-2-1" class="logic-card border-l-purple-500 bg-purple-50 bg-opacity-30">
                <div class="flex justify-between items-start">
                    <h4><i data-lucide="users" class="w-5 h-5 text-purple-600 mt-1"></i> (2.1) Sub-Account Service (Virtual Account Service – VA/Sub-account Layer)</h4>
                    <span class="badge badge-core">Core</span>
                </div>
                <p class="text-sm text-gray-600 mb-3 italic">Đây là thành phần cốt lõi nhất, đại diện cho toàn bộ nghiệp vụ tài khoản ảo/sub-account.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-white p-3 rounded border border-purple-100">
                        <strong class="text-purple-800 block mb-1">Virtual Account Registry & Hierarchy</strong>
                        <p class="text-gray-600 text-xs">Quản lý danh mục VA/Sub-account, cấu trúc nhiều cấp (2–4 level), registry metadata (household_id, project_code,…), mapping VA ↔ DDA và trạng thái (Active/Locked/Closed).</p>
                    </div>
                    <div class="bg-white p-3 rounded border border-purple-100">
                        <strong class="text-purple-800 block mb-1">VA Validation & Policy Control</strong>
                        <p class="text-gray-600 text-xs">Kiểm tra VA trước khi xử lý giao dịch: trạng thái, rule nghiệp vụ (thu/chi), hạn mức, context. Là đầu vào bắt buộc cho luồng VA-first.</p>
                    </div>
                    <div class="bg-white p-3 rounded border border-purple-100">
                        <strong class="text-purple-800 block mb-1">DDA Enrollment & Mapping</strong>
                        <p class="text-gray-600 text-xs">Quản lý đăng ký DDA cho sản phẩm VA; rule nhận diện VA từ DDA + remark cho luồng DDA-first (khi khách hàng chỉ nhập số tài khoản gốc).</p>
                    </div>
                    <div class="bg-white p-3 rounded border border-purple-100">
                        <strong class="text-purple-800 block mb-1">Reconciliation & Exception Handling</strong>
                        <p class="text-gray-600 text-xs">Đối chiếu dữ liệu Shadow Ledger ↔ Core Ledger; xử lý lệch giao dịch, thiếu bút toán, mismatch số tiền, hỗ trợ tra soát thủ công.</p>
                    </div>
                </div>
                <div class="bg-white p-3 rounded border border-purple-100 mt-4 text-sm">
                    <strong class="text-purple-800 block mb-1">VA Reporting & Statement</strong>
                    <p class="text-gray-600 text-xs">Sinh báo cáo và sao kê theo VA, theo cây VA (roll-up), theo DDA, theo dự án hoặc từng sản phẩm tích lũy.</p>
                    <p class="text-xs text-purple-700 mt-1 font-semibold">Sub-Account Service chính là “trái tim nghiệp vụ” của dịch vụ Virtual Account.</p>
                </div>
            </div>

            <!-- 2.2 Transaction Service -->
            <div id="sec-2-2" class="logic-card border-l-blue-500">
                <h4><i data-lucide="arrow-left-right" class="w-5 h-5 text-blue-600 mt-1"></i> (2.2) Transaction Service (Điều phối giao dịch và Shadow Posting)</h4>
                <p class="text-sm text-gray-600 mb-2">Tiếp nhận yêu cầu giao dịch từ Routing Service và thực hiện ba nhóm tác vụ:</p>
                <ul class="text-sm text-gray-600 feature-list">
                    <li><strong>VA Posting & Shadow Ledger:</strong> Ghi Shadow Posting (Credit/Debit), tạo trạng thái pending/completed/reversed, liên kết coreTxnId để đảm bảo idempotency.</li>
                    <li><strong>VA Outgoing Payment:</strong> Xử lý chi tiền từ VA (Kiểm tra số dư real/roll-up; Tạo shadow debit; Gửi debit DDA sang Core; Nhận Debit Notification Event; Hoàn tất chuyển trạng thái ledger). Hỗ trợ POBO, Payroll.</li>
                    <li><strong>Giao dịch sản phẩm Deposit khác:</strong> Mở/tất toán món gửi của Accumulation Deposit, rút trước hạn, gia hạn kỳ hạn, chuyển đổi sản phẩm.</li>
                </ul>
            </div>

            <!-- 2.3 Balance Service -->
            <div class="logic-card border-l-green-500">
                <h4><i data-lucide="scale" class="w-5 h-5 text-green-600 mt-1"></i> (2.3) Balance Service (Số dư – Hạn mức – ADB)</h4>
                <ul class="text-xs text-gray-600 list-disc ml-4 space-y-1">
                    <li>Tính Available, Pending, Roll-up balance cho từng VA/Sub-account.</li>
                    <li>Cung cấp số dư EOD và bình quân (ADB) — đầu vào cho Interest Allocation.</li>
                    <li>Kiểm tra hạn mức theo khách hàng, kênh, VA, DDA hoặc sản phẩm.</li>
                </ul>
            </div>

            <!-- 2.4 Interest Allocation -->
            <div class="logic-card border-l-amber-500">
                <h4><i data-lucide="pie-chart" class="w-5 h-5 text-amber-600 mt-1"></i> (2.4) Job – Interest Allocation (Batch lãi – Phân bổ lãi)</h4>
                <ul class="text-xs text-gray-600 list-disc ml-4 space-y-1">
                    <li>Nhận thông tin lãi thật từ Core trên DDA.</li>
                    <li>Tính lãi phân bổ về từng VA/Sub-account theo tỷ lệ (pro-rata), trọng số, hoặc theo rule.</li>
                    <li>Ghi Shadow Posting lãi và cập nhật số dư roll-up.</li>
                    <li>Vai trò đặc biệt quan trọng cho sản phẩm Accumulation Deposit.</li>
                </ul>
            </div>

            <!-- 2.5 Top-Up Service -->
            <div class="logic-card border-l-cyan-500">
                <h4><i data-lucide="download" class="w-5 h-5 text-cyan-600 mt-1"></i> (2.5) Top-Up Service (Gửi góp – Bổ sung tiền)</h4>
                <p class="text-xs text-gray-600">Hỗ trợ các nghiệp vụ nạp bổ sung tiền trong sản phẩm gửi góp. Mỗi lần top-up được ghi nhận như “một món gửi nhỏ” trong VA/Sub-account, có kỳ hạn, chính sách lãi và điều kiện xử lý riêng.</p>
            </div>

            <!-- 2.6 Multi-Currency -->
            <div class="logic-card border-l-orange-500">
                <h4><i data-lucide="globe" class="w-5 h-5 text-orange-600 mt-1"></i> (2.6) Multi-Currency Service</h4>
                <p class="text-xs text-gray-600">Dành cho các sản phẩm cần hỗ trợ đa tiền tệ. Quản lý account-set, quy tắc FX và mapping currency.</p>
            </div>
            
            <!-- 2.7 Rule Other -->
            <div class="logic-card border-l-slate-500">
                <h4><i data-lucide="settings" class="w-5 h-5 text-slate-600 mt-1"></i> (2.7) Rule Other Service</h4>
                <p class="text-xs text-gray-600">Lưu các rule nghiệp vụ chung như: lịch làm việc, rule ngày tính lãi, chính sách phí, mapping mã sản phẩm. Được các service khác gọi trong lúc xử lý.</p>
            </div>

            <!-- 2.8 Report Service -->
            <div class="logic-card border-l-slate-500">
                <h4><i data-lucide="file-text" class="w-5 h-5 text-slate-600 mt-1"></i> (2.8) Report Service</h4>
                <p class="text-xs text-gray-600">Tổng hợp dữ liệu hoạt động của DCH và cung cấp cho ETL/MIS: Báo cáo sổ cái ảo, báo cáo số dư VA/Deposit, Báo cáo thu–chi, phân bổ lãi, Dashboard vận hành.</p>
            </div>

            <!-- 2.9 History Service -->
            <div class="logic-card border-l-slate-500">
                <h4><i data-lucide="history" class="w-5 h-5 text-slate-600 mt-1"></i> (2.9) History Service</h4>
                <p class="text-xs text-gray-600">Ghi toàn bộ lịch sử thay đổi cấu hình trong DCH: registry VA/DDA, thay đổi rule, thay đổi hạn mức, audit thao tác người dùng. Đảm bảo tính minh bạch.</p>
            </div>
        </div>
    </section>

    <!-- 3. ROUTING SERVICE -->
    <section id="sec-3">
        <h2 class="section-title">
            <i data-lucide="route" class="text-blue-600"></i>
            (3). Routing Service (Điều phối trung tâm giữa Gateway và Domain Services)
        </h2>
        <div class="card border-l-4 border-blue-600">
            <p class="font-bold text-gray-800 mb-2">Định tuyến yêu cầu từ API Gateway đến đúng domain service:</p>
            <ul class="text-sm text-gray-700 list-disc ml-5 space-y-2">
                <li><strong>Routing theo loại giao dịch:</strong> → Sub-account, Balance, Transaction, Top-up, Multi-currency…</li>
                <li><strong>Enrich dữ liệu:</strong> Chuẩn hóa tham số để đảm bảo tương thích với Core.</li>
                <li><strong>Kết nối Core:</strong> Là cầu nối với Core Internal Service (TSSP, MRPC, Dynamic SQL) để gọi các lệnh hạch toán hoặc truy vấn dữ liệu từ Core Profile.</li>
            </ul>
            <div class="mt-3 bg-blue-50 text-blue-900 text-sm p-2 rounded font-semibold text-center">
                Triết lý: "Routing Service giúp Deposit Core Hub thực hiện triết lý không sửa Core, nhưng vẫn sử dụng được toàn bộ năng lực Core"
            </div>
        </div>
    </section>

    <!-- 4. DATABASE & INFRA -->
    <section id="sec-4">
        <h2 class="section-title">
            <i data-lucide="database" class="text-blue-600"></i>
            (4). Database – Core Internal – MQ – ETL – MIS
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="card bg-gray-50 p-4">
                <strong class="block text-gray-800 mb-1">DB Deposit Core Hub</strong>
                <p class="text-xs text-gray-600">Lưu toàn bộ registry, VA ledger, rule, balance snapshot, cấu hình sản phẩm.</p>
            </div>
            <div class="card bg-gray-50 p-4">
                <strong class="block text-gray-800 mb-1">Redis Cache</strong>
                <p class="text-xs text-gray-600">Tăng tốc lookup VA, balance, rule.</p>
            </div>
            <div class="card bg-gray-50 p-4">
                <strong class="block text-gray-800 mb-1">Core Profile</strong>
                <p class="text-xs text-gray-600">Account Engine: nơi hạch toán thật các giao dịch DDA.</p>
            </div>
            <div class="card bg-gray-50 p-4">
                <strong class="block text-gray-800 mb-1">Core MQ</strong>
                <p class="text-xs text-gray-600">Sản sinh event (credit/debit) để Deposit Core Hub và ETL xử lý.</p>
            </div>
            <div class="card bg-gray-50 p-4 md:col-span-2 lg:col-span-1">
                <strong class="block text-gray-800 mb-1">S3 – ETL – MIS</strong>
                <p class="text-xs text-gray-600">Lưu file, batch processing, báo cáo quản trị.</p>
            </div>
        </div>
    </section>

    <!-- 5. VALUE -->
    <section id="sec-5" class="mt-8 mb-12">
        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-lg p-6 shadow-sm">
            <h2 class="text-xl font-bold text-emerald-800 mb-4 flex items-center gap-2">
                <i data-lucide="thumbs-up" class="w-6 h-6"></i> (5). Giá trị kiến trúc tổng thể
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex gap-3 items-start">
                    <div class="bg-white p-1 rounded shadow-sm text-emerald-600"><i data-lucide="check" class="w-4 h-4"></i></div>
                    <p class="text-sm text-gray-700"><strong>Tăng tốc time-to-market:</strong> Phát triển sản phẩm mới mà không ảnh hưởng phân hệ Core gốc.</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="bg-white p-1 rounded shadow-sm text-emerald-600"><i data-lucide="check" class="w-4 h-4"></i></div>
                    <p class="text-sm text-gray-700"><strong>Giảm rủi ro:</strong> Nhờ cơ chế Shadow Posting, Validation, Reconciliation, Idempotency.</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="bg-white p-1 rounded shadow-sm text-emerald-600"><i data-lucide="check" class="w-4 h-4"></i></div>
                    <p class="text-sm text-gray-700"><strong>Dễ mở rộng:</strong> Accumulation Deposit, Multi-currency, Smart Deposit, People-based Deposit…</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="bg-white p-1 rounded shadow-sm text-emerald-600"><i data-lucide="check" class="w-4 h-4"></i></div>
                    <p class="text-sm text-gray-700"><strong>Linh hoạt luồng giao dịch:</strong> Xử lý 2 luồng VA-first và DDA-first, phục vụ các kênh không hỗ trợ nhập VA.</p>
                </div>
                <div class="flex gap-3 items-start md:col-span-2">
                    <div class="bg-white p-1 rounded shadow-sm text-emerald-600"><i data-lucide="check" class="w-4 h-4"></i></div>
                    <p class="text-sm text-gray-700"><strong>Hiện đại hóa:</strong> Tích hợp Event-driven giúp real-time hơn và dễ mở rộng sang Data Platform. Chuẩn hoá Data & API.</p>
                </div>
            </div>
        </div>
    </section>

        <!-- Sơ đồ số 2 -->
        <div id="diagram-2" class="section-header">2. Sơ đồ số 2 – Logical Architecture (Deposit Core Hub + VA)</div>
        <div class="image-container">
            <img class="zoomable-image" src="./Picture/02_Logical_Architecture_DepositCoreHub_VA.png" alt="Logical Architecture">
            <div class="image-caption">Sơ đồ 2/12: Logical Architecture (Deposit Core Hub + VA) (Click để phóng to)</div>
        </div>
        <div class="mt-6 space-y-6">
            <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-500 text-gray-700">
                <p>Sơ đồ mô tả kiến trúc logic của lớp <span class="font-bold text-indigo-700">Deposit Core Hub</span> – một “lớp siêu nghiệp vụ” được xây dựng bao quanh phân hệ Tiền gửi (Deposit Module) của Core Banking, cho phép BIDV phát triển nhanh các sản phẩm thu – chi hiện đại, đặc biệt là <span class="font-bold">Virtual Account (VA)</span>, mà không phải chỉnh sửa Core.</p>
            </div>
            
            <h3 class="font-bold text-xl text-gray-800 border-b border-gray-200 pb-2">Khối Năng Lực Chính</h3>
            
            <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition">
                <div class="flex items-center gap-3 mb-3"><div class="bg-purple-100 p-2 rounded-full text-purple-600"><i data-lucide="route" class="w-6 h-6"></i></div><h4 class="text-lg font-bold text-purple-900">Routing Hub – Bộ não điều hướng & kiểm soát</h4></div>
                <p class="text-gray-600 mb-3 italic">Đóng vai trò điểm trung gian bắt buộc cho mọi giao dịch thu – chi sử dụng VA.</p>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-purple-500 mt-1 flex-shrink-0"></i> <span>Kiểm tra loại giao dịch: <span class="font-medium">VA-first</span> hay <span class="font-medium">DDA-first</span>.</span></li>
                    <li class="flex gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-purple-500 mt-1 flex-shrink-0"></i> <span>Gọi VA Engine để xác thực số VA trước khi gửi hạch toán sang Core.</span></li>
                    <li class="flex gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-purple-500 mt-1 flex-shrink-0"></i> <span>Xác định tài khoản DDA thực tương ứng (Mapped DDA).</span></li>
                    <li class="flex gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-purple-500 mt-1 flex-shrink-0"></i> <span>Tiếp nhận sự kiện từ Core để chuyển tiếp cho VA Engine cập nhật ledger ảo.</span></li>
                </ul>
                <div class="mt-3 text-sm font-medium text-purple-800 bg-purple-50 p-2 rounded border border-purple-100">→ Giúp tách nghiệp vụ mở rộng khỏi Core, đồng thời đảm bảo luồng xử lý thống nhất cho toàn bộ kênh giao dịch.</div>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition">
                <div class="flex items-center gap-3 mb-4"><div class="bg-blue-100 p-2 rounded-full text-blue-600"><i data-lucide="cpu" class="w-6 h-6"></i></div><h4 class="text-lg font-bold text-blue-900">Virtual Account Engine – Trái tim nghiệp vụ VA</h4></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-3 rounded border border-blue-100"><div class="font-bold text-blue-800 text-sm mb-1">VA Incoming Service</div><p class="text-xs text-gray-600">Tiếp nhận giao dịch đầu vào, xác thực VA, tìm kiếm Mapped DDA, trả kết quả cho Routing Hub.</p></div>
                    <div class="bg-blue-50 p-3 rounded border border-blue-100"><div class="font-bold text-blue-800 text-sm mb-1">VA Outgoing Service</div><p class="text-xs text-gray-600">Xử lý lệnh chi, kiểm tra số dư real/roll-up, ghi shadow debit, và gọi Core để trích nợ thật DDA.</p></div>
                    <div class="bg-blue-50 p-3 rounded border border-blue-100"><div class="font-bold text-blue-800 text-sm mb-1">Shadow Posting Engine</div><p class="text-xs text-gray-600">Tạo bút toán ảo; cập nhật số dư VA và số dư roll-up theo cây VA nhiều cấp (3–5 cấp).</p></div>
                    <div class="bg-blue-50 p-3 rounded border border-blue-100"><div class="font-bold text-blue-800 text-sm mb-1">VA Balance Engine</div><p class="text-xs text-gray-600">Tính toán số dư tức thời, đồng bộ với Ledger ảo và sự kiện từ Core.</p></div>
                </div>
                <p class="mt-4 text-sm text-blue-800 font-medium px-2">→ VA Engine hoạt động độc lập với Core, giúp BIDV linh hoạt mở rộng tính năng mà không ảnh hưởng đến hệ lõi.</p>
            </div>
			
			<!-- START: Nội dung Khối Năng Lực Chính Mới -->
            <div class="space-y-6 mt-4">
                
                <!-- 1. DDA Handler -->
                <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-indigo-100 p-2 rounded-full text-indigo-600">
                            <i data-lucide="git-branch" class="w-6 h-6"></i>
                        </div>
                        <h4 class="text-lg font-bold text-indigo-900">DDA Handler – Vai trò Nghiệp Vụ DDA-first</h4>
                    </div>
                    <p class="text-gray-600 mb-3 italic">DDA Handler thực hiện nghiệp vụ xử lý giao dịch, không phải điều phối. Chỉ được kích hoạt trong 2 trường hợp:</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Case 1 -->
                        <div class="bg-indigo-50 p-4 rounded border border-indigo-100">
                            <div class="font-bold text-indigo-800 text-sm mb-2 border-b border-indigo-200 pb-1">*) Khi giao dịch đến theo DDA (DDA-first)</div>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <i data-lucide="check" class="w-4 h-4 text-indigo-500 mt-0.5 shrink-0"></i>
                                    <span>Kiểm tra DDA có đăng ký Virtual Account hay không.</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i data-lucide="check" class="w-4 h-4 text-indigo-500 mt-0.5 shrink-0"></i>
                                    <span>Kiểm tra rule dựa trên remark / mã định danh để tìm VA phù hợp.</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i data-lucide="check" class="w-4 h-4 text-indigo-500 mt-0.5 shrink-0"></i>
                                    <span>Tìm chính xác VA nhận shadow posting & gửi yêu cầu sang VA Engine.</span>
                                </li>
                            </ul>
                        </div>
                        <!-- Case 2 -->
                        <div class="bg-indigo-50 p-4 rounded border border-indigo-100">
                            <div class="font-bold text-indigo-800 text-sm mb-2 border-b border-indigo-200 pb-1">*) Hậu kỳ (Post-processing)</div>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start gap-2">
                                    <i data-lucide="arrow-right" class="w-4 h-4 text-indigo-500 mt-0.5 shrink-0"></i>
                                    <span>Nhận <strong>Credit Notification Event</strong> từ Routing Hub khi Core đã hạch toán xong.</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i data-lucide="arrow-right" class="w-4 h-4 text-indigo-500 mt-0.5 shrink-0"></i>
                                    <span>Dựa vào DDA + remark + registry để tìm VA.</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <i data-lucide="arrow-right" class="w-4 h-4 text-indigo-500 mt-0.5 shrink-0"></i>
                                    <span>Gọi VA Engine để tạo shadow posting.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 2. VA Registry -->
                <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-cyan-100 p-2 rounded-full text-cyan-600">
                            <i data-lucide="book-open" class="w-6 h-6"></i>
                        </div>
                        <h4 class="text-lg font-bold text-cyan-900">VA Registry – Kho dữ liệu trung tâm</h4>
                    </div>
                    <p class="text-gray-600 mb-3">Đóng vai trò là "Sổ cái cấu hình" và "Hệ thống quản lý danh mục sản phẩm VA". Nơi lưu trữ toàn bộ thông tin tra cứu, mapping và trạng thái.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm text-gray-700">
                        <!-- Col 1 -->
                        <div>
                            <h5 class="font-bold text-cyan-800 mb-2">Chức năng quản lý & Mapping</h5>
                            <ul class="list-disc ml-4 space-y-1 text-gray-600">
                                <li><strong>Quản lý cấu trúc:</strong> Tạo VA, Khóa/Mở, Phân cấp cha-con (2-4 cấp), Gán metadata.</li>
                                <li><strong>Mapping VA ↔ DDA:</strong> Mỗi VA gắn với 01 DDA thật, lưu effective date và status.</li>
                                <li><strong>Cung cấp dữ liệu Reporting:</strong> Cấu trúc cây VA, thông tin chủ sở hữu.</li>
                            </ul>
                        </div>
                        <!-- Col 2 -->
                        <div>
                            <h5 class="font-bold text-cyan-800 mb-2">Chức năng Validate & Resolve</h5>
                            <ul class="list-disc ml-4 space-y-1 text-gray-600">
                                <li><strong>Validate VA:</strong> Kiểm tra tồn tại? Thuộc khách hàng nào? Active không? Loại VA (thu/chi)?</li>
                                <li><strong>Resolve VA (DDA-first):</strong> Tìm xem DDA có VA không, áp dụng rule tìm VA từ remark để trả về cho DDA Handler.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 3. Interest Allocation Engine -->
                <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-amber-100 p-2 rounded-full text-amber-600">
                            <i data-lucide="pie-chart" class="w-6 h-6"></i>
                        </div>
                        <h4 class="text-lg font-bold text-amber-900">Interest Allocation Engine – Phân bổ lãi</h4>
                    </div>
                    <p class="text-gray-600 mb-3 italic">Phân hệ thực hiện phân bổ lãi (interest allocation) từ tài khoản DDA thật xuống từng VA. Giúp doanh nghiệp biết VA nào sinh dòng tiền/chi phí.</p>
                    
                    <div class="bg-amber-50 rounded p-4 border border-amber-100">
                        <div class="font-bold text-amber-800 mb-2 border-b border-amber-200 pb-1">Quy trình xử lý chính</div>
                        <ul class="space-y-2 text-sm text-gray-700 mt-2">
                            <li class="flex gap-2">
                                <span class="bg-amber-200 text-amber-800 text-xs font-bold px-2 py-0.5 rounded h-fit">Bước 1</span> 
                                <span><strong>Nhận lãi từ Core:</strong> Nhận event <code>InterestPosted(DDA, amount)</code> từ Routing Hub.</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="bg-amber-200 text-amber-800 text-xs font-bold px-2 py-0.5 rounded h-fit">Bước 2</span> 
                                <span><strong>Lấy dữ liệu:</strong> Truy vấn cấu trúc VA từ Registry (level 1-4) và số dư/giao dịch làm cơ sở phân bổ (EOD balance, ADB, Volume...).</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="bg-amber-200 text-amber-800 text-xs font-bold px-2 py-0.5 rounded h-fit">Bước 3</span> 
                                <span><strong>Tính toán & Shadow Posting:</strong> Áp dụng công thức (VD: theo tỷ lệ số dư), ghi shadow posting vào VA Ledger, cập nhật balance VA (nếu bật chế độ lãi nhập gốc) và roll-up lên cấp cha.</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="bg-amber-200 text-amber-800 text-xs font-bold px-2 py-0.5 rounded h-fit">Audit</span> 
                                <span>Sinh báo cáo phân bổ chi tiết, ghi log toàn bộ input-output và history rule.</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- END: Nội dung Khối Năng Lực Chính Mới -->
			
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 h-full">
                    <div class="flex items-center gap-2 mb-2 text-slate-800 font-bold"><i data-lucide="server" class="w-5 h-5"></i> Core Banking Layer</div>
                    <p class="text-xs text-slate-500 mb-2 uppercase font-bold tracking-wide border-b border-slate-200 pb-1">Nơi ghi nhận bút toán thật</p>
                    <ul class="text-sm text-gray-700 space-y-2 mb-3">
                        <li class="flex items-start gap-2"><span class="w-1.5 h-1.5 rounded-full bg-slate-400 mt-1.5"></span> <span><strong>Deposit Module:</strong> hạch toán thực trên tài khoản DDA.</span></li>
                        <li class="flex items-start gap-2"><span class="w-1.5 h-1.5 rounded-full bg-slate-400 mt-1.5"></span> <span><strong>Event Bus:</strong> phát tín hiệu “Credit/Debit Notification” mỗi khi Core hoàn tất giao dịch.</span></li>
                    </ul>
                    <div class="text-xs italic text-slate-600 bg-white p-2 rounded border border-slate-100">Core chỉ thực hiện nhiệm vụ kế toán; mọi logic điều phối, mapping, đối soát và xử lý ảo đều nằm ở Deposit Core Hub.</div>
                </div>
                <div class="bg-cyan-50 border border-cyan-200 rounded-lg p-4 h-full">
                    <div class="flex items-center gap-2 mb-2 text-cyan-800 font-bold"><i data-lucide="database" class="w-5 h-5"></i> Data Layer</div>
                    <p class="text-xs text-cyan-600 mb-2 uppercase font-bold tracking-wide border-b border-cyan-200 pb-1">Phân tách ledger thật và ảo</p>
                    <ul class="text-sm text-gray-700 space-y-2 mb-3">
                        <li class="flex items-start gap-2"><span class="w-1.5 h-1.5 rounded-full bg-cyan-400 mt-1.5"></span> <span><strong>Core Ledger:</strong> số dư và giao dịch thật của DDA.</span></li>
                        <li class="flex items-start gap-2"><span class="w-1.5 h-1.5 rounded-full bg-cyan-400 mt-1.5"></span> <span><strong>VA Ledger (Shadow):</strong> bút toán ảo cho từng VA và từng level trong hệ thống.</span></li>
                    </ul>
                    <div class="text-xs italic text-cyan-700 bg-white p-2 rounded border border-cyan-100">Cách tách biệt này giúp VA mở rộng linh hoạt, không gây rủi ro cho Core Banking.</div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-5 shadow-sm">
                <h4 class="text-green-800 font-bold text-lg mb-3 flex items-center gap-2"><i data-lucide="gem" class="w-5 h-5"></i> Tóm lược giá trị kiến trúc</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-gray-700">
                    <div class="flex gap-2 items-start"><i data-lucide="check" class="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"></i> <span>Tách biệt nghiệp vụ khỏi Core, giảm tải và giảm thay đổi cho hệ lõi.</span></div>
                    <div class="flex gap-2 items-start"><i data-lucide="check" class="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"></i> <span>Hỗ trợ hai mô hình giao dịch: VA-first và DDA-first.</span></div>
                    <div class="flex gap-2 items-start"><i data-lucide="check" class="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"></i> <span>Đảm bảo vận hành real-time, minh bạch và dễ kiểm soát.</span></div>
                    <div class="flex gap-2 items-start"><i data-lucide="check" class="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5"></i> <span>Tạo nền tảng cho nhiều sản phẩm mới: thu hộ/chi hộ, pooling, quản lý dòng tiền.</span></div>
                </div>
                <div class="mt-4 pt-3 border-t border-green-200 text-center text-green-900 font-bold italic text-sm">"Đây là kiến trúc đột phá, giúp BIDV hiện đại hóa phân hệ tiền gửi và sẵn sàng cho chiến lược ngân hàng giao dịch số."</div>
            </div>
        </div>

        <!-- Sơ đồ 10 -->
        <div id="diagram-10" class="section-header">3. Sơ đồ số 10 – Data Model VA (ERD)</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/10_Data_Model_VA_Conceptual.png" alt="Data Model VA (ERD)"><div class="image-caption">Sơ đồ 10/12: Data Model VA (ERD) & Data Flow (Click để phóng to)</div></div>
        <div class="mt-6 space-y-6">
            <!-- Intro Block -->
            <div class="bg-teal-50 p-4 rounded-lg text-gray-700 border border-teal-100 shadow-sm italic">
                <p>Sơ đồ số 10 trình bày mô hình dữ liệu logic (Entity–Relationship Diagram) được thiết kế để hỗ trợ đầy đủ vòng đời của sản phẩm Virtual Account (VA) và toàn bộ các phân hệ thuộc Deposit Core Hub. Mô hình này đóng vai trò nền tảng của giải pháp VA, đảm bảo khả năng mở rộng, phân mảnh, truy vết và đối soát theo chuẩn hệ thống giao dịch doanh nghiệp.</p>
                <p class="mt-2 text-sm text-teal-800">
                    <strong>ERD (Entity–Relationship Diagram):</strong> Sơ đồ mô tả dữ liệu và mối quan hệ giữa các bảng trong cơ sở dữ liệu. Được tổ chức thành 5 nhóm thực thể chính phản ánh đầy đủ nghiệp vụ thu – chi, phân bổ, cấu trúc VA nhiều cấp và cơ chế shadow ledger.
                </p>
            </div>

            <!-- Entity Groups -->
            <div class="space-y-4">
                <!-- Group 1 -->
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
                    <h4 class="font-bold text-teal-900 mb-2 flex items-center gap-2">
                        <i data-lucide="network" class="w-5 h-5 text-teal-600"></i> 1. Nhóm thực thể VA & Cấu trúc phân cấp
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">VirtualAccount</span>
                            <p class="text-xs text-gray-600">Bản ghi gốc đại diện cho từng VA (trạng thái, mô tả, ngày hiệu lực, loại VA, Mapped DDA). Quy định toàn bộ logic định danh và quản trị.</p>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">VAHierarchy</span>
                            <p class="text-xs text-gray-600">Quản lý cấu trúc cây đa cấp (root, parent, child). Phục vụ tính năng roll-up balance và báo cáo theo cấu trúc doanh nghiệp.</p>
                        </div>
                    </div>
                </div>

                <!-- Group 2 -->
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
                    <h4 class="font-bold text-teal-900 mb-2 flex items-center gap-2">
                        <i data-lucide="link" class="w-5 h-5 text-teal-600"></i> 2. Nhóm thực thể Mapping & Identifier
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">VAIdentifier</span>
                            <p class="text-xs text-gray-600">Chứa các mã định danh (mã dự án, hợp đồng, household ID...) dùng để định tuyến DDA-first/remark. Hỗ trợ auto-reconciliation.</p>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">DDAEnrollment</span>
                            <p class="text-xs text-gray-600">Liên kết DDA ↔ danh sách VA thuộc DDA. Là cơ sở cho luồng DDA-first và phân bổ lãi.</p>
                        </div>
                    </div>
                </div>

                <!-- Group 3 -->
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
                    <h4 class="font-bold text-teal-900 mb-2 flex items-center gap-2">
                        <i data-lucide="book" class="w-5 h-5 text-teal-600"></i> 3. Nhóm thực thể Ledger & Posting
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">VALedger</span>
                            <p class="text-xs text-gray-600">Ghi nhận shadow posting (Incoming, Outgoing, Interest, Adjustment). Mỗi bản ghi chứa: coreTxnId, VAId, amount, status, timestamp.</p>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">VABalance</span>
                            <p class="text-xs text-gray-600">Lưu số dư hiện tại (Available, Pending, Roll-up). Cập nhật tự động sau mỗi posting.</p>
                        </div>
                    </div>
                </div>

                <!-- Group 4 -->
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
                    <h4 class="font-bold text-teal-900 mb-2 flex items-center gap-2">
                        <i data-lucide="percent" class="w-5 h-5 text-teal-600"></i> 4. Nhóm thực thể phục vụ Interest Allocation
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">InterestAllocationRule</span>
                            <p class="text-xs text-gray-600">Cấu hình phương pháp phân bổ (Pro-rata, Fixed ratio, Weighted, Average Balance...).</p>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">InterestAllocationDetail</span>
                            <p class="text-xs text-gray-600">Lưu kết quả phân bổ lãi từng kỳ cho từng VA, phục vụ sao kê và kiểm tra nội bộ.</p>
                        </div>
                    </div>
                </div>

                <!-- Group 5 -->
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition">
                    <h4 class="font-bold text-teal-900 mb-2 flex items-center gap-2">
                        <i data-lucide="external-link" class="w-5 h-5 text-teal-600"></i> 5. Nhóm thực thể Outgoing
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">OutgoingRequest</span>
                            <p class="text-xs text-gray-600">Quản lý request chi từ VA: số tiền, người hưởng, trạng thái. Đầu mối của Sequence Outgoing.</p>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-800 block mb-1">OutgoingSettlement</span>
                            <p class="text-xs text-gray-600">Ghi nhận kết quả thực tế từ Core sau khi debit DDA. Đối soát với shadow debit.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary & Value Block -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-2 text-sm uppercase">Tóm tắt đặc điểm thiết kế</h4>
                    <ul class="text-xs text-gray-600 list-disc ml-4 space-y-1">
                        <li>Tách biệt hoàn toàn ledger thật (Core) và ảo (VA).</li>
                        <li>Hỗ trợ cấu trúc VA đa cấp & event-driven.</li>
                        <li>Ledger dạng immutable, đảm bảo kiểm toán.</li>
                        <li>Cấu trúc mở, dễ bổ sung module mới (phí, hạn mức).</li>
                    </ul>
                </div>
                <div class="bg-gradient-to-r from-teal-50 to-green-50 border border-teal-200 p-4 rounded-lg">
                    <h4 class="font-bold text-teal-800 mb-2 text-sm uppercase">Giá trị kiến trúc của ERD</h4>
                    <ul class="text-xs text-teal-700 list-disc ml-4 space-y-1">
                        <li>Tối ưu mở rộng (hàng trăm nghìn VA/khách hàng).</li>
                        <li>Dễ dàng phân tách microservice/sharding.</li>
                        <li>Nền tảng cho báo cáo real-time & dashboard.</li>
                        <li>Đảm bảo toàn vẹn dữ liệu cho kiểm toán/NHNN/Big4.</li>
                    </ul>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 italic mt-2">"ERD của VA là bản thiết kế cốt lõi, đóng vai trò nền móng cho toàn bộ kiến trúc Deposit Core Hub và hệ thống Virtual Account của BIDV."</p>
        </div>

        <!-- Sơ đồ 11 -->
        <div id="diagram-11" class="section-header">4. Sơ đồ số 11 – Deployment Architecture</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/11_Logical_ERD_VA_Detail.png" alt="Logical ERD Detail"><div class="image-caption">Sơ đồ 11/12: Deployment Architecture (Click để phóng to)</div></div>
        <div class="space-y-4 text-gray-700 mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <p class="font-bold text-lg text-blue-800">Mô hình Triển khai Hiện đại (Deployment & Integration)</p>
            <p>Deposit Core Hub (Super Layer) được triển khai trên nền tảng hiện đại, tách biệt với môi trường Core Banking truyền thống. Sơ đồ này mô tả chi tiết cách hệ thống được triển khai và vận hành.</p>
            <ul class="list-disc ml-8 space-y-1">
                <li><span class="font-bold">Containerized:</span> Sử dụng Docker/Kubernetes cho VA Engine & Routing Hub.</li>
                <li><span class="font-bold">Scaling độc lập:</span> Khả năng mở rộng (Scaling) độc lập theo từng microservice (Incoming Flow, Outgoing Flow, Lookup Services...).</li>
                <li><span class="font-bold">Zero-downtime deployment:</span> Áp dụng phương pháp Rolling Update hoặc Blue/Green.</li>
                <li><span class="font-bold">HA & DR:</span> Triển khai theo mô hình Multinode Cluster (High Availability) và đồng bộ với DR Site (Disaster Recovery).</li>
            </ul>
        </div>

        <!-- Sơ đồ 12 -->
        <div id="diagram-12" class="section-header">5. Sơ đồ số 12 – Integration & Deployment Architecture (Cơ chế Tích hợp)</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/12_Integration_Deployment_VA_DepositCoreHub.png" alt="Integration & Deployment"><div class="image-caption">Sơ đồ 12/12: Integration Architecture (Click để phóng to)</div></div>
        <div class="space-y-4 text-gray-700 mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <p class="font-bold text-lg text-blue-800">Cơ chế Tích hợp Bất Đồng Bộ (Event-Driven)</p>
            <p>Kiến trúc tích hợp Event-Driven (dựa trên Event Bus như Kafka) là mấu chốt để đạt được hiệu năng và tính ổn định, giảm độ phụ thuộc đồng bộ giữa hai hệ thống Core và Super Layer.</p>
            <ul class="list-disc ml-8 space-y-1">
                <li><span class="font-bold">Core to Super Layer:</span> Core Banking phát các sự kiện (posting, interest) lên Event Bus sau khi hoàn thành hạch toán sổ cái thật (DDA).</li>
                <li><span class="font-bold">Super Layer Listener:</span> VA Engine lắng nghe sự kiện. Chỉ khi nhận được sự kiện xác nhận Ghi Có/Ghi Nợ thành công từ Core, VA Engine mới tiến hành Ghi Có/Ghi Nợ vào <span class="text-indigo-700 font-semibold">VA Ledger (sổ cái ảo)</span>.</li>
                <li><span class="font-bold">Đảm bảo:</span> Cơ chế <span class="font-semibold text-red-700">at-least-once delivery</span> và retry để duy trì tính toàn vẹn của giao dịch.</li>
            </ul>
        </div>

        <h2 class="sub-header"><i data-lucide="trello" class="w-6 h-6 text-indigo-500"></i> II. Nhóm 2 – Sơ đồ Kiến trúc Logic & Luồng Xử lý Nghiệp vụ</h2>
        <p class="pl-2 text-gray-700 italic">Các sơ đồ này mô tả chi tiết từng luồng nghiệp vụ, bao gồm luồng giao dịch, quản lý VA và đối chiếu (Sơ đồ #3 $\to$ #9).</p>

        <!-- Sơ đồ 3 -->
        <div id="diagram-3" class="section-header">6. Sơ đồ số 3 – Flow #1: VA-first Incoming (Nộp tiền vào VA)</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/03_Flow_VA_First_Incoming.png" alt="VA-first Incoming Flow"><div class="image-caption">Sơ đồ 3/12: VA-first Incoming Flow (Nộp tiền vào VA) (Click để phóng to)</div></div>
        <div class="mt-6 space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg text-gray-700 border border-blue-100 shadow-sm italic">
                <p>Sơ đồ này mô tả luồng xử lý khi khách hàng chủ động nhập số <span class="font-semibold text-blue-700">Virtual Account (VA)</span> trên kênh giao dịch (Internet Banking, H2H, API, quầy…). Đây là mô hình chuẩn quốc tế (“VA-first”), đảm bảo giao dịch được kiểm tra tính hợp lệ ngay từ đầu, giúp giảm sai sót và giảm chi phí tra soát.</p>
            </div>
            <div class="space-y-4">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">1</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition"><h4 class="font-bold text-gray-900 mb-1">Kênh giao dịch gửi yêu cầu theo số VA</h4><p class="text-sm text-gray-600 mb-2">Khách hàng nhập trực tiếp số VA thay vì số DDA thực.</p><ul class="text-xs text-gray-500 list-disc ml-4"><li>Thông tin: Số VA, Số tiền, Người gửi/nhận, Tham chiếu, Nghiệp vụ thu hộ...</li><li class="italic text-blue-600 mt-1">→ Kênh không xử lý, chuyển toàn bộ request vào Routing Hub.</li></ul></div>
                </div>
                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">2</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition"><h4 class="font-bold text-gray-900 mb-1">Routing Hub gửi yêu cầu xác thực sang VA Engine</h4><p class="text-sm text-gray-600 mb-2">Routing Hub thực hiện vai trò “chốt chặn” nghiệp vụ:</p><ul class="text-xs text-gray-500 list-disc ml-4 space-y-1"><li>Gọi dịch vụ Validate VA tại VA Engine.</li><li>Kiểm tra: Tồn tại, Trạng thái (Hoạt động/Khóa), Ràng buộc (Thu/Chi/Hạn mức).</li><li>Xác định <span class="font-semibold text-gray-700">Mapped DDA</span> – tài khoản thật gắn với VA.</li></ul><div class="flex gap-2 mt-2 text-xs font-semibold"><span class="text-red-600 bg-red-50 px-2 py-1 rounded">Không hợp lệ → Trả lỗi ngay</span><span class="text-green-600 bg-green-50 px-2 py-1 rounded">Hợp lệ → Lấy DDA & tiếp tục</span></div></div>
                </div>
                <!-- Step 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">3</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition"><h4 class="font-bold text-gray-900 mb-1">Routing Hub hạch toán Credit vào DDA qua Core Banking</h4><p class="text-sm text-gray-600">Routing Hub sử dụng Mapped DDA để gọi Core:</p><ul class="text-xs text-gray-500 list-disc ml-4 mt-1"><li>Thực hiện ghi Có vào DDA (hạch toán thật).</li><li>Lưu bút toán tại Core.</li><li>Kiểm tra hạn mức, trạng thái tài khoản thật.</li></ul></div>
                </div>
                <!-- Step 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">4</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition"><h4 class="font-bold text-gray-900 mb-1">Core Banking phát sự kiện Credit Notification</h4><p class="text-sm text-gray-600">Sau khi hạch toán thành công, Core phát event lên Event Bus:</p><div class="mt-2 text-xs bg-gray-50 p-2 rounded border text-gray-600 font-mono">{ Loại giao dịch, Số dư mới, Số tiền, Txn ID, DDA }</div><p class="text-xs text-gray-500 mt-1 italic">→ Sự kiện được chuyển đến Routing Hub để xử lý tiếp cho VA.</p></div>
                </div>
                <!-- Step 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">5</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition"><h4 class="font-bold text-gray-900 mb-1">Routing Hub thông báo Post-Notification cho VA Engine</h4><p class="text-sm text-gray-600">Xác nhận bút toán Core thành công & gửi thông tin để VA ghi ledger.</p><p class="text-xs text-indigo-600 font-semibold mt-1 bg-indigo-50 inline-block px-2 py-1 rounded">Đảm bảo: Không ghi trước - Không ghi 2 lần - Chỉ ghi khi Core thành công.</p></div>
                </div>
                <!-- Step 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">6</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition"><h4 class="font-bold text-gray-900 mb-1">VA Engine ghi Shadow Posting & cập nhật số dư</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2"><div class="text-xs text-gray-600 bg-gray-50 p-2 rounded border"><strong>1. Tạo Shadow Posting (Credit)</strong><br>Lưu vào VA Ledger.</div><div class="text-xs text-gray-600 bg-gray-50 p-2 rounded border"><strong>2. Cập nhật Số Dư</strong><br>VA nhận tiền & Roll-up balance cấp cha.</div></div><p class="text-xs text-gray-500 mt-2 italic">Cơ chế Idempotency đảm bảo mỗi giao dịch Core tương ứng đúng 1 shadow posting.</p></div>
                </div>
                <!-- Step 7 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">7</div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm flex-1"><h4 class="font-bold text-green-900 mb-1">Luồng giao dịch hoàn tất</h4><ul class="text-sm text-green-800 list-disc ml-4"><li>Sổ cái Core & Sổ cái ảo VA được cập nhật.</li><li>Số dư VA các cấp đồng bộ gần real-time.</li><li>Giao dịch hiển thị đúng cho khách hàng ở cấp VA tương ứng.</li></ul></div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-emerald-50 to-green-50 border-l-4 border-emerald-500 p-5 rounded-r-lg shadow-sm">
                <h4 class="font-bold text-emerald-800 text-lg mb-3 flex items-center gap-2"><i data-lucide="award" class="w-6 h-6"></i> Giá trị của luồng VA-first</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-emerald-600 mt-0.5"></i><span><strong>Không có giao dịch “lạc VA”:</strong> VA được kiểm tra trước khi vào Core.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-emerald-600 mt-0.5"></i><span><strong>Tốc độ đối soát nhanh:</strong> VA biết chính xác giao dịch thuộc về ai.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-emerald-600 mt-0.5"></i><span><strong>Tiết kiệm chi phí vận hành:</strong> Giảm tra soát thủ công.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-emerald-600 mt-0.5"></i><span><strong>Linh hoạt mở rộng:</strong> Không yêu cầu sửa logic tại Core.</span></div>
                </div>
                <p class="mt-3 text-emerald-900 font-semibold italic text-sm text-center border-t border-emerald-200 pt-2">"Luồng này là trụ cột chính trong thiết kế Deposit Core Hub và giải pháp Virtual Account của BIDV"</p>
            </div>
        </div>

        <!-- Sơ đồ 4 -->
        <div id="diagram-4" class="section-header">7. Sơ đồ số 4 – DDA-first Incoming Flow (Credit to VA)</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/04_Flow_DDA_First_Incoming.png" alt="DDA-first Incoming Flow"><div class="image-caption">Sơ đồ 4/12: VA-first Incoming Flow (Credit to VA) (Click để phóng to)</div></div>
        
        <div class="mt-6 space-y-6">
            <!-- Intro Block -->
            <div class="bg-blue-50 p-4 rounded-lg text-gray-700 border border-blue-100 shadow-sm italic">
                <p>Sơ đồ này mô tả mô hình xử lý trong trường hợp khách hàng không nhập Virtual Account (VA), mà chỉ nhập số tài khoản DDA thật của BIDV (thông qua chuyển khoản liên ngân hàng, quầy, POS, hoặc các kênh không hỗ trợ VA). Đây là mô hình phổ biến trong hệ thống ngân hàng Việt Nam, nơi VA chưa được hỗ trợ xuyên kênh hoặc xuyên ngân hàng.</p>
                <p class="mt-2 font-semibold text-blue-800">Luồng DDA-first giúp BIDV vẫn áp dụng Virtual Account với những khách hàng đã đăng ký dịch vụ VA, ngay cả khi giao dịch không có số VA ở đầu vào.</p>
            </div>

            <!-- Steps Container -->
            <div class="space-y-4">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">1</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Kênh gửi giao dịch theo số DDA</h4>
                        <p class="text-sm text-gray-600 mb-2">Giao dịch đến thường có cấu trúc:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4">
                            <li>Số DDA của khách hàng tại BIDV</li>
                            <li>Số tiền</li>
                            <li>Thông tin người gửi</li>
                            <li>Tham chiếu/remark</li>
                            <li><strong>Không có số VA vì hệ thống gửi không hỗ trợ</strong></li>
                        </ul>
                        <p class="text-xs italic text-blue-600 mt-2">Kênh gửi trực tiếp DDA → Routing Hub của Deposit Core Hub.</p>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">2</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gọi Core Banking để ghi Có vào DDA</h4>
                        <p class="text-sm text-gray-600 mb-1">Theo đúng chuẩn xử lý ngân hàng, Routing Hub:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Nhận request</li>
                            <li>Không attempt tìm VA ở bước đầu (vì chưa chắc giao dịch liên quan đến VA)</li>
                            <li>Gọi Core Banking thực hiện ghi Có DDA thật</li>
                        </ul>
                        <div class="mt-2 text-xs bg-gray-50 p-2 rounded border text-gray-600">
                            <strong>Core Banking hạch toán:</strong> Lưu bút toán, kiểm tra hạn mức/trạng thái, cập nhật số dư DDA. <br/>
                            Khi thành công: Core phát <strong>Credit Notification Event</strong> lên Event Bus.
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">3</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Deposit Event Bus phát tín hiệu giao dịch thành công</h4>
                        <p class="text-sm text-gray-600 mb-1">Sự kiện chứa:</p>
                        <div class="flex flex-wrap gap-2 text-xs text-gray-500 font-mono mt-1">
                            <span class="bg-gray-100 px-2 py-1 rounded">Số DDA</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Số tiền</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Mã giao dịch Core</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Remark</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Thời điểm</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Người gửi/nguồn kênh</span>
                        </div>
                        <p class="text-xs italic text-gray-500 mt-2">Routing Hub tiếp nhận sự kiện để chuyển sang bước phân tích VA.</p>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">4</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub kiểm tra xem DDA này có đăng ký Virtual Account hay không</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub truy vấn VA Enrollment Registry:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>DDA này có gắn với một hoặc nhiều VA không?</li>
                            <li>Nếu có, VA đang hoạt động không?</li>
                            <li>Có rule phân bổ VA theo remark/reference không?</li>
                            <li>Có cần match theo mã hợp đồng/hộ gia đình/dự án/PO không?</li>
                        </ul>
                        <div class="flex flex-col gap-1 mt-2 text-xs font-semibold">
                            <span class="text-gray-500 bg-gray-100 px-2 py-1 rounded border">Nếu DDA không có dịch vụ VA → Kết thúc luồng / Giao dịch chỉ ghi Có DDA.</span>
                            <span class="text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100">Nếu DDA có dịch vụ VA → Tiếp tục chuyển sang VA Engine tạo shadow posting.</span>
                        </div>
                    </div>
                </div>

                <!-- Step 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">5</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gọi VA Engine để xác định VA nhận giao dịch</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                            <div class="text-xs text-gray-600">
                                <strong>Gửi sự kiện enriched sang VA Engine:</strong>
                                <ul class="list-disc ml-4 mt-1">
                                    <li>Transaction ID của Core</li>
                                    <li>Số DDA đã ghi Có</li>
                                    <li>Số tiền</li>
                                    <li>Remark/Reference</li>
                                    <li>Ngày giá trị</li>
                                </ul>
                            </div>
                            <div class="text-xs text-blue-800 bg-blue-50 p-2 rounded border border-blue-100">
                                <strong>VA Engine sẽ:</strong>
                                <ul class="list-disc ml-4 mt-1">
                                    <li>Tìm VA phù hợp theo rule (nếu remark chứa mã xác định)</li>
                                    <li>Hoặc gán mặc định vào một VA tổng (parent VA) nếu không rõ</li>
                                    <li>Kiểm tra trạng thái VA</li>
                                    <li>Chuẩn bị ghi shadow posting</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">6</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">VA Engine ghi Shadow Posting và cập nhật số dư VA</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
                             <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded border"><strong>1. Kiểm tra Idempotency</strong><br>Tránh trùng lặp giao dịch.</div>
                             <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded border"><strong>2. Ghi bút toán ảo CREDIT</strong><br>Cho VA tương ứng.</div>
                             <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded border"><strong>3. Cập nhật số dư</strong><br>Số dư VA cấp cuối & Roll-up balance cấp cha.</div>
                        </div>
                        <p class="text-xs text-indigo-700 mt-2 font-medium italic">Sơ đồ đã thể hiện đầy đủ: Core hạch toán trước – VA xử lý sau, giúp BIDV phù hợp với các kênh không hỗ trợ VA nhưng vẫn duy trì kiểm soát dòng tiền theo từng VA.</p>
                    </div>
                </div>

                <!-- Step 7 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">7</div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm flex-1">
                        <h4 class="font-bold text-green-900 mb-1">Luồng DDA-first hoàn tất</h4>
                        <ul class="text-sm text-green-800 list-disc ml-4 space-y-1">
                            <li>Core đã hạch toán giao dịch thật.</li>
                            <li>VA Ledger đã có shadow posting đúng VA.</li>
                            <li>Số dư VA và các cấp cha được cập nhật đầy đủ.</li>
                            <li>Doanh nghiệp có thể đối soát theo từng VA, kể cả khi giao dịch ban đầu không nhập số VA.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Value Block -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-l-4 border-indigo-500 p-5 rounded-r-lg shadow-sm">
                <h4 class="font-bold text-indigo-800 text-lg mb-3 flex items-center gap-2"><i data-lucide="star" class="w-6 h-6"></i> Giá trị của luồng DDA-first</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mt-0.5"></i><span><strong>Khả năng bao phủ rộng:</strong> Phù hợp với tất cả kênh thanh toán tại Việt Nam.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mt-0.5"></i><span><strong>Không cần sửa hệ thống ngoài:</strong> Tương thích NapAS, ngân hàng khác, ví điện tử.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mt-0.5"></i><span><strong>Trải nghiệm đầy đủ:</strong> Khách hàng VA không bị bỏ sót giao dịch.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mt-0.5"></i><span><strong>Giảm sai sót đối soát:</strong> Đặc biệt hiệu quả với remark-based routing.</span></div>
                </div>
                <p class="mt-3 text-indigo-900 font-semibold italic text-sm text-center border-t border-indigo-200 pt-2">"Luồng này là bổ sung quan trọng cho VA-first, đảm bảo Virtual Account có thể vận hành hiệu quả trong môi trường đa kênh, không đồng nhất như Việt Nam."</p>
            </div>
        </div>

        <!-- Sơ đồ 5 -->
        <div id="diagram-5" class="section-header">8. Sơ đồ số 5 – Outgoing từ VA (Debit from VA)</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/05_Flow_Outgoing_From_VA.png" alt="Outgoing from VA"><div class="image-caption">Sơ đồ 5/12: Outgoing Transaction Flow (Debit from VA) (Click để phóng to)</div></div>
        
        <div class="mt-6 space-y-6">
            <!-- Intro Block -->
            <div class="bg-red-50 p-4 rounded-lg text-gray-700 border border-red-100 shadow-sm italic">
                <p>Sơ đồ mô tả quy trình xử lý khi khách hàng yêu cầu chuyển tiền từ một tài khoản Virtual Account (VA) sang tài khoản DDA khác trong BIDV hoặc tài khoản tại ngân hàng khác. Đây là luồng nghiệp vụ quan trọng để VA trở thành “tài khoản có khả năng chi”, phục vụ mô hình POBO (Payment On Behalf Of), chi hộ theo dự án, chi ngân sách, hoặc quản lý dòng tiền tập đoàn.</p>
                <p class="mt-2 font-semibold text-red-800">Luồng Outgoing VA được thiết kế với nguyên tắc: VA kiểm soát số dư – Core Banking thực hiện bút toán thật.</p>
            </div>

            <!-- Steps Container -->
            <div class="space-y-4">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">1</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Kênh giao dịch gửi lệnh chi từ VA</h4>
                        <p class="text-sm text-gray-600 mb-2">Khách hàng hoặc hệ thống doanh nghiệp (H2H/API) tạo lệnh:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4">
                            <li>Virtual Account nguồn</li>
                            <li>Số tiền muốn chuyển</li>
                            <li>Người hưởng, Ngân hàng hưởng</li>
                            <li>Mô tả giao dịch (remark)</li>
                            <li>Context nghiệp vụ (POBO, chi lương, chi theo dự án…)</li>
                        </ul>
                        <p class="text-xs italic text-red-600 mt-2">Kênh chuyển request đến Routing Hub để xử lý.</p>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">2</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gọi VA Engine để kiểm tra quyền & số dư</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub thực hiện gọi VA Outgoing Service nhằm:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Kiểm tra VA tồn tại và hoạt động</li>
                            <li>Kiểm tra rule nghiệp vụ: VA có được phép chi không?</li>
                            <li>Xác định VA ở cấp con/cha nào trong cây VA</li>
                            <li>Truy vấn số dư VA (real balance hoặc roll-up balance tùy chính sách)</li>
                            <li>Kiểm tra hạn mức giao dịch</li>
                            <li>Xác định Mapped DDA – tài khoản thật đại diện cho VA</li>
                        </ul>
                        <div class="flex flex-col gap-1 mt-2 text-xs font-semibold">
                            <span class="text-red-600 bg-red-50 px-2 py-1 rounded border border-red-100">Nếu không đủ điều kiện → Gửi lỗi về kênh, không gọi Core.</span>
                            <span class="text-green-600 bg-green-50 px-2 py-1 rounded border border-green-100">Nếu hợp lệ → VA Engine cho phép chuyển bước tiếp theo.</span>
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">3</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">VA Engine ghi Shadow Debit trước (bảo lưu số dư)</h4>
                        <p class="text-sm text-gray-600 mb-2">Để tránh tình trạng “double spending”, VA Engine:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Ghi shadow posting DEBIT tạm thời</li>
                            <li>Giảm số dư VA ngay lập tức</li>
                            <li>Cập nhật roll-up balance trên cây VA</li>
                            <li>Tạo transaction reference để liên kết với giao dịch DDA thật</li>
                        </ul>
                        <p class="text-xs italic text-gray-500 mt-2 font-medium">Shadow posting ở bước này đảm bảo VA phản ánh chính xác khả năng chi, ngay cả khi Core xử lý trễ hoặc asynchronous.</p>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">4</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gửi yêu cầu trích nợ DDA sang Core Banking</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                            <div class="text-xs text-gray-600">
                                <strong>Routing Hub (sử dụng Mapped DDA):</strong>
                                <ul class="list-disc ml-4 mt-1">
                                    <li>Gửi yêu cầu DEBIT DDA (hạch toán thật)</li>
                                    <li>Kèm theo thông tin người hưởng, remark, loại giao dịch</li>
                                </ul>
                            </div>
                            <div class="text-xs text-gray-600">
                                <strong>Core thực hiện:</strong>
                                <ul class="list-disc ml-4 mt-1">
                                    <li>Kiểm tra số dư DDA</li>
                                    <li>Kiểm tra hạn mức tài khoản, rủi ro AML</li>
                                    <li>Ghi DEBIT và tạo giao dịch outgoing</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-2 text-xs bg-red-50 p-2 rounded border border-red-100 text-red-800">
                            <strong>Nếu Core từ chối (hết tiền, tài khoản đóng…):</strong> Routing Hub trả lỗi về kênh & VA Engine roll-back shadow posting, khôi phục số dư.
                        </div>
                    </div>
                </div>

                <!-- Step 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">5</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Core phát sự kiện Debit Notification lên Event Bus</h4>
                        <p class="text-sm text-gray-600 mb-1">Khi debit thành công, Core gửi:</p>
                        <div class="flex flex-wrap gap-2 text-xs text-gray-500 font-mono mt-1">
                            <span class="bg-gray-100 px-2 py-1 rounded">Số DDA bị trích nợ</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Số tiền</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Txn ID Core</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Chi tiết outgoing</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Success Status</span>
                        </div>
                        <p class="text-xs italic text-gray-500 mt-2">Routing Hub nhận sự kiện để hoàn tất xử lý phía VA.</p>
                    </div>
                </div>

                <!-- Step 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">6</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub thông báo lại VA Engine để finalize transaction</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub gọi VA Engine – ConfirmOutgoing:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Xác nhận bút toán shadow debit thành bút toán hoàn tất</li>
                            <li>Cập nhật trạng thái giao dịch</li>
                            <li>Ghi VA Ledger đầy đủ</li>
                            <li>Hoàn thiện số dư VA và roll-up theo cây</li>
                        </ul>
                        <p class="text-xs text-indigo-700 mt-2 font-medium italic">Nếu Core gửi event muộn, VA Engine dùng cơ chế idempotency để đảm bảo không ghi trùng.</p>
                    </div>
                </div>

                <!-- Step 7 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">7</div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm flex-1">
                        <h4 class="font-bold text-green-900 mb-1">Luồng giao dịch hoàn tất</h4>
                        <ul class="text-sm text-green-800 list-disc ml-4 space-y-1">
                            <li>DDA bị trích nợ thật.</li>
                            <li>VA Ledger ghi shadow debit.</li>
                            <li>Số dư VA giảm tức thời.</li>
                            <li>Số dư các VA cấp trên (roll-up) tự động cập nhật.</li>
                            <li>Kênh nhận thông tin giao dịch thành công.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Value Block -->
            <div class="bg-gradient-to-r from-orange-50 to-red-50 border-l-4 border-red-500 p-5 rounded-r-lg shadow-sm">
                <h4 class="font-bold text-red-800 text-lg mb-3 flex items-center gap-2"><i data-lucide="star" class="w-6 h-6"></i> Giá trị thiết kế Outgoing từ VA</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-red-600 mt-0.5"></i><span><strong>Kiểm soát số dư tại VA:</strong> Không phụ thuộc thời gian xử lý Core.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-red-600 mt-0.5"></i><span><strong>Hỗ trợ đầy đủ POBO:</strong> Chi hộ, thanh toán phân cấp theo VA.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-red-600 mt-0.5"></i><span><strong>Không can thiệp vào Core:</strong> Chỉ gửi yêu cầu debit DDA như giao dịch bình thường.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-red-600 mt-0.5"></i><span><strong>An toàn:</strong> Giảm rủi ro, chống double-spending.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-red-600 mt-0.5"></i><span><strong>Cấu trúc mở:</strong> Hỗ trợ cả chi nội bộ và liên ngân hàng.</span></div>
                </div>
                <p class="mt-3 text-red-900 font-semibold italic text-sm text-center border-t border-red-200 pt-2">"Luồng Outgoing từ VA là điều kiện để BIDV triển khai đầy đủ hệ sinh thái Virtual Account và mở rộng sản phẩm Cash Management cho doanh nghiệp."</p>
            </div>
        </div>

        <!-- Sơ đồ 6 -->
        <div id="diagram-6" class="section-header">9. Sơ đồ số 6 – Interest Allocation Flow</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/06_Flow_Interest_Allocation.png" alt="Interest Allocation Flow"><div class="image-caption">Sơ đồ 6/12: Interest Allocation Flow (Click để phóng to)</div></div>
       <div class="mt-6 space-y-6">
            <!-- Intro Block -->
            <div class="bg-amber-50 p-4 rounded-lg text-gray-700 border border-amber-100 shadow-sm italic">
                <p>Sơ đồ này mô tả quy trình phân bổ lãi tiền gửi từ tài khoản DDA thực (do Core Banking quản lý) xuống các tài khoản Virtual Account (VA) theo cơ chế shadow posting. Đây là chức năng quan trọng giúp mô hình VA hoạt động tương đương tài khoản phân tách dòng tiền (sub-ledger), phục vụ:</p>
                <ul class="list-disc ml-5 mt-2 text-sm">
                    <li>Quản lý dự án / hợp đồng</li>
                    <li>Quản lý dòng tiền đa đơn vị / đa công ty</li>
                    <li>Thu hộ/chi hộ có tính chất hoàn trả</li>
                    <li>Dịch vụ tài chính doanh nghiệp nâng cao</li>
                </ul>
                <p class="mt-2 font-semibold text-amber-800 text-sm">Phân bổ lãi VA là một luồng internal posting, không tạo ra giao dịch thật tại Core, nhưng đảm bảo mỗi VA được hưởng lợi tức theo số dư hoặc quy tắc phân bổ đã đăng ký.</p>
            </div>

            <!-- Steps Container -->
            <div class="space-y-4">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-amber-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">1</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Core Banking tính lãi thật trên tài khoản DDA</h4>
                        <p class="text-sm text-gray-600 mb-2">Đến kỳ (ngày, tháng hoặc theo cấu hình), Core Banking thực hiện:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Tính lãi trên tài khoản DDA theo sản phẩm tiền gửi</li>
                            <li>Hạch toán bút toán lãi vào DDA thật & Cập nhật Core Ledger</li>
                            <li>Phát sự kiện <strong>InterestCreditedEvent</strong> lên Deposit Event Bus</li>
                        </ul>
                        <div class="mt-2 text-xs bg-amber-50 p-2 rounded border border-amber-100 text-amber-800">
                            <strong>Thông tin sự kiện:</strong> Số DDA, Số tiền lãi thật, Kỳ tính, Balance dùng để tính lãi, ID giao dịch Core.
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-amber-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">2</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub tiếp nhận sự kiện lãi từ Core</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub đảm nhiệm vai trò trung gian:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Nhận event lãi từ Event Bus</li>
                            <li>Enrich thông tin (ngày value, DDA → danh sách VA tương ứng)</li>
                            <li>Định tuyến sự kiện lãi sang <strong>Interest Allocation Engine</strong> thuộc Deposit Core Hub</li>
                        </ul>
                        <p class="text-xs italic text-gray-500 mt-2">Routing Hub không tính toán lãi, chỉ điều phối luồng.</p>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-amber-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">3</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Interest Allocation Engine xác định danh sách VA để phân bổ</h4>
                        <p class="text-sm text-gray-600 mb-1">Engine sử dụng VA Registry & VA Balance Table để:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 mb-2">
                            <li>Liệt kê toàn bộ VA thuộc DDA (cấp 1–4) và trích số dư cuối kỳ</li>
                            <li>Loại VA khóa, đóng hoặc không đủ điều kiện nhận lãi</li>
                        </ul>
                        <p class="text-sm text-gray-600 mb-1 font-semibold">Xác định phương pháp phân bổ theo cấu hình:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-gray-500">
                            <div class="bg-gray-50 p-2 rounded">Pro-rata theo số dư cuối kỳ</div>
                            <div class="bg-gray-50 p-2 rounded">Pro-rata theo số dư bình quân</div>
                            <div class="bg-gray-50 p-2 rounded">Weighted by business rule</div>
                            <div class="bg-gray-50 p-2 rounded">Fixed ratio (tỉ lệ cố định)</div>
                        </div>
                        <p class="text-xs text-indigo-700 mt-2 italic">Kết quả: Engine tạo bảng phân bổ chi tiết lãi cho từng VA.</p>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-amber-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">4</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Engine tạo Shadow Posting lãi cho từng VA</h4>
                        <p class="text-sm text-gray-600 mb-2">Interest Allocation Engine thực hiện:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li><strong>Shadow Posting CREDIT</strong> vào ledger của từng VA</li>
                            <li>Ghi nhật ký lãi: VAId, số tiền, tỷ lệ phân bổ, reference kỳ lãi</li>
                            <li>Cập nhật số dư VA nhận lãi và roll-up balance các cấp cha</li>
                        </ul>
                        <div class="text-xs font-semibold text-red-600 bg-red-50 px-2 py-1 rounded mt-2 border border-red-100 inline-block">
                            Lưu ý: Không có bút toán thật nào được ghi thêm vào Core ở bước này.
                        </div>
                    </div>
                </div>

                <!-- Step 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-amber-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">5</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Cập nhật báo cáo & hiển thị lãi trên VA</h4>
                        <p class="text-sm text-gray-600 mb-2">Sau khi phân bổ:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>VA Ledger lưu trữ đầy đủ giao dịch lãi</li>
                            <li>VA Balance Engine cập nhật số dư tức thời</li>
                            <li>Hệ thống báo cáo sinh: Sao kê lãi VA, Bảng phân bổ lãi DDA, Bảng đối soát.</li>
                        </ul>
                        <p class="text-xs italic text-gray-500 mt-1">Lãi được hiển thị cho khách hàng ngay khi engine hoàn tất.</p>
                    </div>
                </div>

                <!-- Step 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">6</div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm flex-1">
                        <h4 class="font-bold text-green-900 mb-1">Luồng phân bổ lãi hoàn tất</h4>
                        <ul class="text-sm text-green-800 list-disc ml-4 space-y-1">
                            <li>DDA nhận lãi thật từ Core.</li>
                            <li>Các VA nhận lãi ảo theo rule đã đăng ký.</li>
                            <li>Số dư VA và roll-up balance được đồng bộ.</li>
                            <li>Khách hàng có báo cáo lãi chi tiết theo từng VA.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Value Block -->
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-orange-400 p-5 rounded-r-lg shadow-sm">
                <h4 class="font-bold text-orange-800 text-lg mb-3 flex items-center gap-2"><i data-lucide="pie-chart" class="w-6 h-6"></i> Giá trị của luồng Interest Allocation</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-orange-600 mt-0.5"></i><span><strong>Minh bạch dòng tiền:</strong> Theo từng tiểu khoản ảo.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-orange-600 mt-0.5"></i><span><strong>Lợi thế Cash Management:</strong> Vượt trội so với các ngân hàng khác.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-orange-600 mt-0.5"></i><span><strong>Không tác động Core:</strong> Không tăng phức tạp cho kế toán thật.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-orange-600 mt-0.5"></i><span><strong>Đáp ứng nhu cầu DN:</strong> Quản lý dự án, chi phí vốn, holding.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-orange-600 mt-0.5"></i><span><strong>Dễ mở rộng:</strong> Linh hoạt theo thị trường và chính sách.</span></div>
                </div>
                <p class="mt-3 text-orange-900 font-semibold italic text-sm text-center border-t border-orange-200 pt-2">"Logic phân bổ lãi là thành phần thiết yếu để hệ sinh thái VA của BIDV tiệm cận chuẩn quốc tế và đáp ứng các case phức tạp trong tương lai."</p>
            </div>
        </div>

        <!-- Sơ đồ 7 -->
        <div id="diagram-7" class="section-header">10. Sơ đồ số 7 – Sequence VA-first (Chuyển tiền vào VA)</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/07_Sequence_VA_First.png" alt="Sequence VA First"><div class="image-caption">Sơ đồ 7/12:Sequence VA-first (Click để phóng to)</div></div>
     <div class="mt-6 space-y-6">
            <!-- Intro Block -->
            <div class="bg-indigo-50 p-4 rounded-lg text-gray-700 border border-indigo-100 shadow-sm italic">
                <p>Sơ đồ này mô tả chuỗi tương tác giữa các thành phần hệ thống khi khách hàng nhập trực tiếp Virtual Account (VA) trên kênh giao dịch. Đây là luồng nghiệp vụ chuẩn, đảm bảo VA được kiểm tra ngay từ đầu và mọi giao dịch thu tiền được ghi nhận chính xác vào tài khoản VA.</p>
                <div class="mt-2 font-semibold text-indigo-800 text-sm">
                    <span class="uppercase font-bold">Mục tiêu chính:</span> Xác thực VA trước – Hạch toán DDA sau – Ghi Shadow Posting cuối, đảm bảo giao dịch không bị “lạc VA”, không sai lệch số dư, và tránh sai sót khó đối soát.
                </div>
            </div>

            <!-- Steps Container -->
            <div class="space-y-4">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">1</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Kênh gửi yêu cầu thanh toán theo số VA</h4>
                        <p class="text-sm text-gray-600 mb-2">Khách hàng (Internet Banking, H2H, API doanh nghiệp, quầy) gửi yêu cầu gồm:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Số VA, Số tiền</li>
                            <li>Người gửi</li>
                            <li>Tham chiếu giao dịch (invoice, contract…)</li>
                        </ul>
                        <p class="text-xs italic text-indigo-600 mt-2">Toàn bộ request được chuyển sang Routing Hub, không xử lý ở kênh.</p>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">2</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gọi VA Engine để xác thực VA (ValidateVA)</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub thực hiện cuộc gọi kiểm tra trước:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>VA có tồn tại và đang hoạt động (ACTIVE) không?</li>
                            <li>Thuộc DDA nào? Có phù hợp nghiệp vụ không?</li>
                        </ul>
                        <div class="flex flex-col gap-1 mt-2 text-xs font-semibold">
                            <span class="text-green-600 bg-green-50 px-2 py-1 rounded border border-green-100">APPROVED + Mapped DDA</span>
                            <span class="text-red-600 bg-red-50 px-2 py-1 rounded border border-red-100">REJECTED (VA_NOT_FOUND, LOCKED...) → Trả lỗi về kênh.</span>
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-slate-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">3</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gửi yêu cầu hạch toán thật sang Core Banking</h4>
                        <p class="text-sm text-gray-600 mb-2">Nếu VA hợp lệ, Routing Hub sử dụng Mapped DDA để:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Gửi yêu cầu CREDIT vào tài khoản thật.</li>
                            <li>Gọi Deposit Module hạch toán kế toán thật.</li>
                            <li>Kiểm tra hạn mức, trạng thái tài khoản thật.</li>
                        </ul>
                        <p class="text-xs italic text-slate-600 mt-2">Nếu Core từ chối → Routing Hub trả lỗi về kênh; VA không ghi shadow posting.</p>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-slate-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">4</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Core Banking phát sự kiện Credit Notification lên Event Bus</h4>
                        <p class="text-sm text-gray-600 mb-1">Sau khi hạch toán thành công, Core gửi sự kiện qua Deposit Event Bus:</p>
                        <div class="mt-2 text-xs bg-slate-50 p-2 rounded border border-slate-100 text-slate-800 font-mono">
                            { DDA, Số tiền, Transaction ID, Value Date, Info }
                        </div>
                    </div>
                </div>

                <!-- Step 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">5</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub nhận event và chuyển tiếp cho VA Engine</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub đóng vai trò “bridge”:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Nhận sự kiện từ Event Bus & Áp dụng rule định tuyến.</li>
                            <li>Gửi thông báo <strong>NotifyCreditPosted</strong> sang VA Engine.</li>
                        </ul>
                        <p class="text-xs italic text-purple-600 mt-2">Mục tiêu: VA chỉ tạo shadow posting khi Core đã ghi thật.</p>
                    </div>
                </div>

                <!-- Step 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">6</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">VA Engine tạo Shadow Posting và cập nhật số dư VA</h4>
                        <p class="text-sm text-gray-600 mb-2">Khi nhận thông báo từ Routing Hub, VA Engine:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Kiểm tra idempotency (không ghi trùng giao dịch).</li>
                            <li>Tạo Shadow Posting CREDIT.</li>
                            <li>Cập nhật số dư VA cấp thấp nhất & Roll-up balance các cấp cha.</li>
                            <li>Lưu VA Ledger để phục vụ sao kê, đối soát.</li>
                        </ul>
                        <p class="text-xs font-semibold text-purple-800 mt-2">→ Từ đây, VA phản ánh chính xác dòng tiền doanh nghiệp.</p>
                    </div>
                </div>

                <!-- Step 7 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">7</div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm flex-1">
                        <h4 class="font-bold text-green-900 mb-1">Luồng hoàn tất</h4>
                        <p class="text-sm text-green-800 mb-2">Kênh nhận thông báo giao dịch thành công. Luồng đảm bảo:</p>
                        <ul class="text-xs text-green-700 list-disc ml-4 space-y-1">
                            <li>Không có giao dịch bị ghi nhầm VA.</li>
                            <li>Số dư VA khớp với DDA (gần real-time).</li>
                            <li>Doanh nghiệp có số liệu ngay lập tức.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Value Block -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-indigo-500 p-5 rounded-r-lg shadow-sm">
                <h4 class="font-bold text-indigo-800 text-lg mb-3 flex items-center gap-2"><i data-lucide="git-merge" class="w-6 h-6"></i> Giá trị của luồng Sequence VA-first</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mt-0.5"></i><span><strong>Tránh thất thoát:</strong> Giảm sai mapping, giảm tra soát thủ công.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mt-0.5"></i><span><strong>Đảm bảo VA luôn đúng:</strong> Không phụ thuộc remark hay heuristic.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mt-0.5"></i><span><strong>Khả năng mở rộng mạnh mẽ:</strong> Phù hợp chuẩn quốc tế (India, Indonesia, Singapore).</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-indigo-600 mt-0.5"></i><span><strong>Không tác động Core:</strong> Tách hoàn toàn nghiệp vụ mở rộng khỏi hệ thống lõi.</span></div>
                </div>
                <p class="mt-3 text-indigo-900 font-semibold italic text-sm text-center border-t border-indigo-200 pt-2">"Luồng này là nền tảng quan trọng nhất trong kiến trúc Virtual Account của BIDV"</p>
            </div>
        </div>

        <!-- Sơ đồ 8 -->
        <div id="diagram-8" class="section-header">11. Sơ đồ số 8 – Sequence Outgoing VA (Trích nợ VA)</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/08_Sequence_Outgoing_VA.png" alt="Sequence Outgoing VA"><div class="image-caption">Sơ đồ 8/12: Sequence Outgoing VA (Click để phóng to)</div></div>
        <div class="mt-6 space-y-6">
            <!-- Intro Block -->
            <div class="bg-rose-50 p-4 rounded-lg text-gray-700 border border-rose-100 shadow-sm italic">
                <p>Sơ đồ mô tả thứ tự tương tác giữa các thành phần hệ thống khi khách hàng yêu cầu chi tiền từ Virtual Account (VA). Đây là luồng nghiệp vụ quan trọng giúp VA không chỉ dùng để nhận tiền mà còn có khả năng thực hiện thanh toán, phù hợp với các mô hình quản lý dòng tiền doanh nghiệp như:</p>
                <ul class="list-disc ml-5 mt-2 text-sm space-y-1">
                    <li>POBO (Payment On Behalf Of)</li>
                    <li>Chi theo dự án</li>
                    <li>Chi ngân sách nội bộ tập đoàn</li>
                    <li>Chi điều chuyển giữa các đơn vị</li>
                </ul>
                <p class="mt-2 font-semibold text-rose-800 text-sm">
                    <span class="uppercase font-bold">Nguyên tắc cốt lõi:</span> VA kiểm soát số dư – Core Banking ghi sổ thật – VA cập nhật ledger ảo.
                </p>
            </div>

            <!-- Steps Container -->
            <div class="space-y-4">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-rose-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">1</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Kênh giao dịch gửi yêu cầu chuyển tiền từ VA</h4>
                        <p class="text-sm text-gray-600 mb-2">Kênh (IB/H2H/API doanh nghiệp) gửi request bao gồm:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>VA nguồn, Tài khoản thụ hưởng (DDA nội bộ/liên ngân hàng)</li>
                            <li>Số tiền, Mô tả giao dịch</li>
                            <li>Loại giao dịch (nội bộ/liên ngân hàng)</li>
                        </ul>
                        <p class="text-xs italic text-rose-600 mt-2">Request được đưa vào Routing Hub để điều phối.</p>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-rose-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">2</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gọi VA Engine để kiểm tra điều kiện outgoing</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub gọi <strong>VA Outgoing Service</strong> để:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Kiểm tra VA hoạt động & quyền chi tiền (allowed/blocked).</li>
                            <li>Xác minh VA thuộc DDA nào (Mapped DDA).</li>
                            <li>Lấy số dư VA tại thời điểm giao dịch & Kiểm tra hạn mức.</li>
                            <li>Đánh giá quy tắc nghiệp vụ.</li>
                        </ul>
                        <div class="mt-2 text-xs font-semibold text-red-600 bg-red-50 px-2 py-1 rounded border border-red-100">
                            Nếu VA không hợp lệ hoặc không đủ số dư → Routing Hub trả lỗi ngay.
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-rose-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">3</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">VA Engine ghi Shadow Debit để giữ chỗ số dư</h4>
                        <p class="text-sm text-gray-600 mb-2">VA thực hiện “tạm trích” bằng cách:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-gray-500 mb-2">
                            <div class="bg-gray-50 p-2 rounded border">Tạo Shadow Posting DEBIT (pending)</div>
                            <div class="bg-gray-50 p-2 rounded border">Giảm số dư VA & roll-up ngay lập tức</div>
                        </div>
                        <p class="text-xs italic text-gray-500">→ Giúp ngăn chặn tình trạng chi trùng (double spending) khi nhiều lệnh chi chạy đồng thời.</p>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-rose-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">4</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gửi yêu cầu Debit DDA sang Core Banking</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub gửi request đến <strong>Deposit Module</strong>:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Debit tài khoản DDA thực tương ứng với VA.</li>
                            <li>Thực hiện thanh toán nội bộ hoặc liên ngân hàng.</li>
                            <li>Kiểm tra hạn mức Core, AML/Fraud, trạng thái tài khoản.</li>
                        </ul>
                        <p class="text-xs font-semibold text-red-700 mt-2">Lưu ý: Nếu debit thất bại → VA Engine phải roll-back shadow posting.</p>
                    </div>
                </div>

                <!-- Step 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-rose-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">5</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Core Banking phát sự kiện Debit Notification</h4>
                        <p class="text-sm text-gray-600 mb-1">Nếu giao dịch thành công, Core phát sự kiện lên <strong>Deposit Event Bus</strong> chứa:</p>
                        <div class="mt-2 flex flex-wrap gap-2 text-xs font-mono text-gray-600">
                            <span class="bg-gray-100 px-2 py-1 rounded">DDA bị trích nợ</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Số tiền</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Mã giao dịch Core</span>
                            <span class="bg-gray-100 px-2 py-1 rounded">Trạng thái SUCCESS</span>
                        </div>
                    </div>
                </div>

                <!-- Step 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-rose-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">6</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gọi VA Engine để hoàn tất giao dịch</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub nhận event và gọi <strong>VA Engine – ConfirmOutgoing</strong>:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Chuyển shadow posting từ trạng thái <strong>pending → completed</strong>.</li>
                            <li>Ghi VA Ledger giao dịch chi.</li>
                            <li>Cập nhật số dư chính thức & roll-up.</li>
                        </ul>
                        <p class="text-xs italic text-gray-500 mt-2">Cơ chế idempotency đảm bảo không ghi trùng dù event đến muộn.</p>
                    </div>
                </div>

                <!-- Step 7 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">7</div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm flex-1">
                        <h4 class="font-bold text-green-900 mb-1">Giao dịch được hoàn tất toàn hệ thống</h4>
                        <ul class="text-sm text-green-800 list-disc ml-4 space-y-1">
                            <li>DDA đã trích nợ thật.</li>
                            <li>VA đã ghi shadow debit và cập nhật số dư.</li>
                            <li>Cấu trúc VA nhiều cấp đã được cập nhật ngay lập tức.</li>
                            <li>Khách hàng thấy số dư VA cập nhật theo đúng giao dịch.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Value Block -->
            <div class="bg-gradient-to-r from-pink-50 to-rose-50 border-l-4 border-rose-500 p-5 rounded-r-lg shadow-sm">
                <h4 class="font-bold text-rose-800 text-lg mb-3 flex items-center gap-2"><i data-lucide="layers" class="w-6 h-6"></i> Giá trị của luồng Outgoing từ VA</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-rose-600 mt-0.5"></i><span><strong>Đảm bảo VA luôn khớp với Core:</strong> Không xảy ra dư nợ ảo.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-rose-600 mt-0.5"></i><span><strong>Ngăn chặn double spending:</strong> Nhờ cơ chế shadow pending trước.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-rose-600 mt-0.5"></i><span><strong>Không can thiệp Core:</strong> Chỉ sử dụng hạch toán DDA như giao dịch thông thường.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-rose-600 mt-0.5"></i><span><strong>Hỗ trợ đầy đủ POBO:</strong> Tăng khả năng cung cấp dịch vụ Cash Management.</span></div>
                </div>
                <p class="mt-3 text-rose-900 font-semibold italic text-sm text-center border-t border-rose-200 pt-2">"Luồng tuần tự này là một thành phần cốt lõi của giải pháp Virtual Account mới của BIDV"</p>
            </div>
        </div>
        
        <!-- Sơ đồ 9 -->
        <div id="diagram-9" class="section-header">12. Sơ đồ số 9 – Sequence Interest Allocation (Phân bổ lãi)</div>
        <div class="image-container"><img class="zoomable-image" src="./Picture/09_Sequence_Interest_Allocation.png" alt="Sequence Interest Allocation"><div class="image-caption">Sơ đồ 9/12: Sequence Interest Allocation (Click để phóng to)</div></div>
        <div class="mt-6 space-y-6">
            <!-- Intro Block -->
            <div class="bg-orange-50 p-4 rounded-lg text-gray-700 border border-orange-100 shadow-sm italic">
                <p>Sơ đồ này thể hiện trình tự tương tác giữa Core Banking, Deposit Core Hub và Virtual Account Engine khi thực hiện phân bổ lãi từ tài khoản DDA thật sang các Virtual Account (VA) thuộc cấu trúc nhiều cấp. Đây là một trong những chức năng tạo giá trị gia tăng lớn nhất của dịch vụ VA, giúp BIDV cung cấp khả năng quản lý dòng tiền chuyên sâu cho doanh nghiệp.</p>
                <p class="mt-2 font-semibold text-orange-800 text-sm">
                    <span class="uppercase font-bold">Mục tiêu:</span> Core tính lãi thật → Deposit Core Hub tiếp nhận → VA phân bổ lãi theo rule → Shadow Posting lãi vào từng VA.
                </p>
            </div>

            <!-- Steps Container -->
            <div class="space-y-4">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">1</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Core Banking tính lãi và ghi nhận lãi thật vào DDA</h4>
                        <p class="text-sm text-gray-600 mb-2">Vào thời điểm cuối ngày/cuối tháng hoặc theo chu kỳ sản phẩm, Core:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Tính lãi theo quy tắc sản phẩm tiền gửi.</li>
                            <li>Hạch toán bút toán CREDIT lãi vào tài khoản DDA.</li>
                            <li>Cập nhật Core Ledger.</li>
                            <li>Phát sự kiện <strong>InterestCreditedEvent</strong> lên Deposit Event Bus.</li>
                        </ul>
                        <div class="mt-2 text-xs bg-orange-50 p-2 rounded border border-orange-100 text-orange-800">
                            Thông tin: DDA, số tiền lãi, kỳ tính, transaction ID, phương thức tính.
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">2</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Deposit Event Bus truyền sự kiện lãi đến Routing Hub</h4>
                        <p class="text-sm text-gray-600 mb-2">Event Bus hoạt động như kênh trung gian không đồng bộ:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Đẩy sự kiện lãi theo thời gian thực hoặc theo batch.</li>
                            <li>Đảm bảo không mất sự kiện (At-least-once).</li>
                            <li>Cho phép retry trong trường hợp VA Engine chưa sẵn sàng.</li>
                        </ul>
                        <p class="text-xs italic text-orange-600 mt-2">Routing Hub nhận sự kiện và khởi động quy trình phân bổ lãi.</p>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">3</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Routing Hub gọi Interest Allocation Engine</h4>
                        <p class="text-sm text-gray-600 mb-2">Routing Hub thực hiện xác định DDA liên quan và truy vấn VA đã đăng ký, sau đó gửi yêu cầu đến <strong>Interest Allocation Engine</strong>.</p>
                        <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded border">
                            <strong>Thông tin truyền đi:</strong> Số DDA, Số tiền lãi, Ngày giá trị (value date), Chu kỳ tính lãi.
                        </div>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">4</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Interest Allocation Engine xác định danh sách VA và lấy số dư</h4>
                        <p class="text-sm text-gray-600 mb-2">Engine thực hiện:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Lấy danh sách VA thuộc DDA và truy vấn số dư cuối kỳ/bình quân.</li>
                            <li>Xác định phương pháp phân bổ (Pro-rata, Fixed ratio, Weighted...).</li>
                            <li>Tính toán số tiền lãi cho từng VA & Tạo bảng phân bổ lãi.</li>
                        </ul>
                    </div>
                </div>

                <!-- Step 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">5</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">Engine gửi Shadow Posting lãi sang VA Engine</h4>
                        <p class="text-sm text-gray-600 mb-2">Sau khi tính toán, Engine gửi yêu cầu tạo bút toán ảo:</p>
                        <ul class="text-xs text-gray-500 list-disc ml-4 space-y-1">
                            <li>Tạo <strong>Shadow Posting CREDIT</strong> – Interest Allocation cho mỗi VA.</li>
                            <li>Ghi VA Ledger: VAId, amount, method, allocation ratio.</li>
                        </ul>
                        <p class="text-xs italic text-orange-600 mt-1">VA Engine xử lý idempotency để tránh ghi trùng.</p>
                    </div>
                </div>

                <!-- Step 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">6</div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1 hover:shadow-md transition">
                        <h4 class="font-bold text-gray-900 mb-1">VA Engine cập nhật số dư và roll-up balance</h4>
                        <p class="text-sm text-gray-600 mb-2">VA Engine thực hiện:</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-gray-500">
                            <div class="bg-gray-50 p-2 rounded border">Tăng số dư VA nhận lãi</div>
                            <div class="bg-gray-50 p-2 rounded border">Cập nhật roll-up balance VA cha</div>
                            <div class="bg-gray-50 p-2 rounded border">Ghi lịch sử phân bổ</div>
                            <div class="bg-gray-50 p-2 rounded border">Xác nhận hoàn tất</div>
                        </div>
                    </div>
                </div>

                <!-- Step 7 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold shadow-md">7</div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm flex-1">
                        <h4 class="font-bold text-green-900 mb-1">Routing Hub nhận xác nhận & hoàn tất luồng</h4>
                        <p class="text-sm text-green-800 mb-2">Xác nhận tất cả VA đã ghi shadow posting, không có lỗi phân bổ.</p>
                        <div class="text-xs text-green-700 bg-white p-2 rounded border border-green-100">
                            <strong>Kết quả Reporting:</strong> Sao kê lãi theo từng VA, Báo cáo phân bổ theo dự án, Bảng đối soát VA ↔ DDA.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Value Block -->
            <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border-l-4 border-amber-500 p-5 rounded-r-lg shadow-sm">
                <h4 class="font-bold text-amber-800 text-lg mb-3 flex items-center gap-2"><i data-lucide="trending-up" class="w-6 h-6"></i> Giá trị của luồng Interest Allocation</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-amber-600 mt-0.5"></i><span><strong>Minh bạch dòng tiền:</strong> Theo từng VA và từng cấp trong cấu trúc.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-amber-600 mt-0.5"></i><span><strong>Tối ưu Cash Management:</strong> Đặc biệt cho tập đoàn đa đơn vị.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-amber-600 mt-0.5"></i><span><strong>Không tác động Core Banking:</strong> Giảm rủi ro thay đổi hệ lõi.</span></div>
                    <div class="flex items-start gap-2"><i data-lucide="check" class="w-4 h-4 text-amber-600 mt-0.5"></i><span><strong>Dễ mở rộng:</strong> Hỗ trợ nhiều phương pháp phân bổ linh hoạt.</span></div>
                </div>
                <p class="mt-3 text-amber-900 font-semibold italic text-sm text-center border-t border-amber-200 pt-2">"Giúp BIDV cung cấp tính năng “sub-ledger interest management” — một điểm khác biệt so với hầu hết ngân hàng nội địa."</p>
            </div>
        </div>
    </div>

    <footer class="text-center mt-10 pt-4 border-t border-gray-200 text-gray-500 text-sm">
        Virtual Account System Architecture Document.
        <script>
            lucide.createIcons();
        </script>
    </footer>

</div>

<!-- The Modal -->
<div id="myModal" class="modal">
  <span class="close">&times;</span>
  <img class="modal-content" id="img01">
  <div id="caption"></div>
</div>

<script>
    // --- SCROLL TO TOP LOGIC ---
    let mybutton = document.getElementById("scrollUpBtn");

    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function() {scrollFunction()};

    function scrollFunction() {
      if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
        mybutton.style.display = "block";
      } else {
        mybutton.style.display = "none";
      }
    }

    // When the user clicks on the button, scroll to the top of the document
    function topFunction() {
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    }

    // --- ZOOM IMAGE LOGIC ---
    var modal = document.getElementById("myModal");
    var modalImg = document.getElementById("img01");
    var captionText = document.getElementById("caption");
    var span = document.getElementsByClassName("close")[0];

    // Delegate click event for images
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('zoomable-image')) {
            modal.style.display = "block";
            modalImg.src = e.target.src;
            captionText.innerHTML = e.target.alt;
        }
    });

    span.onclick = function() { 
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // --- PARENT COMMUNICATION LOGIC ---
    // Lắng nghe sự kiện từ iframe cha (nếu có) để chuyển ngôn ngữ mà không cần reload iframe src
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'SET_LANG') {
            if (event.data.lang === 'en') {
                window.location.replace('Architec_EN.html');
            }
        }
    });
</script>

</body>
</html>

