<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .header-bg {
            background-color: #1a202c;
            background-image: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(to right, #6366f1, #a855f7);
        }
        .filter-btn.active {
            background-color: #4f46e5;
            color: #fff;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .show { display: block !important; }
        .hide { display: none !important; }
        .scroll-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3rem;
            height: 3rem;
            background-color: #4f46e5;
            color: #fff;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 40;
        }
        .scroll-to-top:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-content {
            margin: auto;
            border-radius: 1rem;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hide">
        <div class="spinner"></div>
    </div>

    <!-- Main Content -->
    <div class="min-h-screen">
        <!-- Header -->
        <header class="header-bg text-white shadow-lg p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold" data-key="appTitle">Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM</h1>
                <nav>
                    <ul class="flex space-x-4">
                        <li><a href="#" class="hover:text-blue-300 transition-colors duration-200" data-key="home">Trang chủ</a></li>
                        <li><a href="#" class="hover:text-blue-300 transition-colors duration-200" data-key="reports">Báo cáo</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Main section -->
        <main class="container mx-auto px-4 py-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card p-6 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-500" data-key="totalBalance">Tổng số dư</h2>
                        <p id="total-balance" class="text-3xl font-bold text-gradient mt-2">Đang tải...</p>
                    </div>
                </div>
                <div class="card p-6 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-500" data-key="totalIncome">Tổng thu nhập</h2>
                        <p id="total-income" class="text-3xl font-bold text-green-500 mt-2">Đang tải...</p>
                    </div>
                </div>
                <div class="card p-6 flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-500" data-key="totalExpenses">Tổng chi phí</h2>
                        <p id="total-expenses" class="text-3xl font-bold text-red-500 mt-2">Đang tải...</p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4" data-key="incomeVsExpense">Thu nhập và Chi phí</h2>
                    <canvas id="incomeVsExpenseChart"></canvas>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4" data-key="expensesByCategory">Chi phí theo danh mục</h2>
                    <canvas id="expensesByCategoryChart"></canvas>
                </div>
            </div>

            <!-- Transaction Table -->
            <div class="card p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold mb-4 md:mb-0" data-key="transactionHistory">Lịch sử giao dịch</h2>
                    <div class="flex space-x-2">
                        <button id="export-excel-btn" class="bg-emerald-500 text-white font-medium py-2 px-4 rounded-full shadow-lg hover:bg-emerald-600 transition-colors duration-200">
                            <span data-key="exportExcel">Xuất Excel</span>
                        </button>
                        <button id="export-pdf-btn" class="bg-sky-500 text-white font-medium py-2 px-4 rounded-full shadow-lg hover:bg-sky-600 transition-colors duration-200">
                            <span data-key="exportPdf">Xuất PDF</span>
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button class="filter-btn active bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full transition-colors duration-200" data-filter="all" data-key="all">Tất cả</button>
                    <button class="filter-btn bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full transition-colors duration-200" data-filter="income" data-key="income">Thu nhập</button>
                    <button class="filter-btn bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-full transition-colors duration-200" data-filter="expense" data-key="expense">Chi phí</button>
                </div>
                
                <!-- Search and Date Filter -->
                <div class="flex flex-wrap gap-4 mb-4">
                    <input type="text" id="search-input" placeholder="Tìm kiếm giao dịch..." class="p-2 rounded-lg border border-gray-300 flex-grow" data-key-placeholder="searchPlaceholder">
                    <input type="date" id="start-date-filter" class="p-2 rounded-lg border border-gray-300">
                    <input type="date" id="end-date-filter" class="p-2 rounded-lg border border-gray-300">
                    <button id="clear-filters-btn" class="bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-full hover:bg-gray-400 transition-colors duration-200" data-key="clearFilters">Xóa bộ lọc</button>
                </div>

                <div class="overflow-x-auto rounded-lg shadow">
                    <table class="min-w-full bg-white dark:bg-gray-800">
                        <thead>
                            <tr class="w-full bg-gray-200 dark:bg-gray-700 text-left text-gray-600 dark:text-gray-300 uppercase text-sm leading-normal">
                                <th class="py-3 px-6" data-key="date">Ngày</th>
                                <th class="py-3 px-6" data-key="description">Mô tả</th>
                                <th class="py-3 px-6" data-key="type">Loại</th>
                                <th class="py-3 px-6 text-right" data-key="amount">Số tiền</th>
                                <th class="py-3 px-6" data-key="category">Danh mục</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body" class="text-gray-600 dark:text-gray-200 text-sm font-light">
                            <!-- Transactions will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
                <div id="no-transactions-message" class="hidden text-center py-8 text-gray-500 font-medium" data-key="noTransactions">
                    Không có giao dịch nào được tìm thấy.
                </div>
            </div>
        </main>

        <!-- Message Box -->
        <div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white font-semibold shadow-lg hidden z-50"></div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" class="scroll-to-top">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 p-8 w-11/12 md:w-1/2 lg:w-1/3">
            <span class="close" id="close-modal-btn">&times;</span>
            <h3 class="text-2xl font-bold mb-4" data-key="transactionDetails">Chi tiết giao dịch</h3>
            <div id="modal-content-body">
                <!-- Transaction details will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration - Replace with your actual project details
        const SUPABASE_URL = '';
        const SUPABASE_KEY = '';

        const supabase = SUPABASE_URL && SUPABASE_KEY ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;
        
        let allTransactions = [];
        let incomeVsExpenseChart = null;
        let expensesByCategoryChart = null;

        // Language translations
        const translations = {
            'vi': {
                appTitle: 'Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM',
                home: 'Trang chủ',
                reports: 'Báo cáo',
                totalBalance: 'Tổng số dư',
                totalIncome: 'Tổng thu nhập',
                totalExpenses: 'Tổng chi phí',
                incomeVsExpense: 'Thu nhập và Chi phí',
                expensesByCategory: 'Chi phí theo danh mục',
                transactionHistory: 'Lịch sử giao dịch',
                exportExcel: 'Xuất Excel',
                exportPdf: 'Xuất PDF',
                all: 'Tất cả',
                income: 'Thu nhập',
                expense: 'Chi phí',
                searchPlaceholder: 'Tìm kiếm giao dịch...',
                clearFilters: 'Xóa bộ lọc',
                date: 'Ngày',
                description: 'Mô tả',
                type: 'Loại',
                amount: 'Số tiền',
                category: 'Danh mục',
                noTransactions: 'Không có giao dịch nào được tìm thấy.',
                transactionDetails: 'Chi tiết giao dịch',
                processing: 'Đang xử lý...',
                success: 'Thành công!',
                error: 'Đã xảy ra lỗi.',
                modalDate: 'Ngày:',
                modalDescription: 'Mô tả:',
                modalType: 'Loại:',
                modalAmount: 'Số tiền:',
                modalCategory: 'Danh mục:',
                dataFetchError: 'Lỗi khi lấy dữ liệu: Vui lòng kiểm tra kết nối Supabase và cấu trúc bảng của bạn.',
                expenseTypeTableError: 'Lỗi: Không tìm thấy bảng "expensetype_quan". Vui lòng tạo bảng này trong Supabase để tính năng danh mục hoạt động.',
            },
            // Add other languages here if needed
        };

        let currentLanguage = 'vi'; // Default language

        // DOM elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const transactionTableBody = document.getElementById('transaction-table-body');
        const totalBalanceEl = document.getElementById('total-balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const searchInput = document.getElementById('search-input');
        const startDateFilter = document.getElementById('start-date-filter');
        const endDateFilter = document.getElementById('end-date-filter');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
        const messageBox = document.getElementById('message-box');
        const detailModal = document.getElementById('detail-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalContentBody = document.getElementById('modal-content-body');

        // Functions
        function showLoading() {
            loadingOverlay.classList.remove('hide');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hide');
        }

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white font-semibold shadow-lg show';
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            const elements = document.querySelectorAll('[data-key]');
            elements.forEach(el => {
                const key = el.dataset.key;
                if (translations[lang][key]) {
                    if (el.tagName === 'INPUT' && el.type === 'text') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });
        }
        
        // This function has been modified to handle the "relation does not exist" error
        async function fetchExpenseTypes() {
            if (!supabase) {
                console.error('Supabase client not initialized.');
                return [];
            }
            try {
                // The 'expensetype_quan' table is now expected to exist for this feature to work.
                // If it doesn't, we catch the error and return an empty array.
                const { data, error } = await supabase
                    .from('expensetype_quan')
                    .select('*');

                if (error) {
                    // Check for the specific error about the table not existing
                    if (error.message.includes('relation "public.expensetype_quan" does not exist')) {
                        console.error('Error fetching expense types:', error.message);
                        showMessage(translations[currentLanguage].expenseTypeTableError, 'error');
                        return [];
                    }
                    // Handle other errors
                    console.error('Error fetching expense types:', error);
                    return [];
                }
                return data;
            } catch (err) {
                console.error('Unexpected error fetching expense types:', err);
                return [];
            }
        }

        async function fetchTransactions() {
            if (!supabase) {
                showMessage(translations[currentLanguage].dataFetchError, 'error');
                return [];
            }
            showLoading();
            const { data, error } = await supabase
                .from('transactions')
                .select('*')
                .order('date', { ascending: false });

            if (error) {
                console.error('Error fetching transactions:', error);
                showMessage(translations[currentLanguage].dataFetchError, 'error');
                hideLoading();
                return [];
            }
            hideLoading();
            return data;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function calculateSummary(transactions) {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalBalance = totalIncome - totalExpenses;

            totalBalanceEl.textContent = formatCurrency(totalBalance);
            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpensesEl.textContent = formatCurrency(totalExpenses);
        }

        function renderTransactionRow(transaction) {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200 cursor-pointer';
            row.innerHTML = `
                <td class="py-3 px-6 whitespace-nowrap">${new Date(transaction.date).toLocaleDateString('vi-VN')}</td>
                <td class="py-3 px-6">${transaction.description}</td>
                <td class="py-3 px-6">
                    <span class="py-1 px-3 rounded-full text-xs font-semibold ${transaction.type === 'income' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                        ${transaction.type === 'income' ? 'Thu' : 'Chi'}
                    </span>
                </td>
                <td class="py-3 px-6 text-right font-medium ${transaction.type === 'income' ? 'text-green-500' : 'text-red-500'}">
                    ${formatCurrency(transaction.amount)}
                </td>
                <td class="py-3 px-6">${transaction.category || 'N/A'}</td>
            `;
            row.addEventListener('click', () => openDetailModal(transaction));
            return row;
        }

        function renderTransactions(transactions) {
            transactionTableBody.innerHTML = '';
            if (transactions.length === 0) {
                noTransactionsMessage.classList.remove('hidden');
            } else {
                noTransactionsMessage.classList.add('hidden');
                transactions.forEach(t => transactionTableBody.appendChild(renderTransactionRow(t)));
            }
        }

        function renderCharts(transactions) {
            // Check for existing charts and destroy them before re-rendering
            if (incomeVsExpenseChart) {
                incomeVsExpenseChart.destroy();
            }
            if (expensesByCategoryChart) {
                expensesByCategoryChart.destroy();
            }

            const incomeData = transactions.filter(t => t.type === 'income').reduce((acc, t) => {
                const month = new Date(t.date).getMonth();
                acc[month] = (acc[month] || 0) + t.amount;
                return acc;
            }, {});

            const expenseData = transactions.filter(t => t.type === 'expense').reduce((acc, t) => {
                const month = new Date(t.date).getMonth();
                acc[month] = (acc[month] || 0) + t.amount;
                return acc;
            }, {});

            const months = Array.from({ length: 12 }, (_, i) => i);
            const incomeValues = months.map(m => incomeData[m] || 0);
            const expenseValues = months.map(m => expenseData[m] || 0);

            const monthsLabel = Array.from({ length: 12 }, (_, i) => `Tháng ${i + 1}`);

            const incomeVsExpenseCtx = document.getElementById('incomeVsExpenseChart').getContext('2d');
            incomeVsExpenseChart = new Chart(incomeVsExpenseCtx, {
                type: 'bar',
                data: {
                    labels: monthsLabel,
                    datasets: [
                        {
                            label: 'Thu nhập',
                            data: incomeValues,
                            backgroundColor: '#10B981',
                            borderRadius: 10,
                        },
                        {
                            label: 'Chi phí',
                            data: expenseValues,
                            backgroundColor: '#EF4444',
                            borderRadius: 10,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: document.body.classList.contains('dark') ? '#d1d5db' : '#374151',
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' },
                            grid: { color: document.body.classList.contains('dark') ? '#374151' : '#e5e7eb' }
                        },
                        y: {
                            ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' },
                            grid: { color: document.body.classList.contains('dark') ? '#374151' : '#e5e7eb' },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Expense by category chart
            const expensesByCategory = transactions.filter(t => t.type === 'expense').reduce((acc, t) => {
                const category = t.category || 'Không xác định';
                acc[category] = (acc[category] || 0) + t.amount;
                return acc;
            }, {});

            const categoryLabels = Object.keys(expensesByCategory);
            const categoryData = Object.values(expensesByCategory);

            const expensesByCategoryCtx = document.getElementById('expensesByCategoryChart').getContext('2d');
            expensesByCategoryChart = new Chart(expensesByCategoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: [
                            '#4f46e5', '#a855f7', '#ec4899', '#f97316', '#eab308',
                            '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: document.body.classList.contains('dark') ? '#d1d5db' : '#374151',
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    return `${label}: ${formatCurrency(value)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function filterAndRender() {
            let filteredTransactions = [...allTransactions];
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            const searchText = searchInput.value.toLowerCase();
            const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;

            if (activeFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.type === activeFilter);
            }

            if (searchText) {
                filteredTransactions = filteredTransactions.filter(t =>
                    t.description.toLowerCase().includes(searchText) ||
                    (t.category && t.category.toLowerCase().includes(searchText))
                );
            }

            if (startDate) {
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= startDate);
            }

            if (endDate) {
                filteredTransactions = filteredTransactions.filter(t => new Date(t.date) <= endDate);
            }

            renderTransactions(filteredTransactions);
            calculateSummary(filteredTransactions);
            renderCharts(filteredTransactions);
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(allTransactions);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transactions");
            XLSX.writeFile(wb, "transactions.xlsx");
            showMessage(translations[currentLanguage].success, 'success');
        }
        
        function openDetailModal(transaction) {
            const transactionType = transaction.type === 'income' ? translations[currentLanguage].income : translations[currentLanguage].expense;
            modalContentBody.innerHTML = `
                <div class="mb-2"><span class="font-bold text-gray-500">${translations[currentLanguage].modalDate}</span> ${new Date(transaction.date).toLocaleDateString('vi-VN')}</div>
                <div class="mb-2"><span class="font-bold text-gray-500">${translations[currentLanguage].modalDescription}</span> ${transaction.description}</div>
                <div class="mb-2"><span class="font-bold text-gray-500">${translations[currentLanguage].modalType}</span> ${transactionType}</div>
                <div class="mb-2"><span class="font-bold text-gray-500">${translations[currentLanguage].modalAmount}</span> ${formatCurrency(transaction.amount)}</div>
                <div class="mb-2"><span class="font-bold text-gray-500">${translations[currentLanguage].modalCategory}</span> ${transaction.category || 'N/A'}</div>
            `;
            detailModal.classList.add('show');
        }

        function closeDetailModal() {
            detailModal.classList.remove('show');
        }

        // Event Listeners
        window.addEventListener('DOMContentLoaded', async () => {
            setLanguage(currentLanguage);
            allTransactions = await fetchTransactions();
            filterAndRender();

            // Fetch expense types, now with robust error handling
            await fetchExpenseTypes();
        });

        filterButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                filterButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
                e.target.classList.add('active', 'bg-blue-600', 'text-white');
                filterAndRender();
            });
        });
        
        searchInput.addEventListener('input', filterAndRender);
        startDateFilter.addEventListener('change', filterAndRender);
        endDateFilter.addEventListener('change', filterAndRender);
        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            startDateFilter.value = '';
            endDateFilter.value = '';
            filterButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
            document.querySelector('.filter-btn[data-filter="all"]').classList.add('active', 'bg-blue-600', 'text-white');
            filterAndRender();
        });

        exportExcelBtn.addEventListener('click', exportToExcel);
        
        exportPdfBtn.addEventListener('click', () => {
            showMessage(translations[currentLanguage].processing);
            setTimeout(() => {
                showMessage('Chức năng xuất PDF đang được phát triển.', 'info');
            }, 1000);
        });

        closeModalBtn.addEventListener('click', closeDetailModal);
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                closeDetailModal();
            }
        });

        // Scroll to Top Button Logic
        window.onscroll = function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        };

        scrollToTopBtn.onclick = function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
    </script>
</body>
</html>
