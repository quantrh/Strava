<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary {
            background-color: #006B68;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #005654; }
        .btn-secondary {
            background-color: #F3F4F6;
            color: #1F2937;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover { background-color: #E5E7EB; }
        .table-header { background-color: #F9FAFB; }
        .table-cell { padding: 1rem; border-bottom: 1px solid #E5E7EB; }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .scroll-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3rem;
            height: 3rem;
            background-color: #006B68;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(20px);
            z-index: 1000;
        }
        .scroll-to-top.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative;
            z-index: 50;
        }
        .language-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #E0E7FF;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .language-switch button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #006B68;
        }
        .language-switch button.active {
            background-color: #006B68;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #006B68;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom multi-select dropdown */
        .multi-select-container {
            position: relative;
        }
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        .multi-select-dropdown label {
            display: block;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .multi-select-dropdown label:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="navbar flex items-center">
        <!-- Logo and Title -->
        <div class="flex items-center ml-4 flex-grow">
            <img src="LogoQuy.png" alt="Logo Quản Lý Quỹ Nhóm" class="h-12 w-auto rounded-lg shadow-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/006B68/FFFFFF?text=Logo';">
            <h1 class="text-2xl font-bold text-[#006B68]" data-key="appName">QUẢN LÝ QUỸ NHÓM</h1>
        </div>
        <!-- Desktop Nav and Language Switcher -->
        <div class="hidden md:flex items-center gap-4">
            <a href="QuycomQuan.html" class="text-gray-700 hover:text-gray-900 font-semibold" data-key="navDashboard">Trang chủ</a>
            <a href="QuycomReportQuan.html" class="text-gray-700 hover:text-gray-900 font-semibold" data-key="navReport">Báo cáo</a>
            <div class="language-switch">
                <button id="lang-vi-btn" data-lang="vi" class="active">VI</button>
                <button id="lang-en-btn" data-lang="en">EN</button>
            </div>
        </div>
    </div>
    <main class="container mx-auto p-4 mt-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-6" data-key="reportTitle">Lịch Sử Giao Dịch</h2>
        <!-- Filters and Actions Section -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- Start Date Filter -->
                <div>
                    <label for="start-date-filter" class="block text-sm font-medium text-gray-700" data-key="filterStartDate">Từ ngày</label>
                    <input type="date" id="start-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <!-- End Date Filter -->
                <div>
                    <label for="end-date-filter" class="block text-sm font-medium text-gray-700" data-key="filterEndDate">Đến ngày</label>
                    <input type="date" id="end-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <!-- Member Filter -->
                <div>
                    <label for="member-filter" class="block text-sm font-medium text-gray-700" data-key="filterMember">Người giao dịch</label>
                    <select id="member-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="all" data-key="allMembers">Tất cả</option>
                    </select>
                </div>
                <!-- Expense Type Filter -->
                <div class="relative">
                    <label for="expense-type-filter-btn" class="block text-sm font-medium text-gray-700" data-key="filterType">Loại giao dịch</label>
                    <div class="multi-select-container">
                        <button id="expense-type-filter-btn" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-white p-2 text-left">
                            <span id="expense-type-filter-text" data-key="allTypes">Tất cả</span>
                        </button>
                        <div id="expense-type-filter-dropdown" class="multi-select-dropdown hidden">
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mt-4">
                <button id="apply-filter-btn" class="btn-primary flex-1" data-key="filterApply">Áp dụng</button>
                <button id="clear-filter-btn" class="btn-secondary flex-1" data-key="filterClear">Xóa bộ lọc</button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="export-excel-btn" class="btn-primary flex items-center gap-2" data-key="exportExcel">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v6h6a1 1 0 110 2h-6v6a1 1 0 11-2 0v-6H3a1 1 0 110-2h6V3a1 1 0 011-1z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    Xuất Excel
                </button>
            </div>
        </div>

        <!-- Transaction Table Section -->
        <div id="transaction-section" class="bg-white rounded-xl shadow overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900" data-key="transactionHistory">Lịch Sử Giao Dịch</h3>
                <span id="transaction-count" class="text-gray-500 text-sm font-medium"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDate">Ngày</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDescription">Mô tả</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableMember">Người giao dịch</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableType">Loại</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableAmount">Số tiền</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Transaction rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls -->
            <div class="px-6 py-4 flex items-center justify-between border-t border-gray-200">
                <button id="prev-page-btn" class="btn-secondary" data-key="paginationPrevious">Trước</button>
                <span id="page-info" class="text-sm text-gray-700"></span>
                <button id="next-page-btn" class="btn-secondary" data-key="paginationNext">Sau</button>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="grid grid-cols-1 gap-8 mt-8">
            <!-- Doughnut Chart Section -->
            <div id="chart-section" class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900" data-key="spendingChartTitle">Biểu đồ cơ cấu chi tiêu</h3>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div id="expense-legend-container" class="overflow-y-auto max-h-96">
                        <!-- Legend table will be inserted here -->
                    </div>
                    <div class="h-96">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>
             <!-- Monthly Stacked Area Chart Section -->
            <div id="monthly-chart-section" class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900" data-key="monthlySpendingChartTitle">Biểu đồ chi tiêu theo tháng</h3>
                </div>
                <div class="p-6 h-96">
                    <canvas id="monthlyExpenseChart"></canvas>
                </div>
            </div>
        </div>

    </main>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" class="scroll-to-top">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </button>
    
    <!-- Chart Detail Modal -->
    <div id="chart-detail-modal-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center pb-3">
                     <h3 class="text-lg leading-6 font-medium text-gray-900" id="chart-detail-modal-title">Chi tiết chi tiêu</h3>
                     <button id="close-chart-detail-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                <div class="overflow-y-auto" style="max-height: 60vh;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDate">Ngày</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDescription">Mô tả</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableMember">Người giao dịch</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableAmount">Số tiền</th>
                            </tr>
                        </thead>
                        <tbody id="chart-detail-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Details will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <script>
        // DOM elements initialization
        const elements = {
            transactionTableBody: document.getElementById('transaction-table-body'),
            applyFilterBtn: document.getElementById('apply-filter-btn'),
            clearFilterBtn: document.getElementById('clear-filter-btn'),
            startDateFilter: document.getElementById('start-date-filter'),
            endDateFilter: document.getElementById('end-date-filter'),
            memberFilter: document.getElementById('member-filter'),
            expenseTypeFilterBtn: document.getElementById('expense-type-filter-btn'),
            expenseTypeFilterText: document.getElementById('expense-type-filter-text'),
            expenseTypeFilterDropdown: document.getElementById('expense-type-filter-dropdown'),
            transactionCountSpan: document.getElementById('transaction-count'),
            prevPageBtn: document.getElementById('prev-page-btn'),
            nextPageBtn: document.getElementById('next-page-btn'),
            pageInfoSpan: document.getElementById('page-info'),
            exportExcelBtn: document.getElementById('export-excel-btn'),
            scrollToTopBtn: document.getElementById('scroll-to-top-btn'),
            loadingOverlay: document.getElementById('loading-overlay'),
            // Chart elements
            expenseChartCanvas: document.getElementById('expenseChart'),
            expenseLegendContainer: document.getElementById('expense-legend-container'),
            monthlyExpenseChartCanvas: document.getElementById('monthlyExpenseChart'),
            chartDetailModalOverlay: document.getElementById('chart-detail-modal-overlay'),
            chartDetailModalTitle: document.getElementById('chart-detail-modal-title'),
            chartDetailTableBody: document.getElementById('chart-detail-table-body'),
            closeChartDetailModalBtn: document.getElementById('close-chart-detail-modal-btn'),
        };

        // --- Supabase Client Initialization ---
        const supabaseUrl = 'https://rmbsxccrwrktbjlnezpu.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        let members = [];
        let transactions = [];
        let expenseTypes = [];
        let currentPage = 1;
        const transactionsPerPage = 10;
        let filteredTransactions = [];
        let expenseChartInstance = null;
        let monthlyChartInstance = null;
        let expenseTypeColors = {};

        const localization = {
            vi: {
                appTitle: "Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM",
                appName: "QUẢN LÝ QUỸ NHÓM",
                navDashboard: "Trang chủ",
                navReport: "Báo cáo",
                reportTitle: "Lịch Sử Giao Dịch",
                filterStartDate: "Từ ngày",
                filterEndDate: "Đến ngày",
                filterMember: "Người giao dịch",
                filterType: "Loại giao dịch",
                allMembers: "Tất cả",
                allTypes: "Tất cả",
                filterApply: "Áp dụng",
                filterClear: "Xóa bộ lọc",
                exportExcel: "Xuất Excel",
                transactionHistory: "Lịch Sử Giao Dịch",
                tableDate: "Ngày",
                tableDescription: "Mô tả",
                tableMember: "Người giao dịch",
                tableType: "Loại",
                tableAmount: "Số tiền",
                noTransactions: "Không có giao dịch nào",
                paginationPrevious: "Trước",
                paginationNext: "Sau",
                page: "Trang",
                of: "của",
                unassigned: "Không xác định",
                unknownMember: "Thành viên không xác định",
                unknownType: "Loại không xác định",
                spendingChartTitle: "Biểu đồ cơ cấu chi tiêu",
                monthlySpendingChartTitle: "Biểu đồ chi tiêu theo tháng",
                spendingByType: "Chi tiêu theo loại",
                chartDetailTitle: "Chi tiết cho",
                totalSpending: "Tổng chi tiêu",
                legendType: "Loại chi tiêu",
                legendAmount: "Số tiền",
                legendRatio: "Tỷ lệ",
                selected: "đã chọn"
            },
            en: {
                appTitle: "Transaction History - GROUP FUND MANAGER",
                appName: "GROUP FUND MANAGER",
                navDashboard: "Dashboard",
                navReport: "Report",
                reportTitle: "Transaction History",
                filterStartDate: "Start Date",
                filterEndDate: "End Date",
                filterMember: "Member",
                filterType: "Type",
                allMembers: "All Members",
                allTypes: "All Types",
                filterApply: "Apply",
                filterClear: "Clear",
                exportExcel: "Export Excel",
                transactionHistory: "Transaction History",
                tableDate: "Date",
                tableDescription: "Description",
                tableMember: "Member",
                tableType: "Type",
                tableAmount: "Amount",
                noTransactions: "No transactions found",
                paginationPrevious: "Previous",
                paginationNext: "Next",
                page: "Page",
                of: "of",
                unassigned: "Unassigned",
                unknownMember: "Unknown Member",
                unknownType: "Unknown Type",
                spendingChartTitle: "Spending Structure Chart",
                monthlySpendingChartTitle: "Monthly Spending Chart",
                spendingByType: "Spending by Type",
                chartDetailTitle: "Details for",
                totalSpending: "Total Spending",
                legendType: "Expense Type",
                legendAmount: "Amount",
                legendRatio: "Ratio",
                selected: "selected"
            }
        };
        let currentLanguage = 'vi';
        let translations = localization[currentLanguage];

        function updateContent() {
            translations = localization[currentLanguage];
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[key]) {
                    if (element.id !== 'expense-type-filter-text' || getSelectedExpenseTypes().length === 0) {
                       element.textContent = translations[key];
                    }
                }
            });
            renderTransactions(filteredTransactions);
            renderAllCharts(filteredTransactions);
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('lang-vi-btn').classList.toggle('active', lang === 'vi');
            document.getElementById('lang-en-btn').classList.toggle('active', lang === 'en');
            updateContent();
        }

        document.getElementById('lang-vi-btn').addEventListener('click', () => setLanguage('vi'));
        document.getElementById('lang-en-btn').addEventListener('click', () => setLanguage('en'));

        async function fetchSupabaseData() {
            elements.loadingOverlay.classList.remove('hidden');
            try {
                const { data: membersData, error: membersError } = await supabaseClient.from('members_quan').select('*');
                if (membersError) throw membersError;
                members = membersData;

                const { data: expenseTypesData, error: expenseTypesError } = await supabaseClient.from('expensetype_quan').select('*');
                if (expenseTypesError) throw expenseTypesError;
                expenseTypes = expenseTypesData;
                
                expenseTypes.forEach((type, index) => {
                    expenseTypeColors[type.expense_type] = `hsl(${(index * 60) % 360}, 70%, 60%)`;
                });

                const { data: transactionsData, error: transactionsError } = await supabaseClient.from('transactions_quan').select('*');
                if (transactionsError) throw transactionsError;
                transactions = transactionsData;

                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                initializePageWithData();

            } catch (error) {
                console.error('Error fetching data from Supabase:', error.message);
            } finally {
                elements.loadingOverlay.classList.add('hidden');
            }
        }

        function getMemberNames(memberIds, contributingMemberId) {
            let ids = [];
            if (memberIds) ids = [...memberIds];
            if (contributingMemberId && !ids.includes(contributingMemberId)) ids.push(contributingMemberId);

            if (ids.length === 0) return translations.unassigned || 'Không xác định';
            return ids.map(id => {
                const member = members.find(m => m.id === id);
                return member ? member.name : (translations.unknownMember || 'Thành viên không xác định');
            }).join(', ');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function renderTransactions(data) {
            elements.transactionTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            if (paginatedData.length === 0) {
                elements.transactionTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">${translations.noTransactions}</td></tr>`;
            } else {
                paginatedData.forEach(transaction => {
                    const memberName = getMemberNames(transaction.involvedMemberIds, transaction.contributingMemberId);
                    const expenseTypeName = transaction.expense_type;
                    const formattedDate = new Date(transaction.date).toLocaleDateString('vi-VN');
                    const formattedAmount = formatCurrency(transaction.amount);

                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="table-cell">${formattedDate}</td>
                            <td class="table-cell truncate max-w-xs">${transaction.description}</td>
                            <td class="table-cell">${memberName}</td>
                            <td class="table-cell">${expenseTypeName}</td>
                            <td class="table-cell font-medium text-right">${formattedAmount}</td>
                        </tr>
                    `;
                    elements.transactionTableBody.innerHTML += row;
                });
            }

            elements.transactionCountSpan.textContent = `(${data.length} ${translations.transactionHistory.toLowerCase()})`;
            updatePaginationControls(data.length);
        }
        
        function renderAllCharts(data) {
            renderDoughnutChart(data);
            renderMonthlyStackedAreaChart(data);
        }

        function renderDoughnutChart(data) {
            if (expenseChartInstance) {
                expenseChartInstance.destroy();
            }

            const spendingByType = data.reduce((acc, transaction) => {
                const type = transaction.expense_type || (translations.unassigned || 'Không xác định');
                const amount = transaction.amount;
                if (!acc[type]) {
                    acc[type] = { total: 0, transactions: [] };
                }
                acc[type].total += amount;
                acc[type].transactions.push(transaction);
                return acc;
            }, {});

            const sortedData = Object.entries(spendingByType)
                .sort(([, a], [, b]) => b.total - a.total);

            const totalSpending = sortedData.reduce((sum, [, item]) => sum + item.total, 0);

            // Render legend table
            let legendHtml = `
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-2 py-2">${translations.legendType}</th>
                            <th scope="col" class="px-2 py-2 text-right">${translations.legendAmount}</th>
                            <th scope="col" class="px-2 py-2 text-right">${translations.legendRatio}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedData.forEach(([label, item]) => {
                const percentage = totalSpending > 0 ? ((item.total / totalSpending) * 100).toFixed(2) : 0;
                const color = expenseTypeColors[label] || '#cccccc';
                legendHtml += `
                    <tr class="bg-white border-b">
                        <td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">
                            <span class="inline-block w-3 h-3 mr-2 rounded-full" style="background-color: ${color};"></span>
                            ${label}
                        </td>
                        <td class="px-2 py-2 text-right">${formatCurrency(item.total)}</td>
                        <td class="px-2 py-2 text-right">${percentage}%</td>
                    </tr>
                `;
            });

            legendHtml += `
                    </tbody>
                    <tfoot class="font-semibold text-gray-900">
                        <tr>
                            <td class="px-2 py-2">${translations.totalSpending}</td>
                            <td class="px-2 py-2 text-right" colspan="2">${formatCurrency(totalSpending)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            elements.expenseLegendContainer.innerHTML = legendHtml;


            // Render chart
            const chartLabels = sortedData.map(([label]) => label);
            const chartData = sortedData.map(([, item]) => item.total);
            const chartColors = chartLabels.map(label => expenseTypeColors[label] || '#cccccc');

            const ctx = elements.expenseChartCanvas.getContext('2d');
            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderColor: '#fff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, chartElements) => {
                        if (chartElements.length > 0) {
                            const chartElement = chartElements[0];
                            const label = chartLabels[chartElement.index];
                            const transactionsForType = spendingByType[label].transactions;
                            openChartDetailModal(label, transactionsForType);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) {
                                        const value = context.parsed;
                                        const percentage = totalSpending > 0 ? ((value / totalSpending) * 100).toFixed(2) : 0;
                                        label += `${formatCurrency(value)} (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderMonthlyStackedAreaChart(data) {
            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }

            const monthlyData = data.reduce((acc, t) => {
                const month = t.date.substring(0, 7); // YYYY-MM
                if (!acc[month]) acc[month] = { total: 0 };
                
                const type = t.expense_type || (translations.unassigned || 'Không xác định');
                if (!acc[month][type]) acc[month][type] = 0;
                
                acc[month][type] += t.amount;
                acc[month].total += t.amount;
                return acc;
            }, {});
            
            const months = Object.keys(monthlyData).sort();
            const types = [...new Set(data.map(t => t.expense_type || (translations.unassigned || 'Không xác định')))];

            const datasets = types.map(type => {
                const dataForType = months.map(month => {
                    const monthData = monthlyData[month];
                    const typeTotal = monthData[type] || 0;
                    return monthData.total > 0 ? (typeTotal / monthData.total) * 100 : 0;
                });
                return {
                    label: type,
                    data: dataForType,
                    backgroundColor: expenseTypeColors[type] || '#cccccc',
                    borderColor: expenseTypeColors[type] || '#cccccc',
                    fill: true,
                };
            });

            const ctx = elements.monthlyExpenseChartCanvas.getContext('2d');
            monthlyChartInstance = new Chart(ctx, {
                type: 'line', // Changed from 'bar' to 'line'
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: translations.monthlySpendingChartTitle,
                            font: { size: 18, family: "'Inter', sans-serif" }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + '%';
                                    }
                                    return label;
                                }
                            }
                        },
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    elements: {
                        line: {
                            tension: 0.4 // Makes the lines smooth
                        }
                    }
                }
            });
        }

        function openChartDetailModal(type, transactionsForType) {
            elements.chartDetailModalTitle.textContent = `${translations.chartDetailTitle} "${type}"`;
            elements.chartDetailTableBody.innerHTML = '';

            transactionsForType.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (transactionsForType.length === 0) {
                 elements.chartDetailTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">${translations.noTransactions}</td></tr>`;
            } else {
                transactionsForType.forEach(t => {
                    const row = `
                        <tr>
                            <td class="table-cell">${new Date(t.date).toLocaleDateString('vi-VN')}</td>
                            <td class="table-cell">${t.description}</td>
                            <td class="table-cell">${getMemberNames(t.involvedMemberIds, t.contributingMemberId)}</td>
                            <td class="table-cell text-right">${formatCurrency(t.amount)}</td>
                        </tr>
                    `;
                    elements.chartDetailTableBody.innerHTML += row;
                });
            }
            elements.chartDetailModalOverlay.classList.remove('hidden');
        }


        function updatePaginationControls(totalTransactions) {
            const totalPages = Math.ceil(totalTransactions / transactionsPerPage);
            elements.pageInfoSpan.textContent = `${translations.page} ${currentPage} ${translations.of} ${totalPages}`;
            elements.prevPageBtn.disabled = currentPage === 1;
            elements.nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            elements.prevPageBtn.classList.toggle('opacity-50', currentPage === 1);
            elements.nextPageBtn.classList.toggle('opacity-50', currentPage === totalPages || totalPages === 0);
        }

        function getSelectedExpenseTypes() {
            const selectedTypes = [];
            elements.expenseTypeFilterDropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                selectedTypes.push(checkbox.value);
            });
            return selectedTypes;
        }

        function applyFilters() {
            const startDate = elements.startDateFilter.value ? new Date(elements.startDateFilter.value) : null;
            let endDate = null;
            if (elements.endDateFilter.value) {
                endDate = new Date(elements.endDateFilter.value);
                endDate.setDate(endDate.getDate() + 1);
            }
            const memberId = elements.memberFilter.value;
            const selectedExpenseTypeIds = getSelectedExpenseTypes();

            const selectedExpenseTypeNames = selectedExpenseTypeIds.map(id => {
                const type = expenseTypes.find(t => String(t.id) === id);
                return type ? type.expense_type : null;
            }).filter(name => name !== null);

            filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const memberMatch = memberId === 'all' || (t.involvedMemberIds && t.involvedMemberIds.includes(memberId)) || (t.contributingMemberId && t.contributingMemberId === memberId);
                const typeMatch = selectedExpenseTypeNames.length === 0 || selectedExpenseTypeNames.includes(t.expense_type);
                const dateMatch = (!startDate || transactionDate >= startDate) && (!endDate || transactionDate < endDate);
                return memberMatch && typeMatch && dateMatch;
            });

            currentPage = 1;
            renderTransactions(filteredTransactions);
            renderAllCharts(filteredTransactions);
        }

        function exportToExcel() {
            const dataToExport = filteredTransactions.map(t => ({
                'Ngày': new Date(t.date).toLocaleDateString('vi-VN'),
                'Mô tả': t.description,
                'Người giao dịch': getMemberNames(t.involvedMemberIds, t.contributingMemberId),
                'Loại': t.expense_type,
                'Số tiền (VND)': t.amount
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Lịch Sử Giao Dịch');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            saveAs(new Blob([wbout], { type: 'application/octet-stream' }), 'lich_su_giao_dich.xlsx');
        }

        // --- Event Listeners ---
        elements.applyFilterBtn.addEventListener('click', applyFilters);
        elements.clearFilterBtn.addEventListener('click', () => {
            elements.startDateFilter.value = '';
            elements.endDateFilter.value = '';
            elements.memberFilter.value = 'all';
            elements.expenseTypeFilterDropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateExpenseTypeFilterText();
            
            filteredTransactions = transactions;
            currentPage = 1;
            renderTransactions(filteredTransactions);
            renderAllCharts(filteredTransactions);
        });

        elements.prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTransactions(filteredTransactions);
            }
        });

        elements.nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTransactions(filteredTransactions);
            }
        });

        elements.exportExcelBtn.addEventListener('click', exportToExcel);
        elements.closeChartDetailModalBtn.addEventListener('click', () => elements.chartDetailModalOverlay.classList.add('hidden'));

        // Multi-select dropdown logic
        elements.expenseTypeFilterBtn.addEventListener('click', () => {
            elements.expenseTypeFilterDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!elements.expenseTypeFilterBtn.contains(e.target) && !elements.expenseTypeFilterDropdown.contains(e.target)) {
                elements.expenseTypeFilterDropdown.classList.add('hidden');
            }
        });
        
        function updateExpenseTypeFilterText() {
            const selectedCount = getSelectedExpenseTypes().length;
            if (selectedCount === 0) {
                elements.expenseTypeFilterText.textContent = translations.allTypes;
            } else {
                elements.expenseTypeFilterText.textContent = `${selectedCount} ${translations.selected}`;
            }
        }

        function initializePageWithData() {
            elements.memberFilter.innerHTML = `<option value="all" data-key="allMembers">${localization[currentLanguage].allMembers}</option>`;
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                elements.memberFilter.appendChild(option);
            });

            elements.expenseTypeFilterDropdown.innerHTML = '';
            expenseTypes.forEach(type => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = type.id;
                checkbox.className = 'rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-offset-0 focus:ring-indigo-200 focus:ring-opacity-50';
                
                checkbox.addEventListener('change', updateExpenseTypeFilterText);

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(type.expense_type));
                elements.expenseTypeFilterDropdown.appendChild(label);
            });

            setLanguage(currentLanguage);

            filteredTransactions = transactions;
            renderTransactions(filteredTransactions);
            renderAllCharts(filteredTransactions);
        }

        document.addEventListener('DOMContentLoaded', fetchSupabaseData);
    </script>
</body>
</html>
