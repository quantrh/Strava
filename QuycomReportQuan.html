<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #006B68; /* BIDV Brand Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #005A58; /* Darker BIDV Blue */ }
        .btn-secondary {
            background-color: #E0E7FF; /* Light background */
            color: #006B68; /* BIDV Brand Blue for text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover { background-color: #CCF0EF; /* Lighter BIDV Blue for hover */ }
        .input-field {
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .table-header th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #4B5563;
            border-bottom: 1px solid #E5E7EB;
        }
        .table-row td {
            padding: 0.75rem;
            border-bottom: 1px solid #F3F4F6;
        }
        .balance-positive { color: #10B981; font-weight: 600; } /* Green */
        .balance-negative { color: #EF4444; font-weight: 600; } /* Red */
        .balance-zero { color: #6B7280; } /* Gray */
        .error-message {
            background-color: #FEE2E2;
            color: #DC2626;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .text-right-aligned {
            text-align: right; /* Custom class for right alignment */
        }
        /* Styles for the scroll-to-top button */
        #scroll-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #006B68;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Initially hidden */
            transform: scale(0.8); /* Slightly smaller when hidden */
            z-index: 999; /* Ensure it's above other content */
        }
        #scroll-to-top-btn.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Styles for Word export - ensure table borders are visible */
        /* These styles will be embedded directly into the HTML for Word export */
        .word-export-table {
            border-collapse: collapse;
            width: 100%;
        }
        .word-export-table th,
        .word-export-table td {
            border: 1px solid #e5e7eb; /* Add borders for Word */
            padding: 0.75rem;
            text-align: left;
        }
        .word-export-table th {
            background-color: #f3f4f6; /* Light background for headers */
            font-weight: 600;
        }
        .word-export-table .balance-positive { color: #10B981; }
        .word-export-table .balance-negative { color: #EF4444; }
        .word-export-table .balance-zero { color: #6B7280; }
        .word-export-table .text-right-aligned { text-align: right; }

        /* Camera Modal Specific Styles */
        #camera-modal .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            max-width: 95%;
            width: 600px; /* Max width for camera feed */
        }
        #uploaded-image-preview { /* Renamed from captured-image */
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        #camera-loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #006B68;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Language Switch Styles */
        .language-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #E0E7FF;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .language-switch button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #006B68;
        }
        .language-switch button.active {
            background-color: #006B68;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Hamburger Menu Specific Styles */
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative; /* Changed to relative to contain absolute menu */
            z-index: 50;
        }
        #hamburger-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        #hamburger-btn:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu {
            position: absolute; /* Changed to absolute */
            top: 100%; /* Position below the navbar */
            left: 1rem;
            margin-top: 0.5rem;
            background-color: #ffffff; /* Added background color */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 12rem;
            overflow: hidden;
            z-index: 60; /* Increased z-index to ensure it's above navbar content */
        }
        #hamburger-menu a {
            display: flex; /* Use flex to align icon and text */
            align-items: center;
            padding: 0.75rem 1rem;
            color: #374151;
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        #hamburger-menu a:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu.hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans text-gray-800">

    <!-- Navbar with Hamburger Menu -->
    <div class="navbar flex items-center">
        <!-- Hamburger button on the left -->
        <button id="hamburger-btn" aria-label="Mở menu">
            <!-- SVG 3-line icon -->
            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Hidden menu when not active -->
        <div id="hamburger-menu" class="hidden">
            <a href="QuycomQuan.html">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v12a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 000 2h.01a1 1 0 100-2H6zm3 0a1 1 0 000 2h.01a1 1 0 100-2H9zm3 0a1 1 0 000 2h.01a1 1 0 100-2H12zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H9zm3 0a1 1 0 000 2h.01a1 1 0 100-2H12z" clip-rule="evenodd"></path></svg>
                <span data-key="mainAppLink">Ứng dụng chính</span>
            </a>
            <a href="CalendarMaker.html">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Tạo Lịch
            </a>
        </div>

        <!-- Logo and Title (pushed to the right) -->
        <div class="flex items-center ml-4 flex-grow">
            <img src="LogoQuy.png" alt="Logo Quản Lý Quỹ Nhóm" class="h-12 w-auto rounded-lg shadow-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/006B68/FFFFFF?text=Logo';">
            <h1 class="text-2xl font-bold text-[#006B68]" data-key="transactionHistoryTitle">Lịch Sử Giao Dịch</h1>
        </div>
        <div class="language-switch">
            <button id="lang-vi-btn" data-lang="vi" class="active">VI</button>
            <button id="lang-en-btn" data-lang="en">EN</button>
        </div>
    </div>

    <div id="error-message-display" class="error-message mb-4 hidden"></div>

    <!-- Search and Filter Controls -->
    <div class="card mb-4 p-4">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="filterTransactionsTitle">Lọc Giao Dịch</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <label for="from-date-input" class="block text-sm font-medium text-gray-700 mb-1" data-key="fromDateLabel">Từ Ngày</label>
                <input type="datetime-local" id="from-date-input" class="input-field">
            </div>
            <div>
                <label for="to-date-input" class="block text-sm font-medium text-gray-700 mb-1" data-key="toDateLabel">Đến Ngày</label>
                <input type="datetime-local" id="to-date-input" class="input-field">
            </div>
            <div>
                <label for="filter-transaction-type" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionTypeLabel">Loại Giao Dịch</label>
                <select id="filter-transaction-type" class="input-field">
                    <option value="all" data-key="allTypesOption">Tất Cả</option>
                    <option value="contribution" data-key="contributionOption">Đóng Góp</option>
                    <option value="expense" data-key="expenseOption">Chi Tiêu</option>
                </select>
            </div>
            <div>
                <label for="filter-expense-type-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="expenseTypeLabel">Loại Chi Tiêu/Thu</label>
                <select id="filter-expense-type-select" class="input-field">
                    <option value="all" data-key="allCategoriesOption">Tất Cả</option>
                </select>
            </div>
            <div>
                <label for="filter-member-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="relatedMembersLabel">Thành Viên Liên Quan</label>
                <select id="filter-member-select" class="input-field">
                    <option value="all" data-key="allMembersOption">Tất Cả</option>
                </select>
            </div>
            <div>
                <label for="filter-description-input" class="block text-sm font-medium text-gray-700 mb-1" data-key="descriptionLabel">Mô Tả</label>
                <input type="text" id="filter-description-input" class="input-field" data-key="descriptionPlaceholder" placeholder="Mô tả giao dịch">
            </div>
            <div>
                <label for="filter-amount-input" class="block text-sm font-medium text-gray-700 mb-1" data-key="amountLabel">Số Tiền</label>
                <input type="text" id="filter-amount-input" class="input-field text-right" data-key="amountPlaceholder" placeholder="Số tiền">
            </div>
        </div>
        <div class="flex flex-col sm:flex-row justify-end gap-4 mt-4">
            <button type="button" id="reset-filter-btn" class="btn-secondary w-full sm:w-auto" data-key="resetBtn">Đặt Lại</button>
            <button type="button" id="search-btn" class="btn-primary w-full sm:w-auto" data-key="searchBtn">Tìm Kiếm</button>
        </div>
    </div>

    <div id="transactions-section" class="card">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="transactionHistoryTitle">Lịch Sử Giao Dịch</h2>
        <div id="transaction-list-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="loadingTransactions">Đang tải giao dịch...</p>
        </div>
    </div>

    <div id="edit-transaction-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="editTransactionModalTitle">Chỉnh Sửa Giao Dịch</h2>
            <form id="edit-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full">
                    <label for="edit-transaction-type" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionTypeLabel">Loại Giao Dịch</label>
                    <select id="edit-transaction-type" name="editTransactionType" class="input-field">
                        <option value="contribution" data-key="contributionOption">💵 Đóng Góp</option>
                        <option value="expense" data-key="expenseOption">🍺 Chi Tiêu</option>
                    </select>
                </div>

                <div id="edit-expense-type-div" class="col-span-full hidden">
                    <label for="edit-expense-type-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="expenseTypeLabel">Loại Chi Tiêu</label>
                    <select id="edit-expense-type-select" name="editExpenseType" class="input-field"></select>
                </div>

                <div id="edit-contributing-member-div" class="col-span-full">
                    <label for="edit-member-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="contributingMemberLabel">Thành Viên Đóng Góp</label>
                    <select id="edit-member-select" name="editContributingMember" class="input-field" required></select>
                </div>

                <div id="edit-involved-members-div" class="col-span-full hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-key="involvedMembersLabel">Thành Viên Tham Gia Chi Tiêu</label>
                    <div id="edit-involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                        </div>
                </div>

                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-gray-700 mb-1" data-key="amountLabel">Số Tiền (VNĐ)</label>
                    <input type="text" id="edit-amount-input" name="editAmount" data-key="amountPlaceholder" placeholder="Số tiền" class="input-field text-right" required />
                </div>
                <!-- New: Date input field for edit modal -->
                <div>
                    <label for="edit-transaction-date" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionDateLabel">Ngày Giao Dịch</label>
                    <input type="datetime-local" id="edit-transaction-date-input" name="editTransactionDate" class="input-field" required />
                </div>
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1" data-key="descriptionLabel">Mô Tả</label>
                    <textarea id="edit-description-input" name="editDescription" data-key="descriptionPlaceholder" placeholder="Mô tả giao dịch" class="input-field resize-y overflow-auto" rows="3" required></textarea>
                </div>
                <!-- Hidden inputs for GPS coordinates in edit modal -->
                <input type="hidden" id="edit-latitude-input" name="editLatitude">
                <input type="hidden" id="edit-longitude-input" name="editLongitude">

                <div class="col-span-full flex flex-col sm:flex-row justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-transaction-btn" class="btn-secondary w-full sm:w-auto" data-key="cancelBtn">Hủy</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto" data-key="saveChangesBtn">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="member-details-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 id="member-details-name" class="text-2xl font-semibold mb-6 text-[#006B68]"></h2>
            <div class="mb-4">
                <p class="text-lg font-medium text-gray-700" data-key="currentBalance">Số Dư Hiện Tại:</p>
                <p id="member-details-balance" class="text-3xl font-bold"></p>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-[#006B68]" data-key="relatedTransactions">Các Giao Dịch Liên Quan</h3>
            <div id="member-details-transactions-container" class="overflow-x-auto max-h-80">
                <p class="text-center text-gray-500" data-key="noRelatedTransactions">Chưa có giao dịch nào liên quan đến thành viên này.</p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-member-details-btn" class="btn-primary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-xl font-semibold mb-4 text-gray-800" data-key="confirmationTitle">Xác Nhận</h2>
            <p id="confirmation-message" class="mb-6 text-gray-700"></p>
            <div class="flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" id="cancel-confirmation-btn" class="btn-secondary w-full sm:w-auto" data-key="cancelBtn">Hủy</button>
                <button type="button" id="confirm-action-btn" class="btn-primary w-full sm:w-auto" data-key="confirmBtn">Xác Nhận</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-4 text-[#006B68]" data-key="aiDescriptionModalTitle">Mô tả giao dịch bằng AI</h2>
            <input type="file" id="image-upload-input" accept="image/*" class="hidden">
            <img id="uploaded-image-preview" alt="Uploaded Image" class="max-w-full h-auto rounded-md my-4 hidden">
            <div id="camera-loading-spinner" class="hidden"></div>
            <div id="camera-controls" class="flex gap-4 mt-4">
                <button id="cancel-camera-btn" class="btn-secondary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span data-key="cancelBtn">Hủy</span>
                </button>
            </div>
        </div>
    </div>

    <button id="scroll-to-top-btn" data-key="scrollToTopBtn" title="Cuộn lên đầu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
    </button>

    <script>
        // Supabase Client Initialization
        // IMPORTANT: In the Canvas environment, leave SUPABASE_ANON_KEY empty.
        // It will be automatically provided at runtime.
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your actual Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // This should be an empty string in Canvas to use provided key

        let supabase;
        let authReady = false; // New state to track if auth is ready

        // Global state variables (mimicking React state)
        let members = [];
        let transactions = [];
        let expenseTypes = []; // New global state for expense types
        let fundBalance = 0; // Not strictly needed here, but kept for consistency if functions rely on it
        let currentErrorMessage = '';
        let editingTransaction = null;
        let transactionToDelete = null;
        let memberToDelete = null; // New global variable for member to delete

        // Language state
        let currentLanguage = localStorage.getItem('lang') || 'vi'; // Default to Vietnamese

        // Translations object
        const translations = {
            'vi': {
                appTitle: 'Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM',
                mainAppLink: 'Ứng dụng chính',
                fundBalanceTitle: 'Số Dư Quỹ Chung',
                unitCurrency: 'VNĐ',
                addMemberBtn: 'Thêm Thành Viên',
                addTransactionBtn: 'Thêm Giao Dịch',
                viewHistoryBtn: 'Xem Lịch Sử',
                reportBtn: 'Báo Cáo',
                aiInsightsBtn: 'AI Nhận xét Quỹ',
                foodSuggestionsBtn: 'Gợi ý món ăn',
                addMemberTitle: 'Thêm Thành Viên Mới',
                memberNamePlaceholder: 'Tên thành viên',
                addBtn: 'Thêm',
                addTransactionTitle: 'Thêm Giao Dịch Mới',
                transactionTypeLabel: 'Loại Giao Dịch',
                contributionOption: '💵 Đóng Góp',
                expenseOption: '🍺 Chi Tiêu',
                expenseTypeLabel: 'Loại Chi Tiêu', // New translation key
                selectExpenseType: 'Chọn loại chi tiêu', // New translation key
                contributingMemberLabel: 'Thành Viên Đóng Góp',
                involvedMembersLabel: 'Thành Viên Tham Gia Chi Tiêu',
                amountLabel: 'Số Tiền (VNĐ)',
                amountPlaceholder: 'Số tiền',
                transactionDateLabel: 'Ngày Giao Dịch', // New translation key
                descriptionLabel: 'Mô Tả',
                descriptionPlaceholder: 'Mô tả giao dịch',
                aiDescribeBtn: 'Mô tả AI từ Ảnh/Camera',
                recordTransactionBtn: 'Ghi Lại Giao Dịch',
                memberListTitle: 'Danh Sách Thành Viên',
                loadingMembers: 'Đang tải thành viên...',
                memberNameHeader: 'Tên Thành Viên',
                balanceHeader: 'Số Dư',
                actionHeader: 'Hành Động',
                settleUpBtn: 'Thanh Toán',
                viewDetailsBtn: 'Xem chi tiết',
                noMembers: 'Chưa có thành viên nào. Hãy thêm thành viên!',
                summaryReportTitle: 'Báo Cáo Tóm Tắt',
                totalContributions: 'Tổng Đóng Góp',
                totalExpenses: 'Tổng Chi Tiêu',
                memberBalanceChartTitle: 'Số Dư Thành Viên (Biểu Đồ Tròn)',
                loadingChart: 'Đang tải biểu đồ...',
                categoryChartsTitle: 'Thu/Chi Theo Phân Loại (Biểu Đồ Bánh)',
                incomeByCategory: 'Thu nhập theo loại',
                expenseByCategory: 'Chi tiêu theo loại',
                fundReportTitle: 'Báo Cáo Quỹ Chung',
                exportExcelBtn: 'Xuất Excel',
                exportWordBtn: 'Xuất Word',
                noTransactionsReport: 'Chưa có giao dịch nào để báo cáo.',
                dateHeader: 'Ngày',
                typeHeader: 'Loại',
                descriptionHeader: 'Mô Tả',
                expenseTypeHeader: 'Loại Chi Tiêu', // New Column
                relatedMembersHeader: 'Thành Viên Liên Quan',
                amountHeader: 'Số Tiền (VNĐ)',
                memberReportsTitle: 'Báo Cáo Từng Thành Viên',
                selectMemberReportLabel: 'Chọn Thành Viên:',
                selectMemberToReport: 'Vui lòng chọn một thành viên để xem báo cáo.',
                noMemberTransactions: 'Thành viên này chưa có giao dịch nào.',
                transactionHistoryTitle: 'Lịch Sử Giao Dịch',
                loadingTransactions: 'Đang tải giao dịch...',
                noTransactions: 'Chưa có giao dịch nào.',
                editBtn: 'Sửa',
                deleteBtn: 'Xóa',
                editTransactionModalTitle: 'Chỉnh Sửa Giao Dịch',
                cancelBtn: 'Hủy',
                saveChangesBtn: 'Lưu Thay Đổi',
                memberDetailsModalTitle: 'Chi Tiết Thành Viên:',
                currentBalance: 'Số Dư Hiện Tại:',
                relatedTransactions: 'Các Giao Dịch Liên Quan',
                noRelatedTransactions: 'Chưa có giao dịch nào liên quan đến thành viên này.',
                closeBtn: 'Đóng',
                confirmationTitle: 'Xác Nhận',
                confirmBtn: 'Xác Nhận',
                selectReportTypeTitle: 'Chọn Loại Báo Cáo',
                fundReportOption: 'Báo Cáo Quỹ Chung',
                memberReportOption: 'Báo Cáo Từng Thành Viên',
                fundInsightsModalTitle: 'Thông Tin Chi Tiết Quỹ ✨',
                generatingInsights: 'Đang tạo thông tin chi tiết từ AI...',
                noInsights: 'Không thể tạo thông tin chi tiết. Vui lòng thử lại.',
                aiConnectionError: 'Đã xảy ra lỗi khi kết nối với AI. Vui lòng thử lại.',
                foodSuggestionModalTitle: 'Gợi ý món ăn ✨',
                generatingFoodSuggestions: 'Đang tìm kiếm gợi ý món ăn gần bạn...',
                locationError: 'Không thể lấy vị trí hiện tại của bạn. Vui lòng cho phép truy cập vị trí.',
                permissionDenied: 'Bạn đã từ chối quyền truy cập vị trí. Vui lòng cho phép trong cài đặt trình duyệt để nhận gợi ý món ăn.',
                positionUnavailable: 'Thông tin vị trí không khả dụng.',
                timeout: 'Hết thời gian chờ khi cố gắng lấy vị trí.',
                geolocationNotSupported: 'Trình duyệt của bạn không hỗ trợ tính năng định vị địa lý.',
                noFoodSuggestions: 'Không tìm thấy gợi ý món ăn nào.',
                foodSuggestionError: 'Không thể tạo gợi ý món ăn. Vui lòng thử lại.',
                addressLabel: 'Địa chỉ:',
                phoneLabel: 'Điện thoại:',
                ratingLabel: 'Đánh giá:',
                distanceLabel: 'Khoảng cách:',
                descriptionLabelShort: 'Mô tả:',
                menuLabel: 'Menu:',
                viewOnMaps: 'Xem trên Google Maps',
                aiDescriptionModalTitle: 'Mô tả giao dịch bằng AI',
                supaLoadError: 'Lỗi: Thư viện Supabase chưa được tải. Vui lòng kiểm tra kết nối mạng.',
                supabaseConfigWarning: 'Cảnh báo: URL hoặc Khóa Supabase vẫn là giá trị mặc định. Vui lòng thay thế bằng thông tin dự án thực của bạn.',
                supabaseTableError: 'Lỗi: Các bảng dữ liệu (members, transactions, expensetype) chưa được tạo trong Supabase. Vui lòng chạy các script SQL đã cung cấp trước đó.', // Updated
                dataLoadError: 'Lỗi khi tải dữ liệu:',
                emptyMemberName: 'Tên thành viên không được để trống.',
                addMemberError: 'Lỗi khi thêm thành viên:',
                settleUpError: 'Lỗi khi thanh toán số dư:',
                invalidAmountDesc: 'Vui lòng nhập số tiền hợp lệ và mô tả.',
                selectContributingMember: 'Vui lòng chọn thành viên đóng góp.',
                selectInvolvedMembers: 'Vui lòng chọn ít nhất một thành viên tham gia chi tiêu.',
                addTransactionError: 'Lỗi khi thêm giao dịch:',
                editInvalidAmountDesc: 'Vui lòng nhập số tiền hợp lệ và mô tả cho giao dịch.',
                editSelectContributingMember: 'Vui lòng chọn thành viên đóng góp cho giao dịch này.',
                editSelectInvolvedMembers: 'Vui lòng chọn ít nhất một thành viên tham gia chi tiêu cho giao dịch này.',
                editTransactionError: 'Lỗi khi sửa giao dịch:',
                confirmDeleteTransaction: 'Bạn có chắc chắn muốn xóa giao dịch "{description}" này không?',
                deleteTransactionError: 'Lỗi khi xóa giao dịch:',
                noBalanceChart: 'Chưa có số dư nào để hiển thị biểu đồ.',
                noCategoryChart: 'Chưa có {type} để hiển thị biểu đồ.',
                chartLegend: 'Chú Thích:',
                chartLegendFor: 'Chú Thích {title}:',
                xlsxLoadError: 'Thư viện XLSX chưa được tải. Vui lòng thử lại sau.',
                selectMemberForExport: 'Vui lòng chọn một thành viên để xuất báo cáo.',
                fileSaverLoadError: 'Thư viện FileSaver.js chưa được tải. Vui lòng thử lại sau.',
                selectMemberForWordExport: 'Vui lòng chọn một thành viên để xuất báo cáo Word.',
                apiError: 'API Error:',
                noImageDescription: 'Could not get image description from AI. Please try again.',
                aiCallError: 'Error calling AI:',
                scrollToTopBtn: ' ↑',
                allMembers: 'Tất Cả',
                contributionType: 'Đóng góp',
                expenseType: 'Chi tiêu',
                otherCategory: 'Khác',
                totalChart: 'Tổng:',
                deleteMemberBtn: 'Xóa', // New translation key
                confirmDeleteMember: 'Bạn có chắc chắn muốn xóa thành viên "{memberName}"? Tất cả các giao dịch liên quan sẽ bị xóa.', // New translation key
                deleteMemberError: 'Lỗi khi xóa thành viên:', // New translation key
                memberBalanceNotZero: 'Không thể xóa thành viên có số dư khác không. Vui lòng thanh toán số dư trước.', // New translation key
                defaultExpenseTypes: 'Ăn uống, Di chuyển, Mua sắm, Giải trí, Sức khỏe, Giáo dục, Khác', // New translation for default expense types
                filterTransactionsTitle: 'Lọc Giao Dịch',
                fromDateLabel: 'Từ Ngày',
                toDateLabel: 'Đến Ngày',
                allTypesOption: 'Tất Cả',
                allCategoriesOption: 'Tất Cả',
                allMembersOption: 'Tất Cả',
                searchBtn: 'Tìm Kiếm',
                resetBtn: 'Đặt Lại',
            },
            'en': {
                appTitle: 'Transaction History - GROUP FUND MANAGEMENT',
                mainAppLink: 'Main App',
                fundBalanceTitle: 'Overall Fund Balance',
                unitCurrency: 'VNĐ',
                addMemberBtn: 'Add Member',
                addTransactionBtn: 'Add Transaction',
                viewHistoryBtn: 'View History',
                reportBtn: 'Reports',
                aiInsightsBtn: 'AI Fund Insights',
                foodSuggestionsBtn: 'Food Suggestions',
                addMemberTitle: 'Add New Member',
                memberNamePlaceholder: 'Member Name',
                addBtn: 'Add',
                addTransactionTitle: 'Add New Transaction',
                transactionTypeLabel: 'Transaction Type',
                contributionOption: '💵 Contribution',
                expenseOption: '🍺 Expense',
                expenseTypeLabel: 'Expense Type',
                selectExpenseType: 'Select expense type',
                contributingMemberLabel: 'Contributing Member',
                involvedMembersLabel: 'Members Involved in Expense',
                amountLabel: 'Amount (VND)',
                amountPlaceholder: 'Amount',
                transactionDateLabel: 'Transaction Date',
                descriptionLabel: 'Description',
                descriptionPlaceholder: 'Transaction description',
                aiDescribeBtn: 'AI Describe from Image/Camera',
                recordTransactionBtn: 'Record Transaction',
                memberListTitle: 'Member List',
                loadingMembers: 'Loading members...',
                memberNameHeader: 'Member Name',
                balanceHeader: 'Balance',
                actionHeader: 'Action',
                settleUpBtn: 'Settle Up',
                viewDetailsBtn: 'View Details',
                noMembers: 'No members added yet. Add some members!',
                summaryReportTitle: 'Summary Report',
                totalContributions: 'Total Contributions',
                totalExpenses: 'Total Expenses',
                memberBalanceChartTitle: 'Member Balances (Pie Chart)',
                loadingChart: 'Loading chart...',
                categoryChartsTitle: 'Income/Expense by Category (Pie Charts)',
                incomeByCategory: 'Income by Category',
                expenseByCategory: 'Expense by Category',
                fundReportTitle: 'Overall Fund Report',
                exportExcelBtn: 'Export Excel',
                exportWordBtn: 'Export Word',
                noTransactionsReport: 'No transactions to report.',
                dateHeader: 'Date',
                typeHeader: 'Type',
                descriptionHeader: 'Description',
                expenseTypeHeader: 'Expense Type',
                relatedMembersHeader: 'Related Members',
                amountHeader: 'Amount (VND)',
                memberReportsTitle: 'Individual Member Reports',
                selectMemberReportLabel: 'Select Member:',
                selectMemberToReport: 'Please select a member to view report.',
                noMemberTransactions: 'This member has no related transactions.',
                transactionHistoryTitle: 'Transaction History',
                loadingTransactions: 'Loading transactions...',
                noTransactions: 'No transactions recorded yet.',
                editBtn: 'Edit',
                deleteBtn: 'Delete',
                editTransactionModalTitle: 'Edit Transaction',
                cancelBtn: 'Cancel',
                saveChangesBtn: 'Save Changes',
                memberDetailsModalTitle: 'Member Details:',
                currentBalance: 'Current Balance:',
                relatedTransactions: 'Related Transactions',
                noRelatedTransactions: 'No related transactions for this member.',
                closeBtn: 'Close',
                confirmationTitle: 'Confirmation',
                confirmBtn: 'Confirm',
                selectReportTypeTitle: 'Select Report Type',
                fundReportOption: 'Overall Fund Report',
                memberReportOption: 'Individual Member Reports',
                fundInsightsModalTitle: 'Fund Insights ✨',
                generatingInsights: 'Generating AI insights...',
                noInsights: 'Could not generate insights. Please try again.',
                aiConnectionError: 'An error occurred connecting to AI. Please try again.',
                foodSuggestionModalTitle: 'Food Suggestions ✨',
                generatingFoodSuggestions: 'Searching for food suggestions near you...',
                locationError: 'Could not retrieve your current location. Please enable location access.',
                permissionDenied: 'Location access denied. Please enable it in your browser settings to get food suggestions.',
                positionUnavailable: 'Location information is unavailable.',
                timeout: 'The request to get user location timed out.',
                geolocationNotSupported: 'Your browser does not support geolocation.',
                noFoodSuggestions: 'No food suggestions found.',
                foodSuggestionError: 'Could not generate food suggestions. Please try again.',
                addressInputLabel: 'Or enter a specific address:',
                searchByAddressBtn: 'Search by this address',
                addressLabel: 'Address:',
                phoneLabel: 'Phone:',
                ratingLabel: 'Rating:',
                distanceLabel: 'Distance:',
                descriptionLabelShort: 'Description:',
                menuLabel: 'Menu:',
                viewOnMaps: 'View on Google Maps',
                aiDescriptionModalTitle: 'AI Transaction Description',
                supaLoadError: 'Error: Supabase library not loaded. Please check network connection.',
                supabaseConfigWarning: 'Warning: Supabase URL or Key is still default. Please replace with your actual project info.',
                supabaseTableError: 'Error: Data tables (members, transactions, expensetype) are not created in Supabase. Please run the provided SQL scripts first.',
                dataLoadError: 'Error loading data:',
                emptyMemberName: 'Member name cannot be empty.',
                addMemberError: 'Error adding member:',
                settleUpError: 'Error settling up balance:',
                invalidAmountDesc: 'Please enter a valid amount and description.',
                selectContributingMember: 'Please select a contributing member.',
                selectInvolvedMembers: 'Please select at least one member involved in the expense.',
                addTransactionError: 'Error adding transaction:',
                editInvalidAmountDesc: 'Please enter a valid amount and description for the transaction.',
                editSelectContributingMember: 'Please select a contributing member for this transaction.',
                editSelectInvolvedMembers: 'Please select at least one member involved in this expense.',
                editTransactionError: 'Error editing transaction:',
                confirmDeleteTransaction: 'Are you sure you want to delete this transaction: "{description}"?',
                deleteTransactionError: 'Error deleting transaction:',
                noBalanceChart: 'No balances to display chart.',
                noCategoryChart: 'No {type} to display chart.',
                chartLegend: 'Legend',
                chartLegendFor: 'Legend for {title}',
                xlsxLoadError: 'XLSX library not loaded. Please try again.',
                selectMemberForExport: 'Please select a member to export report.',
                fileSaverLoadError: 'FileSaver.js library not loaded. Please try again.',
                selectMemberForWordExport: 'Please select a member to export Word report.',
                apiError: 'API Error:',
                noImageDescription: 'Could not get image description from AI. Please try again.',
                aiCallError: 'Error calling AI:',
                scrollToTopBtn: ' ↑',
                allMembers: 'All',
                contributionType: 'Contribution',
                expenseType: 'Expense',
                otherCategory: 'Other',
                totalChart: 'Total:',
                deleteMemberBtn: 'Delete',
                confirmDeleteMember: 'Are you sure you want to delete member "{memberName}"? All related transactions will be deleted.',
                deleteMemberError: 'Error deleting member:',
                memberBalanceNotZero: 'Cannot delete member with non-zero balance. Please settle up the balance first.',
                defaultExpenseTypes: 'Food, Transport, Shopping, Entertainment, Health, Education, Other',
                filterTransactionsTitle: 'Filter Transactions',
                fromDateLabel: 'From Date',
                toDateLabel: 'To Date',
                allTypesOption: 'All Types',
                allCategoriesOption: 'All Categories',
                allMembersOption: 'All Members',
                searchBtn: 'Search',
                resetBtn: 'Reset',
            }
        };

        // DOM Elements
        const errorMessageDisplay = document.getElementById('error-message-display');
        const transactionListContainer = document.getElementById('transaction-list-container');
        const transactionsSection = document.getElementById('transactions-section');

        // Language switch buttons
        const langViBtn = document.getElementById('lang-vi-btn');
        const langEnBtn = document.getElementById('lang-en-btn');

        // Modals
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const memberDetailsModal = document.getElementById('member-details-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const cameraModal = document.getElementById('camera-modal');

        // Forms and Inputs (for edit and AI description)
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editExpenseTypeDiv = document.getElementById('edit-expense-type-div');
        const editExpenseTypeSelect = document.getElementById('edit-expense-type-select');
        const editContributingMemberDiv = document.getElementById('edit-contributing-member-div');
        const editMemberSelect = document.getElementById('edit-member-select');
        const editInvolvedMembersDiv = document.getElementById('edit-involved-members-div');
        const editInvolvedMembersCheckboxes = document.getElementById('edit-involved-members-checkboxes');
        const editAmountInput = document.getElementById('edit-amount-input');
        const editTransactionDateInput = document.getElementById('edit-transaction-date-input');
        const editDescriptionInput = document.getElementById('edit-description-input');
        const editLatitudeInput = document.getElementById('edit-latitude-input');
        const editLongitudeInput = document.getElementById('edit-longitude-input');
        const cancelEditTransactionBtn = document.getElementById('cancel-edit-transaction-btn');

        // Member Details Modal Elements
        const memberDetailsName = document.getElementById('member-details-name');
        const memberDetailsBalance = document.getElementById('member-details-balance');
        const memberDetailsTransactionsContainer = document.getElementById('member-details-transactions-container');
        const closeMemberDetailsBtn = document.getElementById('close-member-details-btn');

        // Confirmation Modal Elements
        const confirmationMessage = document.getElementById('confirmation-message');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');

        // Camera/Image Upload Elements
        const imageUploadInput = document.getElementById('image-upload-input');
        const uploadedImagePreview = document.getElementById('uploaded-image-preview');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const cameraLoadingSpinner = document.getElementById('camera-loading-spinner');

        // Scroll to Top Button Element
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

        // Filter Elements
        const fromDateInput = document.getElementById('from-date-input');
        const toDateInput = document.getElementById('to-date-input');
        const filterTransactionTypeSelect = document.getElementById('filter-transaction-type');
        const filterDescriptionInput = document.getElementById('filter-description-input');
        const filterExpenseTypeSelect = document.getElementById('filter-expense-type-select');
        const filterMemberSelect = document.getElementById('filter-member-select');
        const filterAmountInput = document.getElementById('filter-amount-input');
        const searchBtn = document.getElementById('search-btn');
        const resetFilterBtn = document.getElementById('reset-filter-btn');

        // Filter state variables
        let filterFromDate = null;
        let filterToDate = null;
        let filterType = 'all';
        let filterDescription = '';
        let filterExpenseType = 'all';
        let filterMember = 'all';
        let filterAmount = '';

        // --- Language Functions ---
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('lang', lang);
            updateContent();
            updateLanguageButtons();
            // Re-render dynamic content that uses translations
            renderTransactionList();
            // Update placeholder texts
            document.getElementById('edit-amount-input').placeholder = translations[currentLanguage].amountPlaceholder;
            document.getElementById('edit-description-input').placeholder = translations[currentLanguage].descriptionPlaceholder;
            document.getElementById('scroll-to-top-btn').title = translations[currentLanguage].scrollToTopBtn;
            // Update filter placeholder texts
            document.getElementById('filter-description-input').placeholder = translations[currentLanguage].descriptionPlaceholder;
            document.getElementById('filter-amount-input').placeholder = translations[currentLanguage].amountPlaceholder;
            populateFilterSelectors(); // Re-populate filter selectors for translation
        }

        function updateContent() {
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            // Special handling for title tag
            document.title = translations[currentLanguage].appTitle;
            // Special handling for options in select elements
            document.querySelector('#edit-transaction-type option[value="contribution"]').textContent = translations[currentLanguage].contributionOption;
            document.querySelector('#edit-transaction-type option[value="expense"]').textContent = translations[currentLanguage].expenseOption;
        }

        function updateLanguageButtons() {
            langViBtn.classList.remove('active');
            langEnBtn.classList.remove('active');
            if (currentLanguage === 'vi') {
                langViBtn.classList.add('active');
            } else {
                langEnBtn.classList.add('active');
            }
        }

        // --- Helper Functions ---

        // Formats a number with thousands separators for display
        function formatNumberForDisplay(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '';
            }
            // Round to the nearest integer (đồng)
            const roundedNum = Math.round(num);
            return roundedNum.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Parses a formatted number string back to a raw number
        function parseFormattedNumber(formattedValue) {
            // Get locale-specific thousands and decimal separators
            const locale = currentLanguage === 'vi' ? 'vi-VN' : 'en-US';
            const formatter = new Intl.NumberFormat(locale, { useGrouping: true, minimumFractionDigits: 0 });
            // Use a number that has both grouping and decimal to correctly identify separators
            // Note: For parsing back, we need to be careful with actual locale separators
            const parts = formatter.formatToParts(1000.50);
            let thousandsSeparator = '';
            let decimalSeparator = '';

            for (const part of parts) {
                if (part.type === 'group') {
                    thousandsSeparator = part.value;
                } else if (part.type === 'decimal') {
                    decimalSeparator = part.value;
                }
            }

            // Remove thousands separators from the formatted value
            let cleanedValue = formattedValue;
            if (thousandsSeparator) { // Only replace if a thousands separator was found
                // Escape special characters in the thousands separator for regex if necessary
                const thousandsSeparatorRegex = new RegExp(thousandsSeparator.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                cleanedValue = cleanedValue.replace(thousandsSeparatorRegex, '');
            }

            // Replace the locale-specific decimal separator with a standard dot for parseFloat
            cleanedValue = cleanedValue.replace(decimalSeparator, '.');

            // Remove any remaining non-numeric characters except for the decimal point
            cleanedValue = cleanedValue.replace(/[^0-9.]/g, '');

            const parsed = parseFloat(cleanedValue);
            return isNaN(parsed) ? 0 : parsed;
        }


        // Formats a number string with thousands separators for input fields
        function formatNumberForInput(value) {
            const rawNumber = parseFormattedNumber(value);
            // Always round to integer for input display as well
            const roundedNum = Math.round(rawNumber);
            return roundedNum.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Displays an error message
        function showErrorMessage(message) {
            currentErrorMessage = message;
            errorMessageDisplay.textContent = message;
            errorMessageDisplay.classList.remove('hidden');
        }

        // Hides the error message
        function hideErrorMessage() {
            currentErrorMessage = '';
            errorMessageDisplay.classList.add('hidden');
        }

        // Hides all main sections and modals (only modals in this file)
        function hideAllSections() {
            editTransactionModal.classList.add('hidden');
            memberDetailsModal.classList.add('hidden');
            confirmationModal.classList.add('hidden');
            cameraModal.classList.add('hidden');
            hideErrorMessage();
        }

        // Scrolls to a specific section on the page (only transactions-section in this file)
        function scrollToSection(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- Supabase and Data Management ---

        // Initializes Supabase client
        function initializeSupabase() {
            console.log("Attempting to initialize Supabase...");
            console.log("Type of window.supabase:", typeof window.supabase);
            if (typeof window.supabase === 'undefined') {
                console.error("window.supabase is undefined. Supabase library not loaded. Check network connection and CDN link.");
                showErrorMessage(translations[currentLanguage].supaLoadError);
                return;
            }
            console.log("window.supabase is available.");

            // Determine the API key to use
            // In Canvas environment, __supabase_key is provided. Otherwise, use the hardcoded SUPABASE_ANON_KEY.
            const anonKey = typeof __supabase_key !== 'undefined' ? __supabase_key : SUPABASE_ANON_KEY;
            console.log("Using Supabase Anon Key:", anonKey ? "Provided/Non-empty" : "Empty/Default");

            // Warn if default URL is still in use
            if (SUPABASE_URL === 'https://1rmbsxccrwrktbjlnezpu.supabase.co') {
                 console.warn("Supabase configuration warning: SUPABASE_URL is still the default value. Please replace with your actual Supabase Project URL.");
                 showErrorMessage(translations[currentLanguage].supabaseConfigWarning);
            }
            // Also warn if anonKey is empty and not running in Canvas (where __supabase_key would be injected)
            if (!anonKey && typeof __supabase_key === 'undefined') {
                console.warn("Supabase configuration warning: SUPABASE_ANON_KEY is empty and __supabase_key is not defined. This app might not connect to Supabase correctly outside Canvas.");
                showErrorMessage(translations[currentLanguage].supabaseConfigWarning + " (Khóa API trống)");
            }


            try {
                // Ensure we are getting the createClient function correctly.
                // It's usually directly available on the global `supabase` object from the CDN.
                if (typeof window.supabase.createClient !== 'function') {
                    const errorMsg = "Supabase library loaded, but `createClient` function is not available on `window.supabase`. This might indicate a corrupted load or version issue.";
                    console.error(errorMsg);
                    showErrorMessage(errorMsg);
                    return;
                }

                supabase = window.supabase.createClient(SUPABASE_URL, anonKey);
                console.log("Supabase client created:", supabase); // Log the full client object
                console.log("Supabase auth module:", supabase.auth); // Log the auth module

                // Add authentication listener
                if (!supabase || !supabase.auth || typeof supabase.auth.onAuthStateChange !== 'function') { // Corrected method name to onAuthStateChange
                    console.error("DEBUG: Value of supabase.auth:", supabase.auth);
                    const errorMsg = "Supabase client hoặc mô-đun xác thực không được khởi tạo đúng cách. `onAuthStateChange` không phải là một hàm. Vui lòng kiểm tra lại SUPABASE_URL và SUPABASE_ANON_KEY trong mã của bạn. Quan trọng hơn, hãy đảm bảo rằng dịch vụ **Xác thực (Authentication)** đã được kích hoạt và cấu hình đúng trong **Bảng điều khiển Supabase** của dự án của bạn (phần 'Authentication' -> 'Settings').";
                    console.error(errorMsg);
                    showErrorMessage(errorMsg);
                    return;
                }
                supabase.auth.onAuthStateChange((event, session) => { // Corrected method name to onAuthStateChange
                    console.log("onAuthStateChange event:", event, "session:", session);
                    if (session) {
                        console.log("User is logged in:", session.user);
                        authReady = true;
                        fetchData(); // Fetch initial data after successful login
                        setupRealtimeSubscriptions(); // Set up real-time listeners
                    } else {
                        console.log("User is not logged in, redirecting to login page.");
                        authReady = false;
                        // Redirect to login page if not authenticated
                        // Use window.location.origin to construct an absolute URL
                        window.location.href = window.location.origin + '/Strava/LoginQuan.html';
                    }
                });

            } catch (error) {
                console.error("Error during Supabase client creation or initialization:", error);
                showErrorMessage(`Lỗi khi tạo client Supabase: ${error.message}. Vui lòng kiểm tra URL và khóa API.`);
                return;
            }
        }

        // Fetches all data from Supabase
        async function fetchData() {
            if (!authReady) {
                console.log("Authentication not ready, skipping data fetch.");
                return;
            }
            showLoading(true);
            try {
                // Fetch members
                const { data: membersData, error: membersError } = await supabase
                    .from('members_quan') // Updated table name
                    .select('*');

                if (membersError) {
                    if (membersError.message.includes('relation "public.members_quan" does not exist')) { // Updated table name
                        showErrorMessage(translations[currentLanguage].supabaseTableError);
                    } else {
                        showErrorMessage(`${translations[currentLanguage].dataLoadError} ${translations[currentLanguage].memberNameHeader.toLowerCase()}: ${membersError.message}`);
                    }
                    throw membersError;
                }

                // Fetch transactions
                const { data: transactionsData, error: transactionsError } = await supabase
                    .from('transactions_quan') // Updated table name
                    .select('*');

                if (transactionsError) {
                    if (transactionsError.message.includes('relation "public.transactions_quan" does not exist')) { // Updated table name
                        showErrorMessage(translations[currentLanguage].supabaseTableError);
                    } else {
                        showErrorMessage(`${translations[currentLanguage].dataLoadError} ${translations[currentLanguage].transactionHistoryTitle.toLowerCase()}: ${transactionsError.message}`);
                    }
                    throw transactionsError;
                }

                // Fetch expense types (New) - DO NOT AUTO-POPULATE IF EMPTY
                const { data: expenseTypesData, error: expenseTypesError } = await supabase
                    .from('expensetype_quan')
                    .select('*');

                if (expenseTypesError) {
                    if (expenseTypesError.message.includes('relation "public.expensetype" does not exist')) {
                        showErrorMessage(translations[currentLanguage].supabaseTableError);
                    } else {
                        showErrorMessage(`${translations[currentLanguage].dataLoadError} ${translations[currentLanguage].expenseTypeLabel.toLowerCase()}: ${expenseTypesError.message}`);
                    }
                    throw expenseTypesError;
                }

                members = membersData;
                transactions = transactionsData;
                expenseTypes = expenseTypesData; // Store expense types

                // If no expense types exist, populate with default ones
                if (expenseTypes.length === 0) {
                    console.log("No expense types found, populating with default data...");
                    const defaultExpenseTypes = translations[currentLanguage].defaultExpenseTypes.split(', ').map(name => ({
                        expense_type: name,
                        Type: 'expense' // Mặc định là loại 'expense'
                    }));
                    // Thêm loại đóng góp mặc định
                    defaultExpenseTypes.unshift({
                        expense_type: translations[currentLanguage].contributionType,
                        Type: 'contribution'
                    });

                    const { data: newExpenseTypes, error: newExpenseTypesError } = await supabase
                        .from('expensetype_quan')
                        .insert(defaultExpenseTypes)
                        .select();

                    if (newExpenseTypesError) {
                        console.error("Error inserting default expense types:", newExpenseTypesError);
                        throw newExpenseTypesError;
                    }
                    expenseTypes = newExpenseTypes;
                }

                // If no members exist, populate with default data (only members and transactions)
                // This block is typically for the main app, but if this page can be accessed first,
                // it might need to ensure basic data exists. For now, assuming members are handled by main app.
                if (members.length === 0) {
                    console.warn("No members found. This page might not function correctly without initial member data from the main app.");
                    // Optionally, you could redirect to the main app or show a message.
                }

                updateUI(); // Update UI after fetching data
            } catch (error) {
                console.error("Error fetching data from Supabase:", error.message);
                // Error message already set by specific checks above, or fallback here
                if (!currentErrorMessage) {
                    showErrorMessage(`${translations[currentLanguage].dataLoadError} ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        }

        // Sets up real-time subscriptions for members and transactions
        function setupRealtimeSubscriptions() {
            if (!authReady) {
                console.log("Authentication not ready, skipping real-time subscriptions.");
                return;
            }
            supabase
                .channel('public:members_quan') // Updated table name
                .on('postgres_changes', { event: '*', schema: 'public', table: 'members_quan' }, payload => { // Updated table name
                    console.log('Member change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();

            supabase
                .channel('public:transactions_quan') // Updated table name
                .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions_quan' }, payload => { // Updated table name
                    console.log('Transaction change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();

            // New: Real-time subscription for expensetype table
            supabase
                .channel('public:expensetype')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'expensetype' }, payload => {
                    console.log('Expense type change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();
        }

        // Shows/hides a loading indicator
        function showLoading(isLoading) {
            const loadingDiv = document.getElementById('loading-overlay'); // Assuming a loading overlay div exists
            if (loadingDiv) {
                loadingDiv.classList.toggle('hidden', !isLoading);
            }
            // You might also disable buttons or inputs here
        }

        // --- UI Update Functions ---

        // Updates all dynamic parts of the UI
        function updateUI() {
            calculateBalances(); // Still needed for member details
            populateSelectors(); // Populate member selectors for modals
            populateFilterSelectors(); // Populate filter dropdowns
            renderTransactionList(); // Re-render transaction list
        }

        // Calculates fund and member balances (needed for member details modal)
        function calculateBalances() {
            let totalBalance = 0;
            const tempMemberBalances = new Map(members.map(m => [m.id, 0]));

            transactions.forEach(t => {
                if (t.type === 'contribution') {
                    totalBalance += t.amount;
                    if (tempMemberBalances.has(t.contributingMemberId)) {
                        tempMemberBalances.set(t.contributingMemberId, tempMemberBalances.get(t.contributingMemberId) + t.amount);
                    }
                } else if (t.type === 'expense') {
                    totalBalance -= t.amount;
                    const involvedMembers = t.involvedMemberIds && t.involvedMemberIds.length > 0
                        ? t.involvedMemberIds
                        : members.map(m => m.id);

                    if (involvedMembers.length > 0) {
                        const costPerMember = t.amount / involvedMembers.length;
                        involvedMembers.forEach(memberId => {
                            if (tempMemberBalances.has(memberId)) {
                                tempMemberBalances.set(memberId, tempMemberBalances.get(memberId) - costPerMember);
                            }
                        });
                    }
                }
            });

            members = members.map(member => ({
                ...member,
                balance: tempMemberBalances.get(member.id) || 0
            }));
            fundBalance = totalBalance;
        }

        // Renders the transaction list table
        function renderTransactionList(transactionsToRender = transactions) { // Modified signature
            if (transactionsToRender.length === 0) { // Use transactionsToRender
                transactionListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noTransactions}</p>`;
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th>${translations[currentLanguage].dateHeader}</th>
                            <th>${translations[currentLanguage].typeHeader}</th>
                            <th>${translations[currentLanguage].descriptionHeader}</th>
                            <th>${translations[currentLanguage].expenseTypeHeader}</th> <!-- New Column -->
                            <th>${translations[currentLanguage].relatedMembersHeader}</th>
                            <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            <th>${translations[currentLanguage].actionHeader}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            transactionsToRender.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => { // Display latest first, sorted by actual date
                // For the general transaction list, always display the total amount of the expense
                const displayedAmount = t.amount;
                const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('💵 ', '') : translations[currentLanguage].expenseOption.replace('🍺 ', '');
                const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                const memberNames = t.type === 'contribution'
                    ? getMemberName(t.contributingMemberId)
                    : getInvolvedMembersNames(t.involvedMemberIds);

                const transactionDate = new Date(t.date).toLocaleDateString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                tableHtml += `
                    <tr class="table-row">
                        <td>${transactionDate}</td>
                        <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                        <td>${t.description}</td>
                        <td>${t.type === 'expense' && t.expense_type ? t.expense_type : 'N/A'}</td> <!-- Display expense type -->
                        <td>${memberNames}</td>
                        <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                        <td class="flex flex-col sm:flex-row gap-2">
                            <button data-transaction-id="${t.id}" class="edit-transaction-btn text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto">${translations[currentLanguage].editBtn}</button>
                            <button data-transaction-id="${t.id}" class="delete-transaction-btn text-red-600 hover:text-red-900 font-semibold text-sm w-full sm:w-auto">${translations[currentLanguage].deleteBtn}</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            transactionListContainer.innerHTML = tableHtml;

            // Attach event listeners for edit and delete buttons
            transactionListContainer.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.transactionId;
                    const transactionToEdit = transactions.find(t => t.id === id);
                    if (transactionToEdit) showEditTransactionModal(transactionToEdit);
                };
            });
            transactionListContainer.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.transactionId;
                    const transactionToDeleteFound = transactions.find(t => t.id === id);
                    if (transactionToDeleteFound) confirmDeleteTransaction(transactionToDeleteFound);
                };
            });
        }

        // Helper to get member name by ID
        function getMemberName(memberId) {
            const member = members.find(m => m.id === memberId);
            return member ? member.name : 'N/A';
        }

        // Helper to get involved members' names for expenses
        function getInvolvedMembersNames(involvedMemberIds) {
            if (!involvedMemberIds || involvedMemberIds.length === 0) {
                return translations[currentLanguage].allMembers;
            }
            return involvedMemberIds.map(id => getMemberName(id)).join(', ');
        }

        // Populates the member dropdowns and checkboxes for transaction forms (and expense types)
        function populateSelectors() {
            // For Edit Transaction Form - Members (similar logic for edit modal)
            editMemberSelect.innerHTML = '';
            editInvolvedMembersCheckboxes.innerHTML = '';

            if (members.length === 0) {
                editMemberSelect.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                editInvolvedMembersCheckboxes.innerHTML = `<p class="text-gray-500 text-sm">${translations[currentLanguage].noMembers}</p>`;
            } else {
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    editMemberSelect.appendChild(option);

                    const label = document.createElement('label');
                    label.className = 'inline-flex items-center cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]" value="${member.id}">
                        <span class="ml-2 text-sm text-gray-700">${member.name}</span>
                    `;
                    editInvolvedMembersCheckboxes.appendChild(label);
                });
            }

            // Populate expense type select for edit form (default to 'expense' type for initial population)
            populateExpenseTypeSelect(editExpenseTypeSelect, 'expense');
        }

        // Hàm để điền các loại chi tiêu/thu nhập vào dropdown
        function populateExpenseTypeSelect(selectElement, transactionType) {
            selectElement.innerHTML = '';

            let filteredTypes = [];
            // Lọc các loại chi tiêu/thu nhập dựa trên 'Type' của chúng trong bảng expensetype
            if (transactionType) {
                filteredTypes = expenseTypes.filter(type => type.Type === transactionType);
            } else {
                // Nếu không có transactionType, hiển thị tất cả các loại (hoặc không hiển thị gì)
                filteredTypes = expenseTypes;
            }

            if (filteredTypes.length === 0) {
                const noOptionsMessage = translations[currentLanguage].selectExpenseType;
                selectElement.innerHTML = `<option value="">${noOptionsMessage}</option>`;
            } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = translations[currentLanguage].selectExpenseType;
                selectElement.appendChild(defaultOption);

                filteredTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.expense_type;
                    option.textContent = type.expense_type;
                    selectElement.appendChild(option);
                });
            }
        }

        // Sets default date filters: ToDate = current date, FromDate = 1 week ago
        function setDefaultDateFilters() {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            const formatDateTimeLocal = (date) => {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };

            toDateInput.value = formatDateTimeLocal(now);
            fromDateInput.value = formatDateTimeLocal(oneWeekAgo);

            // Set initial filter state
            filterFromDate = oneWeekAgo;
            filterToDate = now;
        }

        // Populates filter dropdowns
        function populateFilterSelectors() {
            // Populate filter-transaction-type (already has default options in HTML)
            // No need to dynamically populate, just ensure translations are applied

            // Populate filter-expense-type-select
            filterExpenseTypeSelect.innerHTML = `<option value="all" data-key="allCategoriesOption">${translations[currentLanguage].allCategoriesOption}</option>`;
            expenseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.expense_type;
                option.textContent = type.expense_type;
                filterExpenseTypeSelect.appendChild(option);
            });
            filterExpenseTypeSelect.value = filterExpenseType; // Restore selected value

            // Populate filter-member-select
            filterMemberSelect.innerHTML = `<option value="all" data-key="allMembersOption">${translations[currentLanguage].allMembersOption}</option>`;
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                filterMemberSelect.appendChild(option);
            });
            filterMemberSelect.value = filterMember; // Restore selected value

            // Apply translations to static options in filter-transaction-type
            document.querySelector('#filter-transaction-type option[value="all"]').textContent = translations[currentLanguage].allTypesOption;
            document.querySelector('#filter-transaction-type option[value="contribution"]').textContent = translations[currentLanguage].contributionOption.replace('💵 ', '');
            document.querySelector('#filter-transaction-type option[value="expense"]').textContent = translations[currentLanguage].expenseOption.replace('🍺 ', '');
            filterTransactionTypeSelect.value = filterType; // Restore selected value
        }


        // Applies all current filters and re-renders the transaction list
        function applyFilters() {
            hideErrorMessage(); // Hide any previous error messages

            // Get filter values from inputs
            filterFromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
            filterToDate = toDateInput.value ? new Date(toDateInput.value) : null;
            filterType = filterTransactionTypeSelect.value;
            filterDescription = filterDescriptionInput.value.trim().toLowerCase();
            filterExpenseType = filterExpenseTypeSelect.value;
            filterMember = filterMemberSelect.value;
            filterAmount = parseFormattedNumber(filterAmountInput.value); // Parse amount for numeric comparison

            let filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);

                // Date filter
                if (filterFromDate && transactionDate < filterFromDate) return false;
                if (filterToDate && transactionDate > filterToDate) return false;

                // Type filter
                if (filterType !== 'all' && t.type !== filterType) return false;

                // Description filter
                if (filterDescription && !t.description.toLowerCase().includes(filterDescription)) return false;

                // Expense Type filter (applies to both contribution and expense)
                if (filterExpenseType !== 'all' && t.expense_type !== filterExpenseType) return false;

                // Member filter
                if (filterMember !== 'all') {
                    if (t.type === 'contribution' && t.contributingMemberId !== filterMember) return false;
                    if (t.type === 'expense' && (!t.involvedMemberIds || !t.involvedMemberIds.includes(filterMember))) return false;
                }

                // Amount filter (exact match for now, could be range if needed)
                // We compare the parsed numeric amount
                if (filterAmount > 0 && Math.round(t.amount) !== Math.round(filterAmount)) return false;


                return true;
            });

            renderTransactionList(filteredTransactions);
        }

        // Resets all filters and re-renders the full transaction list
        function resetFilters() {
            setDefaultDateFilters(); // Reset dates to default
            filterTransactionTypeSelect.value = 'all';
            filterDescriptionInput.value = '';
            filterExpenseTypeSelect.value = 'all';
            filterMemberSelect.value = 'all';
            filterAmountInput.value = '';

            // Reset filter state variables
            filterType = 'all';
            filterDescription = '';
            filterExpenseType = 'all';
            filterMember = 'all';
            filterAmount = '';

            renderTransactionList(); // Render all transactions
            hideErrorMessage();
        }

        // Shows the edit transaction modal
        function showEditTransactionModal(transaction) {
            editingTransaction = transaction; // Store the transaction globally
            editTransactionModal.classList.remove('hidden');
            hideErrorMessage();

            // Populate form fields
            editTransactionTypeSelect.value = transaction.type;
            editAmountInput.value = formatNumberForInput(transaction.amount.toString());
            // Format the date for datetime-local input
            const transactionDate = new Date(transaction.date);
            const year = transactionDate.getFullYear();
            const month = (transactionDate.getMonth() + 1).toString().padStart(2, '0');
            const day = transactionDate.getDate().toString().padStart(2, '0');
            const hours = transactionDate.getHours().toString().padStart(2, '0');
            const minutes = transactionDate.getMinutes().toString().padStart(2, '0');
            editTransactionDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;

            editDescriptionInput.value = transaction.description;
            editLatitudeInput.value = transaction.latitude || '';
            editLongitudeInput.value = transaction.longitude || '';

            // Set initial selection based on transaction type and manage required attributes
            const expenseTypeLabelElement = editExpenseTypeDiv.querySelector('label[data-key="expenseTypeLabel"]'); // Lấy label cho modal sửa

            if (transaction.type === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.removeAttribute('required');
                });
                editMemberSelect.value = transaction.contributingMemberId || '';

                // Hiển thị expense_type cho contribution và đổi nhãn
                editExpenseTypeDiv.classList.remove('hidden');
                editExpenseTypeSelect.setAttribute('required', 'true');
                if (expenseTypeLabelElement) {
                    expenseTypeLabelElement.textContent = "Loại thu"; // Đổi nhãn thành "Loại thu"
                }
                populateExpenseTypeSelect(editExpenseTypeSelect, 'contribution'); // Populate với 'contribution' types
                // Sử dụng transaction.expense_type cho cả contribution và expense
                editExpenseTypeSelect.value = transaction.expense_type || ''; // Set giá trị nếu có


            } else { // Expense
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                // Clear all checkboxes first
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                // Then check the ones involved in this transaction
                if (transaction.involvedMemberIds) {
                    transaction.involvedMemberIds.forEach(id => {
                        const checkbox = editInvolvedMembersCheckboxes.querySelector(`input[value="${id}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Hiển thị expense_type cho expense và đổi nhãn
                editExpenseTypeDiv.classList.remove('hidden');
                editExpenseTypeSelect.setAttribute('required', 'true');
                if (expenseTypeLabelElement) {
                    expenseTypeLabelElement.textContent = translations[currentLanguage].expenseTypeLabel; // Đặt lại nhãn ban đầu
                }
                populateExpenseTypeSelect(editExpenseTypeSelect, 'expense'); // Populate với 'expense' types
                // Sử dụng transaction.expense_type cho cả contribution và expense
                editExpenseTypeSelect.value = transaction.expense_type || ''; // Set giá trị nếu có
            }
        }

        // Toggles visibility and required attributes of contributing/involved member fields in edit modal
        editTransactionTypeSelect.onchange = () => {
            const editExpenseTypeLabelElement = editExpenseTypeDiv.querySelector('label[data-key="expenseTypeLabel"]'); // Lấy phần tử label

            if (editTransactionTypeSelect.value === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.removeAttribute('required');
                });

                // HIỂN THỊ edit-expense_type cho Đóng Góp và đổi nhãn
                editExpenseTypeDiv.classList.remove('hidden');
                editExpenseTypeSelect.setAttribute('required', 'true');
                if (editExpenseTypeLabelElement) {
                    editExpenseTypeLabelElement.textContent = "Loại thu"; // Đổi nhãn thành "Loại thu"
                }
                populateExpenseTypeSelect(editExpenseTypeSelect, 'contribution'); // Truyền 'contribution'
                editExpenseTypeSelect.value = ''; // Thêm dòng này để làm sạch giá trị

            } else { // Expense
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // HIỂN THỊ edit-expense_type cho Chi Tiêu và đổi nhãn
                editExpenseTypeDiv.classList.remove('hidden');
                editExpenseTypeSelect.setAttribute('required', 'true');
                if (editExpenseTypeLabelElement) {
                    expenseTypeLabelElement.textContent = translations[currentLanguage].expenseTypeLabel; // Đặt lại nhãn ban đầu
                }
                populateExpenseTypeSelect(editExpenseTypeSelect, 'expense'); // Truyền 'expense'
                // Ensure expense type is populated if not already, and select a default if available
                if (editExpenseTypeSelect.value === '' && expenseTypes.length > 0) {
                    editExpenseTypeSelect.value = expenseTypes.find(et => et.Type === 'expense')?.expense_type || ''; // Select first expense type or empty
                }
            }
        };

        // Handles saving edited transaction
        editTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!editingTransaction) return;

            const submitButton = e.submitter; // Get the button that triggered the submit
            if (submitButton) {
                submitButton.disabled = true; // Disable the button immediately
                submitButton.textContent = 'Đang lưu...'; // Optional: show loading text
            }

            const type = editTransactionTypeSelect.value;
            const amount = parseFormattedNumber(editAmountInput.value); // Use the new parseFormattedNumber
            const transactionDate = editTransactionDateInput.value; // Get the date from the input
            const description = editDescriptionInput.value.trim();
            const contributingMemberId = editMemberSelect.value;
            const involvedMemberIds = Array.from(editInvolvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);
            const latitude = editLatitudeInput.value ? parseFloat(editLatitudeInput.value) : null;
            const longitude = editLongitudeInput.value ? parseFloat(editLongitudeInput.value) : null;
            const expenseType = editExpenseTypeSelect.value; // New: Get expense type

            if (isNaN(amount) || amount <= 0 || !description || !transactionDate) {
                showErrorMessage(translations[currentLanguage].editInvalidAmountDesc);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }
            if (type === 'contribution' && !contributingMemberId) {
                showErrorMessage(translations[currentLanguage].editSelectContributingMember);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }
            // Validation cho expenseType (dù là đóng góp hay chi tiêu, nếu hiển thị thì required)
            if (editExpenseTypeDiv.classList.contains('hidden') === false && !expenseType) {
                showErrorMessage(translations[currentLanguage].selectExpenseType);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }


            hideErrorMessage();

            try {
                const { data, error } = await supabase
                    .from('transactions_quan') // Updated table name
                    .update({
                        type: type,
                        amount: amount,
                        description: description,
                        date: new Date(transactionDate).toISOString(), // Convert to ISO string for Supabase
                        contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                        involvedMemberIds: type === 'expense' ? involvedMemberIds : [],
                        latitude: latitude,
                        longitude: longitude,
                        expense_type: expenseType, // Always update expenseType
                    })
                    .eq('id', editingTransaction.id);
                if (error) throw error;
                editTransactionModal.classList.add('hidden');
                editingTransaction = null;
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error editing transaction:", error.message);
                showErrorMessage(`${translations[currentLanguage].editTransactionError} ${error.message}`);
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn; // Reset button text
                }
            }
        };

        // Shows confirmation modal for deleting a transaction
        function confirmDeleteTransaction(transaction) {
            transactionToDelete = transaction;
            const message = translations[currentLanguage].confirmDeleteTransaction.replace('{description}', transaction.description);
            confirmationMessage.textContent = message;
            confirmationModal.classList.remove('hidden');
            // Change confirm action to delete transaction
            confirmActionBtn.onclick = deleteTransactionConfirmed;
        }

        // Handles deletion of transaction after confirmation
        async function deleteTransactionConfirmed() {
            if (transactionToDelete) {
                try {
                    const { error } = await supabase
                        .from('transactions_quan') // Updated table name
                        .delete()
                        .eq('id', transactionToDelete.id);
                    if (error) throw error;
                    fetchData(); // Re-fetch data to update UI
                } catch (error) {
                    console.error("Error deleting transaction:", error.message);
                    showErrorMessage(`${translations[currentLanguage].deleteTransactionError} ${error.message}`);
                }
            }
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
            // Reset confirm action to delete transaction (default)
            confirmActionBtn.onclick = deleteTransactionConfirmed; // Keep as default for transactions
        }

        // Cancels deletion (for both member and transaction)
        cancelConfirmationBtn.onclick = () => {
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
            memberToDelete = null;
            // Reset confirm action to delete transaction (default)
            confirmActionBtn.onclick = deleteTransactionConfirmed;
        };

        // --- Member Details Modal ---
        function showMemberDetailsModal(member) {
            selectedMemberForDetails = member;
            memberDetailsModal.classList.remove('hidden');
            hideErrorMessage();

            memberDetailsName.textContent = `${translations[currentLanguage].memberDetailsModalTitle} ${member.name}`;
            memberDetailsBalance.textContent = `${formatNumberForDisplay(member.balance)} ${translations[currentLanguage].unitCurrency}`;
            memberDetailsBalance.classList.remove('text-green-600', 'text-red-600');
            if (member.balance >= 0) {
                memberDetailsBalance.classList.add('text-green-600');
            } else {
                memberDetailsBalance.classList.add('text-red-600');
            }

            const memberTransactions = transactions.filter(t =>
                (t.type === 'contribution' && t.contributingMemberId === member.id) ||
                (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(member.id))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (memberTransactions.length === 0) {
                memberDetailsTransactionsContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noRelatedTransactions}</p>`;
            } else {
                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th>${translations[currentLanguage].dateHeader}</th>
                                <th>${translations[currentLanguage].typeHeader}</th>
                                <th>${translations[currentLanguage].descriptionHeader}</th>
                                <th>${translations[currentLanguage].expenseTypeHeader}</th> <!-- New Column -->
                                <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                memberTransactions.forEach(t => {
                    let displayedAmount = t.amount;
                    // For individual member details, show the per-person share of the expense
                    if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                        displayedAmount = t.amount / t.involvedMemberIds.length;
                    }
                    const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('💵 ', '') : translations[currentLanguage].expenseOption.replace('🍺 ', '');
                    const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';
                    const transactionDate = new Date(t.date).toLocaleDateString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    });

                        tableHtml += `
                            <tr class="table-row">
                                <td>${transactionDate}</td>
                                <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                                <td>${t.description}</td>
                                <td>${t.type === 'expense' && t.expense_type ? t.expense_type : 'N/A'}</td> <!-- Display expense type -->
                                <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    memberDetailsTransactionsContainer.innerHTML = tableHtml;
                }
            }

            // --- Gemini API Integration (via Supabase Edge Functions) ---

            // Simple Markdown to HTML converter
            function markdownToHtml(markdown) {
                let html = markdown;

                // Convert headings (e.g., ## Heading) to <h2>
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

                // Convert bold (e.g., **text**) to <strong>
                html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
                // Convert italics (e.g., *text*) to <em>
                html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');

                // Convert unordered lists (e.g., - item) to <ul> and <li>
                html = html.replace(/^\s*\-\s(.*)$/gim, '<li>$1</li>');
                html = html.replace(/^(<li>.*<\/li>(\n<li>.*<\/li>)*)/gim, '<ul>$1</ul>');

                // Convert ordered lists (e.g., 1. item) to <ol> and <li>
                html = html.replace(/^\s*\d+\.\s(.*)$/gim, '<li>$1</li>');
                html = html.replace(/^(<li>.*<\/li>(\n<li>.*<\/li>)*)/gim, '<ol>$1</ol>');


                // Convert newlines to paragraphs, but only if not already part of a block element
                html = html.split('\n').map(line => {
                    if (line.trim() === '' || line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<ol') || line.startsWith('<li>')) {
                        return line;
                    }
                    return `<p class="mb-2 text-gray-700">${line}</p>`;
                }).join('');

                // Clean up empty paragraphs that might be created by the above logic
                html = html.replace(/<p class="mb-2 text-gray-700"><\/p>/g, '');

                return html;
            }

            // NEW: Function to call a Supabase Edge Function
            async function callSupabaseEdgeFunction(functionName, dataPayload) {
                try {
                    const session = await supabase.auth.getSession();
                    let accessToken = session?.data?.session?.access_token;
                    const clientTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                    if (!accessToken) {
                        // Attempt anonymous sign-in if no session. This might fail if RLS requires authenticated users.
                        const { data, error } = await supabase.auth.signInAnonymously();
                        if (error) {
                            throw new Error(`Anonymous sign-in failed: ${error.message}`);
                        }
                        // If anonymous sign-in is successful, retrieve the new session
                        const newSession = await supabase.auth.getSession();
                        if (!newSession?.data?.session?.access_token) {
                            throw new Error("Could not obtain access token after anonymous sign-in.");
                        }
                        accessToken = newSession.data.session.access_token;
                    }

                    const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/${functionName}`;

                    const response = await fetch(edgeFunctionUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            activities: dataPayload, // Pass our custom payload as 'activities'
                            clientTimezone: clientTimezone // Pass timezone for context
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Edge Function error: ${errorData.error || response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`Error calling Supabase Edge Function ${functionName}:`, error);
                    throw error; // Re-throw to be handled by calling functions
                }
            }

            // Call Gemini Vision API (now via single Supabase Edge Function 'process-ai-requests')
            async function callGeminiVisionAPI(base64ImageData) {
                cameraLoadingSpinner.classList.remove('hidden');
                // Hiển thị thông báo đang xử lý trên input mô tả
                // Note: descriptionInput is not available in this file, so this part needs to be removed or adapted
                // descriptionInput.value = translations[currentLanguage].generatingInsights;
                // aiDescribeBtn.disabled = true; // aiDescribeBtn is not available here

                const payload = {
                    type: 'image_description', // Loại hoạt động cho Edge Function
                    image: base64ImageData,
                    currentLanguage: currentLanguage, // Truyền ngôn ngữ để Edge Function sử dụng prompt đúng
                };

                try {
                    // Gọi hàm Edge Function chung: process-ai-requests
                    const result = await callSupabaseEdgeFunction('process-ai-requests_quan', payload);

                    if (result.success && result.analysis) {
                        const parsedAnalysis = result.analysis;
                        console.log("Phản hồi AI đã được phân tích:", parsedAnalysis);

                        // Since descriptionInput and amountInput are not directly available here,
                        // we can't populate them directly. This part of the logic might need to be
                        // re-evaluated if this file is meant to handle transaction *creation* with AI.
                        // For now, I'll assume this function is called from the main app and passes data back.
                        // Or, if this file is *only* for viewing/editing existing transactions, this function
                        // might not be needed here at all.
                        // For demonstration, I'll log the parsed data.
                        console.log("AI Description:", parsedAnalysis.description);
                        console.log("AI Amount:", parsedAnalysis.amount);
                        console.log("AI Transaction Type:", parsedAnalysis.transactionType);
                        console.log("AI Category:", parsedAnalysis.category);
                        console.log("AI Date:", parsedAnalysis.date);
                        console.log("AI Location:", parsedAnalysis.location);

                        // If this function is meant to populate the *edit* modal's fields:
                        editDescriptionInput.value = parsedAnalysis.description || '';
                        editAmountInput.value = parsedAnalysis.amount ? formatNumberForInput(parsedAnalysis.amount) : '';

                        if (parsedAnalysis.transactionType) {
                            editTransactionTypeSelect.value = parsedAnalysis.transactionType;
                            editTransactionTypeSelect.dispatchEvent(new Event('change'));
                        } else {
                            editTransactionTypeSelect.value = 'expense';
                            editTransactionTypeSelect.dispatchEvent(new Event('change'));
                        }

                        if (parsedAnalysis.category && expenseTypes.some(et => et.expense_type === parsedAnalysis.category)) {
                            editExpenseTypeSelect.value = parsedAnalysis.category;
                        } else {
                            const otherOption = expenseTypes.find(et => et.expense_type === translations[currentLanguage].otherCategory);
                            if (otherOption) {
                                editExpenseTypeSelect.value = otherOption.expense_type;
                            } else {
                                editExpenseTypeSelect.value = '';
                            }
                        }

                        if (parsedAnalysis.date) {
                            try {
                                const dateObj = new Date(parsedAnalysis.date);
                                if (!isNaN(dateObj.getTime())) {
                                    const year = dateObj.getFullYear();
                                    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                                    const day = dateObj.getDate().toString().padStart(2, '0');
                                    const hours = dateObj.getHours().toString().padStart(2, '0');
                                    const minutes = dateObj.getMinutes().toString().padStart(2, '0');
                                    editTransactionDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                                } else {
                                    console.warn("Ngày từ AI không hợp lệ:", parsedAnalysis.date);
                                    setDefaultCurrentDateTime(editTransactionDateInput);
                                }
                            } catch (e) {
                                console.error("Lỗi khi phân tích ngày từ AI:", e);
                                setDefaultCurrentDateTime(editTransactionDateInput);
                            }
                        } else {
                            setDefaultCurrentDateTime(editTransactionDateInput);
                        }

                    } else {
                        // If AI description fails, set a default message in the edit description input
                        editDescriptionInput.value = translations[currentLanguage].noImageDescription;
                        editAmountInput.value = '';
                        editTransactionTypeSelect.value = 'expense';
                        editTransactionTypeSelect.dispatchEvent(new Event('change'));
                        setDefaultCurrentDateTime(editTransactionDateInput);
                        editExpenseTypeSelect.value = '';
                        showErrorMessage(result.error || translations[currentLanguage].noImageDescription);
                    }
                } catch (error) {
                    console.error("Lỗi khi gọi Gemini Vision API qua Edge Function:", error);
                    showErrorMessage(`${translations[currentLanguage].aiCallError} ${error.message}`);
                    editDescriptionInput.value = translations[currentLanguage].noImageDescription;
                    editAmountInput.value = '';
                    editTransactionTypeSelect.value = 'expense';
                    editTransactionTypeSelect.dispatchEvent(new Event('change'));
                    setDefaultCurrentDateTime(editTransactionDateInput);
                    editExpenseTypeSelect.value = '';
                } finally {
                    cameraLoadingSpinner.classList.add('hidden');
                    // aiDescribeBtn.disabled = false; // aiDescribeBtn is not available here
                    cameraModal.classList.add('hidden');
                }
            }


            // Hàm tiện ích để đặt ngày giờ hiện tại
            function setDefaultCurrentDateTime(inputElement) {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                inputElement.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // --- Event Listeners ---

            // Edit Transaction Modal buttons
            cancelEditTransactionBtn.onclick = () => { editTransactionModal.classList.add('hidden'); editingTransaction = null; };

            // Member Details Modal buttons
            closeMemberDetailsBtn.onclick = () => { memberDetailsModal.classList.add('hidden'); selectedMemberForDetails = null; };

            // Image/Camera Upload
            // The AI describe button should be in QuycomQuan.html to trigger the camera modal
            // This event listener will be triggered if the camera modal is opened from QuycomQuan.html
            imageUploadInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadstart = () => {
                        cameraLoadingSpinner.classList.remove('hidden');
                        uploadedImagePreview.classList.add('hidden');
                    };
                    reader.onloadend = () => {
                        uploadedImagePreview.src = reader.result;
                        uploadedImagePreview.classList.remove('hidden');
                        // Extract base64 part for API call
                        const base64Data = reader.result.split(',')[1];
                        callGeminiVisionAPI(base64Data);
                    };
                    reader.onerror = (error) => {
                        console.error("Error reading file:", error);
                        showErrorMessage("Lỗi đọc file hình ảnh.");
                        cameraLoadingSpinner.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            };
            cancelCameraBtn.onclick = () => {
                cameraModal.classList.add('hidden');
                cameraLoadingSpinner.classList.add('hidden');
                imageUploadInput.value = '';
            };


            // Input formatting for amount fields
            editAmountInput.oninput = (e) => {
                const originalCursorPos = e.target.selectionStart;
                const originalLength = e.target.value.length;

                let cleanedValue = e.target.value.replace(/[^0-9]/g, ''); // Remove non-digits
                if (cleanedValue.startsWith('0') && cleanedValue.length > 1) { // Remove leading zero if not single '0'
                    cleanedValue = parseInt(cleanedValue, 10).toString();
                }
                if (cleanedValue === '') {
                    e.target.value = '';
                    return;
                }
                const formattedValue = formatNumberForInput(cleanedValue);
                e.target.value = formattedValue;

                // Adjust cursor position
                const newLength = formattedValue.length;
                const diff = newLength - originalLength;
                e.target.setSelectionRange(originalCursorPos + diff, originalCursorPos + diff);
            };

            // Filter buttons
            searchBtn.onclick = applyFilters;
            resetFilterBtn.onclick = resetFilters;

            // Input formatting for filter amount field
            filterAmountInput.oninput = (e) => {
                const originalCursorPos = e.target.selectionStart;
                const originalLength = e.target.value.length;

                let cleanedValue = e.target.value.replace(/[^0-9]/g, ''); // Remove non-digits
                if (cleanedValue.startsWith('0') && cleanedValue.length > 1) { // Remove leading zero if not single '0'
                    cleanedValue = parseInt(cleanedValue, 10).toString();
                }
                if (cleanedValue === '') {
                    e.target.value = '';
                    return;
                }
                const formattedValue = formatNumberForInput(cleanedValue);
                e.target.value = formattedValue;

                // Adjust cursor position
                const newLength = formattedValue.length;
                const diff = newLength - originalLength;
                e.target.setSelectionRange(originalCursorPos + diff, originalCursorPos + diff);
            };

            // --- Scroll to Top Button Logic ---
            window.onscroll = function() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollToTopBtn.classList.add('show');
                } else {
                    scrollToTopBtn.classList.remove('show');
                }
            };

            scrollToTopBtn.onclick = function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };


            // Initial data fetch and UI render when DOM is fully loaded
            document.addEventListener('DOMContentLoaded', () => {
                setLanguage(currentLanguage); // Set initial language
                initializeSupabase(); // Initialize Supabase and check auth
                setDefaultDateFilters(); // Set default dates for filters
            });
        </script>
        <script>
            // When the hamburger button is clicked, toggle the menu
            document.getElementById('hamburger-btn').addEventListener('click', function() {
                const menu = document.getElementById('hamburger-menu');
                console.log('Hamburger button clicked!');
                console.log('Menu before toggle:', menu.classList.contains('hidden') ? 'hidden' : 'visible');
                menu.classList.toggle('hidden');
                console.log('Menu after toggle:', menu.classList.contains('hidden') ? 'hidden' : 'visible');
            });
        </script>

</body>
</html>
