<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #006B68;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #005654; }
        .btn-secondary {
            background-color: #F3F4F6;
            color: #1F2937;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover { background-color: #E5E7EB; }
        .table-header { background-color: #F9FAFB; }
        .table-cell { padding: 1rem; border-bottom: 1px solid #E5E7EB; }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .scroll-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3rem;
            height: 3rem;
            background-color: #006B68;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(20px);
            z-index: 1000;
        }
        .scroll-to-top.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        #hamburger-menu {
            transition: all 0.3s ease-in-out;
            transform-origin: top right;
        }
        .table-auto { table-layout: auto; width: 100%; }
        .table-fixed { table-layout: fixed; width: 100%; }
        .truncate { overflow: hidden; text-overflow: ellipsis; }
        @media (max-width: 768px) {
            .table-cell { word-break: break-all; }
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative;
            z-index: 50;
        }
        #hamburger-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        #hamburger-btn:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu {
            position: absolute;
            top: 100%;
            left: 1rem;
            margin-top: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 12rem;
            overflow: hidden;
            z-index: 60;
        }
        #hamburger-menu a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #374151;
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .language-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #E0E7FF;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .language-switch button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #006B68;
        }
        .language-switch button.active {
            background-color: #006B68;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* New custom legend styles */
        .custom-legend li {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem; /* text-sm */
        }
        .custom-legend .color-box {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            border-radius: 0.25rem;
        }
        /* Chart container to manage multiple charts */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 1024px) {
            .chart-container {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Header -->
    <div class="navbar flex items-center">
        <!-- Hamburger button on the left -->
        <button id="hamburger-btn" aria-label="Mở menu" class="md:hidden">
            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Hidden menu for mobile when not active -->
        <div id="hamburger-menu" class="hidden md:hidden">
            <a href="QuycomQuan.html">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                <span data-key="navDashboard">Trang chủ</span>
            </a>
            <a href="QuycomReportQuan.html">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd"></path></svg>
                <span data-key="navReport">Báo cáo</span>
            </a>
            <a href="#" id="logout-btn-mobile">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h8a1 1 0 011 1v1a1 1 0 11-2 0V4H4v12h7v-1a1 1 0 112 0v1a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm13 8a1 1 0 110 2h-5a1 1 0 110-2h5z" clip-rule="evenodd"></path></svg>
                <span data-key="navLogout">Đăng xuất</span>
            </a>
        </div>

        <!-- Logo and Title -->
        <div class="flex items-center ml-4 flex-grow">
            <img src="LogoQuy.png" alt="Logo Quản Lý Quỹ Nhóm" class="h-12 w-auto rounded-lg shadow-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/006B68/FFFFFF?text=Logo';">
            <h1 class="text-2xl font-bold text-[#006B68]" data-key="appName">QUẢN LÝ QUỸ NHÓM</h1>
        </div>
        <!-- Desktop Nav and Language Switcher -->
        <div class="hidden md:flex items-center gap-4">
            <a href="QuycomQuan.html" class="text-gray-700 hover:text-gray-900 font-semibold" data-key="navDashboard">Trang chủ</a>
            <a href="QuycomReportQuan.html" class="text-gray-700 hover:text-gray-900 font-semibold" data-key="navReport">Báo cáo</a>
            <button id="logout-btn" class="flex items-center gap-2 text-gray-700 hover:text-gray-900 font-semibold" data-key="navLogout">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h8a1 1 0 011 1v1a1 1 0 11-2 0V4H4v12h7v-1a1 1 0 112 0v1a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm13 8a1 1 0 110 2h-5a1 1 0 110-2h5z" clip-rule="evenodd"></path></svg>
                <span class="hidden md:inline">Đăng xuất</span>
            </button>
            <div class="language-switch">
                <button id="lang-vi-btn" data-lang="vi" class="active">VI</button>
                <button id="lang-en-btn" data-lang="en">EN</button>
            </div>
        </div>
    </div>
    <main class="container mx-auto p-4 mt-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-6" data-key="reportTitle">Lịch Sử Giao Dịch</h2>
        <!-- Filters and Actions Section -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- Start Date Filter -->
                <div>
                    <label for="start-date-filter" class="block text-sm font-medium text-gray-700" data-key="filterStartDate">Từ ngày</label>
                    <input type="date" id="start-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <!-- End Date Filter -->
                <div>
                    <label for="end-date-filter" class="block text-sm font-medium text-gray-700" data-key="filterEndDate">Đến ngày</label>
                    <input type="date" id="end-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <!-- Member Filter -->
                <div>
                    <label for="member-filter" class="block text-sm font-medium text-gray-700" data-key="filterMember">Người giao dịch</label>
                    <select id="member-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="all" data-key="allMembers">Tất cả</option>
                    </select>
                </div>
                <!-- Expense Type Filter -->
                <div>
                    <label for="expense-type-filter" class="block text-sm font-medium text-gray-700" data-key="filterType">Loại giao dịch</label>
                    <select id="expense-type-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="all" data-key="allTypes">Tất cả</option>
                    </select>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mt-4">
                <button id="apply-filter-btn" class="btn-primary flex-1" data-key="filterApply">Áp dụng</button>
                <button id="clear-filter-btn" class="btn-secondary flex-1" data-key="filterClear">Xóa bộ lọc</button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="export-excel-btn" class="btn-primary flex items-center gap-2" data-key="exportExcel">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 2a1 1 0 011 1v6h6a1 1 0 110 2h-6v6a1 1 0 11-2 0v-6H3a1 1 0 110-2h6V3a1 1 0 011-1z" clip-rule="evenodd" fill-rule="evenodd"></path>
                    </svg>
                    Xuất Excel
                </button>
            </div>
        </div>

        <!-- Transaction Table Section -->
        <div id="transaction-section" class="bg-white rounded-xl shadow overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900" data-key="transactionHistory">Lịch Sử Giao Dịch</h3>
                <span id="transaction-count" class="text-gray-500 text-sm font-medium"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDate">Ngày</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDescription">Mô tả</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableMember">Người giao dịch</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableType">Loại</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableAmount">Số tiền</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableActions">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Transaction rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls -->
            <div class="px-6 py-4 flex items-center justify-between border-t border-gray-200">
                <button id="prev-page-btn" class="btn-secondary" data-key="paginationPrevious">Trước</button>
                <span id="page-info" class="text-sm text-gray-700"></span>
                <button id="next-page-btn" class="btn-secondary" data-key="paginationNext">Sau</button>
            </div>
        </div>

        <!-- Modal for Edit and Delete (unchanged) -->
        <!-- ... (Modal content) ... -->
        
    </main>

    <!-- Scroll to Top Button (unchanged) -->
    <button id="scroll-to-top-btn" class="scroll-to-top">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </button>
    

    <script>
        // Các đoạn code xử lý đa ngôn ngữ, Supabase, và các hàm khác vẫn giữ nguyên
        // Khởi tạo các phần tử DOM
        const elements = {
            // ... (các phần tử đã có) ...
            transactionTableBody: document.getElementById('transaction-table-body'),
            applyFilterBtn: document.getElementById('apply-filter-btn'),
            clearFilterBtn: document.getElementById('clear-filter-btn'),
            startDateFilter: document.getElementById('start-date-filter'),
            endDateFilter: document.getElementById('end-date-filter'),
            memberFilter: document.getElementById('member-filter'),
            expenseTypeFilter: document.getElementById('expense-type-filter'),
            transactionCountSpan: document.getElementById('transaction-count'),
            prevPageBtn: document.getElementById('prev-page-btn'),
            nextPageBtn: document.getElementById('next-page-btn'),
            pageInfoSpan: document.getElementById('page-info'),
            exportExcelBtn: document.getElementById('export-excel-btn'),
            scrollToTopBtn: document.getElementById('scroll-to-top-btn'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            hamburgerMenu: document.getElementById('hamburger-menu'),
            // ... (thêm các phần tử cần thiết) ...
        };

        // --- Dữ liệu tĩnh được mô phỏng từ file data.txt ---
        const members = [
            {"id":"d9d6d93a-2cce-4f67-9695-2207c85325d3","name":"Trương Hồng Quân","balance":0},
            {"id":"47d7bf16-48bf-42f5-91ca-cd72317a249e","name":"Trương Tuyết Vân","balance":0},
            {"id":"3f03b9ca-b4db-4a3b-9091-97518c6f5c11","name":"Trương Khánh Linh","balance":0},
            {"id":"956b61ad-c4b6-4f13-b565-cc50071e89ac","name":"Nguyễn Thị Hương Lê","balance":0}
        ];

        const expenseTypes = [
            {"id":"Tiền đi chợ", "expense_type": "Tiền đi chợ", "Type": "expense"},
            {"id":"Nhà hàng, quán ăn", "expense_type": "Nhà hàng, quán ăn", "Type": "expense"},
            {"id":"Cafe", "expense_type": "Cafe", "Type": "expense"},
            {"id":"Tiền điện, nước, gas", "expense_type": "Tiền điện, nước, gas", "Type": "expense"},
            {"id":"Internet, điện thoại, truyền hình", "expense_type": "Internet, điện thoại, truyền hình", "Type": "expense"},
            {"id":"Phí dịch vụ nhà", "expense_type": "Phí dịch vụ nhà", "Type": "expense"},
            {"id":"Trang trí, nội thất", "expense_type": "Trang trí, nội thất", "Type": "expense"},
            {"id":"Đồ gia dụng", "expense_type": "Đồ gia dụng", "Type": "expense"},
            {"id":"Đồ điện tử", "expense_type": "Đồ điện tử", "Type": "expense"},
            {"id":"Xăng xe, vé xe", "expense_type": "Xăng xe, vé xe", "Type": "expense"},
            {"id":"Bảo trì, sửa xe", "expense_type": "Bảo trì, sửa xe", "Type": "expense"},
            {"id":"Phí cầu đường, gửi xe", "expense_type": "Phí cầu đường, gửi xe", "Type": "expense"},
            {"id":"Học phí", "expense_type": "Học phí", "Type": "expense"},
            {"id":"Linh", "expense_type": "Linh", "Type": "expense"},
            {"id":"Vân", "expense_type": "Vân", "Type": "expense"},
            {"id":"Quần áo, giày dép", "expense_type": "Quần áo, giày dép", "Type": "expense"},
            {"id":"Mỹ phẩm, làm tóc", "expense_type": "Mỹ phẩm, làm tóc", "Type": "expense"},
            {"id":"Khám chữa bệnh", "expense_type": "Khám chữa bệnh", "Type": "expense"},
            {"id":"Du lịch, dã ngoại", "expense_type": "Du lịch, dã ngoại", "Type": "expense"},
            {"id":"Mừng cưới, ma chay", "expense_type": "Mừng cưới, ma chay", "Type": "expense"},
            {"id":"Đóng góp từ thiện", "expense_type": "Đóng góp từ thiện", "Type": "expense"},
            {"id":"Phí dịch vụ ngân hàng", "expense_type": "Phí dịch vụ ngân hàng", "Type": "expense"},
            {"id":"Trả nợ gốc lãi vay, phí", "expense_type": "Trả nợ gốc lãi vay, phí", "Type": "expense"},
            {"id":"Chi phí phát sinh khác", "expense_type": "Chi phí phát sinh khác", "Type": "expense"},
            {"id":"Lương", "expense_type": "Lương", "Type": "contribution"},
            {"id":"Thưởng", "expense_type": "Thưởng", "Type": "contribution"},
            {"id":"Thu nhập từ kinh doanh", "expense_type": "Thu nhập từ kinh doanh", "Type": "contribution"},
            {"id":"Lãi tiết kiệm", "expense_type": "Lãi tiết kiệm", "Type": "contribution"},
            {"id":"Cổ tức, trái phiếu", "expense_type": "Cổ tức, trái phiếu", "Type": "contribution"},
            {"id":"Thu nhập từ cho thuê", "expense_type": "Thu nhập từ cho thuê", "Type": "contribution"}
        ];

        let transactions = [
            {"id":"4f94c15a-0ed9-498c-b992-9e458b6c6a3c","type":"expense","amount":467600,"description":"Giao dịch mua hàng tại WinMart+, thanh toán bằng BIDV Visa Cashback 360","date":"2025-07-15T14:26:00.000Z","contributingMemberId":null,"involvedMemberIds":["d9d6d93a-2cce-4f67-9695-2207c85325d3"],"latitude":null,"longitude":null,"expense_type":"Tiền đi chợ"},
            {"id":"095dd0fc-ddcf-434d-a446-f54d07d2e7bd","type":"expense","amount":416000,"description":"Chi phí bữa ăn tại Phiếu Tạm Tính, bao gồm các món: bắp bò xào mỳ, đùi ếch xào măng, trúc size M (8 đùi), cháo ếch size M (2 ếch), trà sâm dứa.","date":"2025-07-25T14:18:00.000Z","contributingMemberId":null,"involvedMemberIds":["d9d6d93a-2cce-4f67-9695-2207c85325d3"],"latitude":null,"longitude":null,"expense_type":"Nhà hàng, quán ăn"},
            {"id":"0ccd7559-18a9-49df-9d46-29795f613d8d","type":"expense","amount":360000,"description":"Mua các sản phẩm tại cửa hàng MUJI Vincom Times City, bao gồm túi mua sắm, kẹo xốp Marshmallows, bộ số 5 cuốn 36 tờ 6mm - B, bánh xốp vị sô cô la đậu phộng, súp miso rong biển, mì mầm lúa mạch organic ANP, mì sâm cát organic ANPASO - G","date":"2025-07-27T13:32:00.000Z","contributingMemberId":null,"involvedMemberIds":["d9d6d93a-2cce-4f67-9695-2207c85325d3"],"latitude":null,"longitude":null,"expense_type":"Nhà hàng, quán ăn"},
            {"id":"d58b81df-fa7c-4d1f-8c10-0a6f35bfe02f","type":"expense","amount":621000,"description":"Hóa đơn mua hàng tại MRDIY Vincom Mega Mall Times City, bao gồm dây buộc cáp, giá đỡ góc, cáp USB, kệ để đồ bồn rửa, giá treo bàn chải hút chân không","date":"2025-07-27T13:51:00.000Z","contributingMemberId":null,"involvedMemberIds":["d9d6d93a-2cce-4f67-9695-2207c85325d3"],"latitude":null,"longitude":null,"expense_type":"Trang trí, nội thất"},
            {"id":"0d2c6068-0033-48cf-afc9-444a9e0f99f5","type":"expense","amount":3574000,"description":"Mua sắm các sản phẩm tại MUJI Vincom Times City, bao gồm túi mua sắm, kéo tỉa lông, gương trang điểm, tất, túi chống thấm, bàn chải sàn nhà tắm, bộ dầu thơm nội thất, đồng hồ điện tử, móc đôi nhôm hít chân không, và nhiều loại tất khác.","date":"2025-07-27T13:08:00.000Z","contributingMemberId":null,"involvedMemberIds":["d9d6d93a-2cce-4f67-9695-2207c85325d3"],"latitude":null,"longitude":null,"expense_type":"Đồ gia dụng"},
        ];
        
        // Cần đảm bảo rằng các hàm này đã được định nghĩa ở nơi khác trong code gốc
        // Đây là các biến và hàm cần thiết để hoạt động, có thể đã tồn tại trong file gốc
        let currentPage = 1;
        const transactionsPerPage = 10;
        let filteredTransactions = transactions;

        const localization = {
            vi: {
                // ... (dữ liệu localization tiếng Việt) ...
            },
            en: {
                // ... (dữ liệu localization tiếng Anh) ...
            }
        };
        let currentLanguage = 'vi';
        const translations = localization[currentLanguage];

        // --- Các hàm mới/cập nhật để hiển thị dữ liệu ---

        /**
         * Lấy tên thành viên từ ID.
         * @param {string[]} memberIds - Mảng các ID thành viên.
         * @returns {string} - Chuỗi tên thành viên, hoặc 'Không xác định' nếu không tìm thấy.
         */
        function getMemberNames(memberIds) {
            if (!memberIds || memberIds.length === 0) {
                return translations.unassigned || 'Không xác định';
            }
            const names = memberIds.map(id => {
                const member = members.find(m => m.id === id);
                return member ? member.name : translations.unknownMember || 'Thành viên không xác định';
            });
            return names.join(', ');
        }

        /**
         * Lấy tên loại giao dịch từ ID.
         * @param {string} expenseType - ID của loại giao dịch.
         * @returns {string} - Tên loại giao dịch, hoặc 'Không xác định' nếu không tìm thấy.
         */
        function getExpenseTypeName(expenseType) {
            const type = expenseTypes.find(t => t.id === expenseType);
            return type ? type.expense_type : translations.unknownType || 'Loại không xác định';
        }

        /**
         * Định dạng số tiền thành chuỗi tiền tệ.
         * @param {number} amount - Số tiền.
         * @returns {string} - Chuỗi tiền tệ đã định dạng.
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        /**
         * Hiển thị bảng giao dịch dựa trên dữ liệu.
         * @param {Array} data - Mảng các đối tượng giao dịch.
         */
        function renderTransactions(data) {
            elements.transactionTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            if (paginatedData.length === 0) {
                elements.transactionTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500" data-key="noTransactions">Không có giao dịch nào</td></tr>`;
            } else {
                paginatedData.forEach(transaction => {
                    const memberName = getMemberNames(transaction.involvedMemberIds);
                    const expenseTypeName = getExpenseTypeName(transaction.expense_type);
                    const formattedDate = new Date(transaction.date).toLocaleDateString('vi-VN');
                    const formattedAmount = formatCurrency(transaction.amount);

                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="table-cell">${formattedDate}</td>
                            <td class="table-cell truncate max-w-xs">${transaction.description}</td>
                            <td class="table-cell">${memberName}</td>
                            <td class="table-cell">${expenseTypeName}</td>
                            <td class="table-cell font-medium text-right">${formattedAmount}</td>
                            <td class="table-cell text-right">
                                <button class="text-blue-600 hover:text-blue-900 mx-1 edit-btn" data-id="${transaction.id}">Sửa</button>
                                <button class="text-red-600 hover:text-red-900 mx-1 delete-btn" data-id="${transaction.id}">Xóa</button>
                            </td>
                        </tr>
                    `;
                    elements.transactionTableBody.innerHTML += row;
                });
            }

            elements.transactionCountSpan.textContent = `(${data.length} giao dịch)`;
            updatePaginationControls(data.length);
        }

        /**
         * Cập nhật bộ điều khiển phân trang.
         * @param {number} totalTransactions - Tổng số giao dịch.
         */
        function updatePaginationControls(totalTransactions) {
            const totalPages = Math.ceil(totalTransactions / transactionsPerPage);
            elements.pageInfoSpan.textContent = `${translations.page} ${currentPage} ${translations.of} ${totalPages}`;
            elements.prevPageBtn.disabled = currentPage === 1;
            elements.nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

            if (elements.prevPageBtn.disabled) {
                elements.prevPageBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                elements.prevPageBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            if (elements.nextPageBtn.disabled) {
                elements.nextPageBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                elements.nextPageBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Lọc các giao dịch dựa trên bộ lọc.
         */
        function applyFilters() {
            const startDate = elements.startDateFilter.value ? new Date(elements.startDateFilter.value) : null;
            const endDate = elements.endDateFilter.value ? new Date(elements.endDateFilter.value) : null;
            const memberId = elements.memberFilter.value;
            const expenseType = elements.expenseTypeFilter.value;

            filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const memberMatch = memberId === 'all' || (t.involvedMemberIds && t.involvedMemberIds.includes(memberId)) || (t.contributingMemberId && t.contributingMemberId === memberId);
                const typeMatch = expenseType === 'all' || t.expense_type === expenseType;
                const dateMatch = (!startDate || transactionDate >= startDate) && (!endDate || transactionDate <= endDate);
                return memberMatch && typeMatch && dateMatch;
            });
            currentPage = 1;
            renderTransactions(filteredTransactions);
        }

        // --- Event Listeners ---
        elements.applyFilterBtn.addEventListener('click', applyFilters);
        elements.clearFilterBtn.addEventListener('click', () => {
            elements.startDateFilter.value = '';
            elements.endDateFilter.value = '';
            elements.memberFilter.value = 'all';
            elements.expenseTypeFilter.value = 'all';
            filteredTransactions = transactions;
            currentPage = 1;
            renderTransactions(filteredTransactions);
        });

        elements.prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTransactions(filteredTransactions);
            }
        });

        elements.nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTransactions(filteredTransactions);
            }
        });

        // Event listener cho nút hamburger
        elements.hamburgerBtn.addEventListener('click', () => {
            elements.hamburgerMenu.classList.toggle('hidden');
        });

        // Initialize function to populate filters and render initial data
        function initializePage() {
            // Populate member filter
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                elements.memberFilter.appendChild(option);
            });

            // Populate expense type filter
            expenseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.expense_type;
                elements.expenseTypeFilter.appendChild(option);
            });

            renderTransactions(transactions);
        }
        
        // Gọi hàm khởi tạo khi DOM đã tải xong
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
