<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #006B68;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #005654; }
        .btn-secondary {
            background-color: #F3F4F6;
            color: #1F2937;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover { background-color: #E5E7EB; }
        .table-header { background-color: #F9FAFB; }
        .table-cell { padding: 1rem; border-bottom: 1px solid #E5E7EB; }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .scroll-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3rem;
            height: 3rem;
            background-color: #006B68;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(20px);
            z-index: 1000;
        }
        .scroll-to-top.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        #hamburger-menu {
            transition: all 0.3s ease-in-out;
            transform-origin: top right;
        }
        .table-auto { table-layout: auto; width: 100%; }
        .table-fixed { table-layout: fixed; width: 100%; }
        .truncate { overflow: hidden; text-overflow: ellipsis; }
        @media (max-width: 768px) {
            .table-cell { word-break: break-all; }
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative;
            z-index: 50;
        }
        #hamburger-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        #hamburger-btn:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu {
            position: absolute;
            top: 100%;
            left: 1rem;
            margin-top: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 12rem;
            overflow: hidden;
            z-index: 60;
        }
        #hamburger-menu a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #374151;
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .language-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #E0E7FF;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .language-switch button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #006B68;
        }
        .language-switch button.active {
            background-color: #006B68;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .custom-legend li {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .custom-legend .color-box {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            border-radius: 0.25rem;
        }
        .chart-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 1024px) {
            .chart-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #006B68;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="navbar flex items-center">
        <!-- Hamburger button on the left -->
        <button id="hamburger-btn" aria-label="Mở menu" class="md:hidden">
            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Hidden menu for mobile when not active -->
        <div id="hamburger-menu" class="hidden md:hidden">
            <a href="QuycomQuan.html">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                <span data-key="navDashboard">Trang chủ</span>
            </a>
            <a href="QuycomReportQuan.html">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd"></path></svg>
                <span data-key="navReport">Báo cáo</span>
            </a>
            <a href="#" id="logout-btn-mobile" data-key="navLogout">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h8a1 1 0 011 1v1a1 1 0 11-2 0V4H4v12h7v-1a1 1 0 112 0v1a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm13 8a1 1 0 110 2h-5a1 1 0 110-2h5z" clip-rule="evenodd"></path></svg>
                <span>Đăng xuất</span>
            </a>
        </div>

        <!-- Logo and Title -->
        <div class="flex items-center ml-4 flex-grow">
            <img src="LogoQuy.png" alt="Logo Quản Lý Quỹ Nhóm" class="h-12 w-auto rounded-lg shadow-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/006B68/FFFFFF?text=Logo';">
            <h1 class="text-2xl font-bold text-[#006B68]" data-key="appName">QUẢN LÝ QUỸ NHÓM</h1>
        </div>
        <!-- Desktop Nav and Language Switcher -->
        <div class="hidden md:flex items-center gap-4">
            <a href="QuycomQuan.html" class="text-gray-700 hover:text-gray-900 font-semibold" data-key="navDashboard">Trang chủ</a>
            <a href="QuycomReportQuan.html" class="text-gray-700 hover:text-gray-900 font-semibold" data-key="navReport">Báo cáo</a>
            <button id="logout-btn" class="flex items-center gap-2 text-gray-700 hover:text-gray-900 font-semibold" data-key="navLogout">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h8a1 1 0 011 1v1a1 1 0 11-2 0V4H4v12h7v-1a1 1 0 112 0v1a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm13 8a1 1 0 110 2h-5a1 1 0 110-2h5z" clip-rule="evenodd"></path></svg>
                <span class="hidden md:inline" data-key="navLogout">Đăng xuất</span>
            </button>
            <div class="language-switch">
                <button id="lang-vi-btn" data-lang="vi" class="active">VI</button>
                <button id="lang-en-btn" data-lang="en">EN</button>
            </div>
        </div>
    </div>
    <main class="container mx-auto p-4 mt-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-6" data-key="reportTitle">Lịch Sử Giao Dịch</h2>
        <!-- Filters and Actions Section -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                <!-- Start Date Filter -->
                <div>
                    <label for="start-date-filter" class="block text-sm font-medium text-gray-700" data-key="filterStartDate">Từ ngày</label>
                    <input type="date" id="start-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <!-- End Date Filter -->
                <div>
                    <label for="end-date-filter" class="block text-sm font-medium text-gray-700" data-key="filterEndDate">Đến ngày</label>
                    <input type="date" id="end-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <!-- Member Filter -->
                <div>
                    <label for="member-filter" class="block text-sm font-medium text-gray-700" data-key="filterMember">Người giao dịch</label>
                    <select id="member-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="all" data-key="allMembers">Tất cả</option>
                    </select>
                </div>
                <!-- Transaction Type Filter -->
                <div>
                    <label for="transaction-type-filter" class="block text-sm font-medium text-gray-700" data-key="transactionTypeLabel">Loại giao dịch</label>
                    <select id="transaction-type-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="all" data-key="allTypes">Tất cả</option>
                        <option value="expense" data-key="transactionTypeExpense">Chi tiêu</option>
                        <option value="contribution" data-key="transactionTypeContribution">Đóng góp</option>
                    </select>
                </div>
                <!-- Sub-Type Filter -->
                <div>
                    <label id="sub-type-filter-label" for="sub-type-filter" class="block text-sm font-medium text-gray-700" data-key="expenseTypeLabel">Loại chi tiêu</label>
                    <select id="sub-type-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="all" data-key="allExpenseTypes">Tất cả</option>
                    </select>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mt-4">
                <button id="apply-filter-btn" class="btn-primary flex-1" data-key="filterApply">Áp dụng</button>
                <button id="clear-filter-btn" class="btn-secondary flex-1" data-key="filterClear">Xóa bộ lọc</button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="export-excel-btn" class="btn-primary flex items-center gap-2" data-key="exportExcel">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 2a1 1 0 011 1v6h6a1 1 0 110 2h-6v6a1 1 0 11-2 0v-6H3a1 1 0 110-2h6V3a1 1 0 011-1z" clip-rule="evenodd" fill-rule="evenodd"></path>
                    </svg>
                    <span>Xuất Excel</span>
                </button>
            </div>
        </div>
        <!-- Transaction Table Section -->
        <div id="transaction-section" class="bg-white rounded-xl shadow overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900" data-key="transactionHistory">Lịch Sử Giao Dịch</h3>
                <span id="transaction-count" class="text-gray-500 text-sm font-medium"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDate">Ngày</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDescription">Mô tả</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableMember">Người giao dịch</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableType">Loại</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableAmount">Số tiền</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableActions">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Transaction rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls -->
            <div class="px-6 py-4 flex items-center justify-between border-t border-gray-200">
                <button id="prev-page-btn" class="btn-secondary" data-key="paginationPrevious">Trước</button>
                <span id="page-info" class="text-sm text-gray-700"></span>
                <button id="next-page-btn" class="btn-secondary" data-key="paginationNext">Sau</button>
            </div>
        </div>
    </main>
    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" class="scroll-to-top">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </button>
    <!-- View Detail Modal -->
    <div id="view-detail-modal-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" data-key="viewDetailTitle">Chi tiết giao dịch</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="view-detail-description" class="text-sm text-gray-500"></p>
                    <p id="view-detail-amount" class="text-sm text-gray-500"></p>
                    <p id="view-detail-type" class="text-sm text-gray-500"></p>
                    <p id="view-detail-member" class="text-sm text-gray-500"></p>
                    <p id="view-detail-date" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-view-detail-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring focus:ring-gray-300" data-key="close">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Script Section -->
    <script>
        // Supabase configuration and client
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';
        let supabase = null;

        // Global state
        let transactions = [];
        let expenseTypes = [];
        const TRANSLATIONS = {
            'vi': {
                appTitle: 'Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM',
                appName: 'QUẢN LÝ QUỸ NHÓM',
                navDashboard: 'Trang chủ',
                navReport: 'Báo cáo',
                navLogout: 'Đăng xuất',
                reportTitle: 'Lịch Sử Giao Dịch',
                filterStartDate: 'Từ ngày',
                filterEndDate: 'Đến ngày',
                filterMember: 'Người giao dịch',
                allMembers: 'Tất cả',
                transactionTypeLabel: 'Loại giao dịch',
                allTypes: 'Tất cả',
                transactionTypeExpense: 'Chi tiêu',
                transactionTypeContribution: 'Đóng góp',
                expenseTypeLabel: 'Loại chi tiêu',
                allExpenseTypes: 'Tất cả',
                filterApply: 'Áp dụng',
                filterClear: 'Xóa bộ lọc',
                exportExcel: 'Xuất Excel',
                transactionHistory: 'Lịch Sử Giao Dịch',
                tableDate: 'Ngày',
                tableDescription: 'Mô tả',
                tableMember: 'Người giao dịch',
                tableType: 'Loại',
                tableAmount: 'Số tiền',
                tableActions: 'Hành động',
                paginationPrevious: 'Trước',
                paginationNext: 'Sau',
                viewDetailTitle: 'Chi tiết giao dịch',
                close: 'Đóng',
                expense: 'Chi tiêu',
                contribution: 'Đóng góp',
                noData: 'Không có dữ liệu',
                transactionCount: 'Hiển thị {start} đến {end} trong tổng số {total} giao dịch',
                pageOf: 'Trang {currentPage} trên {totalPages}',
                searchPlaceholder: 'Tìm kiếm...',
                loading: 'Đang tải...',
                loadMore: 'Tải thêm',
                actionDelete: 'Xóa',
                actionEdit: 'Sửa'
            },
            'en': {
                appTitle: 'Transaction History - GROUP FUND MANAGEMENT',
                appName: 'GROUP FUND MANAGEMENT',
                navDashboard: 'Dashboard',
                navReport: 'Report',
                navLogout: 'Logout',
                reportTitle: 'Transaction History',
                filterStartDate: 'From Date',
                filterEndDate: 'To Date',
                filterMember: 'Member',
                allMembers: 'All',
                transactionTypeLabel: 'Transaction Type',
                allTypes: 'All',
                transactionTypeExpense: 'Expense',
                transactionTypeContribution: 'Contribution',
                expenseTypeLabel: 'Expense Type',
                allExpenseTypes: 'All',
                filterApply: 'Apply',
                filterClear: 'Clear Filter',
                exportExcel: 'Export to Excel',
                transactionHistory: 'Transaction History',
                tableDate: 'Date',
                tableDescription: 'Description',
                tableMember: 'Member',
                tableType: 'Type',
                tableAmount: 'Amount',
                tableActions: 'Actions',
                paginationPrevious: 'Previous',
                paginationNext: 'Next',
                viewDetailTitle: 'Transaction Details',
                close: 'Close',
                expense: 'Expense',
                contribution: 'Contribution',
                noData: 'No data available',
                transactionCount: 'Showing {start} to {end} of {total} transactions',
                pageOf: 'Page {currentPage} of {totalPages}',
                searchPlaceholder: 'Search...',
                loading: 'Loading...',
                loadMore: 'Load more',
                actionDelete: 'Delete',
                actionEdit: 'Edit'
            }
        };
        let currentLanguage = 'vi';
        let expenseTypeMap = new Map();

        // Pagination variables
        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;
        let filteredTransactions = [];

        // DOM elements
        const subTypeFilter = document.getElementById('sub-type-filter');
        const transactionTypeFilter = document.getElementById('transaction-type-filter');
        const transactionTableBody = document.getElementById('transaction-table-body');
        const pageInfoSpan = document.getElementById('page-info');
        const transactionCountSpan = document.getElementById('transaction-count');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const langViBtn = document.getElementById('lang-vi-btn');
        const langEnBtn = document.getElementById('lang-en-btn');
        const viewDetailModalOverlay = document.getElementById('view-detail-modal-overlay');
        const closeViewDetailModalBtn = document.getElementById('close-view-detail-modal-btn');
        const memberFilter = document.getElementById('member-filter');
        const startDateFilter = document.getElementById('start-date-filter');
        const endDateFilter = document.getElementById('end-date-filter');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Helper functions
        const showLoading = () => loadingOverlay.classList.remove('hidden');
        const hideLoading = () => loadingOverlay.classList.add('hidden');

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function updateAllTextContent() {
            const elements = document.querySelectorAll('[data-key]');
            elements.forEach(element => {
                const key = element.getAttribute('data-key');
                if (TRANSLATIONS[currentLanguage][key]) {
                    element.textContent = TRANSLATIONS[currentLanguage][key];
                }
            });
            // Update specific dynamic content
            updatePaginationInfo();
            updateExportButtonText();
        }

        function updateExportButtonText() {
            const exportButtonSpan = exportExcelBtn.querySelector('span');
            if (exportButtonSpan) {
                exportButtonSpan.textContent = TRANSLATIONS[currentLanguage]['exportExcel'];
            }
        }

        async function fetchExpenseTypes() {
            showLoading();
            console.log("Đang cố gắng lấy loại chi tiêu từ Supabase...");
            try {
                const { data, error } = await supabase
                    .from('expensetype_quan')
                    .select('*');

                if (error) {
                    // Log lỗi cụ thể từ Supabase
                    console.error('Lỗi khi lấy loại chi tiêu:', error.message);
                    return;
                }

                expenseTypes = data;
                expenseTypeMap.clear();
                expenseTypes.forEach(type => expenseTypeMap.set(type.id, type.name));
                console.log("Đã lấy loại chi tiêu thành công:", expenseTypes);
            } catch (err) {
                // Log lỗi không mong muốn, có thể do kết nối mạng
                console.error('Lỗi không mong muốn xảy ra khi lấy loại chi tiêu. Vui lòng kiểm tra kết nối mạng và khóa API Supabase:', err);
            } finally {
                hideLoading();
            }
        }

        function updateSubTypeFilterOptions() {
            subTypeFilter.innerHTML = `<option value="all" data-key="allExpenseTypes">${TRANSLATIONS[currentLanguage]['allExpenseTypes']}</option>`;
            expenseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                subTypeFilter.appendChild(option);
            });
        }

        function renderTransactions(data) {
            transactionTableBody.innerHTML = '';
            if (data.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="6" class="table-cell text-center text-gray-500">${TRANSLATIONS[currentLanguage]['noData']}</td>`;
                transactionTableBody.appendChild(noDataRow);
                return;
            }

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, data.length);
            const paginatedData = data.slice(startIndex, endIndex);

            paginatedData.forEach(item => {
                const row = document.createElement('tr');
                const isExpense = item.type === 'expense';
                const typeText = isExpense ? (expenseTypeMap.get(item.sub_type_id) || 'Unknown') : TRANSLATIONS[currentLanguage][item.type];
                const amountText = formatCurrency(item.amount);

                row.innerHTML = `
                    <td class="table-cell">${new Date(item.transaction_date).toLocaleDateString('vi-VN')}</td>
                    <td class="table-cell">${item.description}</td>
                    <td class="table-cell">${item.member_name}</td>
                    <td class="table-cell">${typeText}</td>
                    <td class="table-cell ${isExpense ? 'text-red-500' : 'text-green-500'}">${amountText}</td>
                    <td class="table-cell text-right whitespace-nowrap">
                        <button class="text-blue-500 hover:text-blue-700 font-medium view-detail-btn" data-id="${item.id}" data-key="viewDetailTitle">Chi tiết</button>
                    </td>
                `;
                transactionTableBody.appendChild(row);
            });

            setupDetailButtons();
        }

        function setupDetailButtons() {
            document.querySelectorAll('.view-detail-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const transaction = transactions.find(t => t.id == id);
                    if (transaction) {
                        showTransactionDetails(transaction);
                    }
                });
            });
        }

        function showTransactionDetails(transaction) {
            const descriptionElement = document.getElementById('view-detail-description');
            const amountElement = document.getElementById('view-detail-amount');
            const typeElement = document.getElementById('view-detail-type');
            const memberElement = document.getElementById('view-detail-member');
            const dateElement = document.getElementById('view-detail-date');

            const typeDisplay = transaction.type === 'expense' ? (expenseTypeMap.get(transaction.sub_type_id) || 'Unknown') : TRANSLATIONS[currentLanguage][transaction.type];

            descriptionElement.textContent = `${TRANSLATIONS[currentLanguage]['tableDescription']}: ${transaction.description}`;
            amountElement.textContent = `${TRANSLATIONS[currentLanguage]['tableAmount']}: ${formatCurrency(transaction.amount)}`;
            typeElement.textContent = `${TRANSLATIONS[currentLanguage]['tableType']}: ${typeDisplay}`;
            memberElement.textContent = `${TRANSLATIONS[currentLanguage]['tableMember']}: ${transaction.member_name}`;
            dateElement.textContent = `${TRANSLATIONS[currentLanguage]['tableDate']}: ${new Date(transaction.transaction_date).toLocaleDateString('vi-VN')}`;

            viewDetailModalOverlay.classList.remove('hidden');
        }

        function updatePaginationInfo() {
            const totalPages = Math.ceil(filteredTransactions.length / ITEMS_PER_PAGE);
            const totalItems = filteredTransactions.length;
            const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
            const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);

            const paginationText = TRANSLATIONS[currentLanguage]['pageOf']
                .replace('{currentPage}', currentPage)
                .replace('{totalPages}', totalPages);
            pageInfoSpan.textContent = paginationText;

            const countText = TRANSLATIONS[currentLanguage]['transactionCount']
                .replace('{start}', startItem)
                .replace('{end}', endItem)
                .replace('{total}', totalItems);
            transactionCountSpan.textContent = countText;

            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            prevPageBtn.classList.toggle('opacity-50', currentPage === 1);
            nextPageBtn.classList.toggle('opacity-50', currentPage === totalPages);
        }

        function filterTransactions() {
            const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;
            const memberId = memberFilter.value;
            const transactionType = transactionTypeFilter.value;
            const subTypeId = subTypeFilter.value;

            filteredTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.transaction_date);
                const matchesDate = (!startDate || transactionDate >= startDate) && (!endDate || transactionDate <= endDate);
                const matchesMember = (memberId === 'all' || transaction.member_id === memberId);
                const matchesType = (transactionType === 'all' || transaction.type === transactionType);
                const matchesSubType = (subTypeId === 'all' || transaction.sub_type_id == subTypeId);

                return matchesDate && matchesMember && matchesType && matchesSubType;
            });

            currentPage = 1;
            renderTransactions(filteredTransactions);
            updatePaginationInfo();
        }

        function clearFilters() {
            startDateFilter.value = '';
            endDateFilter.value = '';
            memberFilter.value = 'all';
            transactionTypeFilter.value = 'all';
            subTypeFilter.value = 'all';
            filterTransactions();
        }

        function exportToExcel() {
            const dataToExport = filteredTransactions.map(item => ({
                'Ngày': new Date(item.transaction_date).toLocaleDateString('vi-VN'),
                'Mô tả': item.description,
                'Người giao dịch': item.member_name,
                'Loại giao dịch': TRANSLATIONS[currentLanguage][item.type],
                'Loại chi tiêu': item.type === 'expense' ? (expenseTypeMap.get(item.sub_type_id) || '') : '',
                'Số tiền': item.amount
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Giao Dịch");
            XLSX.writeFile(workbook, "Lich_Su_Giao_Dich.xlsx");
        }

        async function fetchSupabaseData() {
            showLoading();
            console.log("Đang cố gắng lấy dữ liệu giao dịch và thành viên từ Supabase...");
            console.log("Sử dụng URL:", SUPABASE_URL);
            try {
                const { data: members, error: membersError } = await supabase
                    .from('members_quan') // Tên bảng đã được đổi
                    .select('*');

                if (membersError) {
                    throw membersError;
                }
                
                memberFilter.innerHTML = `<option value="all" data-key="allMembers">${TRANSLATIONS[currentLanguage]['allMembers']}</option>`;
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    memberFilter.appendChild(option);
                });

                const { data: transactionsData, error: transactionsError } = await supabase
                    .from('transactions_quan')
                    .select('*');

                if (transactionsError) {
                    throw transactionsError;
                }
                
                transactions = transactionsData.map(t => {
                    const member = members.find(m => m.id === t.member_id);
                    return {
                        ...t,
                        member_name: member ? member.name : 'Unknown'
                    };
                });
                filteredTransactions = transactions;
                renderTransactions(filteredTransactions);
                updatePaginationInfo();
                console.log("Đã lấy dữ liệu giao dịch và thành viên thành công.");
                
            } catch (error) {
                // Log lỗi chi tiết hơn
                console.error("Lỗi khi lấy dữ liệu từ Supabase. Vui lòng kiểm tra URL và khóa API:", error);
            } finally {
                hideLoading();
            }
        }
        
        async function initializePageWithData() {
            if (!supabase) {
                console.error("Supabase client is not initialized.");
                return;
            }
            try {
                await fetchExpenseTypes();
                updateSubTypeFilterOptions();
                await fetchSupabaseData();
                updateAllTextContent();
            } catch (error) {
                console.error("Khởi tạo trang thất bại:", error);
            }
        }

        function setupEventListeners() {
            hamburgerBtn.addEventListener('click', () => {
                hamburgerMenu.classList.toggle('hidden');
            });

            langViBtn.addEventListener('click', () => {
                currentLanguage = 'vi';
                langViBtn.classList.add('active');
                langEnBtn.classList.remove('active');
                updateAllTextContent();
                renderTransactions(filteredTransactions);
                updateSubTypeFilterOptions();
            });

            langEnBtn.addEventListener('click', () => {
                currentLanguage = 'en';
                langEnBtn.classList.add('active');
                langViBtn.classList.remove('active');
                updateAllTextContent();
                renderTransactions(filteredTransactions);
                updateSubTypeFilterOptions();
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTransactions(filteredTransactions);
                    updatePaginationInfo();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredTransactions.length / ITEMS_PER_PAGE);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTransactions(filteredTransactions);
                    updatePaginationInfo();
                }
            });

            applyFilterBtn.addEventListener('click', filterTransactions);
            clearFilterBtn.addEventListener('click', clearFilters);
            exportExcelBtn.addEventListener('click', exportToExcel);
            closeViewDetailModalBtn.addEventListener('click', () => {
                viewDetailModalOverlay.classList.add('hidden');
            });
            window.addEventListener('click', (event) => {
                if (event.target === viewDetailModalOverlay) {
                    viewDetailModalOverlay.classList.add('hidden');
                }
            });

            document.getElementById('transaction-type-filter').addEventListener('change', (e) => {
                const subTypeFilterDiv = document.getElementById('sub-type-filter').parentElement;
                if (e.target.value === 'expense') {
                    subTypeFilterDiv.style.display = 'block';
                } else {
                    subTypeFilterDiv.style.display = 'none';
                }
            });

            if (transactionTypeFilter.value !== 'expense') {
                document.getElementById('sub-type-filter').parentElement.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized with URL:", SUPABASE_URL);
                setupEventListeners();
                await initializePageWithData();
            } else {
                console.error("Supabase library not loaded. Please check the script tag.");
            }
        });
    </script>
</body>
</html>
