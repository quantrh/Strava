<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary {
            background-color: #006B68;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color: 0.3s;
        }
        .btn-primary:hover { background-color: #005654; }
        .btn-secondary {
            background-color: #F3F4F6;
            color: #1F2937;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color: 0.3s;
        }
        .btn-secondary:hover { background-color: #E5E7EB; }
        .table-header { background-color: #F9FAFB; }
        .table-cell { padding: 1rem; border-bottom: 1px solid #E5E7EB; }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .scroll-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3rem;
            height: 3rem;
            background-color: #006B68;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(20px);
            z-index: 1000;
        }
        .scroll-to-top.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative;
            z-index: 50;
        }
        .language-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #E0E7FF;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .language-switch button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #006B68;
        }
        .language-switch button.active {
            background-color: #006B68;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #006B68;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom multi-select dropdown */
        .multi-select-container {
            position: relative;
        }
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        .multi-select-dropdown label {
            display: block;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .multi-select-dropdown label:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="navbar flex items-center">
        <!-- Logo and Title -->
        <div class="flex items-center ml-4 flex-grow">
            <img src="LogoQuy.png" alt="Logo Quản Lý Quỹ Nhóm" class="h-12 w-auto rounded-lg shadow-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/006B68/FFFFFF?text=Logo';">
            <h1 class="text-2xl font-bold text-[#006B68]" data-key="appName">QUẢN LÝ QUỸ NHÓM</h1>
        </div>
        <!-- Desktop Nav and Language Switcher -->
        <div class="hidden md:flex items-center gap-4">
            <a href="./QuycomQuan.html" class="text-gray-700 hover:text-gray-900 font-semibold" data-key="navDashboard">Trang chủ</a>
            <a href="./QuycomReportQuan.html" class="text-gray-700 hover:text-gray-900 font-semibold" data-key="navReport">Báo cáo</a>
            <div class="language-switch">
                <button id="lang-vi-btn" data-lang="vi" class="active">VI</button>
                <button id="lang-en-btn" data-lang="en">EN</button>
            </div>
            <!-- Logout Button -->
            <button id="logout-btn" class="ml-4 btn-secondary bg-red-100 text-red-700 hover:bg-red-200" data-key="logout">Đăng xuất</button>
        </div>
    </div>
    <main class="container mx-auto p-4 mt-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-6" data-key="reportTitle">Lịch Sử Giao Dịch</h2>
        <!-- Filters and Actions Section -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- Start Date Filter -->
                <div>
                    <label for="start-date-filter" class="block text-sm font-medium text-gray-700" data-key="filterStartDate">Từ ngày</label>
                    <!-- UPDATE START: Changed input type to date -->
                    <input type="date" id="start-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <!-- UPDATE END -->
                </div>
                <!-- End Date Filter -->
                <div>
                    <label for="end-date-filter" class="block text-sm font-medium text-gray-700" data-key="filterEndDate">Đến ngày</label>
                    <!-- UPDATE START: Changed input type to date -->
                    <input type="date" id="end-date-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <!-- UPDATE END -->
                </div>
                <!-- Member Filter -->
                <div>
                    <label for="member-filter" class="block text-sm font-medium text-gray-700" data-key="filterMember">Người giao dịch</label>
                    <select id="member-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="all" data-key="allMembers">Tất cả</option>
                    </select>
                </div>
                <!-- Expense Type Filter -->
                <div class="relative">
                    <label for="expense-type-filter-btn" class="block text-sm font-medium text-gray-700" data-key="filterType">Loại giao dịch</label>
                    <div class="multi-select-container">
                        <button id="expense-type-filter-btn" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-white p-2 text-left">
                            <span id="expense-type-filter-text" data-key="allTypes">Tất cả</span>
                        </button>
                        <div id="expense-type-filter-dropdown" class="multi-select-dropdown hidden">
                            <!-- Checkboxes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- NEW FILTERS ROW -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="description-filter" class="block text-sm font-medium text-gray-700" data-key="filterDescription">Mô tả</label>
                    <input type="text" id="description-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Tìm theo mô tả...">
                </div>
                <div>
                    <label for="min-amount-filter" class="block text-sm font-medium text-gray-700" data-key="filterMinAmount">Số tiền từ</label>
                    <input type="number" id="min-amount-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="0">
                </div>
                <div>
                    <label for="max-amount-filter" class="block text-sm font-medium text-gray-700" data-key="filterMaxAmount">Số tiền đến</label>
                    <input type="number" id="max-amount-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="1000000">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mt-4">
                <button id="apply-filter-btn" class="btn-primary flex-1" data-key="filterApply">Áp dụng</button>
                <button id="clear-filter-btn" class="btn-secondary flex-1" data-key="filterClear">Xóa bộ lọc</button>
            </div>
            <div class="flex justify-end mt-4 gap-2">
                <button id="get-insights-btn" class="btn-primary flex items-center gap-2">
                    ✨ <span data-key="aiInsightsBtn">AI Nhận xét Quỹ</span>
                </button>
                <button id="export-excel-btn" class="btn-primary flex items-center gap-2" data-key="exportExcel">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v6h6a1 1 0 110 2h-6v6a1 1 0 11-2 0v-6H3a1 1 0 110-2h6V3a1 1 0 011-1z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    Xuất Excel
                </button>
            </div>
        </div>

        <!-- Transaction Table Section -->
        <div id="transaction-section" class="bg-white rounded-xl shadow overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900" data-key="transactionHistory">Lịch Sử Giao Dịch</h3>
                <span id="transaction-count" class="text-gray-500 text-sm font-medium"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDate">Ngày</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDescription">Mô tả</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableMember">Người giao dịch</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableType">Loại</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableAmount">Số tiền</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableActions">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Transaction rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls -->
            <div class="px-6 py-4 flex items-center justify-between border-t border-gray-200">
                <button id="prev-page-btn" class="btn-secondary" data-key="paginationPrevious">Trước</button>
                <span id="page-info" class="text-sm text-gray-700"></span>
                <button id="next-page-btn" class="btn-secondary" data-key="paginationNext">Sau</button>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="grid grid-cols-1 gap-8 mt-8">
            <!-- Doughnut Chart Section -->
            <div id="chart-section" class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900" data-key="spendingChartTitle">Biểu đồ cơ cấu chi tiêu</h3>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div id="expense-legend-container" class="overflow-y-auto max-h-96">
                        <!-- Legend table will be inserted here -->
                    </div>
                    <div class="h-96">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>
             <!-- Monthly Stacked Area Chart Section (Now Monthly Summary) -->
            <div id="monthly-chart-section" class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900" data-key="monthlySpendingChartTitle">Báo cáo tổng hợp hàng tháng</h3>
                </div>
                <div id="monthly-summary-container" class="p-6 border-t border-gray-200 overflow-x-auto">
                    <!-- Monthly summary tables will be inserted here -->
                </div>
            </div>
            <!-- UPDATE START: New Daily Spending Chart Section -->
            <div id="daily-chart-section" class="bg-white rounded-xl shadow overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900" data-key="dailySpendingChartTitle">Biểu đồ chi tiêu hàng ngày (2 tháng gần nhất)</h3>
                </div>
                <div class="p-6 h-96">
                    <canvas id="dailyExpenseChart"></canvas>
                </div>
            </div>
            <!-- UPDATE END -->
        </div>

    </main>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" class="scroll-to-top">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </button>
    
    <!-- Modals -->
    <!-- Edit Transaction Modal -->
    <div id="edit-modal-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40 modal-overlay">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" data-key="editTransactionTitle">Sửa Giao Dịch</h3>
                <div class="mt-2 px-7 py-3 max-h-[70vh] overflow-y-auto">
                    <form id="edit-transaction-form">
                        <input type="hidden" id="edit-transaction-id">
                        <div class="mb-4">
                            <label for="edit-date" class="block text-sm font-medium text-gray-700 text-left" data-key="tableDate">Ngày</label>
                            <!-- UPDATE START: Changed input type to datetime-local -->
                            <input type="datetime-local" id="edit-date" class="mt-1 p-2 w-full border rounded-md" required>
                            <!-- UPDATE END -->
                        </div>
                        <div class="mb-4">
                            <label for="edit-description" class="block text-sm font-medium text-gray-700 text-left" data-key="tableDescription">Mô tả</label>
                            <input type="text" id="edit-description" class="mt-1 p-2 w-full border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-amount" class="block text-sm font-medium text-gray-700 text-left" data-key="tableAmount">Số tiền</label>
                            <input type="number" id="edit-amount" class="mt-1 p-2 w-full border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-member" class="block text-sm font-medium text-gray-700 text-left" data-key="payer">Người trả tiền</label>
                            <select id="edit-member" class="mt-1 p-2 w-full border rounded-md" required>
                                <!-- Members will be populated here -->
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="edit-involved-members-btn" class="block text-sm font-medium text-gray-700 text-left" data-key="involvedMembersLabel">Thành viên liên quan</label>
                            <div class="multi-select-container">
                                <button type="button" id="edit-involved-members-btn" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-white p-2 text-left">
                                    <span id="edit-involved-members-text" data-key="selectMembers">Chọn thành viên</span>
                                </button>
                                <div id="edit-involved-members-dropdown" class="multi-select-dropdown hidden">
                                    <!-- Checkboxes will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="edit-expense-type" class="block text-sm font-medium text-gray-700 text-left" data-key="filterType">Loại giao dịch</label>
                            <select id="edit-expense-type" class="mt-1 p-2 w-full border rounded-md" required>
                                <!-- Expense types will be populated here -->
                            </select>
                        </div>
                        <div class="flex items-center justify-end gap-2 mt-4">
                            <button type="submit" class="btn-primary" data-key="modalSave">Lưu</button>
                            <button type="button" id="close-edit-modal-btn" class="btn-secondary" data-key="modalCancel">Hủy</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40 modal-overlay">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4" data-key="deleteConfirmationTitle">Xác Nhận Xóa</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" data-key="deleteConfirmationMessage">Bạn có chắc chắn muốn xóa giao dịch này không? Hành động này không thể hoàn tác.</p>
                </div>
                <div class="items-center px-4 py-3 flex justify-center gap-4">
                    <button id="confirm-delete-btn" class="btn-primary bg-red-600 hover:bg-red-700" data-key="modalDelete">Xóa</button>
                    <button id="cancel-delete-btn" class="btn-secondary" data-key="modalCancel">Hủy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Detail Modal -->
    <div id="chart-detail-modal-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center pb-3">
                     <h3 class="text-lg leading-6 font-medium text-gray-900" id="chart-detail-modal-title">Chi tiết chi tiêu</h3>
                     <button id="close-chart-detail-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                <div class="overflow-y-auto" style="max-height: 60vh;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDate">Ngày</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableDescription">Mô tả</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableMember">Người giao dịch</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-key="tableAmount">Số tiền</th>
                            </tr>
                        </thead>
                        <tbody id="chart-detail-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Details will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Fund Insights Modal -->
    <div id="fund-insights-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" data-key="fundInsightsModalTitle">Thông Tin Chi Tiết Quỹ ✨</h3>
                    <button id="close-insights-btn" class="text-gray-400 hover:text-gray-600">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                <div id="fund-insights-content" class="overflow-y-auto" style="max-height: 60vh;">
                    <!-- Insights will be populated here -->
                </div>
            </div>
        </div>
    </div>


    <script>
        // DOM elements initialization
        const elements = {
            transactionTableBody: document.getElementById('transaction-table-body'),
            applyFilterBtn: document.getElementById('apply-filter-btn'),
            clearFilterBtn: document.getElementById('clear-filter-btn'),
            startDateFilter: document.getElementById('start-date-filter'),
            endDateFilter: document.getElementById('end-date-filter'),
            memberFilter: document.getElementById('member-filter'),
            expenseTypeFilterBtn: document.getElementById('expense-type-filter-btn'),
            expenseTypeFilterText: document.getElementById('expense-type-filter-text'),
            expenseTypeFilterDropdown: document.getElementById('expense-type-filter-dropdown'),
            descriptionFilter: document.getElementById('description-filter'), 
            minAmountFilter: document.getElementById('min-amount-filter'), 
            maxAmountFilter: document.getElementById('max-amount-filter'), 
            transactionCountSpan: document.getElementById('transaction-count'),
            prevPageBtn: document.getElementById('prev-page-btn'),
            nextPageBtn: document.getElementById('next-page-btn'),
            pageInfoSpan: document.getElementById('page-info'),
            exportExcelBtn: document.getElementById('export-excel-btn'),
            scrollToTopBtn: document.getElementById('scroll-to-top-btn'),
            loadingOverlay: document.getElementById('loading-overlay'),
            // Edit Modal
            editModalOverlay: document.getElementById('edit-modal-overlay'),
            editTransactionForm: document.getElementById('edit-transaction-form'),
            editTransactionId: document.getElementById('edit-transaction-id'),
            editDateInput: document.getElementById('edit-date'),
            editDescriptionInput: document.getElementById('edit-description'),
            editAmountInput: document.getElementById('edit-amount'),
            editMemberSelect: document.getElementById('edit-member'),
            editExpenseTypeSelect: document.getElementById('edit-expense-type'),
            closeEditModalBtn: document.getElementById('close-edit-modal-btn'),
            editInvolvedMembersBtn: document.getElementById('edit-involved-members-btn'),
            editInvolvedMembersText: document.getElementById('edit-involved-members-text'),
            editInvolvedMembersDropdown: document.getElementById('edit-involved-members-dropdown'),
            // Delete Modal
            deleteModalOverlay: document.getElementById('delete-modal-overlay'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            // Chart elements
            expenseChartCanvas: document.getElementById('expenseChart'),
            expenseLegendContainer: document.getElementById('expense-legend-container'),
            monthlySummaryContainer: document.getElementById('monthly-summary-container'),
            dailyExpenseChartCanvas: document.getElementById('dailyExpenseChart'),
            chartDetailModalOverlay: document.getElementById('chart-detail-modal-overlay'),
            chartDetailModalTitle: document.getElementById('chart-detail-modal-title'),
            chartDetailTableBody: document.getElementById('chart-detail-table-body'),
            closeChartDetailModalBtn: document.getElementById('close-chart-detail-modal-btn'),
            getInsightsBtn: document.getElementById('get-insights-btn'),
            fundInsightsModal: document.getElementById('fund-insights-modal'),
            fundInsightsContent: document.getElementById('fund-insights-content'),
            closeInsightsBtn: document.getElementById('close-insights-btn'),
        };

        // --- Supabase Client Initialization ---
        const supabaseUrl = 'https://rmbsxccrwrktbjlnezpu.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        let members = [];
        let transactions = [];
        let expenseTypes = [];
        let currentPage = 1;
        const transactionsPerPage = 10;
        let filteredTransactions = [];
        let expenseChartInstance = null;
        let dailyChartInstance = null;
        let expenseTypeColors = {};
        let transactionToDeleteId = null;

        const localization = {
            vi: {
                appTitle: "Lịch Sử Giao Dịch - QUẢN LÝ QUỸ NHÓM",
                appName: "QUẢN LÝ QUỸ NHÓM",
                navDashboard: "Trang chủ",
                navReport: "Báo cáo",
                reportTitle: "Lịch Sử Giao Dịch",
                filterStartDate: "Từ ngày",
                filterEndDate: "Đến ngày",
                filterMember: "Người giao dịch",
                filterType: "Loại giao dịch",
                filterDescription: "Mô tả",
                filterMinAmount: "Số tiền từ",
                filterMaxAmount: "Số tiền đến",
                allMembers: "Tất cả",
                allTypes: "Tất cả",
                filterApply: "Áp dụng",
                filterClear: "Xóa bộ lọc",
                exportExcel: "Xuất Excel",
                transactionHistory: "Lịch Sử Giao Dịch",
                tableDate: "Ngày",
                tableDescription: "Mô tả",
                tableMember: "Người giao dịch",
                tableType: "Loại",
                tableAmount: "Số tiền",
                tableActions: "Hành động",
                noTransactions: "Không có giao dịch nào",
                paginationPrevious: "Trước",
                paginationNext: "Sau",
                page: "Trang",
                of: "của",
                unassigned: "Không xác định",
                unknownMember: "Thành viên không xác định",
                unknownType: "Loại không xác định",
                spendingChartTitle: "Biểu đồ cơ cấu chi tiêu",
                monthlySpendingChartTitle: "Báo cáo tổng hợp hàng tháng",
                dailySpendingChartTitle: "Biểu đồ chi tiêu hàng ngày (2 tháng gần nhất)",
                spendingByType: "Chi tiêu theo loại",
                chartDetailTitle: "Chi tiết cho",
                totalSpending: "Tổng cộng",
                legendType: "Loại",
                legendAmount: "Số tiền",
                legendRatio: "Tỷ lệ",
                selected: "đã chọn",
                editTransactionTitle: "Sửa Giao Dịch",
                modalSave: "Lưu",
                modalCancel: "Hủy",
                deleteConfirmationTitle: "Xác Nhận Xóa",
                deleteConfirmationMessage: "Bạn có chắc chắn muốn xóa giao dịch này không? Hành động này không thể hoàn tác.",
                modalDelete: "Xóa",
                logout: "Đăng xuất",
                payer: "Người trả tiền",
                involvedMembersLabel: "Thành viên liên quan",
                selectMembers: "Chọn thành viên",
                income: "Thu nhập",
                expenses: "Chi tiêu",
                showMore: "Hiện thêm",
                showLess: "Thu gọn",
                currentMonth: "Tháng này",
                previousMonth: "Tháng trước",
                aiInsightsBtn: "AI Nhận xét Quỹ",
                fundInsightsModalTitle: "Thông Tin Chi Tiết Quỹ ✨",
                generatingInsights: "Đang tạo thông tin chi tiết từ AI...",
                noInsights: "Không thể tạo thông tin chi tiết. Vui lòng thử lại.",
                aiConnectionError: "Đã xảy ra lỗi khi kết nối với AI. Vui lòng thử lại.",
            },
            en: {
                appTitle: "Transaction History - GROUP FUND MANAGER",
                appName: "GROUP FUND MANAGER",
                navDashboard: "Dashboard",
                navReport: "Report",
                reportTitle: "Transaction History",
                filterStartDate: "Start Date",
                filterEndDate: "End Date",
                filterMember: "Member",
                filterType: "Type",
                filterDescription: "Description",
                filterMinAmount: "Amount from",
                filterMaxAmount: "Amount to",
                allMembers: "All Members",
                allTypes: "All Types",
                filterApply: "Apply",
                filterClear: "Clear",
                exportExcel: "Export Excel",
                transactionHistory: "Transaction History",
                tableDate: "Date",
                tableDescription: "Description",
                tableMember: "Member",
                tableType: "Type",
                tableAmount: "Amount",
                tableActions: "Actions",
                noTransactions: "No transactions found",
                paginationPrevious: "Previous",
                paginationNext: "Next",
                page: "Page",
                of: "of",
                unassigned: "Unassigned",
                unknownMember: "Unknown Member",
                unknownType: "Unknown Type",
                spendingChartTitle: "Spending Structure Chart",
                monthlySpendingChartTitle: "Monthly Summary Report",
                dailySpendingChartTitle: "Daily Spending Chart (Last 2 Months)",
                spendingByType: "Spending by Type",
                chartDetailTitle: "Details for",
                totalSpending: "Total",
                legendType: "Type",
                legendAmount: "Amount",
                legendRatio: "Ratio",
                selected: "selected",
                editTransactionTitle: "Edit Transaction",
                modalSave: "Save",
                modalCancel: "Cancel",
                deleteConfirmationTitle: "Delete Confirmation",
                deleteConfirmationMessage: "Are you sure you want to delete this transaction? This action cannot be undone.",
                modalDelete: "Delete",
                logout: "Logout",
                payer: "Payer",
                involvedMembersLabel: "Involved Members",
                selectMembers: "Select Members",
                income: "Income",
                expenses: "Expenses",
                showMore: "Show More",
                showLess: "Show Less",
                currentMonth: "Current Month",
                previousMonth: "Previous Month",
                aiInsightsBtn: "AI Fund Insights",
                fundInsightsModalTitle: "Fund Insights ✨",
                generatingInsights: "Generating insights from AI...",
                noInsights: "Could not generate insights. Please try again.",
                aiConnectionError: "An error occurred while connecting to the AI. Please try again.",
            }
        };
        let currentLanguage = 'vi';
        let translations = localization[currentLanguage];

        function updateContent() {
            translations = localization[currentLanguage];
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[key]) {
                    if (element.id !== 'expense-type-filter-text' || getSelectedExpenseTypes().length === 0) {
                       element.textContent = translations[key];
                    }
                }
            });
            renderTransactions(filteredTransactions);
            renderAllCharts(filteredTransactions);
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('lang-vi-btn').classList.toggle('active', lang === 'vi');
            document.getElementById('lang-en-btn').classList.toggle('active', lang === 'en');
            updateContent();
        }

        document.getElementById('lang-vi-btn').addEventListener('click', () => setLanguage('vi'));
        document.getElementById('lang-en-btn').addEventListener('click', () => setLanguage('en'));

        async function fetchSupabaseData() {
            elements.loadingOverlay.classList.remove('hidden');
            try {
                const { data: membersData, error: membersError } = await supabaseClient.from('members_quan').select('*');
                if (membersError) throw membersError;
                members = membersData;

                const { data: expenseTypesData, error: expenseTypesError } = await supabaseClient.from('expensetype_quan').select('*');
                if (expenseTypesError) throw expenseTypesError;
                expenseTypes = expenseTypesData;
                
                expenseTypes.forEach((type, index) => {
                    expenseTypeColors[type.expense_type] = `hsl(${(index * 60) % 360}, 70%, 60%)`;
                });

                const { data: transactionsData, error: transactionsError } = await supabaseClient.from('transactions_quan').select('*');
                if (transactionsError) throw transactionsError;
                transactions = transactionsData;

                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                initializePageWithData();

            } catch (error) {
                console.error('Error fetching data from Supabase:', error.message);
            } finally {
                elements.loadingOverlay.classList.add('hidden');
            }
        }

        function getMemberNames(memberIds, contributingMemberId) {
            let ids = [];
            if (memberIds) ids = [...memberIds];
            if (contributingMemberId && !ids.includes(contributingMemberId)) ids.push(contributingMemberId);

            if (ids.length === 0) return translations.unassigned || 'Không xác định';
            return ids.map(id => {
                const member = members.find(m => m.id === id);
                return member ? member.name : (translations.unknownMember || 'Thành viên không xác định');
            }).join(', ');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function renderTransactions(data) {
            elements.transactionTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            if (paginatedData.length === 0) {
                elements.transactionTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">${translations.noTransactions}</td></tr>`;
            } else {
                paginatedData.forEach(transaction => {
                    const memberName = getMemberNames(transaction.involvedMemberIds, transaction.contributingMemberId);
                    const expenseTypeName = transaction.expense_type;
                    const formattedDate = new Date(transaction.date).toLocaleDateString('vi-VN');
                    const formattedAmount = formatCurrency(transaction.amount);

                    const row = `
                        <tr class="hover:bg-gray-50" data-id="${transaction.id}">
                            <td class="table-cell">${formattedDate}</td>
                            <td class="table-cell truncate max-w-xs">${transaction.description}</td>
                            <td class="table-cell">${memberName}</td>
                            <td class="table-cell">${expenseTypeName}</td>
                            <td class="table-cell font-medium text-right">${formattedAmount}</td>
                            <td class="table-cell text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button class="text-blue-600 hover:text-blue-900 p-1 edit-btn" data-id="${transaction.id}" title="Sửa">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                          <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <button class="text-red-600 hover:text-red-900 p-1 delete-btn" data-id="${transaction.id}" title="Xóa">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    elements.transactionTableBody.innerHTML += row;
                });
            }

            elements.transactionCountSpan.textContent = `(${data.length} ${translations.transactionHistory.toLowerCase()})`;
            updatePaginationControls(data.length);
        }
        
        function renderAllCharts(data) {
            renderDoughnutChart(data);
            renderMonthlySummaries(data);
            renderDailySpendingChart(data);
        }

        function renderDoughnutChart(data) {
            if (expenseChartInstance) {
                expenseChartInstance.destroy();
            }

            const expenseData = data.filter(transaction => transaction.type === 'expense');

            const spendingByType = expenseData.reduce((acc, transaction) => {
                const type = transaction.expense_type || (translations.unassigned || 'Không xác định');
                const amount = transaction.amount;
                if (!acc[type]) {
                    acc[type] = { total: 0, transactions: [] };
                }
                acc[type].total += amount;
                acc[type].transactions.push(transaction);
                return acc;
            }, {});

            const sortedData = Object.entries(spendingByType)
                .sort(([, a], [, b]) => b.total - a.total);

            const totalSpending = sortedData.reduce((sum, [, item]) => sum + item.total, 0);

            let legendHtml = `
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-2 py-2">${translations.legendType}</th>
                            <th scope="col" class="px-2 py-2 text-right">${translations.legendAmount}</th>
                            <th scope="col" class="px-2 py-2 text-right">${translations.legendRatio}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedData.forEach(([label, item]) => {
                const percentage = totalSpending > 0 ? ((item.total / totalSpending) * 100).toFixed(2) : 0;
                const color = expenseTypeColors[label] || '#cccccc';
                legendHtml += `
                    <tr class="bg-white border-b">
                        <td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">
                            <span class="inline-block w-3 h-3 mr-2 rounded-full" style="background-color: ${color};"></span>
                            ${label}
                        </td>
                        <td class="px-2 py-2 text-right">${formatCurrency(item.total)}</td>
                        <td class="px-2 py-2 text-right">${percentage}%</td>
                    </tr>
                `;
            });

            legendHtml += `
                    </tbody>
                    <tfoot class="font-semibold text-gray-900">
                        <tr>
                            <td class="px-2 py-2">${translations.totalSpending}</td>
                            <td class="px-2 py-2 text-right" colspan="2">${formatCurrency(totalSpending)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            elements.expenseLegendContainer.innerHTML = legendHtml;

            const chartLabels = sortedData.map(([label]) => label);
            const chartData = sortedData.map(([, item]) => item.total);
            const chartColors = chartLabels.map(label => expenseTypeColors[label] || '#cccccc');

            const ctx = elements.expenseChartCanvas.getContext('2d');
            expenseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderColor: '#fff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, chartElements) => {
                        if (chartElements.length > 0) {
                            const chartElement = chartElements[0];
                            const label = chartLabels[chartElement.index];
                            const transactionsForType = spendingByType[label].transactions;
                            const title = `${translations.chartDetailTitle} "${label}"`;
                            openChartDetailModal(title, transactionsForType);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) {
                                        const value = context.parsed;
                                        const percentage = totalSpending > 0 ? ((value / totalSpending) * 100).toFixed(2) : 0;
                                        label += `${formatCurrency(value)} (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderMonthlySummaries(data) {
            const summaryContainer = elements.monthlySummaryContainer;
            summaryContainer.innerHTML = '';

            const monthlyData = data.reduce((acc, t) => {
                const month = t.date.substring(0, 7);
                if (!acc[month]) acc[month] = [];
                acc[month].push(t);
                return acc;
            }, {});

            const months = Object.keys(monthlyData).sort().reverse();

            if (months.length === 0) {
                summaryContainer.innerHTML = `<p class="text-center text-gray-500">${translations.noTransactions}</p>`;
                return;
            }

            let summaryHtml = '<div class="space-y-8">';
            months.forEach((month, index) => {
                const monthTransactions = monthlyData[month];
                const incomeTransactions = monthTransactions.filter(t => t.type === 'contribution');
                const expenseTransactions = monthTransactions.filter(t => t.type === 'expense');

                const incomeByType = incomeTransactions.reduce((acc, t) => {
                    const type = t.expense_type || translations.unassigned;
                    acc[type] = (acc[type] || 0) + t.amount;
                    return acc;
                }, {});
                const expenseByType = expenseTransactions.reduce((acc, t) => {
                    const type = t.expense_type || translations.unassigned;
                    acc[type] = (acc[type] || 0) + t.amount;
                    return acc;
                }, {});

                const totalIncome = Object.values(incomeByType).reduce((sum, amount) => sum + amount, 0);
                const totalExpense = Object.values(expenseByType).reduce((sum, amount) => sum + amount, 0);
                const isCollapsed = index >= 2;

                summaryHtml += `<div class="month-summary-block">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xl font-bold text-gray-800">${month}</h4>
                        ${index >= 2 ? `<button class="toggle-month-btn text-sm text-blue-600 font-semibold" data-month="${month}">${translations.showMore}</button>` : ''}
                    </div>
                    <div class="month-details space-y-4 ${isCollapsed ? 'hidden' : ''}" id="details-${month}">`;

                if (totalIncome > 0) {
                    summaryHtml += `<div><h5 class="text-lg font-semibold text-green-600 mb-2">${translations.income}</h5><table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>
                            <th scope="col" class="px-4 py-2">${translations.legendType}</th><th scope="col" class="px-4 py-2 text-right">${translations.legendAmount}</th><th scope="col" class="px-4 py-2 text-right">${translations.legendRatio}</th>
                        </tr></thead><tbody>`;
                    Object.entries(incomeByType).sort(([,a],[,b]) => b-a).forEach(([type, amount]) => {
                        const percentage = totalIncome > 0 ? (amount / totalIncome * 100).toFixed(2) : 0;
                        summaryHtml += `<tr class="bg-white border-b"><td class="px-4 py-2 font-medium text-gray-900">${type}</td><td class="px-4 py-2 text-right">${formatCurrency(amount)}</td><td class="px-4 py-2 text-right">${percentage}%</td></tr>`;
                    });
                    summaryHtml += `</tbody><tfoot class="font-semibold text-gray-900"><tr>
                        <td class="px-4 py-2">${translations.totalSpending}</td><td class="px-4 py-2 text-right">${formatCurrency(totalIncome)}</td><td class="px-4 py-2 text-right">100.00%</td>
                    </tr></tfoot></table></div>`;
                }

                if (totalExpense > 0) {
                     summaryHtml += `<div><h5 class="text-lg font-semibold text-red-600 mb-2">${translations.expenses}</h5><table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>
                            <th scope="col" class="px-4 py-2">${translations.legendType}</th><th scope="col" class="px-4 py-2 text-right">${translations.legendAmount}</th><th scope="col" class="px-4 py-2 text-right">${translations.legendRatio}</th>
                        </tr></thead><tbody>`;
                    Object.entries(expenseByType).sort(([,a],[,b]) => b-a).forEach(([type, amount]) => {
                        const percentage = totalExpense > 0 ? (amount / totalExpense * 100).toFixed(2) : 0;
                        summaryHtml += `<tr class="bg-white border-b"><td class="px-4 py-2 font-medium text-gray-900">${type}</td><td class="px-4 py-2 text-right">${formatCurrency(amount)}</td><td class="px-4 py-2 text-right">${percentage}%</td></tr>`;
                    });
                    summaryHtml += `</tbody><tfoot class="font-semibold text-gray-900"><tr>
                        <td class="px-4 py-2">${translations.totalSpending}</td><td class="px-4 py-2 text-right">${formatCurrency(totalExpense)}</td><td class="px-4 py-2 text-right">100.00%</td>
                    </tr></tfoot></table></div>`;
                }
                summaryHtml += `</div></div>`;
            });
            summaryHtml += '</div>';
            summaryContainer.innerHTML = summaryHtml;
        }

        function renderDailySpendingChart(data) {
            if (dailyChartInstance) dailyChartInstance.destroy();
            const expenses = data.filter(t => t.type === 'expense');
            const monthlyData = expenses.reduce((acc, t) => {
                const month = t.date.substring(0, 7);
                if (!acc[month]) acc[month] = [];
                acc[month].push(t);
                return acc;
            }, {});

            const months = Object.keys(monthlyData).sort().reverse();
            if (months.length === 0) return;

            const currentMonthKey = months[0];
            const previousMonthKey = months[1];

            const getDailyTotals = (monthKey) => {
                const dailyTotals = Array(31).fill(0);
                if (!monthKey || !monthlyData[monthKey]) return dailyTotals;
                monthlyData[monthKey].forEach(t => {
                    const day = new Date(t.date).getDate() - 1;
                    dailyTotals[day] += t.amount;
                });
                return dailyTotals;
            };

            const datasets = [];
            if(currentMonthKey) datasets.push({
                label: `${translations.currentMonth} (${currentMonthKey})`,
                data: getDailyTotals(currentMonthKey),
                borderColor: 'rgba(239, 68, 68, 1)',
                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                fill: true, tension: 0.4,
            });
            if(previousMonthKey) datasets.push({
                label: `${translations.previousMonth} (${previousMonthKey})`,
                data: getDailyTotals(previousMonthKey),
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                fill: true, tension: 0.4,
            });

            const ctx = elements.dailyExpenseChartCanvas.getContext('2d');
            dailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: Array.from({ length: 31 }, (_, i) => i + 1), datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: (value) => formatCurrency(value) } } },
                    plugins: { tooltip: { callbacks: { label: (context) => `${context.dataset.label || ''}: ${formatCurrency(context.parsed.y)}` } } }
                }
            });
        }

        function openChartDetailModal(title, transactionsForType) {
            elements.chartDetailModalTitle.textContent = title;
            elements.chartDetailTableBody.innerHTML = '';
            transactionsForType.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (transactionsForType.length === 0) {
                 elements.chartDetailTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">${translations.noTransactions}</td></tr>`;
            } else {
                transactionsForType.forEach(t => {
                    elements.chartDetailTableBody.innerHTML += `<tr>
                        <td class="table-cell">${new Date(t.date).toLocaleDateString('vi-VN')}</td>
                        <td class="table-cell">${t.description}</td>
                        <td class="table-cell">${getMemberNames(t.involvedMemberIds, t.contributingMemberId)}</td>
                        <td class="table-cell text-right">${formatCurrency(t.amount)}</td>
                    </tr>`;
                });
            }
            elements.chartDetailModalOverlay.classList.remove('hidden');
        }

        function getEditSelectedInvolvedMembers() {
            return Array.from(elements.editInvolvedMembersDropdown.querySelectorAll('input:checked')).map(cb => cb.value);
        }

        function updateEditInvolvedMembersText() {
            const count = getEditSelectedInvolvedMembers().length;
            elements.editInvolvedMembersText.textContent = count === 0 ? (translations.selectMembers || "Chọn thành viên") : `${count} ${translations.selected}`;
        }

        function openEditModal(transactionId) {
            const transaction = transactions.find(t => String(t.id) === transactionId);
            if (!transaction) return;

            elements.editTransactionId.value = transaction.id;
            
            // UPDATE START: Format date for datetime-local input
            const localDate = new Date(transaction.date);
            localDate.setMinutes(localDate.getMinutes() - localDate.getTimezoneOffset());
            elements.editDateInput.value = localDate.toISOString().slice(0, 16);
            // UPDATE END
            
            elements.editDescriptionInput.value = transaction.description;
            elements.editAmountInput.value = transaction.amount;

            elements.editMemberSelect.innerHTML = '';
            members.forEach(member => {
                elements.editMemberSelect.innerHTML += `<option value="${member.id}">${member.name}</option>`;
            });
            elements.editMemberSelect.value = transaction.contributingMemberId || '';

            elements.editInvolvedMembersDropdown.innerHTML = '';
            members.forEach(member => {
                const isChecked = transaction.involvedMemberIds && transaction.involvedMemberIds.includes(member.id);
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 p-2 hover:bg-gray-100 cursor-pointer';
                label.innerHTML = `<input type="checkbox" value="${member.id}" class="rounded border-gray-300" ${isChecked ? 'checked' : ''}> <span>${member.name}</span>`;
                label.querySelector('input').addEventListener('change', updateEditInvolvedMembersText);
                elements.editInvolvedMembersDropdown.appendChild(label);
            });
            updateEditInvolvedMembersText();

            elements.editExpenseTypeSelect.innerHTML = '';
            expenseTypes.forEach(type => {
                elements.editExpenseTypeSelect.innerHTML += `<option value="${type.id}">${type.expense_type}</option>`;
            });
            const expenseType = expenseTypes.find(t => t.expense_type === transaction.expense_type);
            if (expenseType) elements.editExpenseTypeSelect.value = expenseType.id;

            elements.editModalOverlay.classList.remove('hidden');
        }

        async function handleEditFormSubmit(event) {
            event.preventDefault();
            elements.loadingOverlay.classList.remove('hidden');
            const transactionId = elements.editTransactionId.value;
            const newExpenseTypeId = elements.editExpenseTypeSelect.value;
            const newExpenseTypeName = expenseTypes.find(t => String(t.id) === newExpenseTypeId).expense_type;
            const updatedData = {
                // UPDATE START: Read from datetime-local and convert to ISO string
                date: new Date(elements.editDateInput.value).toISOString(),
                // UPDATE END
                description: elements.editDescriptionInput.value,
                amount: parseFloat(elements.editAmountInput.value),
                contributingMemberId: elements.editMemberSelect.value,
                expense_type: newExpenseTypeName,
                involvedMemberIds: getEditSelectedInvolvedMembers(),
            };
            try {
                const { error } = await supabaseClient.from('transactions_quan').update(updatedData).eq('id', transactionId);
                if (error) throw error;
                elements.editModalOverlay.classList.add('hidden');
                await fetchSupabaseData();
            } catch (error) {
                alert('Lỗi: ' + error.message);
            } finally {
                elements.loadingOverlay.classList.add('hidden');
            }
        }

        function openDeleteModal(transactionId) {
            transactionToDeleteId = transactionId;
            elements.deleteModalOverlay.classList.remove('hidden');
        }

        async function deleteTransaction() {
            if (!transactionToDeleteId) return;
            elements.loadingOverlay.classList.remove('hidden');
            try {
                const { error } = await supabaseClient.from('transactions_quan').delete().eq('id', transactionToDeleteId);
                if (error) throw error;
                elements.deleteModalOverlay.classList.add('hidden');
                await fetchSupabaseData();
            } catch (error) {
                 alert('Lỗi: ' + error.message);
            } finally {
                elements.loadingOverlay.classList.add('hidden');
                transactionToDeleteId = null;
            }
        }

        function updatePaginationControls(totalTransactions) {
            const totalPages = Math.ceil(totalTransactions / transactionsPerPage);
            elements.pageInfoSpan.textContent = `${translations.page} ${currentPage} ${translations.of} ${totalPages}`;
            elements.prevPageBtn.disabled = currentPage === 1;
            elements.nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function getSelectedExpenseTypes() {
            return Array.from(elements.expenseTypeFilterDropdown.querySelectorAll('input:checked')).map(cb => cb.value);
        }

        function applyFilters() {
            // UPDATE START: Read from date inputs and adjust time
            const startDate = elements.startDateFilter.value ? new Date(elements.startDateFilter.value) : null;
            if (startDate) startDate.setHours(0, 0, 0, 0);

            const endDate = elements.endDateFilter.value ? new Date(elements.endDateFilter.value) : null;
            if (endDate) endDate.setHours(23, 59, 59, 999);
            // UPDATE END
            
            const memberId = elements.memberFilter.value;
            const selectedExpenseTypeIds = getSelectedExpenseTypes();
            const description = elements.descriptionFilter.value.toLowerCase().trim();
            const minAmount = parseFloat(elements.minAmountFilter.value);
            const maxAmount = parseFloat(elements.maxAmountFilter.value);
            const selectedExpenseTypeNames = selectedExpenseTypeIds.map(id => expenseTypes.find(t => String(t.id) === id)?.expense_type).filter(Boolean);

            filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const memberMatch = memberId === 'all' || (t.involvedMemberIds && t.involvedMemberIds.includes(memberId)) || (t.contributingMemberId === memberId);
                const typeMatch = selectedExpenseTypeNames.length === 0 || selectedExpenseTypeNames.includes(t.expense_type);
                const dateMatch = (!startDate || transactionDate >= startDate) && (!endDate || transactionDate <= endDate);
                const descriptionMatch = !description || t.description.toLowerCase().includes(description);
                const minAmountMatch = isNaN(minAmount) || t.amount >= minAmount;
                const maxAmountMatch = isNaN(maxAmount) || t.amount <= maxAmount;
                return memberMatch && typeMatch && dateMatch && descriptionMatch && minAmountMatch && maxAmountMatch;
            });

            currentPage = 1;
            renderTransactions(filteredTransactions);
            renderAllCharts(filteredTransactions);
        }

        function exportToExcel() {
            const dataToExport = filteredTransactions.map(t => ({
                'Ngày': new Date(t.date).toLocaleDateString('vi-VN'),
                'Mô tả': t.description,
                'Người giao dịch': getMemberNames(t.involvedMemberIds, t.contributingMemberId),
                'Loại': t.expense_type,
                'Số tiền (VND)': t.amount
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Lịch Sử Giao Dịch');
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            saveAs(new Blob([wbout], { type: 'application/octet-stream' }), 'lich_su_giao_dich.xlsx');
        }

        async function callGeminiAPI(payload, retries = 3, delay = 1000) {
            const apiKey = ""; // Left empty for Canvas environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API Error (${response.status})`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]) return result;
                    throw new Error("Invalid API response structure.");
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * 2 ** i));
                }
            }
        }

        function markdownToHtml(markdown) {
            let html = markdown;
            html = html.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-6 mb-3">$1</h2>');
            html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');
            html = html.replace(/^\s*-\s(.*)$/gim, '<li class="ml-5 list-disc">$1</li>');
            html = html.split('\n').map(line => line.trim() ? `<p class="mb-2">${line}</p>` : '').join('').replace(/<p class="mb-2">((<h[23]>.*<\/h[23]>)|(<li.*<\/li>))<\/p>/g, '$1');
            return html;
        }

        async function generateFundInsights() {
            elements.fundInsightsContent.innerHTML = `<div class="flex flex-col items-center"><div class="spinner"></div><p class="mt-2">${translations.generatingInsights}</p></div>`;
            
            const totalContributions = filteredTransactions.filter(t => t.type === 'contribution').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const currentBalance = totalContributions - totalExpenses;

            const promptData = {
                fundBalance: currentBalance,
                transactions: filteredTransactions.slice(0, 20).map(t => ({
                    type: t.type,
                    amount: t.amount,
                    description: t.description,
                    date: t.date,
                    category: t.expense_type,
                    member: getMemberNames(t.involvedMemberIds, t.contributingMemberId)
                }))
            };

            const prompt = `Bạn là một chuyên gia tư vấn tài chính. Dựa vào dữ liệu quỹ sau (bằng VNĐ), hãy đưa ra phân tích và nhận xét.
            Dữ liệu: ${JSON.stringify(promptData)}
            Hãy trả lời bằng tiếng Việt theo định dạng Markdown, bao gồm:
            ## Tình hình chung
            - Nhận xét về số dư và tổng thu/chi trong giai đoạn được lọc.
            ## Phân tích chi tiêu
            - Các khoản chi lớn nhất là gì?
            - Nhóm đang chi tiêu nhiều nhất cho loại nào?
            ## Gợi ý
            - Đưa ra lời khuyên để quản lý chi tiêu tốt hơn.`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const result = await callGeminiAPI(payload);
                const text = result.candidates[0].content.parts[0].text;
                elements.fundInsightsContent.innerHTML = markdownToHtml(text);
            } catch (error) {
                elements.fundInsightsContent.innerHTML = `<p class="text-red-500">${translations.aiConnectionError}</p>`;
            }
        }

        // --- Event Listeners ---
        elements.applyFilterBtn.addEventListener('click', applyFilters);
        elements.clearFilterBtn.addEventListener('click', () => {
            elements.startDateFilter.value = '';
            elements.endDateFilter.value = '';
            elements.memberFilter.value = 'all';
            elements.descriptionFilter.value = '';
            elements.minAmountFilter.value = '';
            elements.maxAmountFilter.value = '';
            elements.expenseTypeFilterDropdown.querySelectorAll('input').forEach(cb => cb.checked = false);
            updateExpenseTypeFilterText();
            filteredTransactions = transactions;
            currentPage = 1;
            renderTransactions(filteredTransactions);
            renderAllCharts(filteredTransactions);
        });

        elements.prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTransactions(filteredTransactions); } });
        elements.nextPageBtn.addEventListener('click', () => { if (currentPage < Math.ceil(filteredTransactions.length / transactionsPerPage)) { currentPage++; renderTransactions(filteredTransactions); } });
        elements.exportExcelBtn.addEventListener('click', exportToExcel);
        elements.closeChartDetailModalBtn.addEventListener('click', () => elements.chartDetailModalOverlay.classList.add('hidden'));
        elements.transactionTableBody.addEventListener('click', (event) => {
            const editButton = event.target.closest('.edit-btn');
            const deleteButton = event.target.closest('.delete-btn');
            if (editButton) openEditModal(editButton.dataset.id);
            if (deleteButton) openDeleteModal(deleteButton.dataset.id);
        });
        elements.closeEditModalBtn.addEventListener('click', () => elements.editModalOverlay.classList.add('hidden'));
        elements.editTransactionForm.addEventListener('submit', handleEditFormSubmit);
        elements.cancelDeleteBtn.addEventListener('click', () => elements.deleteModalOverlay.classList.add('hidden'));
        elements.confirmDeleteBtn.addEventListener('click', deleteTransaction);
        elements.expenseTypeFilterBtn.addEventListener('click', () => elements.expenseTypeFilterDropdown.classList.toggle('hidden'));
        elements.editInvolvedMembersBtn.addEventListener('click', () => elements.editInvolvedMembersDropdown.classList.toggle('hidden'));
        document.addEventListener('click', (e) => {
            if (!elements.expenseTypeFilterBtn.parentElement.contains(e.target)) elements.expenseTypeFilterDropdown.classList.add('hidden');
            if (!elements.editInvolvedMembersBtn.parentElement.contains(e.target)) elements.editInvolvedMembersDropdown.classList.add('hidden');
        });
        
        function updateExpenseTypeFilterText() {
            const count = getSelectedExpenseTypes().length;
            elements.expenseTypeFilterText.textContent = count === 0 ? translations.allTypes : `${count} ${translations.selected}`;
        }

        function initializePageWithData() {
            elements.memberFilter.innerHTML = `<option value="all" data-key="allMembers">${localization[currentLanguage].allMembers}</option>`;
            members.forEach(member => elements.memberFilter.innerHTML += `<option value="${member.id}">${member.name}</option>`);
            elements.expenseTypeFilterDropdown.innerHTML = '';
            expenseTypes.forEach(type => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 p-2 hover:bg-gray-100 cursor-pointer';
                label.innerHTML = `<input type="checkbox" value="${type.id}" class="rounded border-gray-300"> <span>${type.expense_type}</span>`;
                label.querySelector('input').addEventListener('change', updateExpenseTypeFilterText);
                elements.expenseTypeFilterDropdown.appendChild(label);
            });
            setLanguage(currentLanguage);
            filteredTransactions = transactions;
            renderTransactions(filteredTransactions);
            renderAllCharts(filteredTransactions);
        }
        
        async function handleLogout() {
            elements.loadingOverlay.classList.remove('hidden');
            try {
                await supabaseClient.auth.signOut();
                window.location.href = window.location.origin + '/index.html';
            } catch (error) {
                alert('Lỗi khi đăng xuất: ' + error.message);
            } finally {
                elements.loadingOverlay.classList.add('hidden');
            }
        }
        
        elements.monthlySummaryContainer.addEventListener('click', (event) => {
            const toggleButton = event.target.closest('.toggle-month-btn');
            if (toggleButton) {
                const month = toggleButton.dataset.month;
                const detailsDiv = document.getElementById(`details-${month}`);
                const isHidden = detailsDiv.classList.toggle('hidden');
                toggleButton.textContent = isHidden ? translations.showMore : translations.showLess;
            }
        });

        elements.getInsightsBtn.addEventListener('click', () => {
            elements.fundInsightsModal.classList.remove('hidden');
            generateFundInsights();
        });
        elements.closeInsightsBtn.addEventListener('click', () => {
            elements.fundInsightsModal.classList.add('hidden');
        });

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = window.location.origin + '/index.html';
                    return; 
                }
                document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
                await fetchSupabaseData();
            } catch (error) {
                elements.loadingOverlay.classList.add('hidden');
                document.body.innerHTML = `<div class="text-center p-8 text-red-600">Lỗi khởi tạo: ${error.message}</div>`;
            }
        });

    </script>
</body>
</html>
