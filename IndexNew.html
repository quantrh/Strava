<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Quản lý Thành tích Chạy bộ - BIDV Running Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Define BIDV brand colors */
        :root {
            --bidv-green: #006b68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .btn-primary {
            background-color: var(--bidv-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: #005a57; /* Darker green on hover */
        }

        .btn-secondary {
            background-color: var(--bidv-yellow);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background-color: #e6b32a; /* Darker yellow on hover */
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        /* Styling for the bubble chart container */
        #bubble-chart-container {
            width: 100%;
            height: 500px; /* Fixed height for the chart */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Hide overflow if bubbles go outside */
        }

        .bubble {
            stroke: var(--bidv-green);
            stroke-width: 2px;
            fill-opacity: 0.7;
            cursor: pointer;
            transition: fill-opacity 0.3s ease;
        }

        .bubble:hover {
            fill-opacity: 1;
        }

        .bubble-text {
            font-size: 0.8rem;
            text-anchor: middle;
            fill: white;
            pointer-events: none; /* Allow clicks to pass through text to bubble */
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.9rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            #bubble-chart-container {
                height: 400px; /* Adjust height for smaller screens */
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-bidv-green text-white p-4 shadow-md">
        <div class="container flex justify-between items-center">
            <h1 class="text-2xl font-bold">BIDV Running Club</h1>
            <nav>
                </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <section id="auth-section" class="card mb-8 text-center">
            <h2 class="text-xl font-semibold mb-4">Kết nối tài khoản Strava của bạn</h2>
            <p class="mb-6">Để theo dõi thành tích chạy bộ, vui lòng kết nối với tài khoản Strava của bạn.</p>
            <button id="connect-strava-btn" class="btn-primary">
                Kết nối với Strava
            </button>
            <div id="auth-status" class="mt-4 text-sm text-gray-600"></div>
        </section>

        <section id="data-section" class="card mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Dữ liệu thành tích chạy bộ</h2>
            <p id="user-info" class="mb-4 text-lg font-medium"></p>
            <div class="flex flex-wrap gap-4 mb-6">
                <button id="fetch-activities-btn" class="btn-primary">
                    Tải/Cập nhật dữ liệu từ Strava
                </button>
                <button id="view-stats-btn" class="btn-secondary">
                    Xem thống kê
                </button>
            </div>
            <div id="data-status" class="mt-4 text-sm text-gray-600"></div>

            <div id="activities-list" class="mt-6 border-t pt-4">
                <h3 class="text-lg font-semibold mb-3">Các hoạt động gần đây:</h3>
                <ul id="recent-activities" class="space-y-2 text-sm">
                    </ul>
            </div>
        </section>

        <section id="stats-section" class="card hidden">
            <h2 class="text-xl font-semibold mb-4">Thống kê thành tích theo tuần</h2>
            <div id="bubble-chart-container">
                </div>
            <div id="chart-status" class="mt-4 text-sm text-gray-600"></div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm">
        <div class="container">
            &copy; 2025 BIDV Running Club. All rights reserved.
        </div>
    </footer>

    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="alert-message" class="mb-4 text-lg"></p>
            <button id="alert-ok-btn" class="btn-primary">OK</button>
        </div>
    </div>

    <script>
        // Hàm hiển thị thông báo tùy chỉnh thay cho alert()
        function showAlert(message) {
            const customAlert = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');

            alertOkBtn.onclick = () => {
                customAlert.classList.add('hidden');
            };
        }

        // Cấu hình Strava và Supabase của bạn
        // THAY THẾ CÁC GIÁ TRỊ NÀY BẰNG THÔNG TIN THỰC TẾ CỦA BẠN
        const STRAVA_CLIENT_ID = '55949'; // Lấy từ Strava API application
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // URL dự án Supabase của bạn
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Khóa anon public của Supabase
        // URL của Edge Function để xử lý OAuth callback
        const STRAVA_OAUTH_CALLBACK_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/strava-oauth-callback';
        // URL của Edge Function để tải dữ liệu hoạt động
        const FETCH_ACTIVITIES_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/fetch-strava-activities';
        // URL của Edge Function để lấy dữ liệu thống kê
        const GET_STATS_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/get-user-activities';


        // --- Khởi tạo Firebase (được cung cấp bởi môi trường Canvas, không cần khởi tạo lại) ---
        // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // const app = firebase.initializeApp(firebaseConfig);
        // const auth = firebase.auth(); // Hoặc getAuth(app) nếu dùng modular SDK
        // const db = firebase.firestore(); // Hoặc getFirestore(app) nếu dùng modular SDK

        // Biến toàn cục để lưu trữ trạng thái người dùng
        let currentUserId = null;
        let isAuthenticated = false;

        // Hàm kiểm tra trạng thái đăng nhập và cập nhật UI
        async function checkAuthState() {
            // Trong môi trường Canvas, __initial_auth_token được cung cấp
            // Chúng ta sẽ giả định người dùng đã được xác thực nếu có token này
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                // Giả định rằng token này đã được dùng để đăng nhập Firebase Auth
                // và chúng ta có thể lấy uid từ đó.
                // Trong ứng dụng thực tế, bạn sẽ dùng onAuthStateChanged của Firebase Auth
                // để lấy userId sau khi signInWithCustomToken.
                // Vì đây là một ví dụ front-end, chúng ta sẽ giả định một userId tạm thời
                // hoặc bạn sẽ cần một cách để backend trả về userId sau OAuth.
                // Để đơn giản, chúng ta sẽ sử dụng một ID giả định hoặc lấy từ URL nếu có.
                const params = new URLSearchParams(window.location.search);
                const userIdFromUrl = params.get('userId'); // Giả định backend trả về userId sau OAuth
                if (userIdFromUrl) {
                    currentUserId = userIdFromUrl;
                    isAuthenticated = true;
                } else {
                    // Nếu không có userId từ URL, có thể là lần đầu tiên truy cập hoặc lỗi
                    // Trong môi trường Canvas, __initial_auth_token chỉ ra rằng người dùng đã đăng nhập vào Canvas
                    // nhưng không nhất thiết là đã hoàn tất OAuth với Strava.
                    // Để đơn giản ví dụ này, chúng ta sẽ giả định người dùng cần kết nối Strava.
                    // Hoặc bạn có thể sử dụng một Firebase UID giả định nếu muốn mô phỏng.
                    // Ví dụ: currentUserId = "firebase-user-id-123";
                    // isAuthenticated = true;
                }
            }

            updateUI();
        }

        // Hàm cập nhật giao diện người dùng dựa trên trạng thái xác thực
        function updateUI() {
            const authSection = document.getElementById('auth-section');
            const dataSection = document.getElementById('data-section');
            const statsSection = document.getElementById('stats-section');
            const userInfo = document.getElementById('user-info');
            const authStatus = document.getElementById('auth-status');

            if (isAuthenticated && currentUserId) {
                authSection.classList.add('hidden');
                dataSection.classList.remove('hidden');
                statsSection.classList.remove('hidden');
                userInfo.textContent = `Chào mừng, Người dùng ID: ${currentUserId}`;
                authStatus.textContent = 'Đã kết nối với ứng dụng.';
            } else {
                authSection.classList.remove('hidden');
                dataSection.classList.add('hidden');
                statsSection.classList.add('hidden');
                authStatus.textContent = 'Vui lòng kết nối tài khoản Strava của bạn.';
            }
        }

        // --- Xử lý OAuth 2.0 với Strava ---
        document.getElementById('connect-strava-btn').addEventListener('click', () => {
            const redirectUri = window.location.origin + '/Strava/IndexNew.html'; // Hoặc một URL cụ thể nếu bạn muốn
            const scope = 'activity:read_all'; // Quyền truy cập hoạt động chạy bộ
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&response_type=code&redirect_uri=${redirectUri}&approval_prompt=auto&scope=${scope}`;
            window.location.href = authUrl;
        });

        // Xử lý callback từ Strava OAuth
        async function handleStravaCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const authStatus = document.getElementById('auth-status');

            if (code) {
                authStatus.textContent = 'Đang xử lý kết nối Strava...';
                try {
                    // Gửi mã ủy quyền (code) đến Edge Function của Supabase để trao đổi token
                    const response = await fetch(STRAVA_OAUTH_CALLBACK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ code: code, redirect_uri: window.location.origin + '/Strava/IndexNew.html' }),
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        isAuthenticated = true;
                        currentUserId = result.userId; // Edge Function sẽ trả về userId sau khi lưu token
                        authStatus.textContent = 'Kết nối Strava thành công!';
                        showAlert('Kết nối Strava thành công!');
                        // Xóa các tham số OAuth khỏi URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        updateUI();
                    } else {
                        authStatus.textContent = `Lỗi kết nối Strava: ${result.error || 'Không xác định'}`;
                        showAlert(`Lỗi kết nối Strava: ${result.error || 'Không xác định'}`);
                    }
                } catch (error) {
                    console.error('Lỗi khi xử lý Strava callback:', error);
                    authStatus.textContent = 'Lỗi mạng hoặc server khi xử lý Strava callback.';
                    showAlert('Lỗi mạng hoặc server khi xử lý Strava callback.');
                }
            }
        }

        // --- Tải xuống và lưu trữ dữ liệu chạy bộ ---
        document.getElementById('fetch-activities-btn').addEventListener('click', async () => {
            if (!isAuthenticated || !currentUserId) {
                showAlert('Vui lòng kết nối tài khoản Strava trước.');
                return;
            }

            const dataStatus = document.getElementById('data-status');
            dataStatus.textContent = 'Đang tải dữ liệu hoạt động từ Strava...';

            try {
                // Gửi yêu cầu đến Edge Function của Supabase để tải dữ liệu
                const response = await fetch(FETCH_ACTIVITIES_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Thêm token xác thực nếu Edge Function yêu cầu (ví dụ: Firebase ID token)
                        // 'Authorization': `Bearer ${await auth.currentUser.getIdToken()}`
                    },
                    body: JSON.stringify({ userId: currentUserId }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    dataStatus.textContent = `Đã tải ${result.count} hoạt động thành công!`;
                    showAlert(`Đã tải ${result.count} hoạt động thành công!`);
                    displayRecentActivities(result.activities); // Hiển thị các hoạt động mới tải
                } else {
                    dataStatus.textContent = `Lỗi khi tải hoạt động: ${result.error || 'Không xác định'}`;
                    showAlert(`Lỗi khi tải hoạt động: ${result.error || 'Không xác định'}`);
                }
            } catch (error) {
                console.error('Lỗi khi tải hoạt động:', error);
                dataStatus.textContent = 'Lỗi mạng hoặc server khi tải hoạt động.';
                showAlert('Lỗi mạng hoặc server khi tải hoạt động.');
            }
        });

        // Hàm hiển thị các hoạt động gần đây
        function displayRecentActivities(activities) {
            const recentActivitiesList = document.getElementById('recent-activities');
            recentActivitiesList.innerHTML = ''; // Clear previous list

            if (activities && activities.length > 0) {
                activities.slice(0, 5).forEach(activity => { // Show up to 5 recent activities
                    const li = document.createElement('li');
                    li.className = 'border-b last:border-b-0 py-2';
                    li.innerHTML = `
                        <p class="font-semibold">${activity.name}</p>
                        <p>Ngày: ${new Date(activity.start_date).toLocaleDateString()}</p>
                        <p>Quãng đường: ${(activity.distance / 1000).toFixed(2)} km</p>
                        <p>Thời gian: ${formatDuration(activity.moving_time)}</p>
                    `;
                    recentActivitiesList.appendChild(li);
                });
            } else {
                recentActivitiesList.innerHTML = '<li class="text-gray-500">Chưa có hoạt động nào được tải.</li>';
            }
        }

        // Hàm định dạng thời gian (giây thành HH:MM:SS)
        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return [h, m, s].map(v => v < 10 ? "0" + v : v).filter((v, i) => v !== "00" || i > 0).join(":");
        }

        // --- Thống kê và trực quan hóa kết quả ---
        document.getElementById('view-stats-btn').addEventListener('click', async () => {
            if (!isAuthenticated || !currentUserId) {
                showAlert('Vui lòng kết nối tài khoản Strava trước.');
                return;
            }

            const chartStatus = document.getElementById('chart-status');
            chartStatus.textContent = 'Đang tải dữ liệu thống kê...';

            try {
                // Gửi yêu cầu đến Edge Function của Supabase để lấy dữ liệu thống kê
                const response = await fetch(GET_STATS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Thêm token xác thực nếu Edge Function yêu cầu
                    },
                    body: JSON.stringify({ userId: currentUserId }),
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    chartStatus.textContent = 'Đã tải dữ liệu thống kê thành công.';
                    renderBubbleChart(result.weeklyStats); // Vẽ biểu đồ
                } else {
                    chartStatus.textContent = `Lỗi khi tải thống kê: ${result.error || 'Không xác định'}`;
                    showAlert(`Lỗi khi tải thống kê: ${result.error || 'Không xác định'}`);
                }
            } catch (error) {
                console.error('Lỗi khi tải thống kê:', error);
                chartStatus.textContent = 'Lỗi mạng hoặc server khi tải thống kê.';
                showAlert('Lỗi mạng hoặc server khi tải thống kê.');
            }
        });

        // Hàm vẽ biểu đồ bong bóng
        function renderBubbleChart(data) {
            const container = document.getElementById('bubble-chart-container');
            container.innerHTML = ''; // Clear previous chart

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Không có dữ liệu thống kê để hiển thị biểu đồ.</p>';
                return;
            }

            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            // Tạo một nhóm để chứa các bong bóng và di chuyển nó vào giữa
            const g = svg.append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            // Tạo layout pack cho biểu đồ bong bóng
            const pack = d3.pack()
                .size([width, height])
                .padding(2);

            // Chuyển đổi dữ liệu thành định dạng phân cấp mà d3.pack yêu cầu
            // Dữ liệu mẫu: [{ week: '2025-W20', totalDistance: 50000, totalTime: 18000 }]
            const root = d3.hierarchy({ children: data })
                .sum(d => d.totalDistance); // Kích thước bong bóng dựa trên tổng quãng đường

            const nodes = pack(root).leaves();

            const colorScale = d3.scaleLinear()
                .domain([d3.min(data, d => d.totalDistance), d3.max(data, d => d.totalDistance)])
                .range([0, 1]); // Sử dụng để tạo màu sắc dựa trên khoảng cách

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip");

            // Lấy giá trị của biến CSS
            const style = getComputedStyle(document.documentElement);
            const bidvYellow = style.getPropertyValue('--bidv-yellow').trim();
            const bidvGreen = style.getPropertyValue('--bidv-green').trim();

            // Vẽ các bong bóng
            g.selectAll(".bubble")
                .data(nodes)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => d.x - width / 2) // Điều chỉnh vị trí do translate của g
                .attr("cy", d => d.y - height / 2) // Điều chỉnh vị trí do translate của g
                .attr("r", d => d.r)
                .attr("fill", d => {
                    // Sử dụng màu xanh BIDV, có thể điều chỉnh độ sáng/tối dựa trên giá trị
                    const t = colorScale(d.data.totalDistance);
                    return d3.interpolateRgb(bidvGreen, "#003331")(t); // Biến thể màu xanh
                })
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("stroke", bidvYellow).attr("stroke-width", 3);
                    tooltip.style("opacity", 1)
                        .html(`Tuần: ${d.data.week}<br>
                               Quãng đường: ${(d.data.totalDistance / 1000).toFixed(2)} km<br>
                               Thời gian: ${formatDuration(d.data.totalTime)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("stroke", bidvGreen).attr("stroke-width", 2);
                    tooltip.style("opacity", 0);
                });

            // Thêm văn bản vào bong bóng
            g.selectAll(".bubble-text")
                .data(nodes)
                .enter().append("text")
                .attr("class", "bubble-text")
                .attr("x", d => d.x - width / 2)
                .attr("y", d => d.y - height / 2)
                .text(d => {
                    // Hiển thị tuần nếu bong bóng đủ lớn
                    return d.r > 30 ? d.data.week : '';
                })
                .attr("dy", "0.35em"); // Căn giữa theo chiều dọc

            // Xử lý thay đổi kích thước cửa sổ
            window.addEventListener('resize', () => {
                renderBubbleChart(data); // Vẽ lại biểu đồ khi thay đổi kích thước
            });
        }


        // Khi trang tải xong
        window.onload = () => {
            handleStravaCallback(); // Kiểm tra và xử lý callback từ Strava
            checkAuthState(); // Kiểm tra trạng thái xác thực ban đầu
        };

        // --- Cấu hình cho việc sử dụng Firebase Auth (được cung cấp bởi Canvas) ---
        // Đây là phần giả định cho môi trường Canvas.
        // Trong ứng dụng thực tế, bạn sẽ cần Firebase SDK và logic xác thực đầy đủ.
        // const auth = getAuth(); // Lấy đối tượng Auth
        // onAuthStateChanged(auth, (user) => {
        //     if (user) {
        //         currentUserId = user.uid;
        //         isAuthenticated = true;
        //     } else {
        //         currentUserId = null;
        //         isAuthenticated = false;
        //         // Nếu không có token ban đầu, đăng nhập ẩn danh
        //         if (typeof __initial_auth_token === 'undefined') {
        //             signInAnonymously(auth).then(() => {
        //                 console.log("Signed in anonymously.");
        //             }).catch((error) => {
        //                 console.error("Anonymous sign-in failed:", error);
        //             });
        //         }
        //     }
        //     updateUI();
        // });

        // // Sử dụng __initial_auth_token nếu có
        // if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        //     signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
        //         console.error("Error signing in with custom token:", error);
        //     });
        // } else {
        //     // Nếu không có token, onAuthStateChanged sẽ xử lý đăng nhập ẩn danh
        // }

    </script>
</body>
</html>
