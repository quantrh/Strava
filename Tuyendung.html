<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Báo cáo Kết quả Review Hồ sơ Tuyển dụng (AI-Powered)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            transition: opacity 0.3s ease;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal.active, .modal-backdrop.active {
            display: block;
        }
        .table-container {
            max-height: 65vh;
            overflow: auto;
        }
        /* Custom scrollbar */
        .table-container::-webkit-scrollbar, .modal::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track, .modal::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb, .modal::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover, .modal::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        #reportViewContent ul, #interviewQuestionsContent ul {
            list-style-type: none;
            padding-left: 0;
        }
        #reportViewContent ul li, #interviewQuestionsContent ul li {
            margin-bottom: 1em;
        }
        #reportViewContent ul ul, #interviewQuestionsContent ul ul {
            list-style-type: none;
            padding-left: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Trình Quản lý Hồ sơ Ứng viên</h1>
            <p class="text-gray-500 mt-2">Công cụ hỗ trợ review và báo cáo kết quả tuyển dụng tích hợp AI</p>
        </header>

        <details class="bg-white rounded-lg shadow-md p-6 mb-6">
            <summary class="font-semibold text-xl text-gray-700 cursor-pointer flex justify-between items-center">
                <span><i class="fas fa-info-circle mr-2 text-blue-500"></i> Hướng dẫn sử dụng</span>
                <i class="fas fa-chevron-down transform transition-transform"></i>
            </summary>
            <div class="mt-4 prose max-w-none text-gray-600">
                <h4>Chào mừng bạn đến với Trình Quản lý Hồ sơ Ứng viên!</h4>
                <p>Đây là công cụ giúp bạn tự động hóa quy trình sàng lọc và đánh giá CV. Dưới đây là các bước để bắt đầu:</p>
                <ol>
                    <li>
                        <strong>Thêm Ứng viên (Khuyến khích dùng AI):</strong>
                        <ul>
                            <li>Nhấn nút <strong>"Thêm Ứng viên"</strong>.</li>
                            <li>Trong cửa sổ mới, nhấn vào ô chọn file và <strong>chọn một hoặc nhiều file CV</strong> (.pdf, .doc, .docx).</li>
                            <li>Nhấn nút <strong>"Đánh giá"</strong>. AI sẽ tự động đọc, phân tích, điền thông tin, chấm điểm và tạo báo cáo cho từng ứng viên.</li>
                            <li>Sau khi xử lý xong, các ứng viên sẽ được tự động thêm vào danh sách.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Quản lý Danh sách:</strong>
                        <ul>
                            <li>Sử dụng ô <strong>"Tìm theo tên"</strong> hoặc bộ lọc <strong>"Tất cả đánh giá"</strong> để nhanh chóng tìm kiếm ứng viên.</li>
                            <li>Danh sách hiển thị các thông tin tóm tắt như điểm trung bình và kết quả sơ bộ (Đạt, Không đạt, Cân nhắc).</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Xem, Sửa và Xóa:</strong>
                        <ul>
                            <li><i class="fas fa-eye text-green-600"></i> <strong>Xem:</strong> Nhấn để xem báo cáo đánh giá chi tiết do AI tạo ra. Báo cáo sẽ hiện ở bên dưới danh sách.</li>
                            <li><i class="fas fa-edit text-blue-600"></i> <strong>Sửa:</strong> Nhấn để mở lại form chi tiết, bạn có thể xem lại các tiêu chí, điểm số và chỉnh sửa nếu cần.</li>
                            <li><i class="fas fa-trash text-red-600"></i> <strong>Xóa:</strong> Xóa hồ sơ ứng viên khỏi danh sách.</li>
                        </ul>
                    </li>
                     <li>
                        <strong>Chuẩn bị Phỏng vấn:</strong>
                        <ul>
                            <li>Khi đang xem báo cáo của một ứng viên, nhấn nút <strong>"✨ Tạo câu hỏi phỏng vấn"</strong>.</li>
                            <li>AI sẽ đề xuất các câu hỏi phỏng vấn phù hợp dựa trên hồ sơ và vị trí ứng tuyển.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Xuất Báo cáo:</strong>
                        <ul>
                            <li><strong>Xuất ra Word:</strong> Khi đang xem báo cáo chi tiết của một ứng viên, nhấn nút "Xuất ra Word" để tải về file .docx.</li>
                            <li><strong>Xuất Excel:</strong> Nhấn nút "Xuất Excel" trên Bảng điều khiển để tải về danh sách tóm tắt của tất cả ứng viên.</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </details>
        
        <details class="bg-white rounded-lg shadow-md p-6 mb-6">
            <summary class="font-semibold text-xl text-gray-700 cursor-pointer flex justify-between items-center">
                <span><i class="fas fa-bullseye mr-2 text-green-500"></i> Vị trí & Tiêu chí Tuyển dụng</span>
                <i class="fas fa-chevron-down transform transition-transform"></i>
            </summary>
            <div id="job-criteria-section" class="mt-4 text-gray-600">
                <!-- Job criteria will be populated by JS -->
            </div>
        </details>

        <main>
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Bảng điều khiển</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Thao tác -->
                    <div class="flex flex-wrap items-center gap-2 col-span-1 md:col-span-2 lg:col-span-2">
                        <button id="addCandidateBtn" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            <i class="fas fa-plus"></i> Thêm Ứng viên
                        </button>
                        <button id="importBtn" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                           <i class="fas fa-file-excel"></i> Nhập
                        </button>
                        <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls">
                        <button id="exportBtn" class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                           <i class="fas fa-file-export"></i> Xuất Excel
                        </button>
                    </div>
                    <!-- Lọc và Tìm kiếm -->
                    <div class="col-span-1 md:col-span-2 lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                            <label for="searchInput" class="sr-only">Tìm kiếm</label>
                            <input type="text" id="searchInput" placeholder="Tìm theo tên..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                             <label for="filterAssessment" class="sr-only">Lọc theo đánh giá</label>
                             <select id="filterAssessment" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option value="all">Tất cả đánh giá</option>
                                <option value="Đạt">Đạt</option>
                                <option value="Không đạt">Không đạt</option>
                                <option value="Cân nhắc">Cân nhắc</option>
                                <option value="Chưa đánh giá">Chưa đánh giá</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div id="main-content">
                <div id="table-view" class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-2xl font-semibold text-gray-700">Danh sách Ứng viên</h2>
                    </div>
                    <div class="table-container">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3 whitespace-nowrap">STT</th>
                                    <th scope="col" class="px-6 py-3 whitespace-nowrap">Họ và Tên</th>
                                    <th scope="col" class="px-6 py-3 whitespace-nowrap">Vị trí</th>
                                    <th scope="col" class="px-6 py-3 whitespace-nowrap">Điểm TB</th>
                                    <th scope="col" class="px-6 py-3 whitespace-nowrap">Kết quả</th>
                                    <th scope="col" class="px-6 py-3 whitespace-nowrap text-center">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="candidateTableBody">
                                <!-- Dữ liệu ứng viên sẽ được chèn vào đây -->
                            </tbody>
                        </table>
                    </div>
                     <div id="noDataMessage" class="text-center py-12 text-gray-500">
                        <p>Chưa có dữ liệu ứng viên. Vui lòng thêm mới hoặc nhập từ file Excel.</p>
                    </div>
                </div>

                <div id="report-view" class="bg-white rounded-lg shadow-md mt-8 p-6 hidden">
                    <div class="flex justify-between items-center border-b pb-4 mb-4">
                         <h2 id="reportViewTitle" class="text-2xl font-semibold text-gray-700">Báo cáo Đánh giá</h2>
                         <div class="flex items-center gap-4">
                             <button id="generateQuestionsBtn" class="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <i class="fas fa-question-circle"></i> ✨ Tạo câu hỏi phỏng vấn
                            </button>
                            <button id="exportWordBtn" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <i class="fas fa-file-word"></i> Xuất ra Word
                            </button>
                            <button id="closeReportViewBtn" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times fa-lg"></i>
                            </button>
                         </div>
                    </div>
                    <div id="reportViewContent" class="prose max-w-none">
                        <!-- Nội dung báo cáo sẽ được chèn vào đây -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Backdrop -->
    <div id="modalBackdrop" class="modal-backdrop"></div>

    <!-- Modal Form Thêm/Sửa Ứng viên -->
    <div id="candidateModal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-5/6 lg:w-4/5 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b sticky top-0 bg-white z-10">
            <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">Thêm Ứng viên Mới</h3>
        </div>
        <div class="p-6">
            <form id="candidateForm">
                <input type="hidden" id="candidateId">
                
                <h4 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Thông tin cơ bản</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="fullName" class="block mb-2 text-sm font-medium">Họ và Tên</label>
                        <input type="text" id="fullName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="position" class="block mb-2 text-sm font-medium">Vị trí ứng tuyển</label>
                        <input type="text" id="position" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                    </div>
                     <div>
                        <label for="email" class="block mb-2 text-sm font-medium">Email</label>
                        <input type="email" id="email" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="phone" class="block mb-2 text-sm font-medium">Số điện thoại</label>
                        <input type="tel" id="phone" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                    </div>
                </div>

                <h4 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Đánh giá bằng AI</h4>
                 <div class="flex items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg">
                    <input type="file" id="cvFile" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" accept=".pdf,.doc,.docx" multiple>
                    <button type="button" id="aiEvaluateBtn" class="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 whitespace-nowrap">
                        <i class="fas fa-robot"></i> <span id="aiBtnText">Đánh giá</span>
                        <div id="aiLoader" class="loader hidden"></div>
                    </button>
                </div>
                <p id="aiError" class="text-red-500 text-sm mb-4 hidden"></p>
                <p id="aiSuccess" class="text-green-600 text-sm mb-4 hidden"></p>

                <h4 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Bảng Đánh giá Chi tiết</h4>
                <div id="evaluation-table" class="space-y-4">
                    <!-- Evaluation rows will be generated by JS -->
                </div>
                
                <div class="my-6">
                    <label for="notes" class="block mb-2 text-sm font-medium">Ghi chú chung</label>
                    <textarea id="notes" rows="3" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></textarea>
                </div>
                <div class="flex justify-end gap-4 pt-4 border-t sticky bottom-0 bg-white py-4">
                    <button type="button" id="cancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Hủy</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Câu hỏi Phỏng vấn -->
    <div id="interviewModal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
            <h3 class="text-xl font-semibold text-gray-800" id="interviewModalTitle">Câu hỏi Phỏng vấn Gợi ý</h3>
            <button id="closeInterviewModalBtn" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div id="interviewQuestionsContent" class="p-8 prose max-w-none">
            <!-- Nội dung câu hỏi sẽ được chèn vào đây -->
        </div>
        <div class="p-4 border-t sticky bottom-0 bg-white flex justify-end">
             <button id="copyQuestionsBtn" class="flex items-center gap-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                <i class="fas fa-copy"></i> Sao chép
            </button>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // UI Elements
        const addCandidateBtn = document.getElementById('addCandidateBtn');
        const candidateModal = document.getElementById('candidateModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalTitle = document.getElementById('modalTitle');
        const cancelBtn = document.getElementById('cancelBtn');
        const candidateForm = document.getElementById('candidateForm');
        const candidateTableBody = document.getElementById('candidateTableBody');
        const noDataMessage = document.getElementById('noDataMessage');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const searchInput = document.getElementById('searchInput');
        const filterAssessment = document.getElementById('filterAssessment');
        const cvFile = document.getElementById('cvFile');
        const aiEvaluateBtn = document.getElementById('aiEvaluateBtn');
        const aiLoader = document.getElementById('aiLoader');
        const aiBtnText = document.getElementById('aiBtnText');
        const aiError = document.getElementById('aiError');
        const aiSuccess = document.getElementById('aiSuccess');
        const evaluationTable = document.getElementById('evaluation-table');
        const jobCriteriaSection = document.getElementById('job-criteria-section');
        
        const tableView = document.getElementById('table-view');
        const reportView = document.getElementById('report-view');
        const reportViewTitle = document.getElementById('reportViewTitle');
        const reportViewContent = document.getElementById('reportViewContent');
        const closeReportViewBtn = document.getElementById('closeReportViewBtn');
        const exportWordBtn = document.getElementById('exportWordBtn');
        const generateQuestionsBtn = document.getElementById('generateQuestionsBtn');
        
        const interviewModal = document.getElementById('interviewModal');
        const interviewModalTitle = document.getElementById('interviewModalTitle');
        const interviewQuestionsContent = document.getElementById('interviewQuestionsContent');
        const closeInterviewModalBtn = document.getElementById('closeInterviewModalBtn');
        const copyQuestionsBtn = document.getElementById('copyQuestionsBtn');


        // Data
        let candidates = [];
        let currentlyViewingCandidateId = null;
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
        
        const jobCriteriaData = {
            "Chuyên viên Phân tích nghiệp vụ (cấp 5 đến cấp 8) - Nội bộ": {
                "Mô tả công việc": "Thực hiện tiếp nhận yêu cầu, phân tích, đánh giá và tư vấn giải pháp công nghệ theo yêu cầu nghiệp vụ trong lĩnh vực Tiền gửi, Tiền vay, Thanh toán, Kế toán, Quản lý thông tin khách hàng (CIF). Nghiên cứu công nghệ, thị trường, đánh giá nhu cầu khách hàng và các sản phẩm tương tự nhằm đưa ra ý tưởng, giải pháp cải tiến phát triển sản phẩm dịch vụ ngân hàng. Xây dựng tài liệu nghiệp vụ URD, RSD. Xây dựng kịch bản kiểm thử và thực hiện kiểm thử. Thực hiện các yêu cầu phân tích, tích hợp ứng dụng cho toàn hàng. Tham gia triển khai, phát triển các dự án/ công việc liên quan đến các yêu cầu nghiệp vụ về: Tiền gửi, Tiền vay, Thanh toán, Kế toán, Quản lý thông tin khách hàng (CIF), Giao dịch khách hàng. Tham gia đào tạo người dùng, hỗ trợ các vấn đề phát sinh trong quá trình triển khai sản phẩm dịch vụ.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 35 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp các trường đại học hệ chính quy, tập trung, dài hạn (bao gồm đại học văn bằng 2, không bao gồm hình thức học liên thông lên đại học) tại các trường đại học trong nước/nước ngoài/liên kết thuộc các ngành đào tạo sau: Công nghệ thông tin; Hệ thống thông tin quản lý, phân tích nghiệp vụ; Tài chính ngân hàng; Quản trị kinh doanh; Kế toán kiểm toán; Kinh tế quốc tế; Và các lĩnh vực có liên quan.",
                "Trình độ ngoại ngữ, tin học": "Có một trong các chứng chỉ tiếng Anh với số điểm yêu cầu tối thiểu: TOEIC 600, TOEFL CBT 173, TOEFL iBT 61, IELTS 5.5 trở lên. Hoặc tốt nghiệp Đại học chuyên ngành tiếng Anh hệ chính quy; Hoặc có bằng Đại học, Thạc sỹ ở nước ngoài được giảng dạy hoàn toàn bằng tiếng Anh. Có khả năng giao tiếp/làm việc bằng tiếng Anh tốt.",
                "Kinh nghiệm công tác": "Có kinh nghiệm làm việc tối thiểu 02 năm tại BIDV: Tại chi nhánh: đã từng công tác tại các vị trí Chuyên viên Quản lý khách hàng, Kế hoạch tổng hợp, Quản trị tín dụng, Giao dịch khách hàng, quản lý rủi ro, kế toán. Tại TSC: am hiểu các quy trình nghiệp vụ ngân hàng về Tiền gửi, Tiền vay, Thanh toán, Kế toán, quản lý thông tin khách hàng.",
                "Yêu cầu khác": "Kĩ năng: Có kĩ năng tổng hợp, tư duy phản biện; thương thảo, làm việc nhóm; khả năng phân tích tốt. Kỹ năng sử dụng AI trong công việc. Có kinh nghiệm xây dựng tài liệu URD, RSD. Ưu tiên các ứng viên có một trong các chứng chỉ BA (ECBA, CCBA, CBAP, PMI-PBA, CPRE). Ưu tiên ứng viên đã có kinh nghiệm tham gia dự án CoreBanking hoặc các dự án CNTT của BIDV."
            },
            "Chuyên viên Phân tích nghiệp vụ (cấp 5 đến cấp 8) – Ngoài hệ thống": {
                "Mô tả công việc": "Thực hiện tiếp nhận yêu cầu, phân tích, đánh giá và tư vấn giải pháp công nghệ theo yêu cầu nghiệp vụ trong lĩnh vực Tiền gửi, Tiền vay, Thanh toán, Kế toán, Giao dịch khách hàng. Nghiên cứu công nghệ, thị trường, đánh giá nhu cầu khách hàng và các sản phẩm tương tự nhằm đưa ra ý tưởng, giải pháp cải tiến phát triển sản phẩm dịch vụ ngân hàng. Xây dựng tài liệu nghiệp vụ yêu cầu người sử dụng, đặc tả kỹ thuật. Xây dựng kịch bản kiểm thử và thực hiện kiểm thử. Thực hiện các yêu cầu phân tích, tích hợp ứng dụng cho toàn hàng. Tham gia triển khai, phát triển các dự án/ công việc liên quan đến các yêu cầu nghiệp vụ. Tham gia đào tạo người dùng, hỗ trợ các vấn đề phát sinh trong quá trình triển khai sản phẩm dịch vụ.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 35 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp các trường đại học hệ chính quy, tập trung, dài hạn (bao gồm đại học văn bằng 2, không bao gồm hình thức học liên thông lên đại học) tại các trường đại học trong nước/nước ngoài/liên kết thuộc các ngành: CNTT; Hệ thống thông tin quản lý, phân tích nghiệp vụ; Tài chính ngân hàng; Quản trị kinh doanh; Kế toán kiểm toán; Kinh tế quốc tế; và các lĩnh vực có liên quan. Đối với các trường đại học trong nước yêu cầu thuộc danh sách dưới đây: Lĩnh vực Công nghệ Thông tin: 1. Đại học Bách khoa Hà Nội 2. Đại học Bách khoa TP.HCM 3. Đại học Công nghệ – Đại học Quốc gia Hà Nội (UET) 4. Đại học Công nghệ Thông tin – Đại học Quốc gia TP.HCM 5. Học viện Công nghệ Bưu chính Viễn thông 6. Đại học FPT 7. Đại học Khoa học Tự nhiên – Đại học Quốc gia Hà Nội 8. Đại học Khoa học Tự nhiên – Đại học Quốc gia TP.HCM 9. Đại học Bách khoa – Đại học Đà Nẵng. Lĩnh vực Kinh tế: 1. Đại học Ngoại thương (FTU) 2. Đại học Kinh tế Quốc dân (NEU) 3. Đại học Kinh tế TP.HCM (UEH) 4. Đại học Kinh tế – Đại học Quốc gia Hà Nội 5. Đại học Kinh tế – Luật TP.HCM (UEL) 6. Học viện Tài chính 7. Đại học Thương mại 8. Học viện Ngân hàng 9. Đại học Kinh tế – Đại học Đà Nẵng 10. Đại học Kinh tế Tài chính TP.HCM (UEF)",
                "Trình độ ngoại ngữ, tin học": "Có một trong các chứng chỉ tiếng Anh với số điểm yêu cầu tối thiểu: TOEIC 600, TOEFL CBT 173, TOEFL iBT 61, IELTS 5.5 trở lên. Hoặc tốt nghiệp Đại học chuyên ngành tiếng Anh hệ chính quy; Hoặc có bằng Đại học, Thạc sỹ ở nước ngoài được giảng dạy hoàn toàn bằng tiếng Anh. Có khả năng giao tiếp thành thạo bằng tiếng Anh.",
                "Kinh nghiệm công tác": "Có kinh nghiệm làm vị trí Phân tích nghiệp vụ (Business Analysis) hoặc tương đương tối thiểu 02 năm trong các lĩnh vực Tài chính ngân hàng, Tổ chức tài chính, Công ty về CNTT, fintech. Có kiến thức về các sản phẩm, dịch vụ, quy trình trong lĩnh vực ngân hàng. Có kinh nghiệm làm việc với các dự án theo quy trình Agile/Scrum.",
                "Yêu cầu khác": "Kĩ năng: Có kĩ năng tổng hợp, tư duy phản biện; thương thảo, làm việc nhóm; khả năng phân tích tốt. Kỹ năng sử dụng AI trong công việc. Có kinh nghiệm xây dựng tài liệu yêu cầu người sử dụng, đặc tả kỹ thuật; Thành thạo các công cụ Jira, Confluence, Axure, Microsoft Viso, Draw.io. Ưu tiên các ứng viên có một trong các chứng chỉ BA quốc tế (ECBA, CCBA, CBAP, PMI-PBA, CPRE)."
            },
            "Chuyên viên Quản trị hệ thống ứng dụng Core banking (từ cấp 5 đến cấp 7) - Ngoài hệ thống": {
                "Mô tả công việc": "Thực hiện công tác quản trị hệ thống Core Banking của Ngân hàng gồm các công việc chính sau: Đảm bảo hoạt động an toàn, ổn định cho các cấu phần của hệ thống; Cập nhật hệ thống định kỳ; Giám sát, phát hiện và cảnh báo sớm các lỗi; Đánh giá và đề xuất tối ưu hiệu năng; Hỗ trợ kỹ thuật và xử lý lỗi.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 35 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp Đại học chính quy các ngành: CNTT, Điện tử Viễn thông, Toán-Tin, Hệ thống Thông tin, Công nghệ kỹ thuật Điện tử, Khoa học máy tính, Kỹ thuật phần mềm hoặc các chuyên ngành khác có đào tạo lập trình, kỹ thuật phần mềm.",
                "Trình độ ngoại ngữ, tin học": "TOEIC 600 hoặc tương đương. Có khả năng giao tiếp/làm việc bằng tiếng Anh tốt. Sử dụng thành thạo tin học văn phòng.",
                "Kinh nghiệm công tác": "Có tối thiểu 01 năm kinh nghiệm thực hiện quản trị các hệ thống ứng dụng trong doanh nghiệp. Ưu tiên: Có kinh nghiệm quản trị hệ thống ngân hàng lõi tại các Ngân hàng; Có kinh nghiệm quản trị các hệ thống ứng dụng quan trọng, ứng dụng cốt lõi của các doanh nghiệp.",
                "Yêu cầu khác": "Có hiểu biết và khả năng cài đặt, cấu hình, quản trị, sử dụng các công nghệ nền tảng như IBM Websphere Application server, IBM Websphere MQ, Apache Tomcat, Oracle Tuxedo, ElasticSearch, Logstash, Kibana, Grafana là một lợi thế. Có hiểu biết và khả năng cài đặt về giải pháp sẵn sàng, liên tục cho hoạt động của ứng dụng: HA, DR, LB... Ưu tiên đối tượng có các chứng chỉ hoặc đã tham gia các khóa đào tạo về AIX Administrator, LPIC, IBM Websphere."
            },
            "Chuyên viên Quản trị dữ liệu (Cấp 5) - Nội bộ kết hợp ngoài hệ thống": {
                "Mô tả công việc": "Quản lý, giám sát và tối ưu hệ thống dữ liệu và tham số trên Core Banking. Quản lý dữ liệu (xây dựng, phát triển, kiểm soát, cung cấp). Phát triển báo cáo. Quản lý tham số. Quản trị các hệ thống phần mềm ứng dụng tại Core Banking. Hỗ trợ kỹ thuật và xử lý lỗi.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 35 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp Đại học trở lên, hệ chính quy các ngành: CNTT, Điện tử Viễn thông, Toán-Tin, Hệ thống Thông tin, Khoa học máy tính, Tự động hóa, An toàn thông tin, Kỹ thuật phần mềm...",
                "Trình độ ngoại ngữ, tin học": "TOEIC 600 hoặc tương đương (chấp nhận bổ sung trong 24 tháng).",
                "Kinh nghiệm công tác": "Có tối thiểu 01 năm kinh nghiệm tại vị trí tương đương. Ưu tiên: Có kiến thức tốt về hệ thống thông tin Ngân Hàng; Am hiểu hoạt động kinh doanh và các sản phẩm dịch vụ của ngân hàng; am hiểu Core Banking Profile là một lợi thế. Có kiến thức về ngôn ngữ lập trình Python, R, phân tích Big Data, xây dựng mô hình thống kê... sẽ là một lợi thế.",
                "Yêu cầu khác": "Có hiểu biết tốt và kinh nghiệm triển khai thực tế với về các hệ Quản trị CSDL (Oracle, SQL Server, DB2...), CSDL phi quan hệ (GT.M...). Có kinh nghiệm sử dụng và triển khai thực tế với các công cụ ETL (IBM DataStage, Kafka...). Có kinh nghiệm xử lý dữ liệu lớn, kỹ thuật lập trình tốt, nhạy bén số liệu. Có kiến thức tốt về tuning performance câu lệnh SQL, luồng ETL và CSDL."
            },
            "Chuyên viên Điều phối dự án (cấp 5) - Nội bộ kết hợp ngoài hệ thống": {
                "Mô tả công việc": "Thực hiện các công việc điều phối dự án CNTT bao gồm: Xây dựng kế hoạch, cơ cấu tổ chức và lịch trình; Theo dõi, giám sát quá trình triển khai; Quản lý công việc hàng ngày; Đánh giá tình trạng và báo cáo; Đảm bảo sự tham gia của các bên; Đánh giá rủi ro; Xây dựng tờ trình/báo cáo; Phối hợp truyền thông và đào tạo; Lưu trữ tài liệu dự án.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 35 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp Đại học chính quy chuyên ngành kinh tế (Kế toán, Tài chính, Ngân hàng, kinh tế đầu tư, quản trị kinh doanh,...) hoặc Chuyên ngành về CNTT (Công nghệ thông tin, Điện tử Viễn thông, Toán-Tin, Hệ thống Thông tin...).",
                "Trình độ ngoại ngữ, tin học": "TOEIC 600 hoặc tương đương. Có khả năng giao tiếp/làm việc bằng tiếng Anh tốt. Sử dụng thành thạo tin học văn phòng.",
                "Kinh nghiệm công tác": "Đã từng tham gia Quản trị/điều phối dự án CNTT với thời gian tối thiểu 06 tháng.",
                "Yêu cầu khác": "Am hiểu phương pháp Agile/Scrum. Am hiểu về quản trị, khai thác phần mềm Jira/ Confluence. Ưu tiên: Cán bộ có chứng chỉ quốc tế về quản trị dự án như: PMI- PMP/Prince2 hoặc chứng chỉ tương đương. Hoặc Cán bộ đã từng làm công tác Quản trị/điều phối tại dự án Chuyển đổi cốt lõi (Core) cho các Ngân hàng/Công ty tài chính."
            },
            "Chuyên viên Đảm bảo chất lượng (cấp 5) - Nội bộ kết hợp ngoài hệ thống": {
                "Mô tả công việc": "Xây dựng quy trình phát triển phù hợp với yêu cầu của từng dự án. Xây dựng hệ thống tiêu chuẩn quản lý chất lượng. Giám sát, kiểm tra đội phát triển tuân thủ theo đúng quy trình. Phát hiện các lỗi sai sót trong quy trình. Tổng hợp, báo cáo tiến độ, chất lượng. Tham gia đào tạo, hướng dẫn. Tham gia vào hoạt động cải tiến quy trình. Tham gia triển khai các Dự án CNTT.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 35 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp Đại học chính quy các ngành: CNTT, Điện tử Viễn thông, Toán-Tin, Hệ thống Thông tin, Khoa học máy tính, Kỹ thuật phần mềm...",
                "Trình độ ngoại ngữ, tin học": "TOEIC 600 hoặc tương đương. Có khả năng giao tiếp/làm việc bằng tiếng Anh tốt. Sử dụng thành thạo tin học văn phòng.",
                "Kinh nghiệm công tác": "Có 01 năm kinh nghiệm ở vị trí tương đương, nắm vững và đã từng tham gia vào quá trình phát triển dự án phần mềm.",
                "Yêu cầu khác": "Trung thực, cẩn thận, khả năng tương tác tốt. Có kỹ năng làm việc nhóm, ham học hỏi. Kỹ năng giao tiếp tốt, tư duy logic tốt. Ưu tiên: Có kiến thức về CMMI, Agile/Scrum, DevSecOps, Jira/Confluence, automation testing."
            },
            "Chuyên viên phát triển ứng dụng (cấp 5) - Ngoài hệ thống": {
                "Mô tả công việc": "Thực hiện lập trình, tham gia khảo sát, phân tích thiết kế các yêu cầu phát triển phần mềm trên các ứng dụng nền tảng web. Cộng tác với các thành viên của nhóm nghiệp vụ, kỹ thuật khác. Xác định, thực hiện và chia sẻ các giải pháp kỹ thuật. Nghiên cứu, đề xuất áp dụng công nghệ mới.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 30 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp Đại học chính quy các ngành: CNTT, Điện tử Viễn thông, Toán-Tin, Hệ thống Thông tin, Khoa học máy tính, Tự động hóa, An toàn thông tin, Kỹ thuật phần mềm...",
                "Trình độ ngoại ngữ, tin học": "TOEIC 600 hoặc tương đương (chấp nhận bổ sung trong 24 tháng).",
                "Kinh nghiệm công tác": "Có tối thiểu 03 năm kinh nghiệm tại vị trí tương đương. Có ít nhất 3 năm kinh nghiệm làm việc với Angular và có kiến thức vững chắc về HTML, CSS, Typescript, Javascript, hoặc có ít nhất 3 năm kinh nghiệm làm việc với Springboot và có kiến thức vững chắc về Java.",
                "Yêu cầu khác": "Có kinh nghiệm làm việc với Restful APIs, JSON. Hiểu biết về Responsive Design. Kinh nghiệm với Git, SVN. Tư duy logic tốt. Ưu tiên: kinh nghiệm CSDL SQL/NoSQL, lĩnh vực ngân hàng/fintech, Agile, hệ thống chịu tải lớn, Figma."
            },
            "Chuyên viên kiểm thử tự động (cấp 5) - Ngoài hệ thống": {
                "Mô tả công việc": "Thiết kế, phát triển, bảo trì các kịch bản kiểm thử tự động. Làm việc với các công cụ kiểm thử tự động. Thiết lập môi trường kiểm thử và tích hợp CI/CD. Phát triển framework kiểm thử tự động. Phối hợp thực hiện performance testing. Đánh giá, phân tích kết quả, báo cáo lỗi.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 35 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp Đại học chính quy các ngành: CNTT, Điện tử Viễn thông, Toán-Tin, Hệ thống Thông tin, Khoa học máy tính, Tự động hóa, An toàn thông tin, Kỹ thuật phần mềm, hoặc kiểm thử phần mềm.",
                "Trình độ ngoại ngữ, tin học": "TOEIC 600 hoặc tương đương (chấp nhận bổ sung trong 24 tháng).",
                "Kinh nghiệm công tác": "Có tối thiểu 03 năm kinh nghiệm tại vị trí tương tự.",
                "Yêu cầu khác": "Kinh nghiệm làm việc với các công cụ kiểm thử tự động như Selenium, JUnit, TestNG, Appium, Katalon... Kiến thức về ngôn ngữ lập trình (Java, Python, JavaScript...). Hiểu biết về các công cụ kiểm thử hiệu năng (Jmeter, Load Runner...). Hiểu biết về Agile, Scrum. Ưu tiên: có hiểu biết nghiệp vụ tài chính ngân hàng, chứng chỉ ISTQB, kinh nghiệm CI/CD."
            },
            "Chuyên viên Phát triển API và Tích hợp (Cấp 5)": {
                "Mô tả công việc": "Phát triển các dịch vụ tích hợp, kiểm soát, chuẩn hóa và tối ưu các API. Tham gia đánh giá, khảo sát và đề xuất giải pháp cho các ứng dụng có yêu cầu tích hợp vào corebanking. Xây dựng và cung cấp các API tích hợp. Đầu mỗi thực hiện nâng cấp, bảo trì hệ thống.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 27 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp Đại học chính quy tại các trường top đầu (ĐH Bách Khoa HN, ĐHQG HN, HV Bưu chính Viễn thông, HV Kỹ thuật Quân sự, HV Kỹ thuật Mật mã, ĐH Bách Khoa ĐN, ĐH Khoa học Huế, ĐHQG TPHCM, ĐH Sư phạm Kỹ thuật TPHCM, ĐH FPT) ngành CNTT, Điện tử Viễn thông, Toán-Tin...",
                "Trình độ ngoại ngữ, tin học": "TOEIC 600 hoặc tương đương (chấp nhận bổ sung trong 24 tháng).",
                "Kinh nghiệm công tác": "Có kinh nghiệm về Java, Java EE. Có kinh nghiệm làm trên các cơ sở dữ liệu SQL (và/hoặc NoSQL), thiết kế database, xây dựng package, procedure, function. Kiến thức vững trong lập trình phần mềm. Kiến thức về Git/SVN.",
                "Yêu cầu khác": "Kiến thức về API. Tư duy logic tốt. Ưu tiên: kinh nghiệm Agile, IBM Websphere, công cụ test tự động, nghiệp vụ Corebanking, hệ thống chịu tải lớn, Spring boot, Java web service."
            },
            "Chuyên viên Phát triển Core Banking - CBS02 (cấp 5)": {
                "Mô tả công việc": "Thực hiện các nhiệm vụ phát triển phần mềm trên Core Banking của BIDV: tham gia khảo sát, phân tích thiết kế, trực tiếp lập trình. Xử lý các lỗi kỹ thuật. Xây dựng các chức năng tích hợp với các hệ thống bên ngoài core. Cộng tác với các nhóm khác. Đề xuất và phát triển giải pháp công nghệ mới.",
                "Yêu cầu độ tuổi": "Dưới hoặc bằng 27 tuổi.",
                "Trình độ chuyên môn": "Tốt nghiệp Đại học chính quy tại các trường top đầu (ĐH Bách Khoa HN, ĐHQG HN, HV Bưu chính Viễn thông, HV Kỹ thuật Quân sự, HV Kỹ thuật Mật mã, ĐH Bách Khoa ĐN, ĐH Khoa học Huế, ĐHQG TPHCM, ĐH Sư phạm Kỹ thuật TPHCM, ĐH FPT) ngành CNTT, Điện tử Viễn thông, Toán-Tin...",
                "Trình độ ngoại ngữ, tin học": "TOEIC 600 hoặc tương đương (chấp nhận bổ sung trong 24 tháng).",
                "Kinh nghiệm công tác": "Có kinh nghiệm làm trên các cơ sở dữ liệu SQL (và/hoặc NoSQL), thực hiện thiết kế database, xây dựng các package, procedure, function. Có kiến thức về thuật toán xử lý dữ liệu để tối ưu tốc độ xử lý.",
                "Yêu cầu khác": "Có tư duy logic tốt. Có khả năng làm việc độc lập cũng như làm việc theo nhóm. Có khả năng nghiên cứu, học hỏi công nghệ mới. Ưu tiên: kinh nghiệm Agile, phát triển module nghiệp vụ trong Corebanking, xây dựng module cho bài toán dữ liệu lớn."
            }
        };

        // --- Functions ---

        const getApiKey = () => {
            return "AIzaSyBaLi7TzZJ9SwmHilU24SRcV2i7lU6gqdQ";
        };
        
        const toggleModal = (modal, show) => {
            modal.classList.toggle('active', show);
            modalBackdrop.classList.toggle('active', show);
        };

        const showReportView = (show, candidate = null) => {
            reportView.classList.toggle('hidden', !show);
            tableView.classList.toggle('hidden', show);
            currentlyViewingCandidateId = show ? candidate.id : null;

            if (show) {
                reportViewTitle.textContent = `Báo cáo Đánh giá: ${candidate.fullName}`;
                if (candidate.aiReport) {
                    reportViewContent.innerHTML = candidate.aiReport;
                } else {
                    reportViewContent.innerHTML = '<p>Ứng viên này được thêm thủ công, chưa có báo cáo tự động. Vui lòng nhấn Sửa và đánh giá bằng AI nếu muốn.</p>';
                }
                reportView.scrollIntoView({ behavior: 'smooth' });
            } else {
                tableView.scrollIntoView({ behavior: 'smooth' });
            }
        };

        const saveToLocalStorage = () => localStorage.setItem('candidatesData_v14', JSON.stringify(candidates));
        const loadFromLocalStorage = () => {
            const data = localStorage.getItem('candidatesData_v14');
            candidates = data ? JSON.parse(data) : [];
        };

        const calculateScores = (candidate) => {
            if (!candidate.evaluation || candidate.evaluation.length === 0) {
                return { ...candidate, totalScore: 0, averageScore: '0.00', result: 'Chưa đánh giá' };
            }
            let totalScore = 0;
            let scoreCount = 0;
            candidate.evaluation.forEach(item => {
                const score = Number(item.score || 0);
                totalScore += score;
                if (score > 0) scoreCount++;
            });
            const averageScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(2) : '0.00';
            
            let result = 'Chưa đánh giá';
            if (totalScore > 0) {
                 if (averageScore >= 7.5) result = 'Đạt';
                 else if (averageScore < 5) result = 'Không đạt';
                 else result = 'Cân nhắc';
            }
            return { ...candidate, totalScore, averageScore, result };
        };
        
        const createEvaluationUI = (evaluationData = []) => {
            evaluationTable.innerHTML = `
                <div class="grid grid-cols-12 gap-4 font-semibold text-sm text-gray-600 px-2 pb-2 border-b">
                    <div class="col-span-3">Tiêu chí</div>
                    <div class="col-span-3">Yêu cầu</div>
                    <div class="col-span-4">Thông tin đáp ứng (từ CV)</div>
                    <div class="col-span-2 text-center">Điểm</div>
                </div>`;

            if (evaluationData.length === 0) {
                evaluationTable.innerHTML += '<p class="col-span-12 text-center text-gray-500 py-4">Tải CV và nhấn "Đánh giá bằng AI" để tạo bảng tiêu chí.</p>';
                return;
            }

            evaluationData.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-4 items-center border-b py-2 dynamic-eval-row';
                row.innerHTML = `
                    <div class="col-span-3 text-sm font-medium text-gray-900">
                        <input type="text" class="eval-criterion bg-transparent w-full font-semibold" value="${item.criterion || ''}" readonly>
                    </div>
                    <div class="col-span-3">
                        <textarea rows="3" class="eval-requirement bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">${item.requirement || ''}</textarea>
                    </div>
                    <div class="col-span-4">
                        <textarea rows="3" class="eval-evidence bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">${item.evidence || ''}</textarea>
                    </div>
                    <div class="col-span-2">
                        <input type="number" min="0" max="10" class="eval-score bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5 text-center" value="${item.score || 0}">
                    </div>
                `;
                evaluationTable.appendChild(row);
            });
        };

        const renderTable = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const filterValue = filterAssessment.value;

            const processedCandidates = candidates.map(calculateScores);
            const filteredCandidates = processedCandidates.filter(c => 
                (c.fullName || '').toLowerCase().includes(searchTerm) && 
                (filterValue === 'all' || c.result === filterValue)
            );

            candidateTableBody.innerHTML = '';
            noDataMessage.classList.toggle('hidden', filteredCandidates.length > 0);

            filteredCandidates.forEach((candidate, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 font-semibold">${candidate.fullName}</td>
                    <td class="px-6 py-4">${candidate.position}</td>
                    <td class="px-6 py-4 font-bold text-blue-600">${candidate.averageScore}</td>
                    <td class="px-6 py-4">${getResultBadge(candidate.result)}</td>
                    <td class="px-6 py-4 flex gap-3 justify-center">
                        <button class="view-btn text-green-600 hover:text-green-800" data-id="${candidate.id}" title="Xem báo cáo"><i class="fas fa-eye"></i></button>
                        <button class="edit-btn text-blue-600 hover:text-blue-800" data-id="${candidate.id}" title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn text-red-600 hover:text-red-800" data-id="${candidate.id}" title="Xóa"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                candidateTableBody.appendChild(row);
            });
        };

        const getResultBadge = (result) => {
            let colorClass = 'bg-gray-100 text-gray-800';
            if (result === 'Đạt') colorClass = 'bg-green-100 text-green-800';
            else if (result === 'Không đạt') colorClass = 'bg-red-100 text-red-800';
            else if (result === 'Cân nhắc') colorClass = 'bg-yellow-100 text-yellow-800';
            return `<span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${colorClass}">${result}</span>`;
        };

        const readFileContent = async (file) => {
            if (!file) return null;
            const extension = file.name.split('.').pop().toLowerCase();
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (event) => {
                    try {
                        if (extension === 'pdf') {
                            const data = new Uint8Array(event.target.result);
                            const pdf = await pdfjsLib.getDocument({ data }).promise;
                            let text = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                text += content.items.map(item => item.str).join(' ');
                            }
                            resolve(text);
                        } else if (extension === 'docx' || extension === 'doc') {
                            const result = await mammoth.extractRawText({ arrayBuffer: event.target.result });
                            resolve(result.value);
                        } else {
                             reader.onload = (e) => resolve(e.target.result);
                             reader.readAsText(file);
                        }
                    } catch (error) { reject('Không thể đọc nội dung file.'); }
                };
                 reader.onerror = () => reject('Lỗi khi đọc file.');
                 if (extension === 'pdf' || extension === 'docx' || extension === 'doc') { reader.readAsArrayBuffer(file); } 
                 else { reader.readAsText(file); }
            });
        };
        
        const evaluateWithAI = async (resumeText) => {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error("API Key chưa được cung cấp.");
            }
            const prompt = `Bạn là một chuyên gia tuyển dụng. Dựa vào nội dung CV sau đây: "${resumeText}". Hãy thực hiện các yêu cầu sau:
1. Trích xuất thông tin cơ bản: Họ và tên, Vị trí ứng tuyển, Email, Số điện thoại.
2. Xác định các tiêu chí tuyển dụng chính cho vị trí này, bao gồm: Yêu cầu độ tuổi, Trình độ chuyên môn, Trình độ ngoại ngữ/tin học, Kinh nghiệm công tác, và các Yêu cầu khác (nếu có).
3. Với mỗi tiêu chí, hãy trả về một đối tượng chứa:
    - 'criterion': Tên tiêu chí.
    - 'requirement': Yêu cầu của vị trí. Ví dụ: "Tốt nghiệp Đại học ngành CNTT, Toán-Tin, hoặc tương đương".
    - 'evidence': Thông tin cụ thể trích xuất từ CV của ứng viên để chứng minh sự đáp ứng. Ví dụ: "Ứng viên đã tốt nghiệp ngành CNTT". Nếu ứng viên không đáp ứng, ghi "Không có thông tin".
    - 'score': Điểm từ 0 đến 10 dựa trên mức độ đáp ứng.
Hãy trả về một đối tượng JSON duy nhất.`;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    "basicInfo": {
                        "type": "OBJECT",
                        "properties": {
                            "fullName": { "type": "STRING" },
                            "position": { "type": "STRING" },
                            "email": { "type": "STRING" },
                            "phone": { "type": "STRING" }
                        }
                    },
                    "evaluation": {
                        "type": "ARRAY",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "criterion": { "type": "STRING", "description": "Tên tiêu chí (ví dụ: Kinh nghiệm công tác)" },
                                "requirement": { "type": "STRING", "description": "Yêu cầu cụ thể cho vị trí này (ví dụ: 3 năm kinh nghiệm Java)" },
                                "evidence": { "type": "STRING", "description": "Bằng chứng trích từ CV" },
                                "score": { "type": "NUMBER" }
                            },
                             "required": ["criterion", "requirement", "evidence", "score"]
                        }
                    }
                },
                "required": ["basicInfo", "evaluation"]
            };

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: schema }
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error:", errorBody);
                    throw new Error(`Lỗi API: ${errorBody.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (!result.candidates || !result.candidates[0].content) {
                    throw new Error("Phản hồi từ AI không hợp lệ.");
                }
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw new Error("Có lỗi xảy ra trong quá trình đánh giá của AI. Vui lòng kiểm tra lại API Key.");
            }
        };

        const generateAIReport = async (candidate) => {
            const apiKey = getApiKey();
            if (!apiKey) return "<p>Vui lòng nhập API Key để tạo báo cáo.</p>";
            
            const fullCandidateData = calculateScores(candidate);
            const dataString = JSON.stringify(fullCandidateData, null, 2);
            const prompt = `Bạn là một chuyên gia tuyển dụng. Dựa trên dữ liệu JSON về việc đánh giá ứng viên ${fullCandidateData.fullName} cho vị trí ${fullCandidateData.position} sau đây: ${dataString}. Hãy viết một báo cáo đánh giá chuyên nghiệp bằng tiếng Việt, **sử dụng các thẻ HTML để định dạng**.
Báo cáo phải có các phần được đánh số thứ tự như sau:
1.  <h2 style="font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">1. Tổng quan</h2><p>Tóm tắt ngắn gọn về ứng viên và kết quả đánh giá chung. Ví dụ: <strong>Điểm trung bình: ${fullCandidateData.averageScore}</strong>, <strong>Kết quả: ${fullCandidateData.result}</strong>.</p>
2.  <h2 style="font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">2. Phân tích chi tiết</h2><p>Dưới đây là phân tích chi tiết từng tiêu chí đánh giá:</p><ul style="list-style: none; padding: 0;">...</ul>
3.  <h2 style="font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">3. Đánh giá sự phù hợp về kinh nghiệm với mô tả công việc</h2><p>Phân tích sâu về mức độ phù hợp của kinh nghiệm ứng viên so với mô tả công việc của vị trí tuyển dụng.</p>
4.  <h2 style="font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">4. Điểm mạnh</h2><p>...</p>
5.  <h2 style="font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">5. Điểm cần cải thiện</h2><p>...</p>
6.  <h2 style="font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">6. Kết luận và Đề xuất</h2><p>...</p>
7.  <h2 style="font-size: 1.25rem; font-weight: 600; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;">Phụ lục</h2>
    <h3 style="font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem;">1. Tóm tắt quá trình công tác</h3><p>Trích xuất và tóm tắt quá trình công tác của ứng viên từ CV (nếu có). Với mỗi kinh nghiệm, nêu rõ: Tên công ty, thời gian làm việc, vị trí, và các công việc/thành tích chính.</p>
    <h3 style="font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem;">2. Học vấn (Bằng cấp, chứng chỉ)</h3><p>Trích xuất thông tin về trường học, chuyên ngành, xếp loại tốt nghiệp, và các bằng cấp, chứng chỉ liên quan khác.</p>
Trong phần "Phân tích chi tiết", với mỗi tiêu chí, hãy tạo một thẻ <li style="margin-bottom: 1.25rem;">. Bên trong, đầu tiên là thẻ <strong>Tiêu chí (Điểm: X/10)</strong>. Tiếp theo là một <ul style="list-style-type: none; padding-left: 1.25rem; margin-top: 0.5rem;"> lồng nhau với 3 <li> con: <li style="margin-bottom: 0.25rem;"><strong style="color: #4b5563;">Yêu cầu:</strong> [nội dung]</li>, <li style="margin-bottom: 0.25rem;"><strong style="color: #4b5563;">Thông tin ứng viên:</strong> [nội dung]</li>, và <li style="margin-bottom: 0.25rem;"><strong style="color: #4b5563;">Nhận xét:</strong> [nội dung]</li>.
Chỉ trả về chuỗi HTML bên trong, không bao gồm thẻ <html>, <head>, hoặc <body>.`;

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('API request failed');
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error generating AI report:", error);
                throw new Error("Không thể tạo báo cáo tự động.");
            }
        };

        const generateInterviewQuestions = async (candidate) => {
            const apiKey = getApiKey();
            if (!apiKey) return "<p>Vui lòng nhập API Key để tạo câu hỏi.</p>";
            
            const fullCandidateData = calculateScores(candidate);
            const dataString = JSON.stringify(fullCandidateData, null, 2);
            const prompt = `Với vai trò là một nhà tuyển dụng kinh nghiệm, hãy tạo một bộ câu hỏi phỏng vấn cho ứng viên ${fullCandidateData.fullName} ứng tuyển vào vị trí ${fullCandidateData.position}. Dựa vào dữ liệu đánh giá sau: ${dataString}.
Hãy tạo các câu hỏi để:
1.  **Làm rõ các điểm yếu:** Tập trung vào các tiêu chí có điểm thấp (dưới 6) để hiểu rõ hơn về kinh nghiệm và kiến thức của ứng viên.
2.  **Xác thực các điểm mạnh:** Đặt câu hỏi tình huống để kiểm tra xem các kỹ năng được đánh giá cao (từ 8 trở lên) có thực sự vững chắc không.
3.  **Đánh giá sự phù hợp:** Các câu hỏi về hành vi và tình huống để xem sự phù hợp của ứng viên với văn hóa công ty.
Hãy trả về kết quả dưới dạng HTML, phân loại câu hỏi thành các mục: <h2>Câu hỏi hành vi</h2>, <h2>Câu hỏi kỹ thuật/chuyên môn</h2>, <h2>Câu hỏi tình huống</h2>.`;

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('API request failed');
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error generating interview questions:", error);
                throw new Error("Không thể tạo câu hỏi phỏng vấn.");
            }
        };
        
        const renderJobCriteria = () => {
            let html = '';
            for (const position in jobCriteriaData) {
                html += `<div class="mb-6">`;
                html += `<h4 class="font-semibold text-gray-800 text-lg">${position}</h4>`;
                html += `<div class="mt-2 text-sm space-y-2">`;
                for (const criterion in jobCriteriaData[position]) {
                     html += `<div><strong class="text-gray-600">${criterion}:</strong> ${jobCriteriaData[position][criterion]}</div>`;
                }
                html += `</div></div>`;
            }
            jobCriteriaSection.innerHTML = html;
        };

        // --- Event Listeners ---

        addCandidateBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Thêm Ứng viên Mới';
            candidateForm.reset();
            createEvaluationUI([]);
            cvFile.value = '';
            aiError.classList.add('hidden');
            aiSuccess.classList.add('hidden');
            document.getElementById('candidateId').value = '';
            toggleModal(candidateModal, true);
        });

        cancelBtn.addEventListener('click', () => toggleModal(candidateModal, false));
        closeReportViewBtn.addEventListener('click', () => showReportView(false));
        closeInterviewModalBtn.addEventListener('click', () => toggleModal(interviewModal, false));
        
        modalBackdrop.addEventListener('click', () => {
            toggleModal(candidateModal, false);
            toggleModal(interviewModal, false);
        });

        candidateForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('candidateId').value;
            let candidateData = {
                fullName: document.getElementById('fullName').value,
                position: document.getElementById('position').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                notes: document.getElementById('notes').value,
                evaluation: []
            };

            const evalRows = evaluationTable.querySelectorAll('.dynamic-eval-row');
            evalRows.forEach(row => {
                candidateData.evaluation.push({
                    criterion: row.querySelector('.eval-criterion').value,
                    requirement: row.querySelector('.eval-requirement').value,
                    evidence: row.querySelector('.eval-evidence').value,
                    score: row.querySelector('.eval-score').value
                });
            });

            if (id) {
                const index = candidates.findIndex(c => c.id == id);
                if (index !== -1) {
                    candidateData.aiReport = candidates[index].aiReport; // Preserve existing report
                    candidates[index] = { ...candidates[index], ...candidateData };
                }
            } else {
                candidateData.id = Date.now();
                candidates.push(candidateData);
            }

            saveToLocalStorage();
            renderTable();
            toggleModal(candidateModal, false);
        });

        candidateTableBody.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            const candidate = candidates.find(c => c.id == id);
            if (!candidate) return;

            if (target.classList.contains('view-btn')) {
                showReportView(true, candidate);
            }

            if (target.classList.contains('edit-btn')) {
                modalTitle.textContent = 'Chỉnh sửa Thông tin Ứng viên';
                document.getElementById('candidateId').value = candidate.id;
                document.getElementById('fullName').value = candidate.fullName;
                document.getElementById('position').value = candidate.position;
                document.getElementById('email').value = candidate.email;
                document.getElementById('phone').value = candidate.phone;
                document.getElementById('notes').value = candidate.notes;
                cvFile.value = '';
                aiError.classList.add('hidden');
                aiSuccess.classList.add('hidden');
                createEvaluationUI(candidate.evaluation || []);
                toggleModal(candidateModal, true);
            }

            if (target.classList.contains('delete-btn')) {
                if (currentlyViewingCandidateId == candidate.id) {
                    showReportView(false);
                }
                candidates = candidates.filter(c => c.id != id);
                saveToLocalStorage();
                renderTable();
            }
        });
        
        aiEvaluateBtn.addEventListener('click', async () => {
            const files = cvFile.files;
            if (files.length === 0) {
                aiError.textContent = 'Vui lòng chọn ít nhất một file CV để đánh giá.';
                aiError.classList.remove('hidden');
                return;
            }

            aiError.classList.add('hidden');
            aiSuccess.classList.add('hidden');
            aiLoader.classList.remove('hidden');
            aiBtnText.textContent = `Đang xử lý ${files.length} file...`;
            aiEvaluateBtn.disabled = true;

            try {
                let processedCount = 0;
                for (const file of files) {
                    const resumeText = await readFileContent(file);
                    if (!resumeText || resumeText.trim().length < 50) {
                         console.warn(`Skipping file ${file.name}: content too short or unreadable.`);
                         continue;
                    }
                    
                    const evaluationResult = await evaluateWithAI(resumeText);
                    const newCandidate = {
                        id: Date.now() + Math.random(),
                        ...evaluationResult.basicInfo,
                        evaluation: evaluationResult.evaluation,
                        notes: ''
                    };
                    
                    newCandidate.aiReport = await generateAIReport(newCandidate);
                    
                    candidates.push(newCandidate);
                    processedCount++;
                }

                if (processedCount > 0) {
                    saveToLocalStorage();
                    renderTable();
                    aiSuccess.textContent = `Đã xử lý và thêm thành công ${processedCount} ứng viên.`;
                    aiSuccess.classList.remove('hidden');
                    setTimeout(() => toggleModal(candidateModal, false), 2000);
                } else {
                    throw new Error("Không thể xử lý bất kỳ file nào đã chọn.");
                }

            } catch (error) {
                aiError.textContent = error.message;
                aiError.classList.remove('hidden');
            } finally {
                aiLoader.classList.add('hidden');
                aiBtnText.textContent = 'Đánh giá';
                aiEvaluateBtn.disabled = false;
                cvFile.value = '';
            }
        });

        generateQuestionsBtn.addEventListener('click', async () => {
            if (!currentlyViewingCandidateId) return;
            const candidate = candidates.find(c => c.id == currentlyViewingCandidateId);
            if (!candidate) return;

            interviewModalTitle.textContent = `Câu hỏi Phỏng vấn Gợi ý cho ${candidate.fullName}`;
            interviewQuestionsContent.innerHTML = '<div class="flex justify-center items-center p-8"><div class="loader"></div></div>';
            toggleModal(interviewModal, true);

            try {
                const questionsHTML = await generateInterviewQuestions(candidate);
                interviewQuestionsContent.innerHTML = questionsHTML;
            } catch (error) {
                interviewQuestionsContent.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        });

        copyQuestionsBtn.addEventListener('click', () => {
            const textToCopy = interviewQuestionsContent.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                copyQuestionsBtn.innerHTML = '<i class="fas fa-check"></i> Đã sao chép';
                setTimeout(() => {
                    copyQuestionsBtn.innerHTML = '<i class="fas fa-copy"></i> Sao chép';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        });

        exportWordBtn.addEventListener('click', () => {
            if (!currentlyViewingCandidateId) return;
            const candidate = candidates.find(c => c.id == currentlyViewingCandidateId);
            if (!candidate) return;

            const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Báo cáo</title></head><body>`;
            const footer = "</body></html>";
            const sourceHTML = header + reportViewContent.innerHTML + footer;

            const converted = htmlDocx.asBlob(sourceHTML);
            saveAs(converted, `BaoCao_${candidate.fullName.replace(/ /g, '_')}.docx`);
        });

        exportBtn.addEventListener('click', () => {
            const dataToExport = candidates.map((c, index) => {
                const processed = calculateScores(c);
                let record = {
                    'STT': index + 1,
                    'Họ và Tên': processed.fullName,
                    'Vị trí ứng tuyển': processed.position,
                    'Email': processed.email,
                    'SĐT': processed.phone,
                    'Điểm TB': processed.averageScore,
                    'Kết quả': processed.result,
                    'Ghi chú': processed.notes,
                };
                if (c.evaluation) {
                    c.evaluation.forEach(item => {
                        record[item.criterion] = item.score;
                    });
                }
                return record;
            });

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Danh sách ứng viên');
            XLSX.writeFile(workbook, 'BaoCaoTuyenDung_ChiTiet.xlsx');
        });

        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                const newCandidates = json.map(row => ({
                    id: Date.now() + Math.random(),
                    fullName: row['Họ và Tên'] || '',
                    position: row['Vị trí ứng tuyển'] || '',
                    email: row['Email'] || '',
                    phone: row['SĐT'] || '',
                    notes: row['Ghi chú'] || '',
                    evaluation: [] 
                }));

                candidates = [...candidates, ...newCandidates];
                saveToLocalStorage();
                renderTable();
                importFile.value = '';
            };
            reader.readAsArrayBuffer(file);
        });
        
        searchInput.addEventListener('input', renderTable);
        filterAssessment.addEventListener('change', renderTable);

        // --- Initialization ---
        renderJobCriteria();
        loadFromLocalStorage();
        renderTable();
    });
</script>
</body>
</html>
