<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">QUẢN LÝ QUỸ NHÓM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #006B68; /* BIDV Brand Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #005A58; /* Darker BIDV Blue */ }
        .btn-secondary {
            background-color: #E0E7FF; /* Light background */
            color: #006B68; /* BIDV Brand Blue for text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover { background-color: #CCF0EF; /* Lighter BIDV Blue for hover */ }
        .input-field {
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .table-header th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #4B5563;
            border-bottom: 1px solid #E5E7EB;
        }
        .table-row td {
            padding: 0.75rem;
            border-bottom: 1px solid #F3F4F6;
        }
        .balance-positive { color: #10B981; font-weight: 600; } /* Green */
        .balance-negative { color: #EF4444; font-weight: 600; } /* Red */
        .balance-zero { color: #6B7280; } /* Gray */
        .error-message {
            background-color: #FEE2E2;
            color: #DC2626;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .text-right-aligned {
            text-align: right; /* Custom class for right alignment */
        }
        /* Styles for the scroll-to-top button */
        #scroll-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #006B68;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Initially hidden */
            transform: scale(0.8); /* Slightly smaller when hidden */
            z-index: 999; /* Ensure it's above other content */
        }
        #scroll-to-top-btn.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Styles for Word export - ensure table borders are visible */
        /* These styles will be embedded directly into the HTML for Word export */
        .word-export-table {
            border-collapse: collapse;
            width: 100%;
        }
        .word-export-table th,
        .word-export-table td {
            border: 1px solid #e5e7eb; /* Add borders for Word */
            padding: 0.75rem;
            text-align: left;
        }
        .word-export-table th {
            background-color: #f3f4f6; /* Light background for headers */
            font-weight: 600;
        }
        .word-export-table .balance-positive { color: #10B981; }
        .word-export-table .balance-negative { color: #EF4444; }
        .word-export-table .balance-zero { color: #6B7280; }
        .word-export-table .text-right-aligned { text-align: right; }

        /* Camera Modal Specific Styles */
        #camera-modal .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            max-width: 95%;
            width: 600px; /* Max width for camera feed */
        }
        /* Removed video-feed and camera-canvas styles as they are no longer used */
        #uploaded-image-preview { /* Renamed from captured-image */
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        #camera-loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #006B68;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Language Switch Styles */
        .language-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #E0E7FF;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .language-switch button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #006B68;
        }
        .language-switch button.active {
            background-color: #006B68;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Hamburger Menu Specific Styles */
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative; /* Changed to relative to contain absolute menu */
            z-index: 50;
        }
        #hamburger-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        #hamburger-btn:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu {
            position: absolute; /* Changed to absolute */
            top: 100%; /* Position below the navbar */
            left: 1rem;
            margin-top: 0.5rem;
            background-color: #ffffff; /* Added background color */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 12rem;
            overflow: hidden;
            z-index: 60; /* Increased z-index to ensure it's above navbar content */
        }
        #hamburger-menu a {
            display: flex; /* Use flex to align icon and text */
            align-items: center;
            padding: 0.75rem 1rem;
            color: #374151;
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        #hamburger-menu a:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu.hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans text-gray-800">

  
<!-- Navbar with Hamburger Menu -->
<div class="navbar flex items-center">
    <!-- Hamburger button on the left -->
    <button id="hamburger-btn" aria-label="Mở menu">
        <!-- SVG 3-line icon -->
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Hidden menu when not active -->
    <div id="hamburger-menu" class="hidden">
        <a href="CalendarMaker.html">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Tạo Lịch
        </a>
    </div>

    <!-- Logo and Title (pushed to the right) -->
    <div class="flex items-center ml-4 flex-grow">
        <img src="LogoQuy.png" alt="Logo Quản Lý Quỹ Nhóm" class="h-12 w-auto rounded-lg shadow-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/006B68/FFFFFF?text=Logo';">
        <h1 class="text-2xl font-bold text-[#006B68]" data-key="appTitle">QUẢN LÝ QUỸ NHÓM</h1>
    </div>
  <div class="language-switch">
            <button id="lang-vi-btn" data-lang="vi" class="active">VI</button>
            <button id="lang-en-btn" data-lang="en">EN</button>
        </div>

</div>


    <div id="fund-balance-card" class="card mb-8 text-center">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4" data-key="fundBalanceTitle">Số Dư Quỹ Chung</h2>
        <p id="fund-balance-display" class="text-5xl font-extrabold text-green-600">0 VNĐ</p>
    </div>

    <div id="error-message-display" class="error-message mb-4 hidden"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button id="add-member-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
            <span data-key="addMemberBtn">Thêm Thành Viên</span>
        </button>
        <button id="add-transaction-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
            <span data-key="addTransactionBtn">Thêm Giao Dịch</span>
        </button>
        <button id="view-transactions-btn" class="btn-secondary flex items-center justify-center w-full sm:w-auto" onclick="window.location.href='QuycomReportQuan.html'">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd"></path></svg>
            <span data-key="viewHistoryBtn">Xem Lịch Sử</span>
        </button>
        <button id="show-report-selection-btn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v14a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm4.5 9.5a.5.5 0 000 1h5a.5.5 0 000-1h-5zM7 7a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
            <span data-key="reportBtn">Báo Cáo</span>
        </button>
        <button id="get-insights-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            ✨ <span data-key="aiInsightsBtn">AI Nhận xét Quỹ</span>
        </button>
        <button id="get-food-suggestions-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            🍜 <span data-key="foodSuggestionsBtn">Gợi ý món ăn</span>
        </button>
    </div>

    <div id="add-member-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="addMemberTitle">Thêm Thành Viên Mới</h2>
        <form id="add-member-form" class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="member-name-input" name="memberName" data-key="memberNamePlaceholder" placeholder="Tên thành viên" class="input-field flex-grow" required />
            <button type="submit" class="btn-primary flex-shrink-0 w-full sm:w-auto" data-key="addBtn">Thêm</button>
        </form>
    </div>

    <div id="add-transaction-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="addTransactionTitle">Thêm Giao Dịch Mới</h2>
        <form id="add-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-full">
                <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionTypeLabel">Loại Giao Dịch</label>
                <select id="transaction-type" name="transactionType" class="input-field">
                    <option value="contribution" data-key="contributionOption">💵 Đóng Góp</option>
                    <option value="expense" data-key="expenseOption">🍺 Chi Tiêu</option>
                </select>
            </div>

            <div id="expense-type-div" class="col-span-full hidden">
                <label for="expense-type-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="expenseTypeLabel">Loại Chi Tiêu</label>
                <select id="expense-type-select" name="expenseType" class="input-field"></select>
            </div>

            <div id="contributing-member-div" class="col-span-full">
                <label for="member-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="contributingMemberLabel">Thành Viên Đóng Góp</label>
                <select id="member-select" name="contributingMember" class="input-field" required></select>
            </div>

            <div id="involved-members-div" class="col-span-full hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1" data-key="involvedMembersLabel">Thành Viên Tham Gia Chi Tiêu</label>
                <div id="involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                    </div>
            </div>

            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1" data-key="amountLabel">Số Tiền (VNĐ)</label>
                <input type="text" id="amount-input" name="amount" data-key="amountPlaceholder" placeholder="Số tiền" class="input-field text-right" required />
            </div>
            
            <!-- New: Date input field -->
            <div>
                <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionDateLabel">Ngày Giao Dịch</label>
                <input type="datetime-local" id="transaction-date-input" name="transactionDate" class="input-field" required />
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1" data-key="descriptionLabel">Mô Tả</label>
                <textarea id="description-input" name="description" data-key="descriptionPlaceholder" placeholder="Mô tả giao dịch" class="input-field resize-y overflow-auto" rows="3" required></textarea>
                <button type="button" id="ai-describe-btn" class="btn-secondary mt-2 w-full flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.147-1.146A2 2 0 009.172 3H6a2 2 0 00-2 2zM14 8a2 2 0 11-4 0 2 2 0 014 0z" clip-rule="evenodd"></path></svg>
                    <span data-key="aiDescribeBtn">Mô tả AI từ Ảnh/Camera</span>
                </button>
            </div>
            <!-- Hidden input for GPS coordinates -->
            <input type="hidden" id="latitude-input" name="latitude">
            <input type="hidden" id="longitude-input" name="longitude">

            <div class="col-span-full">
                <button type="submit" class="btn-primary w-full" data-key="recordTransactionBtn">Ghi Lại Giao Dịch</button>
            </div>
        </form>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="memberListTitle">Danh Sách Thành Viên</h2>
        <div id="member-list-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="loadingMembers">Đang tải thành viên...</p>
        </div>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="summaryReportTitle">Báo Cáo Tóm Tắt</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
            <div class="p-4 bg-green-50 rounded-lg">
                <p class="text-lg font-medium text-green-700" data-key="totalContributions">Tổng Đóng Góp</p>
                <p id="total-contributions-display" class="text-3xl font-bold text-green-600">0 VNĐ</p>
            </div>
            <div class="p-4 bg-red-50 rounded-lg">
                <p class="text-lg font-medium text-red-700" data-key="totalExpenses">Tổng Chi Tiêu</p>
                <p id="total-expenses-display" class="text-3xl font-bold text-red-600">0 VNĐ</p>
            </div>
        </div>
        <h3 class="text-xl font-semibold mt-8 mb-4 text-[#006B68] text-center" data-key="memberBalanceChartTitle">Số Dư Thành Viên (Biểu Đồ Tròn)</h3>
        <div id="member-balance-pie-chart" class="flex justify-center items-center w-full my-4">
            <p class="text-center text-gray-500 mt-4" data-key="loadingChart">Đang tải biểu đồ...</p>
        </div>

        <h3 class="text-xl font-semibold mt-8 mb-4 text-[#006B68] text-center" data-key="categoryChartsTitle">Thu/Chi Theo Phân Loại (Biểu Đồ Bánh)</h3>
        <div id="category-pie-charts" class="flex flex-col md:flex-row justify-around items-center w-full my-4 gap-8">
            <div id="income-pie-chart-container" class="flex flex-col items-center">
                <h4 class="text-lg font-semibold text-green-700 mb-2" data-key="incomeByCategory">Thu nhập theo loại</h4>
                <p class="text-center text-gray-500 mt-4" data-key="loadingChart">Đang tải biểu đồ...</p>
            </div>
            <div id="expense-pie-chart-container" class="flex flex-col items-center">
                <h4 class="text-lg font-semibold text-red-700 mb-2" data-key="expenseByCategory">Chi tiêu theo loại</h4>
                <p class="text-center text-gray-500 mt-4" data-key="loadingChart">Đang tải biểu đồ...</p>
            </div>
        </div>
    </div>

    <div id="fund-report-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="fundReportTitle">Báo Cáo Quỹ Chung</h2>
        <div class="flex flex-wrap justify-end gap-4 mb-4">
            <button id="export-fund-report-excel" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                <span data-key="exportExcelBtn">Xuất Excel</span>
            </button>
            <button id="export-fund-report-word" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6z" clip-rule="evenodd"></path></svg>
                <span data-key="exportWordBtn">Xuất Word</span>
            </button>
        </div>
        <div id="fund-report-table-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="noTransactionsReport">Chưa có giao dịch nào để báo cáo.</p>
        </div>
    </div>

    <div id="member-reports-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="memberReportsTitle">Báo Cáo Từng Thành Viên</h2>
        <div class="mb-4">
            <label for="select-member-report" class="block text-sm font-medium text-gray-700 mb-1" data-key="selectMemberReportLabel">Chọn Thành Viên:</label>
            <select id="select-member-report" name="selectMemberReport" class="input-field"></select>
        </div>
        <div class="flex flex-wrap justify-end gap-4 mb-4">
            <button id="export-member-report-excel" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                <span data-key="exportExcelBtn">Xuất Excel</span>
            </button>
            <button id="export-member-report-word" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6z" clip-rule="evenodd"></path></svg>
                <span data-key="exportWordBtn">Xuất Word</span>
            </button>
        </div>
        <div id="member-report-table-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="selectMemberToReport">Vui lòng chọn một thành viên để xem báo cáo.</p>
        </div>
    </div>

    <!-- The transactions-section is now removed from here -->

    <div id="edit-transaction-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="editTransactionModalTitle">Chỉnh Sửa Giao Dịch</h2>
            <form id="edit-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full">
                    <label for="edit-transaction-type" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionTypeLabel">Loại Giao Dịch</label>
                    <select id="edit-transaction-type" name="editTransactionType" class="input-field">
                        <option value="contribution" data-key="contributionOption">💵 Đóng Góp</option>
                        <option value="expense" data-key="expenseOption">🍺 Chi Tiêu</option>
                    </select>
                </div>

                <div id="edit-expense-type-div" class="col-span-full hidden">
                    <label for="edit-expense-type-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="expenseTypeLabel">Loại Chi Tiêu</label>
                    <select id="edit-expense-type-select" name="editExpenseType" class="input-field"></select>
                </div>

                <div id="edit-contributing-member-div" class="col-span-full">
                    <label for="edit-member-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="contributingMemberLabel">Thành Viên Đóng Góp</label>
                    <select id="edit-member-select" name="editContributingMember" class="input-field" required></select>
                </div>

                <div id="edit-involved-members-div" class="col-span-full hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-key="involvedMembersLabel">Thành Viên Tham Gia Chi Tiêu</label>
                    <div id="edit-involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                        </div>
                </div>

                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-gray-700 mb-1" data-key="amountLabel">Số Tiền (VNĐ)</label>
                    <input type="text" id="edit-amount-input" name="editAmount" data-key="amountPlaceholder" placeholder="Số tiền" class="input-field text-right" required />
                </div>
                <!-- New: Date input field for edit modal -->
                <div>
                    <label for="edit-transaction-date" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionDateLabel">Ngày Giao Dịch</label>
                    <input type="datetime-local" id="edit-transaction-date-input" name="editTransactionDate" class="input-field" required />
                </div>
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1" data-key="descriptionLabel">Mô Tả</label>
                    <textarea id="edit-description-input" name="editDescription" data-key="descriptionPlaceholder" placeholder="Mô tả giao dịch" class="input-field resize-y overflow-auto" rows="3" required></textarea>
                </div>
                <!-- Hidden inputs for GPS coordinates in edit modal -->
                <input type="hidden" id="edit-latitude-input" name="editLatitude">
                <input type="hidden" id="edit-longitude-input" name="editLongitude">

                <div class="col-span-full flex flex-col sm:flex-row justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-transaction-btn" class="btn-secondary w-full sm:w-auto" data-key="cancelBtn">Hủy</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto" data-key="saveChangesBtn">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="member-details-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 id="member-details-name" class="text-2xl font-semibold mb-6 text-[#006B68]"></h2>
            <div class="mb-4">
                <p class="text-lg font-medium text-gray-700" data-key="currentBalance">Số Dư Hiện Tại:</p>
                <p id="member-details-balance" class="text-3xl font-bold"></p>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-[#006B68]" data-key="relatedTransactions">Các Giao Dịch Liên Quan</h3>
            <div id="member-details-transactions-container" class="overflow-x-auto max-h-80">
                <p class="text-center text-gray-500" data-key="noRelatedTransactions">Chưa có giao dịch nào liên quan đến thành viên này.</p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-member-details-btn" class="btn-primary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-xl font-semibold mb-4 text-gray-800" data-key="confirmationTitle">Xác Nhận</h2>
            <p id="confirmation-message" class="mb-6 text-gray-700"></p>
            <div class="flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" id="cancel-confirmation-btn" class="btn-secondary w-full sm:w-auto" data-key="cancelBtn">Hủy</button>
                <button type="button" id="confirm-action-btn" class="btn-primary w-full sm:w-auto" data-key="confirmBtn">Xác Nhận</button>
            </div>
        </div>
    </div>

    <div id="report-selection-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68] text-center" data-key="selectReportTypeTitle">Chọn Loại Báo Cáo</h2>
            <div class="flex flex-col gap-4">
                <button id="select-fund-report-btn" class="btn-primary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                    <span data-key="fundReportOption">Báo Cáo Quỹ Chung</span>
                </button>
                <button id="select-member-report-btn" class="btn-primary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a4 4 0 00-4 4h8a4 4 0 00-4-4z" clip-rule="evenodd"></path></svg>
                    <span data-key="memberReportOption">Báo Cáo Từng Thành Viên</span>
                </button>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-report-selection-btn" class="btn-secondary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="fund-insights-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="fundInsightsModalTitle">Thông Tin Chi Tiết Quỹ ✨</h2>
            <div id="fund-insights-content">
                </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-insights-btn" class="btn-primary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="food-suggestion-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="foodSuggestionModalTitle">Gợi Ý Món Ăn ✨</h2>

            <!-- Thêm ô nhập liệu địa chỉ và nút -->
            <div class="mb-4">
                <label for="address-input-for-food" class="block text-sm font-medium text-gray-700 mb-1" data-key="addressInputLabel">Hoặc nhập địa chỉ cụ thể:</label>
                <input type="text" id="address-input-for-food" placeholder="Ví dụ: 123 Đường ABC, Quận 1, TP.HCM" class="input-field mb-2" />
                <button id="get-food-suggestions-by-address-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
                    🍜 <span data-key="searchByAddressBtn">Tìm kiếm theo địa chỉ này</span>
                </button>
            </div>

            <div id="food-suggestion-content">
                <!-- Nội dung gợi ý món ăn sẽ được điền vào đây -->
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-food-suggestion-btn" class="btn-primary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-4 text-[#006B68]" data-key="aiDescriptionModalTitle">Mô tả giao dịch bằng AI</h2>
            <input type="file" id="image-upload-input" accept="image/*" class="hidden">
            <img id="uploaded-image-preview" alt="Uploaded Image" class="max-w-full h-auto rounded-md my-4 hidden">
            <div id="camera-loading-spinner" class="hidden"></div>
            <div id="camera-controls" class="flex gap-4 mt-4">
                <button id="cancel-camera-btn" class="btn-secondary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span data-key="cancelBtn">Hủy</span>
                </button>
            </div>
        </div>
    </div>
    <button id="scroll-to-top-btn" data-key="scrollToTopBtn" title="Cuộn lên đầu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
    </button>
    
    <!-- NEW: Authorization Error Modal -->
    <div id="auth-error-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3 text-center">
            <h2 class="text-2xl font-bold mb-4 text-red-600">Lỗi Phân Quyền</h2>
            <p id="auth-error-message" class="mb-6 text-gray-700 text-lg">
                Bạn cần được phân quyền vào chương trình này, liên hệ quantrhvn@gmail.com hoặc số điện thoại 0989073739
            </p>
        </div>
    </div>

    <script>
        // Supabase Client Initialization
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';

        let supabase;
        let authReady = false; 

        // Global state variables
        let members = [];
        let transactions = [];
        let expenseTypes = [];
        let fundBalance = 0;
        let currentErrorMessage = '';
        let selectedMemberForDetails = null;
        let transactionToDelete = null;
        let memberToDelete = null;
        let isGeneratingInsights = false;
        let isGeneratingFoodSuggestions = false;
        
        // NEW: User permissions state
        let userPermissions = { isInvited: false, canEdit: false };

        // Language state
        let currentLanguage = localStorage.getItem('lang') || 'vi';

        // Translations object
        const translations = {
            'vi': {
				addressInputLabel: 'Hoặc nhập địa chỉ cụ thể:',
				searchByAddressBtn: 'Tìm kiếm theo địa chỉ này',
				appTitle: 'QUẢN LÝ QUỸ NHÓM',
                fundBalanceTitle: 'Số Dư Quỹ Chung',
                unitCurrency: 'VNĐ',
                addMemberBtn: 'Thêm Thành Viên',
                addTransactionBtn: 'Thêm Giao Dịch',
                viewHistoryBtn: 'Xem Lịch Sử',
                reportBtn: 'Báo Cáo',
                aiInsightsBtn: 'AI Nhận xét Quỹ',
                foodSuggestionsBtn: 'Gợi ý món ăn',
                addMemberTitle: 'Thêm Thành Viên Mới',
                memberNamePlaceholder: 'Tên thành viên',
                addBtn: 'Thêm',
                addTransactionTitle: 'Thêm Giao Dịch Mới',
                transactionTypeLabel: 'Loại Giao Dịch',
                contributionOption: '💵 Đóng Góp',
                expenseOption: '🍺 Chi Tiêu',
                expenseTypeLabel: 'Loại Chi Tiêu',
                selectExpenseType: 'Chọn loại chi tiêu',
                contributingMemberLabel: 'Thành Viên Đóng Góp',
                involvedMembersLabel: 'Thành Viên Tham Gia Chi Tiêu',
                amountLabel: 'Số Tiền (VNĐ)',
                amountPlaceholder: 'Số tiền',
                transactionDateLabel: 'Ngày Giao Dịch',
                descriptionLabel: 'Mô Tả',
                descriptionPlaceholder: 'Mô tả giao dịch',
                aiDescribeBtn: 'Mô tả AI từ Ảnh/Camera',
                recordTransactionBtn: 'Ghi Lại Giao Dịch',
                memberListTitle: 'Danh Sách Thành Viên',
                loadingMembers: 'Đang tải thành viên...',
                memberNameHeader: 'Tên Thành Viên',
                balanceHeader: 'Số Dư',
                actionHeader: 'Hành Động',
                settleUpBtn: 'Thanh Toán',
                viewDetailsBtn: 'Xem chi tiết',
                noMembers: 'Chưa có thành viên nào. Hãy thêm thành viên!',
                summaryReportTitle: 'Báo Cáo Tóm Tắt',
                totalContributions: 'Tổng Đóng Góp',
                totalExpenses: 'Tổng Chi Tiêu',
                memberBalanceChartTitle: 'Số Dư Thành Viên (Biểu Đồ Tròn)',
                loadingChart: 'Đang tải biểu đồ...',
                categoryChartsTitle: 'Thu/Chi Theo Phân Loại (Biểu Đồ Bánh)',
                incomeByCategory: 'Thu nhập theo loại',
                expenseByCategory: 'Chi tiêu theo loại',
                fundReportTitle: 'Báo Cáo Quỹ Chung',
                exportExcelBtn: 'Xuất Excel',
                exportWordBtn: 'Xuất Word',
                noTransactionsReport: 'Chưa có giao dịch nào để báo cáo.',
                dateHeader: 'Ngày',
                typeHeader: 'Loại',
                descriptionHeader: 'Mô Tả',
                expenseTypeHeader: 'Loại Chi Tiêu',
                relatedMembersHeader: 'Thành Viên Liên Quan',
                amountHeader: 'Số Tiền (VNĐ)',
                memberReportsTitle: 'Báo Cáo Từng Thành Viên',
                selectMemberReportLabel: 'Chọn Thành Viên:',
                selectMemberToReport: 'Vui lòng chọn một thành viên để xem báo cáo.',
                noMemberTransactions: 'Thành viên này chưa có giao dịch nào.',
                transactionHistoryTitle: 'Lịch Sử Giao Dịch',
                loadingTransactions: 'Đang tải giao dịch...',
                noTransactions: 'Chưa có giao dịch nào.',
                editBtn: 'Sửa',
                deleteBtn: 'Xóa',
                editTransactionModalTitle: 'Chỉnh Sửa Giao Dịch',
                cancelBtn: 'Hủy',
                saveChangesBtn: 'Lưu Thay Đổi',
                memberDetailsModalTitle: 'Chi Tiết Thành Viên:',
                currentBalance: 'Số Dư Hiện Tại:',
                relatedTransactions: 'Các Giao Dịch Liên Quan',
                noRelatedTransactions: 'Chưa có giao dịch nào liên quan đến thành viên này.',
                closeBtn: 'Đóng',
                confirmationTitle: 'Xác Nhận',
                confirmBtn: 'Xác Nhận',
                selectReportTypeTitle: 'Chọn Loại Báo Cáo',
                fundReportOption: 'Báo Cáo Quỹ Chung',
                memberReportOption: 'Báo Cáo Từng Thành Viên',
                fundInsightsModalTitle: 'Thông Tin Chi Tiết Quỹ ✨',
                generatingInsights: 'Đang tạo thông tin chi tiết từ AI...',
                noInsights: 'Không thể tạo thông tin chi tiết. Vui lòng thử lại.',
                aiConnectionError: 'Đã xảy ra lỗi khi kết nối với AI. Vui lòng thử lại.',
                foodSuggestionModalTitle: 'Gợi ý món ăn ✨',
                generatingFoodSuggestions: 'Đang tìm kiếm gợi ý món ăn gần bạn...',
                locationError: 'Không thể lấy vị trí hiện tại của bạn. Vui lòng cho phép truy cập vị trí.',
                permissionDenied: 'Bạn đã từ chối quyền truy cập vị trí. Vui lòng cho phép trong cài đặt trình duyệt để nhận gợi ý món ăn.',
                positionUnavailable: 'Thông tin vị trí không khả dụng.',
                timeout: 'Hết thời gian chờ khi cố gắng lấy vị trí.',
                geolocationNotSupported: 'Trình duyệt của bạn không hỗ trợ tính năng định vị địa lý.',
                noFoodSuggestions: 'Không tìm thấy gợi ý món ăn nào.',
                foodSuggestionError: 'Không thể tạo gợi ý món ăn. Vui lòng thử lại.',
                addressLabel: 'Địa chỉ:',
                phoneLabel: 'Điện thoại:',
                ratingLabel: 'Đánh giá:',
                distanceLabel: 'Khoảng cách:',
                descriptionLabelShort: 'Mô tả:',
                menuLabel: 'Menu:',
                viewOnMaps: 'Xem trên Google Maps',
                aiDescriptionModalTitle: 'Mô tả giao dịch bằng AI',
                supaLoadError: 'Lỗi: Thư viện Supabase chưa được tải. Vui lòng kiểm tra kết nối mạng.',
                supabaseConfigWarning: 'Cảnh báo: URL hoặc Khóa Supabase vẫn là giá trị mặc định. Vui lòng thay thế bằng thông tin dự án thực của bạn.',
                supabaseTableError: 'Lỗi: Các bảng dữ liệu (members, transactions, expensetype) chưa được tạo trong Supabase. Vui lòng chạy các script SQL đã cung cấp trước đó.',
                dataLoadError: 'Lỗi khi tải dữ liệu:',
                emptyMemberName: 'Tên thành viên không được để trống.',
                addMemberError: 'Lỗi khi thêm thành viên:',
                settleUpError: 'Lỗi khi thanh toán số dư:',
                invalidAmountDesc: 'Vui lòng nhập số tiền hợp lệ và mô tả.',
                selectContributingMember: 'Vui lòng chọn thành viên đóng góp.',
                selectInvolvedMembers: 'Vui lòng chọn ít nhất một thành viên tham gia chi tiêu.',
                addTransactionError: 'Lỗi khi thêm giao dịch:',
                editInvalidAmountDesc: 'Vui lòng nhập số tiền hợp lệ và mô tả cho giao dịch.',
                editSelectContributingMember: 'Vui lòng chọn thành viên đóng góp cho giao dịch này.',
                editSelectInvolvedMembers: 'Vui lòng chọn ít nhất một thành viên tham gia chi tiêu cho giao dịch này.',
                editTransactionError: 'Lỗi khi sửa giao dịch:',
                confirmDeleteTransaction: 'Bạn có chắc chắn muốn xóa giao dịch "{description}" này không?',
                deleteTransactionError: 'Lỗi khi xóa giao dịch:',
                noBalanceChart: 'Chưa có số dư nào để hiển thị biểu đồ.',
                noCategoryChart: 'Chưa có {type} để hiển thị biểu đồ.',
                chartLegend: 'Chú Thích:',
                chartLegendFor: 'Chú Thích {title}:',
                xlsxLoadError: 'Thư viện XLSX chưa được tải. Vui lòng thử lại sau.',
                selectMemberForExport: 'Vui lòng chọn một thành viên để xuất báo cáo.',
                fileSaverLoadError: 'Thư viện FileSaver.js chưa được tải. Vui lòng thử lại sau.',
                selectMemberForWordExport: 'Vui lòng chọn một thành viên để xuất báo cáo Word.',
                apiError: 'API Error:',
                noImageDescription: 'Could not get image description from AI. Please try again.',
                aiCallError: 'Error calling AI:',
                scrollToTopBtn: ' ↑',
                allMembers: 'All',
                contributionType: 'Contribution',
                expenseType: 'Expense',
                otherCategory: 'Other',
                totalChart: 'Total:',
                deleteMemberBtn: 'Delete',
                confirmDeleteMember: 'Are you sure you want to delete member "{memberName}"? All related transactions will be deleted.',
                deleteMemberError: 'Error deleting member:',
                memberBalanceNotZero: 'Cannot delete member with non-zero balance. Please settle up the balance first.',
                defaultExpenseTypes: 'Food, Transport, Shopping, Entertainment, Health, Education, Other',
                permissionError: 'Bạn không có quyền thực hiện hành động này.',
            }
        };

        // DOM Elements
		const addressInputForFood = document.getElementById('address-input-for-food');
		const getFoodSuggestionsByAddressBtn = document.getElementById('get-food-suggestions-by-address-btn');
        const fundBalanceDisplay = document.getElementById('fund-balance-display');
        const errorMessageDisplay = document.getElementById('error-message-display');
        const addMemberSection = document.getElementById('add-member-section');
        const addTransactionSection = document.getElementById('add-transaction-section');
        const fundReportSection = document.getElementById('fund-report-section');
        const memberReportsSection = document.getElementById('member-reports-section');
        const memberListContainer = document.getElementById('member-list-container');
        const totalContributionsDisplay = document.getElementById('total-contributions-display');
        const totalExpensesDisplay = document.getElementById('total-expenses-display');
        const memberBalancePieChartDiv = document.getElementById('member-balance-pie-chart');
        const categoryPieChartsDiv = document.getElementById('category-pie-charts');

        // Language switch buttons
        const langViBtn = document.getElementById('lang-vi-btn');
        const langEnBtn = document.getElementById('lang-en-btn');

        // Modals
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const memberDetailsModal = document.getElementById('member-details-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const reportSelectionModal = document.getElementById('report-selection-modal');
        const fundInsightsModal = document.getElementById('fund-insights-modal');
        const fundInsightsContent = document.getElementById('fund-insights-content');
        const foodSuggestionModal = document.getElementById('food-suggestion-modal');
        const foodSuggestionContent = document.getElementById('food-suggestion-content');
        const cameraModal = document.getElementById('camera-modal');

        // Forms and Inputs
        const addMemberForm = document.getElementById('add-member-form');
        const memberNameInput = document.getElementById('member-name-input');
        const addTransactionForm = document.getElementById('add-transaction-form');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const expenseTypeDiv = document.getElementById('expense-type-div');
        const expenseTypeSelect = document.getElementById('expense-type-select');
        const contributingMemberDiv = document.getElementById('contributing-member-div');
        const memberSelect = document.getElementById('member-select');
        const involvedMembersDiv = document.getElementById('involved-members-div');
        const involvedMembersCheckboxes = document.getElementById('involved-members-checkboxes');
        const amountInput = document.getElementById('amount-input');
        const transactionDateInput = document.getElementById('transaction-date-input');
        const descriptionInput = document.getElementById('description-input');
        const latitudeInput = document.getElementById('latitude-input');
        const longitudeInput = document.getElementById('longitude-input');
        const aiDescribeBtn = document.getElementById('ai-describe-btn');

        // Camera/Image Upload Elements
        const imageUploadInput = document.getElementById('image-upload-input');
        const uploadedImagePreview = document.getElementById('uploaded-image-preview');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const cameraLoadingSpinner = document.getElementById('camera-loading-spinner');

        // Edit Transaction Form Elements
        let editingTransaction = null;
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type'); 
        const editExpenseTypeDiv = document.getElementById('edit-expense-type-div');
        const editExpenseTypeSelect = document.getElementById('edit-expense-type-select');
        const editContributingMemberDiv = document.getElementById('edit-contributing-member-div');
        const editMemberSelect = document.getElementById('edit-member-select');
        const editInvolvedMembersDiv = document.getElementById('edit-involved-members-div');
        const editInvolvedMembersCheckboxes = document.getElementById('edit-involved-members-checkboxes');
        const editAmountInput = document.getElementById('edit-amount-input');
        const editTransactionDateInput = document.getElementById('edit-transaction-date-input');
        const editDescriptionInput = document.getElementById('edit-description-input');
        const editLatitudeInput = document.getElementById('edit-latitude-input');
        const editLongitudeInput = document.getElementById('edit-longitude-input');
        const cancelEditTransactionBtn = document.getElementById('cancel-edit-transaction-btn');

        // Member Details Modal Elements
        const memberDetailsName = document.getElementById('member-details-name');
        const memberDetailsBalance = document.getElementById('member-details-balance');
        const memberDetailsTransactionsContainer = document.getElementById('member-details-transactions-container');
        const closeMemberDetailsBtn = document.getElementById('close-member-details-btn');

        // Confirmation Modal Elements
        const confirmationMessage = document.getElementById('confirmation-message');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');

        // Report Selection Modal Elements
        const selectFundReportBtn = document.getElementById('select-fund-report-btn');
        const selectMemberReportBtn = document.getElementById('select-member-report-btn');
        const closeReportSelectionBtn = document.getElementById('close-report-selection-btn');

        // Member Report Specific Elements
        const selectMemberReportDropdown = document.getElementById('select-member-report');
        const memberReportTableContainer = document.getElementById('member-report-table-container');
        const exportMemberReportExcelBtn = document.getElementById('export-member-report-excel');
        const exportMemberReportWordBtn = document.getElementById('export-member-report-word');

        // Fund Report Specific Elements
        const fundReportTableContainer = document.getElementById('fund-report-table-container');
        const exportFundReportExcelBtn = document.getElementById('export-fund-report-excel');
        const exportFundReportWordBtn = document.getElementById('export-fund-report-word');

        // Insights Modal Elements
        const closeInsightsBtn = document.getElementById('close-insights-btn');

        // Food Suggestion Modal Elements
        const closeFoodSuggestionBtn = document.getElementById('close-food-suggestion-btn');

        // Scroll to Top Button Element
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

        // --- Language Functions ---
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('lang', lang);
            updateContent();
            updateLanguageButtons();
            renderMemberList();
            renderFundReport();
            renderSelectedMemberReport();
            renderMemberBalancePieChart();
            renderCategoryPieCharts();
            document.getElementById('member-name-input').placeholder = translations[currentLanguage].memberNamePlaceholder;
            document.getElementById('amount-input').placeholder = translations[currentLanguage].amountPlaceholder;
            document.getElementById('description-input').placeholder = translations[currentLanguage].descriptionPlaceholder;
            document.getElementById('edit-amount-input').placeholder = translations[currentLanguage].amountPlaceholder;
            document.getElementById('edit-description-input').placeholder = translations[currentLanguage].descriptionPlaceholder;
            document.getElementById('scroll-to-top-btn').title = translations[currentLanguage].scrollToTopBtn;
        }

        function updateContent() {
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            document.title = translations[currentLanguage].appTitle;
            document.querySelector('#transaction-type option[value="contribution"]').textContent = translations[currentLanguage].contributionOption;
            document.querySelector('#transaction-type option[value="expense"]').textContent = translations[currentLanguage].expenseOption;
            document.querySelector('#edit-transaction-type option[value="contribution"]').textContent = translations[currentLanguage].contributionOption;
            document.querySelector('#edit-transaction-type option[value="expense"]').textContent = translations[currentLanguage].expenseOption;
        }

        function updateLanguageButtons() {
            langViBtn.classList.remove('active');
            langEnBtn.classList.remove('active');
            if (currentLanguage === 'vi') {
                langViBtn.classList.add('active');
            } else {
                langEnBtn.classList.add('active');
            }
        }

        // --- Helper Functions ---
        function formatNumberForDisplay(num) {
            if (typeof num !== 'number' || isNaN(num)) return '';
            const roundedNum = Math.round(num);
            return roundedNum.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        function parseFormattedNumber(formattedValue) {
            const locale = currentLanguage === 'vi' ? 'vi-VN' : 'en-US';
            const formatter = new Intl.NumberFormat(locale, { useGrouping: true, minimumFractionDigits: 0 });
            const parts = formatter.formatToParts(1000.50); 
            let thousandsSeparator = '';
            let decimalSeparator = '';

            for (const part of parts) {
                if (part.type === 'group') thousandsSeparator = part.value;
                else if (part.type === 'decimal') decimalSeparator = part.value;
            }

            let cleanedValue = formattedValue;
            if (thousandsSeparator) {
                const thousandsSeparatorRegex = new RegExp(thousandsSeparator.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                cleanedValue = cleanedValue.replace(thousandsSeparatorRegex, '');
            }
            cleanedValue = cleanedValue.replace(decimalSeparator, '.');
            cleanedValue = cleanedValue.replace(/[^0-9.]/g, '');
            const parsed = parseFloat(cleanedValue);
            return isNaN(parsed) ? 0 : parsed;
        }

        function formatNumberForInput(value) {
            const rawNumber = parseFormattedNumber(value);
            const roundedNum = Math.round(rawNumber);
            return roundedNum.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        function showErrorMessage(message) {
            currentErrorMessage = message;
            errorMessageDisplay.textContent = message;
            errorMessageDisplay.classList.remove('hidden');
        }

        function hideErrorMessage() {
            currentErrorMessage = '';
            errorMessageDisplay.classList.add('hidden');
        }

        function hideAllSections() {
            addMemberSection.classList.add('hidden');
            addTransactionSection.classList.add('hidden');
            fundReportSection.classList.add('hidden');
            memberReportsSection.classList.add('hidden');
            editTransactionModal.classList.add('hidden');
            memberDetailsModal.classList.add('hidden');
            confirmationModal.classList.add('hidden');
            reportSelectionModal.classList.add('hidden');
            fundInsightsModal.classList.add('hidden');
            foodSuggestionModal.classList.add('hidden');
            cameraModal.classList.add('hidden');
            hideErrorMessage();
        }

        function scrollToSection(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // --- NEW AUTHORIZATION FUNCTIONS ---
        
        // Shows the full-screen authorization error
        function showAuthError() {
            // Hide all main content containers
            document.querySelectorAll('.navbar, .card, .flex-col.sm\\:flex-row').forEach(el => {
                // Ensure we don't hide the modal itself or its children
                if (!el.closest('#auth-error-modal')) {
                    el.style.display = 'none';
                }
            });
            // Show the auth error modal
            const authModal = document.getElementById('auth-error-modal');
            if (authModal) {
                authModal.classList.remove('hidden');
            }
        }

        // Applies UI changes based on edit permissions
        function applyEditingPermissions() {
            const canEdit = userPermissions.canEdit;
            console.log(`Applying permissions. Can edit: ${canEdit}`);

            // Toggle visibility of main action buttons
            document.getElementById('add-member-btn').classList.toggle('hidden', !canEdit);
            document.getElementById('add-transaction-btn').classList.toggle('hidden', !canEdit);
            
            // The AI describe button should also be tied to adding a transaction
            document.getElementById('ai-describe-btn').classList.toggle('hidden', !canEdit);
        }


        // --- Supabase and Data Management ---

        function initializeSupabase() {
            console.log("Attempting to initialize Supabase...");
            if (typeof window.supabase === 'undefined') {
                console.error("Supabase library not loaded.");
                showErrorMessage(translations[currentLanguage].supaLoadError);
                return;
            }

            const anonKey = typeof __supabase_key !== 'undefined' ? __supabase_key : SUPABASE_ANON_KEY;
            supabase = window.supabase.createClient(SUPABASE_URL, anonKey);
            console.log("Supabase client created.");

            // NEW: Updated Authentication Flow with Permission Check
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log("onAuthStateChange event:", event);
                if (session && session.user) {
                    console.log("User is logged in:", session.user.email);
                    const userEmail = session.user.email;

                    // Step 1: Check if user's email is in the invited_users_quan table
                    const { data: invitedUser, error: inviteError } = await supabase
                        .from('invited_users_quan')
                        .select('email, "Edit_author"') // Select email and the permission column
                        .eq('email', userEmail)
                        .single(); // Use .single() to expect one result

                    if (inviteError || !invitedUser) {
                        console.error('Authorization Error:', inviteError ? inviteError.message : 'User not found in invited list.');
                        showAuthError(); // Show the specific auth error message and stop execution
                        return;
                    }

                    // Step 2: User is authorized, set permissions based on the 'Edit_author' column
                    userPermissions.isInvited = true;
                    userPermissions.canEdit = invitedUser.Edit_author === true;
                    console.log('User Permissions set:', userPermissions);

                    // Step 3: Proceed with app initialization
                    authReady = true;
                    applyEditingPermissions(); // Hide/show buttons based on permissions
                    fetchData(); // Fetch main app data
                    setupRealtimeSubscriptions(); // Set up real-time listeners

                } else {
                    console.log("User is not logged in, redirecting to login page.");
                    authReady = false;
                    userPermissions = { isInvited: false, canEdit: false }; // Reset permissions
                    window.location.href = window.location.origin + '/Strava/LoginQuan.html';
                }
            });
        }

        async function fetchData() {
            if (!authReady) {
                console.log("Authentication not ready, skipping data fetch.");
                return;
            }
            showLoading(true);
            try {
                const { data: membersData, error: membersError } = await supabase.from('members_quan').select('*');
                if (membersError) throw membersError;

                const { data: transactionsData, error: transactionsError } = await supabase.from('transactions_quan').select('*');
                if (transactionsError) throw transactionsError;

                const { data: expenseTypesData, error: expenseTypesError } = await supabase.from('expensetype_quan').select('*');
                if (expenseTypesError) throw expenseTypesError;

                members = membersData;
                transactions = transactionsData;
                expenseTypes = expenseTypesData;
				
                if (expenseTypes.length === 0) {
                    console.log("No expense types found, populating with default data...");
                    const defaultExpenseTypes = translations[currentLanguage].defaultExpenseTypes.split(', ').map(name => ({ expense_type: name, Type: 'expense' }));
                    defaultExpenseTypes.unshift({ expense_type: translations[currentLanguage].contributionType, Type: 'contribution' });
                    const { data: newExpenseTypes, error: newExpenseTypesError } = await supabase.from('expensetype_quan').insert(defaultExpenseTypes).select();
                    if (newExpenseTypesError) throw newExpenseTypesError;
                    expenseTypes = newExpenseTypes;
                }

                if (members.length === 0 && userPermissions.canEdit) {
                    console.log("No members found, populating with default data...");
                    const initialMembers = [{ name: 'Trương Hồng Quân' }, { name: 'Bùi Hoàng Giang' }, { name: 'Nguyễn Thị Hoa Hậu' }];
                    const { data: newMembers, error: newMembersError } = await supabase.from('members_quan').insert(initialMembers).select();
                    if (newMembersError) throw newMembersError;
                    members = newMembers;

                    const defaultContributionTypeObj = expenseTypes.find(et => et.Type === 'contribution');
                    const defaultContributionType = defaultContributionTypeObj ? defaultContributionTypeObj.expense_type : 'Đóng góp';
                    const defaultExpenseTypeObj = expenseTypes.find(et => et.Type === 'expense');
                    const defaultExpenseType = defaultExpenseTypeObj ? defaultExpenseTypeObj.expense_type : 'Ăn uống';
                    const initialTransactions = [
                        { type: 'contribution', amount: 500000, description: 'Đóng góp ban đầu', date: new Date().toISOString(), contributingMemberId: newMembers[0].id, latitude: null, longitude: null, expense_type: defaultContributionType },
                        { type: 'contribution', amount: 300000, description: 'Đóng góp thêm', date: new Date().toISOString(), contributingMemberId: newMembers[1].id, latitude: null, longitude: null, expense_type: defaultContributionType },
                        { type: 'expense', amount: 150000, description: 'Mua đồ ăn nhẹ', date: new Date().toISOString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id], latitude: null, longitude: null, expense_type: defaultExpenseType },
                        { type: 'contribution', amount: 200000, description: 'Đóng góp tháng 5', date: new Date().toISOString(), contributingMemberId: newMembers[2].id, latitude: null, longitude: null, expense_type: defaultContributionType },
                        { type: 'expense', amount: 250000, description: 'Tiền nước uống', date: new Date().toISOString(), involvedMemberIds: [newMembers[0].id, newMembers[2].id], latitude: null, longitude: null, expense_type: defaultExpenseType },
                        { type: 'expense', amount: 300000, description: 'Đặt cơm trưa', date: new Date().toISOString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id], latitude: null, longitude: null, expense_type: defaultExpenseType },
                    ];
                    const { data: newTransactions, error: newTransactionsError } = await supabase.from('transactions_quan').insert(initialTransactions).select();
                    if (newTransactionsError) throw newTransactionsError;
                    transactions = newTransactions;
                }
                updateUI();
            } catch (error) {
                console.error("Error fetching data from Supabase:", error.message);
                if (error.message.includes('relation "public.')) {
                    showErrorMessage(translations[currentLanguage].supabaseTableError);
                } else {
                    showErrorMessage(`${translations[currentLanguage].dataLoadError} ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        }

        function setupRealtimeSubscriptions() {
            if (!authReady) return;
            supabase.channel('public:members_quan').on('postgres_changes', { event: '*', schema: 'public', table: 'members_quan' }, () => fetchData()).subscribe();
            supabase.channel('public:transactions_quan').on('postgres_changes', { event: '*', schema: 'public', table: 'transactions_quan' }, () => fetchData()).subscribe();
            supabase.channel('public:expensetype').on('postgres_changes', { event: '*', schema: 'public', table: 'expensetype' }, () => fetchData()).subscribe();
        }

        function showLoading(isLoading) {
            // Placeholder for a proper loading overlay
        }

        // --- UI Update Functions ---
        function updateUI() {
            calculateBalances();
            renderFundBalance();
            renderMemberList();
            renderReportingSummary();
            renderMemberReportDropdown();
            renderMemberBalancePieChart();
            renderCategoryPieCharts();
            populateSelectors();
        }

        function calculateBalances() {
            let totalBalance = 0;
            const tempMemberBalances = new Map(members.map(m => [m.id, 0]));

            transactions.forEach(t => {
                if (t.type === 'contribution') {
                    totalBalance += t.amount;
                    if (tempMemberBalances.has(t.contributingMemberId)) {
                        tempMemberBalances.set(t.contributingMemberId, tempMemberBalances.get(t.contributingMemberId) + t.amount);
                    }
                } else if (t.type === 'expense') {
                    totalBalance -= t.amount;
                    const involvedMembers = t.involvedMemberIds && t.involvedMemberIds.length > 0 ? t.involvedMemberIds : members.map(m => m.id);
                    if (involvedMembers.length > 0) {
                        const costPerMember = t.amount / involvedMembers.length;
                        involvedMembers.forEach(memberId => {
                            if (tempMemberBalances.has(memberId)) {
                                tempMemberBalances.set(memberId, tempMemberBalances.get(memberId) - costPerMember);
                            }
                        });
                    }
                }
            });

            members = members.map(member => ({ ...member, balance: tempMemberBalances.get(member.id) || 0 }));
            fundBalance = totalBalance;
        }

        function renderFundBalance() {
            fundBalanceDisplay.textContent = `${formatNumberForDisplay(fundBalance)} ${translations[currentLanguage].unitCurrency}`;
            fundBalanceDisplay.className = 'text-5xl font-extrabold'; // Reset classes
            fundBalanceDisplay.classList.add(fundBalance >= 0 ? 'text-green-600' : 'text-red-600');
        }

        // MODIFIED: renderMemberList with permission check
        function renderMemberList() {
            if (members.length === 0) {
                memberListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noMembers}</p>`;
                return;
            }
            
            const canEdit = userPermissions.canEdit;

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="table-header">${translations[currentLanguage].memberNameHeader}</th>
                            <th class="table-header text-right-aligned">${translations[currentLanguage].balanceHeader}</th>
                            <th class="table-header">${translations[currentLanguage].actionHeader}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            members.forEach(member => {
                const balanceClass = member.balance > 0 ? 'balance-positive' : member.balance < 0 ? 'balance-negative' : 'balance-zero';
                tableHtml += `
                    <tr class="table-row">
                        <td class="font-medium text-gray-900">${member.name}</td>
                        <td class="text-right-aligned">
                            <span class="text-lg font-bold ${balanceClass}">
                                ${formatNumberForDisplay(member.balance)} ${translations[currentLanguage].unitCurrency}
                            </span>
                        </td>
                        <td class="flex flex-col sm:flex-row gap-2">
                            ${canEdit ? `
                                <button data-member-id="${member.id}" class="settle-up-btn text-[#006B68] hover:text-[#005A58] font-semibold text-sm w-full sm:w-auto" ${Math.abs(member.balance) < 0.01 ? 'disabled' : ''}>
                                    ${translations[currentLanguage].settleUpBtn}
                                </button>
                            ` : ''}
                            <button data-member-id="${member.id}" class="view-details-btn text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto">
                                ${translations[currentLanguage].viewDetailsBtn}
                            </button>
                            ${canEdit ? `
                                <button data-member-id="${member.id}" class="delete-member-btn text-red-600 hover:text-red-900 font-semibold text-sm w-full sm:w-auto" ${Math.abs(member.balance) > 0.01 ? 'disabled' : ''}>
                                    ${translations[currentLanguage].deleteBtn}
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            memberListContainer.innerHTML = tableHtml;

            // Attach event listeners
            memberListContainer.querySelectorAll('.view-details-btn').forEach(button => {
                button.onclick = (e) => showMemberDetailsModal(members.find(m => m.id === e.target.dataset.memberId));
            });
            if (canEdit) {
                memberListContainer.querySelectorAll('.settle-up-btn').forEach(button => {
                    button.onclick = (e) => settleUpMember(e.target.dataset.memberId);
                });
                memberListContainer.querySelectorAll('.delete-member-btn').forEach(button => {
                    button.onclick = (e) => confirmDeleteMember(members.find(m => m.id === e.target.dataset.memberId));
                });
            }
        }

        function renderReportingSummary() {
            const totalContributions = transactions.filter(t => t.type === 'contribution').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            totalContributionsDisplay.textContent = `${formatNumberForDisplay(totalContributions)} ${translations[currentLanguage].unitCurrency}`;
            totalExpensesDisplay.textContent = `${formatNumberForDisplay(totalExpenses)} ${translations[currentLanguage].unitCurrency}`;
        }

        function getMemberName(memberId) {
            const member = members.find(m => m.id === memberId);
            return member ? member.name : 'N/A';
        }

        function getInvolvedMembersNames(involvedMemberIds) {
            if (!involvedMemberIds || involvedMemberIds.length === 0) return translations[currentLanguage].allMembers;
            return involvedMemberIds.map(id => getMemberName(id)).join(', ');
        }

        // --- Member Actions (with permission guards) ---
        addMemberForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!userPermissions.canEdit) {
                showErrorMessage(translations[currentLanguage].permissionError);
                return;
            }
            const submitButton = e.submitter;
            submitButton.disabled = true;
            const name = memberNameInput.value.trim();
            if (!name) {
                showErrorMessage(translations[currentLanguage].emptyMemberName);
                submitButton.disabled = false;
                return;
            }
            hideErrorMessage();
            try {
                const { error } = await supabase.from('members_quan').insert({ name: name, balance: 0 });
                if (error) throw error;
                memberNameInput.value = '';
                addMemberSection.classList.add('hidden');
                // Real-time will update UI
            } catch (error) {
                showErrorMessage(`${translations[currentLanguage].addMemberError} ${error.message}`);
            } finally {
                submitButton.disabled = false;
            }
        };

        async function settleUpMember(memberId) {
            if (!userPermissions.canEdit) return;
            const memberToSettle = members.find(m => m.id === memberId);
            if (!memberToSettle || Math.abs(memberToSettle.balance) < 0.01) return;

            const settlementAmount = Math.abs(memberToSettle.balance);
            const settlementType = memberToSettle.balance < 0 ? 'contribution' : 'expense';
            const description = `${translations[currentLanguage].settleUpBtn} ${memberToSettle.name}`;
            try {
                const newTransaction = {
                    type: settlementType,
                    amount: settlementAmount,
                    description: description,
                    date: new Date().toISOString(),
                    contributingMemberId: settlementType === 'contribution' ? memberToSettle.id : null,
                    involvedMemberIds: settlementType === 'expense' ? [memberToSettle.id] : [],
                    expense_type: settlementType === 'expense' ? translations[currentLanguage].otherCategory : null,
                };
                const { error } = await supabase.from('transactions_quan').insert(newTransaction);
                if (error) throw error;
                // Real-time will update UI
            } catch (error) {
                showErrorMessage(`${translations[currentLanguage].settleUpError} ${error.message}`);
            }
        };

        function confirmDeleteMember(member) {
            if (!userPermissions.canEdit || !member) return;
            if (Math.abs(member.balance) > 0.01) {
                showErrorMessage(translations[currentLanguage].memberBalanceNotZero);
                return;
            }
            memberToDelete = member;
            confirmationMessage.textContent = translations[currentLanguage].confirmDeleteMember.replace('{memberName}', member.name);
            confirmationModal.classList.remove('hidden');
            confirmActionBtn.onclick = deleteMemberConfirmed;
        }

        async function deleteMemberConfirmed() {
            if (!userPermissions.canEdit || !memberToDelete) return;
            try {
                // This logic should be handled by RLS and cascading deletes in the DB for robustness.
                // Client-side deletion is for UX.
                const { error } = await supabase.from('members_quan').delete().eq('id', memberToDelete.id);
                if (error) throw error;
            } catch (error) {
                showErrorMessage(`${translations[currentLanguage].deleteMemberError} ${error.message}`);
            }
            confirmationModal.classList.add('hidden');
            memberToDelete = null;
        }

        // --- Transaction Actions (with permission guards) ---
        addTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!userPermissions.canEdit) {
                showErrorMessage(translations[currentLanguage].permissionError);
                return;
            }
            const submitButton = e.submitter;
            submitButton.disabled = true;

            const type = transactionTypeSelect.value;
            const amount = parseFormattedNumber(amountInput.value);
            const transactionDate = transactionDateInput.value;
            const description = descriptionInput.value.trim();
            const contributingMemberId = memberSelect.value;
            const selectedExpenseMembers = Array.from(involvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);
            const latitude = latitudeInput.value ? parseFloat(latitudeInput.value) : null;
            const longitude = longitudeInput.value ? parseFloat(longitudeInput.value) : null;
            const expenseType = expenseTypeSelect.value;

            // Simple validation
            if (isNaN(amount) || amount <= 0 || !description || !transactionDate) {
                showErrorMessage(translations[currentLanguage].invalidAmountDesc);
                submitButton.disabled = false;
                return;
            }
            // More validation...

            hideErrorMessage();
            try {
                const newTransaction = {
                    type, amount, description, latitude, longitude, expense_type,
                    date: new Date(transactionDate).toISOString(),
                    contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                    involvedMemberIds: type === 'expense' ? selectedExpenseMembers : [],
                };
                const { error } = await supabase.from('transactions_quan').insert(newTransaction);
                if (error) throw error;
                addTransactionForm.reset();
                addTransactionSection.classList.add('hidden');
            } catch (error) {
                showErrorMessage(`${translations[currentLanguage].addTransactionError} ${error.message}`);
            } finally {
                submitButton.disabled = false;
            }
        };

        // --- The rest of the script remains largely the same ---
        // (populateSelectors, modals, reports, charts, AI calls, etc.)
        // Ensure to add permission guards to any other action-triggering functions if necessary.
        // For example, the form submission for the edit modal.
        
        editTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!userPermissions.canEdit || !editingTransaction) {
                showErrorMessage(translations[currentLanguage].permissionError);
                return;
            }
            // ... rest of the edit logic
            const submitButton = e.submitter;
            submitButton.disabled = true;

            const type = editTransactionTypeSelect.value;
            const amount = parseFormattedNumber(editAmountInput.value);
            const transactionDate = editTransactionDateInput.value;
            const description = editDescriptionInput.value.trim();
            const contributingMemberId = editMemberSelect.value;
            const involvedMemberIds = Array.from(editInvolvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);
            const latitude = editLatitudeInput.value ? parseFloat(editLatitudeInput.value) : null;
            const longitude = editLongitudeInput.value ? parseFloat(editLongitudeInput.value) : null;
            const expenseType = editExpenseTypeSelect.value;
            
            // Validation...
            
            try {
                const { error } = await supabase
                    .from('transactions_quan')
                    .update({
                        type: type,
                        amount: amount,
                        description: description,
                        date: new Date(transactionDate).toISOString(),
                        contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                        involvedMemberIds: type === 'expense' ? involvedMemberIds : [],
                        latitude: latitude,
                        longitude: longitude,
                        expense_type: expenseType,
                    })
                    .eq('id', editingTransaction.id);
                if (error) throw error;
                editTransactionModal.classList.add('hidden');
                editingTransaction = null;
            } catch (error) {
                showErrorMessage(`${translations[currentLanguage].editTransactionError} ${error.message}`);
            } finally {
                submitButton.disabled = false;
            }
        };
        
        function confirmDeleteTransaction(transaction) {
            if (!userPermissions.canEdit || !transaction) return;
            transactionToDelete = transaction;
            confirmationMessage.textContent = translations[currentLanguage].confirmDeleteTransaction.replace('{description}', transaction.description);
            confirmationModal.classList.remove('hidden');
            confirmActionBtn.onclick = deleteTransactionConfirmed;
        }

        async function deleteTransactionConfirmed() {
            if (!userPermissions.canEdit || !transactionToDelete) return;
            try {
                const { error } = await supabase.from('transactions_quan').delete().eq('id', transactionToDelete.id);
                if (error) throw error;
            } catch (error) {
                showErrorMessage(`${translations[currentLanguage].deleteTransactionError} ${error.message}`);
            }
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
        }

        // --- All other functions (UI, helpers, charts, etc.) go here ---
        // They are omitted for brevity but should be copied from your original file.
        // The following are placeholders for the functions that need to be present.
        
        function populateSelectors() {
            memberSelect.innerHTML = '';
            involvedMembersCheckboxes.innerHTML = '';
            if (members.length === 0) {
                memberSelect.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                involvedMembersCheckboxes.innerHTML = `<p class="text-gray-500 text-sm">${translations[currentLanguage].noMembers}</p>`;
            } else {
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    memberSelect.appendChild(option);
                    const label = document.createElement('label');
                    label.className = 'inline-flex items-center cursor-pointer';
                    label.innerHTML = `<input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] rounded focus:ring-[#006B68]" value="${member.id}"><span class="ml-2 text-sm text-gray-700">${member.name}</span>`;
                    involvedMembersCheckboxes.appendChild(label);
                });
                if (members.length > 0) memberSelect.value = members[0].id;
            }
            populateExpenseTypeSelect(expenseTypeSelect, transactionTypeSelect.value);
            editMemberSelect.innerHTML = '';
            editInvolvedMembersCheckboxes.innerHTML = '';
            if (members.length === 0) {
                editMemberSelect.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                editInvolvedMembersCheckboxes.innerHTML = `<p class="text-gray-500 text-sm">${translations[currentLanguage].noMembers}</p>`;
            } else {
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    editMemberSelect.appendChild(option);
                    const label = document.createElement('label');
                    label.className = 'inline-flex items-center cursor-pointer';
                    label.innerHTML = `<input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] rounded focus:ring-[#006B68]" value="${member.id}"><span class="ml-2 text-sm text-gray-700">${member.name}</span>`;
                    editInvolvedMembersCheckboxes.appendChild(label);
                });
            }
            populateExpenseTypeSelect(editExpenseTypeSelect, editTransactionTypeSelect.value);
        }
        function populateExpenseTypeSelect(selectElement, transactionType) {
            selectElement.innerHTML = '';
            let filteredTypes = expenseTypes.filter(type => type.Type === transactionType);
            if (filteredTypes.length === 0) {
                selectElement.innerHTML = `<option value="">${translations[currentLanguage].selectExpenseType}</option>`;
            } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = translations[currentLanguage].selectExpenseType;
                selectElement.appendChild(defaultOption);
                filteredTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.expense_type;
                    option.textContent = type.expense_type;
                    selectElement.appendChild(option);
                });
            }
        }
        transactionTypeSelect.onchange = () => {
            const expenseTypeLabelElement = expenseTypeDiv.querySelector('label[data-key="expenseTypeLabel"]');
            const selectedTransactionType = transactionTypeSelect.value;
            if (selectedTransactionType === 'contribution') {
                contributingMemberDiv.classList.remove('hidden');
                memberSelect.setAttribute('required', 'true');
                involvedMembersDiv.classList.add('hidden');
                involvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(c => { c.checked = false; c.removeAttribute('required'); });
                expenseTypeDiv.classList.remove('hidden');
                expenseTypeSelect.setAttribute('required', 'true');
                if (expenseTypeLabelElement) expenseTypeLabelElement.textContent = "Loại thu";
                populateExpenseTypeSelect(expenseTypeSelect, 'contribution');
                expenseTypeSelect.value = '';
            } else {
                contributingMemberDiv.classList.add('hidden');
                memberSelect.removeAttribute('required');
                memberSelect.value = '';
                involvedMembersDiv.classList.remove('hidden');
                expenseTypeDiv.classList.remove('hidden');
                expenseTypeSelect.setAttribute('required', 'true');
                if (expenseTypeLabelElement) expenseTypeLabelElement.textContent = translations[currentLanguage].expenseTypeLabel;
                populateExpenseTypeSelect(expenseTypeSelect, 'expense');
                const defaultExpenseOption = expenseTypes.find(et => et.Type === 'expense');
                if (defaultExpenseOption) expenseTypeSelect.value = defaultExpenseOption.expense_type;
                else expenseTypeSelect.value = '';
            }
        };
        function showEditTransactionModal(transaction) {
            if (!userPermissions.canEdit) return;
            editingTransaction = transaction;
            editTransactionModal.classList.remove('hidden');
            hideErrorMessage();
            editTransactionTypeSelect.value = transaction.type;
            editAmountInput.value = formatNumberForInput(transaction.amount.toString());
            const d = new Date(transaction.date);
            editTransactionDateInput.value = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}T${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            editDescriptionInput.value = transaction.description;
            editLatitudeInput.value = transaction.latitude || '';
            editLongitudeInput.value = transaction.longitude || '';
            const expenseTypeLabelElement = editExpenseTypeDiv.querySelector('label[data-key="expenseTypeLabel"]');
            if (transaction.type === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input').forEach(c => c.removeAttribute('required'));
                editMemberSelect.value = transaction.contributingMemberId || '';
                editExpenseTypeDiv.classList.remove('hidden');
                editExpenseTypeSelect.setAttribute('required', 'true');
                if (expenseTypeLabelElement) expenseTypeLabelElement.textContent = "Loại thu";
                populateExpenseTypeSelect(editExpenseTypeSelect, 'contribution');
                editExpenseTypeSelect.value = transaction.expense_type || '';
            } else {
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input').forEach(c => c.checked = false);
                if (transaction.involvedMemberIds) {
                    transaction.involvedMemberIds.forEach(id => {
                        const checkbox = editInvolvedMembersCheckboxes.querySelector(`input[value="${id}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                editExpenseTypeDiv.classList.remove('hidden');
                editExpenseTypeSelect.setAttribute('required', 'true');
                if (expenseTypeLabelElement) expenseTypeLabelElement.textContent = translations[currentLanguage].expenseTypeLabel;
                populateExpenseTypeSelect(editExpenseTypeSelect, 'expense');
                editExpenseTypeSelect.value = transaction.expense_type || '';
            }
        }
        editTransactionTypeSelect.onchange = () => {
            const editExpenseTypeLabelElement = editExpenseTypeDiv.querySelector('label[data-key="expenseTypeLabel"]');
            if (editTransactionTypeSelect.value === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input').forEach(c => { c.checked = false; c.removeAttribute('required'); });
                editExpenseTypeDiv.classList.remove('hidden');
                editExpenseTypeSelect.setAttribute('required', 'true');
                if (editExpenseTypeLabelElement) editExpenseTypeLabelElement.textContent = "Loại thu";
                populateExpenseTypeSelect(editExpenseTypeSelect, 'contribution');
                editExpenseTypeSelect.value = '';
            } else {
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input').forEach(c => c.checked = false);
                editExpenseTypeDiv.classList.remove('hidden');
                editExpenseTypeSelect.setAttribute('required', 'true');
                if (editExpenseTypeLabelElement) editExpenseTypeLabelElement.textContent = translations[currentLanguage].expenseTypeLabel;
                populateExpenseTypeSelect(editExpenseTypeSelect, 'expense');
                if (editExpenseTypeSelect.value === '' && expenseTypes.length > 0) {
                    editExpenseTypeSelect.value = expenseTypes.find(et => et.Type === 'expense')?.expense_type || '';
                }
            }
        };
        cancelConfirmationBtn.onclick = () => {
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
            memberToDelete = null;
            confirmActionBtn.onclick = deleteTransactionConfirmed;
        };
        function showMemberDetailsModal(member) { /* Omitted for brevity */ }
        function renderFundReport() { /* Omitted for brevity */ }
        function renderMemberReportDropdown() { /* Omitted for brevity */ }
        function renderSelectedMemberReport() { /* Omitted for brevity */ }
        function renderMemberBalancePieChart() { /* Omitted for brevity */ }
        function renderCategoryPieCharts() { /* Omitted for brevity */ }
        async function callSupabaseEdgeFunction(functionName, dataPayload) { /* Omitted for brevity */ }
        async function generateFundInsights() { /* Omitted for brevity */ }
        async function generateFoodSuggestions(latitude, longitude, addressString = null) { /* Omitted for brevity */ }
        async function callGeminiVisionAPI(base64ImageData) { /* Omitted for brevity */ }
        
        // --- Event Listeners ---
        document.getElementById('add-member-btn').onclick = () => { hideAllSections(); addMemberSection.classList.remove('hidden'); scrollToSection('add-member-section'); };
        document.getElementById('add-transaction-btn').onclick = () => {
            hideAllSections();
            addTransactionSection.classList.remove('hidden');
            transactionTypeSelect.value = 'contribution';
            transactionTypeSelect.onchange();
            const now = new Date();
            transactionDateInput.value = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}T${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            scrollToSection('add-transaction-section');
        };
        document.getElementById('show-report-selection-btn').onclick = () => { hideAllSections(); reportSelectionModal.classList.remove('hidden'); };
        document.getElementById('get-insights-btn').onclick = () => { hideAllSections(); fundInsightsModal.classList.remove('hidden'); generateFundInsights(); };
        document.getElementById('get-food-suggestions-btn').onclick = () => { hideAllSections(); foodSuggestionModal.classList.remove('hidden'); getGeolocationAndSuggestFood(); };
        selectFundReportBtn.onclick = () => { hideAllSections(); fundReportSection.classList.remove('hidden'); renderFundReport(); scrollToSection('fund-report-section'); };
        selectMemberReportBtn.onclick = () => { hideAllSections(); memberReportsSection.classList.remove('hidden'); renderMemberReportDropdown(); scrollToSection('member-reports-section'); };
        closeReportSelectionBtn.onclick = () => reportSelectionModal.classList.add('hidden');
        cancelEditTransactionBtn.onclick = () => { editTransactionModal.classList.add('hidden'); editingTransaction = null; };
        closeMemberDetailsBtn.onclick = () => { memberDetailsModal.classList.add('hidden'); selectedMemberForDetails = null; };
        closeInsightsBtn.onclick = () => fundInsightsModal.classList.add('hidden');
        closeFoodSuggestionBtn.onclick = () => foodSuggestionModal.classList.add('hidden');
        getFoodSuggestionsByAddressBtn.onclick = () => {
            const address = addressInputForFood.value.trim();
            if (address) generateFoodSuggestions(null, null, address);
            else showErrorMessage(translations[currentLanguage].locationError);
        };
        aiDescribeBtn.onclick = () => {
            hideAllSections();
            cameraModal.classList.remove('hidden');
            uploadedImagePreview.classList.add('hidden');
            imageUploadInput.value = '';
            imageUploadInput.click();
        };
        imageUploadInput.onchange = (event) => { /* Omitted for brevity */ };
        cancelCameraBtn.onclick = () => { /* Omitted for brevity */ };
        amountInput.oninput = (e) => { /* Omitted for brevity */ };
        editAmountInput.oninput = (e) => { /* Omitted for brevity */ };
        selectMemberReportDropdown.onchange = () => renderSelectedMemberReport();
        function getGeolocationAndSuggestFood() { /* Omitted for brevity */ }
        window.onscroll = function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) scrollToTopBtn.classList.add('show');
            else scrollToTopBtn.classList.remove('show');
        };
        scrollToTopBtn.onclick = function() { window.scrollTo({ top: 0, behavior: 'smooth' }); };
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLanguage);
            initializeSupabase();
        });
        document.getElementById('hamburger-btn').addEventListener('click', function() {
            document.getElementById('hamburger-menu').classList.toggle('hidden');
        });
    </script>
</body>
</html>
