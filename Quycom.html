<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">QU·∫¢N L√ù QU·ª∏ NH√ìM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #006B68; /* BIDV Brand Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #005A58; /* Darker BIDV Blue */ }
        .btn-secondary {
            background-color: #E0E7FF; /* Light background */
            color: #006B68; /* BIDV Brand Blue for text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover { background-color: #CCF0EF; /* Lighter BIDV Blue for hover */ }
        .input-field {
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .table-header th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #4B5563;
            border-bottom: 1px solid #E5E7EB;
        }
        .table-row td {
            padding: 0.75rem;
            border-bottom: 1px solid #F3F4F6;
        }
        .balance-positive { color: #10B981; font-weight: 600; } /* Green */
        .balance-negative { color: #EF4444; font-weight: 600; } /* Red */
        .balance-zero { color: #6B7280; } /* Gray */
        .error-message {
            background-color: #FEE2E2;
            color: #DC2626;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .text-right-aligned {
            text-align: right; /* Custom class for right alignment */
        }
        /* Styles for the scroll-to-top button */
        #scroll-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #006B68;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Initially hidden */
            transform: scale(0.8); /* Slightly smaller when hidden */
            z-index: 999; /* Ensure it's above other content */
        }
        #scroll-to-top-btn.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Styles for Word export - ensure table borders are visible */
        /* These styles will be embedded directly into the HTML for Word export */
        .word-export-table {
            border-collapse: collapse;
            width: 100%;
        }
        .word-export-table th,
        .word-export-table td {
            border: 1px solid #e5e7eb; /* Add borders for Word */
            padding: 0.75rem;
            text-align: left;
        }
        .word-export-table th {
            background-color: #f3f4f6; /* Light background for headers */
            font-weight: 600;
        }
        .word-export-table .balance-positive { color: #10B981; }
        .word-export-table .balance-negative { color: #EF4444; }
        .word-export-table .balance-zero { color: #6B7280; }
        .word-export-table .text-right-aligned { text-align: right; }

        /* Camera Modal Specific Styles */
        #camera-modal .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            max-width: 95%;
            width: 600px; /* Max width for camera feed */
        }
        /* Removed video-feed and camera-canvas styles as they are no longer used */
        #uploaded-image-preview { /* Renamed from captured-image */
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        #camera-controls {
            display: flex;
            gap: 1rem;
            width: 100%;
            justify-content: center;
        }
        #camera-loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #006B68;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Language Switch Styles */
        .language-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #E0E7FF;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .language-switch button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #006B68;
        }
        .language-switch button.active {
            background-color: #006B68;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Hamburger Menu Specific Styles */
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative; /* Changed to relative to contain absolute menu */
            z-index: 50;
        }
        #hamburger-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        #hamburger-btn:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu {
            position: absolute; /* Changed to absolute */
            top: 100%; /* Position below the navbar */
            left: 1rem;
            margin-top: 0.5rem;
            background-color: #ffffff; /* Added background color */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 12rem;
            overflow: hidden;
            z-index: 60; /* Increased z-index to ensure it's above navbar content */
        }
        #hamburger-menu a {
            display: flex; /* Use flex to align icon and text */
            align-items: center;
            padding: 0.75rem 1rem;
            color: #374151;
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        #hamburger-menu a:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu.hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans text-gray-800">

  
<!-- Navbar c√≥ Hamburger Menu -->
<div class="navbar flex items-center">
    <!-- N√∫t hamburger ·ªü tr√°i -->
    <button id="hamburger-btn" aria-label="M·ªü menu">
        <!-- Icon SVG 3 g·∫°ch -->
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Menu ·∫©n khi ch∆∞a b·∫≠t -->
    <div id="hamburger-menu" class="hidden">
        <a href="CalendarMaker.html">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            T·∫°o L·ªãch
        </a>
    </div>

    <!-- Logo v√† Ti√™u ƒë·ªÅ (ƒë·∫©y sang ph·∫£i) -->
    <div class="flex items-center ml-4 flex-grow">
        <img src="LogoQuy.png" alt="Logo Qu·∫£n L√Ω Qu·ªπ Nh√≥m" class="h-12 w-auto rounded-lg shadow-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/006B68/FFFFFF?text=Logo';">
        <h1 class="text-2xl font-bold text-[#006B68]" data-key="appTitle">QU·∫¢N L√ù QU·ª∏ NH√ìM</h1>
    </div>
  <div class="language-switch">
            <button id="lang-vi-btn" data-lang="vi" class="active">VI</button>
            <button id="lang-en-btn" data-lang="en">EN</button>
        </div>

</div>


    <div id="fund-balance-card" class="card mb-8 text-center">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4" data-key="fundBalanceTitle">S·ªë D∆∞ Qu·ªπ Chung</h2>
        <p id="fund-balance-display" class="text-5xl font-extrabold text-green-600">0 VNƒê</p>
    </div>

    <div id="error-message-display" class="error-message mb-4 hidden"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button id="add-member-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
            <span data-key="addMemberBtn">Th√™m Th√†nh Vi√™n</span>
        </button>
        <button id="add-transaction-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
            <span data-key="addTransactionBtn">Th√™m Giao D·ªãch</span>
        </button>
        <button id="view-transactions-btn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd"></path></svg>
            <span data-key="viewHistoryBtn">Xem L·ªãch S·ª≠</span>
        </button>
        <button id="show-report-selection-btn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v14a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm4.5 9.5a.5.5 0 000 1h5a.5.5 0 000-1h-5zM7 7a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
            <span data-key="reportBtn">B√°o C√°o</span>
        </button>
        <button id="get-insights-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            ‚ú® <span data-key="aiInsightsBtn">AI Nh·∫≠n x√©t Qu·ªπ</span>
        </button>
        <button id="get-food-suggestions-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            üçú <span data-key="foodSuggestionsBtn">G·ª£i √Ω m√≥n ƒÉn</span>
        </button>
    </div>

    <div id="add-member-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="addMemberTitle">Th√™m Th√†nh Vi√™n M·ªõi</h2>
        <form id="add-member-form" class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="member-name-input" name="memberName" data-key="memberNamePlaceholder" placeholder="T√™n th√†nh vi√™n" class="input-field flex-grow" required />
            <button type="submit" class="btn-primary flex-shrink-0 w-full sm:w-auto" data-key="addBtn">Th√™m</button>
        </form>
    </div>

    <div id="add-transaction-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="addTransactionTitle">Th√™m Giao D·ªãch M·ªõi</h2>
        <form id="add-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-full">
                <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionTypeLabel">Lo·∫°i Giao D·ªãch</label>
                <select id="transaction-type" name="transactionType" class="input-field">
                    <option value="contribution" data-key="contributionOption">üíµ ƒê√≥ng G√≥p</option>
                    <option value="expense" data-key="expenseOption">üç∫ Chi Ti√™u</option>
                </select>
            </div>

            <div id="contributing-member-div" class="col-span-full">
                <label for="member-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="contributingMemberLabel">Th√†nh Vi√™n ƒê√≥ng G√≥p</label>
                <select id="member-select" name="contributingMember" class="input-field" required></select>
            </div>

            <div id="involved-members-div" class="col-span-full hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1" data-key="involvedMembersLabel">Th√†nh Vi√™n Tham Gia Chi Ti√™u</label>
                <div id="involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                    </div>
            </div>

            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1" data-key="amountLabel">S·ªë Ti·ªÅn (VNƒê)</label>
                <input type="text" id="amount-input" name="amount" data-key="amountPlaceholder" placeholder="S·ªë ti·ªÅn" class="input-field text-right" required />
            </div>
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1" data-key="descriptionLabel">M√¥ T·∫£</label>
                <textarea id="description-input" name="description" data-key="descriptionPlaceholder" placeholder="M√¥ t·∫£ giao d·ªãch" class="input-field resize-y overflow-auto" rows="3" required></textarea>
                <button type="button" id="ai-describe-btn" class="btn-secondary mt-2 w-full flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.147-1.146A2 2 0 009.172 3H6a2 2 0 00-2 2zM14 8a2 2 0 11-4 0 2 2 0 014 0z" clip-rule="evenodd"></path></svg>
                    <span data-key="aiDescribeBtn">M√¥ t·∫£ AI t·ª´ ·∫¢nh/Camera</span>
                </button>
                </div>
            <div class="col-span-full">
                <button type="submit" class="btn-primary w-full" data-key="recordTransactionBtn">Ghi L·∫°i Giao D·ªãch</button>
            </div>
        </form>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="memberListTitle">Danh S√°ch Th√†nh Vi√™n</h2>
        <div id="member-list-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="loadingMembers">ƒêang t·∫£i th√†nh vi√™n...</p>
        </div>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="summaryReportTitle">B√°o C√°o T√≥m T·∫Øt</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
            <div class="p-4 bg-green-50 rounded-lg">
                <p class="text-lg font-medium text-green-700" data-key="totalContributions">T·ªïng ƒê√≥ng G√≥p</p>
                <p id="total-contributions-display" class="text-3xl font-bold text-green-600">0 VNƒê</p>
            </div>
            <div class="p-4 bg-red-50 rounded-lg">
                <p class="text-lg font-medium text-red-700" data-key="totalExpenses">T·ªïng Chi Ti√™u</p>
                <p id="total-expenses-display" class="text-3xl font-bold text-red-600">0 VNƒê</p>
            </div>
        </div>
        <h3 class="text-xl font-semibold mt-8 mb-4 text-[#006B68] text-center" data-key="memberBalanceChartTitle">S·ªë D∆∞ Th√†nh Vi√™n (Bi·ªÉu ƒê·ªì Tr√≤n)</h3>
        <div id="member-balance-pie-chart" class="flex justify-center items-center w-full my-4">
            <p class="text-center text-gray-500 mt-4" data-key="loadingChart">ƒêang t·∫£i bi·ªÉu ƒë·ªì...</p>
        </div>

        <h3 class="text-xl font-semibold mt-8 mb-4 text-[#006B68] text-center" data-key="categoryChartsTitle">Thu/Chi Theo Ph√¢n Lo·∫°i (Bi·ªÉu ƒê·ªì B√°nh)</h3>
        <div id="category-pie-charts" class="flex flex-col md:flex-row justify-around items-center w-full my-4 gap-8">
            <div id="income-pie-chart-container" class="flex flex-col items-center">
                <h4 class="text-lg font-semibold text-green-700 mb-2" data-key="incomeByCategory">Thu nh·∫≠p theo lo·∫°i</h4>
                <p class="text-center text-gray-500 mt-4" data-key="loadingChart">ƒêang t·∫£i bi·ªÉu ƒë·ªì...</p>
            </div>
            <div id="expense-pie-chart-container" class="flex flex-col items-center">
                <h4 class="text-lg font-semibold text-red-700 mb-2" data-key="expenseByCategory">Chi ti√™u theo lo·∫°i</h4>
                <p class="text-center text-gray-500 mt-4" data-key="loadingChart">ƒêang t·∫£i bi·ªÉu ƒë·ªì...</p>
            </div>
        </div>
    </div>

    <div id="fund-report-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="fundReportTitle">B√°o C√°o Qu·ªπ Chung</h2>
        <div class="flex flex-wrap justify-end gap-4 mb-4">
            <button id="export-fund-report-excel" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                <span data-key="exportExcelBtn">Xu·∫•t Excel</span>
            </button>
            <button id="export-fund-report-word" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6z" clip-rule="evenodd"></path></svg>
                <span data-key="exportWordBtn">Xu·∫•t Word</span>
            </button>
        </div>
        <div id="fund-report-table-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="noTransactionsReport">Ch∆∞a c√≥ giao d·ªãch n√†o ƒë·ªÉ b√°o c√°o.</p>
        </div>
    </div>

    <div id="member-reports-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="memberReportsTitle">B√°o C√°o T·ª´ng Th√†nh Vi√™n</h2>
        <div class="mb-4">
            <label for="select-member-report" class="block text-sm font-medium text-gray-700 mb-1" data-key="selectMemberReportLabel">Ch·ªçn Th√†nh Vi√™n:</label>
            <select id="select-member-report" name="selectMemberReport" class="input-field"></select>
        </div>
        <div class="flex flex-wrap justify-end gap-4 mb-4">
            <button id="export-member-report-excel" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                <span data-key="exportExcelBtn">Xu·∫•t Excel</span>
            </button>
            <button id="export-member-report-word" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6z" clip-rule="evenodd"></path></svg>
                <span data-key="exportWordBtn">Xu·∫•t Word</span>
            </button>
        </div>
        <div id="member-report-table-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="selectMemberToReport">Vui l√≤ng ch·ªçn m·ªôt th√†nh vi√™n ƒë·ªÉ xem b√°o c√°o.</p>
        </div>
    </div>

    <div id="transactions-section" class="card hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="transactionHistoryTitle">L·ªãch S·ª≠ Giao D·ªãch</h2>
        <div id="transaction-list-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="loadingTransactions">ƒêang t·∫£i giao d·ªãch...</p>
        </div>
    </div>

    <div id="edit-transaction-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="editTransactionModalTitle">Ch·ªânh S·ª≠a Giao D·ªãch</h2>
            <form id="edit-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full">
                    <label for="edit-transaction-type" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionTypeLabel">Lo·∫°i Giao D·ªãch</label>
                    <select id="edit-transaction-type" name="editTransactionType" class="input-field">
                        <option value="contribution" data-key="contributionOption">üíµ ƒê√≥ng G√≥p</option>
                        <option value="expense" data-key="expenseOption">üç∫ Chi Ti√™u</option>
                    </select>
                </div>

                <div id="edit-contributing-member-div" class="col-span-full">
                    <label for="edit-member-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="contributingMemberLabel">Th√†nh Vi√™n ƒê√≥ng G√≥p</label>
                    <select id="edit-member-select" name="editContributingMember" class="input-field" required></select>
                </div>

                <div id="edit-involved-members-div" class="col-span-full hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-key="involvedMembersLabel">Th√†nh Vi√™n Tham Gia Chi Ti√™u</label>
                    <div id="edit-involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                        </div>
                </div>

                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-gray-700 mb-1" data-key="amountLabel">S·ªë Ti·ªÅn (VNƒê)</label>
                    <input type="text" id="edit-amount-input" name="editAmount" data-key="amountPlaceholder" placeholder="S·ªë ti·ªÅn" class="input-field text-right" required />
                </div>
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1" data-key="descriptionLabel">M√¥ T·∫£</label>
                    <textarea id="edit-description-input" name="editDescription" data-key="descriptionPlaceholder" placeholder="M√¥ t·∫£ giao d·ªãch" class="input-field resize-y overflow-auto" rows="3" required></textarea>
                    </div>
                <div class="col-span-full flex flex-col sm:flex-row justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-transaction-btn" class="btn-secondary w-full sm:w-auto" data-key="cancelBtn">H·ªßy</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto" data-key="saveChangesBtn">L∆∞u Thay ƒê·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="member-details-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 id="member-details-name" class="text-2xl font-semibold mb-6 text-[#006B68]"></h2>
            <div class="mb-4">
                <p class="text-lg font-medium text-gray-700" data-key="currentBalance">S·ªë D∆∞ Hi·ªán T·∫°i:</p>
                <p id="member-details-balance" class="text-3xl font-bold"></p>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-[#006B68]" data-key="relatedTransactions">C√°c Giao D·ªãch Li√™n Quan</h3>
            <div id="member-details-transactions-container" class="overflow-x-auto max-h-80">
                <p class="text-center text-gray-500" data-key="noRelatedTransactions">Ch∆∞a c√≥ giao d·ªãch n√†o li√™n quan ƒë·∫øn th√†nh vi√™n n√†y.</p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-member-details-btn" class="btn-primary" data-key="closeBtn">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-xl font-semibold mb-4 text-gray-800" data-key="confirmationTitle">X√°c Nh·∫≠n</h2>
            <p id="confirmation-message" class="mb-6 text-gray-700"></p>
            <div class="flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" id="cancel-confirmation-btn" class="btn-secondary w-full sm:w-auto" data-key="cancelBtn">H·ªßy</button>
                <button type="button" id="confirm-action-btn" class="btn-primary w-full sm:w-auto" data-key="confirmBtn">X√°c Nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="report-selection-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68] text-center" data-key="selectReportTypeTitle">Ch·ªçn Lo·∫°i B√°o C√°o</h2>
            <div class="flex flex-col gap-4">
                <button id="select-fund-report-btn" class="btn-primary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                    <span data-key="fundReportOption">B√°o C√°o Qu·ªπ Chung</span>
                </button>
                <button id="select-member-report-btn" class="btn-primary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a4 4 0 00-4 4h8a4 4 0 00-4-4z" clip-rule="evenodd"></path></svg>
                    <span data-key="memberReportOption">B√°o C√°o T·ª´ng Th√†nh Vi√™n</span>
                </button>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-report-selection-btn" class="btn-secondary" data-key="closeBtn">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="fund-insights-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="fundInsightsModalTitle">Th√¥ng Tin Chi Ti·∫øt Qu·ªπ ‚ú®</h2>
            <div id="fund-insights-content">
                </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-insights-btn" class="btn-primary" data-key="closeBtn">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="food-suggestion-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="foodSuggestionModalTitle">G·ª£i √ù M√≥n ƒÇn ‚ú®</h2>
            <div id="food-suggestion-content">
                </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-food-suggestion-btn" class="btn-primary" data-key="closeBtn">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-4 text-[#006B68]" data-key="aiDescriptionModalTitle">M√¥ t·∫£ giao d·ªãch b·∫±ng AI</h2>
            <input type="file" id="image-upload-input" accept="image/*" class="hidden">
            <img id="uploaded-image-preview" alt="Uploaded Image" class="max-w-full h-auto rounded-md my-4 hidden">
            <div id="camera-loading-spinner" class="hidden"></div>
            <div id="camera-controls" class="flex gap-4 mt-4">
                <button id="cancel-camera-btn" class="btn-secondary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span data-key="cancelBtn">H·ªßy</span>
                </button>
            </div>
        </div>
    </div>
    <button id="scroll-to-top-btn" data-key="scrollToTopBtn" title="Cu·ªôn l√™n ƒë·∫ßu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
    </button>

    <script>
        // Supabase Client Initialization
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your actual Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Replace with your actual Supabase Anon Key
        let supabase;

        // Global state variables (mimicking React state)
        let members = [];
        let transactions = [];
        let fundBalance = 0;
        let currentErrorMessage = '';
        let selectedMemberForDetails = null;
        let transactionToDelete = null;
        let memberToDelete = null; // New global variable for member to delete
        let isGeneratingInsights = false;
        let isGeneratingFoodSuggestions = false;

        // Language state
        let currentLanguage = localStorage.getItem('lang') || 'vi'; // Default to Vietnamese

        // Translations object
        const translations = {
            'vi': {
                appTitle: 'QU·∫¢N L√ù QU·ª∏ NH√ìM',
                fundBalanceTitle: 'S·ªë D∆∞ Qu·ªπ Chung',
                unitCurrency: 'VNƒê',
                addMemberBtn: 'Th√™m Th√†nh Vi√™n',
                addTransactionBtn: 'Th√™m Giao D·ªãch',
                viewHistoryBtn: 'Xem L·ªãch S·ª≠',
                reportBtn: 'B√°o C√°o',
                aiInsightsBtn: 'AI Nh·∫≠n x√©t Qu·ªπ',
                foodSuggestionsBtn: 'G·ª£i √Ω m√≥n ƒÉn',
                addMemberTitle: 'Th√™m Th√†nh Vi√™n M·ªõi',
                memberNamePlaceholder: 'T√™n th√†nh vi√™n',
                addBtn: 'Th√™m',
                addTransactionTitle: 'Th√™m Giao D·ªãch M·ªõi',
                transactionTypeLabel: 'Lo·∫°i Giao D·ªãch',
                contributionOption: 'üíµ ƒê√≥ng G√≥p',
                expenseOption: 'üç∫ Chi Ti√™u',
                contributingMemberLabel: 'Th√†nh Vi√™n ƒê√≥ng G√≥p',
                involvedMembersLabel: 'Th√†nh Vi√™n Tham Gia Chi Ti√™u',
                amountLabel: 'S·ªë Ti·ªÅn (VNƒê)',
                amountPlaceholder: 'S·ªë ti·ªÅn',
                descriptionLabel: 'M√¥ T·∫£',
                descriptionPlaceholder: 'M√¥ t·∫£ giao d·ªãch',
                aiDescribeBtn: 'M√¥ t·∫£ AI t·ª´ ·∫¢nh/Camera',
                recordTransactionBtn: 'Ghi L·∫°i Giao D·ªãch',
                memberListTitle: 'Danh S√°ch Th√†nh Vi√™n',
                loadingMembers: 'ƒêang t·∫£i th√†nh vi√™n...',
                memberNameHeader: 'T√™n Th√†nh Vi√™n',
                balanceHeader: 'S·ªë D∆∞',
                actionHeader: 'H√†nh ƒê·ªông',
                settleUpBtn: 'Thanh To√°n',
                viewDetailsBtn: 'Xem chi ti·∫øt',
                noMembers: 'Ch∆∞a c√≥ th√†nh vi√™n n√†o. H√£y th√™m th√†nh vi√™n!',
                summaryReportTitle: 'B√°o C√°o T√≥m T·∫Øt',
                totalContributions: 'T·ªïng ƒê√≥ng G√≥p',
                totalExpenses: 'T·ªïng Chi Ti√™u',
                memberBalanceChartTitle: 'S·ªë D∆∞ Th√†nh Vi√™n (Bi·ªÉu ƒê·ªì Tr√≤n)',
                loadingChart: 'ƒêang t·∫£i bi·ªÉu ƒë·ªì...',
                categoryChartsTitle: 'Thu/Chi Theo Ph√¢n Lo·∫°i (Bi·ªÉu ƒê·ªì B√°nh)',
                incomeByCategory: 'Thu nh·∫≠p theo lo·∫°i',
                expenseByCategory: 'Chi ti√™u theo lo·∫°i',
                fundReportTitle: 'B√°o C√°o Qu·ªπ Chung',
                exportExcelBtn: 'Xu·∫•t Excel',
                exportWordBtn: 'Xu·∫•t Word',
                noTransactionsReport: 'Ch∆∞a c√≥ giao d·ªãch n√†o ƒë·ªÉ b√°o c√°o.',
                dateHeader: 'Ng√†y',
                typeHeader: 'Lo·∫°i',
                descriptionHeader: 'M√¥ T·∫£',
                relatedMembersHeader: 'Th√†nh Vi√™n Li√™n Quan',
                amountHeader: 'S·ªë Ti·ªÅn (VNƒê)',
                memberReportsTitle: 'B√°o C√°o T·ª´ng Th√†nh Vi√™n',
                selectMemberReportLabel: 'Ch·ªçn Th√†nh Vi√™n:',
                selectMemberToReport: 'Vui l√≤ng ch·ªçn m·ªôt th√†nh vi√™n ƒë·ªÉ xem b√°o c√°o.',
                noMemberTransactions: 'Th√†nh vi√™n n√†y ch∆∞a c√≥ giao d·ªãch n√†o.',
                transactionHistoryTitle: 'L·ªãch S·ª≠ Giao D·ªãch',
                loadingTransactions: 'ƒêang t·∫£i giao d·ªãch...',
                noTransactions: 'Ch∆∞a c√≥ giao d·ªãch n√†o.',
                editBtn: 'S·ª≠a',
                deleteBtn: 'X√≥a',
                editTransactionModalTitle: 'Ch·ªânh S·ª≠a Giao D·ªãch',
                cancelBtn: 'H·ªßy',
                saveChangesBtn: 'L∆∞u Thay ƒê·ªïi',
                memberDetailsModalTitle: 'Chi Ti·∫øt Th√†nh Vi√™n:',
                currentBalance: 'S·ªë D∆∞ Hi·ªán T·∫°i:',
                relatedTransactions: 'C√°c Giao D·ªãch Li√™n Quan',
                noRelatedTransactions: 'Ch∆∞a c√≥ giao d·ªãch n√†o li√™n quan ƒë·∫øn th√†nh vi√™n n√†y.',
                closeBtn: 'ƒê√≥ng',
                confirmationTitle: 'X√°c Nh·∫≠n',
                confirmBtn: 'X√°c Nh·∫≠n',
                selectReportTypeTitle: 'Ch·ªçn Lo·∫°i B√°o C√°o',
                fundReportOption: 'B√°o C√°o Qu·ªπ Chung',
                memberReportOption: 'B√°o C√°o T·ª´ng Th√†nh Vi√™n',
                fundInsightsModalTitle: 'Th√¥ng Tin Chi Ti·∫øt Qu·ªπ ‚ú®',
                generatingInsights: 'ƒêang t·∫°o th√¥ng tin chi ti·∫øt t·ª´ AI...',
                noInsights: 'Kh√¥ng th·ªÉ t·∫°o th√¥ng tin chi ti·∫øt. Vui l√≤ng th·ª≠ l·∫°i.',
                aiConnectionError: 'ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i.',
                foodSuggestionModalTitle: 'G·ª£i √ù M√≥n ƒÇn ‚ú®',
                generatingFoodSuggestions: 'ƒêang t√¨m ki·∫øm g·ª£i √Ω m√≥n ƒÉn g·∫ßn b·∫°n...',
                locationError: 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n. Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠.',
                permissionDenied: 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠. Vui l√≤ng cho ph√©p trong c√†i ƒë·∫∑t tr√¨nh duy·ªát ƒë·ªÉ nh·∫≠n g·ª£i √Ω m√≥n ƒÉn.',
                positionUnavailable: 'Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng.',
                timeout: 'H·∫øt th·ªùi gian ch·ªù khi c·ªë g·∫Øng l·∫•y v·ªã tr√≠.',
                geolocationNotSupported: 'Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ t√≠nh nƒÉng ƒë·ªãnh v·ªã ƒë·ªãa l√Ω.',
                noFoodSuggestions: 'Kh√¥ng t√¨m th·∫•y g·ª£i √Ω m√≥n ƒÉn n√†o.',
                foodSuggestionError: 'Kh√¥ng th·ªÉ t·∫°o g·ª£i √Ω m√≥n ƒÉn. Vui l√≤ng th·ª≠ l·∫°i.',
                addressLabel: 'ƒê·ªãa ch·ªâ:',
                phoneLabel: 'ƒêi·ªán tho·∫°i:',
                ratingLabel: 'ƒê√°nh gi√°:',
                distanceLabel: 'Kho·∫£ng c√°ch:',
                descriptionLabelShort: 'M√¥ t·∫£:',
                menuLabel: 'Menu:',
                viewOnMaps: 'Xem tr√™n Google Maps',
                aiDescriptionModalTitle: 'M√¥ t·∫£ giao d·ªãch b·∫±ng AI',
                supaLoadError: 'L·ªói: Th∆∞ vi·ªán Supabase ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.',
                supabaseConfigWarning: 'C·∫£nh b√°o: URL ho·∫∑c Kh√≥a Supabase v·∫´n l√† gi√° tr·ªã m·∫∑c ƒë·ªãnh. Vui l√≤ng thay th·∫ø b·∫±ng th√¥ng tin d·ª± √°n th·ª±c c·ªßa b·∫°n.',
                supabaseTableError: 'L·ªói: C√°c b·∫£ng d·ªØ li·ªáu (members, transactions) ch∆∞a ƒë∆∞·ª£c t·∫°o trong Supabase. Vui l√≤ng ch·∫°y c√°c script SQL ƒë√£ cung c·∫•p tr∆∞·ªõc ƒë√≥.',
                dataLoadError: 'L·ªói khi t·∫£i d·ªØ li·ªáu:',
                emptyMemberName: 'T√™n th√†nh vi√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.',
                addMemberError: 'L·ªói khi th√™m th√†nh vi√™n:',
                settleUpError: 'L·ªói khi thanh to√°n s·ªë d∆∞:',
                invalidAmountDesc: 'Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá v√† m√¥ t·∫£.',
                selectContributingMember: 'Vui l√≤ng ch·ªçn th√†nh vi√™n ƒë√≥ng g√≥p.',
                selectInvolvedMembers: 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th√†nh vi√™n tham gia chi ti√™u.',
                addTransactionError: 'L·ªói khi th√™m giao d·ªãch:',
                editInvalidAmountDesc: 'Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá v√† m√¥ t·∫£ cho giao d·ªãch.',
                editSelectContributingMember: 'Vui l√≤ng ch·ªçn th√†nh vi√™n ƒë√≥ng g√≥p cho giao d·ªãch n√†y.',
                editSelectInvolvedMembers: 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th√†nh vi√™n tham gia chi ti√™u cho giao d·ªãch n√†y.',
                editTransactionError: 'L·ªói khi s·ª≠a giao d·ªãch:',
                confirmDeleteTransaction: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch "{description}" n√†y kh√¥ng?',
                deleteTransactionError: 'L·ªói khi x√≥a giao d·ªãch:',
                noBalanceChart: 'Ch∆∞a c√≥ s·ªë d∆∞ n√†o ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.',
                noCategoryChart: 'Ch∆∞a c√≥ {type} ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.',
                chartLegend: 'Ch√∫ Th√≠ch:',
                chartLegendFor: 'Ch√∫ Th√≠ch {title}:',
                xlsxLoadError: 'Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.',
                selectMemberForExport: 'Vui l√≤ng ch·ªçn m·ªôt th√†nh vi√™n ƒë·ªÉ xu·∫•t b√°o c√°o.',
                fileSaverLoadError: 'Th∆∞ vi·ªán FileSaver.js ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.',
                selectMemberForWordExport: 'Vui l√≤ng ch·ªçn m·ªôt th√†nh vi√™n ƒë·ªÉ xu·∫•t b√°o c√°o Word.',
                apiError: 'L·ªói API:',
                noImageDescription: 'Kh√¥ng th·ªÉ l·∫•y m√¥ t·∫£ h√¨nh ·∫£nh t·ª´ AI. Vui l√≤ng th·ª≠ l·∫°i.',
                aiCallError: 'L·ªói khi g·ªçi AI:',
                scrollToTopBtn: ' ‚Üë',
                allMembers: 'T·∫•t c·∫£',
                contributionType: 'ƒê√≥ng G√≥p',
                expenseType: 'Chi Ti√™u',
                otherCategory: 'Kh√°c',
                totalChart: 'T·ªïng:',
                deleteMemberBtn: 'X√≥a', // New translation key
                confirmDeleteMember: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√†nh vi√™n "{memberName}" n√†y kh√¥ng? M·ªçi giao d·ªãch li√™n quan s·∫Ω b·ªã x√≥a.', // New translation key
                deleteMemberError: 'L·ªói khi x√≥a th√†nh vi√™n:', // New translation key
                memberBalanceNotZero: 'Kh√¥ng th·ªÉ x√≥a th√†nh vi√™n c√≥ s·ªë d∆∞ kh√°c 0. Vui l√≤ng thanh to√°n s·ªë d∆∞ tr∆∞·ªõc.', // New translation key
            },
            'en': {
                appTitle: 'GROUP FUND MANAGEMENT',
                fundBalanceTitle: 'Overall Fund Balance',
                unitCurrency: 'VNƒê',
                addMemberBtn: 'Add Member',
                addTransactionBtn: 'Add Transaction',
                viewHistoryBtn: 'View History',
                reportBtn: 'Reports',
                aiInsightsBtn: 'AI Fund Insights',
                foodSuggestionsBtn: 'Food Suggestions',
                addMemberTitle: 'Add New Member',
                memberNamePlaceholder: 'Member Name',
                addBtn: 'Add',
                addTransactionTitle: 'Add New Transaction',
                transactionTypeLabel: 'Transaction Type',
                contributionOption: 'üíµ Contribution',
                expenseOption: 'üç∫ Expense',
                contributingMemberLabel: 'Contributing Member',
                involvedMembersLabel: 'Involved Members (Expense)',
                amountLabel: 'Amount (VNƒê)',
                amountPlaceholder: 'Amount',
                descriptionLabel: 'Description',
                descriptionPlaceholder: 'Transaction description',
                aiDescribeBtn: 'AI Describe from Image/Camera',
                recordTransactionBtn: 'Record Transaction',
                memberListTitle: 'Member List',
                loadingMembers: 'Loading members...',
                memberNameHeader: 'Member Name',
                balanceHeader: 'Balance',
                actionHeader: 'Action',
                settleUpBtn: 'Settle Up',
                viewDetailsBtn: 'View Details',
                noMembers: 'No members yet. Please add members!',
                summaryReportTitle: 'Summary Report',
                totalContributions: 'Total Contributions',
                totalExpenses: 'Total Expenses',
                memberBalanceChartTitle: 'Member Balance (Pie Chart)',
                loadingChart: 'Loading chart...',
                categoryChartsTitle: 'Income/Expense by Category (Pie Charts)',
                incomeByCategory: 'Income by Category',
                expenseByCategory: 'Expense by Category',
                fundReportTitle: 'Overall Fund Report',
                exportExcelBtn: 'Export Excel',
                exportWordBtn: 'Export Word',
                noTransactionsReport: 'No transactions to report.',
                dateHeader: 'Date',
                typeHeader: 'Type',
                descriptionHeader: 'Description',
                relatedMembersHeader: 'Related Members',
                amountHeader: 'Amount (VNƒê)',
                memberReportsTitle: 'Individual Member Reports',
                selectMemberReportLabel: 'Select Member:',
                selectMemberToReport: 'Please select a member to view the report.',
                noMemberTransactions: 'This member has no transactions.',
                transactionHistoryTitle: 'Transaction History',
                loadingTransactions: 'Loading transactions...',
                noTransactions: 'No transactions.',
                editBtn: 'Edit',
                deleteBtn: 'Delete',
                editTransactionModalTitle: 'Edit Transaction',
                cancelBtn: 'Cancel',
                saveChangesBtn: 'Save Changes',
                memberDetailsModalTitle: 'Member Details:',
                currentBalance: 'Current Balance:',
                relatedTransactions: 'Related Transactions',
                noRelatedTransactions: 'No transactions related to this member.',
                closeBtn: 'Close',
                confirmationTitle: 'Confirmation',
                confirmBtn: 'Confirm',
                selectReportTypeTitle: 'Select Report Type',
                fundReportOption: 'Overall Fund Report',
                memberReportOption: 'Individual Member Report',
                fundInsightsModalTitle: 'Fund Insights ‚ú®',
                generatingInsights: 'Generating AI insights...',
                noInsights: 'Could not generate insights. Please try again.',
                aiConnectionError: 'An error occurred connecting to AI. Please try again.',
                foodSuggestionModalTitle: 'Food Suggestions ‚ú®',
                generatingFoodSuggestions: 'Searching for food suggestions near you...',
                locationError: 'Could not retrieve your current location. Please allow location access.',
                permissionDenied: 'You denied location access. Please allow in browser settings to get food suggestions.',
                positionUnavailable: 'Location information is unavailable.',
                timeout: 'The request to get user location timed out.',
                geolocationNotSupported: 'Your browser does not support geolocation.',
                noFoodSuggestions: 'No food suggestions found.',
                foodSuggestionError: 'Could not generate food suggestions. Please try again.',
                addressLabel: 'Address:',
                phoneLabel: 'Phone:',
                ratingLabel: 'Rating:',
                distanceLabel: 'Distance:',
                descriptionLabelShort: 'Description:',
                menuLabel: 'Menu:',
                viewOnMaps: 'View on Google Maps',
                aiDescriptionModalTitle: 'AI Transaction Description',
                supaLoadError: 'Error: Supabase library not loaded. Please check network connection.',
                supabaseConfigWarning: 'Warning: Supabase URL or Key still default. Please replace with your actual project info.',
                supabaseTableError: 'Error: Data tables (members, transactions) not created in Supabase. Please run the provided SQL scripts.',
                dataLoadError: 'Error loading data:',
                emptyMemberName: 'Member name cannot be empty.',
                addMemberError: 'Error adding member:',
                settleUpError: 'Error settling up member balance:',
                invalidAmountDesc: 'Please enter a valid amount and description.',
                selectContributingMember: 'Please select a contributing member.',
                selectInvolvedMembers: 'Please select at least one member involved in the expense.',
                addTransactionError: 'Error adding transaction:',
                editInvalidAmountDesc: 'Please enter a valid amount and description for the transaction.',
                editSelectContributingMember: 'Please select a contributing member for this transaction.',
                editSelectInvolvedMembers: 'Please select at least one member involved in this expense.',
                editTransactionError: 'Error editing transaction:',
                confirmDeleteTransaction: 'Are you sure you want to delete transaction "{description}"?',
                deleteTransactionError: 'Error deleting transaction:',
                noBalanceChart: 'No balance data to display chart.',
                noCategoryChart: 'No {type} to display chart.',
                chartLegend: 'Legend:',
                chartLegendFor: 'Legend {title}:',
                xlsxLoadError: 'XLSX library not loaded. Please try again later.',
                selectMemberForExport: 'Please select a member to export the report.',
                fileSaverLoadError: 'FileSaver.js library not loaded. Please try again later.',
                selectMemberForWordExport: 'Please select a member to export the Word report.',
                apiError: 'API Error:',
                noImageDescription: 'Could not get image description from AI. Please try again.',
                aiCallError: 'Error calling AI:',
                scrollToTopBtn: ' ‚Üë',
                allMembers: 'All',
                contributionType: 'Contribution',
                expenseType: 'Expense',
                otherCategory: 'Other',
                totalChart: 'Total:',
                deleteMemberBtn: 'Delete', // New translation key
                confirmDeleteMember: 'Are you sure you want to delete member "{memberName}"? All related transactions will be deleted.', // New translation key
                deleteMemberError: 'Error deleting member:', // New translation key
                memberBalanceNotZero: 'Cannot delete member with non-zero balance. Please settle up the balance first.', // New translation key
            }
        };

        // DOM Elements
        const fundBalanceDisplay = document.getElementById('fund-balance-display');
        const errorMessageDisplay = document.getElementById('error-message-display');
        const addMemberSection = document.getElementById('add-member-section');
        const addTransactionSection = document.getElementById('add-transaction-section');
        const transactionsSection = document.getElementById('transactions-section');
        const fundReportSection = document.getElementById('fund-report-section');
        const memberReportsSection = document.getElementById('member-reports-section');
        const memberListContainer = document.getElementById('member-list-container');
        const transactionListContainer = document.getElementById('transaction-list-container');
        const totalContributionsDisplay = document.getElementById('total-contributions-display');
        const totalExpensesDisplay = document.getElementById('total-expenses-display');
        const memberBalancePieChartDiv = document.getElementById('member-balance-pie-chart');
        const categoryPieChartsDiv = document.getElementById('category-pie-charts');

        // Language switch buttons
        const langViBtn = document.getElementById('lang-vi-btn');
        const langEnBtn = document.getElementById('lang-en-btn');

        // Modals
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const memberDetailsModal = document.getElementById('member-details-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const reportSelectionModal = document.getElementById('report-selection-modal');
        const fundInsightsModal = document.getElementById('fund-insights-modal');
        const fundInsightsContent = document.getElementById('fund-insights-content');
        const foodSuggestionModal = document.getElementById('food-suggestion-modal');
        const foodSuggestionContent = document.getElementById('food-suggestion-content');
        const cameraModal = document.getElementById('camera-modal');

        // Forms and Inputs
        const addMemberForm = document.getElementById('add-member-form');
        const memberNameInput = document.getElementById('member-name-input');
        const addTransactionForm = document.getElementById('add-transaction-form');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const contributingMemberDiv = document.getElementById('contributing-member-div');
        const memberSelect = document.getElementById('member-select');
        const involvedMembersDiv = document.getElementById('involved-members-div');
        const involvedMembersCheckboxes = document.getElementById('involved-members-checkboxes');
        const amountInput = document.getElementById('amount-input');
        const descriptionInput = document.getElementById('description-input');
        const aiDescribeBtn = document.getElementById('ai-describe-btn');

        // Camera/Image Upload Elements
        const imageUploadInput = document.getElementById('image-upload-input');
        const uploadedImagePreview = document.getElementById('uploaded-image-preview');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const cameraLoadingSpinner = document.getElementById('camera-loading-spinner');

        // Edit Transaction Form Elements
        let editingTransaction = null;
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editContributingMemberDiv = document.getElementById('edit-contributing-member-div');
        const editMemberSelect = document.getElementById('edit-member-select');
        const editInvolvedMembersDiv = document.getElementById('edit-involved-members-div');
        const editInvolvedMembersCheckboxes = document.getElementById('edit-involved-members-checkboxes');
        const editAmountInput = document.getElementById('edit-amount-input');
        const editDescriptionInput = document.getElementById('edit-description-input');
        const cancelEditTransactionBtn = document.getElementById('cancel-edit-transaction-btn');

        // Member Details Modal Elements
        const memberDetailsName = document.getElementById('member-details-name');
        const memberDetailsBalance = document.getElementById('member-details-balance');
        const memberDetailsTransactionsContainer = document.getElementById('member-details-transactions-container');
        const closeMemberDetailsBtn = document.getElementById('close-member-details-btn');

        // Confirmation Modal Elements
        const confirmationMessage = document.getElementById('confirmation-message');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');

        // Report Selection Modal Elements
        const selectFundReportBtn = document.getElementById('select-fund-report-btn');
        const selectMemberReportBtn = document.getElementById('select-member-report-btn');
        const closeReportSelectionBtn = document.getElementById('close-report-selection-btn');

        // Member Report Specific Elements
        const selectMemberReportDropdown = document.getElementById('select-member-report');
        const memberReportTableContainer = document.getElementById('member-report-table-container');
        const exportMemberReportExcelBtn = document.getElementById('export-member-report-excel');
        const exportMemberReportWordBtn = document.getElementById('export-member-report-word');

        // Fund Report Specific Elements
        const fundReportTableContainer = document.getElementById('fund-report-table-container');
        const exportFundReportExcelBtn = document.getElementById('export-fund-report-excel');
        const exportFundReportWordBtn = document.getElementById('export-fund-report-word');

        // Insights Modal Elements
        const closeInsightsBtn = document.getElementById('close-insights-btn');

        // Food Suggestion Modal Elements
        const closeFoodSuggestionBtn = document.getElementById('close-food-suggestion-btn');

        // Scroll to Top Button Element
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

        // --- Language Functions ---
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('lang', lang);
            updateContent();
            updateLanguageButtons();
            // Re-render dynamic content that uses translations
            renderMemberList();
            renderTransactionList();
            renderFundReport();
            renderSelectedMemberReport();
            renderMemberBalancePieChart();
            renderCategoryPieCharts();
            // Update placeholder texts
            document.getElementById('member-name-input').placeholder = translations[currentLanguage].memberNamePlaceholder;
            document.getElementById('amount-input').placeholder = translations[currentLanguage].amountPlaceholder;
            document.getElementById('description-input').placeholder = translations[currentLanguage].descriptionPlaceholder;
            document.getElementById('edit-amount-input').placeholder = translations[currentLanguage].amountPlaceholder;
            document.getElementById('edit-description-input').placeholder = translations[currentLanguage].descriptionPlaceholder;
            document.getElementById('scroll-to-top-btn').title = translations[currentLanguage].scrollToTopBtn;
        }

        function updateContent() {
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            // Special handling for title tag
            document.title = translations[currentLanguage].appTitle;
            // Special handling for options in select elements
            document.querySelector('#transaction-type option[value="contribution"]').textContent = translations[currentLanguage].contributionOption;
            document.querySelector('#transaction-type option[value="expense"]').textContent = translations[currentLanguage].expenseOption;
            document.querySelector('#edit-transaction-type option[value="contribution"]').textContent = translations[currentLanguage].contributionOption;
            document.querySelector('#edit-transaction-type option[value="expense"]').textContent = translations[currentLanguage].expenseOption;
        }

        function updateLanguageButtons() {
            langViBtn.classList.remove('active');
            langEnBtn.classList.remove('active');
            if (currentLanguage === 'vi') {
                langViBtn.classList.add('active');
            } else {
                langEnBtn.classList.add('active');
            }
        }

        // --- Helper Functions ---

        // Formats a number with thousands separators for display
        function formatNumberForDisplay(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '';
            }
            return num.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US');
        }

        // Parses a formatted number string back to a raw number, handling K, m, b suffixes
        function parseFormattedNumber(formattedValue) {
            // Remove all thousands separators (dots for Vietnamese)
            // and replace decimal comma (if any, for European locales) with a dot for parseFloat
            let cleanedValue = formattedValue.toLowerCase()
                                            .replace(/\./g, '') // Remove dots (thousands separator for VI)
                                            .replace(/,/g, '.'); // Replace comma (decimal separator for VI, to dot for parseFloat)

            let multiplier = 1;
            let numericPart = cleanedValue;

            if (cleanedValue.endsWith('k')) {
                multiplier = 1000;
                numericPart = cleanedValue.slice(0, -1);
            } else if (cleanedValue.endsWith('m')) { // Handle 'm' for million
                multiplier = 1000000;
                numericPart = cleanedValue.slice(0, -1); // Remove 'm'
            } else if (cleanedValue.endsWith('b')) { // Handle 'b' for billion
                multiplier = 1000000000;
                numericPart = cleanedValue.slice(0, -1); // Remove 'b'
            }
            // Removed 'tr' and 't' for billion as per request

            console.log(`parseFormattedNumber: formattedValue='${formattedValue}', cleanedValue='${cleanedValue}', numericPart='${numericPart}', multiplier=${multiplier}`);

            const parsed = parseFloat(numericPart);
            console.log(`parseFormattedNumber: parsed=${parsed}, final result=${parsed * multiplier}`);
            return isNaN(parsed) ? 0 : parsed * multiplier;
        }

        // Formats a number string with thousands separators for input fields
        function formatNumberForInput(value) {
            // First, parse the value to a raw number to handle potential 'K', 'm', 'b' if user types them directly
            const rawNumber = parseFormattedNumber(value);
            // Then, format it back to a localized string with thousands separators
            return rawNumber.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US');
        }

        // Displays an error message
        function showErrorMessage(message) {
            currentErrorMessage = message;
            errorMessageDisplay.textContent = message;
            errorMessageDisplay.classList.remove('hidden');
        }

        // Hides the error message
        function hideErrorMessage() {
            currentErrorMessage = '';
            errorMessageDisplay.classList.add('hidden');
        }

        // Hides all main sections and modals
        function hideAllSections() {
            addMemberSection.classList.add('hidden');
            addTransactionSection.classList.add('hidden');
            transactionsSection.classList.add('hidden');
            fundReportSection.classList.add('hidden');
            memberReportsSection.classList.add('hidden');
            editTransactionModal.classList.add('hidden');
            memberDetailsModal.classList.add('hidden');
            confirmationModal.classList.add('hidden');
            reportSelectionModal.classList.add('hidden');
            fundInsightsModal.classList.add('hidden');
            foodSuggestionModal.classList.add('hidden');
            cameraModal.classList.add('hidden');
            hideErrorMessage();
        }

        // Scrolls to a specific section on the page
        function scrollToSection(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- Supabase and Data Management ---

        // Initializes Supabase client
        function initializeSupabase() {
            if (typeof window.supabase === 'undefined') {
                showErrorMessage(translations[currentLanguage].supaLoadError);
                return;
            }
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                showErrorMessage(translations[currentLanguage].supabaseConfigWarning);
                return;
            }
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized.");
            fetchData(); // Fetch initial data after initialization
            setupRealtimeSubscriptions(); // Set up real-time listeners
        }

        // Fetches all data from Supabase
        async function fetchData() {
            showLoading(true);
            try {
                // Fetch members
                const { data: membersData, error: membersError } = await supabase
                    .from('members')
                    .select('*');

                if (membersError) {
                    if (membersError.message.includes('relation "public.members" does not exist')) {
                        showErrorMessage(translations[currentLanguage].supabaseTableError);
                    } else {
                        showErrorMessage(`${translations[currentLanguage].dataLoadError} ${translations[currentLanguage].memberNameHeader.toLowerCase()}: ${membersError.message}`);
                    }
                    throw membersError;
                }

                // Fetch transactions
                const { data: transactionsData, error: transactionsError } = await supabase
                    .from('transactions')
                    .select('*');

                if (transactionsError) {
                    if (transactionsError.message.includes('relation "public.transactions" does not exist')) {
                        showErrorMessage(translations[currentLanguage].supabaseTableError);
                    } else {
                        showErrorMessage(`${translations[currentLanguage].dataLoadError} ${translations[currentLanguage].transactionHistoryTitle.toLowerCase()}: ${transactionsError.message}`);
                    }
                    throw transactionsError;
                }

                members = membersData;
                transactions = transactionsData;

                // If no members exist, populate with default data
                if (members.length === 0) {
                    console.log("No members found, populating with default data...");
                    const initialMembers = [
                        { name: 'Tr∆∞∆°ng H·ªìng Qu√¢n' },
                        { name: 'B√πi Ho√†ng Giang' },
                        { name: 'Nguy·ªÖn Th·ªã Hoa H·∫≠u' },
                    ];
                    const { data: newMembers, error: newMembersError } = await supabase
                        .from('members')
                        .insert(initialMembers)
                        .select();

                    if (newMembersError) throw newMembersError;
                    members = newMembers;

                    // Create initial transactions using the IDs of newly inserted members
                    const initialTransactions = [
                        { type: 'contribution', amount: 500000, description: 'ƒê√≥ng g√≥p ban ƒë·∫ßu', date: new Date().toLocaleString(), contributingMemberId: newMembers[0].id },
                        { type: 'contribution', amount: 300000, description: 'ƒê√≥ng g√≥p th√™m', date: new Date().toLocaleString(), contributingMemberId: newMembers[1].id },
                        { type: 'expense', amount: 150000, description: 'Mua ƒë·ªì ƒÉn nh·∫π', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id] },
                        { type: 'contribution', amount: 200000, description: 'ƒê√≥ng g√≥p th√°ng 5', date: new Date().toLocaleString(), contributingMemberId: newMembers[2].id },
                        { type: 'expense', amount: 250000, description: 'Ti·ªÅn n∆∞·ªõc u·ªëng', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[2].id] },
                        { type: 'expense', amount: 300000, description: 'ƒê·∫∑t c∆°m tr∆∞a', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id] },
                    ];
                    const { data: newTransactions, error: newTransactionsError } = await supabase
                        .from('transactions')
                        .insert(initialTransactions)
                        .select();

                    if (newTransactionsError) throw newTransactionsError;
                    transactions = newTransactions;
                }

                updateUI(); // Update UI after fetching data
            } catch (error) {
                console.error("Error fetching data from Supabase:", error.message);
                // Error message already set by specific checks above, or fallback here
                if (!currentErrorMessage) {
                    showErrorMessage(`${translations[currentLanguage].dataLoadError} ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        }

        // Sets up real-time subscriptions for members and transactions
        function setupRealtimeSubscriptions() {
            supabase
                .channel('public:members')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, payload => {
                    console.log('Member change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();

            supabase
                .channel('public:transactions')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, payload => {
                    console.log('Transaction change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();
        }

        // Shows/hides a loading indicator
        function showLoading(isLoading) {
            const loadingDiv = document.getElementById('loading-overlay'); // Assuming a loading overlay div exists
            if (loadingDiv) {
                loadingDiv.classList.toggle('hidden', !isLoading);
            }
            // You might also disable buttons or inputs here
        }

        // --- UI Update Functions ---

        // Updates all dynamic parts of the UI
        function updateUI() {
            calculateBalances();
            renderFundBalance();
            renderMemberList();
            renderReportingSummary();
            renderTransactionList(); // Re-render transaction list if visible
            renderMemberReportDropdown(); // Update member report dropdown
            renderMemberBalancePieChart(); // Update pie chart
            renderCategoryPieCharts(); // Render the new category pie charts
        }

        // Calculates fund and member balances
        function calculateBalances() {
            let totalBalance = 0;
            const tempMemberBalances = new Map(members.map(m => [m.id, 0]));

            transactions.forEach(t => {
                if (t.type === 'contribution') {
                    totalBalance += t.amount;
                    if (tempMemberBalances.has(t.contributingMemberId)) {
                        tempMemberBalances.set(t.contributingMemberId, tempMemberBalances.get(t.contributingMemberId) + t.amount);
                    }
                } else if (t.type === 'expense') {
                    totalBalance -= t.amount;
                    const involvedMembers = t.involvedMemberIds && t.involvedMemberIds.length > 0
                        ? t.involvedMemberIds
                        : members.map(m => m.id);

                    if (involvedMembers.length > 0) {
                        const costPerMember = t.amount / involvedMembers.length;
                        involvedMembers.forEach(memberId => {
                            if (tempMemberBalances.has(memberId)) {
                                tempMemberBalances.set(memberId, tempMemberBalances.get(memberId) - costPerMember);
                            }
                        });
                    }
                }
            });

            members = members.map(member => ({
                ...member,
                balance: tempMemberBalances.get(member.id) || 0
            }));
            fundBalance = totalBalance;
        }

        // Renders the overall fund balance
        function renderFundBalance() {
            fundBalanceDisplay.textContent = `${formatNumberForDisplay(fundBalance)} ${translations[currentLanguage].unitCurrency}`;
            fundBalanceDisplay.classList.remove('text-green-600', 'text-red-600');
            if (fundBalance >= 0) {
                fundBalanceDisplay.classList.add('text-green-600');
            } else {
                fundBalanceDisplay.classList.add('text-red-600');
            }
        }

        // Renders the member list table
        function renderMemberList() {
            if (members.length === 0) {
                memberListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noMembers}</p>`;
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="table-header">${translations[currentLanguage].memberNameHeader}</th>
                            <th class="table-header text-right-aligned">${translations[currentLanguage].balanceHeader}</th>
                            <th class="table-header">${translations[currentLanguage].actionHeader}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            members.forEach(member => {
                const balanceClass = member.balance > 0 ? 'balance-positive' :
                                     member.balance < 0 ? 'balance-negative' :
                                     'balance-zero';
                tableHtml += `
                    <tr class="table-row">
                        <td class="font-medium text-gray-900">${member.name}</td>
                        <td class="text-right-aligned">
                            <span class="text-lg font-bold ${balanceClass}">
                                ${formatNumberForDisplay(member.balance)} ${translations[currentLanguage].unitCurrency}
                            </span>
                        </td>
                        <td class="flex flex-col sm:flex-row gap-2">
                            <button data-member-id="${member.id}" class="settle-up-btn text-[#006B68] hover:text-[#005A58] font-semibold text-sm w-full sm:w-auto" ${Math.abs(member.balance) < 0.01 ? 'disabled' : ''}>
                                ${translations[currentLanguage].settleUpBtn}
                            </button>
                            <button data-member-id="${member.id}" class="view-details-btn text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto">
                                ${translations[currentLanguage].viewDetailsBtn}
                            </button>
                            <button data-member-id="${member.id}" class="delete-member-btn text-red-600 hover:text-red-900 font-semibold text-sm w-full sm:w-auto" ${Math.abs(member.balance) > 0.01 ? 'disabled' : ''}>
                                ${translations[currentLanguage].deleteBtn}
                            </button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            memberListContainer.innerHTML = tableHtml;

            // Attach event listeners for settle up, view details, and delete buttons
            memberListContainer.querySelectorAll('.settle-up-btn').forEach(button => {
                button.onclick = (e) => settleUpMember(e.target.dataset.memberId);
            });
            memberListContainer.querySelectorAll('.view-details-btn').forEach(button => {
                button.onclick = (e) => showMemberDetailsModal(members.find(m => m.id === e.target.dataset.memberId));
            });
            memberListContainer.querySelectorAll('.delete-member-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.memberId;
                    const memberToDeleteFound = members.find(m => m.id === id);
                    if (memberToDeleteFound) confirmDeleteMember(memberToDeleteFound);
                };
            });
        }

        // Renders the reporting summary (total contributions and expenses)
        function renderReportingSummary() {
            const totalContributions = transactions.filter(t => t.type === 'contribution').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            totalContributionsDisplay.textContent = `${formatNumberForDisplay(totalContributions)} ${translations[currentLanguage].unitCurrency}`;
            totalExpensesDisplay.textContent = `${formatNumberForDisplay(totalExpenses)} ${translations[currentLanguage].unitCurrency}`;
        }

        // Renders the transaction list table
        function renderTransactionList() {
            if (transactionsSection.classList.contains('hidden')) return; // Only render if visible

            if (transactions.length === 0) {
                transactionListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noTransactions}</p>`;
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th>${translations[currentLanguage].dateHeader}</th>
                            <th>${translations[currentLanguage].typeHeader}</th>
                            <th>${translations[currentLanguage].descriptionHeader}</th>
                            <th>${translations[currentLanguage].relatedMembersHeader}</th>
                            <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            <th>${translations[currentLanguage].actionHeader}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            transactions.slice().reverse().forEach(t => { // Display latest first
                // For the general transaction list, always display the total amount of the expense
                const displayedAmount = t.amount;
                const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('üíµ ', '') : translations[currentLanguage].expenseOption.replace('üç∫ ', '');
                const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                const memberNames = t.type === 'contribution'
                    ? getMemberName(t.contributingMemberId)
                    : getInvolvedMembersNames(t.involvedMemberIds);

                tableHtml += `
                    <tr class="table-row">
                        <td>${t.date}</td>
                        <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                        <td>${t.description}</td>
                        <td>${memberNames}</td>
                        <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                        <td class="flex flex-col sm:flex-row gap-2">
                            <button data-transaction-id="${t.id}" class="edit-transaction-btn text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto">${translations[currentLanguage].editBtn}</button>
                            <button data-transaction-id="${t.id}" class="delete-transaction-btn text-red-600 hover:text-red-900 font-semibold text-sm w-full sm:w-auto">${translations[currentLanguage].deleteBtn}</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            transactionListContainer.innerHTML = tableHtml;

            // Attach event listeners for edit and delete buttons
            transactionListContainer.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.transactionId;
                    const transactionToEdit = transactions.find(t => t.id === id);
                    if (transactionToEdit) showEditTransactionModal(transactionToEdit);
                };
            });
            transactionListContainer.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.transactionId;
                    const transactionToDeleteFound = transactions.find(t => t.id === id);
                    if (transactionToDeleteFound) confirmDeleteTransaction(transactionToDeleteFound);
                };
            });
        }

        // Helper to get member name by ID
        function getMemberName(memberId) {
            const member = members.find(m => m.id === memberId);
            return member ? member.name : 'N/A';
        }

        // Helper to get involved members' names for expenses
        function getInvolvedMembersNames(involvedMemberIds) {
            if (!involvedMemberIds || involvedMemberIds.length === 0) {
                return translations[currentLanguage].allMembers;
            }
            return involvedMemberIds.map(id => getMemberName(id)).join(', ');
        }

        // --- Member Actions ---

        // Handles adding a new member
        addMemberForm.onsubmit = async (e) => {
            e.preventDefault();
            const name = memberNameInput.value.trim();
            if (!name) {
                showErrorMessage(translations[currentLanguage].emptyMemberName);
                return;
            }
            hideErrorMessage();
            try {
                const { data, error } = await supabase
                    .from('members')
                    .insert({ name: name, balance: 0 });
                if (error) throw error;
                memberNameInput.value = ''; // Clear input
                addMemberSection.classList.add('hidden'); // Hide form
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error adding member:", error.message);
                showErrorMessage(`${translations[currentLanguage].addMemberError} ${error.message}`);
            }
        };

        // Handles settling up a member's balance
        async function settleUpMember(memberId) {
            const memberToSettle = members.find(m => m.id === memberId);
            if (!memberToSettle || Math.abs(memberToSettle.balance) < 0.01) return; // Use a small epsilon for zero check

            const settlementAmount = Math.abs(memberToSettle.balance);
            const settlementType = memberToSettle.balance < 0 ? 'contribution' : 'expense';
            const description = `${translations[currentLanguage].settleUpBtn} ${memberToSettle.name}`;

            try {
                const newTransaction = {
                    type: settlementType,
                    amount: settlementAmount,
                    description: description,
                    date: new Date().toLocaleString(),
                    contributingMemberId: settlementType === 'contribution' ? memberToSettle.id : null,
                    involvedMemberIds: settlementType === 'expense' ? [memberToSettle.id] : [],
                };
                const { data, error } = await supabase
                    .from('transactions')
                    .insert(newTransaction);
                if (error) throw error;
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error settling up member:", error.message);
                showErrorMessage(`${translations[currentLanguage].settleUpError} ${error.message}`);
            }
        };

        // Shows confirmation modal for deleting a member
        function confirmDeleteMember(member) {
            // Check if balance is effectively zero (within a small tolerance)
            if (Math.abs(member.balance) > 0.01) {
                showErrorMessage(translations[currentLanguage].memberBalanceNotZero);
                return;
            }
            memberToDelete = member;
            const message = translations[currentLanguage].confirmDeleteMember.replace('{memberName}', member.name);
            confirmationMessage.textContent = message;
            confirmationModal.classList.remove('hidden');
            // Change confirm action to delete member
            confirmActionBtn.onclick = deleteMemberConfirmed;
        }

        // Handles deletion of member after confirmation
        async function deleteMemberConfirmed() {
            if (memberToDelete) {
                try {
                    console.log(`Attempting to delete transactions for member: ${memberToDelete.name} (ID: ${memberToDelete.id})`);
                    // Delete all transactions related to this member first
                    const { error: transactionsError } = await supabase
                        .from('transactions')
                        .delete()
                        .or(`contributingMemberId.eq.${memberToDelete.id},involvedMemberIds.cs.{${memberToDelete.id}}`); // Delete if contributing or involved

                    if (transactionsError) {
                        console.error("Error deleting related transactions:", transactionsError.message);
                        throw transactionsError;
                    }
                    console.log(`Transactions for member ${memberToDelete.name} deleted successfully.`);

                    // Then delete the member
                    console.log(`Attempting to delete member: ${memberToDelete.name} (ID: ${memberToDelete.id})`);
                    const { error: memberError } = await supabase
                        .from('members')
                        .delete()
                        .eq('id', memberToDelete.id);

                    if (memberError) {
                        console.error("Error deleting member:", memberError.message);
                        throw memberError;
                    }
                    console.log(`Member ${memberToDelete.name} deleted successfully.`);

                    fetchData(); // Re-fetch data to update UI
                } catch (error) {
                    console.error("Error during member deletion process:", error.message);
                    showErrorMessage(`${translations[currentLanguage].deleteMemberError} ${error.message}`);
                }
            }
            confirmationModal.classList.add('hidden');
            memberToDelete = null;
            // Reset confirm action to delete transaction (default)
            confirmActionBtn.onclick = deleteTransactionConfirmed; // Ensure this is reset
        }

        // --- Transaction Actions ---

        // Handles adding a new transaction
        addTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            const submitButton = e.submitter; // Get the button that triggered the submit
            if (submitButton) {
                submitButton.disabled = true; // Disable the button immediately
                submitButton.textContent = 'ƒêang l∆∞u...'; // Optional: show loading text
            }

            const type = transactionTypeSelect.value;
            const amount = parseFormattedNumber(amountInput.value); // Use the new parseFormattedNumber
            console.log("Amount to be saved (add transaction):", amount); // Log for debugging
            const description = descriptionInput.value.trim();
            const contributingMemberId = memberSelect.value;
            const selectedExpenseMembers = Array.from(involvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);

            if (isNaN(amount) || amount <= 0 || !description) {
                showErrorMessage(translations[currentLanguage].invalidAmountDesc);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn;
                }
                return;
            }
            if (type === 'contribution' && !contributingMemberId) {
                showErrorMessage(translations[currentLanguage].selectContributingMember);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn;
                }
                return;
            }
            if (type === 'expense' && selectedExpenseMembers.length === 0) {
                showErrorMessage(translations[currentLanguage].selectInvolvedMembers);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn;
                }
                return;
            }
            hideErrorMessage();

            try {
                const newTransaction = {
                    type: type,
                    amount: amount,
                    description: description,
                    date: new Date().toLocaleString(),
                    contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                    involvedMemberIds: type === 'expense' ? selectedExpenseMembers : [],
                };
                const { data, error } = await supabase
                    .from('transactions')
                    .insert(newTransaction);
                if (error) throw error;
                amountInput.value = '';
                descriptionInput.value = '';
                // Reset member selection for expense if it was an expense
                involvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                addTransactionSection.classList.add('hidden'); // Hide form
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error adding transaction:", error.message);
                showErrorMessage(`${translations[currentLanguage].addTransactionError} ${error.message}`);
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn; // Reset button text
                }
            }
        };

        // Populates the member dropdowns and checkboxes for transaction forms
        function populateMemberSelectors() {
            // For Add Transaction Form
            memberSelect.innerHTML = '';
            involvedMembersCheckboxes.innerHTML = '';

            if (members.length === 0) {
                memberSelect.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                involvedMembersCheckboxes.innerHTML = `<p class="text-gray-500 text-sm">${translations[currentLanguage].noMembers}</p>`;
                return;
            }

            members.forEach(member => {
                // For dropdown (contributing member)
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                memberSelect.appendChild(option);

                // For checkboxes (involved members)
                const label = document.createElement('label');
                label.className = 'inline-flex items-center cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]" value="${member.id}">
                    <span class="ml-2 text-sm text-gray-700">${member.name}</span>
                `;
                involvedMembersCheckboxes.appendChild(label);
            });

            // Set default selected member for contribution if available
            if (members.length > 0) {
                memberSelect.value = members[0].id;
            }
        }

        // Toggles visibility and required attributes of contributing/involved member fields based on transaction type
        transactionTypeSelect.onchange = () => {
            if (transactionTypeSelect.value === 'contribution') {
                contributingMemberDiv.classList.remove('hidden');
                memberSelect.setAttribute('required', 'true'); // Make contributing member required
                involvedMembersDiv.classList.add('hidden');
                involvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false; // Clear selected expense members
                    checkbox.removeAttribute('required'); // Remove required from expense members
                });
            } else {
                contributingMemberDiv.classList.add('hidden');
                memberSelect.removeAttribute('required'); // Remove required from contributing member
                memberSelect.value = ''; // Clear contributing member
                involvedMembersDiv.classList.remove('hidden');
                // For expense, at least one checkbox should be implicitly required by validation logic
                // No need to set 'required' on individual checkboxes, as the form submission logic handles it.
            }
        };

        // Shows the edit transaction modal
        function showEditTransactionModal(transaction) {
            editingTransaction = transaction; // Store the transaction globally
            editTransactionModal.classList.remove('hidden');
            hideErrorMessage();

            // Populate form fields
            editTransactionTypeSelect.value = transaction.type;
            editAmountInput.value = formatNumberForInput(transaction.amount.toString());
            editDescriptionInput.value = transaction.description;

            // Populate member selectors for edit modal
            editMemberSelect.innerHTML = '';
            editInvolvedMembersCheckboxes.innerHTML = '';

            if (members.length === 0) {
                editMemberSelect.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                editInvolvedMembersCheckboxes.innerHTML = `<p class="text-gray-500 text-sm">${translations[currentLanguage].noMembers}</p>`;
                return;
            }

            members.forEach(member => {
                // For dropdown (contributing member)
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                editMemberSelect.appendChild(option);

                // For checkboxes (involved members)
                const label = document.createElement('label');
                label.className = 'inline-flex items-center cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]" value="${member.id}">
                    <span class="ml-2 text-sm text-gray-700">${member.name}</span>
                `;
                editInvolvedMembersCheckboxes.appendChild(label);
            });

            // Set initial selection based on transaction type and manage required attributes
            if (transaction.type === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.removeAttribute('required');
                });
                editMemberSelect.value = transaction.contributingMemberId || '';
            } else {
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                transaction.involvedMemberIds.forEach(id => {
                    const checkbox = editInvolvedMembersCheckboxes.querySelector(`input[value="${id}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Toggles visibility and required attributes of contributing/involved member fields in edit modal
        editTransactionTypeSelect.onchange = () => {
            if (editTransactionTypeSelect.value === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.removeAttribute('required');
                });
            } else {
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                // For expense, at least one checkbox should be implicitly required by validation logic
            }
        };

        // Handles saving edited transaction
        editTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!editingTransaction) return;

            const submitButton = e.submitter; // Get the button that triggered the submit
            if (submitButton) {
                submitButton.disabled = true; // Disable the button immediately
                submitButton.textContent = 'ƒêang l∆∞u...'; // Optional: show loading text
            }

            const type = editTransactionTypeSelect.value;
            const amount = parseFormattedNumber(editAmountInput.value); // Use the new parseFormattedNumber
            console.log("Amount to be saved (edit transaction):", amount); // Log for debugging
            const description = editDescriptionInput.value.trim();
            const contributingMemberId = editMemberSelect.value;
            const involvedMemberIds = Array.from(editInvolvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);

            if (isNaN(amount) || amount <= 0 || !description) {
                showErrorMessage(translations[currentLanguage].editInvalidAmountDesc);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }
            if (type === 'contribution' && !contributingMemberId) {
                showErrorMessage(translations[currentLanguage].editSelectContributingMember);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }
            if (type === 'expense' && involvedMemberIds.length === 0) {
                showErrorMessage(translations[currentLanguage].editSelectInvolvedMembers);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }
            hideErrorMessage();

            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .update({
                        type: type,
                        amount: amount,
                        description: description,
                        contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                        involvedMemberIds: type === 'expense' ? involvedMemberIds : [],
                    })
                    .eq('id', editingTransaction.id);
                if (error) throw error;
                editTransactionModal.classList.add('hidden');
                editingTransaction = null;
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error editing transaction:", error.message);
                showErrorMessage(`${translations[currentLanguage].editTransactionError} ${error.message}`);
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn; // Reset button text
                }
            }
        };

        // Shows confirmation modal for deleting a transaction
        function confirmDeleteTransaction(transaction) {
            transactionToDelete = transaction;
            const message = translations[currentLanguage].confirmDeleteTransaction.replace('{description}', transaction.description);
            confirmationMessage.textContent = message;
            confirmationModal.classList.remove('hidden');
            // Change confirm action to delete transaction
            confirmActionBtn.onclick = deleteTransactionConfirmed;
        }

        // Handles deletion of transaction after confirmation
        async function deleteTransactionConfirmed() {
            if (transactionToDelete) {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', transactionToDelete.id);
                    if (error) throw error;
                    fetchData(); // Re-fetch data to update UI
                } catch (error) {
                    console.error("Error deleting transaction:", error.message);
                    showErrorMessage(`${translations[currentLanguage].deleteTransactionError} ${error.message}`);
                }
            }
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
            // Reset confirm action to delete transaction (default)
            confirmActionBtn.onclick = deleteTransactionConfirmed; // Keep as default for transactions
        }

        // Cancels deletion (for both member and transaction)
        cancelConfirmationBtn.onclick = () => {
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
            memberToDelete = null;
            // Reset confirm action to delete transaction (default)
            confirmActionBtn.onclick = deleteTransactionConfirmed;
        };

        // --- Member Details Modal ---
        function showMemberDetailsModal(member) {
            selectedMemberForDetails = member;
            memberDetailsModal.classList.remove('hidden');
            hideErrorMessage();

            memberDetailsName.textContent = `${translations[currentLanguage].memberDetailsModalTitle} ${member.name}`;
            memberDetailsBalance.textContent = `${formatNumberForDisplay(member.balance)} ${translations[currentLanguage].unitCurrency}`;
            memberDetailsBalance.classList.remove('text-green-600', 'text-red-600');
            if (member.balance >= 0) {
                memberDetailsBalance.classList.add('text-green-600');
            } else {
                memberDetailsBalance.classList.add('text-red-600');
            }

            const memberTransactions = transactions.filter(t =>
                (t.type === 'contribution' && t.contributingMemberId === member.id) ||
                (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(member.id))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (memberTransactions.length === 0) {
                memberDetailsTransactionsContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noRelatedTransactions}</p>`;
            } else {
                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th>${translations[currentLanguage].dateHeader}</th>
                                <th>${translations[currentLanguage].typeHeader}</th>
                                <th>${translations[currentLanguage].descriptionHeader}</th>
                                <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                memberTransactions.forEach(t => {
                    let displayedAmount = t.amount;
                    // For individual member details, show the per-person share of the expense
                    if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                        displayedAmount = t.amount / t.involvedMemberIds.length;
                    }
                    const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('üíµ ', '') : translations[currentLanguage].expenseOption.replace('üç∫ ', '');
                    const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                        tableHtml += `
                            <tr class="table-row">
                                <td>${t.date}</td>
                                <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                                <td>${t.description}</td>
                                <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    memberDetailsTransactionsContainer.innerHTML = tableHtml;
                }
            }

            // --- Reporting Functions ---

            // Renders the Fund Report table
            function renderFundReport() {
                if (transactions.length === 0) {
                    fundReportTableContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noTransactionsReport}</p>`;
                    return;
                }

                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th class="table-header">${translations[currentLanguage].dateHeader}</th>
                                <th class="table-header">${translations[currentLanguage].typeHeader}</th>
                                <th class="table-header">${translations[currentLanguage].descriptionHeader}</th>
                                <th class="table-header">${translations[currentLanguage].relatedMembersHeader}</th>
                                <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                transactions.slice().reverse().forEach(t => {
                    // For the fund report, always display the total amount of the expense
                    const displayedAmount = t.amount;
                    const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('üíµ ', '') : translations[currentLanguage].expenseOption.replace('üç∫ ', '');
                    const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                    const memberNames = t.type === 'contribution'
                        ? getMemberName(t.contributingMemberId)
                        : getInvolvedMembersNames(t.involvedMemberIds);

                    tableHtml += `
                        <tr class="table-row">
                            <td>${t.date}</td>
                            <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                            <td>${t.description}</td>
                            <td>${memberNames}</td>
                            <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                        </tr>
                    `;
                });
                tableHtml += `
                        </tbody>
                    </table>
                `;
                fundReportTableContainer.innerHTML = tableHtml;
            }

            // Renders the Member Report dropdown
            function renderMemberReportDropdown() {
                selectMemberReportDropdown.innerHTML = '';
                if (members.length === 0) {
                    selectMemberReportDropdown.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                } else {
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.name;
                        selectMemberReportDropdown.appendChild(option);
                    });
                    // Set default selected member if not already set
                    if (!selectMemberReportDropdown.value && members.length > 0) {
                        selectMemberReportDropdown.value = members[0].id;
                    }
                }
                renderSelectedMemberReport(); // Render report for initially selected member
            }

            // Renders the report for the currently selected member
            function renderSelectedMemberReport() {
                const selectedMemberId = selectMemberReportDropdown.value;
                if (!selectedMemberId) {
                    memberReportTableContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].selectMemberToReport}</p>`;
                    return;
                }

                const memberTransactions = transactions.filter(t =>
                    (t.type === 'contribution' && t.contributingMemberId === selectedMemberId) ||
                    (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(selectedMemberId))
                ).sort((a, b) => new Date(b.date) - new Date(a.date));

                if (memberTransactions.length === 0) {
                    memberReportTableContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noMemberTransactions}</p>`;
                    return;
                }

                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th class="table-header">${translations[currentLanguage].dateHeader}</th>
                                <th class="table-header">${translations[currentLanguage].typeHeader}</th>
                                <th class="table-header">${translations[currentLanguage].descriptionHeader}</th>
                                <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                memberTransactions.forEach(t => {
                    let displayedAmount = t.amount;
                    // For individual member reports, show the per-person share of the expense
                    if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                        displayedAmount = t.amount / t.involvedMemberIds.length;
                    }
                    const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('üíµ ', '') : translations[currentLanguage].expenseOption.replace('üç∫ ', '');
                    const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                        tableHtml += `
                            <tr class="table-row">
                                <td>${t.date}</td>
                                <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                                <td>${t.description}</td>
                                <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    memberReportTableContainer.innerHTML = tableHtml;
                }

                // Export Fund Report to Excel
                exportFundReportExcelBtn.onclick = () => {
                    if (typeof window.XLSX === 'undefined') {
                        showErrorMessage(translations[currentLanguage].xlsxLoadError);
                        return;
                    }

                    const reportData = transactions.slice().reverse().map(t => {
                        // For Excel export of fund report, use the total amount
                        const displayedAmount = t.amount;
                        return {
                            [translations[currentLanguage].dateHeader]: t.date,
                            [translations[currentLanguage].typeHeader]: t.type === 'contribution' ? translations[currentLanguage].contributionType : translations[currentLanguage].expenseType,
                            [translations[currentLanguage].descriptionHeader]: t.description,
                            [translations[currentLanguage].relatedMembersHeader]: t.type === 'contribution' ? getMemberName(t.contributingMemberId) : getInvolvedMembersNames(t.involvedMemberIds),
                            [`${translations[currentLanguage].amountHeader} (${translations[currentLanguage].unitCurrency})`]: (t.type === 'contribution' ? '+' : '-') + formatNumberForDisplay(displayedAmount),
                        };
                    });

                    const ws = window.XLSX.utils.json_to_sheet(reportData);
                    const wb = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(wb, ws, translations[currentLanguage].fundReportTitle);
                    window.XLSX.writeFile(wb, `${translations[currentLanguage].fundReportTitle}.xlsx`);
                };

                // Export Member Report to Excel
                exportMemberReportExcelBtn.onclick = () => {
                    if (typeof window.XLSX === 'undefined') {
                        showErrorMessage(translations[currentLanguage].xlsxLoadError);
                        return;
                    }
                    const selectedMemberId = selectMemberReportDropdown.value;
                    if (!selectedMemberId) {
                        showErrorMessage(translations[currentLanguage].selectMemberForExport);
                        return;
                    }
                    const memberName = getMemberName(selectedMemberId);
                    const memberTransactions = transactions.filter(t =>
                        (t.type === 'contribution' && t.contributingMemberId === selectedMemberId) ||
                        (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(selectedMemberId))
                    ).sort((a, b) => new Date(b.date) - new Date(a.date));

                    const reportData = memberTransactions.map(t => {
                        let displayedAmount = t.amount;
                        // For Excel export of member report, use the per-person share
                        if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                            displayedAmount = t.amount / t.involvedMemberIds.length;
                        }
                        return {
                            [translations[currentLanguage].dateHeader]: t.date,
                            [translations[currentLanguage].typeHeader]: t.type === 'contribution' ? translations[currentLanguage].contributionType : translations[currentLanguage].expenseType,
                            [translations[currentLanguage].descriptionHeader]: t.description,
                            [`${translations[currentLanguage].amountHeader} (${translations[currentLanguage].unitCurrency})`]: (t.type === 'contribution' ? '+' : '-') + formatNumberForDisplay(displayedAmount),
                        };
                    });

                    const ws = window.XLSX.utils.json_to_sheet(reportData);
                    const wb = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(wb, ws, `${translations[currentLanguage].memberReportsTitle} ${memberName}`);
                    window.XLSX.writeFile(wb, `${translations[currentLanguage].memberReportsTitle}_${memberName}.xlsx`);
                };

                // --- Word Export Functions ---

                // Helper function to get HTML content for Word export with inline styles
                function getHtmlForWordExport(containerId, title) {
                    const container = document.getElementById(containerId);
                    if (!container) return '';

                    // Clone the container to manipulate its content without affecting the live DOM
                    const clonedContainer = container.cloneNode(true);

                    // Apply inline styles to the cloned table elements for better Word rendering
                    const table = clonedContainer.querySelector('table');
                    if (table) {
                        table.classList.add('word-export-table'); // Add a specific class for Word export styling
                        // Apply inline styles to th and td elements
                        clonedContainer.querySelectorAll('th, td').forEach(cell => {
                            cell.style.border = '1px solid #e5e7eb';
                            cell.style.padding = '0.75rem';
                            cell.style.textAlign = cell.classList.contains('text-right-aligned') ? 'right' : 'left';
                            if (cell.tagName === 'TH') {
                                cell.style.backgroundColor = '#f3f4f6';
                                cell.style.fontWeight = 'bold';
                            }
                            // Apply color for balance classes
                            if (cell.querySelector('.balance-positive')) {
                                cell.style.color = '#10B981';
                            } else if (cell.querySelector('.balance-negative')) {
                                cell.style.color = '#EF4444';
                            } else if (cell.querySelector('.balance-zero')) {
                                cell.style.color = '#6B7280';
                            }
                            // Remove span elements that apply color/background on web for Word export
                            const span = cell.querySelector('span.px-2.py-1.rounded-full');
                            if (span) {
                                cell.textContent = span.textContent; // Move text from span to cell
                                span.remove(); // Remove the span
                            }
                        });
                    }

                    let htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <title>${title}</title>
                            <style>
                                /* Basic styles for Word document */
                                body { font-family: 'Inter', sans-serif; }
                                table {
                                    border-collapse: collapse;
                                    width: 100%;
                                }
                                th, td {
                                    border: 1px solid #e5e7eb;
                                    padding: 0.75rem;
                                    text-align: left;
                                }
                                th {
                                    background-color: #f3f4f6;
                                    font-weight: bold;
                                }
                                .balance-positive { color: #10B981; }
                                .balance-negative { color: #EF4444; }
                                .balance-zero { color: #6B7280; }
                                .text-right-aligned { text-align: right; }
                            </style>
                        </head>
                        <body>
                            <h1>${title}</h1>
                            ${clonedContainer.innerHTML}
                        </body>
                        </html>
                    `;
                    return htmlContent;
                }


                // Export Fund Report to Word
                exportFundReportWordBtn.onclick = () => {
                    if (typeof window.saveAs === 'undefined') {
                        showErrorMessage(translations[currentLanguage].fileSaverLoadError);
                        return;
                    }

                    const title = translations[currentLanguage].fundReportTitle;
                    const content = getHtmlForWordExport('fund-report-table-container', title); // Use the actual table container ID

                    const blob = new Blob([content], {
                        type: 'application/msword;charset=utf-8'
                    });
                    saveAs(blob, `${translations[currentLanguage].fundReportTitle}.doc`);
                };

                // Export Member Report to Word
                exportMemberReportWordBtn.onclick = () => {
                    if (typeof window.saveAs === 'undefined') {
                        showErrorMessage(translations[currentLanguage].fileSaverLoadError);
                        return;
                    }
                    const selectedMemberId = selectMemberReportDropdown.value;
                    if (!selectedMemberId) {
                        showErrorMessage(translations[currentLanguage].selectMemberForWordExport);
                        return;
                    }
                    const memberName = getMemberName(selectedMemberId);
                    const title = `${translations[currentLanguage].memberReportsTitle}: ${memberName}`;
                    const content = getHtmlForWordExport('member-report-table-container', title); // Use the actual table container ID

                    const blob = new Blob([content], {
                        type: 'application/msword;charset=utf-8'
                    });
                    saveAs(blob, `${translations[currentLanguage].memberReportsTitle}_${memberName}.doc`);
                };


                // --- Pie Chart Functions ---

                // Helper for SVG arc drawing
                function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
                    const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                    return {
                        x: centerX + (radius * Math.cos(angleInRadians)),
                        y: centerY + (radius * Math.sin(angleInRadians))
                    };
                }

                function describePieSlice(centerX, centerY, radius, startAngle, endAngle) {
                    const start = polarToCartesian(centerX, centerY, radius, endAngle);
                    const end = polarToCartesian(centerX, centerY, radius, startAngle);
                    const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

                    const pathData = [
                        `M ${centerX} ${centerY}`,
                        `L ${start.x} ${start.y}`,
                        `A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y}`,
                        `L ${centerX} ${centerY}`,
                        `Z`
                    ].join(" ");

                    return pathData;
                }

                // Renders the Member Balance Pie Chart
                function renderMemberBalancePieChart() {
                    const CHART_SIZE = 200;
                    const RADIUS = CHART_SIZE / 2 - 10;
                    const centerX = CHART_SIZE / 2;
                    const centerY = CHART_SIZE / 2;

                    const colorPalette = [
                        '#4CAF50', // Green
                        '#2196F3', // Blue
                        '#FFC107', // Amber
                        '#F44336', // Red
                        '#9C27B0', // Purple
                        '#FF9800', // Orange
                        '#00BCD4', // Cyan
                        '#E91E63', // Pink
                        '#795548', // Brown
                        '#607D8B', // Blue Grey
                    ];

                    const chartData = members.filter(m => m.balance !== 0);
                    const totalAbsoluteBalance = chartData.reduce((sum, m) => sum + Math.abs(m.balance), 0);

                    if (chartData.length === 0) {
                        memberBalancePieChartDiv.innerHTML = `<p class="text-center text-gray-500 mt-4">${translations[currentLanguage].noBalanceChart}</p>`;
                        return;
                    }

                    let currentAngle = 0;
                    let slicesSvg = '';
                    let legendHtml = '';

                    chartData.forEach((member, index) => {
                        const sliceAngle = (Math.abs(member.balance) / totalAbsoluteBalance) * 360;
                        const startAngle = currentAngle;
                        const endAngle = currentAngle + sliceAngle;

                        const pathData = describePieSlice(centerX, centerY, RADIUS, startAngle, endAngle);
                        const color = colorPalette[index % colorPalette.length];

                        const midAngle = startAngle + sliceAngle / 2;
                        const labelRadius = RADIUS * 0.7;
                        const labelPos = polarToCartesian(centerX, centerY, labelRadius, midAngle);

                        slicesSvg += `
                            <g>
                                <path
                                    d="${pathData}"
                                    fill="${color}"
                                    stroke="white"
                                    stroke-width="1"
                                />
                                ${sliceAngle > 10 ? `
                                    <text
                                        x="${labelPos.x}"
                                        y="${labelPos.y}"
                                        fill="white"
                                        font-size="10"
                                        text-anchor="middle"
                                        alignment-baseline="middle"
                                        font-weight="bold"
                                    >
                                        ${member.name}
                                    </text>
                                ` : ''}
                            </g>
                        `;
                        currentAngle = endAngle;

                        legendHtml += `
                            <div class="flex items-center mb-1">
                                <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span>
                                <span class="text-sm text-gray-800">${member.name}</span>
                            </div>
                        `;
                    });

                    memberBalancePieChartDiv.innerHTML = `
                        <svg viewBox="0 0 ${CHART_SIZE} ${CHART_SIZE}" width="100%" height="auto" style="max-width: 300px;">
                            ${slicesSvg}
                            <text x="${centerX}" y="${centerY}" text-anchor="middle" alignment-baseline="middle" font-size="12" font-weight="bold" fill="#333">
                                ${translations[currentLanguage].totalChart} ${formatNumberForDisplay(totalAbsoluteBalance)} ${translations[currentLanguage].unitCurrency}
                            </text>
                        </svg>
                        <div class="ml-8 p-4 bg-gray-50 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">${translations[currentLanguage].chartLegend}:</h4>
                            ${legendHtml}
                        </div>
                    `;
                }

                // --- Pie Charts for Categories (Income and Expense) ---

                // Extracts category from transaction description
                function extractCategory(description) {
                    const match = description.match(/\(Ph√¢n lo·∫°i: ([^)]+)\)/);
                    return match ? match[1].trim() : translations[currentLanguage].otherCategory;
                }

                // Calculates total income and expense for each category
                function calculateCategoryBalances() {
                    const incomeCategories = new Map();
                    const expenseCategories = new Map();

                    transactions.forEach(t => {
                        const category = extractCategory(t.description);
                        if (t.type === 'contribution') {
                            incomeCategories.set(category, (incomeCategories.get(category) || 0) + t.amount);
                        } else if (t.type === 'expense') {
                            expenseCategories.set(category, (expenseCategories.get(category) || 0) + t.amount);
                        }
                    });

                    return { incomeCategories, expenseCategories };
                }

                // Renders a single pie chart for a given type (income or expense)
                function renderSingleCategoryPieChart(containerElement, title, dataMap, totalAmount, colors) {
                    const CHART_SIZE = 200;
                    const RADIUS = CHART_SIZE / 2 - 10;
                    const centerX = CHART_SIZE / 2;
                    const centerY = CHART_SIZE / 2;

                    if (totalAmount === 0) {
                        containerElement.innerHTML = `<p class="text-center text-gray-500 mt-4">${translations[currentLanguage].noCategoryChart.replace('{type}', title.toLowerCase())}</p>`;
                        return;
                    }

                    let currentAngle = 0;
                    let slicesSvg = '';
                    let legendHtml = '';
                    let index = 0;

                    // Sort categories alphabetically for consistent display
                    const sortedCategories = Array.from(dataMap.keys()).sort();

                    sortedCategories.forEach(category => {
                        const amount = dataMap.get(category);
                        const percentage = (amount / totalAmount) * 100;
                        const sliceAngle = (amount / totalAmount) * 360;
                        const startAngle = currentAngle;
                        const endAngle = currentAngle + sliceAngle;

                        const pathData = describePieSlice(centerX, centerY, RADIUS, startAngle, endAngle);
                        const color = colors[index % colors.length];

                        const midAngle = startAngle + sliceAngle / 2;
                        const labelRadius = RADIUS * 0.7;
                        const labelPos = polarToCartesian(centerX, centerY, labelRadius, midAngle);

                        slicesSvg += `
                            <g>
                                <path
                                    d="${pathData}"
                                    fill="${color}"
                                    stroke="white"
                                    stroke-width="1"
                                />
                                ${percentage > 5 ? ` <text
                                        x="${labelPos.x}"
                                        y="${labelPos.y}"
                                        fill="white"
                                        font-size="10"
                                        text-anchor="middle"
                                        alignment-baseline="middle"
                                        font-weight="bold"
                                    >
                                        ${percentage.toFixed(1)}%
                                    </text>
                                ` : ''}
                            </g>
                        `;
                        currentAngle = endAngle;

                        legendHtml += `
                            <div class="flex items-center mb-1">
                                <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span>
                                <span class="text-sm text-gray-800">${category}: ${formatNumberForDisplay(amount)} ${translations[currentLanguage].unitCurrency} (${percentage.toFixed(1)}%)</span>
                            </div>
                        `;
                        index++;
                    });

                    containerElement.innerHTML = `
                        <svg viewBox="0 0 ${CHART_SIZE} ${CHART_SIZE}" width="100%" height="auto" style="max-width: 300px;">
                            ${slicesSvg}
                            <text x="${centerX}" y="${centerY}" text-anchor="middle" alignment-baseline="middle" font-size="12" font-weight="bold" fill="#333">
                                ${translations[currentLanguage].totalChart} ${formatNumberForDisplay(totalAmount)} ${translations[currentLanguage].unitCurrency}
                            </text>
                        </svg>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-sm w-full max-w-[300px]">
                            <h4 class="font-semibold text-gray-700 mb-2">${translations[currentLanguage].chartLegendFor.replace('{title}', title)}:</h4>
                            ${legendHtml}
                        </div>
                    `;
                }

                // Renders both income and expense category pie charts
                function renderCategoryPieCharts() {
                    const { incomeCategories, expenseCategories } = calculateCategoryBalances();

                    const incomeColors = [
                        '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', // Greens to Yellows
                        '#26A69A', '#00BCD4', '#009688', '#4DD0E1', '#80CBC4'  // Teals
                    ];
                    const expenseColors = [
                        '#F44336', '#E57373', '#FFCDD2', '#D32F2F', '#C62828', // Reds
                        '#FF9800', '#FFB74D', '#FFECB3', '#FB8C00', '#E65100'  // Oranges
                    ];

                    const totalIncome = Array.from(incomeCategories.values()).reduce((sum, val) => sum + val, 0);
                    const totalExpense = Array.from(expenseCategories.values()).reduce((sum, val) => sum + val, 0);

                    const incomeChartContainer = document.getElementById('income-pie-chart-container');
                    const expenseChartContainer = document.getElementById('expense-pie-chart-container');

                    renderSingleCategoryPieChart(incomeChartContainer, translations[currentLanguage].incomeByCategory, incomeCategories, totalIncome, incomeColors);
                    renderSingleCategoryPieChart(expenseChartContainer, translations[currentLanguage].expenseByCategory, expenseCategories, totalExpense, expenseColors);
                }


                // --- Gemini API Integration ---

                // Simple Markdown to HTML converter
                function markdownToHtml(markdown) {
                    let html = markdown;

                    // Convert headings (e.g., ## Heading) to <h2>
                    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

                    // Convert bold (e.g., **text**) to <strong> 
                    html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
                    // Convert italics (e.g., *text*) to <em>
                    html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');

                    // Convert unordered lists (e.g., - item) to <ul> and <li>
                    html = html.replace(/^\s*\-\s(.*)$/gim, '<li>$1</li>');
                    html = html.replace(/^(<li>.*<\/li>(\n<li>.*<\/li>)*)/gim, '<ul>$1</ul>');

                    // Convert ordered lists (e.g., 1. item) to <ol> and <li>
                    html = html.replace(/^\s*\d+\.\s(.*)$/gim, '<li>$1</li>');
                    html = html.replace(/^(<li>.*<\/li>(\n<li>.*<\/li>)*)/gim, '<ol>$1</ol>');


                    // Convert newlines to paragraphs, but only if not already part of a block element
                    html = html.split('\n').map(line => {
                        if (line.trim() === '' || line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<ol') || line.startsWith('<li>')) {
                            return line;
                        }
                        return `<p class="mb-2 text-gray-700">${line}</p>`;
                    }).join('');

                    // Clean up empty paragraphs that might be created by the above logic
                    html = html.replace(/<p class="mb-2 text-gray-700"><\/p>/g, '');

                    return html;
                }


                async function generateFundInsights() {
                    isGeneratingInsights = true;
                    fundInsightsContent.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#006B68]"></div>
                            <p class="mt-4 text-gray-600">${translations[currentLanguage].generatingInsights}</p>
                        </div>
                    `;
                    hideErrorMessage(); // Clear previous errors for insights

                    // Construct prompt for LLM
                    let prompt = `Given the following fund transactions and current fund balance for a group's meal fund, provide a concise summary of the fund's financial health and suggest 3-5 actionable tips for better fund management. The response should be in ${currentLanguage === 'vi' ? 'Vietnamese' : 'English'} and formatted using Markdown (e.g., use ## for headings, - for list items, ** for bold).

Current Fund Balance: ${formatNumberForDisplay(fundBalance)} ${translations[currentLanguage].unitCurrency}

Recent Transactions:\n`;

                    if (transactions.length === 0) {
                        prompt += `${translations[currentLanguage].noTransactions}.\n`;
                    } else {
                        transactions.slice(-10).reverse().forEach(t => { // Last 10 transactions
                            const memberNames = t.type === 'contribution'
                                ? getMemberName(t.contributingMemberId)
                                : (t.involvedMemberIds && t.involvedMemberIds.length > 0
                                    ? t.involvedMemberIds.map(id => getMemberName(id)).join(', ')
                                    : translations[currentLanguage].allMembers);
                            prompt += `- ${t.date} | ${translations[currentLanguage].typeHeader}: ${t.type === 'contribution' ? translations[currentLanguage].contributionType : translations[currentLanguage].expenseType} | ${translations[currentLanguage].amountHeader}: ${formatNumberForDisplay(t.amount)} ${translations[currentLanguage].unitCurrency} | ${translations[currentLanguage].descriptionHeader}: ${t.description} | ${translations[currentLanguage].relatedMembersHeader}: ${memberNames}\n`;
                        });
                    }

                    console.log("Sending prompt to Gemini API:", prompt);

                    try {
                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = { contents: chatHistory };
                        const apiKey = "AIzaSyBaLi7TzZJ9SwmHilU24SRcV2i7lU6gqdQ"; // Leave as empty string for Canvas to provide
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        console.log("Gemini API response:", result);

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const markdownText = result.candidates[0].content.parts[0].text;
                            // Convert Markdown to HTML before setting innerHTML
                            fundInsightsContent.innerHTML = markdownToHtml(markdownText);
                        } else {
                            fundInsightsContent.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noInsights}</p>`;
                            console.error("Unexpected Gemini API response structure:", result);
                        }
                    } catch (error) {
                        console.error("Error calling Gemini API:", error);
                        showErrorMessage(`${translations[currentLanguage].aiCallError} ${error.message}. ${translations[currentLanguage].aiConnectionError}`);
                        fundInsightsContent.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].aiConnectionError}</p>`;
                    } finally {
                        isGeneratingInsights = false;
                    }
                }

                // New function to generate food suggestions
                async function generateFoodSuggestions(latitude, longitude) {
                    isGeneratingFoodSuggestions = true;
                    foodSuggestionContent.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#006B68]"></div>
                            <p class="mt-4 text-gray-600">${translations[currentLanguage].generatingFoodSuggestions}</p>
                        </div>
                    `;
                    hideErrorMessage(); // Clear previous errors for food suggestions

                    let prompt = `Based on my current GPS location (latitude: ${latitude}, longitude: ${longitude}), suggest 3-10 popular dishes and good restaurants nearby.
                    For each suggestion, provide the following information:
                    - Restaurant Name
                    - Full Address (including house number, street name, ward/commune, district, city).
                    - Phone Number (if available)
                    - Star Rating (e.g., 4.5)
                    - Estimated Distance from my location (e.g., 1.2 km)
                    - Brief description of the restaurant or signature dish.
                    - Main menu content or a few prominent dishes.

                    The response must be a JSON array, each element being an object containing the above information. Example:
                    [
                      {
                        "name": "Restaurant Name",
                        "address": "Full restaurant address",
                        "phoneNumber": "Phone number",
                        "starRating": 4.5,
                        "estimatedDistance": "1.2 km",
                        "description": "Restaurant description",
                        "menuContent": "Prominent dishes: Dish A, Dish B, Dish C"
                      }
                    ]
                    The response should be in ${currentLanguage === 'vi' ? 'Vietnamese' : 'English'}.
                    `;

                    console.log("Sending food suggestion prompt to Gemini API:", prompt);

                    try {
                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = {
                            contents: chatHistory,
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "name": { "type": "STRING" },
                                            "address": { "type": "STRING" },
                                            "phoneNumber": { "type": "STRING" },
                                            "starRating": { "type": "NUMBER" },
                                            "estimatedDistance": { "type": "STRING" },
                                            "description": { "type": "STRING" },
                                            "menuContent": { "type": "STRING" }
                                        },
                                        "propertyOrdering": ["name", "address", "phoneNumber", "starRating", "estimatedDistance", "description", "menuContent"]
                                    }
                                }
                            }
                        };
                        const apiKey = "AIzaSyBaLi7TzZJ9SwmHilU24SRcV2i7lU6gqdQ"; // Leave as empty string for Canvas to provide
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        console.log("Gemini API food suggestion response:", result);

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            const suggestions = JSON.parse(jsonText);

                            let htmlContent = '<div class="space-y-4">';
                            if (suggestions.length > 0) {
                                suggestions.forEach(s => {
                                    // Construct Google Maps search link using the restaurant name
                                    const googleMapsSearchLink = s.name ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.name)}` : '#';

                                    htmlContent += `
                                        <div class="p-4 border border-gray-200 rounded-lg shadow-sm bg-white">
                                            <h3 class="text-lg font-semibold text-[#006B68]">${s.name}</h3>
                                            <p class="text-sm text-gray-600"><strong>${translations[currentLanguage].addressLabel}</strong> ${s.address || 'N/A'}</p>
                                            <p class="text-sm text-gray-600"><strong>${translations[currentLanguage].phoneLabel}</strong> ${s.phoneNumber || 'N/A'}</p>
                                            <p class="text-sm text-gray-600"><strong>${translations[currentLanguage].ratingLabel}</strong> ${s.starRating ? `${s.starRating} ‚≠ê` : 'N/A'}</p>
                                            <p class="text-sm text-gray-600"><strong>${translations[currentLanguage].distanceLabel}</strong> ${s.estimatedDistance || 'N/A'}</p>
                                            ${s.description ? `<p class="text-sm text-gray-700 mt-2"><strong>${translations[currentLanguage].descriptionLabelShort}</strong> ${s.description}</p>` : ''}
                                            ${s.menuContent ? `<p class="text-sm text-gray-700"><strong>${translations[currentLanguage].menuLabel}</strong> ${s.menuContent}</p>` : ''}
                                            ${s.name ? `<a href="${googleMapsSearchLink}" target="_blank" class="text-blue-500 hover:underline text-sm mt-2 block">${translations[currentLanguage].viewOnMaps}</a>` : ''}
                                        </div>
                                    `;
                                });
                            } else {
                                htmlContent += `<p class="text-center text-gray-500">${translations[currentLanguage].noFoodSuggestions}</p>`;
                            }
                            htmlContent += '</div>';
                            foodSuggestionContent.innerHTML = htmlContent;

                        } else {
                            foodSuggestionContent.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noFoodSuggestions}</p>`;
                            console.error("Unexpected Gemini API food suggestion response structure:", result);
                        }
                    } catch (error) {
                        console.error("Error calling Gemini API for food suggestions:", error);
                        showErrorMessage(`${translations[currentLanguage].aiCallError} ${error.message}. ${translations[currentLanguage].aiConnectionError}`);
                        foodSuggestionContent.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].aiConnectionError}</p>`;
                    } finally {
                        isGeneratingFoodSuggestions = false;
                    }
                }


                // --- Image Upload and AI Description Functions ---

                // Calls Gemini Vision API
                async function callGeminiVisionAPI(base64ImageData, mimeType) {
                    const prompt = `Describe the content of this image concisely for the purpose of clarifying what is being spent or received.
                    Examples of expenses: drinking coffee, eating rice, eating vermicelli, eating Thai food, eating hotpot.
                    Examples of contributions: Van A submitted money via bank transfer from BIDV bank.
                    Information about the location if present in the image (e.g., restaurant name).
                    Categorize the income/expense related to money submission and types of food/drink. Examples: 'fund contribution', 'eating rice', 'drinking coffee', 'eating pho', 'eating vermicelli', 'eating Japanese food', 'eating Thai food'.
                    If there's an amount in the image, put the amount in the amount field (number only, no unit).
                    If there's information about income or expense, select the corresponding transaction type as 'contribution' or 'expense'. If unsure, leave it blank.

                    The response must be a JSON object with the following fields:
                    {
                      "description": "Concise description of the image content",
                      "amount": "Amount (number only, no unit, if available)",
                      "transactionType": "Transaction type ('contribution' or 'expense', if identifiable)",
                      "location": "Location (if available)",
                      "category": "Category (e.g., 'fund contribution', 'eating rice', 'drinking coffee')"
                    }
                    The response should be in ${currentLanguage === 'vi' ? 'Vietnamese' : 'English'}.
                    `;

                    try {
                        let chatHistory = [];
                        const payload = {
                            contents: [
                                {
                                    role: "user",
                                    parts: [
                                        { text: prompt },
                                        {
                                            inlineData: {
                                                mimeType: mimeType,
                                                data: base64ImageData
                                            }
                                        }
                                    ]
                                }
                            ],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        "description": { "type": "STRING" },
                                        "amount": { "type": "STRING" },
                                        "transactionType": { "type": "STRING" },
                                        "location": { "type": "STRING" },
                                        "category": { "type": "STRING" }
                                    },
                                    "propertyOrdering": ["description", "amount", "transactionType", "location", "category"]
                                }
                            }
                        };
                        const apiKey = "AIzaSyBaLi7TzZJ9SwmHilU24SRcV2i7lU6gqdQ";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        console.log("Gemini Vision API response:", result);

                        if (result.error) {
                            showErrorMessage(`${translations[currentLanguage].apiError} ${result.error.message}. ${translations[currentLanguage].aiConnectionError}`);
                            console.error("Gemini Vision API Error:", result.error);
                            return;
                        }

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonString = result.candidates[0].content.parts[0].text;
                            const parsedResult = JSON.parse(jsonString);

                            let fullDescription = parsedResult.description || '';
                            if (parsedResult.location) {
                                fullDescription += ` (${currentLanguage === 'vi' ? 'ƒê·ªãa ƒëi·ªÉm' : 'Location'}: ${parsedResult.location})`;
                            }
                            if (parsedResult.category) {
                                fullDescription += ` (${currentLanguage === 'vi' ? 'Ph√¢n lo·∫°i' : 'Category'}: ${parsedResult.category})`;
                            }
                            descriptionInput.value = fullDescription.trim();

                            const extractedAmount = parseFloat(parsedResult.amount.replace(/\D/g, ''));
                            if (!isNaN(extractedAmount) && extractedAmount > 0) {
                                amountInput.value = formatNumberForInput(extractedAmount.toString());
                            }

                            if (parsedResult.transactionType === 'contribution' || parsedResult.transactionType === 'expense') {
                                transactionTypeSelect.value = parsedResult.transactionType;
                                transactionTypeSelect.dispatchEvent(new Event('change'));
                            }

                        } else {
                            showErrorMessage(translations[currentLanguage].noImageDescription);
                            console.error("Unexpected Gemini Vision API response structure:", result);
                        }
                    } catch (error) {
                        console.error("Error calling Gemini Vision API:", error);
                        showErrorMessage(`${translations[currentLanguage].aiCallError} ${error.message}. ${translations[currentLanguage].aiConnectionError}`);
                    } finally {
                        cameraLoadingSpinner.style.display = 'none';
                        cameraModal.classList.add('hidden');
                    }
                }


                // --- Event Listeners ---

                // Language switch buttons
                langViBtn.addEventListener('click', () => setLanguage('vi'));
                langEnBtn.addEventListener('click', () => setLanguage('en'));

                // Main Navigation Buttons
                document.getElementById('add-member-btn').onclick = () => {
                    hideAllSections();
                    addMemberSection.classList.remove('hidden');
                    memberNameInput.value = '';
                    scrollToSection('add-member-section');
                };

                document.getElementById('add-transaction-btn').onclick = () => {
                    hideAllSections();
                    addTransactionSection.classList.remove('hidden');
                    amountInput.value = '';
                    descriptionInput.value = '';
                    transactionTypeSelect.value = 'contribution';
                    populateMemberSelectors();
                    transactionTypeSelect.dispatchEvent(new Event('change'));
                    scrollToSection('add-transaction-section');
                };

                document.getElementById('view-transactions-btn').onclick = () => {
                    hideAllSections();
                    transactionsSection.classList.remove('hidden');
                    renderTransactionList();
                    scrollToSection('transactions-section');
                };

                document.getElementById('show-report-selection-btn').onclick = () => {
                    hideAllSections();
                    reportSelectionModal.classList.remove('hidden');
                };

                document.getElementById('get-insights-btn').onclick = () => {
                    hideAllSections();
                    fundInsightsModal.classList.remove('hidden');
                    generateFundInsights();
                };

                document.getElementById('get-food-suggestions-btn').onclick = () => {
                    hideAllSections();
                    foodSuggestionModal.classList.remove('hidden');
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            generateFoodSuggestions(position.coords.latitude, position.coords.longitude);
                        }, (error) => {
                            console.error("Error getting location:", error);
                            let errorMessage = translations[currentLanguage].locationError;
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMessage = translations[currentLanguage].permissionDenied;
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errorMessage = translations[currentLanguage].positionUnavailable;
                            } else if (error.code === error.TIMEOUT) {
                                errorMessage = translations[currentLanguage].timeout;
                            }
                            foodSuggestionContent.innerHTML = `<p class="text-center text-red-500">${errorMessage}</p>`;
                            showErrorMessage(errorMessage);
                        });
                    } else {
                        const errorMessage = translations[currentLanguage].geolocationNotSupported;
                        foodSuggestionContent.innerHTML = `<p class="text-center text-red-500">${errorMessage}</p>`;
                        showErrorMessage(errorMessage);
                    }
                };

                // Report Selection Modal Buttons
                selectFundReportBtn.onclick = () => {
                    hideAllSections();
                    fundReportSection.classList.remove('hidden');
                    reportSelectionModal.classList.add('hidden');
                    renderFundReport();
                    scrollToSection('fund-report-section');
                };

                selectMemberReportBtn.onclick = () => {
                    hideAllSections();
                    memberReportsSection.classList.remove('hidden');
                    reportSelectionModal.classList.add('hidden');
                    renderMemberReportDropdown();
                    scrollToSection('member-reports-section');
                };

                closeReportSelectionBtn.onclick = () => {
                    reportSelectionModal.classList.add('hidden');
                };

                // Edit Transaction Modal Buttons
                cancelEditTransactionBtn.onclick = () => {
                    editTransactionModal.classList.add('hidden');
                    editingTransaction = null;
                    hideErrorMessage();
                };

                // Member Details Modal Button
                closeMemberDetailsBtn.onclick = () => {
                    memberDetailsModal.classList.add('hidden');
                    selectedMemberForDetails = null;
                };

                // Close Insights Modal Button
                closeInsightsBtn.onclick = () => {
                    fundInsightsModal.classList.add('hidden');
                    fundInsightsContent.innerHTML = '';
                };

                // Close Food Suggestion Modal Button
                closeFoodSuggestionBtn.onclick = () => {
                    foodSuggestionModal.classList.add('hidden');
                    foodSuggestionContent.innerHTML = '';
                };

                // Member Report Dropdown Change
                selectMemberReportDropdown.onchange = renderSelectedMemberReport;

                // Amount input formatting for add and edit forms
                amountInput.addEventListener('input', (e) => {
                    e.target.value = formatNumberForInput(e.target.value);
                });
                editAmountInput.addEventListener('input', (e) => {
                    e.target.value = formatNumberForInput(e.target.value);
                });

                // --- Image Upload Modal Event Listeners ---
                aiDescribeBtn.onclick = () => {
                    hideErrorMessage();
                    cameraModal.classList.remove('hidden');
                    uploadedImagePreview.classList.add('hidden');
                    cameraLoadingSpinner.style.display = 'none';
                    imageUploadInput.value = '';
                    imageUploadInput.click();
                };

                imageUploadInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) {
                        cameraModal.classList.add('hidden');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImagePreview.src = e.target.result;
                        uploadedImagePreview.classList.remove('hidden');
                        cameraLoadingSpinner.style.display = 'block';

                        const base64Image = e.target.result;
                        const mimeType = file.type;
                        const base64DataOnly = base64Image.split(',')[1];
                        callGeminiVisionAPI(base64DataOnly, mimeType);
                    };
                    reader.readAsDataURL(file);
                };

                cancelCameraBtn.onclick = () => {
                    cameraModal.classList.add('hidden');
                    imageUploadInput.value = '';
                };

                // --- Scroll to Top Button Logic ---
                window.onscroll = function() {
                    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                        scrollToTopBtn.classList.add('show');
                    } else {
                        scrollToTopBtn.classList.remove('show');
                    }
                };

                scrollToTopBtn.onclick = function() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };


                // Initial data fetch and UI render when DOM is fully loaded
                document.addEventListener('DOMContentLoaded', () => {
                    setLanguage(currentLanguage); // Set initial language
                    initializeSupabase();
                });
            </script>
<script>
    // Khi b·∫•m v√†o hamburger, toggle menu
    document.getElementById('hamburger-btn').addEventListener('click', function() {
        const menu = document.getElementById('hamburger-menu');
        console.log('Hamburger button clicked!');
        console.log('Menu before toggle:', menu.classList.contains('hidden') ? 'hidden' : 'visible');
        menu.classList.toggle('hidden');
        console.log('Menu after toggle:', menu.classList.contains('hidden') ? 'hidden' : 'visible');
    });
</script>

        </body>
        </html>
