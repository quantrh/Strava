<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Qu·ªπ C∆°m Nh√≥m</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #006B68; /* BIDV Brand Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #005A58; /* Darker BIDV Blue */ }
        .btn-secondary {
            background-color: #E0E7FF; /* Light background */
            color: #006B68; /* BIDV Brand Blue for text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover { background-color: #CCF0EF; /* Lighter BIDV Blue for hover */ }
        .input-field {
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .table-header th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #4B5563;
            border-bottom: 1px solid #E5E7EB;
        }
        .table-row td {
            padding: 0.75rem;
            border-bottom: 1px solid #F3F4F6;
        }
        .balance-positive { color: #10B981; font-weight: 600; } /* Green */
        .balance-negative { color: #EF4444; font-weight: 600; } /* Red */
        .balance-zero { color: #6B7280; } /* Gray */
        .error-message {
            background-color: #FEE2E2;
            color: #DC2626;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .text-right-aligned {
            text-align: right; /* Custom class for right alignment */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans text-gray-800">

    <h1 class="text-4xl font-bold text-center text-[#006B68] mb-8">Qu·∫£n L√Ω Qu·ªπ C∆°m Nh√≥m</h1>

    <div id="fund-balance-card" class="card mb-8 text-center">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">S·ªë D∆∞ Qu·ªπ Chung</h2>
        <p id="fund-balance-display" class="text-5xl font-extrabold text-green-600">0 VNƒê</p>
    </div>

    <div id="error-message-display" class="error-message mb-4 hidden"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button id="add-member-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
            Th√™m Th√†nh Vi√™n
        </button>
        <button id="add-transaction-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
            Th√™m Giao D·ªãch
        </button>
        <button id="view-transactions-btn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd"></path></svg>
            Xem L·ªãch S·ª≠
        </button>
        <button id="show-report-selection-btn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v14a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm4.5 9.5a.5.5 0 000 1h5a.5.5 0 000-1h-5zM7 7a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
            B√°o C√°o
        </button>
        <button id="get-insights-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            ‚ú® AI Nh·∫≠n X√©t Qu·ªπ
        </button>
    </div>

    <div id="add-member-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]">Th√™m Th√†nh Vi√™n M·ªõi</h2>
        <form id="add-member-form" class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="member-name-input" name="memberName" placeholder="T√™n th√†nh vi√™n" class="input-field flex-grow" required />
            <button type="submit" class="btn-primary flex-shrink-0 w-full sm:w-auto">Th√™m</button>
        </form>
    </div>

    <div id="add-transaction-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]">Th√™m Giao D·ªãch M·ªõi</h2>
        <form id="add-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-full">
                <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i Giao D·ªãch</label>
                <select id="transaction-type" name="transactionType" class="input-field">
                    <option value="contribution">üíµ ƒê√≥ng G√≥p</option>
                    <option value="expense">üç∫ Chi Ti√™u</option>
                </select>
            </div>

            <div id="contributing-member-div" class="col-span-full">
                <label for="member-select" class="block text-sm font-medium text-gray-700 mb-1">Th√†nh Vi√™n ƒê√≥ng G√≥p</label>
                <select id="member-select" name="contributingMember" class="input-field" required></select>
            </div>

            <div id="involved-members-div" class="col-span-full hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">Th√†nh Vi√™n Tham Gia Chi Ti√™u</label>
                <div id="involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                    </div>
            </div>

            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">S·ªë Ti·ªÅn (VNƒê)</label>
                <input type="text" id="amount-input" name="amount" placeholder="S·ªë ti·ªÅn" class="input-field text-right" required />
            </div>
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">M√¥ T·∫£</label>
                <input type="text" id="description-input" name="description" placeholder="M√¥ t·∫£ giao d·ªãch" class="input-field" required />
            </div>
            <div class="col-span-full">
                <button type="submit" class="btn-primary w-full">Ghi L·∫°i Giao D·ªãch</button>
            </div>
        </form>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]">Danh S√°ch Th√†nh Vi√™n</h2>
        <div id="member-list-container" class="overflow-x-auto">
            <p class="text-center text-gray-500">ƒêang t·∫£i th√†nh vi√™n...</p>
        </div>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]">B√°o C√°o T√≥m T·∫Øt</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
            <div class="p-4 bg-green-50 rounded-lg">
                <p class="text-lg font-medium text-green-700">T·ªïng ƒê√≥ng G√≥p</p>
                <p id="total-contributions-display" class="text-3xl font-bold text-green-600">0 VNƒê</p>
            </div>
            <div class="p-4 bg-red-50 rounded-lg">
                <p class="text-lg font-medium text-red-700">T·ªïng Chi Ti√™u</p>
                <p id="total-expenses-display" class="text-3xl font-bold text-red-600">0 VNƒê</p>
            </div>
        </div>
        <h3 class="text-xl font-semibold mt-8 mb-4 text-[#006B68] text-center">S·ªë D∆∞ Th√†nh Vi√™n (Bi·ªÉu ƒê·ªì Tr√≤n)</h3>
        <div id="member-balance-pie-chart" class="flex justify-center items-center w-full my-4">
            <p class="text-center text-gray-500 mt-4">ƒêang t·∫£i bi·ªÉu ƒë·ªì...</p>
        </div>
    </div>

    <div id="fund-report-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]">B√°o C√°o Qu·ªπ Chung</h2>
        <div class="flex flex-wrap justify-end gap-4 mb-4">
            <button id="export-fund-report-excel" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                Xu·∫•t Excel
            </button>
        </div>
        <div id="fund-report-table-container" class="overflow-x-auto">
            <p class="text-center text-gray-500">Ch∆∞a c√≥ giao d·ªãch n√†o ƒë·ªÉ b√°o c√°o.</p>
        </div>
    </div>

    <div id="member-reports-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]">B√°o C√°o T·ª´ng Th√†nh Vi√™n</h2>
        <div class="mb-4">
            <label for="select-member-report" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn Th√†nh Vi√™n:</label>
            <select id="select-member-report" name="selectMemberReport" class="input-field"></select>
        </div>
        <div class="flex flex-wrap justify-end gap-4 mb-4">
            <button id="export-member-report-excel" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                Xu·∫•t Excel
            </button>
        </div>
        <div id="member-report-table-container" class="overflow-x-auto">
            <p class="text-center text-gray-500">Vui l√≤ng ch·ªçn m·ªôt th√†nh vi√™n ƒë·ªÉ xem b√°o c√°o.</p>
        </div>
    </div>

    <div id="transactions-section" class="card hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]">L·ªãch S·ª≠ Giao D·ªãch</h2>
        <div id="transaction-list-container" class="overflow-x-auto">
            <p class="text-center text-gray-500">ƒêang t·∫£i giao d·ªãch...</p>
        </div>
    </div>

    <div id="edit-transaction-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]">Ch·ªânh S·ª≠a Giao D·ªãch</h2>
            <form id="edit-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full">
                    <label for="edit-transaction-type" class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i Giao D·ªãch</label>
                    <select id="edit-transaction-type" name="editTransactionType" class="input-field">
                        <option value="contribution">üíµ ƒê√≥ng G√≥p</option>
                        <option value="expense">üç∫ Chi Ti√™u</option>
                    </select>
                </div>

                <div id="edit-contributing-member-div" class="col-span-full">
                    <label for="edit-member-select" class="block text-sm font-medium text-gray-700 mb-1">Th√†nh Vi√™n ƒê√≥ng G√≥p</label>
                    <select id="edit-member-select" name="editContributingMember" class="input-field" required></select>
                </div>

                <div id="edit-involved-members-div" class="col-span-full hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Th√†nh Vi√™n Tham Gia Chi Ti√™u</label>
                    <div id="edit-involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                        </div>
                </div>

                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-gray-700 mb-1">S·ªë Ti·ªÅn (VNƒê)</label>
                    <input type="text" id="edit-amount-input" name="editAmount" placeholder="S·ªë ti·ªÅn" class="input-field text-right" required />
                </div>
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1">M√¥ T·∫£</label>
                    <input type="text" id="edit-description-input" name="editDescription" placeholder="M√¥ t·∫£ giao d·ªãch" class="input-field" required />
                </div>
                <div class="col-span-full flex flex-col sm:flex-row justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-transaction-btn" class="btn-secondary w-full sm:w-auto">H·ªßy</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto">L∆∞u Thay ƒê·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="member-details-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 id="member-details-name" class="text-2xl font-semibold mb-6 text-[#006B68]"></h2>
            <div class="mb-4">
                <p class="text-lg font-medium text-gray-700">S·ªë D∆∞ Hi·ªán T·∫°i:</p>
                <p id="member-details-balance" class="text-3xl font-bold"></p>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-[#006B68]">C√°c Giao D·ªãch Li√™n Quan</h3>
            <div id="member-details-transactions-container" class="overflow-x-auto max-h-80">
                <p class="text-center text-gray-500">ƒêang t·∫£i giao d·ªãch...</p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-member-details-btn" class="btn-primary">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">X√°c Nh·∫≠n</h2>
            <p id="confirmation-message" class="mb-6 text-gray-700"></p>
            <div class="flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" id="cancel-confirmation-btn" class="btn-secondary w-full sm:w-auto">H·ªßy</button>
                <button type="button" id="confirm-action-btn" class="btn-primary w-full sm:w-auto">X√°c Nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="report-selection-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68] text-center">Ch·ªçn Lo·∫°i B√°o C√°o</h2>
            <div class="flex flex-col gap-4">
                <button id="select-fund-report-btn" class="btn-primary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                    B√°o C√°o Qu·ªπ Chung
                </button>
                <button id="select-member-report-btn" class="btn-primary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a4 4 0 00-4 4h8a4 4 0 00-4-4z" clip-rule="evenodd"></path></svg>
                    B√°o C√°o T·ª´ng Th√†nh Vi√™n
                </button>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-report-selection-btn" class="btn-secondary">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="fund-insights-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]">Th√¥ng Tin Chi Ti·∫øt Qu·ªπ ‚ú®</h2>
            <div id="fund-insights-content">
                </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-insights-btn" class="btn-primary">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Client Initialization
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your actual Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Replace with your actual Supabase Anon Key
        let supabase;

        // Global state variables (mimicking React state)
        let members = [];
        let transactions = [];
        let fundBalance = 0;
        let currentErrorMessage = '';
        let selectedMemberForDetails = null;
        let transactionToDelete = null;
        let isGeneratingInsights = false;

        // DOM Elements
        const fundBalanceDisplay = document.getElementById('fund-balance-display');
        const errorMessageDisplay = document.getElementById('error-message-display');
        const addMemberSection = document.getElementById('add-member-section');
        const addTransactionSection = document.getElementById('add-transaction-section');
        const transactionsSection = document.getElementById('transactions-section');
        const fundReportSection = document.getElementById('fund-report-section');
        const memberReportsSection = document.getElementById('member-reports-section');
        const memberListContainer = document.getElementById('member-list-container');
        const transactionListContainer = document.getElementById('transaction-list-container');
        const totalContributionsDisplay = document.getElementById('total-contributions-display');
        const totalExpensesDisplay = document.getElementById('total-expenses-display');
        const memberBalancePieChartDiv = document.getElementById('member-balance-pie-chart');

        // Modals
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const memberDetailsModal = document.getElementById('member-details-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const reportSelectionModal = document.getElementById('report-selection-modal');
        const fundInsightsModal = document.getElementById('fund-insights-modal');
        const fundInsightsContent = document.getElementById('fund-insights-content');

        // Forms and Inputs
        const addMemberForm = document.getElementById('add-member-form');
        const memberNameInput = document.getElementById('member-name-input');
        const addTransactionForm = document.getElementById('add-transaction-form');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const contributingMemberDiv = document.getElementById('contributing-member-div');
        const memberSelect = document.getElementById('member-select');
        const involvedMembersDiv = document.getElementById('involved-members-div');
        const involvedMembersCheckboxes = document.getElementById('involved-members-checkboxes');
        const amountInput = document.getElementById('amount-input');
        const descriptionInput = document.getElementById('description-input');

        // Edit Transaction Form Elements
        let editingTransaction = null; // Store the transaction being edited
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editContributingMemberDiv = document.getElementById('edit-contributing-member-div');
        const editMemberSelect = document.getElementById('edit-member-select');
        const editInvolvedMembersDiv = document.getElementById('edit-involved-members-div');
        const editInvolvedMembersCheckboxes = document.getElementById('edit-involved-members-checkboxes');
        const editAmountInput = document.getElementById('edit-amount-input');
        const editDescriptionInput = document.getElementById('edit-description-input');
        const cancelEditTransactionBtn = document.getElementById('cancel-edit-transaction-btn');

        // Member Details Modal Elements
        const memberDetailsName = document.getElementById('member-details-name');
        const memberDetailsBalance = document = document.getElementById('member-details-balance');
        const memberDetailsTransactionsContainer = document.getElementById('member-details-transactions-container');
        const closeMemberDetailsBtn = document.getElementById('close-member-details-btn');

        // Confirmation Modal Elements
        const confirmationMessage = document.getElementById('confirmation-message');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');

        // Report Selection Modal Elements
        const selectFundReportBtn = document.getElementById('select-fund-report-btn');
        const selectMemberReportBtn = document.getElementById('select-member-report-btn');
        const closeReportSelectionBtn = document.getElementById('close-report-selection-btn');

        // Member Report Specific Elements
        const selectMemberReportDropdown = document.getElementById('select-member-report');
        const memberReportTableContainer = document.getElementById('member-report-table-container');
        const exportMemberReportExcelBtn = document.getElementById('export-member-report-excel');

        // Fund Report Specific Elements
        const fundReportTableContainer = document.getElementById('fund-report-table-container');
        const exportFundReportExcelBtn = document.getElementById('export-fund-report-excel');

        // Insights Modal Elements
        const closeInsightsBtn = document.getElementById('close-insights-btn');

        // --- Helper Functions ---

        // Formats a number with thousands separators for display
        function formatNumberForDisplay(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '';
            }
            return num.toLocaleString('vi-VN');
        }

        // Formats a number string with thousands separators for input fields
        function formatNumberForInput(value) {
            const cleanedValue = value.replace(/\D/g, '');
            if (!cleanedValue) {
                return '';
            }
            return parseFloat(cleanedValue).toLocaleString('vi-VN');
        }

        // Parses a formatted number string back to a raw number
        function parseFormattedNumber(formattedValue) {
            const cleanedValue = formattedValue.replace(/\D/g, '');
            return parseFloat(cleanedValue) || 0;
        }

        // Displays an error message
        function showErrorMessage(message) {
            currentErrorMessage = message;
            errorMessageDisplay.textContent = message;
            errorMessageDisplay.classList.remove('hidden');
        }

        // Hides the error message
        function hideErrorMessage() {
            currentErrorMessage = '';
            errorMessageDisplay.classList.add('hidden');
        }

        // Hides all main sections and modals
        function hideAllSections() {
            addMemberSection.classList.add('hidden');
            addTransactionSection.classList.add('hidden');
            transactionsSection.classList.add('hidden');
            fundReportSection.classList.add('hidden');
            memberReportsSection.classList.add('hidden');
            editTransactionModal.classList.add('hidden');
            memberDetailsModal.classList.add('hidden');
            confirmationModal.classList.add('hidden');
            reportSelectionModal.classList.add('hidden');
            fundInsightsModal.classList.add('hidden');
            hideErrorMessage();
        }

        // --- Supabase and Data Management ---

        // Initializes Supabase client
        function initializeSupabase() {
            if (typeof window.supabase === 'undefined') {
                showErrorMessage("L·ªói: Th∆∞ vi·ªán Supabase ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.");
                return;
            }
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                showErrorMessage("C·∫£nh b√°o: URL ho·∫∑c Kh√≥a Supabase v·∫´n l√† gi√° tr·ªã m·∫∑c ƒë·ªãnh. Vui l√≤ng thay th·∫ø b·∫±ng th√¥ng tin d·ª± √°n th·ª±c c·ªßa b·∫°n.");
                return;
            }
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized.");
            fetchData(); // Fetch initial data after initialization
            setupRealtimeSubscriptions(); // Set up real-time listeners
        }

        // Fetches all data from Supabase
        async function fetchData() {
            showLoading(true);
            try {
                // Fetch members
                const { data: membersData, error: membersError } = await supabase
                    .from('members')
                    .select('*');

                if (membersError) {
                    if (membersError.message.includes('relation "public.members" does not exist')) {
                        showErrorMessage("L·ªói: C√°c b·∫£ng d·ªØ li·ªáu (members, transactions) ch∆∞a ƒë∆∞·ª£c t·∫°o trong Supabase. Vui l√≤ng ch·∫°y c√°c script SQL ƒë√£ cung c·∫•p tr∆∞·ªõc ƒë√≥.");
                    } else {
                        showErrorMessage(`L·ªói khi t·∫£i d·ªØ li·ªáu th√†nh vi√™n: ${membersError.message}`);
                    }
                    throw membersError;
                }

                // Fetch transactions
                const { data: transactionsData, error: transactionsError } = await supabase
                    .from('transactions')
                    .select('*');

                if (transactionsError) {
                    if (transactionsError.message.includes('relation "public.transactions" does not exist')) {
                        showErrorMessage("L·ªói: C√°c b·∫£ng d·ªØ li·ªáu (members, transactions) ch∆∞a ƒë∆∞·ª£c t·∫°o trong Supabase. Vui l√≤ng ch·∫°y c√°c script SQL ƒë√£ cung c·∫•p tr∆∞·ªõc ƒë√≥.");
                    } else {
                        showErrorMessage(`L·ªói khi t·∫£i d·ªØ li·ªáu giao d·ªãch: ${transactionsError.message}`);
                    }
                    throw transactionsError;
                }

                members = membersData;
                transactions = transactionsData;

                // If no members exist, populate with default data
                if (members.length === 0) {
                    console.log("No members found, populating with default data...");
                    const initialMembers = [
                        { name: 'Tr∆∞∆°ng H·ªìng Qu√¢n' },
                        { name: 'B√πi Ho√†ng Giang' },
                        { name: 'Nguy·ªÖn Th·ªã Hoa H·∫≠u' },
                    ];
                    const { data: newMembers, error: newMembersError } = await supabase
                        .from('members')
                        .insert(initialMembers)
                        .select();

                    if (newMembersError) throw newMembersError;
                    members = newMembers;

                    // Create initial transactions using the IDs of newly inserted members
                    const initialTransactions = [
                        { type: 'contribution', amount: 500000, description: 'ƒê√≥ng g√≥p ban ƒë·∫ßu', date: new Date().toLocaleString(), contributingMemberId: newMembers[0].id },
                        { type: 'contribution', amount: 300000, description: 'ƒê√≥ng g√≥p th√™m', date: new Date().toLocaleString(), contributingMemberId: newMembers[1].id },
                        { type: 'expense', amount: 150000, description: 'Mua ƒë·ªì ƒÉn nh·∫π', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id] },
                        { type: 'contribution', amount: 200000, description: 'ƒê√≥ng g√≥p th√°ng 5', date: new Date().toLocaleString(), contributingMemberId: newMembers[2].id },
                        { type: 'expense', amount: 250000, description: 'Ti·ªÅn n∆∞·ªõc u·ªëng', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[2].id] },
                        { type: 'expense', amount: 300000, description: 'ƒê·∫∑t c∆°m tr∆∞a', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id] },
                    ];
                    const { data: newTransactions, error: newTransactionsError } = await supabase
                        .from('transactions')
                        .insert(initialTransactions)
                        .select();

                    if (newTransactionsError) throw newTransactionsError;
                    transactions = newTransactions;
                }

                updateUI(); // Update UI after fetching data
            } catch (error) {
                console.error("Error fetching data from Supabase:", error.message);
                // Error message already set by specific checks above, or fallback here
                if (!currentErrorMessage) {
                    showErrorMessage(`L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        }

        // Sets up real-time subscriptions for members and transactions
        function setupRealtimeSubscriptions() {
            supabase
                .channel('public:members')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, payload => {
                    console.log('Member change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();

            supabase
                .channel('public:transactions')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, payload => {
                    console.log('Transaction change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();
        }

        // Shows/hides a loading indicator
        function showLoading(isLoading) {
            const loadingDiv = document.getElementById('loading-overlay'); // Assuming a loading overlay div exists
            if (loadingDiv) {
                loadingDiv.classList.toggle('hidden', !isLoading);
            }
            // You might also disable buttons or inputs here
        }

        // --- UI Update Functions ---

        // Updates all dynamic parts of the UI
        function updateUI() {
            calculateBalances();
            renderFundBalance();
            renderMemberList();
            renderReportingSummary();
            renderTransactionList(); // Re-render transaction list if visible
            renderMemberReportDropdown(); // Update member report dropdown
            renderMemberBalancePieChart(); // Update pie chart
        }

        // Calculates fund and member balances
        function calculateBalances() {
            let totalBalance = 0;
            const tempMemberBalances = new Map(members.map(m => [m.id, 0]));

            transactions.forEach(t => {
                if (t.type === 'contribution') {
                    totalBalance += t.amount;
                    if (tempMemberBalances.has(t.contributingMemberId)) {
                        tempMemberBalances.set(t.contributingMemberId, tempMemberBalances.get(t.contributingMemberId) + t.amount);
                    }
                } else if (t.type === 'expense') {
                    totalBalance -= t.amount;
                    const involvedMembers = t.involvedMemberIds && t.involvedMemberIds.length > 0
                        ? t.involvedMemberIds
                        : members.map(m => m.id);

                    if (involvedMembers.length > 0) {
                        const costPerMember = t.amount / involvedMembers.length;
                        involvedMembers.forEach(memberId => {
                            if (tempMemberBalances.has(memberId)) {
                                tempMemberBalances.set(memberId, tempMemberBalances.get(memberId) - costPerMember);
                            }
                        });
                    }
                }
            });

            members = members.map(member => ({
                ...member,
                balance: tempMemberBalances.get(member.id) || 0
            }));
            fundBalance = totalBalance;
        }

        // Renders the overall fund balance
        function renderFundBalance() {
            fundBalanceDisplay.textContent = `${formatNumberForDisplay(fundBalance)} VNƒê`;
            fundBalanceDisplay.classList.remove('text-green-600', 'text-red-600');
            if (fundBalance >= 0) {
                fundBalanceDisplay.classList.add('text-green-600');
            } else {
                fundBalanceDisplay.classList.add('text-red-600');
            }
        }

        // Renders the member list table
        function renderMemberList() {
            if (members.length === 0) {
                memberListContainer.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ th√†nh vi√™n n√†o. H√£y th√™m th√†nh vi√™n!</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="table-header">T√™n Th√†nh Vi√™n</th>
                            <th class="table-header text-right-aligned">S·ªë D∆∞</th>
                            <th class="table-header">H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            members.forEach(member => {
                const balanceClass = member.balance > 0 ? 'balance-positive' :
                                     member.balance < 0 ? 'balance-negative' :
                                     'balance-zero';
                tableHtml += `
                    <tr class="table-row">
                        <td class="font-medium text-gray-900">${member.name}</td>
                        <td class="text-right-aligned">
                            <span class="text-lg font-bold ${balanceClass}">
                                ${formatNumberForDisplay(member.balance)} VNƒê
                            </span>
                        </td>
                        <td class="flex flex-col sm:flex-row gap-2">
                            <button data-member-id="${member.id}" class="settle-up-btn text-[#006B68] hover:text-[#005A58] font-semibold text-sm w-full sm:w-auto" ${member.balance === 0 ? 'disabled' : ''}>
                                Thanh To√°n
                            </button>
                            <button data-member-id="${member.id}" class="view-details-btn text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto">
                                Xem chi ti·∫øt
                            </button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            memberListContainer.innerHTML = tableHtml;

            // Attach event listeners for settle up and view details buttons
            memberListContainer.querySelectorAll('.settle-up-btn').forEach(button => {
                button.onclick = (e) => settleUpMember(e.target.dataset.memberId);
            });
            memberListContainer.querySelectorAll('.view-details-btn').forEach(button => {
                button.onclick = (e) => showMemberDetailsModal(members.find(m => m.id === e.target.dataset.memberId));
            });
        }

        // Renders the reporting summary (total contributions and expenses)
        function renderReportingSummary() {
            const totalContributions = transactions.filter(t => t.type === 'contribution').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            totalContributionsDisplay.textContent = `${formatNumberForDisplay(totalContributions)} VNƒê`;
            totalExpensesDisplay.textContent = `${formatNumberForDisplay(totalExpenses)} VNƒê`;
        }

        // Renders the transaction list table
        function renderTransactionList() {
            if (transactionsSection.classList.contains('hidden')) return; // Only render if visible

            if (transactions.length === 0) {
                transactionListContainer.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th>Ng√†y</th>
                            <th>Lo·∫°i</th>
                            <th>M√¥ T·∫£</th>
                            <th>Th√†nh Vi√™n Li√™n Quan</th>
                            <th class="table-header text-right-aligned">S·ªë Ti·ªÅn (VNƒê)</th>
                            <th>H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            transactions.slice().reverse().forEach(t => { // Display latest first
                // For the general transaction list, always display the total amount of the expense
                const displayedAmount = t.amount;
                const typeText = t.type === 'contribution' ? 'üíµ ƒê√≥ng G√≥p' : 'üç∫ Chi Ti√™u';
                const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                const memberNames = t.type === 'contribution'
                    ? getMemberName(t.contributingMemberId)
                    : getInvolvedMembersNames(t.involvedMemberIds);

                tableHtml += `
                    <tr class="table-row">
                        <td>${t.date}</td>
                        <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                        <td>${t.description}</td>
                        <td>${memberNames}</td>
                        <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                        <td class="flex flex-col sm:flex-row gap-2">
                            <button data-transaction-id="${t.id}" class="edit-transaction-btn text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto">S·ª≠a</button>
                            <button data-transaction-id="${t.id}" class="delete-transaction-btn text-red-600 hover:text-red-900 font-semibold text-sm w-full sm:w-auto">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            transactionListContainer.innerHTML = tableHtml;

            // Attach event listeners for edit and delete buttons
            transactionListContainer.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.transactionId;
                    const transactionToEdit = transactions.find(t => t.id === id);
                    if (transactionToEdit) showEditTransactionModal(transactionToEdit);
                };
            });
            transactionListContainer.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.transactionId;
                    const transactionToDeleteFound = transactions.find(t => t.id === id);
                    if (transactionToDeleteFound) confirmDeleteTransaction(transactionToDeleteFound);
                };
            });
        }

        // Helper to get member name by ID
        function getMemberName(memberId) {
            const member = members.find(m => m.id === memberId);
            return member ? member.name : 'N/A';
        }

        // Helper to get involved members' names for expenses
        function getInvolvedMembersNames(involvedMemberIds) {
            if (!involvedMemberIds || involvedMemberIds.length === 0) {
                return 'T·∫•t c·∫£';
            }
            return involvedMemberIds.map(id => getMemberName(id)).join(', ');
        }

        // --- Member Actions ---

        // Handles adding a new member
        addMemberForm.onsubmit = async (e) => {
            e.preventDefault();
            const name = memberNameInput.value.trim();
            if (!name) {
                showErrorMessage('T√™n th√†nh vi√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
                return;
            }
            hideErrorMessage();
            try {
                const { data, error } = await supabase
                    .from('members')
                    .insert({ name: name, balance: 0 });
                if (error) throw error;
                memberNameInput.value = ''; // Clear input
                addMemberSection.classList.add('hidden'); // Hide form
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error adding member:", error.message);
                showErrorMessage(`L·ªói khi th√™m th√†nh vi√™n: ${error.message}`);
            }
        };

        // Handles settling up a member's balance
        async function settleUpMember(memberId) {
            const memberToSettle = members.find(m => m.id === memberId);
            if (!memberToSettle || memberToSettle.balance === 0) return;

            const settlementAmount = Math.abs(memberToSettle.balance);
            const settlementType = memberToSettle.balance < 0 ? 'contribution' : 'expense';
            const description = `Thanh to√°n s·ªë d∆∞ cho ${memberToSettle.name}`;

            try {
                const newTransaction = {
                    type: settlementType,
                    amount: settlementAmount,
                    description: description,
                    date: new Date().toLocaleString(),
                    contributingMemberId: settlementType === 'contribution' ? memberToSettle.id : null,
                    involvedMemberIds: settlementType === 'expense' ? [memberToSettle.id] : [],
                };
                const { data, error } = await supabase
                    .from('transactions')
                    .insert(newTransaction);
                if (error) throw error;
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error settling up member:", error.message);
                showErrorMessage(`L·ªói khi thanh to√°n s·ªë d∆∞: ${error.message}`);
            }
        }

        // --- Transaction Actions ---

        // Handles adding a new transaction
        addTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            const type = transactionTypeSelect.value;
            const amount = parseFormattedNumber(amountInput.value);
            const description = descriptionInput.value.trim();
            const contributingMemberId = memberSelect.value;
            const selectedExpenseMembers = Array.from(involvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);

            if (isNaN(amount) || amount <= 0 || !description) {
                showErrorMessage('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá v√† m√¥ t·∫£.');
                return;
            }
            if (type === 'contribution' && !contributingMemberId) {
                showErrorMessage('Vui l√≤ng ch·ªçn th√†nh vi√™n ƒë√≥ng g√≥p.');
                return;
            }
            if (type === 'expense' && selectedExpenseMembers.length === 0) {
                showErrorMessage('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th√†nh vi√™n tham gia chi ti√™u.');
                return;
            }
            hideErrorMessage();

            try {
                const newTransaction = {
                    type: type,
                    amount: amount,
                    description: description,
                    date: new Date().toLocaleString(),
                    contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                    involvedMemberIds: type === 'expense' ? selectedExpenseMembers : [],
                };
                const { data, error } = await supabase
                    .from('transactions')
                    .insert(newTransaction);
                if (error) throw error;
                amountInput.value = '';
                descriptionInput.value = '';
                // Reset member selection for expense if it was an expense
                involvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                addTransactionSection.classList.add('hidden'); // Hide form
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error adding transaction:", error.message);
                showErrorMessage(`L·ªói khi th√™m giao d·ªãch: ${error.message}`);
            }
        };

        // Populates the member dropdowns and checkboxes for transaction forms
        function populateMemberSelectors() {
            // For Add Transaction Form
            memberSelect.innerHTML = '';
            involvedMembersCheckboxes.innerHTML = '';

            if (members.length === 0) {
                memberSelect.innerHTML = '<option value="">Ch∆∞a c√≥ th√†nh vi√™n n√†o</option>';
                involvedMembersCheckboxes.innerHTML = '<p class="text-gray-500 text-sm">Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë·ªÉ ch·ªçn.</p>';
                return;
            }

            members.forEach(member => {
                // For dropdown (contributing member)
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                memberSelect.appendChild(option);

                // For checkboxes (involved members)
                const label = document.createElement('label');
                label.className = 'inline-flex items-center cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]" value="${member.id}">
                    <span class="ml-2 text-sm text-gray-700">${member.name}</span>
                `;
                involvedMembersCheckboxes.appendChild(label);
            });

            // Set default selected member for contribution if available
            if (members.length > 0) {
                memberSelect.value = members[0].id;
            }
        }

        // Toggles visibility and required attributes of contributing/involved member fields based on transaction type
        transactionTypeSelect.onchange = () => {
            if (transactionTypeSelect.value === 'contribution') {
                contributingMemberDiv.classList.remove('hidden');
                memberSelect.setAttribute('required', 'true'); // Make contributing member required
                involvedMembersDiv.classList.add('hidden');
                involvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false; // Clear selected expense members
                    checkbox.removeAttribute('required'); // Remove required from expense members
                });
            } else {
                contributingMemberDiv.classList.add('hidden');
                memberSelect.removeAttribute('required'); // Remove required from contributing member
                memberSelect.value = ''; // Clear contributing member
                involvedMembersDiv.classList.remove('hidden');
                // For expense, at least one checkbox should be implicitly required by validation logic
                // No need to set 'required' on individual checkboxes, as the form submission logic handles it.
            }
        };

        // Shows the edit transaction modal
        function showEditTransactionModal(transaction) {
            editingTransaction = transaction; // Store the transaction globally
            editTransactionModal.classList.remove('hidden');
            hideErrorMessage();

            // Populate form fields
            editTransactionTypeSelect.value = transaction.type;
            editAmountInput.value = formatNumberForInput(transaction.amount.toString());
            editDescriptionInput.value = transaction.description;

            // Populate member selectors for edit modal
            editMemberSelect.innerHTML = '';
            editInvolvedMembersCheckboxes.innerHTML = '';

            if (members.length === 0) {
                editMemberSelect.innerHTML = '<option value="">Ch∆∞a c√≥ th√†nh vi√™n n√†o</option>';
                editInvolvedMembersCheckboxes.innerHTML = '<p class="text-gray-500 text-sm">Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë·ªÉ ch·ªçn.</p>';
            } else {
                members.forEach(member => {
                    // For dropdown (contributing member)
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    editMemberSelect.appendChild(option);

                    // For checkboxes (involved members)
                    const label = document.createElement('label');
                    label.className = 'inline-flex items-center cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]" value="${member.id}">
                        <span class="ml-2 text-sm text-gray-700">${member.name}</span>
                    `;
                    editInvolvedMembersCheckboxes.appendChild(label);
                });
            }

            // Set initial selection based on transaction type and manage required attributes
            if (transaction.type === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.removeAttribute('required');
                });
                editMemberSelect.value = transaction.contributingMemberId || '';
            } else {
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                transaction.involvedMemberIds.forEach(id => {
                    const checkbox = editInvolvedMembersCheckboxes.querySelector(`input[value="${id}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Toggles visibility and required attributes of contributing/involved member fields in edit modal
        editTransactionTypeSelect.onchange = () => {
            if (editTransactionTypeSelect.value === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.removeAttribute('required');
                });
            } else {
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                // For expense, at least one checkbox should be implicitly required by validation logic
            }
        };

        // Handles saving edited transaction
        editTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!editingTransaction) return;

            const type = editTransactionTypeSelect.value;
            const amount = parseFormattedNumber(editAmountInput.value);
            const description = editDescriptionInput.value.trim();
            const contributingMemberId = editMemberSelect.value;
            const involvedMemberIds = Array.from(editInvolvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);

            if (isNaN(amount) || amount <= 0 || !description) {
                showErrorMessage('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá v√† m√¥ t·∫£ cho giao d·ªãch.');
                return;
            }
            if (type === 'contribution' && !contributingMemberId) {
                showErrorMessage('Vui l√≤ng ch·ªçn th√†nh vi√™n ƒë√≥ng g√≥p cho giao d·ªãch n√†y.');
                return;
            }
            if (type === 'expense' && involvedMemberIds.length === 0) {
                showErrorMessage('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th√†nh vi√™n tham gia chi ti√™u cho giao d·ªãch n√†y.');
                return;
            }
            hideErrorMessage();

            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .update({
                        type: type,
                        amount: amount,
                        description: description,
                        contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                        involvedMemberIds: type === 'expense' ? involvedMemberIds : [],
                    })
                    .eq('id', editingTransaction.id);
                if (error) throw error;
                editTransactionModal.classList.add('hidden');
                editingTransaction = null;
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error editing transaction:", error.message);
                showErrorMessage(`L·ªói khi s·ª≠a giao d·ªãch: ${error.message}`);
            }
        };

        // Shows confirmation modal for deleting a transaction
        function confirmDeleteTransaction(transaction) {
            transactionToDelete = transaction;
            confirmationMessage.textContent = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch "${transaction.description}" n√†y kh√¥ng?`;
            confirmationModal.classList.remove('hidden');
        }

        // Handles deletion of transaction after confirmation
        confirmActionBtn.onclick = async () => {
            if (transactionToDelete) {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', transactionToDelete.id);
                    if (error) throw error;
                    fetchData(); // Re-fetch data to update UI
                } catch (error) {
                    console.error("Error deleting transaction:", error.message);
                    showErrorMessage(`L·ªói khi x√≥a giao d·ªãch: ${error.message}`);
                }
            }
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
        };

        // Cancels deletion
        cancelConfirmationBtn.onclick = () => {
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
        };

        // --- Member Details Modal ---
        function showMemberDetailsModal(member) {
            selectedMemberForDetails = member;
            memberDetailsModal.classList.remove('hidden');
            hideErrorMessage();

            memberDetailsName.textContent = `Chi Ti·∫øt Th√†nh Vi√™n: ${member.name}`;
            memberDetailsBalance.textContent = `${formatNumberForDisplay(member.balance)} VNƒê`;
            memberDetailsBalance.classList.remove('text-green-600', 'text-red-600');
            if (member.balance >= 0) {
                memberDetailsBalance.classList.add('text-green-600');
            } else {
                memberDetailsBalance.classList.add('text-red-600');
            }

            const memberTransactions = transactions.filter(t =>
                (t.type === 'contribution' && t.contributingMemberId === member.id) ||
                (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(member.id))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (memberTransactions.length === 0) {
                memberDetailsTransactionsContainer.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ giao d·ªãch n√†o li√™n quan ƒë·∫øn th√†nh vi√™n n√†y.</p>';
            } else {
                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th>Ng√†y</th>
                                <th>Lo·∫°i</th>
                                <th>M√¥ T·∫£</th>
                                <th class="table-header text-right-aligned">S·ªë Ti·ªÅn (VNƒê)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                memberTransactions.forEach(t => {
                    let displayedAmount = t.amount;
                    // For individual member details, show the per-person share of the expense
                    if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                        displayedAmount = t.amount / t.involvedMemberIds.length;
                    }
                    const typeText = t.type === 'contribution' ? 'üíµ ƒê√≥ng G√≥p' : 'üç∫ Chi Ti√™u';
                    const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                    tableHtml += `
                        <tr class="table-row">
                            <td>${t.date}</td>
                            <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                            <td>${t.description}</td>
                            <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                        </tr>
                    `;
                });
                tableHtml += `
                        </tbody>
                    </table>
                `;
                memberDetailsTransactionsContainer.innerHTML = tableHtml;
            }
        }

        // --- Reporting Functions ---

        // Renders the Fund Report table
        function renderFundReport() {
            if (transactions.length === 0) {
                fundReportTableContainer.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ giao d·ªãch n√†o ƒë·ªÉ b√°o c√°o.</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="table-header">Ng√†y</th>
                            <th class="table-header">Lo·∫°i</th>
                            <th class="table-header">M√¥ T·∫£</th>
                            <th class="table-header">Th√†nh Vi√™n Li√™n Quan</th>
                            <th class="table-header text-right-aligned">S·ªë Ti·ªÅn (VNƒê)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            transactions.slice().reverse().forEach(t => {
                // For the fund report, always display the total amount of the expense
                const displayedAmount = t.amount;
                const typeText = t.type === 'contribution' ? 'üíµ ƒê√≥ng G√≥p' : 'üç∫ Chi Ti√™u';
                const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                const memberNames = t.type === 'contribution'
                    ? getMemberName(t.contributingMemberId)
                    : getInvolvedMembersNames(t.involvedMemberIds);

                tableHtml += `
                    <tr class="table-row">
                        <td>${t.date}</td>
                        <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                        <td>${t.description}</td>
                        <td>${memberNames}</td>
                        <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            fundReportTableContainer.innerHTML = tableHtml;
        }

        // Renders the Member Report dropdown
        function renderMemberReportDropdown() {
            selectMemberReportDropdown.innerHTML = '';
            if (members.length === 0) {
                selectMemberReportDropdown.innerHTML = '<option value="">Ch∆∞a c√≥ th√†nh vi√™n n√†o</option>';
            } else {
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    selectMemberReportDropdown.appendChild(option);
                });
                // Set default selected member if not already set
                if (!selectMemberReportDropdown.value && members.length > 0) {
                    selectMemberReportDropdown.value = members[0].id;
                }
            }
            renderSelectedMemberReport(); // Render report for initially selected member
        }

        // Renders the report for the currently selected member
        function renderSelectedMemberReport() {
            const selectedMemberId = selectMemberReportDropdown.value;
            if (!selectedMemberId) {
                memberReportTableContainer.innerHTML = '<p class="text-center text-gray-500">Vui l√≤ng ch·ªçn m·ªôt th√†nh vi√™n ƒë·ªÉ xem b√°o c√°o.</p>';
                return;
            }

            const memberTransactions = transactions.filter(t =>
                (t.type === 'contribution' && t.contributingMemberId === selectedMemberId) ||
                (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(selectedMemberId))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (memberTransactions.length === 0) {
                memberReportTableContainer.innerHTML = '<p class="text-center text-gray-500">Th√†nh vi√™n n√†y ch∆∞a c√≥ giao d·ªãch n√†o.</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="table-header">Ng√†y</th>
                            <th class="table-header">Lo·∫°i</th>
                            <th class="table-header">M√¥ T·∫£</th>
                            <th class="table-header text-right-aligned">S·ªë Ti·ªÅn (VNƒê)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            memberTransactions.forEach(t => {
                let displayedAmount = t.amount;
                // For individual member reports, show the per-person share of the expense
                if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                    displayedAmount = t.amount / t.involvedMemberIds.length;
                }
                const typeText = t.type === 'contribution' ? 'üíµ ƒê√≥ng G√≥p' : 'üç∫ Chi Ti√™u';
                const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                tableHtml += `
                    <tr class="table-row">
                        <td>${t.date}</td>
                        <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                        <td>${t.description}</td>
                        <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            memberReportTableContainer.innerHTML = tableHtml;
        }

        // Export Fund Report to Excel
        exportFundReportExcelBtn.onclick = () => {
            if (typeof window.XLSX === 'undefined') {
                showErrorMessage('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.');
                return;
            }

            const reportData = transactions.slice().reverse().map(t => {
                // For Excel export of fund report, use the total amount
                const displayedAmount = t.amount;
                return {
                    'Ng√†y': t.date,
                    'Lo·∫°i': t.type === 'contribution' ? 'ƒê√≥ng G√≥p' : 'Chi Ti√™u',
                    'M√¥ T·∫£': t.description,
                    'Th√†nh Vi√™n Li√™n Quan': t.type === 'contribution' ? getMemberName(t.contributingMemberId) : getInvolvedMembersNames(t.involvedMemberIds),
                    'S·ªë Ti·ªÅn (VNƒê)': (t.type === 'contribution' ? '+' : '-') + formatNumberForDisplay(displayedAmount),
                };
            });

            const ws = window.XLSX.utils.json_to_sheet(reportData);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, 'B√°o C√°o Qu·ªπ Chung');
            window.XLSX.writeFile(wb, 'BaoCaoQuyChung.xlsx');
        };

        // Export Member Report to Excel
        exportMemberReportExcelBtn.onclick = () => {
            if (typeof window.XLSX === 'undefined') {
                showErrorMessage('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.');
                return;
            }
            const selectedMemberId = selectMemberReportDropdown.value;
            if (!selectedMemberId) {
                showErrorMessage('Vui l√≤ng ch·ªçn m·ªôt th√†nh vi√™n ƒë·ªÉ xu·∫•t b√°o c√°o.');
                return;
            }
            const memberName = getMemberName(selectedMemberId);
            const memberTransactions = transactions.filter(t =>
                (t.type === 'contribution' && t.contributingMemberId === selectedMemberId) ||
                (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(selectedMemberId))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            const reportData = memberTransactions.map(t => {
                let displayedAmount = t.amount;
                // For Excel export of member report, use the per-person share
                if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                    displayedAmount = t.amount / t.involvedMemberIds.length;
                }
                return {
                    'Ng√†y': t.date,
                    'Lo·∫°i': t.type === 'contribution' ? 'ƒê√≥ng G√≥p' : 'Chi Ti√™u',
                    'M√¥ T·∫£': t.description,
                    'S·ªë Ti·ªÅn (VNƒê)': (t.type === 'contribution' ? '+' : '-') + formatNumberForDisplay(displayedAmount),
                };
            });

            const ws = window.XLSX.utils.json_to_sheet(reportData);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, `B√°o C√°o ${memberName}`);
            window.XLSX.writeFile(wb, `BaoCao_${memberName}.xlsx`);
        };

        // --- Pie Chart Functions ---

        // Helper for SVG arc drawing
        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function describePieSlice(centerX, centerY, radius, startAngle, endAngle) {
            const start = polarToCartesian(centerX, centerY, radius, endAngle);
            const end = polarToCartesian(centerX, centerY, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

            const pathData = [
                `M ${centerX} ${centerY}`,
                `L ${start.x} ${start.y}`,
                `A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y}`,
                `L ${centerX} ${centerY}`,
                `Z`
            ].join(" ");

            return pathData;
        }

        // Renders the Member Balance Pie Chart
        function renderMemberBalancePieChart() {
            const CHART_SIZE = 200;
            const RADIUS = CHART_SIZE / 2 - 10;
            const centerX = CHART_SIZE / 2;
            const centerY = CHART_SIZE / 2;

            const colorPalette = [
                '#4CAF50', // Green
                '#2196F3', // Blue
                '#FFC107', // Amber
                '#F44336', // Red
                '#9C27B0', // Purple
                '#FF9800', // Orange
                '#00BCD4', // Cyan
                '#E91E63', // Pink
                '#795548', // Brown
                '#607D8B', // Blue Grey
            ];

            const chartData = members.filter(m => m.balance !== 0);
            const totalAbsoluteBalance = chartData.reduce((sum, m) => sum + Math.abs(m.balance), 0);

            if (chartData.length === 0) {
                memberBalancePieChartDiv.innerHTML = '<p class="text-center text-gray-500 mt-4">Ch∆∞a c√≥ s·ªë d∆∞ n√†o ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.</p>';
                return;
            }

            let currentAngle = 0;
            let slicesSvg = '';
            let legendHtml = '';

            chartData.forEach((member, index) => {
                const sliceAngle = (Math.abs(member.balance) / totalAbsoluteBalance) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + sliceAngle;

                const pathData = describePieSlice(centerX, centerY, RADIUS, startAngle, endAngle);
                const color = colorPalette[index % colorPalette.length];

                const midAngle = startAngle + sliceAngle / 2;
                const labelRadius = RADIUS * 0.7;
                const labelPos = polarToCartesian(centerX, centerY, labelRadius, midAngle);

                slicesSvg += `
                    <g>
                        <path
                            d="${pathData}"
                            fill="${color}"
                            stroke="white"
                            stroke-width="1"
                        />
                        ${sliceAngle > 10 ? `
                            <text
                                x="${labelPos.x}"
                                y="${labelPos.y}"
                                fill="white"
                                font-size="10"
                                text-anchor="middle"
                                alignment-baseline="middle"
                                font-weight="bold"
                            >
                                ${member.name}
                            </text>
                        ` : ''}
                    </g>
                `;
                currentAngle = endAngle;

                legendHtml += `
                    <div class="flex items-center mb-1">
                        <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span>
                        <span class="text-sm text-gray-800">${member.name}</span>
                    </div>
                `;
            });

            memberBalancePieChartDiv.innerHTML = `
                <svg viewBox="0 0 ${CHART_SIZE} ${CHART_SIZE}" width="100%" height="auto" style="max-width: 300px;">
                    ${slicesSvg}
                    <text x="${centerX}" y="${centerY}" text-anchor="middle" alignment-baseline="middle" font-size="12" font-weight="bold" fill="#333">
                        T·ªïng: ${formatNumberForDisplay(totalAbsoluteBalance)} VNƒê
                    </text>
                </svg>
                <div class="ml-8 p-4 bg-gray-50 rounded-lg shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-2">Ch√∫ Th√≠ch:</h4>
                    ${legendHtml}
                </div>
            `;
        }

        // --- Gemini API Integration ---

        // Simple Markdown to HTML converter
        function markdownToHtml(markdown) {
            let html = markdown;

            // Convert headings (e.g., ## Heading) to <h2>
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // Convert bold (e.g., **text**) to <strong>
            html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
            // Convert italics (e.g., *text*) to <em>
            html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');

            // Convert unordered lists (e.g., - item) to <ul> and <li>
            html = html.replace(/^\s*\-\s(.*)$/gim, '<li>$1</li>');
            html = html.replace(/^(<li>.*<\/li>(\n<li>.*<\/li>)*)/gim, '<ul>$1</ul>');

            // Convert ordered lists (e.g., 1. item) to <ol> and <li>
            html = html.replace(/^\s*\d+\.\s(.*)$/gim, '<li>$1</li>');
            html = html.replace(/^(<li>.*<\/li>(\n<li>.*<\/li>)*)/gim, '<ol>$1</ol>');


            // Convert newlines to paragraphs, but only if not already part of a block element
            html = html.split('\n').map(line => {
                if (line.trim() === '' || line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<ol') || line.startsWith('<li>')) {
                    return line;
                }
                return `<p class="mb-2 text-gray-700">${line}</p>`;
            }).join('');

            // Clean up empty paragraphs that might be created by the above logic
            html = html.replace(/<p class="mb-2 text-gray-700"><\/p>/g, '');

            return html;
        }


        async function generateFundInsights() {
            isGeneratingInsights = true;
            fundInsightsContent.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#006B68]"></div>
                    <p class="mt-4 text-gray-600">ƒêang t·∫°o th√¥ng tin chi ti·∫øt t·ª´ AI...</p>
                </div>
            `;
            hideErrorMessage(); // Clear previous errors for insights

            // Construct prompt for LLM
            let prompt = `Given the following fund transactions and current fund balance for a group's meal fund, provide a concise summary of the fund's financial health and suggest 3-5 actionable tips for better fund management. The response should be in Vietnamese and formatted using Markdown (e.g., use ## for headings, - for list items, ** for bold).

Current Fund Balance: ${formatNumberForDisplay(fundBalance)} VNƒê

Recent Transactions:\n`;

            if (transactions.length === 0) {
                prompt += "No transactions recorded yet.\n";
            } else {
                transactions.slice(-10).reverse().forEach(t => { // Last 10 transactions
                    const memberNames = t.type === 'contribution'
                        ? getMemberName(t.contributingMemberId)
                        : (t.involvedMemberIds && t.involvedMemberIds.length > 0
                            ? t.involvedMemberIds.map(id => getMemberName(id)).join(', ')
                            : 'T·∫•t c·∫£ th√†nh vi√™n');
                    prompt += `- ${t.date} | Lo·∫°i: ${t.type === 'contribution' ? 'ƒê√≥ng G√≥p' : 'Chi Ti√™u'} | S·ªë ti·ªÅn: ${formatNumberForDisplay(t.amount)} VNƒê | M√¥ t·∫£: ${t.description} | Th√†nh vi√™n: ${memberNames}\n`;
                });
            }

            console.log("Sending prompt to Gemini API:", prompt);

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Leave as empty string for Canvas to provide
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log("Gemini API response:", result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const markdownText = result.candidates[0].content.parts[0].text;
                    // Convert Markdown to HTML before setting innerHTML
                    fundInsightsContent.innerHTML = markdownToHtml(markdownText);
                } else {
                    fundInsightsContent.innerHTML = '<p class="text-center text-gray-500">Kh√¥ng th·ªÉ t·∫°o th√¥ng tin chi ti·∫øt. Vui l√≤ng th·ª≠ l·∫°i.</p>';
                    console.error("Unexpected Gemini API response structure:", result);
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showErrorMessage(`L·ªói khi t·∫°o th√¥ng tin chi ti·∫øt: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
                fundInsightsContent.innerHTML = '<p class="text-center text-gray-500">ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i.</p>';
            } finally {
                isGeneratingInsights = false;
            }
        }


        // --- Event Listeners ---

        // Main Navigation Buttons
        document.getElementById('add-member-btn').onclick = () => {
            hideAllSections();
            addMemberSection.classList.remove('hidden');
            memberNameInput.value = ''; // Clear input
        };

        document.getElementById('add-transaction-btn').onclick = () => {
            hideAllSections();
            addTransactionSection.classList.remove('hidden');
            amountInput.value = ''; // Clear input
            descriptionInput.value = ''; // Clear input
            transactionTypeSelect.value = 'contribution'; // Reset to default
            populateMemberSelectors(); // Repopulate and reset selections
            transactionTypeSelect.dispatchEvent(new Event('change')); // Trigger change to show/hide correct fields
        };

        document.getElementById('view-transactions-btn').onclick = () => {
            hideAllSections();
            transactionsSection.classList.remove('hidden');
            renderTransactionList(); // Render transactions when section is shown
        };

        document.getElementById('show-report-selection-btn').onclick = () => {
            hideAllSections();
            reportSelectionModal.classList.remove('hidden');
        };

        document.getElementById('get-insights-btn').onclick = () => {
            hideAllSections();
            fundInsightsModal.classList.remove('hidden');
            generateFundInsights();
        };

        // Report Selection Modal Buttons
        selectFundReportBtn.onclick = () => {
            hideAllSections();
            fundReportSection.classList.remove('hidden');
            reportSelectionModal.classList.add('hidden');
            renderFundReport();
        };

        selectMemberReportBtn.onclick = () => {
            hideAllSections();
            memberReportsSection.classList.remove('hidden');
            reportSelectionModal.classList.add('hidden');
            renderMemberReportDropdown(); // Re-render dropdown and initial member report
        };

        closeReportSelectionBtn.onclick = () => {
            reportSelectionModal.classList.add('hidden');
        };

        // Edit Transaction Modal Buttons
        cancelEditTransactionBtn.onclick = () => {
            editTransactionModal.classList.add('hidden');
            editingTransaction = null;
            hideErrorMessage();
        };

        // Member Details Modal Button
        closeMemberDetailsBtn.onclick = () => {
            memberDetailsModal.classList.add('hidden');
            selectedMemberForDetails = null;
        };

        // Close Insights Modal Button
        closeInsightsBtn.onclick = () => {
            fundInsightsModal.classList.add('hidden');
            fundInsightsContent.innerHTML = ''; // Clear content when closing
        };

        // Member Report Dropdown Change
        selectMemberReportDropdown.onchange = renderSelectedMemberReport;

        // Amount input formatting for add and edit forms
        amountInput.addEventListener('input', (e) => {
            e.target.value = formatNumberForInput(e.target.value);
        });
        editAmountInput.addEventListener('input', (e) => {
            e.target.value = formatNumberForInput(e.target.value);
        });


        // Initial data fetch and UI render when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeSupabase();
        });
    </script>
</body>
</html>
