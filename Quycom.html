import React, { useState, useEffect, useCallback } from 'react';

// Initialize Supabase client variables (will be set after CDN loads)
const supabaseUrl = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your actual Supabase URL
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Replace with your actual Supabase Anon Key

// Helper function to format a number with thousands separators for display
const formatNumberForDisplay = (num) => {
    if (typeof num !== 'number' || isNaN(num)) {
        return '';
    }
    return num.toLocaleString('vi-VN');
};

// Helper function to format a number string with thousands separators for input
const formatNumberForInput = (value) => {
    const cleanedValue = value.replace(/\D/g, '');
    if (!cleanedValue) {
        return '';
    }
    return parseFloat(cleanedValue).toLocaleString('vi-VN');
};

// Helper function to parse a formatted number string back to a raw number
const parseFormattedNumber = (formattedValue) => {
    const cleanedValue = formattedValue.replace(/\D/g, '');
    return parseFloat(cleanedValue) || 0;
};


// Main App Component
const App = () => {
    // State for members and transactions
    const [members, setMembers] = useState([]);
    const [transactions, setTransactions] = useState([]);
    const [fundBalance, setFundBalance] = useState(0);
    const [showAddMember, setShowAddMember] = useState(false);
    const [showAddTransaction, setShowAddTransaction] = useState(false);
    const [showTransactions, setShowTransactions] = useState(false);
    const [editingTransaction, setEditingTransaction] = useState(null);
    const [errorMessage, setErrorMessage] = useState('');
    const [selectedMemberForDetails, setSelectedMemberForDetails] = useState(null);
    const [showConfirmDelete, setShowConfirmDelete] = useState(false);
    const [transactionToDelete, setTransactionToDelete] = useState(null);
    const [showFundReport, setShowFundReport] = useState(false);
    const [showMemberReports, setShowMemberReports] = useState(false);
    const [showReportSelectionModal, setShowReportSelectionModal] = useState(false);
    const [isLoading, setIsLoading] = useState(true);
    const [supabaseClient, setSupabaseClient] = useState(null); // State to hold the Supabase client instance

    // New states for Gemini API integration
    const [showFundInsightsModal, setShowFundInsightsModal] = useState(false);
    const [fundInsights, setFundInsights] = useState('');
    const [isGeneratingInsights, setIsGeneratingInsights] = useState(false);

    // Effect to load Supabase CDN and initialize client
    useEffect(() => {
        const loadSupabaseClient = () => {
            // Check if window.supabase is available (meaning CDN script has loaded)
            if (window.supabase && !supabaseClient) {
                // Ensure the placeholder values are not used if actual values are intended
                if (supabaseUrl === 'YOUR_SUPABASE_URL' || supabaseAnonKey === 'YOUR_SUPABASE_ANON_KEY') {
                    console.warn("Supabase URL or Anon Key are still placeholders. Please replace them with your actual Supabase project credentials.");
                    setErrorMessage("C·∫£nh b√°o: URL ho·∫∑c Kh√≥a Supabase v·∫´n l√† gi√° tr·ªã m·∫∑c ƒë·ªãnh. Vui l√≤ng thay th·∫ø b·∫±ng th√¥ng tin d·ª± √°n th·ª±c c·ªßa b·∫°n.");
                    setIsLoading(false);
                    return;
                }
                const client = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                setSupabaseClient(client);
                console.log("Supabase client initialized.");
            }
        };

        // If the script is already loaded (e.g., on re-render after initial load)
        if (window.supabase) {
            loadSupabaseClient();
        } else {
            // If the script is not loaded, wait for the DOM to be ready
            // and then check for the script. If not found, create it.
            // This is a fallback for environments where the script might not be injected
            // directly into the head by React's initial render.
            const scriptExists = document.querySelector('script[src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"]');
            if (!scriptExists) {
                const script = document.createElement('script');
                script.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
                script.async = true; // Load asynchronously
                script.onload = loadSupabaseClient; // Call load function once script is loaded
                script.onerror = () => {
                    console.error("Failed to load Supabase CDN script.");
                    setErrorMessage("L·ªói: Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán Supabase. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.");
                    setIsLoading(false);
                };
                document.head.appendChild(script);
            } else {
                // If script exists but client isn't initialized, try to initialize
                loadSupabaseClient();
            }
        }
    }, [supabaseClient]); // Dependency array ensures this runs when supabaseClient is null or changes

    // Function to fetch data from Supabase
    const fetchData = useCallback(async () => {
        if (!supabaseClient) {
            console.log("Supabase client not ready for fetching data.");
            setIsLoading(true); // Keep loading state true until client is ready
            return;
        }

        setIsLoading(true);
        try {
            // Fetch members
            const { data: membersData, error: membersError } = await supabaseClient
                .from('members')
                .select('*');

            if (membersError) {
                if (membersError.message.includes('relation "public.members" does not exist')) {
                    setErrorMessage("L·ªói: C√°c b·∫£ng d·ªØ li·ªáu (members, transactions) ch∆∞a ƒë∆∞·ª£c t·∫°o trong Supabase. Vui l√≤ng ch·∫°y c√°c script SQL ƒë√£ cung c·∫•p tr∆∞·ªõc ƒë√≥.");
                } else {
                    setErrorMessage(`L·ªói khi t·∫£i d·ªØ li·ªáu th√†nh vi√™n: ${membersError.message}`);
                }
                throw membersError; // Still throw to stop further execution in this block
            }

            // Fetch transactions
            const { data: transactionsData, error: transactionsError } = await supabaseClient
                .from('transactions')
                .select('*');

            if (transactionsError) {
                if (transactionsError.message.includes('relation "public.transactions" does not exist')) {
                    setErrorMessage("L·ªói: C√°c b·∫£ng d·ªØ li·ªáu (members, transactions) ch∆∞a ƒë∆∞·ª£c t·∫°o trong Supabase. Vui l√≤ng ch·∫°y c√°c script SQL ƒë√£ cung c·∫•p tr∆∞·ªõc ƒë√≥.");
                } else {
                    setErrorMessage(`L·ªói khi t·∫£i d·ªØ li·ªáu giao d·ªãch: ${transactionsError.message}`);
                }
                throw transactionsError;
            }

            // If no members exist, populate with default data
            if (!membersData || membersData.length === 0) {
                console.log("No members found, populating with default data...");
                const initialMembers = [
                    { name: 'Tr∆∞∆°ng H·ªìng Qu√¢n' },
                    { name: 'B√πi Ho√†ng Giang' },
                    { name: 'Nguy·ªÖn Th·ªã Hoa H·∫≠u' },
                ];
                const { data: newMembers, error: newMembersError } = await supabaseClient
                    .from('members')
                    .insert(initialMembers)
                    .select(); // Use select() to get the inserted data with generated IDs

                if (newMembersError) throw newMembersError;

                setMembers(newMembers);

                // Create initial transactions using the IDs of newly inserted members
                const initialTransactions = [
                    { type: 'contribution', amount: 500000, description: 'ƒê√≥ng g√≥p ban ƒë·∫ßu', date: new Date().toLocaleString(), contributingMemberId: newMembers[0].id },
                    { type: 'contribution', amount: 300000, description: 'ƒê√≥ng g√≥p th√™m', date: new Date().toLocaleString(), contributingMemberId: newMembers[1].id },
                    { type: 'expense', amount: 150000, description: 'Mua ƒë·ªì ƒÉn nh·∫π', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id] },
                    { type: 'contribution', amount: 200000, description: 'ƒê√≥ng g√≥p th√°ng 5', date: new Date().toLocaleString(), contributingMemberId: newMembers[2].id },
                    { type: 'expense', amount: 250000, description: 'Ti·ªÅn n∆∞·ªõc u·ªëng', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[2].id] },
                    { type: 'expense', amount: 300000, description: 'ƒê·∫∑t c∆°m tr∆∞a', date: new Date().toLocaleString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id] },
                ];
                const { data: newTransactions, error: newTransactionsError } = await supabaseClient
                    .from('transactions')
                    .insert(initialTransactions)
                    .select();

                if (newTransactionsError) throw newTransactionsError;
                setTransactions(newTransactions);

            } else {
                setMembers(membersData);
                setTransactions(transactionsData);
            }
        } catch (error) {
            // Error message already set by specific checks above, or fallback here
            if (!errorMessage) { // Only set if not already set by specific error
                setErrorMessage(`L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}`);
            }
        } finally {
            setIsLoading(false);
        }
    }, [supabaseClient, members.length, errorMessage]); // Add errorMessage to dependencies to prevent stale closure for error message check

    // Effect for real-time subscriptions (runs after client is initialized)
    useEffect(() => {
        if (!supabaseClient) return; // Only subscribe if client is ready

        fetchData(); // Initial fetch after client is ready

        // Real-time subscription for members
        const memberSubscription = supabaseClient
            .channel('public:members')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, payload => {
                console.log('Member change received!', payload);
                fetchData(); // Re-fetch data on any change to members
            })
            .subscribe();

        // Real-time subscription for transactions
        const transactionSubscription = supabaseClient
            .channel('public:transactions')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, payload => {
                console.log('Transaction change received!', payload);
                fetchData(); // Re-fetch data on any change to transactions
            })
            .subscribe();

        // Cleanup subscriptions on component unmount
        return () => {
            if (supabaseClient) {
                supabaseClient.removeChannel(memberSubscription);
                supabaseClient.removeChannel(transactionSubscription);
            }
        };
    }, [supabaseClient, fetchData]); // Depend on supabaseClient and fetchData

    // Calculate fund balance and member balances whenever data changes
    useEffect(() => {
        let totalBalance = 0;
        const tempMemberBalances = new Map(members.map(m => [m.id, 0]));

        transactions.forEach(t => {
            if (t.type === 'contribution') {
                totalBalance += t.amount;
                if (tempMemberBalances.has(t.contributingMemberId)) {
                    tempMemberBalances.set(t.contributingMemberId, tempMemberBalances.get(t.contributingMemberId) + t.amount);
                }
            } else if (t.type === 'expense') {
                totalBalance -= t.amount;
                const involvedMembers = t.involvedMemberIds && t.involvedMemberIds.length > 0
                    ? t.involvedMemberIds
                    : members.map(m => m.id);

                if (involvedMembers.length > 0) {
                    const costPerMember = t.amount / involvedMembers.length;
                    involvedMembers.forEach(memberId => {
                        if (tempMemberBalances.has(memberId)) {
                            tempMemberBalances.set(memberId, tempMemberBalances.get(memberId) - costPerMember);
                        }
                    });
                }
            }
        });

        const updatedMembers = members.map(member => ({
            ...member,
            balance: tempMemberBalances.get(member.id) || 0
        }));

        setFundBalance(totalBalance);
        setMembers(updatedMembers);
    }, [transactions, members.length]);


    // Calculate total contributions and total expenses for reporting
    const totalContributions = transactions.filter(t => t.type === 'contribution').reduce((sum, t) => sum + t.amount, 0);
    const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);


    // --- Member Management ---
    const addMember = async (name) => {
        if (!name.trim()) {
            setErrorMessage('T√™n th√†nh vi√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
            return;
        }
        setErrorMessage('');
        if (!supabaseClient) {
            setErrorMessage('L·ªói: Supabase client ch∆∞a s·∫µn s√†ng.');
            return;
        }
        try {
            const { data, error } = await supabaseClient
                .from('members')
                .insert({ name: name.trim(), balance: 0 });
            if (error) throw error;
            setShowAddMember(false);
        } catch (error) {
            console.error("Error adding member:", error.message);
            setErrorMessage(`L·ªói khi th√™m th√†nh vi√™n: ${error.message}`);
        }
    };

    // --- Transaction Management ---
    const addTransaction = async (type, amount, description, contributingMemberId = null, involvedMemberIds = []) => {
        if (isNaN(amount) || amount <= 0 || !description.trim()) {
            setErrorMessage('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá v√† m√¥ t·∫£.');
            return;
        }

        if (type === 'contribution' && !contributingMemberId) {
            setErrorMessage('Vui l√≤ng ch·ªçn th√†nh vi√™n ƒë√≥ng g√≥p.');
            return;
        }

        if (type === 'expense' && involvedMemberIds.length === 0) {
            setErrorMessage('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th√†nh vi√™n tham gia chi ti√™u.');
            return;
        }
        setErrorMessage('');
        if (!supabaseClient) {
            setErrorMessage('L·ªói: Supabase client ch∆∞a s·∫µn s√†ng.');
            return;
        }
        try {
            const newTransaction = {
                type,
                amount: parseFloat(amount),
                description: description.trim(),
                date: new Date().toLocaleString(),
                contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                involvedMemberIds: type === 'expense' ? involvedMemberIds : [],
            };
            const { data, error } = await supabaseClient
                .from('transactions')
                .insert(newTransaction);
            if (error) throw error;
            setShowAddTransaction(false);
        } catch (error) {
            console.error("Error adding transaction:", error.message);
            setErrorMessage(`L·ªói khi th√™m giao d·ªãch: ${error.message}`);
        }
    };

    const editTransaction = async (updatedTransaction) => {
        if (isNaN(updatedTransaction.amount) || updatedTransaction.amount <= 0 || !updatedTransaction.description.trim()) {
            setErrorMessage('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá v√† m√¥ t·∫£ cho giao d·ªãch.');
            return;
        }
        if (updatedTransaction.type === 'contribution' && !updatedTransaction.contributingMemberId) {
            setErrorMessage('Vui l√≤ng ch·ªçn th√†nh vi√™n ƒë√≥ng g√≥p cho giao d·ªãch n√†y.');
            return;
        }
        if (updatedTransaction.type === 'expense' && updatedTransaction.involvedMemberIds.length === 0) {
            setErrorMessage('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th√†nh vi√™n tham gia chi ti√™u cho giao d·ªãch n√†y.');
            return;
        }
        setErrorMessage('');
        if (!supabaseClient) {
            setErrorMessage('L·ªói: Supabase client ch∆∞a s·∫µn s√†ng.');
            return;
        }
        try {
            const { data, error } = await supabaseClient
                .from('transactions')
                .update({
                    type: updatedTransaction.type,
                    amount: parseFloat(updatedTransaction.amount),
                    description: updatedTransaction.description,
                    contributingMemberId: updatedTransaction.type === 'contribution' ? updatedTransaction.contributingMemberId : null,
                    involvedMemberIds: updatedTransaction.type === 'expense' ? updatedTransaction.involvedMemberIds : [],
                })
                .eq('id', updatedTransaction.id);
            if (error) throw error;
            setEditingTransaction(null);
        } catch (error) {
            console.error("Error editing transaction:", error.message);
            setErrorMessage(`L·ªói khi s·ª≠a giao d·ªãch: ${error.message}`);
        }
    };

    const deleteTransaction = (transaction) => {
        setTransactionToDelete(transaction);
        setShowConfirmDelete(true);
    };

    const confirmDelete = async () => {
        if (transactionToDelete) {
            if (!supabaseClient) {
                setErrorMessage('L·ªói: Supabase client ch∆∞a s·∫µn s√†ng.');
                setShowConfirmDelete(false);
                setTransactionToDelete(null);
                return;
            }
            try {
                const { error } = await supabaseClient
                    .from('transactions')
                    .delete()
                    .eq('id', transactionToDelete.id);
                if (error) throw error;
            } catch (error) {
                console.error("Error deleting transaction:", error.message);
                setErrorMessage(`L·ªói khi x√≥a giao d·ªãch: ${error.message}`);
            }
        }
        setShowConfirmDelete(false);
        setTransactionToDelete(null);
    };

    const cancelDelete = () => {
        setShowConfirmDelete(false);
        setTransactionToDelete(null);
    };

    const settleUpMember = async (memberId) => {
        const memberToSettle = members.find(m => m.id === memberId);
        if (!memberToSettle) return;

        const settlementAmount = Math.abs(memberToSettle.balance);
        const settlementType = memberToSettle.balance < 0 ? 'contribution' : 'expense';

        if (settlementAmount > 0) {
            if (!supabaseClient) {
                setErrorMessage('L·ªói: Supabase client ch∆∞a s·∫µn s√†ng.');
                return;
            }
            try {
                const settlementTransaction = {
                    type: settlementType,
                    amount: settlementAmount,
                    description: `Thanh to√°n s·ªë d∆∞ cho ${memberToSettle.name}`,
                    date: new Date().toLocaleString(),
                    contributingMemberId: settlementType === 'contribution' ? memberToSettle.id : null,
                    involvedMemberIds: settlementType === 'expense' ? [memberToSettle.id] : [],
                };
                const { data, error } = await supabaseClient
                    .from('transactions')
                    .insert(settlementTransaction);
                if (error) throw error;
            } catch (error) {
                console.error("Error settling up member:", error.message);
                setErrorMessage(`L·ªói khi thanh to√°n s·ªë d∆∞: ${error.message}`);
            }
        }
    };

    // Function to hide all other sections
    const hideAllSections = () => {
        setShowAddMember(false);
        setShowAddTransaction(false);
        setShowTransactions(false);
        setSelectedMemberForDetails(null);
        setErrorMessage('');
        setShowFundReport(false);
        setShowMemberReports(false);
        setShowReportSelectionModal(false);
        setShowFundInsightsModal(false); // Hide insights modal too
    };

    // ‚ú® Gemini API Integration: Generate Fund Insights
    const generateFundInsights = async () => {
        setIsGeneratingInsights(true);
        setFundInsights('');
        setErrorMessage(''); // Clear previous errors

        // Construct prompt for LLM
        let prompt = `Given the following fund transactions and current fund balance for a group's meal fund, provide a concise summary of the fund's financial health and suggest 3-5 actionable tips for better fund management. The response should be in Vietnamese.

Current Fund Balance: ${formatNumberForDisplay(fundBalance)} VNƒê

Recent Transactions:\n`;

        if (transactions.length === 0) {
            prompt += "No transactions recorded yet.\n";
        } else {
            transactions.slice(-10).reverse().forEach(t => { // Last 10 transactions
                const memberNames = t.type === 'contribution'
                    ? members.find(m => m.id === t.contributingMemberId)?.name || 'N/A'
                    : (t.involvedMemberIds && t.involvedMemberIds.length > 0
                        ? t.involvedMemberIds.map(id => members.find(m => m.id === id)?.name || 'N/A').join(', ')
                        : 'T·∫•t c·∫£ th√†nh vi√™n');
                prompt += `- ${t.date} | Lo·∫°i: ${t.type === 'contribution' ? 'ƒê√≥ng G√≥p' : 'Chi Ti√™u'} | S·ªë ti·ªÅn: ${formatNumberForDisplay(t.amount)} VNƒê | M√¥ t·∫£: ${t.description} | Th√†nh vi√™n: ${memberNames}\n`;
            });
        }

        console.log("Sending prompt to Gemini API:", prompt);

        try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Leave as empty string for Canvas to provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            console.log("Gemini API response:", result);

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                setFundInsights(text);
            } else {
                setFundInsights("Kh√¥ng th·ªÉ t·∫°o th√¥ng tin chi ti·∫øt. Vui l√≤ng th·ª≠ l·∫°i.");
                console.error("Unexpected Gemini API response structure:", result);
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            setErrorMessage(`L·ªói khi t·∫°o th√¥ng tin chi ti·∫øt: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
            setFundInsights("ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng th·ª≠ l·∫°i.");
        } finally {
            setIsGeneratingInsights(false);
        }
    };


    if (isLoading) {
        return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center">
                <p className="text-xl font-semibold text-gray-700">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans text-gray-800">
            {/* Supabase CDN script - Added here to ensure it's loaded in the DOM */}
            <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
            {/* Other CDNs */}
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
            <style>
                {`
                body { font-family: 'Inter', sans-serif; }
                .card {
                    background-color: #fff;
                    border-radius: 1rem;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    padding: 1.5rem;
                }
                .btn-primary {
                    background-color: #006B68; /* BIDV Brand Blue */
                    color: white;
                    padding: 0.75rem 1.5rem;
                    border-radius: 0.75rem;
                    font-weight: 600;
                    transition: background-color 0.2s;
                }
                .btn-primary:hover { background-color: #005A58; /* Darker BIDV Blue */ }
                .btn-secondary {
                    background-color: #E0E7FF; /* Light background */
                    color: #006B68; /* BIDV Brand Blue for text */
                    padding: 0.75rem 1.5rem;
                    border-radius: 0.75rem;
                    font-weight: 600;
                    transition: background-color 0.2s;
                }
                .btn-secondary:hover { background-color: #CCF0EF; /* Lighter BIDV Blue for hover */ }
                .input-field {
                    border: 1px solid #D1D5DB;
                    border-radius: 0.5rem;
                    padding: 0.75rem 1rem;
                    width: 100%;
                }
                .table-header th {
                    padding: 0.75rem;
                    text-align: left;
                    font-weight: 600;
                    color: #4B5563;
                    border-bottom: 1px solid #E5E7EB;
                }
                .table-row td {
                    padding: 0.75rem;
                    border-bottom: 1px solid #F3F4F6;
                }
                .balance-positive { color: #10B981; font-weight: 600; } /* Green */
                .balance-negative { color: #EF4444; font-weight: 600; } /* Red */
                .balance-zero { color: #6B7280; } /* Gray */
                .error-message {
                    background-color: #FEE2E2;
                    color: #DC2626;
                    padding: 0.75rem;
                    border-radius: 0.5rem;
                    margin-bottom: 1rem;
                    text-align: center;
                }
                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                }
                .modal-content {
                    background-color: white;
                    padding: 2rem;
                    border-radius: 1rem;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    max-width: 90%;
                    max-height: 90%;
                    overflow-y: auto;
                }
                .text-right-aligned {
                    text-align: right; /* Custom class for right alignment */
                }
                `}
            </style>

            <h1 className="text-4xl font-bold text-center text-[#006B68] mb-8">Qu·∫£n L√Ω Qu·ªπ C∆°m Nh√≥m</h1>

            {/* Overall Fund Balance */}
            <div className="card mb-8 text-center">
                <h2 className="text-2xl font-semibold text-gray-700 mb-4">S·ªë D∆∞ Qu·ªπ Chung</h2>
                <p className={`text-5xl font-extrabold ${fundBalance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {formatNumberForDisplay(fundBalance)} VNƒê
                </p>
            </div>

            {/* Error Message Display */}
            {errorMessage && (
                <div className="error-message mb-4">
                    {errorMessage}
                </div>
            )}

            {/* Action Buttons */}
            <div className="flex flex-col sm:flex-row justify-center gap-4 mb-8">
                <button
                    onClick={() => {
                        hideAllSections();
                        setShowAddMember(!showAddMember);
                    }}
                    className="btn-primary flex items-center justify-center w-full sm:w-auto"
                >
                    <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd"></path></svg>
                    Th√™m Th√†nh Vi√™n
                </button>
                <button
                    onClick={() => {
                        hideAllSections();
                        setShowAddTransaction(!showAddTransaction);
                    }}
                    className="btn-primary flex items-center justify-center w-full sm:w-auto"
                >
                    <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clipRule="evenodd"></path></svg>
                    Th√™m Giao D·ªãch
                </button>
                <button
                    onClick={() => {
                        hideAllSections();
                        setShowTransactions(!showTransactions);
                    }}
                    className="btn-secondary flex items-center justify-center w-full sm:w-auto"
                >
                    <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fillRule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clipRule="evenodd"></path></svg>
                    Xem L·ªãch S·ª≠
                </button>
                <button
                    onClick={() => {
                        hideAllSections();
                        setShowReportSelectionModal(true);
                    }}
                    className="btn-secondary flex items-center justify-center w-full sm:w-auto"
                >
                    <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v14a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm4.5 9.5a.5.5 0 000 1h5a.5.5 0 000-1h-5zM7 7a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clipRule="evenodd"></path></svg>
                    B√°o C√°o
                </button>
                <button
                    onClick={() => {
                        hideAllSections();
                        setShowFundInsightsModal(true);
                        generateFundInsights(); // Trigger insights generation
                    }}
                    className="btn-primary flex items-center justify-center w-full sm:w-auto"
                >
                    ‚ú® Nh·∫≠n Th√¥ng Tin Qu·ªπ
                </button>
            </div>

            {/* Add Member Form */}
            {showAddMember && (
                <div className="card mb-8">
                    <h2 className="text-xl font-semibold mb-4 text-[#006B68]">Th√™m Th√†nh Vi√™n M·ªõi</h2>
                    <AddMemberForm onAddMember={addMember} />
                </div>
            )}

            {/* Add Transaction Form */}
            {showAddTransaction && (
                <div className="card mb-8">
                    <h2 className="text-xl font-semibold mb-4 text-[#006B68]">Th√™m Giao D·ªãch M·ªõi</h2>
                    <AddTransactionForm members={members} onAddTransaction={addTransaction} />
                </div>
            )}

            {/* Member List */}
            <div className="card mb-8">
                <h2 className="text-xl font-semibold mb-4 text-[#006B68]">Danh S√°ch Th√†nh Vi√™n</h2>
                <MemberList
                    members={members}
                    onSettleUp={settleUpMember}
                    onViewDetails={setSelectedMemberForDetails}
                />
            </div>

            {/* Reporting Summary */}
            <div className="card mb-8">
                <h2 className="text-xl font-semibold mb-4 text-[#006B68]">B√°o C√°o T√≥m T·∫Øt</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
                    <div className="p-4 bg-green-50 rounded-lg">
                        <p className="text-lg font-medium text-green-700">T·ªïng ƒê√≥ng G√≥p</p>
                        <p className="text-3xl font-bold text-green-600">{formatNumberForDisplay(totalContributions)} VNƒê</p>
                    </div>
                    <div className="p-4 bg-red-50 rounded-lg">
                        <p className="text-lg font-medium text-red-700">T·ªïng Chi Ti√™u</p>
                        <p className="text-3xl font-bold text-red-600">{formatNumberForDisplay(totalExpenses)} VNƒê</p>
                    </div>
                </div>
                <h3 className="text-xl font-semibold mt-8 mb-4 text-[#006B68] text-center">S·ªë D∆∞ Th√†nh Vi√™n (Bi·ªÉu ƒê·ªì Tr√≤n)</h3>
                <MemberBalancePieChart members={members} />
            </div>

            {/* Report Selection Modal */}
            {showReportSelectionModal && (
                <ReportSelectionModal
                    onSelectFundReport={() => {
                        hideAllSections();
                        setShowFundReport(true);
                    }}
                    onSelectMemberReport={() => {
                        hideAllSections();
                        setShowMemberReports(true);
                    }}
                    onClose={() => setShowReportSelectionModal(false)}
                />
            )}

            {/* Fund Report Section */}
            {showFundReport && (
                <div className="card mb-8">
                    <h2 className="text-xl font-semibold mb-4 text-[#006B68]">B√°o C√°o Qu·ªπ Chung</h2>
                    <FundReport transactions={transactions} members={members} />
                </div>
            )}

            {/* Member Reports Section */}
            {showMemberReports && (
                <div className="card mb-8">
                    <h2 className="text-xl font-semibold mb-4 text-[#006B68]">B√°o C√°o T·ª´ng Th√†nh Vi√™n</h2>
                    <MemberReport members={members} transactions={transactions} />
                </div>
            )}

            {/* Transaction List */}
            {showTransactions && (
                <div className="card">
                    <h2 className="text-xl font-semibold mb-4 text-[#006B68]">L·ªãch S·ª≠ Giao D·ªãch</h2>
                    <TransactionList
                        transactions={transactions}
                        members={members}
                        onEdit={setEditingTransaction}
                        onDelete={deleteTransaction}
                    />
                </div>
            )}

            {/* Edit Transaction Modal */}
            {editingTransaction && (
                <EditTransactionModal
                    transaction={editingTransaction}
                    members={members}
                    onSave={editTransaction}
                    onClose={() => setEditingTransaction(null)}
                />
            )}

            {/* Member Details Modal */}
            {selectedMemberForDetails && (
                <MemberDetailsModal
                    member={selectedMemberForDetails}
                    transactions={transactions}
                    members={members}
                    onClose={() => setSelectedMemberForDetails(null)}
                />
            )}

            {/* Custom Delete Confirmation Modal */}
            {showConfirmDelete && transactionToDelete && (
                <ConfirmationModal
                    message={`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch "${transactionToDelete.description}" n√†y kh√¥ng?`}
                    onConfirm={confirmDelete}
                    onCancel={cancelDelete}
                />
            )}

            {/* Fund Insights Modal */}
            {showFundInsightsModal && (
                <FundInsightsModal
                    insights={fundInsights}
                    isLoading={isGeneratingInsights}
                    onClose={() => setShowFundInsightsModal(false)}
                    errorMessage={errorMessage}
                />
            )}
        </div>
    );
};

// Component for adding a new member
const AddMemberForm = ({ onAddMember }) => {
    const [memberName, setMemberName] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        onAddMember(memberName);
        setMemberName('');
    };

    return (
        <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row gap-4">
            <input
                type="text"
                placeholder="T√™n th√†nh vi√™n"
                value={memberName}
                onChange={(e) => setMemberName(e.target.value)}
                className="input-field flex-grow"
                required
            />
            <button type="submit" className="btn-primary flex-shrink-0 w-full sm:w-auto">
                Th√™m
            </button>
        </form>
    );
};

// Component for adding a new transaction (contribution or expense)
const AddTransactionForm = ({ members, onAddTransaction }) => {
    const [type, setType] = useState('contribution');
    const [amount, setAmount] = useState('');
    const [description, setDescription] = useState('');
    const [contributingMemberId, setContributingMemberId] = useState('');
    const [selectedExpenseMembers, setSelectedExpenseMembers] = useState([]);

    useEffect(() => {
        if (members.length > 0 && !contributingMemberId) {
            setContributingMemberId(members[0].id);
        }
    }, [members, contributingMemberId]);

    const handleExpenseMemberChange = (memberId) => {
        setSelectedExpenseMembers(prevSelected =>
            prevSelected.includes(memberId)
                ? prevSelected.filter(id => id !== memberId)
                : [...prevSelected, memberId]
        );
    };

    const handleAmountChange = (e) => {
        const formattedValue = formatNumberForInput(e.target.value);
        setAmount(formattedValue);
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        const parsedAmount = parseFormattedNumber(amount);
        onAddTransaction(type, parsedAmount, description, contributingMemberId, selectedExpenseMembers);
        setAmount('');
        setDescription('');
        setSelectedExpenseMembers([]);
    };

    return (
        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="col-span-full">
                <label htmlFor="transaction-type" className="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i Giao D·ªãch</label>
                <select
                    id="transaction-type"
                    value={type}
                    onChange={(e) => {
                        setType(e.target.value);
                        if (e.target.value === 'contribution') {
                            setSelectedExpenseMembers([]);
                        } else {
                            setContributingMemberId('');
                        }
                    }}
                    className="input-field"
                >
                    <option value="contribution">üíµ ƒê√≥ng G√≥p</option>
                    <option value="expense">üç∫ Chi Ti√™u</option>
                </select>
            </div>

            {type === 'contribution' && (
                <div className="col-span-full">
                    <label htmlFor="member-select" className="block text-sm font-medium text-gray-700 mb-1">Th√†nh Vi√™n ƒê√≥ng G√≥p</label>
                    <select
                        id="member-select"
                        value={contributingMemberId}
                        onChange={(e) => setContributingMemberId(e.target.value)}
                        className="input-field"
                        required={type === 'contribution'}
                    >
                        {members.length === 0 ? (
                            <option value="">Ch∆∞a c√≥ th√†nh vi√™n n√†o</option>
                        ) : (
                            members.map(member => (
                                <option key={member.id} value={member.id}>{member.name}</option>
                            ))
                        )}
                    </select>
                </div>
            )}

            {type === 'expense' && (
                <div className="col-span-full">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Th√†nh Vi√™n Tham Gia Chi Ti√™u</label>
                    {members.length === 0 ? (
                        <p className="text-gray-500 text-sm">Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë·ªÉ ch·ªçn.</p>
                    ) : (
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                            {members.map(member => (
                                <label key={member.id} className="inline-flex items-center cursor-pointer">
                                    <input
                                        type="checkbox"
                                        className="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]"
                                        value={member.id}
                                        checked={selectedExpenseMembers.includes(member.id)}
                                        onChange={() => handleMemberCheckboxChange(member.id)}
                                    />
                                    <span className="ml-2 text-sm text-gray-700">{member.name}</span>
                                </label>
                            ))}
                        </div>
                    )}
                </div>
            )}

            <div>
                <label htmlFor="amount" className="block text-sm font-medium text-gray-700 mb-1">S·ªë Ti·ªÅn (VNƒê)</label>
                <input
                    id="amount"
                    type="text"
                    placeholder="S·ªë ti·ªÅn"
                    value={amount}
                    onChange={handleAmountChange}
                    className="input-field text-right"
                    required
                />
            </div>
            <div>
                <label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-1">M√¥ T·∫£</label>
                <input
                    id="description"
                    type="text"
                    placeholder="M√¥ t·∫£ giao d·ªãch"
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    className="input-field"
                    required
                />
            </div>
            <div className="col-span-full">
                <button type="submit" className="btn-primary w-full">
                    Ghi L·∫°i Giao D·ªãch
                </button>
            </div>
        </form>
    );
};

// Component for displaying the list of members
const MemberList = ({ members, onSettleUp, onViewDetails }) => {
    return (
        <div className="overflow-x-auto">
            {members.length === 0 ? (
                <p className="text-center text-gray-500">Ch∆∞a c√≥ th√†nh vi√™n n√†o. H√£y th√™m th√†nh vi√™n!</p>
            ) : (
                <table className="min-w-full bg-white rounded-lg shadow-sm">
                    <thead><tr><th className="table-header">T√™n Th√†nh Vi√™n</th><th className="table-header text-right-aligned">S·ªë D∆∞</th><th className="table-header">H√†nh ƒê·ªông</th></tr></thead>
                    <tbody>
                        {members.map(member => (
                            <tr key={member.id} className="table-row">
                                <td className="font-medium text-gray-900">{member.name}</td>
                                <td className="text-right-aligned">
                                    <span className={`text-lg font-bold ${
                                        member.balance > 0 ? 'balance-positive' :
                                        member.balance < 0 ? 'balance-negative' :
                                        'balance-zero'
                                    }`}>
                                        {formatNumberForDisplay(member.balance)} VNƒê
                                    </span>
                                </td>
                                <td className="flex flex-col sm:flex-row gap-2">
                                    <button
                                        onClick={() => onSettleUp(member.id)}
                                        className="text-[#006B68] hover:text-[#005A58] font-semibold text-sm w-full sm:w-auto"
                                        disabled={member.balance === 0}
                                    >
                                        Thanh To√°n
                                    </button>
                                    <button
                                        onClick={() => onViewDetails(member)}
                                        className="text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto"
                                    >
                                        Xem chi ti·∫øt
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            )}
        </div>
    );
};

// Component for displaying the list of transactions
const TransactionList = ({ transactions, members, onEdit, onDelete }) => {
    const getMemberName = (memberId) => {
        const member = members.find(m => m.id === memberId);
        return member ? member.name : 'N/A';
    };

    const getInvolvedMembersNames = (involvedMemberIds) => {
        if (!involvedMemberIds || involvedMemberIds.length === 0) {
            return 'T·∫•t c·∫£';
        }
        return involvedMemberIds.map(id => getMemberName(id)).join(', ');
    };

    return (
        <div className="overflow-x-auto">
            {transactions.length === 0 ? (
                <p className="text-center text-gray-500">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>
            ) : (
                <table className="min-w-full bg-white rounded-lg shadow-sm">
                    <thead><tr><th className="table-header">Ng√†y</th><th>Lo·∫°i</th><th>M√¥ T·∫£</th><th>Th√†nh Vi√™n Li√™n Quan</th><th className="table-header text-right-aligned">S·ªë Ti·ªÅn (VNƒê)</th><th>H√†nh ƒê·ªông</th></tr></thead>
                    <tbody>
                        {transactions.slice().reverse().map(t => {
                            const displayedAmount = t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0
                                ? t.amount / t.involvedMemberIds.length
                                : t.amount;

                            return (
                                <tr key={t.id} className="table-row">
                                    <td>{t.date}</td>
                                    <td>
                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                            t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                        }`}>
                                            {t.type === 'contribution' ? 'üíµ ƒê√≥ng G√≥p' : 'üç∫ Chi Ti√™u'}
                                        </span>
                                    </td>
                                    <td>{t.description}</td>
                                    <td>
                                        {t.type === 'contribution' ? getMemberName(t.contributingMemberId) : getInvolvedMembersNames(t.involvedMemberIds)}
                                    </td>
                                    <td className={`text-right-aligned ${
                                        t.type === 'contribution' ? 'balance-positive' : 'balance-negative'
                                    }`}>
                                        {t.type === 'contribution' ? '+' : '-'}
                                        {formatNumberForDisplay(displayedAmount)}
                                    </td>
                                    <td className="flex flex-col sm:flex-row gap-2">
                                        <button
                                            onClick={() => onEdit(t)}
                                            className="text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto"
                                        >
                                            S·ª≠a
                                        </button>
                                        <button
                                            onClick={() => onDelete(t)}
                                            className="text-red-600 hover:text-red-900 font-semibold text-sm w-full sm:w-auto"
                                        >
                                            X√≥a
                                        </button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            )}
        </div>
    );
};

// Component for Fund Report (Qu·ªπ Chung)
const FundReport = ({ transactions, members }) => {
    const getMemberName = (memberId) => {
        const member = members.find(m => m.id === memberId);
        return member ? member.name : 'N/A';
    };

    const getInvolvedMembersNames = (involvedMemberIds) => {
        if (!involvedMemberIds || involvedMemberIds.length === 0) {
            return 'T·∫•t c·∫£';
        }
        return involvedMemberIds.map(id => getMemberName(id)).join(', ');
    };

    const exportToExcel = () => {
        if (typeof window.XLSX === 'undefined') {
            alert('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.');
            return;
        }

        const reportData = transactions.slice().reverse().map(t => {
            const displayedAmount = t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0
                ? t.amount / t.involvedMemberIds.length
                : t.amount;
            return {
                'Ng√†y': t.date,
                'Lo·∫°i': t.type === 'contribution' ? 'ƒê√≥ng G√≥p' : 'Chi Ti√™u',
                'M√¥ T·∫£': t.description,
                'Th√†nh Vi√™n Li√™n Quan': t.type === 'contribution' ? getMemberName(t.contributingMemberId) : getInvolvedMembersNames(t.involvedMemberIds),
                'S·ªë Ti·ªÅn (VNƒê)': (t.type === 'contribution' ? '+' : '-') + formatNumberForDisplay(displayedAmount),
            };
        });

        const ws = window.XLSX.utils.json_to_sheet(reportData);
        const wb = window.XLSX.utils.book_new();
        window.XLSX.utils.book_append_sheet(wb, ws, 'B√°o C√°o Qu·ªπ Chung');
        window.XLSX.writeFile(wb, 'BaoCaoQuyChung.xlsx');
    };

    return (
        <div>
            <div className="flex flex-wrap justify-end gap-4 mb-4">
                <button onClick={exportToExcel} className="btn-secondary flex items-center">
                    <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd"></path></svg>
                    Xu·∫•t Excel
                </button>
            </div>
            {transactions.length === 0 ? (
                <p className="text-center text-gray-500">Ch∆∞a c√≥ giao d·ªãch n√†o ƒë·ªÉ b√°o c√°o.</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th className="table-header">Ng√†y</th>
                                <th className="table-header">Lo·∫°i</th>
                                <th className="table-header">M√¥ T·∫£</th>
                                <th className="table-header">Th√†nh Vi√™n Li√™n Quan</th>
                                <th className="table-header text-right-aligned">S·ªë Ti·ªÅn (VNƒê)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {transactions.slice().reverse().map(t => {
                                const displayedAmount = t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0
                                    ? t.amount / t.involvedMemberIds.length
                                    : t.amount;
                                return (
                                    <tr key={t.id} className="table-row">
                                        <td>{t.date}</td>
                                        <td>
                                            <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                                t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                            }`}>
                                                {t.type === 'contribution' ? 'üíµ ƒê√≥ng G√≥p' : 'üç∫ Chi Ti√™u'}
                                            </span>
                                        </td>
                                        <td>{t.description}</td>
                                        <td>
                                            {t.type === 'contribution' ? getMemberName(t.contributingMemberId) : getInvolvedMembersNames(t.involvedMemberIds)}
                                        </td>
                                        <td className={`text-right-aligned ${
                                            t.type === 'contribution' ? 'balance-positive' : 'balance-negative'
                                        }`}>
                                            {t.type === 'contribution' ? '+' : '-'}
                                            {formatNumberForDisplay(displayedAmount)}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
};

// Component for Individual Member Reports
const MemberReport = ({ members, transactions }) => {
    const [selectedMemberId, setSelectedMemberId] = useState('');
    const [memberTransactions, setMemberTransactions] = useState([]);

    useEffect(() => {
        if (members.length > 0 && !selectedMemberId) {
            setSelectedMemberId(members[0].id);
        }
    }, [members, selectedMemberId]);

    useEffect(() => {
        if (selectedMemberId) {
            const filteredTransactions = transactions.filter(t =>
                (t.type === 'contribution' && t.contributingMemberId === selectedMemberId) ||
                (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(selectedMemberId))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));
            setMemberTransactions(filteredTransactions);
        } else {
            setMemberTransactions([]);
        }
    }, [selectedMemberId, transactions]);

    const getMemberName = (memberId) => {
        const member = members.find(m => m.id === memberId);
        return member ? member.name : 'N/A';
    };

    const exportToExcel = () => {
        if (typeof window.XLSX === 'undefined') {
            alert('Th∆∞ vi·ªán XLSX ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.');
            return;
        }
        const memberName = getMemberName(selectedMemberId);
        const reportData = memberTransactions.map(t => {
            let displayedAmount = t.amount;
            if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                displayedAmount = t.amount / t.involvedMemberIds.length;
            }
            return {
                'Ng√†y': t.date,
                'Lo·∫°i': t.type === 'contribution' ? 'ƒê√≥ng G√≥p' : 'Chi Ti√™u',
                'M√¥ T·∫£': t.description,
                'S·ªë Ti·ªÅn (VNƒê)': (t.type === 'contribution' ? '+' : '-') + formatNumberForDisplay(displayedAmount),
            };
        });

        const ws = window.XLSX.utils.json_to_sheet(reportData);
        const wb = window.XLSX.utils.book_new();
        window.XLSX.utils.book_append_sheet(wb, ws, `B√°o C√°o ${memberName}`);
        window.XLSX.writeFile(wb, `BaoCao_${memberName}.xlsx`);
    };

    return (
        <div>
            <div className="mb-4">
                <label htmlFor="select-member-report" className="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn Th√†nh Vi√™n:</label>
                <select
                    id="select-member-report"
                    value={selectedMemberId}
                    onChange={(e) => setSelectedMemberId(e.target.value)}
                    className="input-field"
                >
                    {members.length === 0 ? (
                        <option value="">Ch∆∞a c√≥ th√†nh vi√™n n√†o</option>
                    ) : (
                        members.map(member => (
                            <option key={member.id} value={member.id}>{member.name}</option>
                        ))
                    )}
                </select>
            </div>

            {selectedMemberId && (
                <div className="flex flex-wrap justify-end gap-4 mb-4">
                    <button onClick={exportToExcel} className="btn-secondary flex items-center">
                        <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd"></path></svg>
                        Xu·∫•t Excel
                    </button>
                </div>
            )}

            {selectedMemberId && memberTransactions.length === 0 ? (
                <p className="text-center text-gray-500">Th√†nh vi√™n n√†y ch∆∞a c√≥ giao d·ªãch n√†o.</p>
            ) : selectedMemberId ? (
                <div className="overflow-x-auto">
                    <table className="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th className="table-header">Ng√†y</th>
                                <th className="table-header">Lo·∫°i</th>
                                <th className="table-header">M√¥ T·∫£</th>
                                <th className="table-header text-right-aligned">S·ªë Ti·ªÅn (VNƒê)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {memberTransactions.map(t => {
                                let displayedAmount = t.amount;
                                if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                                    displayedAmount = t.amount / t.involvedMemberIds.length;
                                }
                                return (
                                    <tr key={t.id} className="table-row">
                                        <td>{t.date}</td>
                                        <td>
                                            <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                                t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                            }`}>
                                                {t.type === 'contribution' ? 'üíµ ƒê√≥ng G√≥p' : 'üç∫ Chi Ti√™u'}
                                            </span>
                                        </td>
                                        <td>{t.description}</td>
                                        <td className={`text-right-aligned ${
                                            t.type === 'contribution' ? 'balance-positive' : 'balance-negative'
                                        }`}>
                                            {t.type === 'contribution' ? '+' : '-'}
                                            {formatNumberForDisplay(displayedAmount)}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            ) : (
                <p className="text-center text-gray-500">Vui l√≤ng ch·ªçn m·ªôt th√†nh vi√™n ƒë·ªÉ xem b√°o c√°o.</p>
            )}
        </div>
    );
};

// Modal for editing a transaction
const EditTransactionModal = ({ transaction, members, onSave, onClose }) => {
    const [editedType, setEditedType] = useState(transaction.type);
    const [editedAmount, setEditedAmount] = useState(formatNumberForInput(transaction.amount.toString()));
    const [editedDescription, setEditedDescription] = useState(transaction.description);
    const [editedContributingMemberId, setEditedContributingMemberId] = useState(transaction.contributingMemberId || '');
    const [editedInvolvedMemberIds, setEditedInvolvedMemberIds] = useState(transaction.involvedMemberIds || []);

    const handleMemberCheckboxChange = useCallback((memberId) => {
        setEditedInvolvedMemberIds(prevSelected =>
            prevSelected.includes(memberId)
                ? prevSelected.filter(id => id !== memberId)
                : [...prevSelected, memberId]
        );
    }, []);

    const handleEditedAmountChange = (e) => {
        const formattedValue = formatNumberForInput(e.target.value);
        setEditedAmount(formattedValue);
    };

    useEffect(() => {
        if (editedType === 'contribution' && members.length > 0 && !editedContributingMemberId) {
            setEditedContributingMemberId(members[0].id);
        }
        if (editedType === 'contribution') {
            setEditedInvolvedMemberIds([]);
        } else {
            setEditedContributingMemberId('');
        }
    }, [editedType, members, editedContributingMemberId]);


    const handleSubmit = (e) => {
        e.preventDefault();
        const parsedEditedAmount = parseFormattedNumber(editedAmount);
        onSave({
            ...transaction,
            type: editedType,
            amount: parsedEditedAmount,
            description: editedDescription,
            contributingMemberId: editedType === 'contribution' ? editedContributingMemberId : null,
            involvedMemberIds: editedType === 'expense' ? editedInvolvedMemberIds : [],
        });
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content w-11/12 md:w-2/3 lg:w-1/2">
                <h2 className="text-2xl font-semibold mb-6 text-[#006B68]">Ch·ªânh S·ª≠a Giao D·ªãch</h2>
                <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="col-span-full">
                        <label htmlFor="edit-transaction-type" className="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i Giao D·ªãch</label>
                        <select
                            id="edit-transaction-type"
                            value={editedType}
                            onChange={(e) => setEditedType(e.target.value)}
                            className="input-field"
                        >
                            <option value="contribution">üíµ ƒê√≥ng G√≥p</option>
                            <option value="expense">üç∫ Chi Ti√™u</option>
                        </select>
                    </div>

                    {editedType === 'contribution' && (
                        <div className="col-span-full">
                            <label htmlFor="edit-member-select" className="block text-sm font-medium text-gray-700 mb-1">Th√†nh Vi√™n ƒê√≥ng G√≥p</label>
                            <select
                                id="edit-member-select"
                                value={editedContributingMemberId}
                                onChange={(e) => setEditedContributingMemberId(e.target.value)}
                                className="input-field"
                                required={editedType === 'contribution'}
                            >
                                {members.length === 0 ? (
                                    <option value="">Ch∆∞a c√≥ th√†nh vi√™n n√†o</option>
                                ) : (
                                    members.map(member => (
                                        <option key={member.id} value={member.id}>{member.name}</option>
                                    ))
                                )}
                            </select>
                        </div>
                    )}

                    {editedType === 'expense' && (
                        <div className="col-span-full">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Th√†nh Vi√™n Tham Gia Chi Ti√™u</label>
                            {members.length === 0 ? (
                                <p className="text-gray-500 text-sm">Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë·ªÉ ch·ªçn.</p>
                            ) : (
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                                    {members.map(member => (
                                        <label key={member.id} className="inline-flex items-center cursor-pointer">
                                            <input
                                                type="checkbox"
                                                className="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]"
                                                value={member.id}
                                                checked={editedInvolvedMemberIds.includes(member.id)}
                                                onChange={() => handleMemberCheckboxChange(member.id)}
                                            />
                                            <span className="ml-2 text-sm text-gray-700">{member.name}</span>
                                        </label>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    <div>
                        <label htmlFor="edit-amount" className="block text-sm font-medium text-gray-700 mb-1">S·ªë Ti·ªÅn (VNƒê)</label>
                        <input
                            id="edit-amount"
                            type="text"
                            placeholder="S·ªë ti·ªÅn"
                            value={editedAmount}
                            onChange={handleEditedAmountChange}
                            className="input-field text-right"
                            required
                        />
                    </div>
                    <div>
                        <label htmlFor="edit-description" className="block text-sm font-medium text-gray-700 mb-1">M√¥ T·∫£</label>
                        <input
                            id="edit-description"
                            type="text"
                            placeholder="M√¥ t·∫£ giao d·ªãch"
                            value={editedDescription}
                            onChange={(e) => setEditedDescription(e.target.value)}
                            className="input-field"
                            required
                        />
                    </div>
                    <div className="col-span-full flex flex-col sm:flex-row justify-end gap-4 mt-4">
                        <button type="button" onClick={onClose} className="btn-secondary w-full sm:w-auto">
                            H·ªßy
                        </button>
                        <button type="submit" className="btn-primary w-full sm:w-auto">
                            L∆∞u Thay ƒê·ªïi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

// Modal for displaying individual member details and transactions
const MemberDetailsModal = ({ member, transactions, members, onClose }) => {
    const getMemberName = (memberId) => {
        const foundMember = members.find(m => m.id === memberId);
        return foundMember ? foundMember.name : 'N/A';
    };

    const getInvolvedMembersNames = (involvedMemberIds) => {
        if (!involvedMemberIds || involvedMemberIds.length === 0) {
            return 'T·∫•t c·∫£';
        }
        return involvedMemberIds.map(id => getMemberName(id)).join(', ');
    };

    const memberTransactions = transactions.filter(t =>
        (t.type === 'contribution' && t.contributingMemberId === member.id) ||
        (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(member.id))
    ).sort((a, b) => new Date(b.date) - new Date(a.date));

    return (
        <div className="modal-overlay">
            <div className="modal-content w-11/12 md:w-2/3 lg:w-1/2">
                <h2 className="text-2xl font-semibold mb-6 text-[#006B68]">Chi Ti·∫øt Th√†nh Vi√™n: {member.name}</h2>
                <div className="mb-4">
                    <p className="text-lg font-medium text-gray-700">S·ªë D∆∞ Hi·ªán T·∫°i:</p>
                    <p className={`text-3xl font-bold ${member.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {formatNumberForDisplay(member.balance)} VNƒê
                    </p>
                </div>

                <h3 className="text-xl font-semibold mb-3 text-[#006B68]">C√°c Giao D·ªãch Li√™n Quan</h3>
                {memberTransactions.length === 0 ? (
                    <p className="text-center text-gray-500">Ch∆∞a c√≥ giao d·ªãch n√†o li√™n quan ƒë·∫øn th√†nh vi√™n n√†y.</p>
                ) : (
                    <div className="overflow-x-auto max-h-80">
                        <table className="min-w-full bg-white rounded-lg shadow-sm">
                            <thead><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>M√¥ T·∫£</th><th className="table-header text-right-aligned">S·ªë Ti·ªÅn (VNƒê)</th></tr></thead>
                            <tbody>
                                {memberTransactions.map(t => {
                                    let displayedAmount = t.amount;
                                    if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                                        displayedAmount = t.amount / t.involvedMemberIds.length;
                                    }

                                    return (
                                        <tr key={t.id} className="table-row">
                                            <td>{t.date}</td>
                                            <td>
                                                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                                    t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                }`}>
                                                    {t.type === 'contribution' ? 'üíµ ƒê√≥ng G√≥p' : 'üç∫ Chi Ti√™u'}
                                                </span>
                                            </td>
                                            <td>{t.description}</td>
                                            <td className={`text-right-aligned ${
                                                t.type === 'contribution' ? 'balance-positive' : 'balance-negative'
                                            }`}>
                                                {t.type === 'contribution' ? '+' : '-'}
                                                {formatNumberForDisplay(displayedAmount)}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
                <div className="flex justify-end mt-6">
                    <button type="button" onClick={onClose} className="btn-primary">
                        ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    );
};

// Generic Confirmation Modal
const ConfirmationModal = ({ message, onConfirm, onCancel }) => {
    return (
        <div className="modal-overlay">
            <div className="modal-content w-11/12 md:w-1/2 lg:w-1/3">
                <h2 className="text-xl font-semibold mb-4 text-gray-800">X√°c Nh·∫≠n</h2>
                <p className="mb-6 text-gray-700">{message}</p>
                <div className="flex flex-col sm:flex-row justify-end gap-4">
                    <button onClick={onCancel} className="btn-secondary w-full sm:w-auto">
                        H·ªßy
                    </button>
                    <button onClick={onConfirm} className="btn-primary w-full sm:w-auto">
                        X√°c Nh·∫≠n
                    </button>
                </div>
            </div>
        </div>
    );
};

// New component for Report Selection Modal
const ReportSelectionModal = ({ onSelectFundReport, onSelectMemberReport, onClose }) => {
    return (
        <div className="modal-overlay">
            <div className="modal-content w-11/12 md:w-1/2 lg:w-1/3">
                <h2 className="text-2xl font-semibold mb-6 text-[#006B68] text-center">Ch·ªçn Lo·∫°i B√°o C√°o</h2>
                <div className="flex flex-col gap-4">
                    <button
                        onClick={() => {
                            onSelectFundReport();
                            onClose();
                        }}
                        className="btn-primary flex items-center justify-center w-full"
                    >
                        <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd"></path></svg>
                        B√°o C√°o Qu·ªπ Chung
                    </button>
                    <button
                        onClick={() => {
                            onSelectMemberReport();
                            onClose();
                        }}
                        className="btn-primary flex items-center justify-center w-full"
                    >
                        <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a4 4 0 00-4 4h8a4 4 0 00-4-4z" clipRule="evenodd"></path></svg>
                        B√°o C√°o T·ª´ng Th√†nh Vi√™n
                    </button>
                </div>
                <div className="flex justify-end mt-6">
                    <button type="button" onClick={onClose} className="btn-secondary">
                        ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    );
};

// Helper functions for SVG arc drawing (placed outside component for reusability)
const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
    const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
    return {
        x: centerX + (radius * Math.cos(angleInRadians)),
        y: centerY + (radius * Math.sin(angleInRadians))
    };
};

const describePieSlice = (centerX, centerY, radius, startAngle, endAngle) => {
    const start = polarToCartesian(centerX, centerY, radius, endAngle);
    const end = polarToCartesian(centerX, centerY, radius, startAngle);
    const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

    const pathData = [
        `M ${centerX} ${centerY}`,
        `L ${start.x} ${start.y}`,
        `A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y}`,
        `L ${centerX} ${centerY}`,
        `Z`
    ].join(" ");

    return pathData;
};

// New Component for Member Balance Pie Chart
const MemberBalancePieChart = ({ members }) => {
    const CHART_SIZE = 200;
    const RADIUS = CHART_SIZE / 2 - 10;
    const centerX = CHART_SIZE / 2;
    const centerY = CHART_SIZE / 2;

    const colorPalette = [
        '#4CAF50', // Green
        '#2196F3', // Blue
        '#FFC107', // Amber
        '#F44336', // Red
        '#9C27B0', // Purple
        '#FF9800', // Orange
        '#00BCD4', // Cyan
        '#E91E63', // Pink
        '#795548', // Brown
        '#607D8B', // Blue Grey
    ];

    const chartData = members.filter(m => m.balance !== 0);
    const totalAbsoluteBalance = chartData.reduce((sum, m) => sum + Math.abs(m.balance), 0);

    if (chartData.length === 0) {
        return <p className="text-center text-gray-500 mt-4">Ch∆∞a c√≥ s·ªë d∆∞ n√†o ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.</p>;
    }

    let currentAngle = 0;
    const slices = [];

    chartData.forEach((member, index) => {
        const sliceAngle = (Math.abs(member.balance) / totalAbsoluteBalance) * 360;
        const startAngle = currentAngle;
        const endAngle = currentAngle + sliceAngle;

        const pathData = describePieSlice(centerX, centerY, RADIUS, startAngle, endAngle);
        const color = colorPalette[index % colorPalette.length];

        const midAngle = startAngle + sliceAngle / 2;
        const labelRadius = RADIUS * 0.7;
        const labelPos = polarToCartesian(centerX, centerY, labelRadius, midAngle);

        slices.push(
            <g key={member.id}>
                <path
                    d={pathData}
                    fill={color}
                    stroke="white"
                    strokeWidth="1"
                />
                {sliceAngle > 10 && (
                    <text
                        x={labelPos.x}
                        y={labelPos.y}
                        fill="white"
                        fontSize="10"
                        textAnchor="middle"
                        alignmentBaseline="middle"
                        fontWeight="bold"
                    >
                        {member.name}
                    </text>
                )}
            </g>
        );
        currentAngle = endAngle;
    });

    return (
        <div className="flex justify-center items-center w-full my-4">
            <svg viewBox={`0 0 ${CHART_SIZE} ${CHART_SIZE}`} width="100%" height="auto" style={{ maxWidth: '300px' }}>
                {slices}
                <text x={centerX} y={centerY} textAnchor="middle" alignmentBaseline="middle" fontSize="12" fontWeight="bold" fill="#333">
                    T·ªïng: {formatNumberForDisplay(totalAbsoluteBalance)} VNƒê
                </text>
            </svg>
            <div className="ml-8 p-4 bg-gray-50 rounded-lg shadow-sm">
                <h4 className="font-semibold text-gray-700 mb-2">Ch√∫ Th√≠ch:</h4>
                {chartData.map((member, index) => (
                    <div key={member.id} className="flex items-center mb-1">
                        <span
                            className="inline-block w-4 h-4 rounded-full mr-2"
                            style={{ backgroundColor: colorPalette[index % colorPalette.length] }}
                        ></span>
                        <span className="text-sm text-gray-800">{member.name}</span>
                    </div>
                ))}
            </div>
        </div>
    );
};

// New Component for Fund Insights Modal
const FundInsightsModal = ({ insights, isLoading, onClose, errorMessage }) => {
    return (
        <div className="modal-overlay">
            <div className="modal-content w-11/12 md:w-2/3 lg:w-1/2">
                <h2 className="text-2xl font-semibold mb-6 text-[#006B68]">Th√¥ng Tin Chi Ti·∫øt Qu·ªπ ‚ú®</h2>
                {isLoading ? (
                    <div className="flex flex-col items-center justify-center p-8">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#006B68]"></div>
                        <p className="mt-4 text-gray-600">ƒêang t·∫°o th√¥ng tin chi ti·∫øt t·ª´ AI...</p>
                    </div>
                ) : errorMessage ? (
                    <div className="error-message mb-4">
                        {errorMessage}
                    </div>
                ) : (
                    <div className="prose max-w-none">
                        {insights ? (
                            // Render insights, preserving newlines
                            insights.split('\n').map((line, index) => (
                                <p key={index} className="mb-2 text-gray-700">{line}</p>
                            ))
                        ) : (
                            <p className="text-center text-gray-500">Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt n√†o ƒë∆∞·ª£c t·∫°o. Vui l√≤ng th·ª≠ l·∫°i.</p>
                        )}
                    </div>
                )}
                <div className="flex justify-end mt-6">
                    <button type="button" onClick={onClose} className="btn-primary">
                        ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>
    );
};


export default App;
