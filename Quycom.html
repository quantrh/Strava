<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">QUẢN LÝ QUỸ NHÓM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #006B68; /* BIDV Brand Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #005A58; /* Darker BIDV Blue */ }
        .btn-secondary {
            background-color: #E0E7FF; /* Light background */
            color: #006B68; /* BIDV Brand Blue for text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover { background-color: #CCF0EF; /* Lighter BIDV Blue for hover */ }
        .input-field {
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .table-header th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #4B5563;
            border-bottom: 1px solid #E5E7EB;
        }
        .table-row td {
            padding: 0.75rem;
            border-bottom: 1px solid #F3F4F6;
        }
        .balance-positive { color: #10B981; font-weight: 600; } /* Green */
        .balance-negative { color: #EF4444; font-weight: 600; } /* Red */
        .balance-zero { color: #6B7280; } /* Gray */
        .error-message {
            background-color: #FEE2E2;
            color: #DC2626;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .text-right-aligned {
            text-align: right; /* Custom class for right alignment */
        }
        /* Styles for the scroll-to-top button */
        #scroll-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #006B68;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Initially hidden */
            transform: scale(0.8); /* Slightly smaller when hidden */
            z-index: 999; /* Ensure it's above other content */
        }
        #scroll-to-top-btn.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Styles for Word export - ensure table borders are visible */
        /* These styles will be embedded directly into the HTML for Word export */
        .word-export-table {
            border-collapse: collapse;
            width: 100%;
        }
        .word-export-table th,
        .word-export-table td {
            border: 1px solid #e5e7eb; /* Add borders for Word */
            padding: 0.75rem;
            text-align: left;
        }
        .word-export-table th {
            background-color: #f3f4f6; /* Light background for headers */
            font-weight: 600;
        }
        .word-export-table .balance-positive { color: #10B981; }
        .word-export-table .balance-negative { color: #EF4444; }
        .word-export-table .balance-zero { color: #6B7280; }
        .word-export-table .text-right-aligned { text-align: right; }

        /* Camera Modal Specific Styles */
        #camera-modal .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            max-width: 95%;
            width: 600px; /* Max width for camera feed */
        }
        /* Removed video-feed and camera-canvas styles as they are no longer used */
        #uploaded-image-preview { /* Renamed from captured-image */
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none; /* Hidden by default */
        }
        #camera-loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #006B68;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Language Switch Styles */
        .language-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #E0E7FF;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .language-switch button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: #006B68;
        }
        .language-switch button.active {
            background-color: #006B68;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Hamburger Menu Specific Styles */
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative; /* Changed to relative to contain absolute menu */
            z-index: 50;
        }
        #hamburger-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        #hamburger-btn:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu {
            position: absolute; /* Changed to absolute */
            top: 100%; /* Position below the navbar */
            left: 1rem;
            margin-top: 0.5rem;
            background-color: #ffffff; /* Added background color */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 12rem;
            overflow: hidden;
            z-index: 60; /* Increased z-index to ensure it's above navbar content */
        }
        #hamburger-menu a {
            display: flex; /* Use flex to align icon and text */
            align-items: center;
            padding: 0.75rem 1rem;
            color: #374151;
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        #hamburger-menu a:hover {
            background-color: #F3F4F6;
        }
        #hamburger-menu.hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-sans text-gray-800">

  
<!-- Navbar with Hamburger Menu -->
<div class="navbar flex items-center">
    <!-- Hamburger button on the left -->
    <button id="hamburger-btn" aria-label="Mở menu">
        <!-- SVG 3-line icon -->
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Hidden menu when not active -->
    <div id="hamburger-menu" class="hidden">
        <a href="CalendarMaker.html">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Tạo Lịch
        </a>
    </div>

    <!-- Logo and Title (pushed to the right) -->
    <div class="flex items-center ml-4 flex-grow">
        <img src="LogoQuy.png" alt="Logo Quản Lý Quỹ Nhóm" class="h-12 w-auto rounded-lg shadow-md mr-3" onerror="this.onerror=null;this.src='https://placehold.co/100x100/006B68/FFFFFF?text=Logo';">
        <h1 class="text-2xl font-bold text-[#006B68]" data-key="appTitle">QUẢN LÝ QUỸ NHÓM</h1>
    </div>
  <div class="language-switch">
            <button id="lang-vi-btn" data-lang="vi" class="active">VI</button>
            <button id="lang-en-btn" data-lang="en">EN</button>
        </div>

</div>


    <div id="fund-balance-card" class="card mb-8 text-center">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4" data-key="fundBalanceTitle">Số Dư Quỹ Chung</h2>
        <p id="fund-balance-display" class="text-5xl font-extrabold text-green-600">0 VNĐ</p>
    </div>

    <div id="error-message-display" class="error-message mb-4 hidden"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button id="add-member-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
            <span data-key="addMemberBtn">Thêm Thành Viên</span>
        </button>
        <button id="add-transaction-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
            <span data-key="addTransactionBtn">Thêm Giao Dịch</span>
        </button>
        <button id="view-transactions-btn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd"></path></svg>
            <span data-key="viewHistoryBtn">Xem Lịch Sử</span>
        </button>
        <button id="show-report-selection-btn" class="btn-secondary flex items-center justify-center w-full sm:w-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v14a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm4.5 9.5a.5.5 0 000 1h5a.5.5 0 000-1h-5zM7 7a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
            <span data-key="reportBtn">Báo Cáo</span>
        </button>
        <button id="get-insights-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            ✨ <span data-key="aiInsightsBtn">AI Nhận xét Quỹ</span>
        </button>
        <button id="get-food-suggestions-btn" class="btn-primary flex items-center justify-center w-full sm:w-auto">
            🍜 <span data-key="foodSuggestionsBtn">Gợi ý món ăn</span>
        </button>
    </div>

    <div id="add-member-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="addMemberTitle">Thêm Thành Viên Mới</h2>
        <form id="add-member-form" class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="member-name-input" name="memberName" data-key="memberNamePlaceholder" placeholder="Tên thành viên" class="input-field flex-grow" required />
            <button type="submit" class="btn-primary flex-shrink-0 w-full sm:w-auto" data-key="addBtn">Thêm</button>
        </form>
    </div>

    <div id="add-transaction-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="addTransactionTitle">Thêm Giao Dịch Mới</h2>
        <form id="add-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-full">
                <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionTypeLabel">Loại Giao Dịch</label>
                <select id="transaction-type" name="transactionType" class="input-field">
                    <option value="contribution" data-key="contributionOption">💵 Đóng Góp</option>
                    <option value="expense" data-key="expenseOption">🍺 Chi Tiêu</option>
                </select>
            </div>

            <div id="expense-type-div" class="col-span-full hidden">
                <label for="expense-type-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="expenseTypeLabel">Loại Chi Tiêu</label>
                <select id="expense-type-select" name="expenseType" class="input-field"></select>
            </div>

            <div id="contributing-member-div" class="col-span-full">
                <label for="member-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="contributingMemberLabel">Thành Viên Đóng Góp</label>
                <select id="member-select" name="contributingMember" class="input-field" required></select>
            </div>

            <div id="involved-members-div" class="col-span-full hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1" data-key="involvedMembersLabel">Thành Viên Tham Gia Chi Tiêu</label>
                <div id="involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                    </div>
            </div>

            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1" data-key="amountLabel">Số Tiền (VNĐ)</label>
                <input type="text" id="amount-input" name="amount" data-key="amountPlaceholder" placeholder="Số tiền" class="input-field text-right" required />
            </div>
            
            <!-- New: Date input field -->
            <div>
                <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionDateLabel">Ngày Giao Dịch</label>
                <input type="datetime-local" id="transaction-date-input" name="transactionDate" class="input-field" required />
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1" data-key="descriptionLabel">Mô Tả</label>
                <textarea id="description-input" name="description" data-key="descriptionPlaceholder" placeholder="Mô tả giao dịch" class="input-field resize-y overflow-auto" rows="3" required></textarea>
                <button type="button" id="ai-describe-btn" class="btn-secondary mt-2 w-full flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.147-1.146A2 2 0 009.172 3H6a2 2 0 00-2 2zM14 8a2 2 0 11-4 0 2 2 0 014 0z" clip-rule="evenodd"></path></svg>
                    <span data-key="aiDescribeBtn">Mô tả AI từ Ảnh/Camera</span>
                </button>
            </div>
            <!-- Hidden input for GPS coordinates -->
            <input type="hidden" id="latitude-input" name="latitude">
            <input type="hidden" id="longitude-input" name="longitude">

            <div class="col-span-full">
                <button type="submit" class="btn-primary w-full" data-key="recordTransactionBtn">Ghi Lại Giao Dịch</button>
            </div>
        </form>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="memberListTitle">Danh Sách Thành Viên</h2>
        <div id="member-list-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="loadingMembers">Đang tải thành viên...</p>
        </div>
    </div>

    <div class="card mb-8">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="summaryReportTitle">Báo Cáo Tóm Tắt</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
            <div class="p-4 bg-green-50 rounded-lg">
                <p class="text-lg font-medium text-green-700" data-key="totalContributions">Tổng Đóng Góp</p>
                <p id="total-contributions-display" class="text-3xl font-bold text-green-600">0 VNĐ</p>
            </div>
            <div class="p-4 bg-red-50 rounded-lg">
                <p class="text-lg font-medium text-red-700" data-key="totalExpenses">Tổng Chi Tiêu</p>
                <p id="total-expenses-display" class="text-3xl font-bold text-red-600">0 VNĐ</p>
            </div>
        </div>
        <h3 class="text-xl font-semibold mt-8 mb-4 text-[#006B68] text-center" data-key="memberBalanceChartTitle">Số Dư Thành Viên (Biểu Đồ Tròn)</h3>
        <div id="member-balance-pie-chart" class="flex justify-center items-center w-full my-4">
            <p class="text-center text-gray-500 mt-4" data-key="loadingChart">Đang tải biểu đồ...</p>
        </div>

        <h3 class="text-xl font-semibold mt-8 mb-4 text-[#006B68] text-center" data-key="categoryChartsTitle">Thu/Chi Theo Phân Loại (Biểu Đồ Bánh)</h3>
        <div id="category-pie-charts" class="flex flex-col md:flex-row justify-around items-center w-full my-4 gap-8">
            <div id="income-pie-chart-container" class="flex flex-col items-center">
                <h4 class="text-lg font-semibold text-green-700 mb-2" data-key="incomeByCategory">Thu nhập theo loại</h4>
                <p class="text-center text-gray-500 mt-4" data-key="loadingChart">Đang tải biểu đồ...</p>
            </div>
            <div id="expense-pie-chart-container" class="flex flex-col items-center">
                <h4 class="text-lg font-semibold text-red-700 mb-2" data-key="expenseByCategory">Chi tiêu theo loại</h4>
                <p class="text-center text-gray-500 mt-4" data-key="loadingChart">Đang tải biểu đồ...</p>
            </div>
        </div>
    </div>

    <div id="fund-report-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="fundReportTitle">Báo Cáo Quỹ Chung</h2>
        <div class="flex flex-wrap justify-end gap-4 mb-4">
            <button id="export-fund-report-excel" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                <span data-key="exportExcelBtn">Xuất Excel</span>
            </button>
            <button id="export-fund-report-word" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6z" clip-rule="evenodd"></path></svg>
                <span data-key="exportWordBtn">Xuất Word</span>
            </button>
        </div>
        <div id="fund-report-table-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="noTransactionsReport">Chưa có giao dịch nào để báo cáo.</p>
        </div>
    </div>

    <div id="member-reports-section" class="card mb-8 hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="memberReportsTitle">Báo Cáo Từng Thành Viên</h2>
        <div class="mb-4">
            <label for="select-member-report" class="block text-sm font-medium text-gray-700 mb-1" data-key="selectMemberReportLabel">Chọn Thành Viên:</label>
            <select id="select-member-report" name="selectMemberReport" class="input-field"></select>
        </div>
        <div class="flex flex-wrap justify-end gap-4 mb-4">
            <button id="export-member-report-excel" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                <span data-key="exportExcelBtn">Xuất Excel</span>
            </button>
            <button id="export-member-report-word" class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 2a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6zm0 4a1 1 0 000 2h8a1 1 0 000-2H6z" clip-rule="evenodd"></path></svg>
                <span data-key="exportWordBtn">Xuất Word</span>
            </button>
        </div>
        <div id="member-report-table-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="selectMemberToReport">Vui lòng chọn một thành viên để xem báo cáo.</p>
        </div>
    </div>

    <div id="transactions-section" class="card hidden">
        <h2 class="text-xl font-semibold mb-4 text-[#006B68]" data-key="transactionHistoryTitle">Lịch Sử Giao Dịch</h2>
        <div id="transaction-list-container" class="overflow-x-auto">
            <p class="text-center text-gray-500" data-key="loadingTransactions">Đang tải giao dịch...</p>
        </div>
    </div>

    <div id="edit-transaction-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="editTransactionModalTitle">Chỉnh Sửa Giao Dịch</h2>
            <form id="edit-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full">
                    <label for="edit-transaction-type" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionTypeLabel">Loại Giao Dịch</label>
                    <select id="edit-transaction-type" name="editTransactionType" class="input-field">
                        <option value="contribution" data-key="contributionOption">💵 Đóng Góp</option>
                        <option value="expense" data-key="expenseOption">🍺 Chi Tiêu</option>
                    </select>
                </div>

                <div id="edit-expense-type-div" class="col-span-full hidden">
                    <label for="edit-expense-type-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="expenseTypeLabel">Loại Chi Tiêu</label>
                    <select id="edit-expense-type-select" name="editExpenseType" class="input-field"></select>
                </div>

                <div id="edit-contributing-member-div" class="col-span-full">
                    <label for="edit-member-select" class="block text-sm font-medium text-gray-700 mb-1" data-key="contributingMemberLabel">Thành Viên Đóng Góp</label>
                    <select id="edit-member-select" name="editContributingMember" class="input-field" required></select>
                </div>

                <div id="edit-involved-members-div" class="col-span-full hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-key="involvedMembersLabel">Thành Viên Tham Gia Chi Tiêu</label>
                    <div id="edit-involved-members-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                        </div>
                </div>

                <div>
                    <label for="edit-amount" class="block text-sm font-medium text-gray-700 mb-1" data-key="amountLabel">Số Tiền (VNĐ)</label>
                    <input type="text" id="edit-amount-input" name="editAmount" data-key="amountPlaceholder" placeholder="Số tiền" class="input-field text-right" required />
                </div>
                <!-- New: Date input field for edit modal -->
                <div>
                    <label for="edit-transaction-date" class="block text-sm font-medium text-gray-700 mb-1" data-key="transactionDateLabel">Ngày Giao Dịch</label>
                    <input type="datetime-local" id="edit-transaction-date-input" name="editTransactionDate" class="input-field" required />
                </div>
                <div>
                    <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1" data-key="descriptionLabel">Mô Tả</label>
                    <textarea id="edit-description-input" name="editDescription" data-key="descriptionPlaceholder" placeholder="Mô tả giao dịch" class="input-field resize-y overflow-auto" rows="3" required></textarea>
                </div>
                <!-- Hidden inputs for GPS coordinates in edit modal -->
                <input type="hidden" id="edit-latitude-input" name="editLatitude">
                <input type="hidden" id="edit-longitude-input" name="editLongitude">

                <div class="col-span-full flex flex-col sm:flex-row justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-transaction-btn" class="btn-secondary w-full sm:w-auto" data-key="cancelBtn">Hủy</button>
                    <button type="submit" class="btn-primary w-full sm:w-auto" data-key="saveChangesBtn">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="member-details-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 id="member-details-name" class="text-2xl font-semibold mb-6 text-[#006B68]"></h2>
            <div class="mb-4">
                <p class="text-lg font-medium text-gray-700" data-key="currentBalance">Số Dư Hiện Tại:</p>
                <p id="member-details-balance" class="text-3xl font-bold"></p>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-[#006B68]" data-key="relatedTransactions">Các Giao Dịch Liên Quan</h3>
            <div id="member-details-transactions-container" class="overflow-x-auto max-h-80">
                <p class="text-center text-gray-500" data-key="noRelatedTransactions">Chưa có giao dịch nào liên quan đến thành viên này.</p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-member-details-btn" class="btn-primary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-xl font-semibold mb-4 text-gray-800" data-key="confirmationTitle">Xác Nhận</h2>
            <p id="confirmation-message" class="mb-6 text-gray-700"></p>
            <div class="flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" id="cancel-confirmation-btn" class="btn-secondary w-full sm:w-auto" data-key="cancelBtn">Hủy</button>
                <button type="button" id="confirm-action-btn" class="btn-primary w-full sm:w-auto" data-key="confirmBtn">Xác Nhận</button>
            </div>
        </div>
    </div>

    <div id="report-selection-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2 lg:w-1/3">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68] text-center" data-key="selectReportTypeTitle">Chọn Loại Báo Cáo</h2>
            <div class="flex flex-col gap-4">
                <button id="select-fund-report-btn" class="btn-primary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                    <span data-key="fundReportOption">Báo Cáo Quỹ Chung</span>
                </button>
                <button id="select-member-report-btn" class="btn-primary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a4 4 0 00-4 4h8a4 4 0 00-4-4z" clip-rule="evenodd"></path></svg>
                    <span data-key="memberReportOption">Báo Cáo Từng Thành Viên</span>
                </button>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-report-selection-btn" class="btn-secondary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="fund-insights-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="fundInsightsModalTitle">Thông Tin Chi Tiết Quỹ ✨</h2>
            <div id="fund-insights-content">
                </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-insights-btn" class="btn-primary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="food-suggestion-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-2xl font-semibold mb-6 text-[#006B68]" data-key="foodSuggestionModalTitle">Gợi Ý Món Ăn ✨</h2>
            <div id="food-suggestion-content">
                </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-food-suggestion-btn" class="btn-primary" data-key="closeBtn">Đóng</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-4 text-[#006B68]" data-key="aiDescriptionModalTitle">Mô tả giao dịch bằng AI</h2>
            <input type="file" id="image-upload-input" accept="image/*" class="hidden">
            <img id="uploaded-image-preview" alt="Uploaded Image" class="max-w-full h-auto rounded-md my-4 hidden">
            <div id="camera-loading-spinner" class="hidden"></div>
            <div id="camera-controls" class="flex gap-4 mt-4">
                <button id="cancel-camera-btn" class="btn-secondary flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span data-key="cancelBtn">Hủy</span>
                </button>
            </div>
        </div>
    </div>
    <button id="scroll-to-top-btn" data-key="scrollToTopBtn" title="Cuộn lên đầu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
    </button>

    <script>
        // Supabase Client Initialization
        // IMPORTANT: In the Canvas environment, leave SUPABASE_ANON_KEY empty.
        // It will be automatically provided at runtime.
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your actual Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // This should be an empty string in Canvas to use provided key

        let supabase;

        // Global state variables (mimicking React state)
        let members = [];
        let transactions = [];
        let expenseTypes = []; // New global state for expense types
        let fundBalance = 0;
        let currentErrorMessage = '';
        let selectedMemberForDetails = null;
        let transactionToDelete = null;
        let memberToDelete = null; // New global variable for member to delete
        let isGeneratingInsights = false;
        let isGeneratingFoodSuggestions = false;

        // Language state
        let currentLanguage = localStorage.getItem('lang') || 'vi'; // Default to Vietnamese

        // Translations object
        const translations = {
            'vi': {
                appTitle: 'QUẢN LÝ QUỸ NHÓM',
                fundBalanceTitle: 'Số Dư Quỹ Chung',
                unitCurrency: 'VNĐ',
                addMemberBtn: 'Thêm Thành Viên',
                addTransactionBtn: 'Thêm Giao Dịch',
                viewHistoryBtn: 'Xem Lịch Sử',
                reportBtn: 'Báo Cáo',
                aiInsightsBtn: 'AI Nhận xét Quỹ',
                foodSuggestionsBtn: 'Gợi ý món ăn',
                addMemberTitle: 'Thêm Thành Viên Mới',
                memberNamePlaceholder: 'Tên thành viên',
                addBtn: 'Thêm',
                addTransactionTitle: 'Thêm Giao Dịch Mới',
                transactionTypeLabel: 'Loại Giao Dịch',
                contributionOption: '💵 Đóng Góp',
                expenseOption: '🍺 Chi Tiêu',
                expenseTypeLabel: 'Loại Chi Tiêu', // New translation key
                selectExpenseType: 'Chọn loại chi tiêu', // New translation key
                contributingMemberLabel: 'Thành Viên Đóng Góp',
                involvedMembersLabel: 'Thành Viên Tham Gia Chi Tiêu',
                amountLabel: 'Số Tiền (VNĐ)',
                amountPlaceholder: 'Số tiền',
                transactionDateLabel: 'Ngày Giao Dịch', // New translation key
                descriptionLabel: 'Mô Tả',
                descriptionPlaceholder: 'Mô tả giao dịch',
                aiDescribeBtn: 'Mô tả AI từ Ảnh/Camera',
                recordTransactionBtn: 'Ghi Lại Giao Dịch',
                memberListTitle: 'Danh Sách Thành Viên',
                loadingMembers: 'Đang tải thành viên...',
                memberNameHeader: 'Tên Thành Viên',
                balanceHeader: 'Số Dư',
                actionHeader: 'Hành Động',
                settleUpBtn: 'Thanh Toán',
                viewDetailsBtn: 'Xem chi tiết',
                noMembers: 'Chưa có thành viên nào. Hãy thêm thành viên!',
                summaryReportTitle: 'Báo Cáo Tóm Tắt',
                totalContributions: 'Tổng Đóng Góp',
                totalExpenses: 'Tổng Chi Tiêu',
                memberBalanceChartTitle: 'Số Dư Thành Viên (Biểu Đồ Tròn)',
                loadingChart: 'Đang tải biểu đồ...',
                categoryChartsTitle: 'Thu/Chi Theo Phân Loại (Biểu Đồ Bánh)',
                incomeByCategory: 'Thu nhập theo loại',
                expenseByCategory: 'Chi tiêu theo loại',
                fundReportTitle: 'Báo Cáo Quỹ Chung',
                exportExcelBtn: 'Xuất Excel',
                exportWordBtn: 'Xuất Word',
                noTransactionsReport: 'Chưa có giao dịch nào để báo cáo.',
                dateHeader: 'Ngày',
                typeHeader: 'Loại',
                descriptionHeader: 'Mô Tả',
                expenseTypeHeader: 'Loại Chi Tiêu', // New translation key
                relatedMembersHeader: 'Thành Viên Liên Quan',
                amountHeader: 'Số Tiền (VNĐ)',
                memberReportsTitle: 'Báo Cáo Từng Thành Viên',
                selectMemberReportLabel: 'Chọn Thành Viên:',
                selectMemberToReport: 'Vui lòng chọn một thành viên để xem báo cáo.',
                noMemberTransactions: 'Thành viên này chưa có giao dịch nào.',
                transactionHistoryTitle: 'Lịch Sử Giao Dịch',
                loadingTransactions: 'Đang tải giao dịch...',
                noTransactions: 'Chưa có giao dịch nào.',
                editBtn: 'Sửa',
                deleteBtn: 'Xóa',
                editTransactionModalTitle: 'Chỉnh Sửa Giao Dịch',
                cancelBtn: 'Hủy',
                saveChangesBtn: 'Lưu Thay Đổi',
                memberDetailsModalTitle: 'Chi Tiết Thành Viên:',
                currentBalance: 'Số Dư Hiện Tại:',
                relatedTransactions: 'Các Giao Dịch Liên Quan',
                noRelatedTransactions: 'Chưa có giao dịch nào liên quan đến thành viên này.',
                closeBtn: 'Đóng',
                confirmationTitle: 'Xác Nhận',
                confirmBtn: 'Xác Nhận',
                selectReportTypeTitle: 'Chọn Loại Báo Cáo',
                fundReportOption: 'Báo Cáo Quỹ Chung',
                memberReportOption: 'Báo Cáo Từng Thành Viên',
                fundInsightsModalTitle: 'Thông Tin Chi Tiết Quỹ ✨',
                generatingInsights: 'Đang tạo thông tin chi tiết từ AI...',
                noInsights: 'Không thể tạo thông tin chi tiết. Vui lòng thử lại.',
                aiConnectionError: 'Đã xảy ra lỗi khi kết nối với AI. Vui lòng thử lại.',
                foodSuggestionModalTitle: 'Gợi Ý Món Ăn ✨',
                generatingFoodSuggestions: 'Đang tìm kiếm gợi ý món ăn gần bạn...',
                locationError: 'Không thể lấy vị trí hiện tại của bạn. Vui lòng cho phép truy cập vị trí.',
                permissionDenied: 'Bạn đã từ chối quyền truy cập vị trí. Vui lòng cho phép trong cài đặt trình duyệt để nhận gợi ý món ăn.',
                positionUnavailable: 'Thông tin vị trí không khả dụng.',
                timeout: 'Hết thời gian chờ khi cố gắng lấy vị trí.',
                geolocationNotSupported: 'Trình duyệt của bạn không hỗ trợ tính năng định vị địa lý.',
                noFoodSuggestions: 'Không tìm thấy gợi ý món ăn nào.',
                foodSuggestionError: 'Không thể tạo gợi ý món ăn. Vui lòng thử lại.',
                addressLabel: 'Địa chỉ:',
                phoneLabel: 'Điện thoại:',
                ratingLabel: 'Đánh giá:',
                distanceLabel: 'Khoảng cách:',
                descriptionLabelShort: 'Mô tả:',
                menuLabel: 'Menu:',
                viewOnMaps: 'Xem trên Google Maps',
                aiDescriptionModalTitle: 'Mô tả giao dịch bằng AI',
                supaLoadError: 'Lỗi: Thư viện Supabase chưa được tải. Vui lòng kiểm tra kết nối mạng.',
                supabaseConfigWarning: 'Cảnh báo: URL hoặc Khóa Supabase vẫn là giá trị mặc định. Vui lòng thay thế bằng thông tin dự án thực của bạn.',
                supabaseTableError: 'Lỗi: Các bảng dữ liệu (members, transactions, expensetype) chưa được tạo trong Supabase. Vui lòng chạy các script SQL đã cung cấp trước đó.', // Updated
                dataLoadError: 'Lỗi khi tải dữ liệu:',
                emptyMemberName: 'Tên thành viên không được để trống.',
                addMemberError: 'Lỗi khi thêm thành viên:',
                settleUpError: 'Lỗi khi thanh toán số dư:',
                invalidAmountDesc: 'Vui lòng nhập số tiền hợp lệ và mô tả.',
                selectContributingMember: 'Vui lòng chọn thành viên đóng góp.',
                selectInvolvedMembers: 'Vui lòng chọn ít nhất một thành viên tham gia chi tiêu.',
                addTransactionError: 'Lỗi khi thêm giao dịch:',
                editInvalidAmountDesc: 'Vui lòng nhập số tiền hợp lệ và mô tả cho giao dịch.',
                editSelectContributingMember: 'Vui lòng chọn thành viên đóng góp cho giao dịch này.',
                editSelectInvolvedMembers: 'Vui lòng chọn ít nhất một thành viên tham gia chi tiêu cho giao dịch này.',
                editTransactionError: 'Lỗi khi sửa giao dịch:',
                confirmDeleteTransaction: 'Bạn có chắc chắn muốn xóa giao dịch "{description}" này không?',
                deleteTransactionError: 'Lỗi khi xóa giao dịch:',
                noBalanceChart: 'Chưa có số dư nào để hiển thị biểu đồ.',
                noCategoryChart: 'Chưa có {type} để hiển thị biểu đồ.',
                chartLegend: 'Chú Thích:',
                chartLegendFor: 'Chú Thích {title}:',
                xlsxLoadError: 'Thư viện XLSX chưa được tải. Vui lòng thử lại sau.',
                selectMemberForExport: 'Vui lòng chọn một thành viên để xuất báo cáo.',
                fileSaverLoadError: 'Thư viện FileSaver.js chưa được tải. Vui lòng thử lại sau.',
                selectMemberForWordExport: 'Vui lòng chọn một thành viên để xuất báo cáo Word.',
                apiError: 'Lỗi API:',
                noImageDescription: 'Không thể lấy mô tả hình ảnh từ AI. Vui lòng thử lại.',
                aiCallError: 'Lỗi khi gọi AI:',
                scrollToTopBtn: ' ↑',
                allMembers: 'Tất cả',
                contributionType: 'Đóng Góp',
                expenseType: 'Chi Tiêu',
                otherCategory: 'Khác',
                totalChart: 'Tổng:',
                deleteMemberBtn: 'Xóa', // New translation key
                confirmDeleteMember: 'Bạn có chắc chắn muốn xóa thành viên "{memberName}" này không? Mọi giao dịch liên quan sẽ bị xóa.', // New translation key
                deleteMemberError: 'Lỗi khi xóa thành viên:', // New translation key
                memberBalanceNotZero: 'Không thể xóa thành viên có số dư khác 0. Vui lòng thanh toán số dư trước.', // New translation key
                defaultExpenseTypes: 'Ăn uống, Đi lại, Mua sắm, Giải trí, Y tế, Giáo dục, Khác', // New translation for default expense types
            },
            'en': {
                appTitle: 'GROUP FUND MANAGEMENT',
                fundBalanceTitle: 'Overall Fund Balance',
                unitCurrency: 'VND',
                addMemberBtn: 'Add Member',
                addTransactionBtn: 'Add Transaction',
                viewHistoryBtn: 'View History',
                reportBtn: 'Reports',
                aiInsightsBtn: 'AI Fund Insights',
                foodSuggestionsBtn: 'Food Suggestions',
                addMemberTitle: 'Add New Member',
                memberNamePlaceholder: 'Member Name',
                addBtn: 'Add',
                addTransactionTitle: 'Add New Transaction',
                transactionTypeLabel: 'Transaction Type',
                contributionOption: '💵 Contribution',
                expenseOption: '🍺 Expense',
                expenseTypeLabel: 'Expense Type', // New translation key
                selectExpenseType: 'Select expense type', // New translation key
                contributingMemberLabel: 'Contributing Member',
                involvedMembersLabel: 'Involved Members (Expense)',
                amountLabel: 'Amount (VND)',
                amountPlaceholder: 'Amount',
                transactionDateLabel: 'Transaction Date', // New translation key
                descriptionLabel: 'Description',
                descriptionPlaceholder: 'Transaction description',
                aiDescribeBtn: 'AI Describe from Image/Camera',
                recordTransactionBtn: 'Record Transaction',
                memberListTitle: 'Member List',
                loadingMembers: 'Loading members...',
                memberNameHeader: 'Member Name',
                balanceHeader: 'Balance',
                actionHeader: 'Action',
                settleUpBtn: 'Settle Up',
                viewDetailsBtn: 'View Details',
                noMembers: 'No members yet. Please add members!',
                summaryReportTitle: 'Summary Report',
                totalContributions: 'Total Contributions',
                totalExpenses: 'Total Expenses',
                memberBalanceChartTitle: 'Member Balance (Pie Chart)',
                loadingChart: 'Loading chart...',
                categoryChartsTitle: 'Income/Expense by Category (Pie Charts)',
                incomeByCategory: 'Income by Category',
                expenseByCategory: 'Expense by Category',
                fundReportTitle: 'Overall Fund Report',
                exportExcelBtn: 'Export Excel',
                exportWordBtn: 'Export Word',
                noTransactionsReport: 'No transactions to report.',
                dateHeader: 'Date',
                typeHeader: 'Type',
                descriptionHeader: 'Description',
                expenseTypeHeader: 'Expense Type', // New translation key
                relatedMembersHeader: 'Related Members',
                amountHeader: 'Amount (VND)',
                memberReportsTitle: 'Individual Member Reports',
                selectMemberReportLabel: 'Select Member:',
                selectMemberToReport: 'Please select a member to view the report.',
                noMemberTransactions: 'This member has no transactions.',
                transactionHistoryTitle: 'Transaction History',
                loadingTransactions: 'Loading transactions...',
                noTransactions: 'No transactions.',
                editBtn: 'Edit',
                deleteBtn: 'Delete',
                editTransactionModalTitle: 'Edit Transaction',
                cancelBtn: 'Cancel',
                saveChangesBtn: 'Save Changes',
                memberDetailsModalTitle: 'Member Details:',
                currentBalance: 'Current Balance:',
                relatedTransactions: 'Related Transactions',
                noRelatedTransactions: 'No transactions related to this member.',
                closeBtn: 'Close',
                confirmationTitle: 'Confirmation',
                confirmBtn: 'Confirm',
                selectReportTypeTitle: 'Select Report Type',
                fundReportOption: 'Overall Fund Report',
                memberReportOption: 'Individual Member Report',
                fundInsightsModalTitle: 'Fund Insights ✨',
                generatingInsights: 'Generating AI insights...',
                noInsights: 'Could not generate insights. Please try again.',
                aiConnectionError: 'An error occurred connecting to AI. Please try again.',
                foodSuggestionModalTitle: 'Food Suggestions ✨',
                generatingFoodSuggestions: 'Searching for food suggestions near you...',
                locationError: 'Could not retrieve your current location. Please allow location access.',
                permissionDenied: 'You denied location access. Please allow in browser settings to get food suggestions.',
                positionUnavailable: 'Location information is unavailable.',
                timeout: 'The request to get user location timed out.',
                geolocationNotSupported: 'Your browser does not support geolocation.',
                noFoodSuggestions: 'No food suggestions found.',
                foodSuggestionError: 'Could not generate food suggestions. Please try again.',
                addressLabel: 'Address:',
                phoneLabel: 'Phone:',
                ratingLabel: 'Rating:',
                distanceLabel: 'Distance:',
                descriptionLabelShort: 'Description:',
                menuLabel: 'Menu:',
                viewOnMaps: 'View on Google Maps',
                aiDescriptionModalTitle: 'AI Transaction Description',
                supaLoadError: 'Error: Supabase library not loaded. Please check network connection.',
                supabaseConfigWarning: 'Warning: Supabase URL or Key still default. Please replace with your actual project info.',
                supabaseTableError: 'Error: Data tables (members, transactions, expensetype) not created in Supabase. Please run the provided SQL scripts.', // Updated
                dataLoadError: 'Error loading data:',
                emptyMemberName: 'Member name cannot be empty.',
                addMemberError: 'Error adding member:',
                settleUpError: 'Error settling up member balance:',
                invalidAmountDesc: 'Please enter a valid amount and description.',
                selectContributingMember: 'Please select a contributing member.',
                selectInvolvedMembers: 'Please select at least one member involved in the expense.',
                addTransactionError: 'Error adding transaction:',
                editInvalidAmountDesc: 'Please enter a valid amount and description for the transaction.',
                editSelectContributingMember: 'Please select a contributing member for this transaction.',
                editSelectInvolvedMembers: 'Please select at least one member involved in this expense.',
                editTransactionError: 'Error editing transaction:',
                confirmDeleteTransaction: 'Are you sure you want to delete transaction "{description}"?',
                deleteTransactionError: 'Error deleting transaction:',
                noBalanceChart: 'No balance data to display chart.',
                noCategoryChart: 'No {type} to display chart.',
                chartLegend: 'Legend:',
                chartLegendFor: 'Legend {title}:',
                xlsxLoadError: 'XLSX library not loaded. Please try again later.',
                selectMemberForExport: 'Please select a member to export the report.',
                fileSaverLoadError: 'FileSaver.js library not loaded. Please try again later.',
                selectMemberForWordExport: 'Please select a member to export the Word report.',
                apiError: 'API Error:',
                noImageDescription: 'Could not get image description from AI. Please try again.',
                aiCallError: 'Error calling AI:',
                scrollToTopBtn: ' ↑',
                allMembers: 'All',
                contributionType: 'Contribution',
                expenseType: 'Expense',
                otherCategory: 'Other',
                totalChart: 'Total:',
                deleteMemberBtn: 'Delete', // New translation key
                confirmDeleteMember: 'Are you sure you want to delete member "{memberName}"? All related transactions will be deleted.', // New translation key
                deleteMemberError: 'Error deleting member:', // New translation key
                memberBalanceNotZero: 'Cannot delete member with non-zero balance. Please settle up the balance first.', // New translation key
                defaultExpenseTypes: 'Food, Transport, Shopping, Entertainment, Health, Education, Other', // New translation for default expense types
            }
        };

        // DOM Elements
        const fundBalanceDisplay = document.getElementById('fund-balance-display');
        const errorMessageDisplay = document.getElementById('error-message-display');
        const addMemberSection = document.getElementById('add-member-section');
        const addTransactionSection = document.getElementById('add-transaction-section');
        const transactionsSection = document.getElementById('transactions-section');
        const fundReportSection = document.getElementById('fund-report-section');
        const memberReportsSection = document.getElementById('member-reports-section');
        const memberListContainer = document.getElementById('member-list-container');
        const transactionListContainer = document.getElementById('transaction-list-container');
        const totalContributionsDisplay = document.getElementById('total-contributions-display');
        const totalExpensesDisplay = document.getElementById('total-expenses-display');
        const memberBalancePieChartDiv = document.getElementById('member-balance-pie-chart');
        const categoryPieChartsDiv = document.getElementById('category-pie-charts');

        // Language switch buttons
        const langViBtn = document.getElementById('lang-vi-btn');
        const langEnBtn = document.getElementById('lang-en-btn');

        // Modals
        const editTransactionModal = document.getElementById('edit-transaction-modal');
        const memberDetailsModal = document.getElementById('member-details-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const reportSelectionModal = document.getElementById('report-selection-modal');
        const fundInsightsModal = document.getElementById('fund-insights-modal');
        const fundInsightsContent = document.getElementById('fund-insights-content');
        const foodSuggestionModal = document.getElementById('food-suggestion-modal');
        const foodSuggestionContent = document.getElementById('food-suggestion-content');
        const cameraModal = document.getElementById('camera-modal');

        // Forms and Inputs
        const addMemberForm = document.getElementById('add-member-form');
        const memberNameInput = document.getElementById('member-name-input');
        const addTransactionForm = document.getElementById('add-transaction-form');
        const transactionTypeSelect = document.getElementById('transaction-type');
        const expenseTypeDiv = document.getElementById('expense-type-div'); // New
        const expenseTypeSelect = document.getElementById('expense-type-select'); // New
        const contributingMemberDiv = document.getElementById('contributing-member-div');
        const memberSelect = document.getElementById('member-select');
        const involvedMembersDiv = document.getElementById('involved-members-div');
        const involvedMembersCheckboxes = document.getElementById('involved-members-checkboxes');
        const amountInput = document.getElementById('amount-input');
        const transactionDateInput = document.getElementById('transaction-date-input'); // New: Date input
        const descriptionInput = document.getElementById('description-input');
        const latitudeInput = document.getElementById('latitude-input'); // New: Latitude input
        const longitudeInput = document.getElementById('longitude-input'); // New: Longitude input
        const aiDescribeBtn = document.getElementById('ai-describe-btn');

        // Camera/Image Upload Elements
        const imageUploadInput = document.getElementById('image-upload-input');
        const uploadedImagePreview = document.getElementById('uploaded-image-preview');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const cameraLoadingSpinner = document.getElementById('camera-loading-spinner');

        // Edit Transaction Form Elements
        let editingTransaction = null;
        const editTransactionForm = document.getElementById('edit-transaction-form');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editExpenseTypeDiv = document.getElementById('edit-expense-type-div'); // New
        const editExpenseTypeSelect = document.getElementById('edit-expense-type-select'); // New
        const editContributingMemberDiv = document.getElementById('edit-contributing-member-div');
        const editMemberSelect = document.getElementById('edit-member-select');
        const editInvolvedMembersDiv = document.getElementById('edit-involved-members-div');
        const editInvolvedMembersCheckboxes = document.getElementById('edit-involved-members-checkboxes');
        const editAmountInput = document.getElementById('edit-amount-input');
        const editTransactionDateInput = document.getElementById('edit-transaction-date-input'); // New: Edit date input
        const editDescriptionInput = document.getElementById('edit-description-input');
        const editLatitudeInput = document.getElementById('edit-latitude-input'); // New: Edit latitude input
        const editLongitudeInput = document.getElementById('edit-longitude-input'); // New: Edit longitude input
        const cancelEditTransactionBtn = document.getElementById('cancel-edit-transaction-btn');

        // Member Details Modal Elements
        const memberDetailsName = document.getElementById('member-details-name');
        const memberDetailsBalance = document.getElementById('member-details-balance');
        const memberDetailsTransactionsContainer = document.getElementById('member-details-transactions-container');
        const closeMemberDetailsBtn = document.getElementById('close-member-details-btn');

        // Confirmation Modal Elements
        const confirmationMessage = document.getElementById('confirmation-message');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');

        // Report Selection Modal Elements
        const selectFundReportBtn = document.getElementById('select-fund-report-btn');
        const selectMemberReportBtn = document.getElementById('select-member-report-btn');
        const closeReportSelectionBtn = document.getElementById('close-report-selection-btn');

        // Member Report Specific Elements
        const selectMemberReportDropdown = document.getElementById('select-member-report');
        const memberReportTableContainer = document.getElementById('member-report-table-container');
        const exportMemberReportExcelBtn = document.getElementById('export-member-report-excel');
        const exportMemberReportWordBtn = document.getElementById('export-member-report-word');

        // Fund Report Specific Elements
        const fundReportTableContainer = document.getElementById('fund-report-table-container');
        const exportFundReportExcelBtn = document.getElementById('export-fund-report-excel');
        const exportFundReportWordBtn = document.getElementById('export-fund-report-word');

        // Insights Modal Elements
        const closeInsightsBtn = document.getElementById('close-insights-btn');

        // Food Suggestion Modal Elements
        const closeFoodSuggestionBtn = document.getElementById('close-food-suggestion-btn');

        // Scroll to Top Button Element
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

        // --- Language Functions ---
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('lang', lang);
            updateContent();
            updateLanguageButtons();
            // Re-render dynamic content that uses translations
            renderMemberList();
            renderTransactionList();
            renderFundReport();
            renderSelectedMemberReport();
            renderMemberBalancePieChart();
            renderCategoryPieCharts();
            // Update placeholder texts
            document.getElementById('member-name-input').placeholder = translations[currentLanguage].memberNamePlaceholder;
            document.getElementById('amount-input').placeholder = translations[currentLanguage].amountPlaceholder;
            document.getElementById('description-input').placeholder = translations[currentLanguage].descriptionPlaceholder;
            document.getElementById('edit-amount-input').placeholder = translations[currentLanguage].amountPlaceholder;
            document.getElementById('edit-description-input').placeholder = translations[currentLanguage].descriptionPlaceholder;
            document.getElementById('scroll-to-top-btn').title = translations[currentLanguage].scrollToTopBtn;
        }

        function updateContent() {
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            // Special handling for title tag
            document.title = translations[currentLanguage].appTitle;
            // Special handling for options in select elements
            document.querySelector('#transaction-type option[value="contribution"]').textContent = translations[currentLanguage].contributionOption;
            document.querySelector('#transaction-type option[value="expense"]').textContent = translations[currentLanguage].expenseOption;
            document.querySelector('#edit-transaction-type option[value="contribution"]').textContent = translations[currentLanguage].contributionOption;
            document.querySelector('#edit-transaction-type option[value="expense"]').textContent = translations[currentLanguage].expenseOption;
        }

        function updateLanguageButtons() {
            langViBtn.classList.remove('active');
            langEnBtn.classList.remove('active');
            if (currentLanguage === 'vi') {
                langViBtn.classList.add('active');
            } else {
                langEnBtn.classList.add('active');
            }
        }

        // --- Helper Functions ---

        // Formats a number with thousands separators for display
        function formatNumberForDisplay(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '';
            }
            // Round to the nearest integer (đồng)
            const roundedNum = Math.round(num);
            return roundedNum.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Parses a formatted number string back to a raw number
        function parseFormattedNumber(formattedValue) {
            // Get locale-specific thousands and decimal separators
            const locale = currentLanguage === 'vi' ? 'vi-VN' : 'en-US';
            const formatter = new Intl.NumberFormat(locale, { useGrouping: true, minimumFractionDigits: 0 });
            // Use a number that has both grouping and decimal to correctly identify separators
            // Note: For parsing back, we need to be careful with actual locale separators
            const parts = formatter.formatToParts(1000.50); 
            let thousandsSeparator = '';
            let decimalSeparator = '';

            for (const part of parts) {
                if (part.type === 'group') {
                    thousandsSeparator = part.value;
                } else if (part.type === 'decimal') {
                    decimalSeparator = part.value;
                }
            }

            // Remove thousands separators from the formatted value
            let cleanedValue = formattedValue;
            if (thousandsSeparator) { // Only replace if a thousands separator was found
                // Escape special characters in the thousands separator for regex if necessary
                const thousandsSeparatorRegex = new RegExp(thousandsSeparator.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                cleanedValue = cleanedValue.replace(thousandsSeparatorRegex, '');
            }

            // Replace the locale-specific decimal separator with a standard dot for parseFloat
            cleanedValue = cleanedValue.replace(decimalSeparator, '.');

            // Remove any remaining non-numeric characters except for the decimal point
            cleanedValue = cleanedValue.replace(/[^0-9.]/g, '');

            const parsed = parseFloat(cleanedValue);
            return isNaN(parsed) ? 0 : parsed;
        }


        // Formats a number string with thousands separators for input fields
        function formatNumberForInput(value) {
            const rawNumber = parseFormattedNumber(value);
            // Always round to integer for input display as well
            const roundedNum = Math.round(rawNumber);
            return roundedNum.toLocaleString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Displays an error message
        function showErrorMessage(message) {
            currentErrorMessage = message;
            errorMessageDisplay.textContent = message;
            errorMessageDisplay.classList.remove('hidden');
        }

        // Hides the error message
        function hideErrorMessage() {
            currentErrorMessage = '';
            errorMessageDisplay.classList.add('hidden');
        }

        // Hides all main sections and modals
        function hideAllSections() {
            addMemberSection.classList.add('hidden');
            addTransactionSection.classList.add('hidden');
            transactionsSection.classList.add('hidden');
            fundReportSection.classList.add('hidden');
            memberReportsSection.classList.add('hidden');
            editTransactionModal.classList.add('hidden');
            memberDetailsModal.classList.add('hidden');
            confirmationModal.classList.add('hidden');
            reportSelectionModal.classList.add('hidden');
            fundInsightsModal.classList.add('hidden');
            foodSuggestionModal.classList.add('hidden');
            cameraModal.classList.add('hidden');
            hideErrorMessage();
        }

        // Scrolls to a specific section on the page
        function scrollToSection(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- Supabase and Data Management ---

        // Initializes Supabase client
        function initializeSupabase() {
            if (typeof window.supabase === 'undefined') {
                showErrorMessage(translations[currentLanguage].supaLoadError);
                return;
            }
            // For Canvas environment, check if __supabase_key is available
            // If running outside Canvas, SUPABASE_ANON_KEY should be set manually
            const anonKey = typeof __supabase_key !== 'undefined' ? __supabase_key : SUPABASE_ANON_KEY;

            if (!anonKey || SUPABASE_URL === 'https://rmbsxccrwrktbjlnezpu.supabase.co1') { // Check for default URL
                 showErrorMessage(translations[currentLanguage].supabaseConfigWarning);
                 return;
            }

            supabase = window.supabase.createClient(SUPABASE_URL, anonKey);
            console.log("Supabase client initialized.");
            fetchData(); // Fetch initial data after initialization
            setupRealtimeSubscriptions(); // Set up real-time listeners
        }

        // Fetches all data from Supabase
        async function fetchData() {
            showLoading(true);
            try {
                // Fetch members
                const { data: membersData, error: membersError } = await supabase
                    .from('members')
                    .select('*');

                if (membersError) {
                    if (membersError.message.includes('relation "public.members" does not exist')) {
                        showErrorMessage(translations[currentLanguage].supabaseTableError);
                    } else {
                        showErrorMessage(`${translations[currentLanguage].dataLoadError} ${translations[currentLanguage].memberNameHeader.toLowerCase()}: ${membersError.message}`);
                    }
                    throw membersError;
                }

                // Fetch transactions
                const { data: transactionsData, error: transactionsError } = await supabase
                    .from('transactions')
                    .select('*');

                if (transactionsError) {
                    if (transactionsError.message.includes('relation "public.transactions" does not exist')) {
                        showErrorMessage(translations[currentLanguage].supabaseTableError);
                    } else {
                        showErrorMessage(`${translations[currentLanguage].dataLoadError} ${translations[currentLanguage].transactionHistoryTitle.toLowerCase()}: ${transactionsError.message}`);
                    }
                    throw transactionsError;
                }

                // Fetch expense types (New) - DO NOT AUTO-POPULATE IF EMPTY
                const { data: expenseTypesData, error: expenseTypesError } = await supabase
                    .from('expensetype')
                    .select('*');

                if (expenseTypesError) {
                    if (expenseTypesError.message.includes('relation "public.expensetype" does not exist')) {
                        showErrorMessage(translations[currentLanguage].supabaseTableError);
                    } else {
                        showErrorMessage(`${translations[currentLanguage].dataLoadError} ${translations[currentLanguage].expenseTypeLabel.toLowerCase()}: ${expenseTypesError.message}`);
                    }
                    throw expenseTypesError;
                }

                members = membersData;
                transactions = transactionsData;
                expenseTypes = expenseTypesData; // Store expense types

                // If no members exist, populate with default data (only members and transactions)
                if (members.length === 0) {
                    console.log("No members found, populating with default data...");
                    const initialMembers = [
                        { name: 'Trương Hồng Quân' },
                        { name: 'Bùi Hoàng Giang' },
                        { name: 'Nguyễn Thị Hoa Hậu' },
                    ];
                    const { data: newMembers, error: newMembersError } = await supabase
                        .from('members')
                        .insert(initialMembers)
                        .select();

                    if (newMembersError) throw newMembersError;
                    members = newMembers;

                    // Create initial transactions using the IDs of newly inserted members
                    // Ensure expense types used here exist in your actual expensetype table or handle "Khác"
                    const defaultExpenseType = expenseTypes.length > 0 ? expenseTypes[0].expense_type : 'Ăn uống'; // Use first type or 'Ăn uống' as a common default
                    const initialTransactions = [
                        { type: 'contribution', amount: 500000, description: 'Đóng góp ban đầu', date: new Date().toISOString(), contributingMemberId: newMembers[0].id, latitude: null, longitude: null, expense_type: null },
                        { type: 'contribution', amount: 300000, description: 'Đóng góp thêm', date: new Date().toISOString(), contributingMemberId: newMembers[1].id, latitude: null, longitude: null, expense_type: null },
                        { type: 'expense', amount: 150000, description: 'Mua đồ ăn nhẹ', date: new Date().toISOString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id], latitude: null, longitude: null, expense_type: 'Ăn uống' },
                        { type: 'contribution', amount: 200000, description: 'Đóng góp tháng 5', date: new Date().toISOString(), contributingMemberId: newMembers[2].id, latitude: null, longitude: null, expense_type: null },
                        { type: 'expense', amount: 250000, description: 'Tiền nước uống', date: new Date().toISOString(), involvedMemberIds: [newMembers[0].id, newMembers[2].id], latitude: null, longitude: null, expense_type: 'Ăn uống' },
                        { type: 'expense', amount: 300000, description: 'Đặt cơm trưa', date: new Date().toISOString(), involvedMemberIds: [newMembers[0].id, newMembers[1].id, newMembers[2].id], latitude: null, longitude: null, expense_type: 'Ăn uống' },
                    ];
                    const { data: newTransactions, error: newTransactionsError } = await supabase
                        .from('transactions')
                        .insert(initialTransactions)
                        .select();

                    if (newTransactionsError) throw newTransactionsError;
                    transactions = newTransactions;
                }

                updateUI(); // Update UI after fetching data
            } catch (error) {
                console.error("Error fetching data from Supabase:", error.message);
                // Error message already set by specific checks above, or fallback here
                if (!currentErrorMessage) {
                    showErrorMessage(`${translations[currentLanguage].dataLoadError} ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        }

        // Sets up real-time subscriptions for members and transactions
        function setupRealtimeSubscriptions() {
            supabase
                .channel('public:members')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'members' }, payload => {
                    console.log('Member change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();

            supabase
                .channel('public:transactions')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'transactions' }, payload => {
                    console.log('Transaction change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();
            
            // New: Real-time subscription for expensetype table
            supabase
                .channel('public:expensetype')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'expensetype' }, payload => {
                    console.log('Expense type change received!', payload);
                    fetchData(); // Re-fetch data on any change
                })
                .subscribe();
        }

        // Shows/hides a loading indicator
        function showLoading(isLoading) {
            const loadingDiv = document.getElementById('loading-overlay'); // Assuming a loading overlay div exists
            if (loadingDiv) {
                loadingDiv.classList.toggle('hidden', !isLoading);
            }
            // You might also disable buttons or inputs here
        }

        // --- UI Update Functions ---

        // Updates all dynamic parts of the UI
        function updateUI() {
            calculateBalances();
            renderFundBalance();
            renderMemberList();
            renderReportingSummary();
            renderTransactionList(); // Re-render transaction list if visible
            renderMemberReportDropdown(); // Update member report dropdown
            renderMemberBalancePieChart(); // Update pie chart
            renderCategoryPieCharts(); // Render the new category pie charts
            populateSelectors(); // Populate new expense type dropdowns
        }

        // Calculates fund and member balances
        function calculateBalances() {
            let totalBalance = 0;
            const tempMemberBalances = new Map(members.map(m => [m.id, 0]));

            transactions.forEach(t => {
                if (t.type === 'contribution') {
                    totalBalance += t.amount;
                    if (tempMemberBalances.has(t.contributingMemberId)) {
                        tempMemberBalances.set(t.contributingMemberId, tempMemberBalances.get(t.contributingMemberId) + t.amount);
                    }
                } else if (t.type === 'expense') {
                    totalBalance -= t.amount;
                    const involvedMembers = t.involvedMemberIds && t.involvedMemberIds.length > 0
                        ? t.involvedMemberIds
                        : members.map(m => m.id);

                    if (involvedMembers.length > 0) {
                        const costPerMember = t.amount / involvedMembers.length;
                        involvedMembers.forEach(memberId => {
                            if (tempMemberBalances.has(memberId)) {
                                tempMemberBalances.set(memberId, tempMemberBalances.get(memberId) - costPerMember);
                            }
                        });
                    }
                }
            });

            members = members.map(member => ({
                ...member,
                balance: tempMemberBalances.get(member.id) || 0
            }));
            fundBalance = totalBalance;
        }

        // Renders the overall fund balance
        function renderFundBalance() {
            fundBalanceDisplay.textContent = `${formatNumberForDisplay(fundBalance)} ${translations[currentLanguage].unitCurrency}`;
            fundBalanceDisplay.classList.remove('text-green-600', 'text-red-600');
            if (fundBalance >= 0) {
                fundBalanceDisplay.classList.add('text-green-600');
            } else {
                fundBalanceDisplay.classList.add('text-red-600');
            }
        }

        // Renders the member list table
        function renderMemberList() {
            if (members.length === 0) {
                memberListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noMembers}</p>`;
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th class="table-header">${translations[currentLanguage].memberNameHeader}</th>
                            <th class="table-header text-right-aligned">${translations[currentLanguage].balanceHeader}</th>
                            <th class="table-header">${translations[currentLanguage].actionHeader}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            members.forEach(member => {
                const balanceClass = member.balance > 0 ? 'balance-positive' :
                                     member.balance < 0 ? 'balance-negative' :
                                     'balance-zero';
                tableHtml += `
                    <tr class="table-row">
                        <td class="font-medium text-gray-900">${member.name}</td>
                        <td class="text-right-aligned">
                            <span class="text-lg font-bold ${balanceClass}">
                                ${formatNumberForDisplay(member.balance)} ${translations[currentLanguage].unitCurrency}
                            </span>
                        </td>
                        <td class="flex flex-col sm:flex-row gap-2">
                            <button data-member-id="${member.id}" class="settle-up-btn text-[#006B68] hover:text-[#005A58] font-semibold text-sm w-full sm:w-auto" ${Math.abs(member.balance) < 0.01 ? 'disabled' : ''}>
                                ${translations[currentLanguage].settleUpBtn}
                            </button>
                            <button data-member-id="${member.id}" class="view-details-btn text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto">
                                ${translations[currentLanguage].viewDetailsBtn}
                            </button>
                            <button data-member-id="${member.id}" class="delete-member-btn text-red-600 hover:text-red-900 font-semibold text-sm w-full sm:w-auto" ${Math.abs(member.balance) > 0.01 ? 'disabled' : ''}>
                                ${translations[currentLanguage].deleteBtn}
                            </button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            memberListContainer.innerHTML = tableHtml;

            // Attach event listeners for settle up, view details, and delete buttons
            memberListContainer.querySelectorAll('.settle-up-btn').forEach(button => {
                button.onclick = (e) => settleUpMember(e.target.dataset.memberId);
            });
            memberListContainer.querySelectorAll('.view-details-btn').forEach(button => {
                button.onclick = (e) => showMemberDetailsModal(members.find(m => m.id === e.target.dataset.memberId));
            });
            memberListContainer.querySelectorAll('.delete-member-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.memberId;
                    const memberToDeleteFound = members.find(m => m.id === id);
                    if (memberToDeleteFound) confirmDeleteMember(memberToDeleteFound);
                };
            });
        }

        // Renders the reporting summary (total contributions and expenses)
        function renderReportingSummary() {
            const totalContributions = transactions.filter(t => t.type === 'contribution').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            totalContributionsDisplay.textContent = `${formatNumberForDisplay(totalContributions)} ${translations[currentLanguage].unitCurrency}`;
            totalExpensesDisplay.textContent = `${formatNumberForDisplay(totalExpenses)} ${translations[currentLanguage].unitCurrency}`;
        }

        // Renders the transaction list table
        function renderTransactionList() {
            if (transactionsSection.classList.contains('hidden')) return; // Only render if visible

            if (transactions.length === 0) {
                transactionListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noTransactions}</p>`;
                return;
            }

            let tableHtml = `
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr>
                            <th>${translations[currentLanguage].dateHeader}</th>
                            <th>${translations[currentLanguage].typeHeader}</th>
                            <th>${translations[currentLanguage].descriptionHeader}</th>
                            <th>${translations[currentLanguage].expenseTypeHeader}</th> <!-- New Column -->
                            <th>${translations[currentLanguage].relatedMembersHeader}</th>
                            <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            <th>${translations[currentLanguage].actionHeader}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            transactions.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => { // Display latest first, sorted by actual date
                // For the general transaction list, always display the total amount of the expense
                const displayedAmount = t.amount;
                const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('💵 ', '') : translations[currentLanguage].expenseOption.replace('🍺 ', '');
                const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                const memberNames = t.type === 'contribution'
                    ? getMemberName(t.contributingMemberId)
                    : getInvolvedMembersNames(t.involvedMemberIds);

                const transactionDate = new Date(t.date).toLocaleDateString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                tableHtml += `
                    <tr class="table-row">
                        <td>${transactionDate}</td>
                        <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                        <td>${t.description}</td>
                        <td>${t.type === 'expense' && t.expense_type ? t.expense_type : 'N/A'}</td> <!-- Display expense type -->
                        <td>${memberNames}</td>
                        <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                        <td class="flex flex-col sm:flex-row gap-2">
                            <button data-transaction-id="${t.id}" class="edit-transaction-btn text-blue-600 hover:text-blue-900 font-semibold text-sm w-full sm:w-auto">${translations[currentLanguage].editBtn}</button>
                            <button data-transaction-id="${t.id}" class="delete-transaction-btn text-red-600 hover:text-red-900 font-semibold text-sm w-full sm:w-auto">${translations[currentLanguage].deleteBtn}</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `
                    </tbody>
                </table>
            `;
            transactionListContainer.innerHTML = tableHtml;

            // Attach event listeners for edit and delete buttons
            transactionListContainer.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.transactionId;
                    const transactionToEdit = transactions.find(t => t.id === id);
                    if (transactionToEdit) showEditTransactionModal(transactionToEdit);
                };
            });
            transactionListContainer.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.target.dataset.transactionId;
                    const transactionToDeleteFound = transactions.find(t => t.id === id);
                    if (transactionToDeleteFound) confirmDeleteTransaction(transactionToDeleteFound);
                };
            });
        }

        // Helper to get member name by ID
        function getMemberName(memberId) {
            const member = members.find(m => m.id === memberId);
            return member ? member.name : 'N/A';
        }

        // Helper to get involved members' names for expenses
        function getInvolvedMembersNames(involvedMemberIds) {
            if (!involvedMemberIds || involvedMemberIds.length === 0) {
                return translations[currentLanguage].allMembers;
            }
            return involvedMemberIds.map(id => getMemberName(id)).join(', ');
        }

        // --- Member Actions ---

        // Handles adding a new member
        addMemberForm.onsubmit = async (e) => {
            e.preventDefault();
            const name = memberNameInput.value.trim();
            if (!name) {
                showErrorMessage(translations[currentLanguage].emptyMemberName);
                return;
            }
            hideErrorMessage();
            try {
                const { data, error } = await supabase
                    .from('members')
                    .insert({ name: name, balance: 0 });
                if (error) throw error;
                memberNameInput.value = ''; // Clear input
                addMemberSection.classList.add('hidden'); // Hide form
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error adding member:", error.message);
                showErrorMessage(`${translations[currentLanguage].addMemberError} ${error.message}`);
            }
        };

        // Handles settling up a member's balance
        async function settleUpMember(memberId) {
            const memberToSettle = members.find(m => m.id === memberId);
            if (!memberToSettle || Math.abs(memberToSettle.balance) < 0.01) return; // Use a small epsilon for zero check

            const settlementAmount = Math.abs(memberToSettle.balance);
            const settlementType = memberToSettle.balance < 0 ? 'contribution' : 'expense';
            const description = `${translations[currentLanguage].settleUpBtn} ${memberToSettle.name}`;

            try {
                const newTransaction = {
                    type: settlementType,
                    amount: settlementAmount,
                    description: description,
                    date: new Date().toISOString(), // Use ISO string for consistency
                    contributingMemberId: settlementType === 'contribution' ? memberToSettle.id : null,
                    involvedMemberIds: settlementType === 'expense' ? [memberToSettle.id] : [],
                    latitude: null, // Default to null for settlement transactions
                    longitude: null, // Default to null for settlement transactions
                    expense_type: settlementType === 'expense' ? translations[currentLanguage].otherCategory : null, // Default for settlement expense
                };
                const { data, error } = await supabase
                    .from('transactions')
                    .insert(newTransaction);
                if (error) throw error;
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error settling up member:", error.message);
                showErrorMessage(`${translations[currentLanguage].settleUpError} ${error.message}`);
            }
        };

        // Shows confirmation modal for deleting a member
        function confirmDeleteMember(member) {
            // Check if balance is effectively zero (within a small tolerance)
            if (Math.abs(member.balance) > 0.01) {
                showErrorMessage(translations[currentLanguage].memberBalanceNotZero);
                return;
            }
            memberToDelete = member;
            const message = translations[currentLanguage].confirmDeleteMember.replace('{memberName}', member.name);
            confirmationMessage.textContent = message;
            confirmationModal.classList.remove('hidden');
            // Change confirm action to delete member
            confirmActionBtn.onclick = deleteMemberConfirmed;
        }

        // Handles deletion of member after confirmation
        async function deleteMemberConfirmed() {
            if (memberToDelete) {
                try {
                    console.log(`Attempting to delete transactions for member: ${memberToDelete.name} (ID: ${memberToDelete.id})`);
                    // Delete all transactions related to this member first
                    const { error: transactionsError } = await supabase
                        .from('transactions')
                        .delete()
                        .or(`contributingMemberId.eq.${memberToDelete.id},involvedMemberIds.cs.{${memberToDelete.id}}`); // Delete if contributing or involved

                    if (transactionsError) {
                        console.error("Error deleting related transactions:", transactionsError.message);
                        throw transactionsError;
                    }
                    console.log(`Transactions for member ${memberToDelete.name} deleted successfully.`);

                    // Then delete the member
                    console.log(`Attempting to delete member: ${memberToDelete.name} (ID: ${memberToDelete.id})`);
                    const { error: memberError } = await supabase
                        .from('members')
                        .delete()
                        .eq('id', memberToDelete.id);

                    if (memberError) {
                        console.error("Error deleting member:", memberError.message);
                        throw memberError;
                    }
                    console.log(`Member ${memberToDelete.name} deleted successfully.`);

                    fetchData(); // Re-fetch data to update UI
                } catch (error) {
                    console.error("Error during member deletion process:", error.message);
                    showErrorMessage(`${translations[currentLanguage].deleteMemberError} ${error.message}`);
                }
            }
            confirmationModal.classList.add('hidden');
            memberToDelete = null;
            // Reset confirm action to delete transaction (default)
            confirmActionBtn.onclick = deleteTransactionConfirmed; // Ensure this is reset
        }

        // --- Transaction Actions ---

        // Handles adding a new transaction
        addTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            const submitButton = e.submitter; // Get the button that triggered the submit
            if (submitButton) {
                submitButton.disabled = true; // Disable the button immediately
                submitButton.textContent = 'Đang lưu...'; // Optional: show loading text
            }

            const type = transactionTypeSelect.value;
            const amount = parseFormattedNumber(amountInput.value); // Use the new parseFormattedNumber
            const transactionDate = transactionDateInput.value; // Get the date from the input
            const description = descriptionInput.value.trim();
            const contributingMemberId = memberSelect.value;
            const selectedExpenseMembers = Array.from(involvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);
            const latitude = latitudeInput.value ? parseFloat(latitudeInput.value) : null;
            const longitude = longitudeInput.value ? parseFloat(longitudeInput.value) : null;
            const expenseType = expenseTypeSelect.value; // New: Get expense type

            if (isNaN(amount) || amount <= 0 || !description || !transactionDate) {
                showErrorMessage(translations[currentLanguage].invalidAmountDesc);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn;
                }
                return;
            }
            if (type === 'contribution' && !contributingMemberId) {
                showErrorMessage(translations[currentLanguage].selectContributingMember);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn;
                }
                return;
            }
            if (type === 'expense' && selectedExpenseMembers.length === 0) {
                showErrorMessage(translations[currentLanguage].selectInvolvedMembers);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn;
                }
                return;
            }
            if (type === 'expense' && !expenseType) { // New validation for expense type
                showErrorMessage(translations[currentLanguage].selectExpenseType);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn;
                }
                return;
            }

            hideErrorMessage();

            try {
                const newTransaction = {
                    type: type,
                    amount: amount,
                    description: description,
                    date: new Date(transactionDate).toISOString(), // Convert to ISO string for Supabase
                    contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                    involvedMemberIds: type === 'expense' ? selectedExpenseMembers : [],
                    latitude: latitude,
                    longitude: longitude,
                    expense_type: type === 'expense' ? expenseType : null, // New: Save expense type
                };
                const { data, error } = await supabase
                    .from('transactions')
                    .insert(newTransaction);
                if (error) throw error;
                amountInput.value = '';
                descriptionInput.value = '';
                // Reset member selection for expense if it was an expense
                involvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                addTransactionSection.classList.add('hidden'); // Hide form
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error adding transaction:", error.message);
                showErrorMessage(`${translations[currentLanguage].addTransactionError} ${error.message}`);
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].recordTransactionBtn; // Reset button text
                }
            }
        };

        // Populates the member dropdowns and checkboxes for transaction forms (and expense types)
        function populateSelectors() {
            // For Add Transaction Form - Members
            memberSelect.innerHTML = '';
            involvedMembersCheckboxes.innerHTML = '';

            if (members.length === 0) {
                memberSelect.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                involvedMembersCheckboxes.innerHTML = `<p class="text-gray-500 text-sm">${translations[currentLanguage].noMembers}</p>`;
            } else {
                members.forEach(member => {
                    // For dropdown (contributing member)
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    memberSelect.appendChild(option);

                    // For checkboxes (involved members)
                    const label = document.createElement('label');
                    label.className = 'inline-flex items-center cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]" value="${member.id}">
                        <span class="ml-2 text-sm text-gray-700">${member.name}</span>
                    `;
                    involvedMembersCheckboxes.appendChild(label);
                });
                // Set default selected member for contribution if available
                if (members.length > 0) {
                    memberSelect.value = members[0].id;
                }
            }

            // For Add Transaction Form - Expense Types (New)
            expenseTypeSelect.innerHTML = '';
            if (expenseTypes.length === 0) {
                expenseTypeSelect.innerHTML = `<option value="">${translations[currentLanguage].selectExpenseType} (${translations[currentLanguage].noCategoriesAvailable})</option>`;
            } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = translations[currentLanguage].selectExpenseType;
                expenseTypeSelect.appendChild(defaultOption);

                expenseTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.expense_type;
                    option.textContent = type.expense_type;
                    expenseTypeSelect.appendChild(option);
                });
                // Set the default selected expense type if there are entries
                if (expenseTypes.length > 0) {
                    expenseTypeSelect.value = expenseTypes[0].expense_type;
                }
            }

            // For Edit Transaction Form - Members (similar logic for edit modal)
            editMemberSelect.innerHTML = '';
            editInvolvedMembersCheckboxes.innerHTML = '';

            if (members.length === 0) {
                editMemberSelect.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                editInvolvedMembersCheckboxes.innerHTML = `<p class="text-gray-500 text-sm">${translations[currentLanguage].noMembers}</p>`;
            } else {
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    editMemberSelect.appendChild(option);

                    const label = document.createElement('label');
                    label.className = 'inline-flex items-center cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-[#006B68] transition duration-150 ease-in-out rounded focus:ring-[#006B68]" value="${member.id}">
                        <span class="ml-2 text-sm text-gray-700">${member.name}</span>
                    `;
                    editInvolvedMembersCheckboxes.appendChild(label);
                });
            }

            // For Edit Transaction Form - Expense Types (New)
            editExpenseTypeSelect.innerHTML = '';
            if (expenseTypes.length === 0) {
                editExpenseTypeSelect.innerHTML = `<option value="">${translations[currentLanguage].selectExpenseType} (${translations[currentLanguage].noCategoriesAvailable})</option>`;
            } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = translations[currentLanguage].selectExpenseType;
                editExpenseTypeSelect.appendChild(defaultOption);

                expenseTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.expense_type;
                    option.textContent = type.expense_type;
                    editExpenseTypeSelect.appendChild(option);
                });
            }
        }

        // Toggles visibility and required attributes of contributing/involved member fields and expense type field based on transaction type
        transactionTypeSelect.onchange = () => {
            if (transactionTypeSelect.value === 'contribution') {
                contributingMemberDiv.classList.remove('hidden');
                memberSelect.setAttribute('required', 'true'); // Make contributing member required
                involvedMembersDiv.classList.add('hidden');
                involvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false; // Clear selected expense members
                    checkbox.removeAttribute('required'); // Remove required from expense members
                });
                expenseTypeDiv.classList.add('hidden'); // Hide expense type for contribution
                expenseTypeSelect.removeAttribute('required'); // Remove required from expense type
                expenseTypeSelect.value = ''; // Clear expense type
            } else { // Expense
                contributingMemberDiv.classList.add('hidden');
                memberSelect.removeAttribute('required'); // Remove required from contributing member
                memberSelect.value = ''; // Clear contributing member
                involvedMembersDiv.classList.remove('hidden');
                // For expense, at least one checkbox should be implicitly required by validation logic
                // No need to set 'required' on individual checkboxes, as the form submission logic handles it.
                expenseTypeDiv.classList.remove('hidden'); // Show expense type for expense
                expenseTypeSelect.setAttribute('required', 'true'); // Make expense type required
                // Ensure expense type is populated if not already, and select a default if available
                if (expenseTypeSelect.value === '' && expenseTypes.length > 0) {
                    expenseTypeSelect.value = expenseTypes[0].expense_type;
                }
            }
        };

        // Shows the edit transaction modal
        function showEditTransactionModal(transaction) {
            editingTransaction = transaction; // Store the transaction globally
            editTransactionModal.classList.remove('hidden');
            hideErrorMessage();

            // Populate form fields
            editTransactionTypeSelect.value = transaction.type;
            editAmountInput.value = formatNumberForInput(transaction.amount.toString());
            // Format the date for datetime-local input
            const transactionDate = new Date(transaction.date);
            const year = transactionDate.getFullYear();
            const month = (transactionDate.getMonth() + 1).toString().padStart(2, '0');
            const day = transactionDate.getDate().toString().padStart(2, '0');
            const hours = transactionDate.getHours().toString().padStart(2, '0');
            const minutes = transactionDate.getMinutes().toString().padStart(2, '0');
            editTransactionDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;

            editDescriptionInput.value = transaction.description;
            editLatitudeInput.value = transaction.latitude || '';
            editLongitudeInput.value = transaction.longitude || '';
            
            // Set initial selection based on transaction type and manage required attributes
            if (transaction.type === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.removeAttribute('required');
                });
                editMemberSelect.value = transaction.contributingMemberId || '';
                editExpenseTypeDiv.classList.add('hidden'); // Hide expense type for contribution
                editExpenseTypeSelect.removeAttribute('required'); // Remove required from expense type
                editExpenseTypeSelect.value = ''; // Clear expense type
            } else { // Expense
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                // Clear all checkboxes first
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                // Then check the ones involved in this transaction
                if (transaction.involvedMemberIds) {
                    transaction.involvedMemberIds.forEach(id => {
                        const checkbox = editInvolvedMembersCheckboxes.querySelector(`input[value="${id}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                editExpenseTypeDiv.classList.remove('hidden'); // Show expense type for expense
                editExpenseTypeSelect.setAttribute('required', 'true'); // Make expense type required
                editExpenseTypeSelect.value = transaction.expense_type || ''; // Set expense type (New)
            }
        }

        // Toggles visibility and required attributes of contributing/involved member fields in edit modal
        editTransactionTypeSelect.onchange = () => {
            if (editTransactionTypeSelect.value === 'contribution') {
                editContributingMemberDiv.classList.remove('hidden');
                editMemberSelect.setAttribute('required', 'true');
                editInvolvedMembersDiv.classList.add('hidden');
                editInvolvedMembersCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.removeAttribute('required');
                });
                editExpenseTypeDiv.classList.add('hidden'); // Hide expense type for contribution
                editExpenseTypeSelect.removeAttribute('required'); // Remove required from expense type
                editExpenseTypeSelect.value = ''; // Clear expense type
            } else { // Expense
                editContributingMemberDiv.classList.add('hidden');
                editMemberSelect.removeAttribute('required');
                editMemberSelect.value = '';
                editInvolvedMembersDiv.classList.remove('hidden');
                // For expense, at least one checkbox should be implicitly required by validation logic
                editExpenseTypeDiv.classList.remove('hidden'); // Show expense type for expense
                editExpenseTypeSelect.setAttribute('required', 'true'); // Make expense type required
                 // Ensure expense type is populated if not already, and select a default if available
                if (editExpenseTypeSelect.value === '' && expenseTypes.length > 0) {
                    editExpenseTypeSelect.value = expenseTypes[0].expense_type;
                }
            }
        };

        // Handles saving edited transaction
        editTransactionForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!editingTransaction) return;

            const submitButton = e.submitter; // Get the button that triggered the submit
            if (submitButton) {
                submitButton.disabled = true; // Disable the button immediately
                submitButton.textContent = 'Đang lưu...'; // Optional: show loading text
            }

            const type = editTransactionTypeSelect.value;
            const amount = parseFormattedNumber(editAmountInput.value); // Use the new parseFormattedNumber
            const transactionDate = editTransactionDateInput.value; // Get the date from the input
            const description = editDescriptionInput.value.trim();
            const contributingMemberId = editMemberSelect.value;
            const involvedMemberIds = Array.from(editInvolvedMembersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);
            const latitude = editLatitudeInput.value ? parseFloat(editLatitudeInput.value) : null;
            const longitude = editLongitudeInput.value ? parseFloat(editLongitudeInput.value) : null;
            const expenseType = editExpenseTypeSelect.value; // New: Get expense type

            if (isNaN(amount) || amount <= 0 || !description || !transactionDate) {
                showErrorMessage(translations[currentLanguage].editInvalidAmountDesc);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }
            if (type === 'contribution' && !contributingMemberId) {
                showErrorMessage(translations[currentLanguage].editSelectContributingMember);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }
            if (type === 'expense' && involvedMemberIds.length === 0) {
                showErrorMessage(translations[currentLanguage].editSelectInvolvedMembers);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }
            if (type === 'expense' && !expenseType) { // New validation for expense type
                showErrorMessage(translations[currentLanguage].selectExpenseType);
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn;
                }
                return;
            }

            hideErrorMessage();

            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .update({
                        type: type,
                        amount: amount,
                        description: description,
                        date: new Date(transactionDate).toISOString(), // Convert to ISO string for Supabase
                        contributingMemberId: type === 'contribution' ? contributingMemberId : null,
                        involvedMemberIds: type === 'expense' ? involvedMemberIds : [],
                        latitude: latitude,
                        longitude: longitude,
                        expense_type: type === 'expense' ? expenseType : null, // New: Update expense type
                    })
                    .eq('id', editingTransaction.id);
                if (error) throw error;
                editTransactionModal.classList.add('hidden');
                editingTransaction = null;
                fetchData(); // Re-fetch data to update UI
            } catch (error) {
                console.error("Error editing transaction:", error.message);
                showErrorMessage(`${translations[currentLanguage].editTransactionError} ${error.message}`);
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLanguage].saveChangesBtn; // Reset button text
                }
            }
        };

        // Shows confirmation modal for deleting a transaction
        function confirmDeleteTransaction(transaction) {
            transactionToDelete = transaction;
            const message = translations[currentLanguage].confirmDeleteTransaction.replace('{description}', transaction.description);
            confirmationMessage.textContent = message;
            confirmationModal.classList.remove('hidden');
            // Change confirm action to delete transaction
            confirmActionBtn.onclick = deleteTransactionConfirmed;
        }

        // Handles deletion of transaction after confirmation
        async function deleteTransactionConfirmed() {
            if (transactionToDelete) {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', transactionToDelete.id);
                    if (error) throw error;
                    fetchData(); // Re-fetch data to update UI
                } catch (error) {
                    console.error("Error deleting transaction:", error.message);
                    showErrorMessage(`${translations[currentLanguage].deleteTransactionError} ${error.message}`);
                }
            }
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
            // Reset confirm action to delete transaction (default)
            confirmActionBtn.onclick = deleteTransactionConfirmed; // Keep as default for transactions
        }

        // Cancels deletion (for both member and transaction)
        cancelConfirmationBtn.onclick = () => {
            confirmationModal.classList.add('hidden');
            transactionToDelete = null;
            memberToDelete = null;
            // Reset confirm action to delete transaction (default)
            confirmActionBtn.onclick = deleteTransactionConfirmed;
        };

        // --- Member Details Modal ---
        function showMemberDetailsModal(member) {
            selectedMemberForDetails = member;
            memberDetailsModal.classList.remove('hidden');
            hideErrorMessage();

            memberDetailsName.textContent = `${translations[currentLanguage].memberDetailsModalTitle} ${member.name}`;
            memberDetailsBalance.textContent = `${formatNumberForDisplay(member.balance)} ${translations[currentLanguage].unitCurrency}`;
            memberDetailsBalance.classList.remove('text-green-600', 'text-red-600');
            if (member.balance >= 0) {
                memberDetailsBalance.classList.add('text-green-600');
            } else {
                memberDetailsBalance.classList.add('text-red-600');
            }

            const memberTransactions = transactions.filter(t =>
                (t.type === 'contribution' && t.contributingMemberId === member.id) ||
                (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(member.id))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (memberTransactions.length === 0) {
                memberDetailsTransactionsContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noRelatedTransactions}</p>`;
            } else {
                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th>${translations[currentLanguage].dateHeader}</th>
                                <th>${translations[currentLanguage].typeHeader}</th>
                                <th>${translations[currentLanguage].descriptionHeader}</th>
                                <th>${translations[currentLanguage].expenseTypeHeader}</th> <!-- New Column -->
                                <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                memberTransactions.forEach(t => {
                    let displayedAmount = t.amount;
                    // For individual member details, show the per-person share of the expense
                    if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                        displayedAmount = t.amount / t.involvedMemberIds.length;
                    }
                    const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('💵 ', '') : translations[currentLanguage].expenseOption.replace('🍺 ', '');
                    const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';
                    const transactionDate = new Date(t.date).toLocaleDateString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    });

                        tableHtml += `
                            <tr class="table-row">
                                <td>${transactionDate}</td>
                                <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                                <td>${t.description}</td>
                                <td>${t.type === 'expense' && t.expense_type ? t.expense_type : 'N/A'}</td> <!-- Display expense type -->
                                <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    memberDetailsTransactionsContainer.innerHTML = tableHtml;
                }
            }

            // --- Reporting Functions ---

            // Renders the Fund Report table
            function renderFundReport() {
                if (transactions.length === 0) {
                    fundReportTableContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noTransactionsReport}</p>`;
                    return;
                }

                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th class="table-header">${translations[currentLanguage].dateHeader}</th>
                                <th class="table-header">${translations[currentLanguage].typeHeader}</th>
                                <th class="table-header">${translations[currentLanguage].descriptionHeader}</th>
                                <th class="table-header">${translations[currentLanguage].expenseTypeHeader}</th> <!-- New Column -->
                                <th class="table-header">${translations[currentLanguage].relatedMembersHeader}</th>
                                <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                transactions.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                    // For the fund report, always display the total amount of the expense
                    const displayedAmount = t.amount;
                    const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('💵 ', '') : translations[currentLanguage].expenseOption.replace('🍺 ', '');
                    const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';

                    const memberNames = t.type === 'contribution'
                        ? getMemberName(t.contributingMemberId)
                        : getInvolvedMembersNames(t.involvedMemberIds);
                    const transactionDate = new Date(t.date).toLocaleDateString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    });

                    tableHtml += `
                        <tr class="table-row">
                            <td>${transactionDate}</td>
                            <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                            <td>${t.description}</td>
                            <td>${t.type === 'expense' && t.expense_type ? t.expense_type : 'N/A'}</td> <!-- Display expense type -->
                            <td>${memberNames}</td>
                            <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                        </tr>
                    `;
                });
                tableHtml += `
                        </tbody>
                    </table>
                `;
                fundReportTableContainer.innerHTML = tableHtml;
            }

            // Renders the Member Report dropdown
            function renderMemberReportDropdown() {
                selectMemberReportDropdown.innerHTML = '';
                if (members.length === 0) {
                    selectMemberReportDropdown.innerHTML = `<option value="">${translations[currentLanguage].noMembers}</option>`;
                } else {
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.name;
                        selectMemberReportDropdown.appendChild(option);
                    });
                    // Set default selected member if not already set
                    if (!selectMemberReportDropdown.value && members.length > 0) {
                        selectMemberReportDropdown.value = members[0].id;
                    }
                }
                renderSelectedMemberReport(); // Render report for initially selected member
            }

            // Renders the report for the currently selected member
            function renderSelectedMemberReport() {
                const selectedMemberId = selectMemberReportDropdown.value;
                if (!selectedMemberId) {
                    memberReportTableContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].selectMemberToReport}</p>`;
                    return;
                }

                const memberTransactions = transactions.filter(t =>
                    (t.type === 'contribution' && t.contributingMemberId === selectedMemberId) ||
                    (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(selectedMemberId))
                ).sort((a, b) => new Date(b.date) - new Date(a.date));

                if (memberTransactions.length === 0) {
                    memberReportTableContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noMemberTransactions}</p>`;
                    return;
                }

                let tableHtml = `
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                <th class="table-header">${translations[currentLanguage].dateHeader}</th>
                                <th class="table-header">${translations[currentLanguage].typeHeader}</th>
                                <th class="table-header">${translations[currentLanguage].descriptionHeader}</th>
                                <th class="table-header">${translations[currentLanguage].expenseTypeHeader}</th> <!-- New Column -->
                                <th class="table-header text-right-aligned">${translations[currentLanguage].amountHeader}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                memberTransactions.forEach(t => {
                    let displayedAmount = t.amount;
                    // For individual member reports, show the per-person share of the expense
                    if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                        displayedAmount = t.amount / t.involvedMemberIds.length;
                    }
                    const typeText = t.type === 'contribution' ? translations[currentLanguage].contributionOption.replace('💵 ', '') : translations[currentLanguage].expenseOption.replace('🍺 ', '');
                    const typeClass = t.type === 'contribution' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const amountClass = t.type === 'contribution' ? 'balance-positive' : 'balance-negative';
                    const transactionDate = new Date(t.date).toLocaleDateString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    });

                        tableHtml += `
                            <tr class="table-row">
                                <td>${transactionDate}</td>
                                <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${typeClass}">${typeText}</span></td>
                                <td>${t.description}</td>
                                <td>${t.type === 'expense' && t.expense_type ? t.expense_type : 'N/A'}</td> <!-- Display expense type -->
                                <td class="text-right-aligned ${amountClass}">${t.type === 'contribution' ? '+' : '-'}${formatNumberForDisplay(displayedAmount)}</td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    memberReportTableContainer.innerHTML = tableHtml;
                }

                // Export Fund Report to Excel
                exportFundReportExcelBtn.onclick = () => {
                    if (typeof window.XLSX === 'undefined') {
                        showErrorMessage(translations[currentLanguage].xlsxLoadError);
                        return;
                    }

                    const reportData = transactions.slice().sort((a, b) => new Date(a.date) - new Date(b.date)).map(t => {
                        // For Excel export of fund report, use the total amount
                        const displayedAmount = t.amount;
                        const transactionDate = new Date(t.date).toLocaleDateString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                            year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                        });
                        return {
                            [translations[currentLanguage].dateHeader]: transactionDate,
                            [translations[currentLanguage].typeHeader]: t.type === 'contribution' ? translations[currentLanguage].contributionType : translations[currentLanguage].expenseType,
                            [translations[currentLanguage].descriptionHeader]: t.description,
                            [translations[currentLanguage].expenseTypeHeader]: t.type === 'expense' && t.expense_type ? t.expense_type : 'N/A', // New
                            [translations[currentLanguage].relatedMembersHeader]: t.type === 'contribution' ? getMemberName(t.contributingMemberId) : getInvolvedMembersNames(t.involvedMemberIds),
                            [`${translations[currentLanguage].amountHeader} (${translations[currentLanguage].unitCurrency})`]: (t.type === 'contribution' ? '+' : '-') + formatNumberForDisplay(displayedAmount),
                        };
                    });

                    const ws = window.XLSX.utils.json_to_sheet(reportData);
                    const wb = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(wb, ws, translations[currentLanguage].fundReportTitle);
                    window.XLSX.writeFile(wb, `${translations[currentLanguage].fundReportTitle}.xlsx`);
                };

                // Export Member Report to Excel
                exportMemberReportExcelBtn.onclick = () => {
                    if (typeof window.XLSX === 'undefined') {
                        showErrorMessage(translations[currentLanguage].xlsxLoadError);
                        return;
                    }
                    const selectedMemberId = selectMemberReportDropdown.value;
                    if (!selectedMemberId) {
                        showErrorMessage(translations[currentLanguage].selectMemberForExport);
                        return;
                    }
                    const memberName = getMemberName(selectedMemberId);
                    const memberTransactions = transactions.filter(t =>
                        (t.type === 'contribution' && t.contributingMemberId === selectedMemberId) ||
                        (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.includes(selectedMemberId))
                    ).sort((a, b) => new Date(a.date) - new Date(b.date));

                    const reportData = memberTransactions.map(t => {
                        let displayedAmount = t.amount;
                        // For Excel export of member report, use the per-person share
                        if (t.type === 'expense' && t.involvedMemberIds && t.involvedMemberIds.length > 0) {
                            displayedAmount = t.amount / t.involvedMemberIds.length;
                        }
                        const transactionDate = new Date(t.date).toLocaleDateString(currentLanguage === 'vi' ? 'vi-VN' : 'en-US', {
                            year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                        });
                        return {
                            [translations[currentLanguage].dateHeader]: transactionDate,
                            [translations[currentLanguage].typeHeader]: t.type === 'contribution' ? translations[currentLanguage].contributionType : translations[currentLanguage].expenseType,
                            [translations[currentLanguage].descriptionHeader]: t.description,
                            [translations[currentLanguage].expenseTypeHeader]: t.type === 'expense' && t.expense_type ? t.expense_type : 'N/A', // New
                            [`${translations[currentLanguage].amountHeader} (${translations[currentLanguage].unitCurrency})`]: (t.type === 'contribution' ? '+' : '-') + formatNumberForDisplay(displayedAmount),
                        };
                    });

                    const ws = window.XLSX.utils.json_to_sheet(reportData);
                    const wb = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(wb, ws, `${translations[currentLanguage].memberReportsTitle} ${memberName}`);
                    window.XLSX.writeFile(wb, `${translations[currentLanguage].memberReportsTitle}_${memberName}.xlsx`);
                };

                // --- Word Export Functions ---

                // Helper function to get HTML content for Word export with inline styles
                function getHtmlForWordExport(containerId, title) {
                    const container = document.getElementById(containerId);
                    if (!container) return '';

                    // Clone the container to manipulate its content without affecting the live DOM
                    const clonedContainer = container.cloneNode(true);

                    // Apply inline styles to the cloned table elements for better Word rendering
                    const table = clonedContainer.querySelector('table');
                    if (table) {
                        table.classList.add('word-export-table'); // Add a specific class for Word export styling
                        // Apply inline styles to th and td elements
                        clonedContainer.querySelectorAll('th, td').forEach(cell => {
                            cell.style.border = '1px solid #e5e7eb';
                            cell.style.padding = '0.75rem';
                            cell.style.textAlign = cell.classList.contains('text-right-aligned') ? 'right' : 'left';
                            if (cell.tagName === 'TH') {
                                cell.style.backgroundColor = '#f3f4f6';
                                cell.style.fontWeight = 'bold';
                            }
                            // Apply color for balance classes
                            if (cell.querySelector('.balance-positive')) {
                                cell.style.color = '#10B981';
                            } else if (cell.querySelector('.balance-negative')) {
                                cell.style.color = '#EF4444';
                            } else if (cell.querySelector('.balance-zero')) {
                                cell.style.color = '#6B7280';
                            }
                            // Remove span elements that apply color/background on web for Word export
                            const span = cell.querySelector('span.px-2.py-1.rounded-full');
                            if (span) {
                                cell.textContent = span.textContent; // Move text from span to cell
                                span.remove(); // Remove the span
                            }
                        });
                    }

                    let htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="utf-8">
                            <title>${title}</title>
                            <style>
                                /* Basic styles for Word document */
                                body { font-family: 'Inter', sans-serif; }
                                table {
                                    border-collapse: collapse;
                                    width: 100%;
                                }
                                th, td {
                                    border: 1px solid #e5e7eb;
                                    padding: 0.75rem;
                                    text-align: left;
                                }
                                th {
                                    background-color: #f3f4f6;
                                    font-weight: bold;
                                }
                                .balance-positive { color: #10B981; }
                                .balance-negative { color: #EF4444; }
                                .balance-zero { color: #6B7280; }
                                .text-right-aligned { text-align: right; }
                            </style>
                        </head>
                        <body>
                            <h1>${title}</h1>
                            ${clonedContainer.innerHTML}
                        </body>
                        </html>
                    `;
                    return htmlContent;
                }


                // Export Fund Report to Word
                exportFundReportWordBtn.onclick = () => {
                    if (typeof window.saveAs === 'undefined') {
                        showErrorMessage(translations[currentLanguage].fileSaverLoadError);
                        return;
                    }

                    const title = translations[currentLanguage].fundReportTitle;
                    const content = getHtmlForWordExport('fund-report-table-container', title); // Use the actual table container ID

                    const blob = new Blob([content], {
                        type: 'application/msword;charset=utf-8'
                    });
                    saveAs(blob, `${translations[currentLanguage].fundReportTitle}.doc`);
                };

                // Export Member Report to Word
                exportMemberReportWordBtn.onclick = () => {
                    if (typeof window.saveAs === 'undefined') {
                        showErrorMessage(translations[currentLanguage].fileSaverLoadError);
                        return;
                    }
                    const selectedMemberId = selectMemberReportDropdown.value;
                    if (!selectedMemberId) {
                        showErrorMessage(translations[currentLanguage].selectMemberForWordExport);
                        return;
                    }
                    const memberName = getMemberName(selectedMemberId);
                    const title = `${translations[currentLanguage].memberReportsTitle}: ${memberName}`;
                    const content = getHtmlForWordExport('member-report-table-container', title); // Use the actual table container ID

                    const blob = new Blob([content], {
                        type: 'application/msword;charset=utf-8'
                    });
                    saveAs(blob, `${translations[currentLanguage].memberReportsTitle}_${memberName}.doc`);
                };


                // --- Pie Chart Functions ---

                // Helper for SVG arc drawing
                function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
                    const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                    return {
                        x: centerX + (radius * Math.cos(angleInRadians)),
                        y: centerY + (radius * Math.sin(angleInRadians))
                    };
                }

                function describePieSlice(centerX, centerY, radius, startAngle, endAngle) {
                    const start = polarToCartesian(centerX, centerY, radius, endAngle);
                    const end = polarToCartesian(centerX, centerY, radius, startAngle);
                    const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

                    const pathData = [
                        `M ${centerX} ${centerY}`,
                        `L ${start.x} ${start.y}`,
                        `A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y}`,
                        `L ${centerX} ${centerY}`,
                        `Z`
                    ].join(" ");

                    return pathData;
                }

                // Renders the Member Balance Pie Chart
                function renderMemberBalancePieChart() {
                    const CHART_SIZE = 200;
                    const RADIUS = CHART_SIZE / 2 - 10;
                    const centerX = CHART_SIZE / 2;
                    const centerY = CHART_SIZE / 2;

                    const colorPalette = [
                        '#4CAF50', // Green
                        '#2196F3', // Blue
                        '#FFC107', // Amber
                        '#F44336', // Red
                        '#9C27B0', // Purple
                        '#FF9800', // Orange
                        '#00BCD4', // Cyan
                        '#E91E63', // Pink
                        '#795548', // Brown
                        '#607D8B', // Blue Grey
                    ];

                    const chartData = members.filter(m => Math.abs(m.balance) > 0.01); // Filter out members with effectively zero balance
                    const totalAbsoluteBalance = chartData.reduce((sum, m) => sum + Math.abs(m.balance), 0);

                    if (chartData.length === 0) {
                        memberBalancePieChartDiv.innerHTML = `<p class="text-center text-gray-500 mt-4">${translations[currentLanguage].noBalanceChart}</p>`;
                        return;
                    }

                    let currentAngle = 0;
                    let slicesSvg = '';
                    let legendHtml = '';

                    chartData.forEach((member, index) => {
                        const sliceAngle = (Math.abs(member.balance) / totalAbsoluteBalance) * 360;
                        const startAngle = currentAngle;
                        const endAngle = currentAngle + sliceAngle;

                        const pathData = describePieSlice(centerX, centerY, RADIUS, startAngle, endAngle);
                        const color = colorPalette[index % colorPalette.length];

                        const midAngle = startAngle + sliceAngle / 2;
                        const labelRadius = RADIUS * 0.7;
                        const labelPos = polarToCartesian(centerX, centerY, labelRadius, midAngle);

                        slicesSvg += `
                            <g>
                                <path
                                    d="${pathData}"
                                    fill="${color}"
                                    stroke="white"
                                    stroke-width="1"
                                />
                                ${sliceAngle > 10 ? `
                                    <text
                                        x="${labelPos.x}"
                                        y="${labelPos.y}"
                                        fill="white"
                                        font-size="10"
                                        text-anchor="middle"
                                        alignment-baseline="middle"
                                        font-weight="bold"
                                    >
                                        ${member.name}
                                    </text>
                                ` : ''}
                            </g>
                        `;
                        currentAngle = endAngle;

                        legendHtml += `
                            <div class="flex items-center mb-1">
                                <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span>
                                <span class="text-sm text-gray-800">${member.name}</span>
                            </div>
                        `;
                    });

                    memberBalancePieChartDiv.innerHTML = `
                        <svg viewBox="0 0 ${CHART_SIZE} ${CHART_SIZE}" width="100%" height="auto" style="max-width: 300px;">
                            ${slicesSvg}
                            <text x="${centerX}" y="${centerY}" text-anchor="middle" alignment-baseline="middle" font-size="12" font-weight="bold" fill="#333">
                                ${translations[currentLanguage].totalChart} ${formatNumberForDisplay(totalAbsoluteBalance)} ${translations[currentLanguage].unitCurrency}
                            </text>
                        </svg>
                        <div class="ml-8 p-4 bg-gray-50 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-gray-700 mb-2">${translations[currentLanguage].chartLegend}:</h4>
                            ${legendHtml}
                        </div>
                    `;
                }

                // --- Pie Charts for Categories (Income and Expense) ---

                // Extracts category from transaction expense_type (New)
                function extractCategory(transaction) {
                    if (transaction.type === 'expense' && transaction.expense_type) {
                        return transaction.expense_type;
                    }
                    return translations[currentLanguage].otherCategory;
                }

                // Calculates total income and expense for each category
                function calculateCategoryBalances() {
                    const incomeCategories = new Map();
                    const expenseCategories = new Map();

                    transactions.forEach(t => {
                        if (t.type === 'contribution') {
                            // Contributions don't have expense_type, so we can categorize them generally
                            incomeCategories.set(translations[currentLanguage].contributionType, (incomeCategories.get(translations[currentLanguage].contributionType) || 0) + t.amount);
                        } else if (t.type === 'expense') {
                            const category = extractCategory(t);
                            expenseCategories.set(category, (expenseCategories.get(category) || 0) + t.amount);
                        }
                    });

                    return { incomeCategories, expenseCategories };
                }

                // Renders a single pie chart for a given type (income or expense)
                function renderSingleCategoryPieChart(containerElement, title, dataMap, totalAmount, colors) {
                    const CHART_SIZE = 200;
                    const RADIUS = CHART_SIZE / 2 - 10;
                    const centerX = CHART_SIZE / 2;
                    const centerY = CHART_SIZE / 2;

                    if (totalAmount === 0) {
                        containerElement.innerHTML = `<p class="text-center text-gray-500 mt-4">${translations[currentLanguage].noCategoryChart.replace('{type}', title.toLowerCase())}</p>`;
                        return;
                    }

                    let currentAngle = 0;
                    let slicesSvg = '';
                    let legendHtml = '';
                    let index = 0;

                    // Sort categories alphabetically for consistent display
                    const sortedCategories = Array.from(dataMap.keys()).sort();

                    sortedCategories.forEach(category => {
                        const amount = dataMap.get(category);
                        const percentage = (amount / totalAmount) * 100;
                        const sliceAngle = (amount / totalAmount) * 360;
                        const startAngle = currentAngle;
                        const endAngle = currentAngle + sliceAngle;

                        const pathData = describePieSlice(centerX, centerY, RADIUS, startAngle, endAngle);
                        const color = colors[index % colors.length];

                        const midAngle = startAngle + sliceAngle / 2;
                        const labelRadius = RADIUS * 0.7;
                        const labelPos = polarToCartesian(centerX, centerY, labelRadius, midAngle);

                        slicesSvg += `
                            <g>
                                <path
                                    d="${pathData}"
                                    fill="${color}"
                                    stroke="white"
                                    stroke-width="1"
                                />
                                ${percentage > 5 ? ` <text
                                        x="${labelPos.x}"
                                        y="${labelPos.y}"
                                        fill="white"
                                        font-size="10"
                                        text-anchor="middle"
                                        alignment-baseline="middle"
                                        font-weight="bold"
                                    >
                                        ${percentage.toFixed(1)}%
                                    </text>
                                ` : ''}
                            </g>
                        `;
                        currentAngle = endAngle;

                        legendHtml += `
                            <div class="flex items-center mb-1">
                                <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span>
                                <span class="text-sm text-gray-800">${category}: ${formatNumberForDisplay(amount)} ${translations[currentLanguage].unitCurrency} (${percentage.toFixed(1)}%)</span>
                            </div>
                        `;
                        index++;
                    });

                    containerElement.innerHTML = `
                        <svg viewBox="0 0 ${CHART_SIZE} ${CHART_SIZE}" width="100%" height="auto" style="max-width: 300px;">
                            ${slicesSvg}
                            <text x="${centerX}" y="${centerY}" text-anchor="middle" alignment-baseline="middle" font-size="12" font-weight="bold" fill="#333">
                                ${translations[currentLanguage].totalChart} ${formatNumberForDisplay(totalAmount)} ${translations[currentLanguage].unitCurrency}
                            </text>
                        </svg>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg shadow-sm w-full max-w-[300px]">
                            <h4 class="font-semibold text-gray-700 mb-2">${translations[currentLanguage].chartLegendFor.replace('{title}', title)}:</h4>
                            ${legendHtml}
                        </div>
                    `;
                }

                // Renders both income and expense category pie charts
                function renderCategoryPieCharts() {
                    const { incomeCategories, expenseCategories } = calculateCategoryBalances();

                    const incomeColors = [
                        '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', // Greens to Yellows
                        '#26A69A', '#00BCD4', '#009688', '#4DD0E1', '#80CBC4'  // Teals
                    ];
                    const expenseColors = [
                        '#F44336', '#E57373', '#FFCDD2', '#D32F2F', '#C62828', // Reds
                        '#FF9800', '#FFB74D', '#FFECB3', '#FB8C00', '#E65100'  // Oranges
                    ];

                    const totalIncome = Array.from(incomeCategories.values()).reduce((sum, val) => sum + val, 0);
                    const totalExpense = Array.from(expenseCategories.values()).reduce((sum, val) => sum + val, 0);

                    const incomeChartContainer = document.getElementById('income-pie-chart-container');
                    const expenseChartContainer = document.getElementById('expense-pie-chart-container');

                    renderSingleCategoryPieChart(incomeChartContainer, translations[currentLanguage].incomeByCategory, incomeCategories, totalIncome, incomeColors);
                    renderSingleCategoryPieChart(expenseChartContainer, translations[currentLanguage].expenseByCategory, expenseCategories, totalExpense, expenseColors);
                }


                // --- Gemini API Integration (via Supabase Edge Functions) ---

                // Simple Markdown to HTML converter
                function markdownToHtml(markdown) {
                    let html = markdown;

                    // Convert headings (e.g., ## Heading) to <h2>
                    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

                    // Convert bold (e.g., **text**) to <strong> 
                    html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
                    // Convert italics (e.g., *text*) to <em>
                    html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');

                    // Convert unordered lists (e.g., - item) to <ul> and <li>
                    html = html.replace(/^\s*\-\s(.*)$/gim, '<li>$1</li>');
                    html = html.replace(/^(<li>.*<\/li>(\n<li>.*<\/li>)*)/gim, '<ul>$1</ul>');

                    // Convert ordered lists (e.g., 1. item) to <ol> and <li>
                    html = html.replace(/^\s*\d+\.\s(.*)$/gim, '<li>$1</li>');
                    html = html.replace(/^(<li>.*<\/li>(\n<li>.*<\/li>)*)/gim, '<ol>$1</ol>');


                    // Convert newlines to paragraphs, but only if not already part of a block element
                    html = html.split('\n').map(line => {
                        if (line.trim() === '' || line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<ol') || line.startsWith('<li>')) {
                            return line;
                        }
                        return `<p class="mb-2 text-gray-700">${line}</p>`;
                    }).join('');

                    // Clean up empty paragraphs that might be created by the above logic
                    html = html.replace(/<p class="mb-2 text-gray-700"><\/p>/g, '');

                    return html;
                }

                // NEW: Function to call a Supabase Edge Function
                async function callSupabaseEdgeFunction(functionName, dataPayload) {
                    try {
                        const session = await supabase.auth.getSession();
                        let accessToken = session?.data?.session?.access_token;
                        const clientTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                        if (!accessToken) {
                            // Attempt anonymous sign-in if no session. This might fail if RLS requires authenticated users.
                            const { data, error } = await supabase.auth.signInAnonymously();
                            if (error) {
                                throw new Error(`Anonymous sign-in failed: ${error.message}`);
                            }
                            // If anonymous sign-in is successful, retrieve the new session
                            const newSession = await supabase.auth.getSession();
                            if (!newSession?.data?.session?.access_token) {
                                throw new Error("Could not obtain access token after anonymous sign-in.");
                            }
                            accessToken = newSession.data.session.access_token;
                        }

                        const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/${functionName}`;

                        const response = await fetch(edgeFunctionUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                activities: dataPayload, // Pass our custom payload as 'activities'
                                clientTimezone: clientTimezone // Pass timezone for context
                            }),
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Edge Function error: ${errorData.error || response.statusText}`);
                        }

                        return await response.json();
                    } catch (error) {
                        console.error(`Error calling Supabase Edge Function ${functionName}:`, error);
                        throw error; // Re-throw to be handled by calling functions
                    }
                }


                async function generateFundInsights() {
                    isGeneratingInsights = true;
                    fundInsightsContent.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#006B68]"></div>
                            <p class="mt-4 text-gray-600">${translations[currentLanguage].generatingInsights}</p>
                        </div>
                    `;
                    hideErrorMessage(); // Clear previous errors for insights

                    // Prepare data for the Edge Function
                    let activitiesData = {
                        type: 'fund_insights',
                        fundBalance: fundBalance,
                        transactions: transactions.map(t => ({
                            type: t.type,
                            amount: t.amount,
                            description: t.description,
                            date: t.date,
                            contributingMemberName: t.type === 'contribution' ? getMemberName(t.contributingMemberId) : null,
                           // Dòng đã sửa để gửi một mảng các tên thành viên
                            involvedMemberNames: t.type === 'expense' && t.involvedMemberIds
                                ? t.involvedMemberIds.map(id => getMemberName(id))
                                : [],
                            expenseType: t.type === 'expense' ? t.expense_type : null
                        })).slice(-10).sort((a, b) => new Date(a.date) - new Date(b.date)), // Last 10, sorted by date
                        currentLanguage: currentLanguage
                    };

                    console.log("Sending fund insights data to Edge Function:", activitiesData);

                    try {
                        // Gọi hàm Edge Function mới: process-ai-requests
                        const result = await callSupabaseEdgeFunction('process-ai-requests', activitiesData);

                        if (result.success && result.analysis) {
                            fundInsightsContent.innerHTML = markdownToHtml(result.analysis);
                        } else {
                            fundInsightsContent.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noInsights}</p>`;
                            console.error("Supabase Edge Function response indicated failure:", result);
                        }
                    } catch (error) {
                        console.error("Error generating fund insights:", error);
                        showErrorMessage(`${translations[currentLanguage].aiCallError} ${error.message}. ${translations[currentLanguage].aiConnectionError}`);
                        fundInsightsContent.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].aiConnectionError}</p>`;
                    } finally {
                        isGeneratingInsights = false;
                    }
                }

                // New function to generate food suggestions
                async function generateFoodSuggestions(latitude, longitude) {
                    isGeneratingFoodSuggestions = true;
                    foodSuggestionContent.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#006B68]"></div>
                            <p class="mt-4 text-gray-600">${translations[currentLanguage].generatingFoodSuggestions}</p>
                        </div>
                    `;
                    hideErrorMessage(); // Clear previous errors for food suggestions

                    // Prepare data for the Edge Function
                    let activitiesData = {
                        type: 'food_suggestions',
                        latitude: latitude,
                        longitude: longitude,
                        currentLanguage: currentLanguage
                    };

                    console.log("Sending food suggestion data to Edge Function:", activitiesData);

                    try {
                        // Gọi hàm Edge Function mới: process-ai-requests
                        const result = await callSupabaseEdgeFunction('process-ai-requests', activitiesData);

                        if (result.success && result.analysis) {
                            const suggestions = JSON.parse(result.analysis); // Assume analysis is already JSON from Edge Function

                            let htmlContent = '<div class="space-y-4">';
                            if (suggestions.length > 0) {
                                suggestions.forEach(s => {
                                    // Construct Google Maps search link using the restaurant name
                                    const googleMapsSearchLink = s.name ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.name)}` : '#';

                                    htmlContent += `
                                        <div class="p-4 border border-gray-200 rounded-lg shadow-sm bg-white">
                                            <h3 class="text-lg font-semibold text-[#006B68]">${s.name}</h3>
                                            <p class="text-sm text-gray-600"><strong>${translations[currentLanguage].addressLabel}</strong> ${s.address || 'N/A'}</p>
                                            <p class="text-sm text-gray-600"><strong>${translations[currentLanguage].phoneLabel}</strong> ${s.phoneNumber || 'N/A'}</p>
                                            <p class="text-sm text-gray-600"><strong>${translations[currentLanguage].ratingLabel}</strong> ${s.starRating ? `${s.starRating} ⭐` : 'N/A'}</p>
                                            <p class="text-sm text-gray-600"><strong>${translations[currentLanguage].distanceLabel}</strong> ${s.estimatedDistance || 'N/A'}</p>
                                            ${s.description ? `<p class="text-sm text-gray-700 mt-2"><strong>${translations[currentLanguage].descriptionLabelShort}</strong> ${s.description}</p>` : ''}
                                            ${s.menuContent ? `<p class="text-sm text-gray-700"><strong>${translations[currentLanguage].menuLabel}</strong> ${s.menuContent}</p>` : ''}
                                            ${s.name ? `<a href="${googleMapsSearchLink}" target="_blank" class="text-blue-500 hover:underline text-sm flex items-center mt-2">
                                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                                                ${translations[currentLanguage].viewOnMaps}
                                            </a>` : ''}
                                        </div>
                                    `;
                                });
                            } else {
                                htmlContent += `<p class="text-center text-gray-500">${translations[currentLanguage].noFoodSuggestions}</p>`;
                            }
                            htmlContent += '</div>'; // Close space-y-4 div
                            foodSuggestionContent.innerHTML = htmlContent;
                        } else {
                            foodSuggestionContent.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].noFoodSuggestions}</p>`;
                            console.error("Supabase Edge Function response indicated failure:", result);
                        }
                    } catch (error) {
                        console.error("Error generating food suggestions:", error);
                        showErrorMessage(`${translations[currentLanguage].aiCallError} ${error.message}. ${translations[currentLanguage].foodSuggestionError}`);
                        foodSuggestionContent.innerHTML = `<p class="text-center text-gray-500">${translations[currentLanguage].foodSuggestionError}</p>`;
                    } finally {
                        isGeneratingFoodSuggestions = false;
                    }
                }

                // Removed: callSupabaseVisionEdgeFunction is no longer needed.
                // All AI calls go through callSupabaseEdgeFunction now.

                // Call Gemini Vision API (now via single Supabase Edge Function 'process-ai-requests')
                async function callGeminiVisionAPI(base64ImageData) {
                    cameraLoadingSpinner.classList.remove('hidden');
                    descriptionInput.value = translations[currentLanguage].generatingInsights; // Show loading text
                    aiDescribeBtn.disabled = true;

                    // Prepare a more detailed prompt for image analysis
                    const prompt = `Bạn là một trợ lý tài chính. Hãy mô tả hình ảnh này một cách chi tiết và sau đó đề xuất mô tả giao dịch phù hợp cho ứng dụng quản lý quỹ nhóm. Dựa trên hình ảnh, hãy gợi ý một "Loại Chi Tiêu" phù hợp từ danh sách sau, nếu không phù hợp, hãy gợi ý loại "Khác": ${translations[currentLanguage].defaultExpenseTypes}.
                    
                    Định dạng phản hồi JSON:
                    {
                        "description": "Mô tả chi tiết từ hình ảnh và đề xuất mô tả giao dịch.",
                        "expense_type_suggestion": "Loại Chi Tiêu gợi ý từ danh sách đã cho."
                    }
                    `;
                    
                    const payload = {
                        type: 'image_description', // Thêm trường type mới
                        image: base64ImageData,
                        prompt: prompt,
                        currentLanguage: currentLanguage, // Pass language for context
                        expenseTypes: expenseTypes.map(et => et.expense_type) // Pass existing expense types for better categorization
                    };

                    try {
                        // Gọi hàm Edge Function chung: process-ai-requests
                        const result = await callSupabaseEdgeFunction('process-ai-requests', payload);

                        if (result.success && result.analysis) {
                            const parsedAnalysis = JSON.parse(result.analysis);
                            descriptionInput.value = parsedAnalysis.description || '';
                            // Try to set the expense type if it exists in the current list
                            if (parsedAnalysis.expense_type_suggestion && expenseTypes.some(et => et.expense_type === parsedAnalysis.expense_type_suggestion)) {
                                expenseTypeSelect.value = parsedAnalysis.expense_type_suggestion;
                            } else {
                                // If not found, try to default to "Khác" if it exists, otherwise keep current
                                const otherOption = expenseTypes.find(et => et.expense_type === translations[currentLanguage].otherCategory);
                                if (otherOption) {
                                    expenseTypeSelect.value = otherOption.expense_type;
                                }
                            }
                        } else {
                            descriptionInput.value = translations[currentLanguage].noImageDescription;
                        }
                    } catch (error) {
                        console.error("Error calling Gemini Vision API via Edge Function:", error);
                        showErrorMessage(`${translations[currentLanguage].aiCallError} ${error.message}`);
                        descriptionInput.value = translations[currentLanguage].noImageDescription;
                    } finally {
                        cameraLoadingSpinner.classList.add('hidden');
                        aiDescribeBtn.disabled = false;
                        cameraModal.classList.add('hidden'); // Close modal after processing
                    }
                }


                // --- Event Listeners ---

                // Navigation buttons
                document.getElementById('add-member-btn').onclick = () => { hideAllSections(); addMemberSection.classList.remove('hidden'); scrollToSection('add-member-section'); };
                document.getElementById('add-transaction-btn').onclick = () => {
                    hideAllSections();
                    addTransactionSection.classList.remove('hidden');
                    transactionTypeSelect.value = 'contribution'; // Default to contribution
                    transactionTypeSelect.onchange(); // Trigger change to set correct fields
                    // Set current date and time
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    transactionDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    scrollToSection('add-transaction-section');
                };
                document.getElementById('view-transactions-btn').onclick = () => { hideAllSections(); transactionsSection.classList.remove('hidden'); renderTransactionList(); scrollToSection('transactions-section'); };
                document.getElementById('show-report-selection-btn').onclick = () => { hideAllSections(); reportSelectionModal.classList.remove('hidden'); };
                document.getElementById('get-insights-btn').onclick = () => {
                    hideAllSections();
                    fundInsightsModal.classList.remove('hidden');
                    generateFundInsights();
                };
                document.getElementById('get-food-suggestions-btn').onclick = () => {
                    hideAllSections();
                    foodSuggestionModal.classList.remove('hidden');
                    getGeolocationAndSuggestFood();
                };

                // Report Selection Modal buttons
                selectFundReportBtn.onclick = () => { hideAllSections(); fundReportSection.classList.remove('hidden'); renderFundReport(); scrollToSection('fund-report-section'); };
                selectMemberReportBtn.onclick = () => { hideAllSections(); memberReportsSection.classList.remove('hidden'); renderMemberReportDropdown(); scrollToSection('member-reports-section'); };
                closeReportSelectionBtn.onclick = () => reportSelectionModal.classList.add('hidden');

                // Edit Transaction Modal buttons
                cancelEditTransactionBtn.onclick = () => { editTransactionModal.classList.add('hidden'); editingTransaction = null; };

                // Member Details Modal buttons
                closeMemberDetailsBtn.onclick = () => { memberDetailsModal.classList.add('hidden'); selectedMemberForDetails = null; };

                // Insights Modal buttons
                closeInsightsBtn.onclick = () => fundInsightsModal.classList.add('hidden');

                // Food Suggestion Modal buttons
                closeFoodSuggestionBtn.onclick = () => foodSuggestionModal.classList.add('hidden');

                // Image/Camera Upload
                aiDescribeBtn.onclick = () => {
                    hideAllSections();
                    cameraModal.classList.remove('hidden');
                    uploadedImagePreview.classList.add('hidden');
                    imageUploadInput.value = ''; // Clear previous selection
                    imageUploadInput.click(); // Trigger file input click
                };

                imageUploadInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadstart = () => {
                            cameraLoadingSpinner.classList.remove('hidden');
                            uploadedImagePreview.classList.add('hidden');
                        };
                        reader.onloadend = () => {
                            uploadedImagePreview.src = reader.result;
                            uploadedImagePreview.classList.remove('hidden');
                            // Extract base64 part for API call
                            const base64Data = reader.result.split(',')[1];
                            callGeminiVisionAPI(base64Data);
                        };
                        reader.onerror = (error) => {
                            console.error("Error reading file:", error);
                            showErrorMessage("Lỗi đọc file hình ảnh.");
                            cameraLoadingSpinner.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                cancelCameraBtn.onclick = () => {
                    cameraModal.classList.add('hidden');
                    cameraLoadingSpinner.classList.add('hidden');
                    imageUploadInput.value = '';
                };


                // Input formatting for amount fields
                amountInput.oninput = (e) => {
                    const originalCursorPos = e.target.selectionStart;
                    const originalLength = e.target.value.length;

                    let cleanedValue = e.target.value.replace(/[^0-9]/g, ''); // Remove non-digits
                    if (cleanedValue.startsWith('0') && cleanedValue.length > 1) { // Remove leading zero if not single '0'
                        cleanedValue = parseInt(cleanedValue, 10).toString();
                    }
                    if (cleanedValue === '') {
                        e.target.value = '';
                        return;
                    }
                    const formattedValue = formatNumberForInput(cleanedValue);
                    e.target.value = formattedValue;

                    // Adjust cursor position
                    const newLength = formattedValue.length;
                    const diff = newLength - originalLength;
                    e.target.setSelectionRange(originalCursorPos + diff, originalCursorPos + diff);
                };

                editAmountInput.oninput = (e) => {
                    const originalCursorPos = e.target.selectionStart;
                    const originalLength = e.target.value.length;

                    let cleanedValue = e.target.value.replace(/[^0-9]/g, ''); // Remove non-digits
                    if (cleanedValue.startsWith('0') && cleanedValue.length > 1) { // Remove leading zero if not single '0'
                        cleanedValue = parseInt(cleanedValue, 10).toString();
                    }
                    if (cleanedValue === '') {
                        e.target.value = '';
                        return;
                    }
                    const formattedValue = formatNumberForInput(cleanedValue);
                    e.target.value = formattedValue;

                    // Adjust cursor position
                    const newLength = formattedValue.length;
                    const diff = newLength - originalLength;
                    e.target.setSelectionRange(originalCursorPos + diff, originalCursorPos + diff);
                };


                // Handle change for member report dropdown
                selectMemberReportDropdown.onchange = () => {
                    renderSelectedMemberReport();
                };

                // --- Geolocation for Food Suggestions ---
                function getGeolocationAndSuggestFood() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const latitude = position.coords.latitude;
                                const longitude = position.coords.longitude;
                                latitudeInput.value = latitude;
                                longitudeInput.value = longitude;
                                console.log(`Got location: Lat ${latitude}, Lon ${longitude}`);
                                generateFoodSuggestions(latitude, longitude);
                            },
                            (error) => {
                                let errorMessage = translations[currentLanguage].locationError;
                                switch (error.code) {
                                    case error.PERMISSION_DENIED:
                                        errorMessage = translations[currentLanguage].permissionDenied;
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        errorMessage = translations[currentLanguage].positionUnavailable;
                                        break;
                                    case error.TIMEOUT:
                                        errorMessage = translations[currentLanguage].timeout;
                                        break;
                                }
                                showErrorMessage(errorMessage);
                                foodSuggestionContent.innerHTML = `<p class="text-center text-red-500">${errorMessage}</p>`;
                                isGeneratingFoodSuggestions = false;
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        const errorMessage = translations[currentLanguage].geolocationNotSupported;
                        showErrorMessage(errorMessage);
                        foodSuggestionContent.innerHTML = `<p class="text-center text-red-500">${errorMessage}</p>`;
                        isGeneratingFoodSuggestions = false;
                    }
                }

                // --- Scroll to Top Button Logic ---
                window.onscroll = function() {
                    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                        scrollToTopBtn.classList.add('show');
                    } else {
                        scrollToTopBtn.classList.remove('show');
                    }
                };

                scrollToTopBtn.onclick = function() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };


                // Initial data fetch and UI render when DOM is fully loaded
                document.addEventListener('DOMContentLoaded', () => {
                    setLanguage(currentLanguage); // Set initial language
                    initializeSupabase();
                });
            </script>
<script>
    // When the hamburger button is clicked, toggle the menu
    document.getElementById('hamburger-btn').addEventListener('click', function() {
        const menu = document.getElementById('hamburger-menu');
        console.log('Hamburger button clicked!');
        console.log('Menu before toggle:', menu.classList.contains('hidden') ? 'hidden' : 'visible');
        menu.classList.toggle('hidden');
        console.log('Menu after toggle:', menu.classList.contains('hidden') ? 'hidden' : 'visible');
    });
</script>

        </body>
        </html>
