<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Gọi Đồ Ăn</title> <!-- Tên đã sửa -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .tab-active { background-color: #ea580c; color: white; }
        .tab-inactive { background-color: white; color: #4b5563; border: 1px solid #e5e7eb; }
        .view-hidden { display: none; }
        #toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-100%); opacity: 0;
        }
        #toast.show { transform: translateY(0); opacity: 1; }
        /* Thêm hiệu ứng loading đơn giản */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- 1. THÔNG BÁO "TOAST" -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-lg bg-green-600 text-white font-semibold">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="toast-message">Đã thêm vào giỏ hàng!</span>
    </div>

    <!-- 2. NAVIGATION (Tabs) -->
    <nav class="bg-white shadow sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <i class="fas fa-utensils text-orange-600 text-2xl"></i>
                    <span class="font-bold text-xl text-gray-800">FoodApp</span> <!-- Tên đã sửa -->
                </div>
                <div class="flex space-x-2">
                    <button onclick="switchTab('customer')" id="tab-btn-customer" class="px-4 py-2 rounded-lg font-medium transition-colors tab-active">
                        <i class="fas fa-store"></i> <span class="hidden sm:inline">Đặt món</span>
                    </button>
                    <button onclick="switchTab('admin-menu')" id="tab-btn-admin-menu" class="px-4 py-2 rounded-lg font-medium transition-colors tab-inactive">
                        <i class="fas fa-edit"></i> <span class="hidden sm:inline">QL Menu</span>
                    </button>
                    <button onclick="switchTab('admin-orders')" id="tab-btn-admin-orders" class="px-4 py-2 rounded-lg font-medium transition-colors tab-inactive relative">
                        <i class="fas fa-list-alt"></i> <span class="hidden sm:inline">QL Đơn</span>
                        <span id="badge-new" class="hidden absolute -top-1 -right-1 h-3 w-3 bg-red-500 rounded-full"></span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6">
        
        <!-- 3. MÀN HÌNH KHÁCH HÀNG (MENU & GIỎ HÀNG) -->
        <div id="view-customer" class="app-view">
            <div class="flex flex-col lg:flex-row gap-6">
                
                <div class="w-full lg:w-2/3">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Thực đơn hôm nay</h2>
                    <!-- Thêm loading indicator -->
                    <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
                        <p class="loading col-span-3">Đang tải thực đơn từ Supabase...</p>
                    </div>
                </div>

                <div class="w-full lg:w-1/3">
                    <div class="bg-white p-4 rounded-xl shadow-lg sticky top-20 border">
                        <h3 class="text-lg font-bold text-orange-600 mb-3 border-b pb-2"><i class="fas fa-shopping-cart mr-2"></i>Giỏ hàng</h3>
                        
                        <div id="cart-list" class="space-y-3 max-h-[300px] overflow-y-auto mb-4">
                           <p class="text-gray-400 text-center py-4 italic">Chưa có món nào...</p>
                        </div>

                        <div class="flex justify-between items-center border-t pt-3 mb-4">
                            <span class="font-semibold text-gray-600">Tổng cộng:</span>
                            <span id="cart-total" class="font-bold text-xl text-orange-600">0 đ</span>
                        </div>

                        <form id="checkout-form" onsubmit="handleCheckout(event)" class="space-y-3">
                            <input type="text" id="cus-name" placeholder="Tên người đặt (*)" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">
                            <input type="tel" id="cus-phone" placeholder="Số điện thoại (*)" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">
                            <input type="email" id="cus-email" placeholder="Email (nếu có)" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">
                            <button type="submit" id="btn-checkout" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2.5 rounded-lg transition shadow-md">
                                <i class="fas fa-paper-plane mr-2"></i> Đặt hàng
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. MÀN HÌNH QUẢN LÝ MENU (ADMIN) -->
        <div id="view-admin-menu" class="app-view view-hidden">
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Quản lý món ăn (Thêm / Sửa)</h2>
                <form onsubmit="saveDish(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end bg-gray-50 p-4 rounded-lg border">
                    <input type="hidden" id="dish-id">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Tên món</label>
                        <input type="text" id="dish-name" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Giá (VNĐ)</label>
                        <input type="number" id="dish-price" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Link Ảnh (URL)</label>
                        <input type="text" id="dish-img" placeholder="https://..." class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" id="btn-save-dish" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-medium">
                            <i class="fas fa-plus"></i> Thêm
                        </button>
                        <button type="button" onclick="resetDishForm()" class="px-3 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Hủy
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên món</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giá</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="admin-menu-table" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="loading">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 5. MÀN HÌNH QUẢN LÝ ĐƠN HÀNG (ADMIN) -->
        <div id="view-admin-orders" class="app-view view-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Tổng hợp đơn hàng</h2>
            <div class="bg-white rounded-xl shadow overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã / Thời gian</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khách hàng</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chi tiết món</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổng tiền</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="admin-orders-table" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr><td colspan="5" class="loading">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. DATA & STATE ---
        // Bỏ localStorage, thay bằng Supabase
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        let menuData = [];  // Dữ liệu từ DB
        let orderData = []; // Dữ liệu từ DB
        let cart = []; // Giỏ hàng (tạm thời)

        // --- 2. UTILS (Hàm tiện ích) ---
        const formatMoney = (num) => (num ? num.toLocaleString('vi-VN') : '0') + ' đ';
        let toastTimeout;

        function showToast(message) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            msgEl.innerText = message;
            toast.classList.add('show');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 2500);
        }

        async function switchTab(tabName) {
            document.querySelectorAll('.app-view').forEach(view => view.classList.add('view-hidden'));
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.getElementById(`view-${tabName}`).classList.remove('view-hidden');
            document.getElementById(`tab-btn-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-btn-${tabName}`).classList.remove('tab-inactive');
            
            // Tải dữ liệu mới nhất khi chuyển tab
            if(tabName === 'customer') {
                await loadMenuData(); // Tải menu
                renderCustomerMenu(); // Vẽ lại
            }
            if(tabName === 'admin-menu') {
                await loadMenuData(); // Tải menu
                renderAdminMenu(); // Vẽ lại
            }
            if(tabName === 'admin-orders') {
                await loadOrderData(); // Tải đơn
                renderAdminOrders(); // Vẽ lại
            }
        }
        
        // --- 3. CUSTOMER LOGIC (Logic Khách hàng) ---
        
        // MỚI: Hàm tải dữ liệu menu từ Supabase
        async function loadMenuData() {
            const { data, error } = await db.from('menu').select('*').order('created_at', { ascending: false });
            if(error) {
                console.error("Lỗi tải menu:", error);
                return;
            }
            menuData = data; // Cập nhật biến global
        }
        
        // MỚI: Hàm tải dữ liệu order từ Supabase
        async function loadOrderData() {
            const { data, error } = await db.from('orders').select('*').order('created_at', { ascending: false });
            if(error) {
                console.error("Lỗi tải đơn hàng:", error);
                return;
            }
            orderData = data; // Cập nhật biến global
            checkNewOrders(); // Cập nhật badge
        }

        function renderCustomerMenu() {
            const grid = document.getElementById('menu-grid');
            if (!grid) return;
            if (menuData.length === 0) {
                 grid.innerHTML = '<p class="loading col-span-3">Chưa có món ăn nào trong thực đơn.</p>';
                 return;
            }
            
            grid.innerHTML = menuData.map(item => `
                <div class="bg-white rounded-xl shadow hover:shadow-lg transition overflow-hidden flex flex-col h-full">
                    <img src="${item.img || 'https://placehold.co/400x300'}" class="w-full h-48 object-cover">
                    <div class="p-4 flex-1 flex flex-col">
                        <h3 class="font-bold text-lg text-gray-800 mb-1">${item.name}</h3>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-orange-600 font-bold text-lg">${formatMoney(item.price)}</span>
                            <button onclick="addToCart(${item.id})" class="bg-orange-100 text-orange-600 hover:bg-orange-600 hover:text-white p-2 rounded-full transition w-10 h-10 flex items-center justify-center">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addToCart(id) {
            const item = menuData.find(x => x.id == id);
            if (!item) return;
            const existing = cart.find(x => x.id == id);
            if (existing) existing.qty++;
            else cart.push({...item, qty: 1});
            showToast(`Đã thêm: ${item.name}`);
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const totalEl = document.getElementById('cart-total');
            if (cart.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center py-4 italic">Chưa có món nào...</p>';
                totalEl.innerText = '0 đ';
                return;
            }
            let total = 0;
            list.innerHTML = cart.map((item, index) => {
                total += item.price * item.qty;
                return `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded border">
                    <div>
                        <div class="font-medium text-sm text-gray-800">${item.name}</div>
                        <div class="text-xs text-gray-500">${formatMoney(item.price)} x ${item.qty}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateCartQty(${item.id}, -1)" class="text-gray-400 hover:text-red-500"><i class="fas fa-minus-circle"></i></button>
                        <span class="text-sm font-bold w-4 text-center">${item.qty}</span>
                        <button onclick="updateCartQty(${item.id}, 1)" class="text-gray-400 hover:text-green-500"><i class="fas fa-plus-circle"></i></button>
                    </div>
                </div>`;
            }).join('');
            totalEl.innerText = formatMoney(total);
        }

        function updateCartQty(id, delta) {
            const item = cart.find(x => x.id == id);
            if (!item) return;
            item.qty += delta;
            if (item.qty <= 0) cart = cart.filter(x => x.id != id);
            renderCart();
        }

        // SỬA: Chuyển sang ASYNC
        async function handleCheckout(e) {
            e.preventDefault();
            if (cart.length === 0) {
                alert('Giỏ hàng trống!');
                return;
            }
            
            const btn = document.getElementById('btn-checkout');
            btn.disabled = true;
            btn.innerText = "Đang xử lý...";

            const name = document.getElementById('cus-name').value;
            const phone = document.getElementById('cus-phone').value;
            const email = document.getElementById('cus-email').value;

            const newOrder = {
                // id, created_at sẽ do Supabase tự tạo
                time: new Date().toLocaleString('vi-VN'),
                customer: { name, phone, email }, // Kiểu JSONB
                items: [...cart], // Kiểu JSONB
                total: cart.reduce((s, i) => s + i.price * i.qty, 0),
                status: 'Mới'
            };

            // GỌI SUPABASE
            const { data, error } = await db.from('orders').insert([newOrder]).select();

            if (error) {
                console.error('Lỗi đặt hàng:', error);
                alert('Đặt hàng thất bại, vui lòng thử lại.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Đặt hàng';
                return;
            }
            
            // Nếu thành công, thêm vào mảng data local
            orderData.unshift(data[0]);

            // Reset UI
            cart = [];
            document.getElementById('checkout-form').reset();
            renderCart();
            checkNewOrders();
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Đặt hàng';
            
            alert(`Đặt hàng thành công!\nMã đơn: ${data[0].id}`);
        }

        // --- 4. ADMIN MENU LOGIC ---
        function renderAdminMenu() {
            const tbody = document.getElementById('admin-menu-table');
            if (menuData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="loading">Chưa có món nào.</td></tr>';
                return;
            }
            tbody.innerHTML = menuData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 text-gray-500">${formatMoney(item.price)}</td>
                    <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                        <button onclick="editDish(${item.id})" class="text-blue-600 hover:text-blue-900 bg-blue-50 px-3 py-1 rounded">Sửa</button>
                        <button onclick="deleteDish(${item.id})" class="text-red-600 hover:text-red-900 bg-red-50 px-3 py-1 rounded">Xóa</button>
                    </td>
                </tr>
            `).join('');
        }

        function editDish(id) {
            const item = menuData.find(x => x.id == id);
            if (!item) return;

            document.getElementById('dish-id').value = item.id;
            document.getElementById('dish-name').value = item.name;
            document.getElementById('dish-price').value = item.price;
            document.getElementById('dish-img').value = item.img;

            const btn = document.getElementById('btn-save-dish');
            btn.innerHTML = '<i class="fas fa-save"></i> Cập nhật';
            btn.classList.add('bg-green-600');
        }

        function resetDishForm() {
            document.getElementById('dish-id').value = '';
            document.getElementById('dish-name').value = '';
            document.getElementById('dish-price').value = '';
            document.getElementById('dish-img').value = '';
            
            const btn = document.getElementById('btn-save-dish');
            btn.innerHTML = '<i class="fas fa-plus"></i> Thêm';
            btn.classList.remove('bg-green-600');
        }

        // SỬA: Chuyển sang ASYNC
        async function saveDish(e) {
            e.preventDefault();
            const id = document.getElementById('dish-id').value;
            const name = document.getElementById('dish-name').value;
            const price = Number(document.getElementById('dish-price').value);
            const img = document.getElementById('dish-img').value;
            
            const btn = document.getElementById('btn-save-dish');
            btn.disabled = true;

            let error;

            if (id) { // Sửa (Update)
                const { error: updateError } = await db.from('menu')
                    .update({ name: name, price: price, img: img })
                    .eq('id', id);
                error = updateError;
            } else { // Thêm (Insert)
                const { error: insertError } = await db.from('menu')
                    .insert([{ name: name, price: price, img: img }]);
                error = insertError;
            }

            if (error) {
                console.error("Lỗi lưu món:", error);
                alert("Lưu thất bại!");
            } else {
                showToast(id ? "Cập nhật thành công!" : "Thêm món thành công!");
                // Tải lại dữ liệu từ DB để đồng bộ
                await loadMenuData();
                renderAdminMenu(); // Cập nhật bảng admin
                renderCustomerMenu(); // Cập nhật bên khách
                resetDishForm();
            }
            btn.disabled = false;
        }

        // SỬA: Chuyển sang ASYNC
        async function deleteDish(id) {
            if (confirm('Bạn chắc chắn muốn xóa món này?')) {
                const { error } = await db.from('menu').delete().eq('id', id);
                if (error) {
                    console.error("Lỗi xóa món:", error);
                    alert("Xóa thất bại!");
                } else {
                    showToast("Đã xóa món ăn.");
                    // Xóa khỏi mảng local và render lại
                    menuData = menuData.filter(x => x.id != id);
                    renderAdminMenu();
                    renderCustomerMenu();
                }
            }
        }

        // --- 5. ADMIN ORDERS LOGIC ---
        function renderAdminOrders() {
            const tbody = document.getElementById('admin-orders-table');
            if (orderData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Chưa có đơn hàng nào.</td></tr>';
                return;
            }
            tbody.innerHTML = orderData.map(order => `
                <tr>
                    <td class="px-4 py-3 align-top">
                        <span class="font-bold text-gray-800 block">${order.id}</span>
                        <span class="text-xs text-gray-500">${order.time}</span>
                    </td>
                    <td class="px-4 py-3 align-top">
                        <div class="font-medium text-gray-900">${order.customer.name}</div>
                        <div class="text-blue-600 text-sm">${order.customer.phone}</div>
                        <div class="text-gray-400 text-xs">${order.customer.email || ''}</div>
                    </td>
                    <td class="px-4 py-3 align-top text-sm">
                        ${order.items.map(i => `<div>• ${i.name} (x${i.qty})</div>`).join('')}
                    </td>
                    <td class="px-4 py-3 align-top font-bold text-orange-600">
                        ${formatMoney(order.total)}
                    </td>
                    <td class="px-4 py-3 align-top">
                        <select onchange="updateOrderStatus(${order.id}, this.value)" 
                            class="block w-full text-xs font-semibold p-1 rounded border">
                            <option value="Mới" ${order.status === 'Mới' ? 'selected' : ''}>Mới</option>
                            <option value="Đang làm" ${order.status === 'Đang làm' ? 'selected' : ''}>Đang làm</option>
                            <option value="Đang giao" ${order.status === 'Đang giao' ? 'selected' : ''}>Đang giao</option>
                            <option value="Hoàn thành" ${order.status === 'Hoàn thành' ? 'selected' : ''}>Hoàn thành</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        // SỬA: Chuyển sang ASYNC
        async function updateOrderStatus(orderId, newStatus) {
            const { error } = await db.from('orders')
                .update({ status: newStatus })
                .eq('id', orderId);

            if (error) {
                console.error("Lỗi cập nhật trạng thái:", error);
                alert("Cập nhật thất bại!");
            } else {
                showToast(`Đã cập nhật đơn ${orderId} sang "${newStatus}"`);
                // Cập nhật mảng local và badge
                const order = orderData.find(x => x.id === orderId);
                if (order) order.status = newStatus;
                checkNewOrders();
            }
        }

        function checkNewOrders() {
            const newCount = orderData.filter(o => o.status === 'Mới').length;
            const badge = document.getElementById('badge-new');
            if(newCount > 0) {
                 badge.innerText = newCount;
                 badge.classList.remove('hidden');
            } else {
                 badge.classList.add('hidden');
            }
        }

        // --- 6. INIT (Khởi chạy) ---
        // SỬA: Chuyển sang ASYNC để tải dữ liệu lần đầu
        async function init() {
            // Tải dữ liệu từ Supabase trước
            await loadMenuData();
            await loadOrderData();
            
            // Sau khi có dữ liệu, mới vẽ lên
            renderCustomerMenu();
            renderCart(); // Giỏ hàng ban đầu luôn rỗng
            checkNewOrders();
        }
        
        // Chạy hàm init
        init();

    </script>
</body>
</html>
