<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o ho·∫°t ƒë·ªông ch·∫°y b·ªô - FOR RUNNER LOVER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for bubble charts and weekly distance -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Chart.js for other charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define BIDV brand colors */
        :root {
            --bidv-green: #006b68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .btn-primary {
            background-color: var(--bidv-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: #005a57;
        }

        .btn-secondary {
            background-color: var(--bidv-yellow);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background-color: #e6b32a;
        }

        .btn-danger {
            @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out shadow-md;
        }

        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500;
        }
        
        /* Multi-select specific CSS */
        .multi-select-container {
            position: relative;
        }
        .multi-select-selected-items {
            @apply w-full p-2 border border-gray-300 rounded-md bg-white cursor-pointer flex flex-wrap gap-1;
            min-height: 42px;
            align-items: center;
        }
        .multi-select-selected-item {
            @apply bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full flex items-center gap-1;
        }
        .multi-select-selected-item span {
            cursor: pointer;
            font-weight: bold;
        }
        .multi-select-options {
            @apply absolute w-full border border-gray-300 rounded-md bg-white shadow-lg z-10;
            max-height: 200px;
            overflow-y: auto;
        }
        .multi-select-option {
            @apply p-2 cursor-pointer hover:bg-gray-100;
        }
        .multi-select-option.selected {
            @apply bg-blue-100 font-semibold;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        /* Chart.js specific styles */
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
            width: 100%;
        }

        /* D3.js chart specific styles */
        #distance-by-runner-chart,
        #distance-by-club-chart,
        #weekly-distance-chart-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            min-height: 300px;
        }

        .bubble {
            fill-opacity: 0.7;
            cursor: pointer;
            transition: fill-opacity 0.3s ease;
        }

        .bubble:hover {
            fill-opacity: 1;
        }

        .bubble-text {
            font-size: 0.8rem;
            text-anchor: middle;
            fill: white;
            pointer-events: none;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .grid-cols-1-md-grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--bidv-green);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        .data-table th {
            background-color: var(--bidv-green);
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .data-table tbody tr:hover {
            background-color: #f0f2f5;
        }
        .data-table .total-row {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        .data-table .summary-row {
            background-color: #d1e7dd;
            font-weight: bold;
        }
        .data-table .missing-row {
            background-color: #fee2e2;
            color: #ef4444;
            font-weight: bold;
        }
        .data-table .runner-summary-group {
             border-bottom: 2px solid var(--bidv-green);
        }
        .data-table .runner-summary-group .total-row td,
        .data-table .runner-summary-group .summary-row td {
            border-bottom: none;
        }
        .data-table .runner-summary-group .total-row {
            border-bottom: 1px solid #e2e8f0;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        input[type="date"] {
            position: relative;
        }
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-clear-button {
            display: none;
        }

        #scroll-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--bidv-green);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }

        #scroll-to-top-btn:hover {
            background-color: #005a57;
        }

        #custom-alert, #custom-confirm-modal, #training-suggestions-modal {
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        /* Collapsible content styles */
        .collapsible-content {
            max-height: 1000px; /* Arbitrarily large value for expanded state */
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        /* Add this rule to properly hide table bodies */
        tbody.collapsible-content.collapsed {
            display: none;
        }

        /* Custom Styles for Top Stats List */
        .top-stats-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .top-stats-list li:last-child {
            border-bottom: none;
        }
        .top-stats-icon {
            width: 24px;
            text-align: center;
            display: inline-block;
            margin-right: 8px;
        }

    </style>
</head>
<body>
    <header class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="Running-Management-logo.png" alt="Logo Den lu Running Club" class="h-20 w-auto rounded-md">
                <h1 class="text-2xl font-bold text-white">B√°o c√°o ho·∫°t ƒë·ªông ch·∫°y b·ªô - FOR RUNNER LOVER</h1>
            </div>
            <nav class="flex items-center space-x-4">
                <button id="back-to-home-btn" class="btn-primary">
                    <i class="fas fa-home"></i> Quay v·ªÅ
                </button>
                <button id="logout-btn" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <section id="report-dashboard" class="card mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center text-bidv-green">B√°o c√°o ho·∫°t ƒë·ªông</h2>
            <p id="user-info" class="text-lg font-medium text-center mb-6">Ch√†o m·ª´ng, <span id="current-user-email"></span>!</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- B·ªô l·ªçc -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700"><i class="fas fa-filter"></i> B·ªô l·ªçc b√°o c√°o</h3>
                    <div class="mb-4">
                        <label for="report-runner-filter" class="block text-gray-700 text-sm font-bold mb-2">Ch·ªçn Runner:</label>
                        <select id="report-runner-filter" class="form-input">
                            <option value="all">T·∫•t c·∫£ Runner</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ch·ªçn C√¢u l·∫°c b·ªô:</label>
                        <div class="multi-select-container">
                            <div id="multi-select-display-club" class="multi-select-selected-items">
                                <span class="text-gray-500">Ch·ªçn c√¢u l·∫°c b·ªô</span>
                            </div>
                            <div id="multi-select-options-club" class="multi-select-options hidden">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Lo·∫°i ho·∫°t ƒë·ªông:</label>
                        <div class="multi-select-container">
                            <div id="multi-select-display-report" class="multi-select-selected-items">
                                <span class="text-gray-500">Ch·ªçn lo·∫°i ho·∫°t ƒë·ªông</span>
                            </div>
                            <div id="multi-select-options-report" class="multi-select-options hidden">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="report-min-pace" class="block text-gray-700 text-sm font-bold mb-2">Pace (ph√∫t/km) nh·ªè h∆°n ho·∫∑c b·∫±ng:</label>
                        <input type="number" id="report-min-pace" class="form-input" placeholder="V√≠ d·ª•: 5.5 (5 ph√∫t 30 gi√¢y/km)" step="0.1">
                    </div>

                    <div class="mb-4">
                        <label for="report-min-distance" class="block text-gray-700 text-sm font-bold mb-2">Qu√£ng ƒë∆∞·ªùng (km) l·ªõn h∆°n ho·∫∑c b·∫±ng:</label>
                        <input type="number" id="report-min-distance" class="form-input" placeholder="V√≠ d·ª•: 10" step="0.1">
                    </div>

                    <div class="mb-4 flex gap-4">
                        <div class="flex-1">
                            <label for="report-start-date" class="block text-gray-700 text-sm font-bold mb-2">T·ª´ ng√†y:</label>
                            <input type="date" id="report-start-date" class="form-input">
                        </div>
                        <div class="flex-1">
                            <label for="report-end-date" class="block text-gray-700 text-sm font-bold mb-2">ƒê·∫øn ng√†y:</label>
                            <input type="date" id="report-end-date" class="form-input">
                        </div>
                    </div>
                    <button id="apply-report-filters-btn" class="btn-primary w-full">
                        √Åp d·ª•ng b·ªô l·ªçc
                    </button>
                    <div id="report-filter-status" class="mt-2 text-sm text-gray-600 text-center"></div>
                </div>

                <!-- T·ªïng quan th·ªëng k√™ -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">T·ªïng quan th·ªëng k√™</h2>
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-sm font-semibold mb-1">T·ªïng qu√£ng ƒë∆∞·ªùng</h2>
                            <p id="totalDistance" class="text-xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-sm font-semibold mb-1">T·ªïng th·ªùi gian</h2>
                            <p id="totalMovingTime" class="text-xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-sm font-semibold mb-1">Pace trung b√¨nh</h2>
                            <p id="averageOverallPace" class="text-xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-sm font-semibold mb-1">Ho·∫°t ƒë·ªông</h2>
                            <p id="totalActivities" class="text-xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow-md sm:col-span-2 md:col-span-2">
                            <h2 class="text-sm font-semibold mb-1">T·ªïng ƒë·ªô cao ƒë·∫°t ƒë∆∞·ª£c</h2>
                            <p id="totalElevationGain" class="text-xl font-bold">0 m</p>
                        </div>
                    </div>

                    <!-- Top Records Sections -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4">
                        <div>
                            <h3 class="text-md font-bold text-gray-700 mb-2 border-b pb-1"><i class="fas fa-route text-blue-500 mr-2"></i>2 Cu·ªôc ch·∫°y d√†i nh·∫•t</h3>
                            <ul id="longest-runs-list" class="top-stats-list text-sm text-gray-600">
                                <!-- JS will populate this -->
                                <li class="text-center italic text-gray-400">ƒêang t·∫£i...</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-md font-bold text-gray-700 mb-2 border-b pb-1"><i class="fas fa-bolt text-yellow-500 mr-2"></i>2 Cu·ªôc ch·∫°y nhanh nh·∫•t</h3>
                            <ul id="fastest-runs-list" class="top-stats-list text-sm text-gray-600">
                                <!-- JS will populate this -->
                                <li class="text-center italic text-gray-400">ƒêang t·∫£i...</li>
                            </ul>
                        </div>
                    </div>

                    <button id="get-training-suggestions-btn" class="btn-primary w-full mt-6 flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i> ‚ú®G·ª£i √Ω Luy·ªán t·∫≠p Th√¥ng minh
                        <span id="training-suggestions-loader" class="loader hidden"></span>
                    </button>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Qu√£ng ƒë∆∞·ªùng ch·∫°y theo ng√†y (km)</h2>
                    <div class="chart-container">
                        <canvas id="distanceChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Ph√¢n b·ªë t·ªëc ƒë·ªô trung b√¨nh (ph√∫t/km)</h2>
                    <div class="chart-container">
                        <canvas id="paceDistributionChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Nh·ªãp tim trung b√¨nh theo t·ªëc ƒë·ªô</h2>
                    <div class="chart-container">
                        <canvas id="heartRatePaceChart"></canvas>
                    </div>
                </div>
                <!-- New Chart: Average Heart Rate by Month -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Nh·ªãp tim trung b√¨nh theo th√°ng</h2>
                    <div class="chart-container">
                        <canvas id="monthlyHeartRateChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Ph√¢n lo·∫°i ho·∫°t ƒë·ªông</h2>
                    <div class="chart-container">
                        <canvas id="activityTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- D3.js Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-green-700">Qu√£ng ƒë∆∞·ªùng (KM) theo Runner</h3>
                    <div id="distance-by-runner-chart" class="mt-4 border rounded-md p-2 min-h-[150px] flex items-center justify-content-center">
                        <p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì qu√£ng ƒë∆∞·ªùng theo Runner s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-yellow-700">Qu√£ng ƒë∆∞·ªùng (KM) theo CLB</h3>
                    <div id="distance-by-club-chart" class="mt-4 border rounded-md p-2 min-h-[150px] flex items-center justify-content-center">
                        <p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì qu√£ng ƒë∆∞·ªùng theo CLB s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
                    </div>
                    <div id="distance-by-club-legend" class="mt-4 overflow-x-auto"></div>
                </div>
            </div>

            <!-- B·∫£ng chi ti·∫øt ho·∫°t ƒë·ªông (Collapsible) -->
            <div id="detailed-activities-section" class="card mt-8 p-6">
                <div class="flex justify-between items-center mb-4">
                    <div id="detailed-activities-header" class="flex items-center cursor-pointer">
                        <h3 class="text-xl font-semibold text-blue-700">
                            <i class="fas fa-list mr-2"></i> Chi ti·∫øt c√°c ho·∫°t ƒë·ªông
                        </h3>
                        <i id="detailed-activities-toggle-icon" class="fas fa-chevron-down text-gray-600 transition-transform duration-300 ml-2"></i>
                    </div>
                    <button id="download-detailed-activities-excel" class="btn-secondary ml-4">
                        <i class="fas fa-download mr-2"></i> T·∫£i Excel
                    </button>
                </div>
                <div id="detailed-activities-content" class="collapsible-content overflow-x-auto">
                    <table id="detailed-activities-table" class="data-table">
                        <thead>
                            <tr>
                                <th>T√™n Runner</th>
                                <th>CLB</th>
                                <th>T√™n ho·∫°t ƒë·ªông</th>
                                <th>Lo·∫°i</th>
                                <th>Ng√†y</th>
                                <th>Qu√£ng ƒë∆∞·ªùng (KM)</th>
                                <th>Th·ªùi gian</th>
                                <th>Pace</th>
                                <th>NƒÉng l∆∞·ª£ng (KJ)</th>
                                <th>Nh·ªãp tim TB</th>
                                <th>ƒê·ªô cao tƒÉng (m)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Ho·∫°t ƒë·ªông s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
                        </tbody>
                    </table>
                    <p id="detailed-activities-status" class="mt-4 text-sm text-gray-600 text-center">Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o ƒë·ªÉ hi·ªÉn th·ªã.</p>
                </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì th·ªëng k√™ theo tu·∫ßn -->
            <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-red-700"><i class="fas fa-chart-line"></i> Th·ªëng k√™ qu√£ng ƒë∆∞·ªùng theo tu·∫ßn</h3>
                <div id="weekly-distance-chart-container" class="border rounded-md p-2 min-h-[300px] flex items-center justify-content-center">
                    <p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì th·ªëng k√™ qu√£ng ƒë∆∞·ªùng theo tu·∫ßn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
                </div>
                <p id="weekly-chart-status" class="mt-4 text-sm text-gray-600 text-center"></p>
            </div>

             <!-- B·∫£ng th·ªëng k√™ chi ti·∫øt & Ti·ªÅn ph·∫°t/Th∆∞·ªüng -->
             <div class="card mt-8 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-teal-700"><i class="fas fa-calculator"></i> Th·ªëng k√™ ti·ªÅn ph·∫°t/th∆∞·ªüng</h3>
                    <button id="download-penalty-bonus-excel" class="btn-secondary ml-4">
                        <i class="fas fa-download mr-2"></i> T·∫£i Excel
                    </button>
                </div>
                <div class="mb-4 flex gap-4 items-end">
                    <div class="flex-1">
                        <label for="penalty-per-km-gt10" class="block text-gray-700 text-sm font-bold mb-2">S·ªë ti·ªÅn n·ªôp cho 1KM (ngh√¨n VNƒê) khi thi·∫øu > 10KM:</label>
                        <input type="number" id="penalty-per-km-gt10" class="form-input bg-yellow-100" value="30" min="0" step="1">
                    </div>
                    <div class="flex-1">
                        <label for="penalty-per-km-lte10" class="block text-gray-700 text-sm font-bold mb-2">S·ªë ti·ªÅn n·ªôp cho 1KM (ngh√¨n VNƒê) khi thi·∫øu <= 10KM:</label>
                        <input type="number" id="penalty-per-km-lte10" class="form-input bg-yellow-100" value="20" min="0" step="1">
                    </div>
                    <div class="flex-1">
                        <label for="target-km-per-week" class="block text-gray-700 text-sm font-bold mb-2">S·ªë KM m·ªôt tu·∫ßn (KM):</label>
                        <input type="number" id="target-km-per-week" class="form-input bg-yellow-100" value="25" min="0" step="1">
                    </div>
                </div>
                <div id="detailed-stats-table-container" class="overflow-x-auto">
                    <table id="penalty-bonus-table" class="data-table">
                        <thead>
                            <tr>
                                <th>T√™n Runner</th>
                                <th>Ng√†y ch·∫°y / Tu·∫ßn</th>
                                <th>T√™n Ho·∫°t ƒê·ªông</th>
                                <th>Lo·∫°i</th>
                                <th>Qu√£ng ƒë∆∞·ªùng (KM)</th>
                                <th>Pace / Ch√™nh l·ªách (KM)</th>
                                <th>Th·ªùi gian / Th∆∞·ªüng-Ph·∫°t</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="penalty-bonus-status" class="mt-4 text-sm text-gray-600 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</p>
            </div>


        </section>
    </main>

    <footer class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container" style="color: var(--bidv-yellow);">
            &copy; 2025 Tr∆∞∆°ng H·ªìng Qu√¢n - ƒê·ªÅn L·ª´ Running Club. All rights reserved (Dev by AIs - Gemini, GPT) - üìßquantrhvn@gmail.com - üì≥+84989073739 - 248064a v2.
            <br>
            <img src="PowerStrava.png" alt="PowerStrava Logo" style="height: 28px; margin: 5px auto 0 auto; display: block;">
        </div>
    </footer>

    <!-- Weekly Activities Modal -->
    <div id="weekly-activities-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="close-weekly-activities-modal-btn">&times;</span>
            <h3 id="weekly-activities-title" class="text-2xl font-bold mb-4 text-gray-800">Ho·∫°t ƒë·ªông trong tu·∫ßn:</h3>
            <div class="max-h-96 overflow-y-auto border rounded-md p-2">
                <ul id="weekly-activities-list" class="space-y-2 text-sm">
                    <!-- Activities will be loaded here -->
                </ul>
            </div>
            <p id="weekly-activities-status" class="mt-4 text-sm text-gray-600"></p>
        </div>
    </div>

    <!-- Training Suggestions Modal -->
    <div id="training-suggestions-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-button" id="close-training-suggestions-modal-btn">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">G·ª£i √Ω Luy·ªán t·∫≠p t·ª´ AI</h3>
            <div id="training-suggestions-content" class="prose max-w-none">
                <!-- AI suggestions will be loaded here -->
            </div>
            <p id="training-suggestions-status" class="mt-4 text-sm text-gray-600"></p>
        </div>
    </div>


    <!-- Custom Alert/Confirm Modals -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-content-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="alert-message" class="mb-4 text-lg"></p>
            <button id="alert-ok-btn" class="btn-primary">OK</button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-content-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="mb-4 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button type="button" id="confirm-cancel-btn" class="btn-primary">H·ªßy</button>
                <button type="button" id="confirm-ok-btn" class="btn-danger">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <button id="scroll-to-top-btn" title="Go to top">‚ñ≤</button>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Replace with your Supabase Anon Key

        const ANALYZE_ACTIVITIES_EDGE_FUNCTION_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/analyze-activities-with-gemini';


        let supabaseClientInstance;
        let allRunnerCredentials = []; 
        let allClubs = []; 
        let allActivitiesData = []; 

        // Filter states
        let selectedRunnerIdReport = 'all'; 
        let selectedClubNamesReport = []; 
        let selectedActivityTypesReport = []; 
        let minPaceFilter = null; 
        let minDistanceFilter = null; 

        // Chart.js instances
        let distanceChart, paceDistributionChart, heartRatePaceChart, activityTypeChart, monthlyHeartRateChart;

        // DOM Elements
        const currentUserEmailSpan = document.getElementById('current-user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');

        // Filter elements
        const reportRunnerFilter = document.getElementById('report-runner-filter');
        const multiSelectDisplayClub = document.getElementById('multi-select-display-club');
        const multiSelectOptionsClub = document.getElementById('multi-select-options-club');
        const multiSelectDisplayReport = document.getElementById('multi-select-display-report');
        const multiSelectOptionsReport = document.getElementById('multi-select-options-report');
        const reportMinPaceInput = document.getElementById('report-min-pace');
        const reportMinDistanceInput = document.getElementById('report-min-distance');
        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const applyReportFiltersBtn = document.getElementById('apply-report-filters-btn');
        const reportFilterStatus = document.getElementById('report-filter-status');
        
        // Summary stats elements
        const totalDistanceSpan = document.getElementById('totalDistance');
        const totalMovingTimeSpan = document.getElementById('totalMovingTime');
        const averageOverallPaceSpan = document.getElementById('averageOverallPace');
        const totalActivitiesSpan = document.getElementById('totalActivities');
        const totalElevationGainSpan = document.getElementById('totalElevationGain'); // New element
        const longestRunsList = document.getElementById('longest-runs-list'); // New element
        const fastestRunsList = document.getElementById('fastest-runs-list'); // New element

        // New Gemini API related elements
        const getTrainingSuggestionsBtn = document.getElementById('get-training-suggestions-btn');
        const trainingSuggestionsLoader = document.getElementById('training-suggestions-loader');
        const trainingSuggestionsModal = document.getElementById('training-suggestions-modal');
        const closeTrainingSuggestionsModalBtn = document.getElementById('close-training-suggestions-modal-btn');
        const trainingSuggestionsContent = document.getElementById('training-suggestions-content');
        const trainingSuggestionsStatus = document.getElementById('training-suggestions-status');


        // D3.js chart specific elements
        const distanceByRunnerChart = document.getElementById('distance-by-runner-chart'); 
        const distanceByClubChart = document.getElementById('distance-by-club-chart'); 

        // Detailed Activities Table elements
        const detailedActivitiesTableBody = document.querySelector('#detailed-activities-table tbody');
        const detailedActivitiesStatus = document.getElementById('detailed-activities-status');
        const downloadDetailedActivitiesExcelBtn = document.getElementById('download-detailed-activities-excel');


        // Weekly Distance Chart elements
        const weeklyDistanceChartContainer = document.getElementById('weekly-distance-chart-container');
        const weeklyChartStatus = document.getElementById('weekly-chart-status');

        // Penalty/Bonus Table elements
        const penaltyPerKmGt10Input = document.getElementById('penalty-per-km-gt10');
        const penaltyPerKmLte10Input = document.getElementById('penalty-per-km-lte10');
        const targetKmPerWeekInput = document.getElementById('target-km-per-week');
        const penaltyBonusTableBody = document.querySelector('#penalty-bonus-table tbody');
        const penaltyBonusStatus = document.getElementById('penalty-bonus-status');
        const downloadPenaltyBonusExcelBtn = document.getElementById('download-penalty-bonus-excel');


        // Weekly Activities Modal elements
        const weeklyActivitiesModal = document.getElementById('weekly-activities-modal');
        const closeWeeklyActivitiesModalBtn = document.getElementById('close-weekly-activities-modal-btn');
        const weeklyActivitiesTitle = document.getElementById('weekly-activities-title');
        const weeklyActivitiesList = document.getElementById('weekly-activities-list');
        const weeklyActivitiesStatus = document.getElementById('weekly-activities-status');

        // Collapsible section elements
        const detailedActivitiesSection = document.getElementById('detailed-activities-section');
        const detailedActivitiesHeader = document.getElementById('detailed-activities-header');
        const detailedActivitiesContent = document.getElementById('detailed-activities-content');
        const detailedActivitiesToggleIcon = document.getElementById('detailed-activities-toggle-icon');
        const DETAILED_ACTIVITIES_STATE_KEY = 'detailedActivitiesCollapsed';


        // All Activity Types
        const ALL_ACTIVITY_TYPES = [
            'Run', 'Walk', 'Ride', 'Swim', 'Hike', 'NordicSki', 'AlpineSki', 'Workout', 'Yoga', 
            'WeightTraining', 'Elliptical', 'StairStepper', 'Rowing', 'Crossfit', 'Canoeing', 
            'Kayaking', 'StandUpPaddling', 'VirtualRide', 'VirtualRun', 'Wheelchair', 'Handcycle', 
            'RollerSki', 'IceSkate', 'Snowboard', 'Snowshoe', 'BackcountrySki', 'EMountainBikeRide', 
            'EBikeRide', 'MountainBikeRide', 'GravelRide', 'Velomobile', 'Kitesurf', 'Windsurf', 
            'RockClimbing', 'Alpinism', 'Badminton', 'Squash', 'TableTennis', 'Tennis', 'Volleyball', 
            'Surfing', 'Pilates', 'Golf', 'WaterSport', 'Soccer', 'Basketball'
        ].sort();


        // --- Helper Functions ---

        function showAlert(message) {
            const customAlert = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
            customAlert.style.display = 'flex'; 

            alertOkBtn.onclick = () => {
                customAlert.classList.add('hidden');
                customAlert.style.display = 'none'; 
            };
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const customConfirm = document.getElementById('custom-confirm-modal');
                const confirmMessage = document.getElementById('confirm-message');
                const confirmOkBtn = document.getElementById('confirm-ok-btn'); 
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                confirmMessage.textContent = message;
                customConfirm.classList.remove('hidden');
                customConfirm.style.display = 'flex'; 

                const cleanup = () => {
                    customConfirm.classList.add('hidden');
                    customConfirm.style.display = 'none'; 
                    confirmOkBtn.onclick = null;
                    confirmCancelBtn.onclick = null;
                };

                confirmOkBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                confirmCancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        function formatTime(seconds) {
            if (seconds === null || isNaN(seconds)) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s]
                .map(v => v < 10 ? '0' + v : v)
                .filter((v, i) => v !== '00' || i > 0)
                .join(':') || '00:00';
        }

        function formatPaceLabel(totalSeconds) {
            if (totalSeconds === null || isNaN(totalSeconds) || totalSeconds < 0) {
                return 'N/A';
            }
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);
            const formatted = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            return formatted;
        }

        function formatPace(speedMs) {
            if (speedMs === null || isNaN(speedMs) || speedMs <= 0) {
                return 'N/A';
            }
            const paceSecondsPerKm = 1000 / speedMs; 

            if (paceSecondsPerKm < 0.5) { 
                return 'N/A'; 
            }

            const formatted = `${formatPaceLabel(paceSecondsPerKm)} /km`;
            return formatted;
        }
        
        function formatPaceForTable(metersPerSecond) {
            if (typeof metersPerSecond !== 'number' || isNaN(metersPerSecond) || metersPerSecond <= 0) {
                return 'N/A';
            }
            const kmPerHour = (metersPerSecond * 3.6); 
            if (kmPerHour === 0) {
                return 'N/A';
            }
            const minutesPerKm = 60 / kmPerHour; 

            if (minutesPerKm < (0.5 / 60)) { 
                return 'N/A'; 
            }

            const minutes = Math.floor(minutesPerKm);
            const seconds = Math.round((minutesPerKm - minutes) * 60);
            return `${minutes}:${String(seconds).padStart(2, '0')} /km`;
        }

        function formatElevationGain(meters) {
            if (meters === null || isNaN(meters)) return 'N/A';
            return `${Math.round(meters)} m`;
        }
        
        function formatKilojoules(kilojoules) {
            if (kilojoules === null || isNaN(kilojoules) || kilojoules === 0) return 'N/A';
            return Math.round(kilojoules);
        }

        function formatKilojoulesDisplay(kilojoules) {
            if (kilojoules === null || isNaN(kilojoules) || kilojoules === 0) return 'N/A';
            return `${Math.round(kilojoules).toLocaleString('vi-VN')} KJ`;
        }
        
        function populateActivityTypeFilter() {
            multiSelectOptionsReport.innerHTML = ''; 
            ALL_ACTIVITY_TYPES.forEach(type => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.textContent = type;
                optionDiv.dataset.value = type;
                multiSelectOptionsReport.appendChild(optionDiv);
            });
        }
        
        function populateClubFilter() {
            multiSelectOptionsClub.innerHTML = '';
            allClubs.forEach(club => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.textContent = club.name;
                optionDiv.dataset.value = club.name;
                multiSelectOptionsClub.appendChild(optionDiv);
            });
        }

        function updateMultiSelectDisplay(displayElement, selectedItems, optionsContainer, placeholder) {
            displayElement.innerHTML = '';
            if (selectedItems.length === 0) {
                displayElement.innerHTML = `<span class="text-gray-500">${placeholder}</span>`;
            } else {
                selectedItems.forEach(item => {
                    const itemSpan = document.createElement('span');
                    itemSpan.className = 'multi-select-selected-item';
                    itemSpan.innerHTML = `${item} <span data-value="${item}" class="remove-item-btn">&times;</span>`;
                    displayElement.appendChild(itemSpan);
                });
            }

            Array.from(optionsContainer.children).forEach(optionDiv => {
                if (selectedItems.includes(optionDiv.dataset.value)) {
                    optionDiv.classList.add('selected');
                } else {
                    optionDiv.classList.remove('selected');
                }
            });
        }

        function toggleItemInList(item, selectedItemsArray, displayElement, optionsContainer, placeholder) {
            const index = selectedItemsArray.indexOf(item);
            if (index > -1) {
                selectedItemsArray.splice(index, 1); 
            } else {
                selectedItemsArray.push(item); 
                selectedItemsArray.sort(); 
            }
            updateMultiSelectDisplay(displayElement, selectedItemsArray, optionsContainer, placeholder);
        }

        // Event delegation for all multi-select components
        document.addEventListener('click', (event) => {
            if (event.target.closest('#multi-select-display-report')) {
                multiSelectOptionsReport.classList.toggle('hidden');
            } else if (!event.target.closest('#multi-select-options-report')) {
                multiSelectOptionsReport.classList.add('hidden');
            }

            if (event.target.closest('#multi-select-display-club')) {
                multiSelectOptionsClub.classList.toggle('hidden');
            } else if (!event.target.closest('#multi-select-options-club')) {
                multiSelectOptionsClub.classList.add('hidden');
            }

            if (event.target.classList.contains('multi-select-option')) {
                const value = event.target.dataset.value;
                if (event.target.closest('#multi-select-options-report')) {
                    toggleItemInList(value, selectedActivityTypesReport, multiSelectDisplayReport, multiSelectOptionsReport, 'Ch·ªçn lo·∫°i ho·∫°t ƒë·ªông');
                } else if (event.target.closest('#multi-select-options-club')) {
                    toggleItemInList(value, selectedClubNamesReport, multiSelectDisplayClub, multiSelectOptionsClub, 'Ch·ªçn c√¢u l·∫°c b·ªô');
                }
            } else if (event.target.classList.contains('remove-item-btn')) {
                const value = event.target.dataset.value;
                if (event.target.closest('#multi-select-display-report')) {
                    toggleItemInList(value, selectedActivityTypesReport, multiSelectDisplayReport, multiSelectOptionsReport, 'Ch·ªçn lo·∫°i ho·∫°t ƒë·ªông');
                } else if (event.target.closest('#multi-select-display-club')) {
                    toggleItemInList(value, selectedClubNamesReport, multiSelectDisplayClub, multiSelectOptionsClub, 'Ch·ªçn c√¢u l·∫°c b·ªô');
                }
            }
        });


        async function fetchAllRunnerCredentials() {
            try {
                const { data, error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('*')
                    .order('runner_name', { ascending: true });
                if (error) throw error;
                allRunnerCredentials = data;
                console.log('Fetched all runner credentials for report:', allRunnerCredentials);
            } catch (error) {
                console.error('Error fetching all runner credentials:', error.message);
                showAlert(`L·ªói khi t·∫£i th√¥ng tin runner: ${error.message}`);
                allRunnerCredentials = [];
            }
        }

        async function fetchClubs() {
            try {
                const { data, error } = await supabaseClientInstance
                    .from('clubs')
                    .select('*')
                    .order('name', { ascending: true });
                if (error) throw error;
                allClubs = data;
                console.log('Fetched clubs for report:', allClubs);
            } catch (error) {
                console.error('Error fetching clubs for report:', error.message);
                showAlert(`L·ªói khi t·∫£i danh s√°ch c√¢u l·∫°c b·ªô: ${error.message}`);
                allClubs = [];
            }
        }

        function populateFilters() {
            // Populate Runner filter
            reportRunnerFilter.innerHTML = '<option value="all">T·∫•t c·∫£ Runner</option>';
            allRunnerCredentials.forEach(cred => {
                const option = document.createElement('option');
                option.value = String(cred.athlete_id); 
                option.textContent = cred.runner_name;
                reportRunnerFilter.appendChild(option);
            });
            reportRunnerFilter.value = selectedRunnerIdReport; 

            // Populate Club filter
            populateClubFilter();
            updateMultiSelectDisplay(multiSelectDisplayClub, selectedClubNamesReport, multiSelectOptionsClub, 'Ch·ªçn c√¢u l·∫°c b·ªô');

            // Initialize activity type filter
            populateActivityTypeFilter();
            updateMultiSelectDisplay(multiSelectDisplayReport, selectedActivityTypesReport, multiSelectOptionsReport, 'Ch·ªçn lo·∫°i ho·∫°t ƒë·ªông');

            // Restore pace and distance filter values
            reportMinPaceInput.value = minPaceFilter !== null ? minPaceFilter : '';
            reportMinDistanceInput.value = minDistanceFilter !== null ? minDistanceFilter : '';
        }

        async function fetchAndRenderReportData() {
            reportFilterStatus.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu b√°o c√°o...';
            allActivitiesData = []; 

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y phi√™n ƒëƒÉng nh·∫≠p Supabase. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                }

                // Prepare filters
                let queryRunnerIds = [];
                if (selectedRunnerIdReport === 'all') {
                    queryRunnerIds = allRunnerCredentials.filter(c => c.athlete_id).map(c => String(c.athlete_id));
                } else {
                    queryRunnerIds = [selectedRunnerIdReport];
                }

                if (selectedClubNamesReport.length > 0) {
                    const runnersInSelectedClubs = allRunnerCredentials.filter(
                        c => selectedClubNamesReport.includes(c.running_team) && c.athlete_id
                    ).map(c => String(c.athlete_id));
                    queryRunnerIds = queryRunnerIds.filter(id => runnersInSelectedClubs.includes(id));
                }

                if (queryRunnerIds.length === 0) {
                    reportFilterStatus.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã v·ªõi c√°c b·ªô l·ªçc ƒë√£ ch·ªçn. Vui l√≤ng ƒëi·ªÅu ch·ªânh b·ªô l·ªçc.';
                    renderAllReports(); 
                    return;
                }

                let query = supabaseClientInstance
                    .from('activities')
                    .select('strava_activity_id, name, type, distance, moving_time, total_elevation_gain, start_date, average_speed, average_heartrate, user_id, data')
                    .in('user_id', queryRunnerIds); 

                if (selectedActivityTypesReport.length > 0) {
                    query = query.in('type', selectedActivityTypesReport);
                }

                if (minPaceFilter !== null && minPaceFilter > 0) {
                    const minSpeedMs = 1000 / (minPaceFilter * 60);
                    query = query.gte('average_speed', minSpeedMs); 
                }

                if (minDistanceFilter !== null && minDistanceFilter > 0) {
                    query = query.gte('distance', minDistanceFilter * 1000); 
                }

                if (reportStartDateInput.value) {
                    const selectedStartDate = new Date(reportStartDateInput.value);
                    selectedStartDate.setHours(0, 0, 0, 0); 
                    query = query.gte('start_date', selectedStartDate.toISOString());
                }
                
                if (reportEndDateInput.value) {
                    const selectedEndDate = new Date(reportEndDateInput.value);
                    selectedEndDate.setHours(23, 59, 59, 999); 
                    query = query.lte('start_date', selectedEndDate.toISOString());
                }

                query = query.order('start_date', { ascending: false });

                const { data, error } = await query;

                if (error) throw error;
                
                allActivitiesData = data.map(activity => ({
                    ...activity,
                    kilojoules: activity.data ? activity.data.kilojoules : null,
                    data: undefined, 
                    start_date: new Date(activity.start_date), 
                    distance_km: (activity.distance / 1000).toFixed(2), 
                    moving_time_formatted: formatTime(activity.moving_time),
                    pace_seconds_per_km_raw: (activity.average_speed !== null && activity.average_speed > 0) ? (1000 / activity.average_speed) : null,
                    pace_min_per_km_formatted: formatPaceForTable(activity.average_speed) 
                }));

                reportFilterStatus.textContent = `ƒê√£ t·∫£i ${allActivitiesData.length} ho·∫°t ƒë·ªông.`;
                renderAllReports(); 
                
            } catch (error) {
                console.error('Error fetching report data:', error.message);
                reportFilterStatus.textContent = `L·ªói khi t·∫£i b√°o c√°o: ${error.message}`;
                showAlert(`L·ªói khi t·∫£i b√°o c√°o: ${error.message}`);
                allActivitiesData = []; 
                renderAllReports(); 
            }
        }


        function renderAllReports() {
            // 1. Render Overall Stats
            let totalActivities = allActivitiesData.length;
            let totalDistance = 0; 
            let totalMovingTime = 0; 
            let totalElevationGain = 0; // New variable

            allActivitiesData.forEach(activity => {
                totalDistance += activity.distance || 0;
                totalMovingTime += activity.moving_time || 0;
                totalElevationGain += activity.total_elevation_gain || 0; // Sum elevation gain
            });

            totalActivitiesSpan.textContent = totalActivities;
            totalDistanceSpan.textContent = `${(totalDistance / 1000).toFixed(2)} KM`;
            totalMovingTimeSpan.textContent = formatTime(totalMovingTime);
            totalElevationGainSpan.textContent = `${Math.round(totalElevationGain)} m`; // Display total gain

            // Calculate overall average pace
            let averageOverallPaceFormatted = 'N/A';
            if (totalDistance > 0 && totalMovingTime > 0) {
                const overallAverageSpeedMs = totalDistance / totalMovingTime; 
                averageOverallPaceFormatted = formatPace(overallAverageSpeedMs);
            }
            averageOverallPaceSpan.textContent = averageOverallPaceFormatted;

            // Render Top Runs Summary (Longest and Fastest)
            renderTopActivities(allActivitiesData);

            // 2. Render Detailed Activities Table
            renderDetailedActivitiesTable(allActivitiesData);

            // 3. Render Weekly Distance Chart (D3.js)
            renderWeeklyDistanceChart(allActivitiesData);

            // 4. Render Penalty/Bonus Table
            renderPenaltyBonusTable(allActivitiesData);

            // 5. Render Distance by Runner/Club Chart (D3.js)
            renderDistanceCharts(allActivitiesData);

            // 6. Render Chart.js Charts
            renderChartJSCharts(allActivitiesData);
        }

        // New function to find and render top activities
        function renderTopActivities(data) {
            // Find 2 longest runs
            const longestRuns = [...data]
                .sort((a, b) => b.distance - a.distance)
                .slice(0, 2);

            longestRunsList.innerHTML = '';
            if (longestRuns.length === 0) {
                longestRunsList.innerHTML = '<li class="text-center italic text-gray-400">Kh√¥ng c√≥ d·ªØ li·ªáu</li>';
            } else {
                longestRuns.forEach(run => {
                    const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(run.user_id));
                    const runnerName = runner ? runner.runner_name : 'Runner';
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-700 w-1/3 truncate" title="${runnerName}">${runnerName}</span>
                            <span class="font-bold text-blue-600 w-1/3 text-center">${(run.distance / 1000).toFixed(2)} km</span>
                            <span class="text-xs text-gray-400 w-1/3 text-right">${run.start_date.toLocaleDateString('vi-VN')}</span>
                        </div>
                    `;
                    longestRunsList.appendChild(li);
                });
            }

            // Find 2 fastest runs (based on average_speed)
            const fastestRuns = [...data]
                .filter(run => run.average_speed > 0)
                .sort((a, b) => b.average_speed - a.average_speed)
                .slice(0, 2);

            fastestRunsList.innerHTML = '';
            if (fastestRuns.length === 0) {
                fastestRunsList.innerHTML = '<li class="text-center italic text-gray-400">Kh√¥ng c√≥ d·ªØ li·ªáu</li>';
            } else {
                fastestRuns.forEach(run => {
                    const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(run.user_id));
                    const runnerName = runner ? runner.runner_name : 'Runner';
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-700 w-1/3 truncate" title="${runnerName}">${runnerName}</span>
                            <span class="font-bold text-yellow-600 w-1/3 text-center">${formatPaceForTable(run.average_speed)}</span>
                            <span class="text-xs text-gray-400 w-1/3 text-right">${run.start_date.toLocaleDateString('vi-VN')}</span>
                        </div>
                    `;
                    fastestRunsList.appendChild(li);
                });
            }
        }
        
        function renderChartJSCharts(data) {
            renderDistanceChart(data);
            renderPaceDistributionChart(data);
            renderHeartRatePaceChart(data);
            renderMonthlyHeartRateChart(data); // Call the new chart renderer
            renderActivityTypeChart(data);
        }

        // New function to render Monthly Heart Rate Chart
        function renderMonthlyHeartRateChart(data) {
            const ctx = document.getElementById('monthlyHeartRateChart').getContext('2d');

            // 1. Group by Month (YYYY-MM) and calculate average HR
            const monthlyStats = {}; // { '2023-10': { sum: 0, count: 0 }, ... }

            data.forEach(activity => {
                // Only consider activities with valid heart rate
                if (activity.average_heartrate && activity.average_heartrate > 0) {
                    const date = new Date(activity.start_date);
                    // Format: YYYY-MM
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyStats[monthKey]) {
                        monthlyStats[monthKey] = { sum: 0, count: 0 };
                    }
                    monthlyStats[monthKey].sum += activity.average_heartrate;
                    monthlyStats[monthKey].count += 1;
                }
            });

            // 2. Prepare sorted data for chart
            const labels = Object.keys(monthlyStats).sort(); // Sort chronological
            const hrData = labels.map(month => {
                const stats = monthlyStats[month];
                return (stats.sum / stats.count).toFixed(1);
            });

            // 3. Render Chart
            if (monthlyHeartRateChart) {
                monthlyHeartRateChart.destroy();
            }

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText("Kh√¥ng c√≥ d·ªØ li·ªáu nh·ªãp tim ƒë·ªÉ hi·ªÉn th·ªã.", 10, 50);
                return;
            }

            monthlyHeartRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nh·ªãp tim trung b√¨nh (bpm)',
                        data: hrData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgb(255, 99, 132)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(255, 99, 132)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Nh·ªãp tim TB: ${context.parsed.y} bpm`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Th√°ng',
                                color: '#4b5563'
                            },
                            ticks: { color: '#4b5563' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Nh·ªãp tim (bpm)',
                                color: '#4b5563'
                            },
                            beginAtZero: false, // Often HR doesn't start at 0, looks better
                            ticks: { color: '#4b5563' }
                        }
                    }
                }
            });
        }

        function renderDetailedActivitiesTable(activities) {
            detailedActivitiesTableBody.innerHTML = '';
            if (activities.length === 0) {
                detailedActivitiesStatus.textContent = 'Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o ƒë·ªÉ hi·ªÉn th·ªã.';
                return;
            }
            detailedActivitiesStatus.textContent = '';

            activities.forEach(activity => {
                const row = detailedActivitiesTableBody.insertRow();
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                const runnerName = runner ? runner.runner_name : 'N/A';
                const runnerClub = runner ? runner.running_team : 'N/A';

                row.innerHTML = `
                    <td>${runnerName}</td>
                    <td>${runnerClub}</td>
                    <td>${activity.name}</td>
                    <td>${activity.type}</td>
                    <td>${new Date(activity.start_date).toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'short' })}</td>
                    <td>${(activity.distance / 1000).toFixed(2)}</td>
                    <td>${formatTime(activity.moving_time)}</td>
                    <td>${formatPaceForTable(activity.average_speed)}</td>
                    <td>${formatKilojoules(activity.kilojoules)}</td>
                    <td>${activity.average_heartrate ? activity.average_heartrate.toFixed(0) : 'N/A'}</td>
                    <td>${formatElevationGain(activity.total_elevation_gain)}</td>
                `;
            });
        }

        function renderWeeklyDistanceChart(activities) {
            weeklyDistanceChartContainer.innerHTML = '';
            weeklyChartStatus.textContent = '';

            if (activities.length === 0) {
                weeklyDistanceChartContainer.innerHTML = '<p class="text-gray-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì th·ªëng k√™ theo tu·∫ßn.</p>';
                return;
            }

            const weeklyAggregatedData = new Map(); 
            const weeklyDetailedActivities = new Map(); 

            activities.forEach(activity => {
                const isoWeek = getISOWeekString(activity.start_date);
                if (isoWeek) {
                    weeklyAggregatedData.set(isoWeek, (weeklyAggregatedData.get(isoWeek) || 0) + activity.distance);

                    if (!weeklyDetailedActivities.has(isoWeek)) {
                        weeklyDetailedActivities.set(isoWeek, []);
                    }
                    weeklyDetailedActivities.get(isoWeek).push({ ...activity, athlete_id: activity.user_id }); 
                }
            });

            const weeklyStats = Array.from(weeklyAggregatedData.entries()).map(([week, totalDistance]) => ({
                week: week,
                totalDistance: totalDistance, 
            })).sort((a, b) => a.week.localeCompare(b.week));


            if (weeklyStats.length === 0) {
                weeklyDistanceChartContainer.innerHTML = '<p class="text-gray-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì th·ªëng k√™ theo tu·∫ßn.</p>';
                return;
            }

            const container = weeklyDistanceChartContainer;
            const width = container.clientWidth;
            const height = 300; 

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxDistance = d3.max(weeklyStats, d => d.totalDistance);
            const minDistance = d3.min(weeklyStats, d => d.totalDistance);

            if (typeof d3.scaleSequential !== 'function' || typeof d3.interpolateViridis !== 'function') {
                console.error("D3 scales or interpolators are not available. Cannot draw weekly distance chart.");
                weeklyDistanceChartContainer.innerHTML = `<p class="text-red-500 text-center">L·ªói: Kh√¥ng th·ªÉ v·∫Ω bi·ªÉu ƒë·ªì. Th∆∞ vi·ªán D3.js ho·∫∑c c√°c th√†nh ph·∫ßn c·ªßa n√≥ kh√¥ng kh·∫£ d·ª•ng.</p>`;
                return; 
            }

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxDistance || 1])
                .range([10, 40]);

            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxDistance || 1, minDistance || 0]);

            const x = d3.scaleBand()
                .domain(weeklyStats.map(d => d.week)) 
                .range([50, width - 20])
                .paddingInner(0.1);

            const y = d3.scaleLinear()
                .domain([0, maxDistance * 1.2 || 10000]) 
                .range([height - 50, 20]);

            const xAxis = d3.axisBottom(x).tickFormat(d => {
                const parts = d.split('-W');
                return `W${parts[1]}-${parts[0]}`; 
            });
            const yAxis = d3.axisLeft(y).tickFormat(d => `${(d / 1000).toFixed(0)}km`);

            svg.append("g")
                .attr("transform", `translate(0, ${height - 50})`)
                .call(xAxis)
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .attr("transform", `translate(50, 0)`)
                .call(yAxis);

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            svg.selectAll(".bubble")
                .data(weeklyStats)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => x(d.week) + x.bandwidth() / 2) 
                .attr("cy", d => y(d.totalDistance))
                .attr("r", d => radiusScale(d.totalDistance))
                .attr("fill", d => colorScale(d.totalDistance))
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`Tu·∫ßn: ${d.week.replace(/-W/, 'W')}<br>T·ªïng qu√£ng ƒë∆∞·ªùng: ${(d.totalDistance / 1000).toFixed(2)} km`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                })
                .on("click", function(event, d) {
                    const activitiesInWeek = weeklyDetailedActivities.get(d.week) || [];
                    weeklyActivitiesTitle.textContent = `Ho·∫°t ƒë·ªông trong tu·∫ßn ${d.week.replace(/-W/, 'W')}:`;
                    displayActivitiesInModal(activitiesInWeek); 
                });

            svg.selectAll(".weekly-bubble-text")
                .data(weeklyStats)
                .enter().append("text")
                .attr("class", "weekly-bubble-text")
                .attr("x", d => x(d.week) + x.bandwidth() / 2)
                .attr("y", d => d.y)
                .text(d => `${(d.totalDistance / 1000).toFixed(0)}km`) 
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .attr("font-size", d => Math.max(8, radiusScale(d.totalDistance) / 3)) 
                .attr("fill", "black") 
                .attr("pointer-events", "none");

            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height - 10})`)
                .style("text-anchor", "middle")
                .text("Tu·∫ßn");

            svg.append("text")
                .attr("transform", `rotate(-90) translate(-${height / 2}, 15)`)
                .style("text-anchor", "middle")
                .text("Qu√£ng ƒë∆∞·ªùng (KM)");
        }

        function getISOWeekString(d) {
            let activityDateUtc;

            if (typeof d === 'string') {
                activityDateUtc = new Date(d);
            } else if (d instanceof Date) {
                activityDateUtc = d;
            } else {
                console.error("Invalid date input for getISOWeekString:", d);
                return null;
            }

            if (isNaN(activityDateUtc.getTime())) {
                console.error("Invalid Date object after parsing in getISOWeekString:", d);
                return null;
            }

            const formatter = new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                timeZone: 'Asia/Ho_Chi_Minh',
                hour12: false 
            });

            const parts = formatter.formatToParts(activityDateUtc);
            let year, month, day, hour = 0, minute = 0, second = 0;

            parts.forEach(p => {
                switch (p.type) {
                    case 'year': year = parseInt(p.value); break;
                    case 'month': month = parseInt(p.value); break;
                    case 'day': day = parseInt(p.value); break;
                    case 'hour': hour = parseInt(p.value); break;
                    case 'minute': minute = parseInt(p.value); break;
                    case 'second': second = parseInt(p.value); break;
                }
            });

            const vietnamAlignedUtcDate = new Date(Date.UTC(year, month - 1, day, hour, minute, second));
            vietnamAlignedUtcDate.setUTCHours(0, 0, 0, 0);

            const dayOfVietnamWeekUtc = vietnamAlignedUtcDate.getUTCDay() || 7; 
            vietnamAlignedUtcDate.setUTCDate(vietnamAlignedUtcDate.getUTCDate() + 4 - dayOfVietnamWeekUtc);

            const isoWeekYear = vietnamAlignedUtcDate.getUTCFullYear();
            const yearStart = new Date(Date.UTC(isoWeekYear, 0, 1));
            const weekNo = Math.ceil((((vietnamAlignedUtcDate - yearStart) / 86400000) + 1) / 7);

            return `${isoWeekYear}-W${String(weekNo).padStart(2, '0')}`;
        }

        function displayActivitiesInModal(activitiesToDisplay) {
            weeklyActivitiesList.innerHTML = '';
            weeklyActivitiesStatus.textContent = '';
            weeklyActivitiesModal.style.display = 'flex'; 

            if (activitiesToDisplay.length > 0) {
                activitiesToDisplay.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
                activitiesToDisplay.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'border-b last:border-b-0 py-2';
                    const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                    const runnerName = runner ? runner.runner_name : 'N/A';

                    li.innerHTML = `
                        <p class="font-semibold">${runnerName}: ${activity.name} (${activity.type})</p>
                        <p class="text-sm text-gray-600">Ng√†y: ${new Date(activity.start_date).toLocaleDateString('vi-VN')}</p>
                        <p class="text-sm text-gray-600">Qu√£ng ƒë∆∞·ªùng: ${(activity.distance / 1000).toFixed(2)} km</p>
                        <p class="text-sm text-gray-600">Th·ªùi gian: ${formatTime(activity.moving_time)}</p>
                        <p class="text-sm text-gray-600">Pace: ${formatPaceForTable(activity.average_speed)}</p>
                        <p class="text-sm text-gray-600">NƒÉng l∆∞·ª£ng: ${formatKilojoulesDisplay(activity.kilojoules)}</p>
                        ${activity.strava_activity_id ? `<button class="btn-primary mt-2 text-xs px-2 py-1 view-map-btn" data-activity-id="${activity.strava_activity_id}">Xem b·∫£n ƒë·ªì</button>` : ''}
                    `;
                    weeklyActivitiesList.appendChild(li);
                });
                weeklyActivitiesStatus.textContent = `ƒê√£ t·∫£i ${activitiesToDisplay.length} ho·∫°t ƒë·ªông cho tu·∫ßn n√†y.`;
                document.querySelectorAll('#weekly-activities-modal .view-map-btn').forEach(button => {
                    button.onclick = (e) => {
                        const activityId = e.target.dataset.activityId;
                        if (activityId) {
                            window.open(`https://www.strava.com/activities/${activityId}`, '_blank');
                        }
                    };
                });
            } else {
                weeklyActivitiesStatus.textContent = 'Kh√¥ng t√¨m th·∫•y ho·∫°t ƒë·ªông n√†o cho tu·∫ßn n√†y.';
            }
        }

        function renderPenaltyBonusTable(activities) {
            const table = document.getElementById('penalty-bonus-table');
            table.querySelectorAll('tbody').forEach(tbody => tbody.remove());

            const penaltyBonusStatus = document.getElementById('penalty-bonus-status');
            penaltyBonusStatus.textContent = '';

            if (activities.length === 0) {
                penaltyBonusStatus.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.';
                return;
            }

            const penaltyPerKmGt10 = parseFloat(penaltyPerKmGt10Input.value) || 0;
            const penaltyPerKmLte10 = parseFloat(penaltyPerKmLte10Input.value) || 0;
            const targetKmPerWeek = parseFloat(targetKmPerWeekInput.value) || 0;

            const activitiesByAthlete = activities.reduce((acc, activity) => {
                const athleteId = String(activity.user_id);
                if (!acc[athleteId]) {
                    acc[athleteId] = [];
                }
                acc[athleteId].push(activity);
                return acc;
            }, {});

            const sortedAthleteIds = Object.keys(activitiesByAthlete).sort((a, b) => {
                const runnerA = allRunnerCredentials.find(rc => String(rc.athlete_id) === a);
                const runnerB = allRunnerCredentials.find(rc => String(rc.athlete_id) === b);
                return (runnerA?.runner_name || '').localeCompare(runnerB?.runner_name || '');
            });

            if (sortedAthleteIds.length === 0) {
                penaltyBonusStatus.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.';
                return;
            }
            
            table.removeEventListener('click', handlePenaltyTableClick); 
            table.addEventListener('click', handlePenaltyTableClick);

            sortedAthleteIds.forEach(athleteId => {
                const runnerInfo = allRunnerCredentials.find(rc => String(rc.athlete_id) === athleteId);
                const runnerName = runnerInfo?.runner_name || `Runner ID: ${athleteId}`;
                const runnerClub = runnerInfo?.running_team || 'N/A';
                const runnerActivities = activitiesByAthlete[athleteId];

                const weeklyStats = {};
                runnerActivities.forEach(activity => {
                    const isoWeek = getISOWeekString(activity.start_date);
                    if (!weeklyStats[isoWeek]) {
                        weeklyStats[isoWeek] = { activities: [], totalKm: 0 };
                    }
                    weeklyStats[isoWeek].activities.push(activity);
                    weeklyStats[isoWeek].totalKm += (activity.distance / 1000);
                });

                let totalRunnerKm = 0;
                let totalRunnerAmount = 0;
                
                Object.values(weeklyStats).forEach(week => {
                    totalRunnerKm += week.totalKm;
                    const kmDifference = week.totalKm - targetKmPerWeek;
                    week.kmDifference = kmDifference;
                    if (kmDifference < 0) {
                        const deficitKm = Math.abs(kmDifference);
                        let rate = (deficitKm <= 10) ? penaltyPerKmLte10 : penaltyPerKmGt10;
                        week.penaltyBonus = -(deficitKm * rate);
                        totalRunnerAmount += week.penaltyBonus;
                    } else {
                        week.penaltyBonus = 0; 
                    }
                });
                
                const summaryTbody = document.createElement('tbody');
                summaryTbody.className = 'runner-summary-group';
                summaryTbody.innerHTML = `
                    <tr class="total-row">
                        <td colspan="4" class="font-bold text-lg text-bidv-green">
                            ${runnerName} <span class="text-gray-500 text-base">(${runnerClub})</span>
                            <i class="fas fa-chevron-right text-gray-600 ml-2 cursor-pointer penalty-toggle-icon" data-target-tbody-id="penalty-details-for-${athleteId}"></i>
                        </td>
                        <td colspan="3" class="text-right font-bold text-lg">${totalRunnerKm.toFixed(2)} KM</td>
                    </tr>
                    <tr class="${totalRunnerAmount < 0 ? 'missing-row' : 'summary-row'}">
                        <td colspan="7" class="text-right font-bold text-lg">
                            T·ªïng c·ªông Ph·∫°t/Th∆∞·ªüng: 
                            <span class="${totalRunnerAmount < 0 ? 'text-red-600' : 'text-green-600'}">
                                ${totalRunnerAmount.toLocaleString('vi-VN')} ngh√¨n VNƒê
                            </span>
                        </td>
                    </tr>
                `;
                table.appendChild(summaryTbody);

                const detailedTbody = document.createElement('tbody');
                detailedTbody.id = `penalty-details-for-${athleteId}`;
                detailedTbody.className = 'hidden'; 
                
                const sortedWeeks = Object.keys(weeklyStats).sort().reverse();
                sortedWeeks.forEach(isoWeek => {
                    const weekData = weeklyStats[isoWeek];
                    const weekTargetClass = `week-details-for-${athleteId}-${isoWeek.replace(/\W/g, '')}`;
                    
                    const weekSummaryRow = document.createElement('tr');
                    weekSummaryRow.className = 'weekly-summary-row bg-gray-100 hover:bg-gray-200 cursor-pointer';
                    weekSummaryRow.innerHTML = `
                        <td></td> 
                        <td class="font-bold">
                            ${isoWeek.replace('-W', ' Tu·∫ßn ')}
                            <i class="fas fa-chevron-right text-gray-600 ml-2 cursor-pointer week-toggle-icon" data-week-target-class="${weekTargetClass}"></i>
                        </td>
                        <td colspan="2" class="font-bold text-center">T·ªîNG K·∫æT TU·∫¶N</td>
                        <td class="font-bold text-center">${weekData.totalKm.toFixed(2)}</td>
                        <td class="font-bold text-center ${weekData.kmDifference < 0 ? 'text-red-500' : 'text-green-500'}">
                            ${weekData.kmDifference >= 0 ? '+' : ''}${weekData.kmDifference.toFixed(2)}
                        </td>
                        <td class="font-bold text-center ${weekData.penaltyBonus < 0 ? 'text-red-600' : 'text-green-600'}">
                            ${weekData.penaltyBonus.toLocaleString('vi-VN')}
                        </td>
                    `;
                    detailedTbody.appendChild(weekSummaryRow);

                    weekData.activities.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
                    weekData.activities.forEach(activity => {
                        const activityRow = document.createElement('tr');
                        activityRow.className = `weekly-activity-row ${weekTargetClass} hidden bg-white`; 
                        activityRow.innerHTML = `
                            <td></td>
                            <td>${new Date(activity.start_date).toLocaleDateString('vi-VN')}</td>
                            <td>${activity.name}</td>
                            <td>${activity.type}</td>
                            <td>${(activity.distance / 1000).toFixed(2)}</td>
                            <td>${formatPaceForTable(activity.average_speed)}</td>
                            <td>${formatTime(activity.moving_time)}</td>
                        `;
                        detailedTbody.appendChild(activityRow);
                    });
                });
                table.appendChild(detailedTbody);
                
                const spacerTbody = document.createElement('tbody');
                spacerTbody.innerHTML = `<tr class="h-4 bg-gray-100"><td colspan="7"></td></tr>`;
                table.appendChild(spacerTbody);
            });
        }


        function renderDistanceCharts(activities) {
            distanceByRunnerChart.innerHTML = '<p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì qu√£ng ƒë∆∞·ªùng theo Runner s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>';
            distanceByClubChart.innerHTML = '<p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì qu√£ng ƒë∆∞·ªùng theo CLB s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>';
            const clubLegendContainer = document.getElementById('distance-by-club-legend');

            if (activities.length === 0) {
                if (clubLegendContainer) clubLegendContainer.innerHTML = '';
                return;
            }

            const distanceByRunner = new Map();
            const statsByClub = new Map();

            activities.forEach(activity => {
                const distanceKm = activity.distance / 1000;
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                const runnerName = runner ? runner.runner_name : `Runner ID: ${activity.user_id || 'Unknown'}`;
                const clubName = runner ? runner.running_team : 'Kh√¥ng r√µ CLB';
                const runnerId = String(activity.user_id);

                distanceByRunner.set(runnerName, (distanceByRunner.get(runnerName) || 0) + distanceKm);
                
                if (!statsByClub.has(clubName)) {
                    statsByClub.set(clubName, { distance: 0, runners: new Set() });
                }
                const clubStats = statsByClub.get(clubName);
                clubStats.distance += distanceKm;
                clubStats.runners.add(runnerId);
            });

            const runnerData = Array.from(distanceByRunner.entries()).map(([name, distance]) => ({ name, distance }));
            const clubData = Array.from(statsByClub.entries()).map(([name, stats]) => ({
                name,
                distance: stats.distance,
                runnerCount: stats.runners.size
            }));

            drawBubbleChart(distanceByRunnerChart, runnerData, "Qu√£ng ƒë∆∞·ªùng (KM) theo Runner", "name", "distance");

            if (clubLegendContainer) clubLegendContainer.innerHTML = ''; 

            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;

            drawBubbleChart(
                distanceByClubChart,
                clubData,
                "Qu√£ng ƒë∆∞·ªùng (KM) theo CLB",
                "name",
                "distance",
                { 
                    container: clubLegendContainer,
                    startDate: startDate,
                    endDate: endDate
                }
            );
        }

        function drawBubbleChart(container, data, title, nameKey, valueKey, legendOptions = null) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">${title} - Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`;
                if (legendOptions && legendOptions.container) {
                    legendOptions.container.innerHTML = '';
                }
                return;
            }

            const width = container.clientWidth;
            const height = Math.max(300, data.length * 60); 

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxValue = d3.max(data, d => d[valueKey]);
            const minValue = d3.min(data, d => d[valueKey]);

            if (typeof d3.scaleSequential !== 'function' || typeof d3.interpolateViridis !== 'function') {
                console.error("D3 scales or interpolators are not available. Cannot draw bubble chart for " + title);
                container.innerHTML = `<p class="text-red-500 text-center">L·ªói: Kh√¥ng th·ªÉ v·∫Ω bi·ªÉu ƒë·ªì. Th∆∞ vi·ªán D3.js ho·∫∑c c√°c th√†nh ph·∫ßn c·ªßa n√≥ kh√¥ng kh·∫£ d·ª•ng.</p>`;
                return; 
            }

            const maxRadius = width < 768 ? 70 : 60; 
            const minRadius = width < 768 ? 8 : 15; 

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxValue || 1])
                .range([minRadius, maxRadius]); 

            const simulation = d3.forceSimulation(data)
                .force("x", d3.forceX(width / 2).strength(0.15)) 
                .force("y", d3.forceY(height / 2).strength(0.15)) 
                .force("collide", d3.forceCollide(d => radiusScale(d[valueKey]) + 4)) 
                .stop();

            for (let i = 0; i < 200; ++i) simulation.tick(); 

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxValue || 1, minValue || 0]);

            const bubbles = svg.selectAll(".bubble")
                .data(data)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => radiusScale(d[valueKey]))
                .attr("fill", d => colorScale(d[valueKey]))
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`${d[nameKey]}<br>${d[valueKey].toFixed(2)} KM`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            svg.selectAll(".bubble-text")
                .data(data)
                .enter().append("text")
                .attr("class", "bubble-text")
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .text(d => d[nameKey])
                .attr("dy", "-0.3em") 
                .attr("font-size", d => Math.max(8, radiusScale(d[valueKey]) / 4)) 
                .attr("fill", "black") 
                .attr("pointer-events", "none");

            svg.selectAll(".bubble-km-text")
                .data(data)
                .enter().append("text")
                .attr("class", "bubble-text bubble-km-text") 
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .text(d => `${d[valueKey].toFixed(1)} KM`) 
                .attr("dy", "1em") 
                .attr("text-anchor", "middle")
                .attr("font-size", d => Math.max(8, radiusScale(d[valueKey]) / 4.5)) 
                .attr("fill", "black") 
                .attr("pointer-events", "none");


            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 20)
                .attr("text-anchor", "middle")
                .attr("font-size", "1.2rem")
                .attr("font-weight", "bold")
                .attr("fill", "#333")
                .text(title);

            if (legendOptions && legendOptions.container && data.length > 0) {
                const { container: legendContainer, startDate, endDate } = legendOptions;
                legendContainer.innerHTML = ''; 

                const formatDate = (dateString) => {
                    if (!dateString) return '...';
                    const parts = dateString.split('-');
                    if (parts.length !== 3) return dateString; 
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                };

                const startDateFormatted = formatDate(startDate);
                const endDateFormatted = formatDate(endDate);

                const sortedData = [...data].sort((a, b) => b[valueKey] - a[valueKey]);

                let tableHtml = `
                    <h4 class="text-md font-semibold mb-2 text-center">K·∫øt qu·∫£ ch·∫°y t·ª´ ng√†y ${startDateFormatted} ƒë·∫øn ng√†y ${endDateFormatted}</h4>
                    <table class="data-table w-full text-sm">
                        <thead>
                            <tr>
                                <th class="w-1/12 text-center">STT</th>
                                <th class="w-5/12">T√™n c√¢u l·∫°c b·ªô</th>
                                <th class="w-3/12 text-center">S·ªë l∆∞·ª£ng runner</th>
                                <th class="w-3/12 text-right">S·ªë KM ƒë·∫°t ƒë∆∞·ª£c</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sortedData.forEach((item, index) => {
                    tableHtml += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>${item[nameKey]}</td>
                            <td class="text-center">${item.runnerCount || 0}</td>
                            <td class="text-right">${item[valueKey].toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                const totalKm = data.reduce((sum, item) => sum + item[valueKey], 0);
                const totalRunners = data.reduce((sum, item) => sum + (item.runnerCount || 0), 0);
                tableHtml += `
                    <tr class="total-row">
                        <td colspan="2" class="text-right font-bold">T·ªïng c·ªông</td>
                        <td class="text-center font-bold">${totalRunners}</td>
                        <td class="text-right font-bold">${totalKm.toFixed(2)}</td>
                    </tr>
                `;

                tableHtml += `
                        </tbody>
                    </table>
                `;

                legendContainer.innerHTML = tableHtml;
            }
        }

        function renderDistanceChart(data) {
            const ctx = document.getElementById('distanceChart').getContext('2d');

            data.sort((a, b) => a.start_date - b.start_date);

            const labels = data.map(activity => activity.start_date.toLocaleDateString('vi-VN'));
            const distances = data.map(activity => activity.distance_km);

            if (distanceChart) {
                distanceChart.destroy(); 
            }

            distanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kho·∫£ng c√°ch (km)',
                        data: distances,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: 'rgb(75, 192, 192)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(75, 192, 192)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const activity = data[context.dataIndex];
                                    return `Kho·∫£ng c√°ch: ${activity.distance_km} km\nTh·ªùi gian: ${activity.moving_time_formatted}\nT·ªëc ƒë·ªô TB: ${activity.pace_min_per_km_formatted}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Ng√†y',
                                color: '#4b5563'
                            },
                            ticks: {
                                color: '#4b5563'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Kho·∫£ng c√°ch (km)',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        function renderPaceDistributionChart(data) {
            const ctx = document.getElementById('paceDistributionChart').getContext('2d');

            const validPaces = data
                .filter(activity => activity.pace_seconds_per_km_raw !== null && activity.pace_seconds_per_km_raw > 0)
                .map(activity => activity.pace_seconds_per_km_raw);

            if (validPaces.length === 0) {
                if (paceDistributionChart) paceDistributionChart.destroy();
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); 
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText("Kh√¥ng c√≥ d·ªØ li·ªáu t·ªëc ƒë·ªô ƒë·ªÉ hi·ªÉn th·ªã.", 10, 50);
                return;
            }

            const minPace = Math.min(...validPaces);
            const maxPace = Math.max(...validPaces);
            const binSize = 30; 
            const bins = {};

            for (let i = Math.floor(minPace / binSize) * binSize; i <= maxPace + binSize; i += binSize) {
                bins[i.toFixed(0)] = 0;
            }

            validPaces.forEach(pace => {
                const binKey = (Math.floor(pace / binSize) * binSize).toFixed(0);
                if (bins[binKey] !== undefined) {
                    bins[binKey]++;
                }
            });

            const labels = Object.keys(bins).sort((a, b) => parseFloat(a) - parseFloat(b));
            const counts = labels.map(label => bins[label]);

            if (paceDistributionChart) {
                paceDistributionChart.destroy();
            }

            paceDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, 
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông',
                        data: counts,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgb(153, 102, 255)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const rawSeconds = parseFloat(context[0].label);
                                    const startPace = formatPaceLabel(rawSeconds);
                                    const endPace = formatPaceLabel(rawSeconds + binSize);
                                    return `T·ªëc ƒë·ªô: ${startPace} - ${endPace} /km`;
                                },
                                label: function(context) {
                                    return `S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'T·ªëc ƒë·ªô trung b√¨nh (ph√∫t/km)', 
                                color: '#4b5563'
                            },
                            ticks: {
                                color: '#4b5563',
                                callback: function(value, index, values) {
                                    const startSeconds = parseFloat(this.getLabelForValue(value));
                                    const endSeconds = startSeconds + binSize;
                                    return `${formatPaceLabel(startSeconds)} - ${formatPaceLabel(endSeconds)}`;
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0, 
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        function renderHeartRatePaceChart(data) {
            const ctx = document.getElementById('heartRatePaceChart').getContext('2d');

            const scatterData = data
                .filter(activity => activity.average_heartrate !== null && activity.average_heartrate > 0 && activity.pace_seconds_per_km_raw !== null && activity.pace_seconds_per_km_raw > 0)
                .map(activity => ({
                    x: activity.pace_seconds_per_km_raw, 
                    y: activity.average_heartrate,
                    name: activity.name,
                    distance_km: activity.distance_km,
                    moving_time_formatted: activity.moving_time_formatted,
                    pace_min_per_km_formatted: formatPaceForTable(activity.average_speed) 
                }));

            if (scatterData.length === 0) {
                if (heartRatePaceChart) heartRatePaceChart.destroy();
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); 
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText("Kh√¥ng c√≥ d·ªØ li·ªáu nh·ªãp tim/t·ªëc ƒë·ªô ƒë·ªÉ hi·ªÉn √Ω.", 10, 50);
                return;
            }

            if (heartRatePaceChart) {
                heartRatePaceChart.destroy();
            }

            heartRatePaceChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Nh·ªãp tim trung b√¨nh vs T·ªëc ƒë·ªô trung b√¨nh',
                        data: scatterData,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = context.raw;
                                    return `Ho·∫°t ƒë·ªông: ${item.name}\nT·ªëc ƒë·ªô TB: ${item.pace_min_per_km_formatted}\nNh·ªãp tim TB: ${item.y.toFixed(1)} bpm\nKho·∫£ng c√°ch: ${item.distance_km} km\nTh·ªùi gian: ${item.moving_time_formatted}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'T·ªëc ƒë·ªô trung b√¨nh (ph√∫t/km)', 
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563',
                                callback: function(value, index, values) {
                                    return formatPaceLabel(value); 
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Nh·ªãp tim trung b√¨nh (bpm)',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        function renderActivityTypeChart(data) {
            const ctx = document.getElementById('activityTypeChart').getContext('2d');

            const activityTypes = {};
            data.forEach(activity => {
                activityTypes[activity.type] = (activityTypes[activity.type] || 0) + 1;
            });

            const labels = Object.keys(activityTypes);
            const counts = Object.values(activityTypes);

            const backgroundColors = [
                'rgba(255, 205, 86, 0.8)', 
                'rgba(54, 162, 235, 0.8)', 
                'rgba(75, 192, 192, 0.8)', 
                'rgba(153, 102, 255, 0.8)', 
                'rgba(201, 203, 207, 0.8)'  
            ];
            const borderColors = [
                'rgb(255, 205, 86)',
                'rgb(54, 162, 235)',
                'rgb(75, 192, 192)',
                'rgb(153, 102, 255)',
                'rgb(201, 203, 207)'
            ];

            if (activityTypeChart) {
                activityTypeChart.destroy();
            }

            activityTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông',
                        data: counts,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function toggleCollapsible(contentElement, toggleIcon, forceCollapse = null, stateKey = null) {
            let isCollapsed;
            if (forceCollapse !== null) {
                isCollapsed = forceCollapse;
            } else {
                isCollapsed = !contentElement.classList.contains('collapsed');
            }

            if (isCollapsed) {
                contentElement.classList.add('collapsed');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
                if (stateKey) localStorage.setItem(stateKey, 'collapsed');
            } else {
                contentElement.classList.remove('collapsed');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
                if (stateKey) localStorage.setItem(stateKey, 'expanded');
            }
        }

        function handlePenaltyTableClick(event) {
            const icon = event.target.closest('i.cursor-pointer');
            if (!icon) return;

            if (icon.classList.contains('penalty-toggle-icon')) {
                const targetId = icon.dataset.targetTbodyId;
                const contentTbody = document.getElementById(targetId);
                if (contentTbody) {
                    contentTbody.classList.toggle('hidden');
                    if (contentTbody.classList.contains('hidden')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    } else {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            }

            if (icon.classList.contains('week-toggle-icon')) {
                const targetClass = icon.dataset.weekTargetClass;
                const activityRows = document.querySelectorAll(`.${targetClass}`);
                const isHidden = Array.from(activityRows).some(row => row.classList.contains('hidden'));
                
                activityRows.forEach(row => {
                    row.classList.toggle('hidden', !isHidden);
                });

                if (isHidden) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                } else {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-right');
                }
            }
        }

        async function getTrainingSuggestions() {
            if (allActivitiesData.length === 0) {
                showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ho·∫°t ƒë·ªông ƒë·ªÉ t·∫°o g·ª£i √Ω luy·ªán t·∫≠p. Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc.');
                return;
            }

            trainingSuggestionsLoader.classList.remove('hidden');
            getTrainingSuggestionsBtn.disabled = true;
            trainingSuggestionsContent.innerHTML = '';
            trainingSuggestionsStatus.textContent = 'ƒêang t·∫°o g·ª£i √Ω luy·ªán t·∫≠p th√¥ng minh...';

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y phi√™n ƒëƒÉng nh·∫≠p Supabase. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                }

                const isSingleRunner = selectedRunnerIdReport !== 'all';
                
                const payload = {
                    activities: allActivitiesData.map(activity => {
                        const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                        const runnerName = runner ? runner.runner_name : 'Kh√¥ng r√µ';

                        return {
                            runner_name: runnerName, 
                            type: activity.type,
                            distance_km: parseFloat(activity.distance_km),
                            moving_time_seconds: activity.moving_time,
                            average_speed_mps: activity.average_speed,
                            average_heartrate: activity.average_heartrate,
                            kilojoules: activity.kilojoules, 
                            start_date: activity.start_date.toISOString(),
                            total_elevation_gain_meters: activity.total_elevation_gain
                        };
                    }),
                    analysis_context: {
                        is_single_runner: isSingleRunner,
                        runner_name: isSingleRunner 
                            ? (allRunnerCredentials.find(rc => String(rc.athlete_id) === selectedRunnerIdReport)?.runner_name || 'Runner ƒë√£ ch·ªçn') 
                            : 'Nhi·ªÅu runners',
                        client_timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                };

                const response = await fetch(ANALYZE_ACTIVITIES_EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    trainingSuggestionsContent.innerHTML = marked.parse(result.analysis);
                    trainingSuggestionsStatus.textContent = 'G·ª£i √Ω ƒë√£ s·∫µn s√†ng!';
                } else {
                    const errorMessage = result.error || 'Kh√¥ng th·ªÉ nh·∫≠n ƒë∆∞·ª£c g·ª£i √Ω luy·ªán t·∫≠p t·ª´ Edge Function.';
                    trainingSuggestionsContent.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
                    trainingSuggestionsStatus.textContent = 'L·ªói khi t·∫°o g·ª£i √Ω.';
                    console.error('Error from Edge Function:', result);
                }

            } catch (error) {
                console.error('Error calling Edge Function for training suggestions:', error);
                trainingSuggestionsContent.innerHTML = `<p class="text-red-500">ƒê√£ x·∫£y ra l·ªói khi g·ªçi Edge Function: ${error.message}</p>`;
                trainingSuggestionsStatus.textContent = 'L·ªói khi g·ªçi g·ª£i √Ω.';
                showAlert(`L·ªói khi t·∫°o g·ª£i √Ω luy·ªán t·∫≠p: ${error.message}`);
            } finally {
                trainingSuggestionsLoader.classList.add('hidden');
                getTrainingSuggestionsBtn.disabled = false;
                trainingSuggestionsModal.classList.remove('hidden');
                trainingSuggestionsModal.style.display = 'flex';
            }
        }


        function tableToJson(tableElement) {
            const data = [];
            const headers = [];
            
            tableElement.querySelectorAll('thead th').forEach(header => {
                headers.push(header.textContent.trim());
            });

            tableElement.querySelectorAll('tbody tr').forEach(row => {
                const rowData = {};
                row.querySelectorAll('td').forEach((cell, index) => {
                    const header = headers[index] || `Column ${index + 1}`;
                    rowData[header] = cell.textContent.trim();
                });
                data.push(rowData);
            });
            return data;
        }

        function downloadExcel(data, fileName, sheetName) {
            if (!data || data.length === 0) {
                showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t ra Excel.');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
        }


        async function checkAuthAndLoadReport() {
            try {
                const { data: { session }, error } = await supabaseClientInstance.auth.getSession();
                if (error || !session) {
                    console.warn('No active Supabase session found. Redirecting to Index1.html');
                    showAlert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang b√°o c√°o. ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p...');
                    setTimeout(() => {
                        window.location.href = 'https://quantrh.github.io/Strava/index1.html'; 
                    }, 2000); 
                    return;
                }
                
                currentUserEmailSpan.textContent = session.user.email;
                await fetchAllRunnerCredentials(); 
                await fetchClubs(); 
                
                selectedRunnerIdReport = localStorage.getItem('report_runner_filter') || 'all';
                try {
                    const savedClubs = localStorage.getItem('report_club_filter');
                    selectedClubNamesReport = savedClubs ? JSON.parse(savedClubs) : [];
                } catch (e) {
                    console.error('Error parsing saved clubs from local storage:', e);
                    selectedClubNamesReport = [];
                }
                try {
                    const savedActivityTypes = localStorage.getItem('report_activity_types');
                    selectedActivityTypesReport = savedActivityTypes ? JSON.parse(savedActivityTypes) : [];
                } catch (e) {
                    console.error('Error parsing saved activity types from local storage:', e);
                    selectedActivityTypesReport = [];
                }
                minPaceFilter = localStorage.getItem('report_min_pace') ? parseFloat(localStorage.getItem('report_min_pace')) : null;
                minDistanceFilter = localStorage.getItem('report_min_distance') ? parseFloat(localStorage.getItem('report_min_distance')) : null;

                populateFilters(); 

                const today = new Date();
                const endDate = today.toISOString().split('T')[0];
                reportEndDateInput.value = endDate;

                const sixDaysAgo = new Date(today);
                sixDaysAgo.setDate(today.getDate() - 6); 
                const startDate = sixDaysAgo.toISOString().split('T')[0];
                reportStartDateInput.value = startDate;

                await fetchAndRenderReportData(); 
            } catch (authError) {
                console.error('Error during authentication check:', authError.message);
                showAlert(`L·ªói x√°c th·ª±c: ${authError.message}. ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p...`);
                setTimeout(() => {
                    window.location.href = 'https://quantrh.github.io/Strava/index1.html'; 
                }, 2000);
            }
        }

        window.onload = async () => {
            if (typeof window.supabase === 'undefined') {
                showAlert('L·ªói: Th∆∞ vi·ªán Supabase kh√¥ng ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet ho·∫∑c URL CDN.');
                console.error('Th∆∞ vi·ªán Supabase kh√¥ng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a. Vui l√≤ng ki·ªÉm tra th·∫ª script CDN Supabase.');
                return;
            }
            supabaseClientInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            await checkAuthAndLoadReport();

            logoutBtn.addEventListener('click', async () => {
                const confirmed = await showConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?');
                if (confirmed) {
                    try {
                        const { error } = await supabaseClientInstance.auth.signOut();
                        if (error) throw error;
                        localStorage.removeItem('strava_access_token');
                        localStorage.removeItem('strava_refresh_token');
                        localStorage.removeItem('strava_expires_at');
                        localStorage.removeItem('strava_athlete_id');
                        localStorage.removeItem('strava_runner_name');
                        localStorage.removeItem('strava_runner_credential_id');
                        localStorage.removeItem('strava_authenticated');
                        localStorage.removeItem('report_runner_filter');
                        localStorage.removeItem('report_club_filter');
                        localStorage.removeItem('report_activity_types');
                        localStorage.removeItem('report_min_pace');
                        localStorage.removeItem('report_min_distance');

                        showAlert('ƒêƒÉng xu·∫•t th√†nh c√¥ng. ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p...');
                        setTimeout(() => {
                            window.location.href = 'https://quantrh.github.io/Strava/index1.html'; 
                        }, 1500);
                    }
                    catch (error) {
                        console.error('L·ªói ƒëƒÉng xu·∫•t:', error.message);
                        showAlert(`L·ªói khi ƒëƒÉng xu·∫•t: ${error.message}`);
                    }
                }
            });

            backToHomeBtn.addEventListener('click', () => {
                window.location.href = 'https://quantrh.github.io/Strava/index1.html';
            });

            applyReportFiltersBtn.addEventListener('click', () => {
                localStorage.setItem('report_runner_filter', selectedRunnerIdReport);
                localStorage.setItem('report_club_filter', JSON.stringify(selectedClubNamesReport));
                localStorage.setItem('report_activity_types', JSON.stringify(selectedActivityTypesReport));
                localStorage.setItem('report_min_pace', minPaceFilter !== null ? minPaceFilter.toString() : '');
                localStorage.setItem('report_min_distance', minDistanceFilter !== null ? minDistanceFilter.toString() : '');
                
                fetchAndRenderReportData();
            });

            reportRunnerFilter.addEventListener('change', (e) => {
                selectedRunnerIdReport = e.target.value;
            });

            reportStartDateInput.addEventListener('change', () => { });
            reportEndDateInput.addEventListener('change', () => { });

            reportMinPaceInput.addEventListener('input', (e) => {
                minPaceFilter = e.target.value !== '' ? parseFloat(e.target.value) : null;
            });
            reportMinDistanceInput.addEventListener('input', (e) => {
                minDistanceFilter = e.target.value !== '' ? parseFloat(e.target.value) : null;
            });

            penaltyPerKmGt10Input.addEventListener('input', renderAllReports);
            penaltyPerKmLte10Input.addEventListener('input', renderAllReports);
            targetKmPerWeekInput.addEventListener('input', renderAllReports);

            closeWeeklyActivitiesModalBtn.addEventListener('click', () => {
                weeklyActivitiesModal.style.display = 'none';
            });
            closeTrainingSuggestionsModalBtn.addEventListener('click', () => {
                trainingSuggestionsModal.classList.add('hidden');
                trainingSuggestionsModal.style.display = 'none';
            });


            getTrainingSuggestionsBtn.addEventListener('click', getTrainingSuggestions);

            downloadDetailedActivitiesExcelBtn.addEventListener('click', () => {
                const table = document.getElementById('detailed-activities-table');
                const dataToExport = tableToJson(table);
                downloadExcel(dataToExport, 'chi_tiet_hoat_dong.xlsx', 'ChiTietHoatDong');
            });

            downloadPenaltyBonusExcelBtn.addEventListener('click', () => {
                const table = document.getElementById('penalty-bonus-table');
                const dataToExport = tableToJson(table);
                downloadExcel(dataToExport, 'thong_ke_phat_thuong.xlsx', 'ThongKePhatThuong');
            });


            const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
            window.onscroll = function() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollToTopBtn.style.display = "block";
                } else {
                    scrollToTopBtn.style.display = "none";
                }
            };
            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });

            window.addEventListener('resize', () => {
                if (allActivitiesData.length > 0) {
                    renderDistanceCharts(allActivitiesData); 
                    renderWeeklyDistanceChart(allActivitiesData); 
                    renderChartJSCharts(allActivitiesData); 
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                populateFilters(); 
            });

            if (detailedActivitiesHeader && detailedActivitiesContent && detailedActivitiesToggleIcon) {
                const savedState = localStorage.getItem(DETAILED_ACTIVITIES_STATE_KEY);
                const initialStateCollapsed = (savedState === null || savedState === 'collapsed');
                toggleCollapsible(detailedActivitiesContent, detailedActivitiesToggleIcon, initialStateCollapsed, DETAILED_ACTIVITIES_STATE_KEY);

                detailedActivitiesHeader.addEventListener('click', () => {
                    toggleCollapsible(detailedActivitiesContent, detailedActivitiesToggleIcon, null, DETAILED_ACTIVITIES_STATE_KEY);
                });
            }
        };
    </script>
    <!-- Add marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>
