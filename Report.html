<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo hoạt động chạy bộ - FOR RUNNER LOVER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define BIDV brand colors */
        :root {
            --bidv-green: #006b68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .btn-primary {
            background-color: var(--bidv-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: #005a57;
        }

        .btn-secondary {
            background-color: var(--bidv-yellow);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background-color: #e6b32a;
        }

        .btn-danger {
            @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out shadow-md;
        }

        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500;
        }
        
        .multi-select-container {
            position: relative;
        }

        .multi-select-selected-items {
            @apply w-full p-2 border border-gray-300 rounded-md bg-white cursor-pointer flex flex-wrap gap-1;
            min-height: 42px;
            align-items: center;
        }

        .multi-select-selected-item {
            @apply bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full flex items-center gap-1;
        }

        .multi-select-selected-item span {
            cursor: pointer;
            font-weight: bold;
        }

        .multi-select-options {
            @apply absolute w-full border border-gray-300 rounded-md bg-white shadow-lg z-10;
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            @apply p-2 cursor-pointer hover:bg-gray-100;
        }

        .multi-select-option.selected {
            @apply bg-blue-100 font-semibold;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        /* Biểu đồ bong bóng (Bubble Chart) */
        #distance-by-runner-chart,
        #distance-by-club-chart,
        #weekly-distance-chart-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            min-height: 300px; /* Chiều cao tối thiểu để dễ nhìn */
        }

        .bubble {
            fill-opacity: 0.7;
            cursor: pointer;
            transition: fill-opacity 0.3s ease;
        }

        .bubble:hover {
            fill-opacity: 1;
        }

        .bubble-text {
            font-size: 0.8rem;
            text-anchor: middle;
            fill: white;
            pointer-events: none;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .grid-cols-1-md-grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--bidv-green);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        .data-table th {
            background-color: var(--bidv-green);
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .data-table tbody tr:hover {
            background-color: #f0f2f5;
        }
        .data-table .total-row {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        .data-table .summary-row {
            background-color: #d1e7dd;
            font-weight: bold;
        }
        .data-table .missing-row {
            background-color: #fee2e2;
            color: #ef4444;
            font-weight: bold;
        }
        .data-table .runner-summary-group {
             border-bottom: 2px solid var(--bidv-green);
        }
        .data-table .runner-summary-group .total-row td,
        .data-table .runner-summary-group .summary-row td {
            border-bottom: none;
        }
        .data-table .runner-summary-group .summary-row td {
            border-top: none;
        }
        .data-table .runner-summary-group .total-row {
            border-bottom: 1px solid #e2e8f0;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        input[type="date"] {
            position: relative;
        }
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-clear-button {
            display: none;
        }

        #scroll-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--bidv-green);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }

        #scroll-to-top-btn:hover {
            background-color: #005a57;
        }

        #custom-alert, #custom-confirm-modal {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

    </style>
</head>
<body>
    <header class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://placehold.co/80x80/006B68/FFFFFF?text=RUN" alt="Logo BIDV Running Club" class="h-20 w-auto rounded-md">
                <h1 class="text-2xl font-bold text-white">Báo cáo hoạt động chạy bộ - FOR RUNNER LOVER</h1>
            </div>
            <nav>
                <button id="logout-btn" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <section id="report-dashboard" class="card mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center text-bidv-green">Báo cáo hoạt động</h2>
            <p id="user-info" class="text-lg font-medium text-center mb-6">Chào mừng, <span id="current-user-email"></span>!</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Bộ lọc -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700"><i class="fas fa-filter"></i> Bộ lọc báo cáo</h3>
                    <div class="mb-4">
                        <label for="report-runner-filter" class="block text-gray-700 text-sm font-bold mb-2">Chọn Runner:</label>
                        <select id="report-runner-filter" class="form-input">
                            <option value="all">Tất cả Runner</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="report-club-filter" class="block text-gray-700 text-sm font-bold mb-2">Chọn Câu lạc bộ:</label>
                        <select id="report-club-filter" class="form-input">
                            <option value="all">Tất cả Câu lạc bộ</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="report-activity-type-filter" class="block text-gray-700 text-sm font-bold mb-2">Loại hoạt động:</label>
                        <div class="multi-select-container">
                            <div id="multi-select-display-report" class="multi-select-selected-items">
                                <span class="text-gray-500">Chọn loại hoạt động</span>
                            </div>
                            <div id="multi-select-options-report" class="multi-select-options hidden">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 flex gap-4">
                        <div class="flex-1">
                            <label for="report-start-date" class="block text-gray-700 text-sm font-bold mb-2">Từ ngày:</label>
                            <input type="date" id="report-start-date" class="form-input">
                        </div>
                        <div class="flex-1">
                            <label for="report-end-date" class="block text-gray-700 text-sm font-bold mb-2">Đến ngày:</label>
                            <input type="date" id="report-end-date" class="form-input">
                        </div>
                    </div>
                    <button id="apply-report-filters-btn" class="btn-primary w-full">
                        Áp dụng bộ lọc
                    </button>
                    <div id="report-filter-status" class="mt-2 text-sm text-gray-600 text-center"></div>
                </div>

                <!-- Tổng quan thống kê -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-green-700"><i class="fas fa-chart-pie"></i> Tổng quan thống kê</h3>
                    <div id="overall-stats" class="space-y-3 text-gray-700">
                        <p class="text-lg">Tổng số hoạt động: <span id="total-activities-count" class="font-bold text-bidv-green">0</span></p>
                        <p class="text-lg">Tổng quãng đường: <span id="total-distance-km" class="font-bold text-bidv-green">0.00 KM</span></p>
                        <p class="text-lg">Tổng thời gian di chuyển: <span id="total-moving-time" class="font-bold text-bidv-green">00:00:00</span></p>
                    </div>
                    <div id="distance-by-runner-chart" class="mt-4 border rounded-md p-2 min-h-[150px] flex items-center justify-center">
                        <p class="text-gray-500 text-sm">Biểu đồ quãng đường theo Runner sẽ hiển thị ở đây.</p>
                    </div>
                    <div id="distance-by-club-chart" class="mt-4 border rounded-md p-2 min-h-[150px] flex items-center justify-center">
                        <p class="text-gray-500 text-sm">Biểu đồ quãng đường theo CLB sẽ hiển thị ở đây.</p>
                    </div>
                </div>
            </div>

            <!-- Biểu đồ phân bố tốc độ trung bình (Pace Distribution) -->
            <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-purple-700"><i class="fas fa-chart-bar"></i> Phân bố tốc độ trung bình (Pace)</h3>
                <div id="pace-distribution-chart" class="mt-4 border rounded-md p-2 min-h-[300px] flex items-center justify-center">
                    <p class="text-gray-500 text-sm">Biểu đồ phân bố tốc độ trung bình sẽ hiển thị ở đây.</p>
                </div>
            </div>

            <!-- Biểu đồ Nhịp tim trung bình theo tốc độ (Heartrate vs Pace) -->
            <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-pink-700"><i class="fas fa-heartbeat"></i> Nhịp tim trung bình theo tốc độ</h3>
                <div id="heartrate-pace-chart" class="mt-4 border rounded-md p-2 min-h-[300px] flex items-center justify-center">
                    <p class="text-gray-500 text-sm">Biểu đồ nhịp tim trung bình theo tốc độ sẽ hiển thị ở đây.</p>
                </div>
            </div>

            <!-- Biểu đồ phân loại hoạt động (Activity Type Distribution) -->
            <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-yellow-700"><i class="fas fa-running"></i> Phân loại hoạt động</h3>
                <div id="activity-type-chart" class="mt-4 border rounded-md p-2 min-h-[300px] flex items-center justify-center">
                    <p class="text-gray-500 text-sm">Biểu đồ phân loại hoạt động sẽ hiển thị ở đây.</p>
                </div>
            </div>


            <!-- Bảng chi tiết hoạt động -->
            <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-blue-700"><i class="fas fa-list"></i> Chi tiết các hoạt động</h3>
                <div class="overflow-x-auto">
                    <table id="detailed-activities-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Tên Runner</th>
                                <th>CLB</th>
                                <th>Tên hoạt động</th>
                                <th>Loại</th>
                                <th>Ngày</th>
                                <th>Quãng đường (KM)</th>
                                <th>Thời gian</th>
                                <th>Pace</th>
                                <th>Nhịp tim TB</th>
                                <th>Độ cao tăng (m)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Hoạt động sẽ được tải vào đây -->
                        </tbody>
                    </table>
                </div>
                <p id="detailed-activities-status" class="mt-4 text-sm text-gray-600 text-center">Không có hoạt động nào để hiển thị.</p>
            </div>

            <!-- Biểu đồ thống kê theo tuần -->
            <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-red-700"><i class="fas fa-chart-line"></i> Thống kê quãng đường theo tuần</h3>
                <div id="weekly-distance-chart-container" class="border rounded-md p-2 min-h-[300px] flex items-center justify-center">
                    <p class="text-gray-500 text-sm">Biểu đồ thống kê quãng đường theo tuần sẽ hiển thị ở đây.</p>
                </div>
                <p id="weekly-chart-status" class="mt-4 text-sm text-gray-600 text-center"></p>
            </div>

             <!-- Bảng thống kê chi tiết & Tiền phạt/Thưởng -->
             <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-teal-700"><i class="fas fa-calculator"></i> Thống kê tiền phạt/thưởng</h3>
                <div class="mb-4 flex gap-4 items-end">
                    <div class="flex-1">
                        <label for="penalty-per-km-gt10" class="block text-gray-700 text-sm font-bold mb-2">Số tiền nộp cho 1KM (nghìn VNĐ) khi thiếu > 10KM:</label>
                        <input type="number" id="penalty-per-km-gt10" class="form-input bg-yellow-100" value="30" min="0" step="1">
                    </div>
                    <div class="flex-1">
                        <label for="penalty-per-km-lte10" class="block text-gray-700 text-sm font-bold mb-2">Số tiền nộp cho 1KM (nghìn VNĐ) khi thiếu <= 10KM:</label>
                        <input type="number" id="penalty-per-km-lte10" class="form-input bg-yellow-100" value="20" min="0" step="1">
                    </div>
                    <div class="flex-1">
                        <label for="target-km-per-week" class="block text-gray-700 text-sm font-bold mb-2">Số KM một tuần (KM):</label>
                        <input type="number" id="target-km-per-week" class="form-input bg-yellow-100" value="25" min="0" step="1">
                    </div>
                </div>
                <div id="detailed-stats-table-container" class="overflow-x-auto">
                    <table id="penalty-bonus-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Tên Runner</th>
                                <th>CLB</th>
                                <th>Tuần</th>
                                <th>Tổng KM thực hiện</th>
                                <th>Mục tiêu KM</th>
                                <th>KM chênh lệch</th>
                                <th>Số tiền (nghìn VNĐ)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="penalty-bonus-status" class="mt-4 text-sm text-gray-600 text-center">Chưa có dữ liệu để hiển thị.</p>
            </div>


        </section>
    </main>

    <footer class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container" style="color: var(--bidv-yellow);">
            &copy; 2025 Trương Hồng Quân - BIDV Running Club. All rights reserved (Dev by AIs - Gemini, GPT) - 📧quantrhvn@gmail.com -  +84989073739 - 248064a v2.
            <br>
            <img src="https://placehold.co/80x28/006B68/FFFFFF?text=PowerStrava" alt="PowerStrava Logo" style="height: 28px; margin: 5px auto 0 auto; display: block;">
        </div>
    </footer>

    <!-- Weekly Activities Modal -->
    <div id="weekly-activities-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="close-weekly-activities-modal-btn">&times;</span>
            <h3 id="weekly-activities-title" class="text-2xl font-bold mb-4 text-gray-800">Hoạt động trong tuần:</h3>
            <div class="max-h-96 overflow-y-auto border rounded-md p-2">
                <ul id="weekly-activities-list" class="space-y-2 text-sm">
                    <!-- Activities will be loaded here -->
                </ul>
            </div>
            <p id="weekly-activities-status" class="mt-4 text-sm text-gray-600"></p>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modals -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="alert-message" class="mb-4 text-lg"></p>
            <button id="alert-ok-btn" class="btn-primary">OK</button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="mb-4 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button type="button" id="confirm-cancel-btn" class="btn-primary">Hủy</button>
                <button type="button" id="confirm-ok-btn" class="btn-danger">Đồng ý</button>
            </div>
        </div>
    </div>

    <button id="scroll-to-top-btn" title="Go to top">▲</button>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Replace with your Supabase Anon Key

        const GET_STATS_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/get-user-activities';

        let supabaseClientInstance;
        let allRunnerCredentials = [];
        let allClubs = [];
        let allActivitiesData = []; // Store all fetched activities for the report

        let selectedRunnerIdReport = 'all'; // Default filter for runner in report
        let selectedClubNameReport = 'all'; // Default filter for club in report
        let selectedActivityTypesReport = []; // Default filter for activity type in report

        // DOM Elements
        const currentUserEmailSpan = document.getElementById('current-user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const reportRunnerFilter = document.getElementById('report-runner-filter');
        const reportClubFilter = document.getElementById('report-club-filter');
        const multiSelectDisplayReport = document.getElementById('multi-select-display-report');
        const multiSelectOptionsReport = document.getElementById('multi-select-options-report');
        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const applyReportFiltersBtn = document.getElementById('apply-report-filters-btn');
        const reportFilterStatus = document.getElementById('report-filter-status');

        const totalActivitiesCountSpan = document.getElementById('total-activities-count');
        const totalDistanceKmSpan = document.getElementById('total-distance-km');
        const totalMovingTimeSpan = document.getElementById('total-moving-time');

        const detailedActivitiesTableBody = document.querySelector('#detailed-activities-table tbody');
        const detailedActivitiesStatus = document.getElementById('detailed-activities-status');

        const weeklyDistanceChartContainer = document.getElementById('weekly-distance-chart-container');
        const weeklyChartStatus = document.getElementById('weekly-chart-status');

        const penaltyPerKmGt10Input = document.getElementById('penalty-per-km-gt10');
        const penaltyPerKmLte10Input = document.getElementById('penalty-per-km-lte10');
        const targetKmPerWeekInput = document.getElementById('target-km-per-week');
        const penaltyBonusTableBody = document.querySelector('#penalty-bonus-table tbody');
        const penaltyBonusStatus = document.getElementById('penalty-bonus-status');

        const weeklyActivitiesModal = document.getElementById('weekly-activities-modal');
        const closeWeeklyActivitiesModalBtn = document.getElementById('close-weekly-activities-modal-btn');
        const weeklyActivitiesTitle = document.getElementById('weekly-activities-title');
        const weeklyActivitiesList = document.getElementById('weekly-activities-list');
        const weeklyActivitiesStatus = document.getElementById('weekly-activities-status');

        const paceDistributionChart = document.getElementById('pace-distribution-chart');
        const heartratePaceChart = document.getElementById('heartrate-pace-chart');
        const activityTypeChart = document.getElementById('activity-type-chart');
        const distanceByRunnerChart = document.getElementById('distance-by-runner-chart');
        const distanceByClubChart = document.getElementById('distance-by-club-chart');

        const ALL_ACTIVITY_TYPES = [
            'Run', 'Walk', 'Ride', 'Swim', 'Hike', 'NordicSki', 'AlpineSki', 'Workout', 'Yoga', 
            'WeightTraining', 'Elliptical', 'StairStepper', 'Rowing', 'Crossfit', 'Canoeing', 
            'Kayaking', 'StandUpPaddling', 'VirtualRide', 'VirtualRun', 'Wheelchair', 'Handcycle', 
            'RollerSki', 'IceSkate', 'Snowboard', 'Snowshoe', 'BackcountrySki', 'EMountainBikeRide', 
            'EBikeRide', 'MountainBikeRide', 'GravelRide', 'Velomobile', 'Kitesurf', 'Windsurf', 
            'RockClimbing', 'Alpinism', 'Badminton', 'Squash', 'TableTennis', 'Tennis', 'Volleyball', 
            'Surfing', 'Pilates', 'Golf', 'WaterSport', 'Soccer', 'Basketball'
        ].sort(); // Sort activity types alphabetically


        // --- Helper Functions ---

        function showAlert(message) {
            const customAlert = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
            customAlert.style.display = 'flex'; // Ensure it's visible

            alertOkBtn.onclick = () => {
                customAlert.classList.add('hidden');
                customAlert.style.display = 'none';
            };
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const customConfirm = document.getElementById('custom-confirm-modal');
                const confirmMessage = document.getElementById('confirm-message');
                const confirmOkBtn = document.getElementById('confirm-ok-btn'); 
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                confirmMessage.textContent = message;
                customConfirm.classList.remove('hidden');
                customConfirm.style.display = 'flex'; // Ensure it's visible

                const cleanup = () => {
                    customConfirm.classList.add('hidden');
                    customConfirm.style.display = 'none';
                    confirmOkBtn.onclick = null;
                    confirmCancelBtn.onclick = null;
                };

                confirmOkBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                confirmCancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        function formatDuration(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s].map(v => v < 10 ? "0" + v : v).filter((v, i) => v !== "00" || i > 0).join(":");
        }

        function formatPace(metersPerSecond) {
            if (typeof metersPerSecond !== 'number' || isNaN(metersPerSecond) || metersPerSecond <= 0) return 'N/A';
            const kmPerHour = (metersPerSecond * 3.6); 
            if (kmPerHour === 0) return 'N/A';
            const minutesPerKm = 60 / kmPerHour; 
            const minutes = Math.floor(minutesPerKm);
            const seconds = Math.round((minutesPerKm - minutes) * 60);
            return `${minutes}:${String(seconds).padStart(2, '0')} /km`;
        }

        function formatElevationGain(meters) {
            if (typeof meters !== 'number' || isNaN(meters)) return 'N/A';
            return `${meters.toFixed(0)} m`;
        }

        /**
         * Populates the multi-select filter dropdowns.
         */
        function populateActivityTypeFilters() {
            multiSelectOptionsReport.innerHTML = ''; 
            ALL_ACTIVITY_TYPES.forEach(type => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.textContent = type;
                optionDiv.dataset.value = type;
                multiSelectOptionsReport.appendChild(optionDiv);
            });
        }

        /**
         * Updates the display of selected items in the multi-select.
         * @param {HTMLElement} displayElement - The element to show selected tags.
         * @param {string[]} selectedTypes - Array of selected activity types.
         * @param {HTMLElement} optionsContainer - The container for options to update their 'selected' class.
         */
        function updateMultiSelectDisplay(displayElement, selectedTypes, optionsContainer) {
            displayElement.innerHTML = '';
            if (selectedTypes.length === 0) {
                displayElement.innerHTML = '<span class="text-gray-500">Chọn loại hoạt động</span>';
            } else {
                selectedTypes.forEach(type => {
                    const itemSpan = document.createElement('span');
                    itemSpan.className = 'multi-select-selected-item';
                    itemSpan.innerHTML = `${type} <span data-value="${type}" class="remove-item-btn">&times;</span>`;
                    displayElement.appendChild(itemSpan);
                });
            }

            Array.from(optionsContainer.children).forEach(optionDiv => {
                if (selectedTypes.includes(optionDiv.dataset.value)) {
                    optionDiv.classList.add('selected');
                } else {
                    optionDiv.classList.remove('selected');
                }
            });
        }

        /**
         * Toggles an activity type in the selected list.
         * @param {string} type - The activity type to toggle.
         * @param {string[]} selectedTypesArray - The array to modify.
         * @param {HTMLElement} displayElement - The display element for this filter.
         * @param {HTMLElement} optionsContainer - The options container for this filter.
         */
        function toggleActivityType(type, selectedTypesArray, displayElement, optionsContainer) {
            const index = selectedTypesArray.indexOf(type);
            if (index > -1) {
                selectedTypesArray.splice(index, 1); // Remove if already exists
            } else {
                selectedTypesArray.push(type); // Add if not exists
                selectedTypesArray.sort(); // Keep sorted alphabetically
            }
            updateMultiSelectDisplay(displayElement, selectedTypesArray, optionsContainer);
        }

        // Event delegation for multi-select options (Report Page specific)
        document.addEventListener('click', (event) => {
            // Toggle options visibility
            if (event.target.closest('#multi-select-display-report')) {
                document.getElementById('multi-select-options-report').classList.toggle('hidden');
            } else {
                // Click outside to close options
                if (!event.target.closest('#multi-select-options-report')) {
                    document.getElementById('multi-select-options-report').classList.add('hidden');
                }
            }

            // Handle option selection/deselection
            if (event.target.classList.contains('multi-select-option')) {
                const type = event.target.dataset.value;
                if (event.target.closest('#multi-select-options-report')) {
                    toggleActivityType(type, selectedActivityTypesReport, multiSelectDisplayReport, multiSelectOptionsReport);
                }
            } else if (event.target.classList.contains('remove-item-btn')) {
                const type = event.target.dataset.value;
                if (event.target.closest('#multi-select-display-report')) {
                    toggleActivityType(type, selectedActivityTypesReport, multiSelectDisplayReport, multiSelectOptionsReport);
                }
            }
        });

        /**
         * Fetches all runner credentials for the logged-in user from Supabase.
         * This includes runners with and without athlete_id as they might still be relevant for filtering by club etc.
         */
        async function fetchAllRunnerCredentials() {
            try {
                const { data, error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('*')
                    .order('runner_name', { ascending: true });
                if (error) throw error;
                allRunnerCredentials = data;
                console.log('Fetched all runner credentials for report:', allRunnerCredentials);
            } catch (error) {
                console.error('Error fetching all runner credentials:', error.message);
                showAlert(`Lỗi khi tải thông tin runner: ${error.message}`);
                allRunnerCredentials = [];
            }
        }

        /**
         * Fetches clubs from Supabase and updates the global `allClubs` array.
         */
        async function fetchClubs() {
            try {
                const { data, error } = await supabaseClientInstance
                    .from('clubs')
                    .select('*')
                    .order('name', { ascending: true });
                if (error) throw error;
                allClubs = data;
                console.log('Fetched clubs for report:', allClubs);
            } catch (error) {
                console.error('Error fetching clubs for report:', error.message);
                showAlert(`Lỗi khi tải danh sách câu lạc bộ: ${error.message}`);
                allClubs = [];
            }
        }

        /**
         * Populates the runner and club filter dropdowns.
         */
        function populateFilters() {
            // Populate Runner filter
            reportRunnerFilter.innerHTML = '<option value="all">Tất cả Runner</option>';
            allRunnerCredentials.forEach(cred => {
                const option = document.createElement('option');
                option.value = String(cred.athlete_id); // Use athlete_id for filtering activities
                option.textContent = cred.runner_name;
                reportRunnerFilter.appendChild(option);
            });
            reportRunnerFilter.value = selectedRunnerIdReport; // Restore previous selection

            // Populate Club filter
            reportClubFilter.innerHTML = '<option value="all">Tất cả Câu lạc bộ</option>';
            allClubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club.name;
                option.textContent = club.name;
                reportClubFilter.appendChild(option);
            });
            reportClubFilter.value = selectedClubNameReport; // Restore previous selection

            // Initialize activity type filter
            populateActivityTypeFilters();
            updateMultiSelectDisplay(multiSelectDisplayReport, selectedActivityTypesReport, multiSelectOptionsReport);
        }

        /**
         * Fetches activity data based on current filters and renders all reports.
         */
        async function fetchAndRenderReportData() {
            reportFilterStatus.textContent = 'Đang tải dữ liệu báo cáo...';
            allActivitiesData = []; // Clear previous data

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Không tìm thấy phiên đăng nhập Supabase. Vui lòng đăng nhập lại.');
                }

                // Prepare filters for the Supabase query
                let queryRunnerIds = [];
                if (selectedRunnerIdReport === 'all') {
                    // If 'All Runners' is selected, get all athlete_ids that exist
                    queryRunnerIds = allRunnerCredentials.filter(c => c.athlete_id).map(c => String(c.athlete_id));
                } else {
                    queryRunnerIds = [selectedRunnerIdReport];
                }

                // If a specific club is selected, narrow down runner IDs further
                if (selectedClubNameReport !== 'all') {
                    const runnersInSelectedClub = allRunnerCredentials.filter(
                        c => c.running_team === selectedClubNameReport && c.athlete_id
                    ).map(c => String(c.athlete_id));
                    queryRunnerIds = queryRunnerIds.filter(id => runnersInSelectedClub.includes(id));
                }

                if (queryRunnerIds.length === 0) {
                    reportFilterStatus.textContent = 'Không có dữ liệu để hiển thị với các bộ lọc đã chọn. Vui lòng điều chỉnh bộ lọc.';
                    renderAllReports(); // Render empty reports
                    return;
                }

                let query = supabaseClientInstance
                    .from('activities')
                    .select('strava_activity_id, name, type, distance, moving_time, total_elevation_gain, start_date, average_speed, average_heartrate, user_id')
                    .in('user_id', queryRunnerIds); // Filter by runner IDs

                if (selectedActivityTypesReport.length > 0) {
                    query = query.in('type', selectedActivityTypesReport);
                }

                if (reportStartDateInput.value) {
                    query = query.gte('start_date', reportStartDateInput.value + 'T00:00:00.000Z');
                }
                if (reportEndDateInput.value) {
                    // Add one day to end date to include activities on that day
                    const endDatePlusOne = new Date(reportEndDateInput.value);
                    endDatePlusOne.setDate(endDatePlusOne.getDate() + 1);
                    query = query.lt('start_date', endDatePlusOne.toISOString());
                }

                query = query.order('start_date', { ascending: false });

                const { data, error } = await query;

                if (error) throw error;
                
                allActivitiesData = data || []; // Store fetched data
                reportFilterStatus.textContent = `Đã tải ${allActivitiesData.length} hoạt động.`;
                renderAllReports(); // Call a function to render all sections
                
            } catch (error) {
                console.error('Error fetching report data:', error.message);
                reportFilterStatus.textContent = `Lỗi khi tải báo cáo: ${error.message}`;
                showAlert(`Lỗi khi tải báo cáo: ${error.message}`);
                allActivitiesData = []; // Clear data on error
                renderAllReports(); // Render empty reports
            }
        }

        /**
         * Renders all report sections: summary, detailed table, charts.
         */
        function renderAllReports() {
            // 1. Render Overall Stats
            let totalActivities = allActivitiesData.length;
            let totalDistance = 0; // in meters
            let totalMovingTime = 0; // in seconds

            allActivitiesData.forEach(activity => {
                totalDistance += activity.distance || 0;
                totalMovingTime += activity.moving_time || 0;
            });

            totalActivitiesCountSpan.textContent = totalActivities;
            totalDistanceKmSpan.textContent = `${(totalDistance / 1000).toFixed(2)} KM`;
            totalMovingTimeSpan.textContent = formatDuration(totalMovingTime);

            // 2. Render Detailed Activities Table
            renderDetailedActivitiesTable(allActivitiesData);

            // 3. Render Weekly Distance Chart
            renderWeeklyDistanceChart(allActivitiesData);

            // 4. Render Penalty/Bonus Table
            renderPenaltyBonusTable(allActivitiesData);

            // 5. Render Distance by Runner/Club Chart
            renderDistanceCharts(allActivitiesData);

            // 6. Render Pace Distribution Chart
            renderPaceDistributionChart(allActivitiesData);

            // 7. Render Heartrate vs Pace Chart
            renderHeartratePaceChart(allActivitiesData);

            // 8. Render Activity Type Distribution Chart
            renderActivityTypeChart(allActivitiesData);
        }

        /**
         * Renders the detailed activities table.
         * @param {Array} activities - Array of activity objects.
         */
        function renderDetailedActivitiesTable(activities) {
            detailedActivitiesTableBody.innerHTML = '';
            if (activities.length === 0) {
                detailedActivitiesStatus.textContent = 'Không có hoạt động nào để hiển thị.';
                return;
            }
            detailedActivitiesStatus.textContent = '';

            activities.forEach(activity => {
                const row = detailedActivitiesTableBody.insertRow();
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                const runnerName = runner ? runner.runner_name : 'N/A';
                const runnerClub = runner ? runner.running_team : 'N/A';

                row.innerHTML = `
                    <td>${runnerName}</td>
                    <td>${runnerClub}</td>
                    <td>${activity.name}</td>
                    <td>${activity.type}</td>
                    <td>${new Date(activity.start_date).toLocaleDateString('vi-VN')}</td>
                    <td>${(activity.distance / 1000).toFixed(2)}</td>
                    <td>${formatDuration(activity.moving_time)}</td>
                    <td>${formatPace(activity.average_speed)}</td>
                    <td>${activity.average_heartrate ? activity.average_heartrate.toFixed(0) : 'N/A'}</td>
                    <td>${formatElevationGain(activity.total_elevation_gain)}</td>
                `;
            });
        }

        /**
         * Calculates and renders weekly distance chart.
         * @param {Array} activities - Array of activity objects.
         */
        function renderWeeklyDistanceChart(activities) {
            weeklyDistanceChartContainer.innerHTML = '';
            weeklyChartStatus.textContent = '';

            if (activities.length === 0) {
                weeklyDistanceChartContainer.innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu để hiển thị biểu đồ thống kê theo tuần.</p>';
                return;
            }

            const weeklyDataMap = new Map();
            activities.forEach(activity => {
                const isoWeek = getISOWeekString(activity.start_date);
                if (isoWeek) {
                    if (!weeklyDataMap.has(isoWeek)) {
                        weeklyDataMap.set(isoWeek, {
                            week: isoWeek,
                            totalDistance: 0,
                            athlete_id: activity.user_id // Keep track of athlete_id for detailed view
                        });
                    }
                    weeklyDataMap.get(isoWeek).totalDistance += activity.distance;
                }
            });

            const weeklyStats = Array.from(weeklyDataMap.values()).sort((a, b) => a.week.localeCompare(b.week));

            if (weeklyStats.length === 0) {
                weeklyDistanceChartContainer.innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu để hiển thị biểu đồ thống kê theo tuần.</p>';
                return;
            }

            const container = weeklyDistanceChartContainer;
            const width = container.clientWidth;
            const height = 300; // Fixed height for weekly chart

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxDistance = d3.max(weeklyStats, d => d.totalDistance);
            const minDistance = d3.min(weeklyStats, d => d.totalDistance);

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxDistance || 1])
                .range([10, 40]);

            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxDistance || 1, minDistance || 0]);

            const x = d3.scaleBand()
                .domain(weeklyStats.map(d => d.week))
                .range([50, width - 20])
                .paddingInner(0.1);

            const y = d3.scaleLinear()
                .domain([0, maxDistance * 1.2 || 10000]) // Extend y-axis slightly
                .range([height - 50, 20]);

            const xAxis = d3.axisBottom(x).tickFormat(d => d.replace(/-W/, 'W'));
            const yAxis = d3.axisLeft(y).tickFormat(d => `${(d / 1000).toFixed(0)}km`);

            svg.append("g")
                .attr("transform", `translate(0, ${height - 50})`)
                .call(xAxis)
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .attr("transform", `translate(50, 0)`)
                .call(yAxis);

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            svg.selectAll(".bubble")
                .data(weeklyStats)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => x(d.week) + x.bandwidth() / 2)
                .attr("cy", d => y(d.totalDistance))
                .attr("r", d => radiusScale(d.totalDistance))
                .attr("fill", d => colorScale(d.totalDistance))
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`Tuần: ${d.week.replace(/-W/, 'W')}<br>Quãng đường: ${(d.totalDistance / 1000).toFixed(2)} km`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                })
                .on("click", function(event, d) {
                    const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(d.athlete_id));
                    const runnerName = runner ? runner.runner_name : `Runner ID: ${d.athlete_id}`;
                    weeklyActivitiesTitle.textContent = `Hoạt động của ${runnerName} trong tuần ${d.week.replace(/-W/, 'W')}:`;
                    fetchActivitiesForWeek(d.week, d.athlete_id);
                });

            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height - 10})`)
                .style("text-anchor", "middle")
                .text("Tuần");

            svg.append("text")
                .attr("transform", `rotate(-90) translate(-${height / 2}, 15)`)
                .style("text-anchor", "middle")
                .text("Quãng đường (KM)");
        }

        /**
         * Helper to get ISO week string (YYYY-WNN) from a Date object, adjusted for Vietnam timezone.
         * This function ensures that the week calculation aligns with Vietnam local time (UTC+7).
         * @param {Date|string} d - The Date object or ISO 8601 string (assumed to be UTC from Supabase).
         * @returns {string} ISO week string (YYYY-WNN). Returns null if input is invalid.
         */
        function getISOWeekString(d) {
            let activityDateUtc;
            if (typeof d === 'string') {
                activityDateUtc = new Date(d);
            } else if (d instanceof Date) {
                activityDateUtc = d;
            } else {
                return null;
            }
            if (isNaN(activityDateUtc.getTime())) return null;

            const formatter = new Intl.DateTimeFormat('en-US', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                timeZone: 'Asia/Ho_Chi_Minh'
            });
            const parts = formatter.formatToParts(activityDateUtc);
            let year, month, day;
            parts.forEach(p => {
                switch (p.type) {
                    case 'year': year = parseInt(p.value); break;
                    case 'month': month = parseInt(p.value); break;
                    case 'day': day = parseInt(p.value); break;
                }
            });

            const vietnamAlignedDate = new Date(year, month - 1, day);
            vietnamAlignedDate.setHours(0, 0, 0, 0); // Set to start of the day in Vietnam time

            const dayOfWeek = vietnamAlignedDate.getDay() || 7; // 0 for Sunday, 1 for Monday, ..., 6 for Saturday. Map 0 to 7 for ISO.
            vietnamAlignedDate.setDate(vietnamAlignedDate.getDate() + 4 - dayOfWeek); // To nearest Thursday

            const isoWeekYear = vietnamAlignedDate.getFullYear();
            const yearStart = new Date(isoWeekYear, 0, 1);
            const weekNo = Math.ceil((((vietnamAlignedDate - yearStart) / 86400000) + 1) / 7);

            return `${isoWeekYear}-W${String(weekNo).padStart(2, '0')}`;
        }

        /**
         * Fetches and displays detailed activities for a specific week and athlete ID in a modal.
         * @param {string} isoWeek - The ISO week string (e.e.g., "2023-W01").
         * @param {string} athleteId - The Strava athlete ID.
         */
        async function fetchActivitiesForWeek(isoWeek, athleteId) {
            weeklyActivitiesList.innerHTML = '';
            weeklyActivitiesStatus.textContent = 'Đang tải hoạt động cho tuần này...';
            weeklyActivitiesModal.style.display = 'flex';

            try {
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(athleteId));
                if (!runner) {
                    weeklyActivitiesStatus.textContent = 'Không tìm thấy thông tin runner.';
                    showAlert('Không tìm thấy thông tin runner cho Athlete ID này. Vui lòng kiểm tra lại dữ liệu.');
                    weeklyActivitiesModal.style.display = 'none';
                    return;
                }

                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                const headers = { 'Content-Type': 'application/json' };
                if (session?.access_token) {
                    headers['Authorization'] = `Bearer ${session.access_token}`;
                } else {
                    weeklyActivitiesStatus.textContent = 'Lỗi xác thực: Vui lòng đăng nhập lại.';
                    showAlert('Lỗi: Không tìm thấy phiên đăng nhập. Vui lòng đăng nhập lại để xem chi tiết hoạt động.');
                    weeklyActivitiesModal.style.display = 'none';
                    return;
                }

                const payload = {
                    runnerCredentialId: runner.id,
                    isoWeek: isoWeek,
                };

                const response = await fetch(GET_STATS_API_URL, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success && result.detailed_activities) {
                    const activitiesToDisplay = result.detailed_activities;
                    if (activitiesToDisplay.length > 0) {
                        activitiesToDisplay.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
                        weeklyActivitiesList.innerHTML = '';
                        activitiesToDisplay.forEach(activity => {
                            const li = document.createElement('li');
                            li.className = 'border-b last:border-b-0 py-2';
                            li.innerHTML = `
                                <p class="font-semibold">${activity.name} (${activity.type})</p>
                                <p class="text-sm text-gray-600">Ngày: ${new Date(activity.start_date).toLocaleDateString('vi-VN')}</p>
                                <p class="text-sm text-gray-600">Quãng đường: ${(activity.distance / 1000).toFixed(2)} km</p>
                                <p class="text-sm text-gray-600">Thời gian: ${formatDuration(activity.moving_time)}</p>
                                <p class="text-sm text-gray-600">Pace: ${formatPace(activity.average_speed)}</p>
                                ${activity.strava_activity_id ? `<button class="btn-primary mt-2 text-xs px-2 py-1 view-map-btn" data-activity-id="${activity.strava_activity_id}">Xem bản đồ</button>` : ''}
                            `;
                            weeklyActivitiesList.appendChild(li);
                        });
                        weeklyActivitiesStatus.textContent = `Đã tải ${activitiesToDisplay.length} hoạt động cho tuần này.`;
                        document.querySelectorAll('#weekly-activities-modal .view-map-btn').forEach(button => {
                            button.onclick = (e) => {
                                const activityId = e.target.dataset.activityId;
                                if (activityId) {
                                    window.open(`https://www.strava.com/activities/${activityId}`, '_blank');
                                }
                            };
                        });
                    } else {
                        weeklyActivitiesStatus.textContent = 'Không tìm thấy hoạt động nào cho tuần này.';
                    }
                } else {
                    console.error('Lỗi khi tải hoạt động chi tiết cho tuần:', result.error || 'Không xác định');
                    weeklyActivitiesStatus.textContent = `Lỗi: ${result.error || 'Không xác định'}`;
                    showAlert(`Lỗi khi tải hoạt động chi tiết: ${result.error || 'Không xác định'}`);
                }
            } catch (error) {
                console.error('Lỗi mạng hoặc máy chủ khi tải hoạt động chi tiết:', error);
                weeklyActivitiesStatus.textContent = 'Lỗi mạng hoặc máy chủ khi tải hoạt động.';
                showAlert(`Lỗi mạng hoặc máy chủ khi tải hoạt động: ${error.message}`);
            }
        }

        /**
         * Renders the penalty/bonus table.
         * @param {Array} activities - Array of activity objects.
         */
        function renderPenaltyBonusTable(activities) {
            penaltyBonusTableBody.innerHTML = '';
            penaltyBonusStatus.textContent = '';

            if (activities.length === 0) {
                penaltyBonusStatus.textContent = 'Chưa có dữ liệu để hiển thị.';
                return;
            }

            const penaltyPerKmGt10 = parseFloat(penaltyPerKmGt10Input.value) || 0;
            const penaltyPerKmLte10 = parseFloat(penaltyPerKmLte10Input.value) || 0;
            const targetKmPerWeek = parseFloat(targetKmPerWeekInput.value) || 0;

            const weeklyStatsByRunner = {}; // { athlete_id: { isoWeek: { totalDistance: ..., activities: [...] } } }

            activities.forEach(activity => {
                const athleteId = String(activity.user_id);
                const isoWeek = getISOWeekString(activity.start_date);

                if (!weeklyStatsByRunner[athleteId]) {
                    weeklyStatsByRunner[athleteId] = {};
                }
                if (!weeklyStatsByRunner[athleteId][isoWeek]) {
                    weeklyStatsByRunner[athleteId][isoWeek] = { totalDistance: 0, activities: [] };
                }
                weeklyStatsByRunner[athleteId][isoWeek].totalDistance += (activity.distance / 1000); // Convert to KM
                weeklyStatsByRunner[athleteId][isoWeek].activities.push(activity);
            });

            const sortedAthleteIds = Object.keys(weeklyStatsByRunner).sort((a, b) => {
                const nameA = allRunnerCredentials.find(rc => String(rc.athlete_id) === a)?.runner_name || `Runner ID: ${a}`;
                const nameB = allRunnerCredentials.find(rc => String(rc.athlete_id) === b)?.runner_name || `Runner ID: ${b}`;
                return nameA.localeCompare(nameB);
            });

            sortedAthleteIds.forEach(athleteId => {
                const runnerName = allRunnerCredentials.find(rc => String(rc.athlete_id) === athleteId)?.runner_name || `Runner ID: ${athleteId}`;
                const runnerClub = allRunnerCredentials.find(rc => String(rc.athlete_id) === athleteId)?.running_team || 'N/A';

                const weeklyData = weeklyStatsByRunner[athleteId];
                const sortedWeeks = Object.keys(weeklyData).sort();

                sortedWeeks.forEach(isoWeek => {
                    const weekData = weeklyData[isoWeek];
                    const totalKm = weekData.totalDistance;
                    const kmDifference = totalKm - targetKmPerWeek;

                    let amount = 0;
                    let amountType = ''; // 'penalty' or 'bonus'

                    if (kmDifference < 0) {
                        const deficitKm = Math.abs(kmDifference);
                        let rate = 0;
                        if (deficitKm <= 10) {
                            rate = penaltyPerKmLte10;
                        } else {
                            rate = penaltyPerKmGt10;
                        }
                        amount = deficitKm * rate;
                        amountType = 'penalty';
                    } else {
                        // Bonus for exceeding target (using penaltyPerKmGt10 for bonus rate)
                        amount = kmDifference * penaltyPerKmGt10;
                        amountType = 'bonus';
                    }

                    const row = penaltyBonusTableBody.insertRow();
                    row.className = amountType === 'penalty' ? 'missing-row' : ''; // Apply red style for penalty

                    row.innerHTML = `
                        <td>${runnerName}</td>
                        <td>${runnerClub}</td>
                        <td>${isoWeek.replace(/-W/, 'W')}</td>
                        <td>${totalKm.toFixed(2)}</td>
                        <td>${targetKmPerWeek.toFixed(0)}</td>
                        <td class="${kmDifference < 0 ? 'text-red-600' : 'text-green-600'} font-bold">
                            ${kmDifference.toFixed(2)}
                        </td>
                        <td class="${amountType === 'penalty' ? 'text-red-600' : 'text-green-600'} font-bold">
                            ${amount.toLocaleString('vi-VN')}
                        </td>
                    `;
                });
            });
        }

        /**
         * Renders bubble charts for distance by runner and distance by club.
         * @param {Array} activities - Array of activity objects.
         */
        function renderDistanceCharts(activities) {
            distanceByRunnerChart.innerHTML = '<p class="text-gray-500 text-sm">Biểu đồ quãng đường theo Runner sẽ hiển thị ở đây.</p>';
            distanceByClubChart.innerHTML = '<p class="text-gray-500 text-sm">Biểu đồ quãng đường theo CLB sẽ hiển thị ở đây.</p>';

            if (activities.length === 0) return;

            const distanceByRunner = new Map();
            const distanceByClub = new Map();

            activities.forEach(activity => {
                const distanceKm = activity.distance / 1000;
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                const runnerName = runner ? runner.runner_name : `Runner ID: ${activity.user_id || 'Unknown'}`;
                const clubName = runner ? runner.running_team : 'Không rõ CLB';

                distanceByRunner.set(runnerName, (distanceByRunner.get(runnerName) || 0) + distanceKm);
                distanceByClub.set(clubName, (distanceByClub.get(clubName) || 0) + distanceKm);
            });

            const runnerData = Array.from(distanceByRunner.entries()).map(([name, distance]) => ({ name, distance }));
            const clubData = Array.from(distanceByClub.entries()).map(([name, distance]) => ({ name, distance }));

            // Render Runner Chart
            drawBubbleChart(distanceByRunnerChart, runnerData, "Quãng đường (KM) theo Runner", "name", "distance");

            // Render Club Chart
            drawBubbleChart(distanceByClubChart, clubData, "Quãng đường (KM) theo CLB", "name", "distance");
        }

        /**
         * Generic function to draw a bubble chart.
         * @param {HTMLElement} container - The DOM element to append the SVG to.
         * @param {Array} data - Array of objects for the chart.
         * @param {string} title - Chart title.
         * @param {string} nameKey - Key for the name/category (e.g., 'runner_name', 'club_name').
         * @param {string} valueKey - Key for the numerical value (e.g., 'totalDistance', 'distance').
         */
        function drawBubbleChart(container, data, title, nameKey, valueKey) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">${title} - Không có dữ liệu.</p>`;
                return;
            }

            const width = container.clientWidth;
            const height = Math.max(300, data.length * 60); // Adjust height dynamically based on number of items

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxValue = d3.max(data, d => d[valueKey]);
            const minValue = d3.min(data, d => d[valueKey]);

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxValue || 1])
                .range([15, 60]);

            const colorScale = d3.scaleSequential(d3.interpolateYlGnBu)
                .domain([minValue || 0, maxValue || 1]);

            const simulation = d3.forceSimulation(data)
                .force("x", d3.forceX(width / 2).strength(0.05))
                .force("y", d3.forceY(height / 2).strength(0.05))
                .force("collide", d3.forceCollide(d => radiusScale(d[valueKey]) + 2))
                .stop();

            for (let i = 0; i < 120; ++i) simulation.tick(); // Run simulation for a fixed number of ticks

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            const bubbles = svg.selectAll(".bubble")
                .data(data)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => radiusScale(d[valueKey]))
                .attr("fill", d => colorScale(d[valueKey]))
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`${d[nameKey]}<br>${d[valueKey].toFixed(2)} KM`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            svg.selectAll(".bubble-text")
                .data(data)
                .enter().append("text")
                .attr("class", "bubble-text")
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .text(d => d[nameKey])
                .attr("dy", "0.35em")
                .attr("font-size", d => Math.max(8, radiusScale(d[valueKey]) / 3.5)) // Dynamic font size
                .attr("fill", "white")
                .attr("pointer-events", "none");

            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 30)
                .attr("text-anchor", "middle")
                .attr("font-size", "1.2rem")
                .attr("font-weight", "bold")
                .attr("fill", "#333")
                .text(title);
        }

        /**
         * Renders the Pace Distribution Chart (Histogram).
         * @param {Array} activities - Array of activity objects.
         */
        function renderPaceDistributionChart(activities) {
            paceDistributionChart.innerHTML = '<p class="text-gray-500 text-sm">Biểu đồ phân bố tốc độ trung bình sẽ hiển thị ở đây.</p>';
            if (activities.length === 0) return;

            const paceData = activities
                .filter(d => d.average_speed > 0) // Only include activities with valid speed
                .map(d => {
                    const kmPerHour = (d.average_speed * 3.6); 
                    return kmPerHour > 0 ? 60 / kmPerHour : null; // Pace in minutes per km
                })
                .filter(p => p !== null && p > 0); // Filter out invalid paces

            if (paceData.length === 0) {
                paceDistributionChart.innerHTML = '<p class="text-gray-500 text-sm">Không có dữ liệu tốc độ trung bình hợp lệ để hiển thị biểu đồ.</p>';
                return;
            }

            const container = paceDistributionChart;
            const width = container.clientWidth;
            const height = 300;
            const margin = { top: 20, right: 20, bottom: 60, left: 50 };

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const x = d3.scaleLinear()
                .domain([d3.min(paceData) * 0.9, d3.max(paceData) * 1.1]) // Dynamic domain
                .range([margin.left, width - margin.right]);

            const histogram = d3.histogram()
                .value(d => d)
                .domain(x.domain())
                .thresholds(x.ticks(20)); // 20 bins for the histogram

            const bins = histogram(paceData);

            const y = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length)]).nice()
                .range([height - margin.bottom, margin.top]);

            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).tickFormat(d => formatMinutesToPaceLabel(d)))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y));

            // Bars
            svg.selectAll("rect")
                .data(bins)
                .enter().append("rect")
                .attr("x", 1)
                .attr("transform", d => `translate(${x(d.x0)},${y(d.length)})`)
                .attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 1))
                .attr("height", d => height - margin.bottom - y(d.length))
                .attr("fill", "var(--bidv-green)") // Changed to correctly reference CSS variable
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`Pace: ${formatMinutesToPaceLabel(d.x0)} - ${formatMinutesToPaceLabel(d.x1)}<br>Số hoạt động: ${d.length}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    d3.select(this).attr("fill", "#005a57"); // Darker green on hover
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                    d3.select(this).attr("fill", "var(--bidv-green)"); // Changed to correctly reference CSS variable
                });
            
            // X-axis label
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height - 10)
                .attr("text-anchor", "middle")
                .text("Tốc độ trung bình (phút/km)");

            // Y-axis label
            svg.append("text")
                .attr("transform", `rotate(-90) translate(-${height / 2}, 15)`)
                .attr("text-anchor", "middle")
                .text("Số lượng hoạt động");

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }
        }

        // Helper for pace label on Pace Distribution chart
        function formatMinutesToPaceLabel(minutes) {
            const min = Math.floor(minutes);
            const sec = Math.round((minutes - min) * 60);
            return `${min}:${String(sec).padStart(2, '0')}`;
        }

        /**
         * Renders Heartrate vs Pace Chart (Scatter Plot).
         * @param {Array} activities - Array of activity objects.
         */
        function renderHeartratePaceChart(activities) {
            heartratePaceChart.innerHTML = '<p class="text-gray-500 text-sm">Biểu đồ nhịp tim trung bình theo tốc độ sẽ hiển thị ở đây.</p>';
            if (activities.length === 0) return;

            const data = activities.filter(d => d.average_speed > 0 && d.average_heartrate !== null);
            if (data.length === 0) {
                heartratePaceChart.innerHTML = '<p class="text-gray-500 text-sm">Không có dữ liệu nhịp tim hoặc tốc độ hợp lệ để hiển thị biểu đồ.</p>';
                return;
            }

            // Convert average_speed (m/s) to pace (minutes/km) for the x-axis
            const chartData = data.map(d => ({
                pace: d.average_speed > 0 ? (60 / (d.average_speed * 3.6)) : null,
                heartrate: d.average_heartrate
            })).filter(d => d.pace !== null);

            if (chartData.length === 0) {
                 heartratePaceChart.innerHTML = '<p class="text-gray-500 text-sm">Không có dữ liệu nhịp tim hoặc tốc độ hợp lệ để hiển thị biểu đồ.</p>';
                return;
            }

            const container = heartratePaceChart;
            const width = container.clientWidth;
            const height = 300;
            const margin = { top: 20, right: 20, bottom: 60, left: 50 };

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const x = d3.scaleLinear()
                .domain([d3.min(chartData, d => d.pace) * 0.9, d3.max(chartData, d => d.pace) * 1.1])
                .range([margin.left, width - margin.right]);

            const y = d3.scaleLinear()
                .domain([d3.min(chartData, d => d.heartrate) * 0.9, d3.max(chartData, d => d.heartrate) * 1.1]).nice()
                .range([height - margin.bottom, margin.top]);

            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).tickFormat(d => formatMinutesToPaceLabel(d)));

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y));

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            svg.selectAll("circle")
                .data(chartData)
                .enter().append("circle")
                .attr("cx", d => x(d.pace))
                .attr("cy", d => y(d.heartrate))
                .attr("r", 5)
                .attr("fill", "steelblue")
                .attr("opacity", 0.7)
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`Pace: ${formatMinutesToPaceLabel(d.pace)}/km<br>Nhịp tim: ${d.heartrate.toFixed(0)} bpm`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            // X-axis label
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height - 10)
                .attr("text-anchor", "middle")
                .text("Tốc độ trung bình (phút/km)");

            // Y-axis label
            svg.append("text")
                .attr("transform", `rotate(-90) translate(-${height / 2}, 15)`)
                .attr("text-anchor", "middle")
                .text("Nhịp tim trung bình (bpm)");
        }

        /**
         * Renders Activity Type Distribution Chart (Pie Chart).
         * @param {Array} activities - Array of activity objects.
         */
        function renderActivityTypeChart(activities) {
            activityTypeChart.innerHTML = '<p class="text-gray-500 text-sm">Biểu đồ phân loại hoạt động sẽ hiển thị ở đây.</p>';
            if (activities.length === 0) return;

            const activityTypeCounts = activities.reduce((acc, activity) => {
                acc[activity.type] = (acc[activity.type] || 0) + 1;
                return acc;
            }, {});

            const data = Object.entries(activityTypeCounts).map(([type, count]) => ({ type, count }));

            if (data.length === 0) {
                 activityTypeChart.innerHTML = '<p class="text-gray-500 text-sm">Không có dữ liệu loại hoạt động để hiển thị biểu đồ.</p>';
                return;
            }

            const container = activityTypeChart;
            const width = container.clientWidth;
            const height = 300;
            const radius = Math.min(width, height) / 2 - 20;

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            const pie = d3.pie()
                .sort(null)
                .value(d => d.count);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const color = d3.scaleOrdinal(d3.schemeCategory10);

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            const arcs = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.type))
                .attr("stroke", "white")
                .style("stroke-width", "2px")
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`${d.data.type}: ${d.data.count} hoạt động (${(d.data.count / activities.length * 100).toFixed(1)}%)`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", "0.35em")
                .style("text-anchor", "middle")
                .text(d => d.data.type)
                .attr("fill", "white")
                .style("font-size", "0.8rem")
                .style("pointer-events", "none");
        }


        // --- Supabase Authentication Check for Report Page ---
        async function checkAuthAndLoadReport() {
            try {
                const { data: { session }, error } = await supabaseClientInstance.auth.getSession();
                if (error || !session) {
                    console.warn('No active Supabase session found. Redirecting to Index1.html');
                    showAlert('Bạn cần đăng nhập để truy cập trang báo cáo. Đang chuyển hướng về trang đăng nhập...');
                    setTimeout(() => {
                        window.location.href = 'Index1.html';
                    }, 2000); // Redirect after 2 seconds
                    return;
                }
                
                // If session exists, set current user email and proceed to load data
                currentUserEmailSpan.textContent = session.user.email;
                await fetchAllRunnerCredentials(); // Load all runner credentials
                await fetchClubs(); // Load all clubs
                populateFilters(); // Populate dropdowns
                
                // Set default dates to past 7 days
                const today = new Date();
                const endDate = today.toISOString().split('T')[0];
                reportEndDateInput.value = endDate;

                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                const startDate = sevenDaysAgo.toISOString().split('T')[0];
                reportStartDateInput.value = startDate;

                await fetchAndRenderReportData(); // Initial data load
            } catch (authError) {
                console.error('Error during authentication check:', authError.message);
                showAlert(`Lỗi xác thực: ${authError.message}. Đang chuyển hướng về trang đăng nhập...`);
                setTimeout(() => {
                    window.location.href = 'Index1.html';
                }, 2000);
            }
        }

        // --- Event Listeners and Initialization ---
        window.onload = async () => {
            if (typeof window.supabase === 'undefined') {
                showAlert('Lỗi: Thư viện Supabase không được tải. Vui lòng kiểm tra kết nối internet hoặc URL CDN.');
                console.error('Thư viện Supabase không được định nghĩa. Vui lòng kiểm tra thẻ script CDN Supabase.');
                return;
            }
            supabaseClientInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            await checkAuthAndLoadReport();

            logoutBtn.addEventListener('click', async () => {
                const confirmed = await showConfirm('Bạn có chắc chắn muốn đăng xuất không?');
                if (confirmed) {
                    try {
                        const { error } = await supabaseClientInstance.auth.signOut();
                        if (error) throw error;
                        localStorage.removeItem('strava_access_token');
                        localStorage.removeItem('strava_refresh_token');
                        localStorage.removeItem('strava_expires_at');
                        localStorage.removeItem('strava_athlete_id');
                        localStorage.removeItem('strava_runner_name');
                        localStorage.removeItem('strava_runner_credential_id');
                        localStorage.removeItem('strava_authenticated');
                        showAlert('Đăng xuất thành công. Đang chuyển hướng về trang đăng nhập...');
                        setTimeout(() => {
                            window.location.href = 'Index1.html';
                        }, 1500);
                    } catch (error) {
                        console.error('Lỗi đăng xuất:', error.message);
                        showAlert(`Lỗi khi đăng xuất: ${error.message}`);
                    }
                }
            });

            applyReportFiltersBtn.addEventListener('click', fetchAndRenderReportData);
            reportRunnerFilter.addEventListener('change', (e) => {
                selectedRunnerIdReport = e.target.value;
                // No automatic re-fetch, user clicks apply button
            });
            reportClubFilter.addEventListener('change', (e) => {
                selectedClubNameReport = e.target.value;
                // No automatic re-fetch, user clicks apply button
            });
            penaltyPerKmGt10Input.addEventListener('input', renderAllReports);
            penaltyPerKmLte10Input.addEventListener('input', renderAllReports);
            targetKmPerWeekInput.addEventListener('input', renderAllReports);

            closeWeeklyActivitiesModalBtn.addEventListener('click', () => {
                weeklyActivitiesModal.style.display = 'none';
            });

            // Scroll-to-top button logic
            const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
            window.onscroll = function() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollToTopBtn.style.display = "block";
                } else {
                    scrollToTopBtn.style.display = "none";
                }
            };
            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });

            // Re-render charts on window resize
            window.addEventListener('resize', () => {
                if (allActivitiesData.length > 0) {
                    renderDistanceCharts(allActivitiesData);
                    renderPaceDistributionChart(allActivitiesData);
                    renderHeartratePaceChart(allActivitiesData);
                    renderActivityTypeChart(allActivitiesData);
                    renderWeeklyDistanceChart(allActivitiesData);
                }
            });
        };
    </script>
</body>
</html>
 