<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o ho·∫°t ƒë·ªông ch·∫°y b·ªô - FOR RUNNER LOVER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for bubble charts and weekly distance (from original report.html) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Chart.js for other charts (from report origin.html) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define BIDV brand colors */
        :root {
            --bidv-green: #006b68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .btn-primary {
            background-color: var(--bidv-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: #005a57;
        }

        .btn-secondary {
            background-color: var(--bidv-yellow);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background-color: #e6b32a;
        }

        .btn-danger {
            @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out shadow-md;
        }

        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500;
        }
        
        /* Multi-select specific CSS (from original report.html) */
        .multi-select-container {
            position: relative;
        }
        .multi-select-selected-items {
            @apply w-full p-2 border border-gray-300 rounded-md bg-white cursor-pointer flex flex-wrap gap-1;
            min-height: 42px;
            align-items: center;
        }
        .multi-select-selected-item {
            @apply bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full flex items-center gap-1;
        }
        .multi-select-selected-item span {
            cursor: pointer;
            font-weight: bold;
        }
        .multi-select-options {
            @apply absolute w-full border border-gray-300 rounded-md bg-white shadow-lg z-10;
            max-height: 200px;
            overflow-y: auto;
        }
        .multi-select-option {
            @apply p-2 cursor-pointer hover:bg-gray-100;
        }
        .multi-select-option.selected {
            @apply bg-blue-100 font-semibold;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        /* Chart.js specific styles from report origin.html */
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
            width: 100%;
        }

        /* D3.js chart specific styles (from original report.html) */
        #distance-by-runner-chart,
        #distance-by-club-chart,
        #weekly-distance-chart-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            min-height: 300px;
        }

        .bubble {
            fill-opacity: 0.7;
            cursor: pointer;
            transition: fill-opacity 0.3s ease;
        }

        .bubble:hover {
            fill-opacity: 1;
        }

        .bubble-text {
            font-size: 0.8rem;
            text-anchor: middle;
            fill: white;
            pointer-events: none;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .grid-cols-1-md-grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--bidv-green);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        .data-table th {
            background-color: var(--bidv-green);
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .data-table tbody tr:hover {
            background-color: #f0f2f5;
        }
        .data-table .total-row {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        .data-table .summary-row {
            background-color: #d1e7dd;
            font-weight: bold;
        }
        .data-table .missing-row {
            background-color: #fee2e2;
            color: #ef4444;
            font-weight: bold;
        }
        .data-table .runner-summary-group {
             border-bottom: 2px solid var(--bidv-green);
        }
        .data-table .runner-summary-group .total-row td,
        .data-table .runner-summary-group .summary-row td {
            border-bottom: none;
        }
        .data-table .runner-summary-group .total-row {
            border-bottom: 1px solid #e2e8f0;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        input[type="date"] {
            position: relative;
        }
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-clear-button {
            display: none;
        }

        #scroll-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--bidv-green);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }

        #scroll-to-top-btn:hover {
            background-color: #005a57;
        }

        #custom-alert, #custom-confirm-modal, #training-suggestions-modal {
            background-color: rgba(0, 0, 0, 0.5);
            /* display: flex; <-- REMOVED this line as 'hidden' class handles it */
            align-items: center;
            justify-content: center;
        }

        /* Collapsible content styles */
        .collapsible-content {
            max-height: 1000px; /* Arbitrarily large value for expanded state */
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        /* Add this rule to properly hide table bodies */
        tbody.collapsible-content.collapsed {
            display: none;
        }

    </style>
</head>
<body>
    <header class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="Running-Management-logo.png" alt="Logo Den lu Running Club" class="h-20 w-auto rounded-md">
                <h1 class="text-2xl font-bold text-white">B√°o c√°o ho·∫°t ƒë·ªông ch·∫°y b·ªô - FOR RUNNER LOVER</h1>
            </div>
            <nav class="flex items-center space-x-4"> <!-- Added flex and space-x-4 for proper spacing -->
                <button id="back-to-home-btn" class="btn-primary">
                    <i class="fas fa-home"></i> Quay v·ªÅ
                </button>
                <button id="logout-btn" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <section id="report-dashboard" class="card mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center text-bidv-green">B√°o c√°o ho·∫°t ƒë·ªông</h2>
            <p id="user-info" class="text-lg font-medium text-center mb-6">Ch√†o m·ª´ng, <span id="current-user-email"></span>!</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- B·ªô l·ªçc -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700"><i class="fas fa-filter"></i> B·ªô l·ªçc b√°o c√°o</h3>
                    <div class="mb-4">
                        <label for="report-runner-filter" class="block text-gray-700 text-sm font-bold mb-2">Ch·ªçn Runner:</label>
                        <select id="report-runner-filter" class="form-input">
                            <option value="all">T·∫•t c·∫£ Runner</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="report-club-filter" class="block text-gray-700 text-sm font-bold mb-2">Ch·ªçn C√¢u l·∫°c b·ªô:</label>
                        <select id="report-club-filter" class="form-input">
                            <option value="all">T·∫•t c·∫£ C√¢u l·∫°c b·ªô</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="report-activity-type-filter" class="block text-gray-700 text-sm font-bold mb-2">Lo·∫°i ho·∫°t ƒë·ªông:</label>
                        <div class="multi-select-container">
                            <div id="multi-select-display-report" class="multi-select-selected-items">
                                <span class="text-gray-500">Ch·ªçn lo·∫°i ho·∫°t ƒë·ªông</span>
                            </div>
                            <div id="multi-select-options-report" class="multi-select-options hidden">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="report-min-pace" class="block text-gray-700 text-sm font-bold mb-2">Pace (ph√∫t/km) nh·ªè h∆°n ho·∫∑c b·∫±ng:</label>
                        <input type="number" id="report-min-pace" class="form-input" placeholder="V√≠ d·ª•: 5.5 (5 ph√∫t 30 gi√¢y/km)" step="0.1">
                    </div>

                    <div class="mb-4">
                        <label for="report-min-distance" class="block text-gray-700 text-sm font-bold mb-2">Qu√£ng ƒë∆∞·ªùng (km) l·ªõn h∆°n ho·∫∑c b·∫±ng:</label>
                        <input type="number" id="report-min-distance" class="form-input" placeholder="V√≠ d·ª•: 10" step="0.1">
                    </div>

                    <div class="mb-4 flex gap-4">
                        <div class="flex-1">
                            <label for="report-start-date" class="block text-gray-700 text-sm font-bold mb-2">T·ª´ ng√†y:</label>
                            <input type="date" id="report-start-date" class="form-input">
                        </div>
                        <div class="flex-1">
                            <label for="report-end-date" class="block text-gray-700 text-sm font-bold mb-2">ƒê·∫øn ng√†y:</label>
                            <input type="date" id="report-end-date" class="form-input">
                        </div>
                    </div>
                    <button id="apply-report-filters-btn" class="btn-primary w-full">
                        √Åp d·ª•ng b·ªô l·ªçc
                    </button>
                    <div id="report-filter-status" class="mt-2 text-sm text-gray-600 text-center"></div>
                </div>

                <!-- T·ªïng quan th·ªëng k√™ -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">T·ªïng quan th·ªëng k√™</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-1">T·ªïng qu√£ng ƒë∆∞·ªùng</h2>
                            <p id="totalDistance" class="text-2xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-1">T·ªïng th·ªùi gian di chuy·ªÉn</h2>
                            <p id="totalMovingTime" class="text-2xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-1">T·ªëc ƒë·ªô trung b√¨nh</h2>
                            <p id="averageOverallPace" class="text-2xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-1">Ho·∫°t ƒë·ªông</h2>
                            <p id="totalActivities" class="text-2xl font-bold"></p>
                        </div>
                    </div>
                    <button id="get-training-suggestions-btn" class="btn-primary w-full mt-6 flex items-center justify-center">
                        <i class="fas fa-magic mr-2"></i> ‚ú®G·ª£i √Ω Luy·ªán t·∫≠p Th√¥ng minh
                        <span id="training-suggestions-loader" class="loader hidden"></span>
                    </button>
                </div>
            </div>

            <!-- Charts Section (from report origin.html - Chart.js) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Qu√£ng ƒë∆∞·ªùng ch·∫°y theo ng√†y (km)</h2>
                    <div class="chart-container">
                        <canvas id="distanceChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Ph√¢n b·ªë t·ªëc ƒë·ªô trung b√¨nh (ph√∫t/km)</h2>
                    <div class="chart-container">
                        <canvas id="paceDistributionChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Nh·ªãp tim trung b√¨nh theo t·ªëc ƒë·ªô (ph√∫t/km)</h2>
                    <div class="chart-container">
                        <canvas id="heartRatePaceChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Ph√¢n lo·∫°i ho·∫°t ƒë·ªông</h2>
                    <div class="chart-container">
                        <canvas id="activityTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- D3.js Charts (Restored from original report.html) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-green-700">Qu√£ng ƒë∆∞·ªùng (KM) theo Runner</h3>
                    <div id="distance-by-runner-chart" class="mt-4 border rounded-md p-2 min-h-[150px] flex items-center justify-content-center">
                        <p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì qu√£ng ƒë∆∞·ªùng theo Runner s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-yellow-700">Qu√£ng ƒë∆∞·ªùng (KM) theo CLB</h3>
                    <div id="distance-by-club-chart" class="mt-4 border rounded-md p-2 min-h-[150px] flex items-center justify-content-center">
                        <p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì qu√£ng ƒë∆∞·ªùng theo CLB s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
                    </div>
                    <div id="distance-by-club-legend" class="mt-4 overflow-x-auto"></div>
                </div>
            </div>

            <!-- B·∫£ng chi ti·∫øt ho·∫°t ƒë·ªông (Collapsible) -->
            <div id="detailed-activities-section" class="card mt-8 p-6">
                <div class="flex justify-between items-center mb-4">
                    <div id="detailed-activities-header" class="flex items-center cursor-pointer">
                        <h3 class="text-xl font-semibold text-blue-700">
                            <i class="fas fa-list mr-2"></i> Chi ti·∫øt c√°c ho·∫°t ƒë·ªông
                        </h3>
                        <i id="detailed-activities-toggle-icon" class="fas fa-chevron-down text-gray-600 transition-transform duration-300 ml-2"></i>
                    </div>
                    <button id="download-detailed-activities-excel" class="btn-secondary ml-4">
                        <i class="fas fa-download mr-2"></i> T·∫£i Excel
                    </button>
                </div>
                <div id="detailed-activities-content" class="collapsible-content overflow-x-auto">
                    <table id="detailed-activities-table" class="data-table">
                        <thead>
                            <tr>
                                <th>T√™n Runner</th>
                                <th>CLB</th>
                                <th>T√™n ho·∫°t ƒë·ªông</th>
                                <th>Lo·∫°i</th>
                                <th>Ng√†y</th>
                                <th>Qu√£ng ƒë∆∞·ªùng (KM)</th>
                                <th>Th·ªùi gian</th>
                                <th>Pace</th>
                                <th>Nh·ªãp tim TB</th>
                                <th>ƒê·ªô cao tƒÉng (m)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Ho·∫°t ƒë·ªông s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
                        </tbody>
                    </table>
                    <p id="detailed-activities-status" class="mt-4 text-sm text-gray-600 text-center">Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o ƒë·ªÉ hi·ªÉn th·ªã.</p>
                </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì th·ªëng k√™ theo tu·∫ßn -->
            <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-red-700"><i class="fas fa-chart-line"></i> Th·ªëng k√™ qu√£ng ƒë∆∞·ªùng theo tu·∫ßn</h3>
                <div id="weekly-distance-chart-container" class="border rounded-md p-2 min-h-[300px] flex items-center justify-content-center">
                    <p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì th·ªëng k√™ qu√£ng ƒë∆∞·ªùng theo tu·∫ßn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
                </div>
                <p id="weekly-chart-status" class="mt-4 text-sm text-gray-600 text-center"></p>
            </div>

             <!-- B·∫£ng th·ªëng k√™ chi ti·∫øt & Ti·ªÅn ph·∫°t/Th∆∞·ªüng -->
             <div class="card mt-8 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-teal-700"><i class="fas fa-calculator"></i> Th·ªëng k√™ ti·ªÅn ph·∫°t/th∆∞·ªüng</h3>
                    <button id="download-penalty-bonus-excel" class="btn-secondary ml-4">
                        <i class="fas fa-download mr-2"></i> T·∫£i Excel
                    </button>
                </div>
                <div class="mb-4 flex gap-4 items-end">
                    <div class="flex-1">
                        <label for="penalty-per-km-gt10" class="block text-gray-700 text-sm font-bold mb-2">S·ªë ti·ªÅn n·ªôp cho 1KM (ngh√¨n VNƒê) khi thi·∫øu > 10KM:</label>
                        <input type="number" id="penalty-per-km-gt10" class="form-input bg-yellow-100" value="30" min="0" step="1">
                    </div>
                    <div class="flex-1">
                        <label for="penalty-per-km-lte10" class="block text-gray-700 text-sm font-bold mb-2">S·ªë ti·ªÅn n·ªôp cho 1KM (ngh√¨n VNƒê) khi thi·∫øu <= 10KM:</label>
                        <input type="number" id="penalty-per-km-lte10" class="form-input bg-yellow-100" value="20" min="0" step="1">
                    </div>
                    <div class="flex-1">
                        <label for="target-km-per-week" class="block text-gray-700 text-sm font-bold mb-2">S·ªë KM m·ªôt tu·∫ßn (KM):</label>
                        <input type="number" id="target-km-per-week" class="form-input bg-yellow-100" value="25" min="0" step="1">
                    </div>
                </div>
                <div id="detailed-stats-table-container" class="overflow-x-auto">
                    <table id="penalty-bonus-table" class="data-table">
                        <thead>
                            <tr>
                                <th>T√™n Runner</th>
                                <th>Ng√†y ch·∫°y</th>
                                <th>T√™n Ho·∫°t ƒê·ªông</th>
                                <th>Lo·∫°i</th>
                                <th>Qu√£ng ƒë∆∞·ªùng (KM)</th>
                                <th>Pace</th>
                                <th>Th·ªùi gian</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="penalty-bonus-status" class="mt-4 text-sm text-gray-600 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</p>
            </div>


        </section>
    </main>

    <footer class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container" style="color: var(--bidv-yellow);">
            &copy; 2025 Tr∆∞∆°ng H·ªìng Qu√¢n - ƒê·ªÅn L·ª´ Running Club. All rights reserved (Dev by AIs - Gemini, GPT) - üìßquantrhvn@gmail.com - üì≥+84989073739 - 248064a v2.
            <br>
            <img src="PowerStrava.png" alt="PowerStrava Logo" style="height: 28px; margin: 5px auto 0 auto; display: block;">
        </div>
    </footer>

    <!-- Weekly Activities Modal -->
    <div id="weekly-activities-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="close-weekly-activities-modal-btn">&times;</span>
            <h3 id="weekly-activities-title" class="text-2xl font-bold mb-4 text-gray-800">Ho·∫°t ƒë·ªông trong tu·∫ßn:</h3>
            <div class="max-h-96 overflow-y-auto border rounded-md p-2">
                <ul id="weekly-activities-list" class="space-y-2 text-sm">
                    <!-- Activities will be loaded here -->
                </ul>
            </div>
            <p id="weekly-activities-status" class="mt-4 text-sm text-gray-600"></p>
        </div>
    </div>

    <!-- Training Suggestions Modal -->
    <div id="training-suggestions-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-button" id="close-training-suggestions-modal-btn">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">G·ª£i √Ω Luy·ªán t·∫≠p t·ª´ AI</h3>
            <div id="training-suggestions-content" class="prose max-w-none">
                <!-- AI suggestions will be loaded here -->
            </div>
            <p id="training-suggestions-status" class="mt-4 text-sm text-gray-600"></p>
        </div>
    </div>


    <!-- Custom Alert/Confirm Modals -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-content-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="alert-message" class="mb-4 text-lg"></p>
            <button id="alert-ok-btn" class="btn-primary">OK</button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-content-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="mb-4 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button type="button" id="confirm-cancel-btn" class="btn-primary">H·ªßy</button>
                <button type="button" id="confirm-ok-btn" class="btn-danger">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <button id="scroll-to-top-btn" title="Go to top">‚ñ≤</button>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Replace with your Supabase Anon Key

        // Supabase Edge Function URL to fetch activities (from original report.html)
        // const GET_STATS_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/get-user-activities'; // Original
        // New: Edge Function for Gemini analysis
        const ANALYZE_ACTIVITIES_EDGE_FUNCTION_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/analyze-activities-with-gemini';


        let supabaseClientInstance;
        let allRunnerCredentials = []; // Used for filtering and display (from original report.html)
        let allClubs = []; // Used for filtering and display (from original report.html)
        let allActivitiesData = []; // Store all fetched activities for the report (from original report.html)

        // Filter states (from original report.html)
        let selectedRunnerIdReport = 'all'; 
        let selectedClubNameReport = 'all'; 
        let selectedActivityTypesReport = []; 
        let minPaceFilter = null; // New filter for minimum pace (seconds/km)
        let minDistanceFilter = null; // New filter for minimum distance (km)


        // Chart.js instances (from report origin.html)
        let distanceChart, paceDistributionChart, heartRatePaceChart, activityTypeChart;

        // DOM Elements
        const currentUserEmailSpan = document.getElementById('current-user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn'); // Added back to home button

        // Filter elements (from original report.html's filter section)
        const reportRunnerFilter = document.getElementById('report-runner-filter');
        const reportClubFilter = document.getElementById('report-club-filter');
        const multiSelectDisplayReport = document.getElementById('multi-select-display-report');
        const multiSelectOptionsReport = document.getElementById('multi-select-options-report');
        const reportMinPaceInput = document.getElementById('report-min-pace'); // New pace filter input
        const reportMinDistanceInput = document.getElementById('report-min-distance'); // New distance filter input
        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const applyReportFiltersBtn = document.getElementById('apply-report-filters-btn');
        const reportFilterStatus = document.getElementById('report-filter-status');
        
        // Summary stats elements (from report origin.html, using Chart.js related IDs)
        const totalDistanceSpan = document.getElementById('totalDistance');
        const totalMovingTimeSpan = document.getElementById('totalMovingTime');
        const averageOverallPaceSpan = document.getElementById('averageOverallPace');
        const totalActivitiesSpan = document.getElementById('totalActivities');

        // New Gemini API related elements
        const getTrainingSuggestionsBtn = document.getElementById('get-training-suggestions-btn');
        const trainingSuggestionsLoader = document.getElementById('training-suggestions-loader');
        const trainingSuggestionsModal = document.getElementById('training-suggestions-modal');
        const closeTrainingSuggestionsModalBtn = document.getElementById('close-training-suggestions-modal-btn');
        const trainingSuggestionsContent = document.getElementById('training-suggestions-content');
        const trainingSuggestionsStatus = document.getElementById('training-suggestions-status');


        // D3.js chart specific elements (from original report.html)
        const distanceByRunnerChart = document.getElementById('distance-by-runner-chart'); 
        const distanceByClubChart = document.getElementById('distance-by-club-chart'); 

        // Detailed Activities Table elements (from original report.html)
        const detailedActivitiesTableBody = document.querySelector('#detailed-activities-table tbody');
        const detailedActivitiesStatus = document.getElementById('detailed-activities-status');
        const downloadDetailedActivitiesExcelBtn = document.getElementById('download-detailed-activities-excel');


        // Weekly Distance Chart elements (from original report.html)
        const weeklyDistanceChartContainer = document.getElementById('weekly-distance-chart-container');
        const weeklyChartStatus = document.getElementById('weekly-chart-status');

        // Penalty/Bonus Table elements (from original report.html)
        const penaltyPerKmGt10Input = document.getElementById('penalty-per-km-gt10');
        const penaltyPerKmLte10Input = document.getElementById('penalty-per-km-lte10');
        const targetKmPerWeekInput = document.getElementById('target-km-per-week');
        const penaltyBonusTableBody = document.querySelector('#penalty-bonus-table tbody');
        const penaltyBonusStatus = document.getElementById('penalty-bonus-status');
        const downloadPenaltyBonusExcelBtn = document.getElementById('download-penalty-bonus-excel');


        // Weekly Activities Modal elements (from original report.html)
        const weeklyActivitiesModal = document.getElementById('weekly-activities-modal');
        const closeWeeklyActivitiesModalBtn = document.getElementById('close-weekly-activities-modal-btn');
        const weeklyActivitiesTitle = document.getElementById('weekly-activities-title');
        const weeklyActivitiesList = document.getElementById('weekly-activities-list');
        const weeklyActivitiesStatus = document.getElementById('weekly-activities-status');

        // Collapsible section elements (for Detailed Activities Table)
        const detailedActivitiesSection = document.getElementById('detailed-activities-section');
        const detailedActivitiesHeader = document.getElementById('detailed-activities-header');
        const detailedActivitiesContent = document.getElementById('detailed-activities-content');
        const detailedActivitiesToggleIcon = document.getElementById('detailed-activities-toggle-icon');
        const DETAILED_ACTIVITIES_STATE_KEY = 'detailedActivitiesCollapsed';


        // All Activity Types for multi-select (from original report.html)
        const ALL_ACTIVITY_TYPES = [
            'Run', 'Walk', 'Ride', 'Swim', 'Hike', 'NordicSki', 'AlpineSki', 'Workout', 'Yoga', 
            'WeightTraining', 'Elliptical', 'StairStepper', 'Rowing', 'Crossfit', 'Canoeing', 
            'Kayaking', 'StandUpPaddling', 'VirtualRide', 'VirtualRun', 'Wheelchair', 'Handcycle', 
            'RollerSki', 'IceSkate', 'Snowboard', 'Snowshoe', 'BackcountrySki', 'EMountainBikeRide', 
            'EBikeRide', 'MountainBikeRide', 'GravelRide', 'Velomobile', 'Kitesurf', 'Windsurf', 
            'RockClimbing', 'Alpinism', 'Badminton', 'Squash', 'TableTennis', 'Tennis', 'Volleyball', 
            'Surfing', 'Pilates', 'Golf', 'WaterSport', 'Soccer', 'Basketball'
        ].sort(); // Sort activity types alphabetically


        // --- Helper Functions ---

        function showAlert(message) {
            const customAlert = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
            customAlert.style.display = 'flex'; // Ensure it's visible

            alertOkBtn.onclick = () => {
                customAlert.classList.add('hidden');
                customAlert.style.display = 'none'; // Ensure it's hidden
            };
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const customConfirm = document.getElementById('custom-confirm-modal');
                const confirmMessage = document.getElementById('confirm-message');
                const confirmOkBtn = document.getElementById('confirm-ok-btn'); 
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                confirmMessage.textContent = message;
                customConfirm.classList.remove('hidden');
                customConfirm.style.display = 'flex'; // Ensure it's visible

                const cleanup = () => {
                    customConfirm.classList.add('hidden');
                    customConfirm.style.display = 'none'; // Ensure it's hidden
                    confirmOkBtn.onclick = null;
                    confirmCancelBtn.onclick = null;
                };

                confirmOkBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                confirmCancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        // Function to convert seconds to HH:MM:SS format (used for total moving time) - from report origin.html
        function formatTime(seconds) {
            if (seconds === null || isNaN(seconds)) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s]
                .map(v => v < 10 ? '0' + v : v)
                .filter((v, i) => v !== '00' || i > 0)
                .join(':') || '00:00';
        }

        // Function to format seconds into MM:SS for pace labels (used for chart axes and tooltips) - from report origin.html
        // This function assumes valid totalSeconds input. The validity check should happen upstream.
        function formatPaceLabel(totalSeconds) {
            console.log('DEBUG: formatPaceLabel input totalSeconds:', totalSeconds);
            if (totalSeconds === null || isNaN(totalSeconds) || totalSeconds < 0) {
                console.log('DEBUG: formatPaceLabel output: N/A (invalid input)');
                return 'N/A';
            }
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);
            console.log(`DEBUG: minutes=${minutes}, seconds=${seconds} for totalSeconds=${totalSeconds}`);
            const formatted = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            console.log('DEBUG: formatPaceLabel output:', formatted);
            return formatted;
        }

        // Function to convert average_speed (m/s) to pace (min/km) formatted as MM:SS /km (used for overall summary)
        function formatPace(speedMs) {
            console.log('DEBUG: formatPace input speedMs (for overall summary):', speedMs);
            if (speedMs === null || isNaN(speedMs) || speedMs <= 0) {
                console.log('DEBUG: formatPace output (overall): N/A (invalid speedMs)');
                return 'N/A';
            }
            // Check for extremely fast pace that would result in 00:00 (less than 0.5 seconds/km)
            const paceSecondsPerKm = 1000 / speedMs; // total seconds per kilometer
            console.log('DEBUG: Calculated paceSecondsPerKm (overall):', paceSecondsPerKm);

            if (paceSecondsPerKm < 0.5) { 
                console.warn('DEBUG: Extremely fast pace detected, returning N/A. Pace seconds/km:', paceSecondsPerKm);
                return 'N/A'; // Revert to plain N/A
            }

            const formatted = `${formatPaceLabel(paceSecondsPerKm)} /km`;
            console.log('DEBUG: formatPace output (overall):', formatted);
            return formatted;
        }
        
        // Original formatPace from initial report.html for detailed table
        function formatPaceForTable(metersPerSecond) {
            console.log('DEBUG: formatPaceForTable input metersPerSecond (for detailed table):', metersPerSecond);
            if (typeof metersPerSecond !== 'number' || isNaN(metersPerSecond) || metersPerSecond <= 0) {
                console.log('DEBUG: formatPaceForTable output (individual): N/A (invalid metersPerSecond)');
                return 'N/A';
            }
            const kmPerHour = (metersPerSecond * 3.6); 
            if (kmPerHour === 0) {
                console.log('DEBUG: formatPaceForTable output (individual): N/A (kmPerHour is 0)');
                return 'N/A';
            }
            const minutesPerKm = 60 / kmPerHour; 
            console.log('DEBUG: Calculated minutesPerKm (individual):', minutesPerKm);

            // Check for extremely fast pace that would result in 00:00 (less than 0.5 seconds)
            if (minutesPerKm < (0.5 / 60)) { 
                console.warn('DEBUG: Extremely fast pace detected for table, returning N/A. Minutes per Km:', minutesPerKm);
                return 'N/A'; // Revert to plain N/A
            }

            const minutes = Math.floor(minutesPerKm);
            const seconds = Math.round((minutesPerKm - minutes) * 60);
            console.log(`DEBUG: minutes (table)=${minutes}, seconds (table)=${seconds} for minutesPerKm=${minutesPerKm}`);
            return `${minutes}:${String(seconds).padStart(2, '0')} /km`;
        }

        // Function to format elevation gain (m)
        function formatElevationGain(meters) {
            if (meters === null || isNaN(meters)) return 'N/A';
            return `${Math.round(meters)} m`;
        }

        /**
         * Populates the multi-select filter dropdowns (from original report.html).
         */
        function populateActivityTypeFilters() {
            multiSelectOptionsReport.innerHTML = ''; 
            ALL_ACTIVITY_TYPES.forEach(type => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.textContent = type;
                optionDiv.dataset.value = type;
                multiSelectOptionsReport.appendChild(optionDiv);
            });
        }

        /**
         * Updates the display of selected items in the multi-select (from original report.html).
         * @param {HTMLElement} displayElement - The element to show selected tags.
         * @param {string[]} selectedTypes - Array of selected activity types.
         * @param {HTMLElement} optionsContainer - The container for options to update their 'selected' class.
         */
        function updateMultiSelectDisplay(displayElement, selectedTypes, optionsContainer) {
            displayElement.innerHTML = '';
            if (selectedTypes.length === 0) {
                displayElement.innerHTML = '<span class="text-gray-500">Ch·ªçn lo·∫°i ho·∫°t ƒë·ªông</span>';
            } else {
                selectedTypes.forEach(type => {
                    const itemSpan = document.createElement('span');
                    itemSpan.className = 'multi-select-selected-item';
                    itemSpan.innerHTML = `${type} <span data-value="${type}" class="remove-item-btn">&times;</span>`;
                    displayElement.appendChild(itemSpan);
                });
            }

            Array.from(optionsContainer.children).forEach(optionDiv => {
                if (selectedTypes.includes(optionDiv.dataset.value)) {
                    optionDiv.classList.add('selected');
                } else {
                    optionDiv.classList.remove('selected');
                }
            });
        }

        /**
         * Toggles an activity type in the selected list (from original report.html).
         * @param {string} type - The activity type to toggle.
         * @param {string[]} selectedTypesArray - The array to modify.
         * @param {HTMLElement} displayElement - The display element for this filter.
         * @param {HTMLElement} optionsContainer - The options container for this filter.
         */
        function toggleActivityType(type, selectedTypesArray, displayElement, optionsContainer) {
            const index = selectedTypesArray.indexOf(type);
            if (index > -1) {
                selectedTypesArray.splice(index, 1); // Remove if already exists
            } else {
                selectedTypesArray.push(type); // Add if not exists
                selectedTypesArray.sort(); // Keep sorted alphabetically
            }
            updateMultiSelectDisplay(displayElement, selectedTypesArray, optionsContainer);
        }

        // Event delegation for multi-select options (Report Page specific)
        document.addEventListener('click', (event) => {
            // Toggle options visibility
            if (event.target.closest('#multi-select-display-report')) {
                document.getElementById('multi-select-options-report').classList.toggle('hidden');
            } else {
                // Click outside to close options
                if (!event.target.closest('#multi-select-options-report')) {
                    document.getElementById('multi-select-options-report').classList.add('hidden');
                }
            }

            // Handle option selection/deselection
            if (event.target.classList.contains('multi-select-option')) {
                const type = event.target.dataset.value;
                if (event.target.closest('#multi-select-options-report')) {
                    toggleActivityType(type, selectedActivityTypesReport, multiSelectDisplayReport, multiSelectOptionsReport);
                }
            } else if (event.target.classList.contains('remove-item-btn')) {
                const type = event.target.dataset.value;
                if (event.target.closest('#multi-select-display-report')) {
                    toggleActivityType(type, selectedActivityTypesReport, multiSelectDisplayReport, multiSelectOptionsReport);
                }
            }
        });


        /**
         * Fetches all runner credentials for the logged-in user from Supabase (from original report.html).
         */
        async function fetchAllRunnerCredentials() {
            try {
                const { data, error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('*')
                    .order('runner_name', { ascending: true });
                if (error) throw error;
                allRunnerCredentials = data;
                console.log('Fetched all runner credentials for report:', allRunnerCredentials);
            } catch (error) {
                console.error('Error fetching all runner credentials:', error.message);
                showAlert(`L·ªói khi t·∫£i th√¥ng tin runner: ${error.message}`);
                allRunnerCredentials = [];
            }
        }

        /**
         * Fetches clubs from Supabase and updates the global `allClubs` array (from original report.html).
         */
        async function fetchClubs() {
            try {
                const { data, error } = await supabaseClientInstance
                    .from('clubs')
                    .select('*')
                    .order('name', { ascending: true });
                if (error) throw error;
                allClubs = data;
                console.log('Fetched clubs for report:', allClubs);
            } catch (error) {
                console.error('Error fetching clubs for report:', error.message);
                showAlert(`L·ªói khi t·∫£i danh s√°ch c√¢u l·∫°c b·ªô: ${error.message}`);
                allClubs = [];
            }
        }

        /**
         * Populates the runner and club filter dropdowns (from original report.html).
         */
        function populateFilters() {
            // Populate Runner filter
            reportRunnerFilter.innerHTML = '<option value="all">T·∫•t c·∫£ Runner</option>';
            allRunnerCredentials.forEach(cred => {
                const option = document.createElement('option');
                option.value = String(cred.athlete_id); // Use athlete_id for filtering activities
                option.textContent = cred.runner_name;
                reportRunnerFilter.appendChild(option);
            });
            reportRunnerFilter.value = selectedRunnerIdReport; // Restore previous selection

            // Populate Club filter
            reportClubFilter.innerHTML = '<option value="all">T·∫•t c·∫£ C√¢u l·∫°c b·ªô</option>';
            allClubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club.name;
                option.textContent = club.name;
                reportClubFilter.appendChild(option);
            });
            reportClubFilter.value = selectedClubNameReport; // Restore previous selection

            // Initialize activity type filter
            populateActivityTypeFilters();
            updateMultiSelectDisplay(multiSelectDisplayReport, selectedActivityTypesReport, multiSelectOptionsReport);

            // Restore pace and distance filter values
            reportMinPaceInput.value = minPaceFilter !== null ? minPaceFilter : '';
            reportMinDistanceInput.value = minDistanceFilter !== null ? minDistanceFilter : '';
        }

        /**
         * Fetches activity data based on current filters from Supabase and then renders all reports.
         * (Adapted from original report.html)
         */
        async function fetchAndRenderReportData() {
            reportFilterStatus.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu b√°o c√°o...';
            allActivitiesData = []; // Clear previous data

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y phi√™n ƒëƒÉng nh·∫≠p Supabase. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                }

                // Prepare filters for the Supabase query
                let queryRunnerIds = [];
                if (selectedRunnerIdReport === 'all') {
                    // If 'All Runners' is selected, get all athlete_ids that exist
                    queryRunnerIds = allRunnerCredentials.filter(c => c.athlete_id).map(c => String(c.athlete_id));
                } else {
                    queryRunnerIds = [selectedRunnerIdReport];
                }

                // If a specific club is selected, narrow down runner IDs further
                if (selectedClubNameReport !== 'all') {
                    const runnersInSelectedClub = allRunnerCredentials.filter(
                        c => c.running_team === selectedClubNameReport && c.athlete_id
                    ).map(c => String(c.athlete_id));
                    queryRunnerIds = queryRunnerIds.filter(id => runnersInSelectedClub.includes(id));
                }

                if (queryRunnerIds.length === 0) {
                    reportFilterStatus.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã v·ªõi c√°c b·ªô l·ªçc ƒë√£ ch·ªçn. Vui l√≤ng ƒëi·ªÅu ch·ªânh b·ªô l·ªçc.';
                    renderAllReports(); // Render empty reports
                    return;
                }

                let query = supabaseClientInstance
                    .from('activities')
                    .select('strava_activity_id, name, type, distance, moving_time, total_elevation_gain, start_date, average_speed, average_heartrate, user_id')
                    .in('user_id', queryRunnerIds); // Filter by runner IDs

                if (selectedActivityTypesReport.length > 0) {
                    query = query.in('type', selectedActivityTypesReport);
                }

                // Apply new pace filter (average_speed is in m/s, convert min/km to m/s)
                // pace (min/km) = 60 / (speed in km/h) = 60 / (speed_ms * 3.6)
                // speed_ms = 1000 / pace_seconds_per_km
                // So, if user enters min pace in min/km, we need to convert it to max average_speed in m/s
                if (minPaceFilter !== null && minPaceFilter > 0) {
                    // Convert minPace (min/km) to min_speed (m/s)
                    // minPace (min/km) = minPace * 60 (seconds/km)
                    // min_speed_ms = 1000 / (minPace * 60)
                    const minSpeedMs = 1000 / (minPaceFilter * 60);
                    // Change from lte to gte for pace <= X (meaning speed >= Y)
                    query = query.gte('average_speed', minSpeedMs); 
                }

                // Apply new distance filter (distance is in meters, convert km to meters)
                if (minDistanceFilter !== null && minDistanceFilter > 0) {
                    query = query.gte('distance', minDistanceFilter * 1000); // Convert km to meters
                }

                // ƒêi·ªÅu ch·ªânh b·ªô l·ªçc ng√†y b·∫Øt ƒë·∫ßu ƒë·ªÉ l·ªçc ch√≠nh x√°c t·ª´ ƒë·∫ßu ng√†y Vi·ªát Nam
                if (reportStartDateInput.value) {
                    const selectedStartDate = new Date(reportStartDateInput.value);
                    // ƒê·∫∑t th·ªùi gian l√† ƒë·∫ßu ng√†y (00:00:00.000) theo m√∫i gi·ªù ƒë·ªãa ph∆∞∆°ng c·ªßa tr√¨nh duy·ªát.
                    // Sau ƒë√≥, khi g·ªçi .toISOString(), n√≥ s·∫Ω t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi sang UTC.
                    selectedStartDate.setHours(0, 0, 0, 0); 
                    query = query.gte('start_date', selectedStartDate.toISOString());
                }
                
                // ƒêi·ªÅu ch·ªânh b·ªô l·ªçc ng√†y k·∫øt th√∫c ƒë·ªÉ l·ªçc ch√≠nh x√°c theo cu·ªëi ng√†y Vi·ªát Nam
                if (reportEndDateInput.value) {
                    const selectedEndDate = new Date(reportEndDateInput.value);
                    // ƒê·∫∑t th·ªùi gian l√† cu·ªëi ng√†y (23:59:59.999) theo m√∫i gi·ªù ƒë·ªãa ph∆∞∆°ng c·ªßa tr√¨nh duy·ªát.
                    // Sau ƒë√≥, khi g·ªçi .toISOString(), n√≥ s·∫Ω t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi sang UTC.
                    selectedEndDate.setHours(23, 59, 59, 999); 
                    query = query.lte('start_date', selectedEndDate.toISOString());
                }

                query = query.order('start_date', { ascending: false });

                const { data, error } = await query;

                if (error) throw error;
                
                // Process fetched data to include formatted fields for Chart.js and D3.js
                allActivitiesData = data.map(activity => ({
                    ...activity,
                    start_date: new Date(activity.start_date), // Convert date string to Date object
                    distance_km: (activity.distance / 1000).toFixed(2), // Convert meters to km
                    moving_time_formatted: formatTime(activity.moving_time),
                    // Calculate raw pace in seconds/km for sorting/binning (numerical value for Chart.js)
                    pace_seconds_per_km_raw: (activity.average_speed !== null && activity.average_speed > 0) ? (1000 / activity.average_speed) : null,
                    pace_min_per_km_formatted: formatPaceForTable(activity.average_speed) // Formatted pace string for display
                }));

                reportFilterStatus.textContent = `ƒê√£ t·∫£i ${allActivitiesData.length} ho·∫°t ƒë·ªông.`;
                renderAllReports(); // Call a function to render all sections
                
            } catch (error) {
                console.error('Error fetching report data:', error.message);
                reportFilterStatus.textContent = `L·ªói khi t·∫£i b√°o c√°o: ${error.message}`;
                showAlert(`L·ªói khi t·∫£i b√°o c√°o: ${error.message}`);
                allActivitiesData = []; // Clear data on error
                renderAllReports(); // Render empty reports
            }
        }


        /**
         * Renders all report sections: summary, detailed table, charts.
         * (Adapted from original report.html)
         */
        function renderAllReports() {
            // 1. Render Overall Stats
            let totalActivities = allActivitiesData.length;
            let totalDistance = 0; // in meters
            let totalMovingTime = 0; // in seconds

            allActivitiesData.forEach(activity => {
                totalDistance += activity.distance || 0;
                totalMovingTime += activity.moving_time || 0;
            });

            console.log('DEBUG: Total Distance (m):', totalDistance, 'Total Moving Time (s):', totalMovingTime); // Debugging log

            totalActivitiesSpan.textContent = totalActivities;
            totalDistanceSpan.textContent = `${(totalDistance / 1000).toFixed(2)} KM`;
            totalMovingTimeSpan.textContent = formatTime(totalMovingTime);

            // Calculate overall average pace for summary
            let averageOverallPaceFormatted = 'N/A';
            if (totalDistance > 0 && totalMovingTime > 0) {
                // Corrected: totalDistance is already in meters, no need to multiply by 1000 again.
                const overallAverageSpeedMs = totalDistance / totalMovingTime; 
                console.log('DEBUG: Overall Average Speed (m/s):', overallAverageSpeedMs); // Debugging log
                averageOverallPaceFormatted = formatPace(overallAverageSpeedMs);
            }
            console.log('DEBUG: Average Overall Pace Formatted (before assign):', averageOverallPaceFormatted); // Debugging log
            averageOverallPaceSpan.textContent = averageOverallPaceFormatted;


            // 2. Render Detailed Activities Table
            renderDetailedActivitiesTable(allActivitiesData);

            // 3. Render Weekly Distance Chart (D3.js)
            // Changed to use the generic drawBubbleChart function
            renderWeeklyDistanceChart(allActivitiesData);

            // 4. Render Penalty/Bonus Table
            renderPenaltyBonusTable(allActivitiesData);

            // 5. Render Distance by Runner/Club Chart (D3.js)
            renderDistanceCharts(allActivitiesData);

            // 6. Render Chart.js Charts (re-using functions from report origin.html)
            renderChartJSCharts(allActivitiesData);
        }
        
        /**
         * Renders all Chart.js specific charts.
         * @param {Array} data - Array of activity objects.
         */
        function renderChartJSCharts(data) {
            renderDistanceChart(data);
            renderPaceDistributionChart(data);
            renderHeartRatePaceChart(data);
            renderActivityTypeChart(data);
        }

        /**
         * Renders the detailed activities table (from original report.html).
         * @param {Array} activities - Array of activity objects.
         */
        function renderDetailedActivitiesTable(activities) {
            detailedActivitiesTableBody.innerHTML = '';
            if (activities.length === 0) {
                detailedActivitiesStatus.textContent = 'Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o ƒë·ªÉ hi·ªÉn th·ªã.';
                return;
            }
            detailedActivitiesStatus.textContent = '';

            activities.forEach(activity => {
                const row = detailedActivitiesTableBody.insertRow();
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                const runnerName = runner ? runner.runner_name : 'N/A';
                const runnerClub = runner ? runner.running_team : 'N/A';

                row.innerHTML = `
                    <td>${runnerName}</td>
                    <td>${runnerClub}</td>
                    <td>${activity.name}</td>
                    <td>${activity.type}</td>
                    <td>${new Date(activity.start_date).toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'short' })}</td>
                    <td>${(activity.distance / 1000).toFixed(2)}</td>
                    <td>${formatTime(activity.moving_time)}</td>
                    <td>${formatPaceForTable(activity.average_speed)}</td>
                    <td>${activity.average_heartrate ? activity.average_heartrate.toFixed(0) : 'N/A'}</td>
                    <td>${formatElevationGain(activity.total_elevation_gain)}</td>
                `;
            });
        }

        /**
         * Calculates and renders weekly distance chart (D3.js).
         * This version aggregates distance across all runners for each week.
         * @param {Array} activities - Array of activity objects.
         */
        function renderWeeklyDistanceChart(activities) {
            weeklyDistanceChartContainer.innerHTML = '';
            weeklyChartStatus.textContent = '';

            if (activities.length === 0) {
                weeklyDistanceChartContainer.innerHTML = '<p class="text-gray-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì th·ªëng k√™ theo tu·∫ßn.</p>';
                return;
            }

            const weeklyAggregatedData = new Map(); // Map: ISOWeek -> totalDistance
            const weeklyDetailedActivities = new Map(); // Map: ISOWeek -> array of activities for that week

            activities.forEach(activity => {
                const isoWeek = getISOWeekString(activity.start_date);
                if (isoWeek) {
                    weeklyAggregatedData.set(isoWeek, (weeklyAggregatedData.get(isoWeek) || 0) + activity.distance);

                    if (!weeklyDetailedActivities.has(isoWeek)) {
                        weeklyDetailedActivities.set(isoWeek, []);
                    }
                    // Store the original activity object (or a copy) along with its runner's athlete_id
                    weeklyDetailedActivities.get(isoWeek).push({ ...activity, athlete_id: activity.user_id }); 
                }
            });

            // Convert map to array for D3, then sort by week
            const weeklyStats = Array.from(weeklyAggregatedData.entries()).map(([week, totalDistance]) => ({
                week: week,
                totalDistance: totalDistance, // Total distance for the week across all runners
                // We don't need athlete_id here for drawing the bubble, but for the modal click.
                // We'll pass the whole week's activities to the modal function.
            })).sort((a, b) => a.week.localeCompare(b.week));


            if (weeklyStats.length === 0) {
                weeklyDistanceChartContainer.innerHTML = '<p class="text-gray-500 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì th·ªëng k√™ theo tu·∫ßn.</p>';
                return;
            }

            const container = weeklyDistanceChartContainer;
            const width = container.clientWidth;
            const height = 300; // Fixed height for weekly chart

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxDistance = d3.max(weeklyStats, d => d.totalDistance);
            const minDistance = d3.min(weeklyStats, d => d.totalDistance);

            // Defensive check for D3 functions
            if (typeof d3.scaleSequential !== 'function' || typeof d3.interpolateViridis !== 'function') {
                console.error("D3 scales or interpolators are not available. Cannot draw weekly distance chart.");
                weeklyDistanceChartContainer.innerHTML = `<p class="text-red-500 text-center">L·ªói: Kh√¥ng th·ªÉ v·∫Ω bi·ªÉu ƒë·ªì. Th∆∞ vi·ªán D3.js ho·∫∑c c√°c th√†nh ph·∫ßn c·ªßa n√≥ kh√¥ng kh·∫£ d·ª•ng.</p>`;
                return; // Exit if D3 components are missing
            }

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxDistance || 1])
                .range([10, 40]);

            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxDistance || 1, minDistance || 0]);

            const x = d3.scaleBand()
                .domain(weeklyStats.map(d => d.week)) // Use unique week string for X axis
                .range([50, width - 20])
                .paddingInner(0.1);

            const y = d3.scaleLinear()
                .domain([0, maxDistance * 1.2 || 10000]) // Extend y-axis slightly
                .range([height - 50, 20]);

            // Adjust x-axis tick format to show only week number and year
            const xAxis = d3.axisBottom(x).tickFormat(d => {
                const parts = d.split('-W');
                return `W${parts[1]}-${parts[0]}`; // Format as WNN-YYYY
            });
            const yAxis = d3.axisLeft(y).tickFormat(d => `${(d / 1000).toFixed(0)}km`);

            svg.append("g")
                .attr("transform", `translate(0, ${height - 50})`)
                .call(xAxis)
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .attr("transform", `translate(50, 0)`)
                .call(yAxis);

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            svg.selectAll(".bubble")
                .data(weeklyStats)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => x(d.week) + x.bandwidth() / 2) // Center bubble in band
                .attr("cy", d => y(d.totalDistance))
                .attr("r", d => radiusScale(d.totalDistance))
                .attr("fill", d => colorScale(d.totalDistance))
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`Tu·∫ßn: ${d.week.replace(/-W/, 'W')}<br>T·ªïng qu√£ng ƒë∆∞·ªùng: ${(d.totalDistance / 1000).toFixed(2)} km`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                })
                .on("click", function(event, d) {
                    // When clicked, open modal for activities of this week (for ALL runners)
                    const activitiesInWeek = weeklyDetailedActivities.get(d.week) || [];
                    weeklyActivitiesTitle.textContent = `Ho·∫°t ƒë·ªông trong tu·∫ßn ${d.week.replace(/-W/, 'W')}:`;
                    displayActivitiesInModal(activitiesInWeek); // New function to display
                });

            // Add text labels for weekly distance chart
            svg.selectAll(".weekly-bubble-text")
                .data(weeklyStats)
                .enter().append("text")
                .attr("class", "weekly-bubble-text")
                .attr("x", d => x(d.week) + x.bandwidth() / 2)
                .attr("y", d => y(d.totalDistance))
                .text(d => `${(d.totalDistance / 1000).toFixed(0)}km`) // Display KM value
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .attr("font-size", d => Math.max(8, radiusScale(d.totalDistance) / 3)) // Dynamic font size
                .attr("fill", "black") // Set text color to black
                .attr("pointer-events", "none");

            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height - 10})`)
                .style("text-anchor", "middle")
                .text("Tu·∫ßn");

            svg.append("text")
                .attr("transform", `rotate(-90) translate(-${height / 2}, 15)`)
                .style("text-anchor", "middle")
                .text("Qu√£ng ƒë∆∞·ªùng (KM)");
        }

        /**
         * Helper to get ISO week string (YYYY-WNN) from a Date object, adjusted for Vietnam timezone.
         * This function ensures that the week calculation aligns with Vietnam local time (UTC+7),
         * regardless of the user's browser timezone settings, by explicitly converting the UTC date
         * to its Vietnam timezone components before calculating the ISO week.
         * @param {Date|string} d - The Date object or ISO 8601 string (assumed to be UTC from Supabase).
         * @returns {string} ISO week string (YYYY-WNN). Returns null if input is invalid.
         */
        function getISOWeekString(d) {
            let activityDateUtc;

            // Ensure we have a valid Date object, assuming string inputs are UTC ISO 8601
            if (typeof d === 'string') {
                activityDateUtc = new Date(d);
            } else if (d instanceof Date) {
                activityDateUtc = d;
            } else {
                console.error("Invalid date input for getISOWeekString:", d);
                return null;
            }

            // Check for invalid date
            if (isNaN(activityDateUtc.getTime())) {
                console.error("Invalid Date object after parsing in getISOWeekString:", d);
                return null;
            }

            // Use Intl.DateTimeFormat to get date components as perceived in 'Asia/Ho_Chi_Minh'
            // This is the most robust way to get timezone-specific date parts in vanilla JS.
            const formatter = new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                timeZone: 'Asia/Ho_Chi_Minh',
                hour12: false // Ensure 24-hour format for consistency
            });

            const parts = formatter.formatToParts(activityDateUtc);
            let year, month, day, hour = 0, minute = 0, second = 0;

            parts.forEach(p => {
                switch (p.type) {
                    case 'year': year = parseInt(p.value); break;
                    case 'month': month = parseInt(p.value); break;
                    case 'day': day = parseInt(p.value); break;
                    case 'hour': hour = parseInt(p.value); break;
                    case 'minute': minute = parseInt(p.value); break;
                    case 'second': second = parseInt(p.value); break;
                }
            });

            // Construct a new Date object using Date.UTC() from the Vietnam-aligned components.
            // This creates a UTC date whose *UTC properties* (like getUTCDay, getUTCFullYear)
            // will now correctly reflect the date and day of the week in Vietnam.
            const vietnamAlignedUtcDate = new Date(Date.UTC(year, month - 1, day, hour, minute, second));

            // Set to the start of the day in UTC for the Vietnam-aligned date
            vietnamAlignedUtcDate.setUTCHours(0, 0, 0, 0);

            // ISO week calculation logic (ISO 8601 defines weeks starting on Monday)
            // getUTCDay() returns 0 for Sunday, 1 for Monday, ..., 6 for Saturday.
            // We map Sunday (0) to 7 for consistent calculation.
            const dayOfVietnamWeekUtc = vietnamAlignedUtcDate.getUTCDay() || 7; 

            // Adjust the date to the nearest Thursday of its week (in Vietnam time).
            // Thursday is chosen because it's always in the same ISO week as the week's Monday.
            vietnamAlignedUtcDate.setUTCDate(vietnamAlignedUtcDate.getUTCDate() + 4 - dayOfVietnamWeekUtc);

            // Get the year of the ISO week. This might be different from the actual year
            // if the first week of the new year falls into the end of the previous year, or vice-versa.
            const isoWeekYear = vietnamAlignedUtcDate.getUTCFullYear();

            // Get the first day of that ISO year (January 1st UTC of the ISO year)
            const yearStart = new Date(Date.UTC(isoWeekYear, 0, 1));

            // Calculate the ISO week number:
            // (Difference in milliseconds between the Vietnam-aligned Thursday and the start of its ISO year + 1 day) / milliseconds in 7 days
            const weekNo = Math.ceil((((vietnamAlignedUtcDate - yearStart) / 86400000) + 1) / 7);

            // Return the ISO week string inYYYY-WNN format
            return `${isoWeekYear}-W${String(weekNo).padStart(2, '0')}`;
        }

        /**
         * Displays detailed activities for a specific week in a modal.
         * This function now takes an array of activity objects directly.
         * @param {Array} activitiesToDisplay - Array of activity objects for the week.
         */
        function displayActivitiesInModal(activitiesToDisplay) {
            weeklyActivitiesList.innerHTML = '';
            weeklyActivitiesStatus.textContent = '';
            weeklyActivitiesModal.style.display = 'flex'; // Show modal

            if (activitiesToDisplay.length > 0) {
                activitiesToDisplay.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
                activitiesToDisplay.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'border-b last:border-b-0 py-2';
                    const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                    const runnerName = runner ? runner.runner_name : 'N/A';

                    li.innerHTML = `
                        <p class="font-semibold">${runnerName}: ${activity.name} (${activity.type})</p>
                        <p class="text-sm text-gray-600">Ng√†y: ${new Date(activity.start_date).toLocaleDateString('vi-VN')}</p>
                        <p class="text-sm text-gray-600">Qu√£ng ƒë∆∞·ªùng: ${(activity.distance / 1000).toFixed(2)} km</p>
                        <p class="text-sm text-gray-600">Th·ªùi gian: ${formatTime(activity.moving_time)}</p>
                        <p class="text-sm text-gray-600">Pace: ${formatPaceForTable(activity.average_speed)}</p>
                        ${activity.strava_activity_id ? `<button class="btn-primary mt-2 text-xs px-2 py-1 view-map-btn" data-activity-id="${activity.strava_activity_id}">Xem b·∫£n ƒë·ªì</button>` : ''}
                    `;
                    weeklyActivitiesList.appendChild(li);
                });
                weeklyActivitiesStatus.textContent = `ƒê√£ t·∫£i ${activitiesToDisplay.length} ho·∫°t ƒë·ªông cho tu·∫ßn n√†y.`;
                document.querySelectorAll('#weekly-activities-modal .view-map-btn').forEach(button => {
                    button.onclick = (e) => {
                        const activityId = e.target.dataset.activityId;
                        if (activityId) {
                            window.open(`https://www.strava.com/activities/${activityId}`, '_blank');
                        }
                    };
                });
            } else {
                weeklyActivitiesStatus.textContent = 'Kh√¥ng t√¨m th·∫•y ho·∫°t ƒë·ªông n√†o cho tu·∫ßn n√†y.';
            }
        }


        /**
         * Renders the penalty/bonus table with collapsible runner sections, showing individual activities.
         * @param {Array} activities - Array of activity objects.
         */
        function renderPenaltyBonusTable(activities) {
            const table = document.getElementById('penalty-bonus-table');
            table.querySelectorAll('tbody').forEach(tbody => tbody.remove());

            const penaltyBonusStatus = document.getElementById('penalty-bonus-status');
            penaltyBonusStatus.textContent = '';

            if (activities.length === 0) {
                penaltyBonusStatus.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.';
                table.appendChild(document.createElement('tbody'));
                return;
            }

            const penaltyPerKmGt10 = parseFloat(penaltyPerKmGt10Input.value) || 0;
            const penaltyPerKmLte10 = parseFloat(penaltyPerKmLte10Input.value) || 0;
            const targetKmPerWeek = parseFloat(targetKmPerWeekInput.value) || 0;

            const activitiesByAthlete = activities.reduce((acc, activity) => {
                const athleteId = String(activity.user_id);
                if (!acc[athleteId]) {
                    acc[athleteId] = [];
                }
                acc[athleteId].push(activity);
                return acc;
            }, {});

            const sortedAthleteIds = Object.keys(activitiesByAthlete).sort((a, b) => {
                const runnerA = allRunnerCredentials.find(rc => String(rc.athlete_id) === a);
                const runnerB = allRunnerCredentials.find(rc => String(rc.athlete_id) === b);
                const nameA = runnerA ? runnerA.runner_name : `Runner ID: ${a}`;
                const nameB = runnerB ? runnerB.runner_name : `Runner ID: ${b}`;
                return nameA.localeCompare(nameB);
            });

            if (sortedAthleteIds.length === 0) {
                penaltyBonusStatus.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.';
                table.appendChild(document.createElement('tbody'));
                return;
            }

            sortedAthleteIds.forEach(athleteId => {
                const runnerInfo = allRunnerCredentials.find(rc => String(rc.athlete_id) === athleteId);
                const runnerName = runnerInfo?.runner_name || `Runner ID: ${athleteId}`;
                const runnerClub = runnerInfo?.running_team || 'N/A';
                const runnerActivities = activitiesByAthlete[athleteId];

                let totalRunnerKm = 0;
                let totalRunnerAmount = 0;
                const weeklyStats = {};

                runnerActivities.forEach(activity => {
                    const isoWeek = getISOWeekString(activity.start_date);
                    totalRunnerKm += (activity.distance / 1000);
                    if (isoWeek) {
                        if (!weeklyStats[isoWeek]) {
                            weeklyStats[isoWeek] = 0;
                        }
                        weeklyStats[isoWeek] += (activity.distance / 1000);
                    }
                });

                Object.values(weeklyStats).forEach(weekKm => {
                    const kmDifference = weekKm - targetKmPerWeek;
                    if (kmDifference < 0) {
                        const deficitKm = Math.abs(kmDifference);
                        let rate = (deficitKm <= 10) ? penaltyPerKmLte10 : penaltyPerKmGt10;
                        totalRunnerAmount -= (deficitKm * rate);
                    }
                });
                
                const summaryTbody = document.createElement('tbody');
                summaryTbody.className = 'runner-summary-group';

                const totalRow = summaryTbody.insertRow();
                totalRow.className = 'total-row';
                totalRow.innerHTML = `
                    <td colspan="4" class="font-bold text-lg text-bidv-green">
                        ${runnerName} <span class="text-gray-500 text-base">(${runnerClub})</span>
                        <i class="fas fa-chevron-right text-gray-600 ml-2 cursor-pointer penalty-toggle-icon" data-target-id="penalty-details-for-${athleteId}"></i>
                    </td>
                    <td colspan="3" class="text-right font-bold text-lg">${totalRunnerKm.toFixed(2)} KM</td>
                `;

                const summaryRow = summaryTbody.insertRow();
                summaryRow.className = totalRunnerAmount < 0 ? 'missing-row' : 'summary-row';
                summaryRow.innerHTML = `
                    <td colspan="7" class="text-right font-bold text-lg">
                        T·ªïng c·ªông Ph·∫°t/Th∆∞·ªüng: 
                        <span class="${totalRunnerAmount < 0 ? 'text-red-600' : 'text-green-600'}">
                            ${totalRunnerAmount.toLocaleString('vi-VN')} ngh√¨n VNƒê
                        </span>
                    </td>
                `;
                table.appendChild(summaryTbody);

                const detailedTbody = document.createElement('tbody');
                detailedTbody.id = `penalty-details-for-${athleteId}`;
                detailedTbody.className = 'collapsible-content collapsed';

                runnerActivities.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));

                runnerActivities.forEach(activity => {
                    const row = detailedTbody.insertRow();
                    row.innerHTML = `
                        <td></td>
                        <td>${new Date(activity.start_date).toLocaleDateString('vi-VN')}</td>
                        <td>${activity.name}</td>
                        <td>${activity.type}</td>
                        <td>${(activity.distance / 1000).toFixed(2)}</td>
                        <td>${formatPaceForTable(activity.average_speed)}</td>
                        <td>${formatTime(activity.moving_time)}</td>
                    `;
                });
                table.appendChild(detailedTbody);
                
                const spacerTbody = document.createElement('tbody');
                spacerTbody.innerHTML = `<tr class="h-4 bg-gray-100"><td colspan="7"></td></tr>`;
                table.appendChild(spacerTbody);
            });

            document.querySelectorAll('.penalty-toggle-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const targetId = icon.dataset.targetId;
                    const contentElement = document.getElementById(targetId);
                    if (contentElement) {
                        contentElement.classList.toggle('collapsed');
                        if (contentElement.classList.contains('collapsed')) {
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-right');
                        } else {
                            icon.classList.remove('fa-chevron-right');
                            icon.classList.add('fa-chevron-down');
                        }
                    }
                });
            });
        }


        /**
         * Renders bubble charts for distance by runner and distance by club (D3.js - from original report.html).
         * @param {Array} activities - Array of activity objects.
         */
        function renderDistanceCharts(activities) {
            distanceByRunnerChart.innerHTML = '<p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì qu√£ng ƒë∆∞·ªùng theo Runner s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>';
            distanceByClubChart.innerHTML = '<p class="text-gray-500 text-sm">Bi·ªÉu ƒë·ªì qu√£ng ƒë∆∞·ªùng theo CLB s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>';
            const clubLegendContainer = document.getElementById('distance-by-club-legend');

            if (activities.length === 0) {
                if (clubLegendContainer) clubLegendContainer.innerHTML = '';
                return;
            }

            const distanceByRunner = new Map();
            const statsByClub = new Map();

            activities.forEach(activity => {
                const distanceKm = activity.distance / 1000;
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                const runnerName = runner ? runner.runner_name : `Runner ID: ${activity.user_id || 'Unknown'}`;
                const clubName = runner ? runner.running_team : 'Kh√¥ng r√µ CLB';
                const runnerId = String(activity.user_id);

                distanceByRunner.set(runnerName, (distanceByRunner.get(runnerName) || 0) + distanceKm);
                
                if (!statsByClub.has(clubName)) {
                    statsByClub.set(clubName, { distance: 0, runners: new Set() });
                }
                const clubStats = statsByClub.get(clubName);
                clubStats.distance += distanceKm;
                clubStats.runners.add(runnerId);
            });

            const runnerData = Array.from(distanceByRunner.entries()).map(([name, distance]) => ({ name, distance }));
            const clubData = Array.from(statsByClub.entries()).map(([name, stats]) => ({
                name,
                distance: stats.distance,
                runnerCount: stats.runners.size
            }));

            // Render Runner Chart
            drawBubbleChart(distanceByRunnerChart, runnerData, "Qu√£ng ƒë∆∞·ªùng (KM) theo Runner", "name", "distance");

            // Prepare and render Club Chart with legend
            if (clubLegendContainer) clubLegendContainer.innerHTML = ''; // Clear previous legend on re-render

            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;

            drawBubbleChart(
                distanceByClubChart,
                clubData,
                "Qu√£ng ƒë∆∞·ªùng (KM) theo CLB",
                "name",
                "distance",
                { // New legendOptions object
                    container: clubLegendContainer,
                    startDate: startDate,
                    endDate: endDate
                }
            );
        }

        /**
         * Generic function to draw a bubble chart (D3.js - from original report.html).
         * @param {HTMLElement} container - The DOM element to append the SVG to.
         * @param {Array} data - Array of objects for the chart.
         * @param {string} title - Chart title.
         * @param {string} nameKey - Key for the name/category (e.g., 'runner_name', 'club_name').
         * @param {string} valueKey - Key for the numerical value (e.g., 'totalDistance', 'distance').
         * @param {object|null} legendOptions - Optional parameters for creating a legend table.
         */
        function drawBubbleChart(container, data, title, nameKey, valueKey, legendOptions = null) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">${title} - Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`;
                // Also clear the legend if there's no data
                if (legendOptions && legendOptions.container) {
                    legendOptions.container.innerHTML = '';
                }
                return;
            }

            const width = container.clientWidth;
            const height = Math.max(300, data.length * 60); // Adjust height dynamically based on number of items

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxValue = d3.max(data, d => d[valueKey]);
            const minValue = d3.min(data, d => d[valueKey]);

            // Defensive check for D3 functions
            if (typeof d3.scaleSequential !== 'function' || typeof d3.interpolateViridis !== 'function') {
                console.error("D3 scales or interpolators are not available. Cannot draw bubble chart for " + title);
                container.innerHTML = `<p class="text-red-500 text-center">L·ªói: Kh√¥ng th·ªÉ v·∫Ω bi·ªÉu ƒë·ªì. Th∆∞ vi·ªán D3.js ho·∫∑c c√°c th√†nh ph·∫ßn c·ªßa n√≥ kh√¥ng kh·∫£ d·ª•ng.</p>`;
                return; // Exit if D3 components are missing
            }

            const maxRadius = width < 768 ? 70 : 60; // Max radius for bubbles
            const minRadius = width < 768 ? 8 : 15; // Min radius for bubbles

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxValue || 1])
                .range([minRadius, maxRadius]); // Adjust range based on desired bubble sizes

            // TƒÉng c∆∞·ªùng ƒë·ªô m·∫°nh c·ªßa force ƒë·ªÉ gi√£n c√°c bong b√≥ng ra xa h∆°n
            const simulation = d3.forceSimulation(data)
                .force("x", d3.forceX(width / 2).strength(0.15)) // TƒÉng strength X
                .force("y", d3.forceY(height / 2).strength(0.15)) // TƒÉng strength Y
                .force("collide", d3.forceCollide(d => radiusScale(d[valueKey]) + 4)) // TƒÉng kho·∫£ng c√°ch va ch·∫°m
                .stop();

            for (let i = 0; i < 200; ++i) simulation.tick(); // Ch·∫°y simulation nhi·ªÅu l·∫ßn h∆°n ƒë·ªÉ ƒë·∫°t tr·∫°ng th√°i ·ªïn ƒë·ªãnh

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxValue || 1, minValue || 0]);

            const bubbles = svg.selectAll(".bubble")
                .data(data)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => radiusScale(d[valueKey]))
                .attr("fill", d => colorScale(d[valueKey]))
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`${d[nameKey]}<br>${d[valueKey].toFixed(2)} KM`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            svg.selectAll(".bubble-text")
                .data(data)
                .enter().append("text")
                .attr("class", "bubble-text")
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .text(d => d[nameKey])
                .attr("dy", "-0.3em") // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ ch·ªØ ƒë·ªÉ th√™m d√≤ng KM
                .attr("font-size", d => Math.max(8, radiusScale(d[valueKey]) / 4)) // Dynamic font size
                .attr("fill", "black") // Set text color to black
                .attr("pointer-events", "none");

            // Th√™m d√≤ng hi·ªÉn th·ªã KM
            svg.selectAll(".bubble-km-text")
                .data(data)
                .enter().append("text")
                .attr("class", "bubble-text bubble-km-text") // S·ª≠ d·ª•ng l·∫°i class bubble-text
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .text(d => `${d[valueKey].toFixed(1)} KM`) // Hi·ªÉn th·ªã s·ªë KM
                .attr("dy", "1em") // ƒêi·ªÅu ch·ªânh v·ªã tr√≠ ƒë·ªÉ n·∫±m d∆∞·ªõi t√™n
                .attr("text-anchor", "middle")
                .attr("font-size", d => Math.max(8, radiusScale(d[valueKey]) / 4.5)) // Dynamic font size
                .attr("fill", "black") // Set text color to black
                .attr("pointer-events", "none");


            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 20)
                .attr("text-anchor", "middle")
                .attr("font-size", "1.2rem")
                .attr("font-weight", "bold")
                .attr("fill", "#333")
                .text(title);

            // --- START: New Legend Generation Logic ---
            if (legendOptions && legendOptions.container && data.length > 0) {
                const { container: legendContainer, startDate, endDate } = legendOptions;
                legendContainer.innerHTML = ''; // Clear previous legend

                // Helper function to format date string from 'YYYY-MM-DD' to 'DD/MM/YYYY'
                const formatDate = (dateString) => {
                    if (!dateString) return '...';
                    const parts = dateString.split('-');
                    if (parts.length !== 3) return dateString; // Fallback for unexpected formats
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                };

                const startDateFormatted = formatDate(startDate);
                const endDateFormatted = formatDate(endDate);

                // Sort data by distance (valueKey) descending for the table
                const sortedData = [...data].sort((a, b) => b[valueKey] - a[valueKey]);

                // Create the table HTML
                let tableHtml = `
                    <h4 class="text-md font-semibold mb-2 text-center">K·∫øt qu·∫£ ch·∫°y t·ª´ ng√†y ${startDateFormatted} ƒë·∫øn ng√†y ${endDateFormatted}</h4>
                    <table class="data-table w-full text-sm">
                        <thead>
                            <tr>
                                <th class="w-1/12 text-center">STT</th>
                                <th class="w-5/12">T√™n c√¢u l·∫°c b·ªô</th>
                                <th class="w-3/12 text-center">S·ªë l∆∞·ª£ng runner</th>
                                <th class="w-3/12 text-right">S·ªë KM ƒë·∫°t ƒë∆∞·ª£c</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sortedData.forEach((item, index) => {
                    tableHtml += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>${item[nameKey]}</td>
                            <td class="text-center">${item.runnerCount || 0}</td>
                            <td class="text-right">${item[valueKey].toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                // Add total row
                const totalKm = data.reduce((sum, item) => sum + item[valueKey], 0);
                const totalRunners = data.reduce((sum, item) => sum + (item.runnerCount || 0), 0);
                tableHtml += `
                    <tr class="total-row">
                        <td colspan="2" class="text-right font-bold">T·ªïng c·ªông</td>
                        <td class="text-center font-bold">${totalRunners}</td>
                        <td class="text-right font-bold">${totalKm.toFixed(2)}</td>
                    </tr>
                `;

                tableHtml += `
                        </tbody>
                    </table>
                `;

                legendContainer.innerHTML = tableHtml;
            }
            // --- END: New Legend Generation Logic ---
        }

        // --- Chart.js Specific Rendering Functions (from report origin.html) ---

        /**
         * Function to render Distance over Time Chart (Chart.js).
         * @param {Array} data - Array of activity objects.
         */
        function renderDistanceChart(data) {
            const ctx = document.getElementById('distanceChart').getContext('2d');

            // Sort data by date for chronological display
            data.sort((a, b) => a.start_date - b.start_date);

            const labels = data.map(activity => activity.start_date.toLocaleDateString('vi-VN'));
            const distances = data.map(activity => activity.distance_km);

            if (distanceChart) {
                distanceChart.destroy(); // Destroy previous chart instance
            }

            distanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kho·∫£ng c√°ch (km)',
                        data: distances,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: 'rgb(75, 192, 192)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(75, 192, 192)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const activity = data[context.dataIndex];
                                    return `Kho·∫£ng c√°ch: ${activity.distance_km} km\nTh·ªùi gian: ${activity.moving_time_formatted}\nT·ªëc ƒë·ªô TB: ${activity.pace_min_per_km_formatted}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Ng√†y',
                                color: '#4b5563'
                            },
                            ticks: {
                                color: '#4b5563'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Kho·∫£ng c√°ch (km)',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Function to render Pace Distribution Chart (Chart.js).
         * @param {Array} data - Array of activity objects.
         */
        function renderPaceDistributionChart(data) {
            const ctx = document.getElementById('paceDistributionChart').getContext('2d');

            // Filter out activities with null or invalid pace
            const validPaces = data
                .filter(activity => activity.pace_seconds_per_km_raw !== null && activity.pace_seconds_per_km_raw > 0)
                .map(activity => activity.pace_seconds_per_km_raw);

            if (validPaces.length === 0) {
                if (paceDistributionChart) paceDistributionChart.destroy();
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText("Kh√¥ng c√≥ d·ªØ li·ªáu t·ªëc ƒë·ªô ƒë·ªÉ hi·ªÉn th·ªã.", 10, 50);
                return;
            }

            // Create bins for histogram (e.g., 30 seconds/km intervals)
            const minPace = Math.min(...validPaces);
            const maxPace = Math.max(...validPaces);
            const binSize = 30; // seconds/km (e.g., 0.5 min/km)
            const bins = {};

            // Initialize bins
            for (let i = Math.floor(minPace / binSize) * binSize; i <= maxPace + binSize; i += binSize) {
                bins[i.toFixed(0)] = 0;
            }

            validPaces.forEach(pace => {
                const binKey = (Math.floor(pace / binSize) * binSize).toFixed(0);
                if (bins[binKey] !== undefined) {
                    bins[binKey]++;
                }
            });

            // Get raw seconds labels for Chart.js to handle tick generation
            const labels = Object.keys(bins).sort((a, b) => parseFloat(a) - parseFloat(b));
            const counts = labels.map(label => bins[label]);

            if (paceDistributionChart) {
                paceDistributionChart.destroy();
            }

            paceDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, // Use raw seconds values as labels
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông',
                        data: counts,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgb(153, 102, 255)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Get the raw seconds value for the bin
                                    const rawSeconds = parseFloat(context[0].label);
                                    const startPace = formatPaceLabel(rawSeconds);
                                    const endPace = formatPaceLabel(rawSeconds + binSize);
                                    return `T·ªëc ƒë·ªô: ${startPace} - ${endPace} /km`;
                                },
                                label: function(context) {
                                    return `S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'T·ªëc ƒë·ªô trung b√¨nh (ph√∫t/km)', // Updated label for clarity
                                color: '#4b5563'
                            },
                            ticks: {
                                color: '#4b5563',
                                // Format x-axis ticks as MM:SS pace range using the new formatPaceLabel function
                                callback: function(value, index, values) {
                                    const startSeconds = parseFloat(this.getLabelForValue(value));
                                    const endSeconds = startSeconds + binSize;
                                    return `${formatPaceLabel(startSeconds)} - ${formatPaceLabel(endSeconds)}`;
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0, // Ensure integer ticks for counts
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Function to render Heart Rate vs. Pace Chart (Chart.js).
         * @param {Array} data - Array of activity objects.
         */
        function renderHeartRatePaceChart(data) {
            const ctx = document.getElementById('heartRatePaceChart').getContext('2d');

            const scatterData = data
                .filter(activity => activity.average_heartrate !== null && activity.average_heartrate > 0 && activity.pace_seconds_per_km_raw !== null && activity.pace_seconds_per_km_raw > 0)
                .map(activity => ({
                    x: activity.pace_seconds_per_km_raw, // Raw pace in seconds/km for plotting
                    y: activity.average_heartrate,
                    name: activity.name,
                    distance_km: activity.distance_km,
                    moving_time_formatted: activity.moving_time_formatted,
                    pace_min_per_km_formatted: formatPaceForTable(activity.average_speed) // Formatted pace for tooltip
                }));

            if (scatterData.length === 0) {
                if (heartRatePaceChart) heartRatePaceChart.destroy();
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText("Kh√¥ng c√≥ d·ªØ li·ªáu nh·ªãp tim/t·ªëc ƒë·ªô ƒë·ªÉ hi·ªÉn √Ω.", 10, 50);
                return;
            }

            if (heartRatePaceChart) {
                heartRatePaceChart.destroy();
            }

            heartRatePaceChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Nh·ªãp tim trung b√¨nh vs T·ªëc ƒë·ªô trung b√¨nh',
                        data: scatterData,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = context.raw;
                                    return `Ho·∫°t ƒë·ªông: ${item.name}\nT·ªëc ƒë·ªô TB: ${item.pace_min_per_km_formatted}\nNh·ªãp tim TB: ${item.y.toFixed(1)} bpm\nKho·∫£ng c√°ch: ${item.distance_km} km\nTh·ªùi gian: ${item.moving_time_formatted}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'T·ªëc ƒë·ªô trung b√¨nh (ph√∫t/km)', // Updated label for clarity
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563',
                                callback: function(value, index, values) {
                                    return formatPaceLabel(value); // Format x-axis ticks as MM:SS
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Nh·ªãp tim trung b√¨nh (bpm)',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Function to render Activity Type Chart (Doughnut Chart) (Chart.js).
         * @param {Array} data - Array of activity objects.
         */
        function renderActivityTypeChart(data) {
            const ctx = document.getElementById('activityTypeChart').getContext('2d');

            const activityTypes = {};
            data.forEach(activity => {
                activityTypes[activity.type] = (activityTypes[activity.type] || 0) + 1;
            });

            const labels = Object.keys(activityTypes);
            const counts = Object.values(activityTypes);

            const backgroundColors = [
                'rgba(255, 205, 86, 0.8)', // Yellow for Run
                'rgba(54, 162, 235, 0.8)',  // Blue for Walk
                'rgba(75, 192, 192, 0.8)',  // Teal for others
                'rgba(153, 102, 255, 0.8)', // Purple
                'rgba(201, 203, 207, 0.8)'  // Gray
            ];
            const borderColors = [
                'rgb(255, 205, 86)',
                'rgb(54, 162, 235)',
                'rgb(75, 192, 192)',
                'rgb(153, 102, 255)',
                'rgb(201, 203, 207)'
            ];

            if (activityTypeChart) {
                activityTypeChart.destroy();
            }

            activityTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông',
                        data: counts,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Toggles the visibility of a collapsible content section and rotates its icon.
         * Optionally saves the state to localStorage.
         * @param {HTMLElement} contentElement - The content div to show/hide.
         * @param {HTMLElement} toggleIcon - The icon element to rotate.
         * @param {boolean|null} forceCollapse - If true, forces collapse; if false, forces expand. If null, toggles.
         * @param {string|null} stateKey - Key for localStorage to save the state ('expanded' or 'collapsed').
         */
        function toggleCollapsible(contentElement, toggleIcon, forceCollapse = null, stateKey = null) {
            let isCollapsed;
            if (forceCollapse !== null) {
                isCollapsed = forceCollapse;
            } else {
                // If not forcing, toggle based on current state
                isCollapsed = !contentElement.classList.contains('collapsed');
            }

            if (isCollapsed) {
                contentElement.classList.add('collapsed');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
                if (stateKey) localStorage.setItem(stateKey, 'collapsed');
            } else {
                contentElement.classList.remove('collapsed');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
                if (stateKey) localStorage.setItem(stateKey, 'expanded');
            }
        }

        /**
         * Fetches training suggestions from the Gemini API based on current activity data.
         * Now calls the Supabase Edge Function to handle the Gemini API call securely.
         */
        async function getTrainingSuggestions() {
            if (allActivitiesData.length === 0) {
                showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ho·∫°t ƒë·ªông ƒë·ªÉ t·∫°o g·ª£i √Ω luy·ªán t·∫≠p. Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc.');
                return;
            }

            trainingSuggestionsLoader.classList.remove('hidden'); // Show loader
            getTrainingSuggestionsBtn.disabled = true; // Disable button
            trainingSuggestionsContent.innerHTML = ''; // Clear previous content
            trainingSuggestionsStatus.textContent = 'ƒêang t·∫°o g·ª£i √Ω luy·ªán t·∫≠p th√¥ng minh...';

            try {
                // Get the current session to extract the access token
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y phi√™n ƒëƒÉng nh·∫≠p Supabase. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                }

                // Prepare data to send to the Edge Function
                const payload = {
                    activities: allActivitiesData.map(activity => ({
                        // Simplify activities data for the LLM prompt to only include necessary fields
                        name: activity.name,
                        type: activity.type,
                        distance_km: parseFloat(activity.distance_km),
                        moving_time: activity.moving_time, // in seconds
                        average_speed: activity.average_speed, // in m/s
                        average_heartrate: activity.average_heartrate,
                        start_date: activity.start_date.toISOString(), // Send ISO string
                        total_elevation_gain: activity.total_elevation_gain
                    })),
                    // If you want to include runnerCredentialId for the Edge Function's security check, you can get it from local storage or context.
                    // For this generic summary, it might not be strictly necessary for the LLM prompt itself,
                    // but the Edge Function might require it for its internal security checks.
                    // Let's assume the first activity's user_id can be mapped to a runner credential ID
                    runnerCredentialId: allRunnerCredentials.find(rc => String(rc.athlete_id) === String(allActivitiesData[0]?.user_id))?.id,
                    clientTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone // Get client's current timezone
                };

                // Call the Supabase Edge Function
                const response = await fetch(ANALYZE_ACTIVITIES_EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}` // Send user's access token
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    trainingSuggestionsContent.innerHTML = marked.parse(result.analysis); // Render Markdown
                    trainingSuggestionsStatus.textContent = 'G·ª£i √Ω ƒë√£ s·∫µn s√†ng!';
                } else {
                    const errorMessage = result.error || 'Kh√¥ng th·ªÉ nh·∫≠n ƒë∆∞·ª£c g·ª£i √Ω luy·ªán t·∫≠p t·ª´ Edge Function.';
                    trainingSuggestionsContent.innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
                    trainingSuggestionsStatus.textContent = 'L·ªói khi t·∫°o g·ª£i √Ω.';
                    console.error('Error from Edge Function:', result);
                }

            } catch (error) {
                console.error('Error calling Edge Function for training suggestions:', error);
                trainingSuggestionsContent.innerHTML = `<p class="text-red-500">ƒê√£ x·∫£y ra l·ªói khi g·ªçi Edge Function: ${error.message}</p>`;
                trainingSuggestionsStatus.textContent = 'L·ªói khi g·ªçi g·ª£i √Ω.';
                showAlert(`L·ªói khi t·∫°o g·ª£i √Ω luy·ªán t·∫≠p: ${error.message}`);
            } finally {
                trainingSuggestionsLoader.classList.add('hidden'); // Hide loader
                getTrainingSuggestionsBtn.disabled = false; // Enable button
                trainingSuggestionsModal.classList.remove('hidden'); // Show modal
                trainingSuggestionsModal.style.display = 'flex'; // Ensure it's visible
            }
        }


        /**
         * Converts table data to an array of objects suitable for XLSX.
         * @param {HTMLTableElement} tableElement - The table DOM element.
         * @returns {Array<Object>} An array of objects, where each object represents a row.
         */
        function tableToJson(tableElement) {
            const data = [];
            const headers = [];
            
            // Get headers
            tableElement.querySelectorAll('thead th').forEach(header => {
                headers.push(header.textContent.trim());
            });

            // Get rows
            tableElement.querySelectorAll('tbody tr').forEach(row => {
                const rowData = {};
                row.querySelectorAll('td').forEach((cell, index) => {
                    // Use headers as keys. If there are more cells than headers, use a generic key.
                    const header = headers[index] || `Column ${index + 1}`;
                    rowData[header] = cell.textContent.trim();
                });
                data.push(rowData);
            });
            return data;
        }

        /**
         * Downloads data as an XLSX file.
         * @param {Array<Object>} data - Array of objects to export.
         * @param {string} fileName - The desired file name (e.g., 'report.xlsx').
         * @param {string} sheetName - The name of the sheet within the workbook.
         */
        function downloadExcel(data, fileName, sheetName) {
            if (!data || data.length === 0) {
                showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t ra Excel.');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
        }


        // --- Supabase Authentication Check for Report Page ---
        async function checkAuthAndLoadReport() {
            try {
                const { data: { session }, error } = await supabaseClientInstance.auth.getSession();
                if (error || !session) {
                    console.warn('No active Supabase session found. Redirecting to Index1.html');
                    showAlert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang b√°o c√°o. ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p...');
                    setTimeout(() => {
                        window.location.href = 'https://quantrh.github.io/Strava/index1.html'; // Changed to direct link
                    }, 2000); // Redirect after 2 seconds
                    return;
                }
                
                // If session exists, set current user email and proceed to load data
                currentUserEmailSpan.textContent = session.user.email;
                await fetchAllRunnerCredentials(); // Load all runner credentials
                await fetchClubs(); // Load all clubs
                
                // Load filter states from local storage
                selectedRunnerIdReport = localStorage.getItem('report_runner_filter') || 'all';
                selectedClubNameReport = localStorage.getItem('report_club_filter') || 'all';
                try {
                    const savedActivityTypes = localStorage.getItem('report_activity_types');
                    selectedActivityTypesReport = savedActivityTypes ? JSON.parse(savedActivityTypes) : [];
                } catch (e) {
                    console.error('Error parsing saved activity types from local storage:', e);
                    selectedActivityTypesReport = [];
                }
                minPaceFilter = localStorage.getItem('report_min_pace') ? parseFloat(localStorage.getItem('report_min_pace')) : null;
                minDistanceFilter = localStorage.getItem('report_min_distance') ? parseFloat(localStorage.getItem('report_min_distance')) : null;

                populateFilters(); // Populate dropdowns and inputs with loaded/default values

                // Set default dates to past 6 days from today (inclusive 7 days)
                const today = new Date();
                const endDate = today.toISOString().split('T')[0];
                reportEndDateInput.value = endDate;

                const sixDaysAgo = new Date(today);
                sixDaysAgo.setDate(today.getDate() - 6); // Changed to 6 days ago for a 7-day inclusive range
                const startDate = sixDaysAgo.toISOString().split('T')[0];
                reportStartDateInput.value = startDate;

                await fetchAndRenderReportData(); // Initial data load from Supabase
            } catch (authError) {
                console.error('Error during authentication check:', authError.message);
                showAlert(`L·ªói x√°c th·ª±c: ${authError.message}. ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p...`);
                setTimeout(() => {
                    window.location.href = 'https://quantrh.github.io/Strava/index1.html'; // Changed to direct link
                }, 2000);
            }
        }

        // --- Event Listeners and Initialization ---
        window.onload = async () => {
            if (typeof window.supabase === 'undefined') {
                showAlert('L·ªói: Th∆∞ vi·ªán Supabase kh√¥ng ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet ho·∫∑c URL CDN.');
                console.error('Th∆∞ vi·ªán Supabase kh√¥ng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a. Vui l√≤ng ki·ªÉm tra th·∫ª script CDN Supabase.');
                return;
            }
            supabaseClientInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            await checkAuthAndLoadReport();

            logoutBtn.addEventListener('click', async () => {
                const confirmed = await showConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?');
                if (confirmed) {
                    try {
                        const { error } = await supabaseClientInstance.auth.signOut();
                        if (error) throw error;
                        localStorage.removeItem('strava_access_token');
                        localStorage.removeItem('strava_refresh_token');
                        localStorage.removeItem('strava_expires_at');
                        localStorage.removeItem('strava_athlete_id');
                        localStorage.removeItem('strava_runner_name');
                        localStorage.removeItem('strava_runner_credential_id');
                        localStorage.removeItem('strava_authenticated');
                        // Clear saved filters from local storage on logout
                        localStorage.removeItem('report_runner_filter');
                        localStorage.removeItem('report_club_filter');
                        localStorage.removeItem('report_activity_types');
                        localStorage.removeItem('report_min_pace');
                        localStorage.removeItem('report_min_distance');

                        showAlert('ƒêƒÉng xu·∫•t th√†nh c√¥ng. ƒêang chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p...');
                        setTimeout(() => {
                            window.location.href = 'https://quantrh.github.io/Strava/index1.html'; // Changed to direct link
                        }, 1500);
                    }
                    catch (error) {
                        console.error('L·ªói ƒëƒÉng xu·∫•t:', error.message);
                        showAlert(`L·ªói khi ƒëƒÉng xu·∫•t: ${error.message}`);
                    }
                }
            });

            // Event listener for the new "Quay v·ªÅ" button
            backToHomeBtn.addEventListener('click', () => {
                window.location.href = 'https://quantrh.github.io/Strava/index1.html';
            });

            // Event listener for the Apply Filters button (to fetch data from Supabase)
            applyReportFiltersBtn.addEventListener('click', () => {
                // Save current filter states to local storage before applying
                localStorage.setItem('report_runner_filter', selectedRunnerIdReport);
                localStorage.setItem('report_club_filter', selectedClubNameReport);
                localStorage.setItem('report_activity_types', JSON.stringify(selectedActivityTypesReport));
                localStorage.setItem('report_min_pace', minPaceFilter !== null ? minPaceFilter.toString() : '');
                localStorage.setItem('report_min_distance', minDistanceFilter !== null ? minDistanceFilter.toString() : '');
                
                fetchAndRenderReportData();
            });

            // Filter changes don't trigger direct fetch, only update selected values
            reportRunnerFilter.addEventListener('change', (e) => {
                selectedRunnerIdReport = e.target.value;
            });
            reportClubFilter.addEventListener('change', (e) => {
                selectedClubNameReport = e.target.value;
            });
            // Multi-select activity type changes are handled by global click listener
            reportStartDateInput.addEventListener('change', () => { /* value changed */ });
            reportEndDateInput.addEventListener('change', () => { /* value changed */ });

            // New filter inputs event listeners
            reportMinPaceInput.addEventListener('input', (e) => {
                minPaceFilter = e.target.value !== '' ? parseFloat(e.target.value) : null;
            });
            reportMinDistanceInput.addEventListener('input', (e) => {
                minDistanceFilter = e.target.value !== '' ? parseFloat(e.target.value) : null;
            });

            // Penalty/Bonus calculation inputs trigger re-render of all reports (not a new fetch)
            penaltyPerKmGt10Input.addEventListener('input', renderAllReports);
            penaltyPerKmLte10Input.addEventListener('input', renderAllReports);
            targetKmPerWeekInput.addEventListener('input', renderAllReports);

            closeWeeklyActivitiesModalBtn.addEventListener('click', () => {
                weeklyActivitiesModal.style.display = 'none';
            });
            // Close button for the new training suggestions modal
            closeTrainingSuggestionsModalBtn.addEventListener('click', () => {
                trainingSuggestionsModal.classList.add('hidden');
                trainingSuggestionsModal.style.display = 'none';
            });


            // --- Gemini API Feature: Get Training Suggestions ---
            getTrainingSuggestionsBtn.addEventListener('click', getTrainingSuggestions);

            // Excel Download buttons
            downloadDetailedActivitiesExcelBtn.addEventListener('click', () => {
                const table = document.getElementById('detailed-activities-table');
                const dataToExport = tableToJson(table);
                downloadExcel(dataToExport, 'chi_tiet_hoat_dong.xlsx', 'ChiTietHoatDong');
            });

            downloadPenaltyBonusExcelBtn.addEventListener('click', () => {
                const table = document.getElementById('penalty-bonus-table');
                const dataToExport = tableToJson(table);
                downloadExcel(dataToExport, 'thong_ke_phat_thuong.xlsx', 'ThongKePhatThuong');
            });


            // Scroll-to-top button logic
            const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
            window.onscroll = function() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollToTopBtn.style.display = "block";
                } else {
                    scrollToTopBtn.style.display = "none";
                }
            };
            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });

            // Re-render charts on window resize
            window.addEventListener('resize', () => {
                if (allActivitiesData.length > 0) {
                    renderDistanceCharts(allActivitiesData); // D3.js charts
                    renderWeeklyDistanceChart(allActivitiesData); // D3.js chart
                    renderChartJSCharts(allActivitiesData); // Chart.js chartsaa
                }
            });

            // Initial state: Clear charts and filter options until data is loaded
            // (Note: Initial rendering is now handled by checkAuthAndLoadReport calling fetchAndRenderReportData)
            document.addEventListener('DOMContentLoaded', () => {
                // Clear charts and set initial filter options, though checkAuthAndLoadReport will ultimately populate
                // and fetch data, so this might be redundant but safe.
                // clearCharts(); // Already handled by fetchAndRenderReportData which calls renderAllReports
                populateFilters(); // Ensure filters are populated even if no data is loaded yet
            });

            // Initialize collapsible detailed activities section
            if (detailedActivitiesHeader && detailedActivitiesContent && detailedActivitiesToggleIcon) {
                const savedState = localStorage.getItem(DETAILED_ACTIVITIES_STATE_KEY);
                // Default to collapsed if no state saved or if it was explicitly collapsed
                const initialStateCollapsed = (savedState === null || savedState === 'collapsed');
                toggleCollapsible(detailedActivitiesContent, detailedActivitiesToggleIcon, initialStateCollapsed, DETAILED_ACTIVITIES_STATE_KEY);

                detailedActivitiesHeader.addEventListener('click', () => {
                    toggleCollapsible(detailedActivitiesContent, detailedActivitiesToggleIcon, null, DETAILED_ACTIVITIES_STATE_KEY);
                });
            }
        };
    </script>
    <!-- Add marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>



