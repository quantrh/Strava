<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo hoạt động chạy bộ - FOR RUNNER LOVER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for bubble charts and weekly distance (from original report.html) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Chart.js for other charts (from report origin.html) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define BIDV brand colors */
        :root {
            --bidv-green: #006b68;
            --bidv-yellow: #FFC62F;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .btn-primary {
            background-color: var(--bidv-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background-color: #005a57;
        }

        .btn-secondary {
            background-color: var(--bidv-yellow);
            color: #333;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background-color: #e6b32a;
        }

        .btn-danger {
            @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out shadow-md;
        }

        .form-input {
            @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500;
        }
        
        /* Multi-select specific CSS (from original report.html) */
        .multi-select-container {
            position: relative;
        }
        .multi-select-selected-items {
            @apply w-full p-2 border border-gray-300 rounded-md bg-white cursor-pointer flex flex-wrap gap-1;
            min-height: 42px;
            align-items: center;
        }
        .multi-select-selected-item {
            @apply bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full flex items-center gap-1;
        }
        .multi-select-selected-item span {
            cursor: pointer;
            font-weight: bold;
        }
        .multi-select-options {
            @apply absolute w-full border border-gray-300 rounded-md bg-white shadow-lg z-10;
            max-height: 200px;
            overflow-y: auto;
        }
        .multi-select-option {
            @apply p-2 cursor-pointer hover:bg-gray-100;
        }
        .multi-select-option.selected {
            @apply bg-blue-100 font-semibold;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
        }

        /* Chart.js specific styles from report origin.html */
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
            width: 100%;
        }

        /* D3.js chart specific styles (from original report.html) */
        #distance-by-runner-chart,
        #distance-by-club-chart,
        #weekly-distance-chart-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            min-height: 300px;
        }

        .bubble {
            fill-opacity: 0.7;
            cursor: pointer;
            transition: fill-opacity 0.3s ease;
        }

        .bubble:hover {
            fill-opacity: 1;
        }

        .bubble-text {
            font-size: 0.8rem;
            text-anchor: middle;
            fill: white;
            pointer-events: none;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .grid-cols-1-md-grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--bidv-green);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        .data-table th {
            background-color: var(--bidv-green);
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            text-transform: uppercase;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .data-table tbody tr:hover {
            background-color: #f0f2f5;
        }
        .data-table .total-row {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        .data-table .summary-row {
            background-color: #d1e7dd;
            font-weight: bold;
        }
        .data-table .missing-row {
            background-color: #fee2e2;
            color: #ef4444;
            font-weight: bold;
        }
        .data-table .runner-summary-group {
             border-bottom: 2px solid var(--bidv-green);
        }
        .data-table .runner-summary-group .total-row td,
        .data-table .runner-summary-group .summary-row td {
            border-bottom: none;
        }
        .data-table .runner-summary-group .total-row {
            border-bottom: 1px solid #e2e8f0;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        input[type="date"] {
            position: relative;
        }
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-clear-button {
            display: none;
        }

        #scroll-to-top-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: var(--bidv-green);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }

        #scroll-to-top-btn:hover {
            background-color: #005a57;
        }

        #custom-alert, #custom-confirm-modal {
            background-color: rgba(0, 0, 0, 0.5);
            /* display: flex; <-- REMOVED this line as 'hidden' class handles it */
            align-items: center;
            justify-content: center;
        }

        /* Collapsible content styles */
        .collapsible-content {
            max-height: 1000px; /* Arbitrarily large value for expanded state */
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <header class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://placehold.co/80x80/006B68/FFFFFF?text=RUN" alt="Logo BIDV Running Club" class="h-20 w-auto rounded-md">
                <h1 class="text-2xl font-bold text-white">Báo cáo hoạt động chạy bộ - FOR RUNNER LOVER</h1>
            </div>
            <nav>
                <button id="logout-btn" class="btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <section id="report-dashboard" class="card mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center text-bidv-green">Báo cáo hoạt động</h2>
            <p id="user-info" class="text-lg font-medium text-center mb-6">Chào mừng, <span id="current-user-email"></span>!</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Bộ lọc -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-700"><i class="fas fa-filter"></i> Bộ lọc báo cáo</h3>
                    <div class="mb-4">
                        <label for="report-runner-filter" class="block text-gray-700 text-sm font-bold mb-2">Chọn Runner:</label>
                        <select id="report-runner-filter" class="form-input">
                            <option value="all">Tất cả Runner</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="report-club-filter" class="block text-gray-700 text-sm font-bold mb-2">Chọn Câu lạc bộ:</label>
                        <select id="report-club-filter" class="form-input">
                            <option value="all">Tất cả Câu lạc bộ</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="report-activity-type-filter" class="block text-gray-700 text-sm font-bold mb-2">Loại hoạt động:</label>
                        <div class="multi-select-container">
                            <div id="multi-select-display-report" class="multi-select-selected-items">
                                <span class="text-gray-500">Chọn loại hoạt động</span>
                            </div>
                            <div id="multi-select-options-report" class="multi-select-options hidden">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 flex gap-4">
                        <div class="flex-1">
                            <label for="report-start-date" class="block text-gray-700 text-sm font-bold mb-2">Từ ngày:</label>
                            <input type="date" id="report-start-date" class="form-input">
                        </div>
                        <div class="flex-1">
                            <label for="report-end-date" class="block text-gray-700 text-sm font-bold mb-2">Đến ngày:</label>
                            <input type="date" id="report-end-date" class="form-input">
                        </div>
                    </div>
                    <button id="apply-report-filters-btn" class="btn-primary w-full">
                        Áp dụng bộ lọc
                    </button>
                    <div id="report-filter-status" class="mt-2 text-sm text-gray-600 text-center"></div>
                </div>

                <!-- Tổng quan thống kê -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Tổng quan thống kê</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-1">Tổng quãng đường</h2>
                            <p id="totalDistance" class="text-2xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-1">Tổng thời gian di chuyển</h2>
                            <p id="totalMovingTime" class="text-2xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-1">Tốc độ trung bình</h2>
                            <p id="averageOverallPace" class="text-2xl font-bold"></p>
                        </div>
                        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-1">Hoạt động</h2>
                            <p id="totalActivities" class="text-2xl font-bold"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section (from report origin.html - Chart.js) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Quãng đường chạy theo ngày (km)</h2>
                    <div class="chart-container">
                        <canvas id="distanceChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Phân bố tốc độ trung bình (phút/km)</h2>
                    <div class="chart-container">
                        <canvas id="paceDistributionChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Nhịp tim trung bình theo tốc độ (phút/km)</h2>
                    <div class="chart-container">
                        <canvas id="heartRatePaceChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Phân loại hoạt động</h2>
                    <div class="chart-container">
                        <canvas id="activityTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- D3.js Charts (Restored from original report.html) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-green-700">Quãng đường (KM) theo Runner</h3>
                    <div id="distance-by-runner-chart" class="mt-4 border rounded-md p-2 min-h-[150px] flex items-center justify-center">
                        <p class="text-gray-500 text-sm">Biểu đồ quãng đường theo Runner sẽ hiển thị ở đây.</p>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-yellow-700">Quãng đường (KM) theo CLB</h3>
                    <div id="distance-by-club-chart" class="mt-4 border rounded-md p-2 min-h-[150px] flex items-center justify-center">
                        <p class="text-gray-500 text-sm">Biểu đồ quãng đường theo CLB sẽ hiển thị ở đây.</p>
                    </div>
                </div>
            </div>

            <!-- Bảng chi tiết hoạt động (Collapsible) -->
            <div id="detailed-activities-section" class="card mt-8 p-6">
                <div id="detailed-activities-header" class="flex justify-between items-center cursor-pointer mb-4">
                    <h3 class="text-xl font-semibold text-blue-700">
                        <i class="fas fa-list mr-2"></i> Chi tiết các hoạt động
                    </h3>
                    <i id="detailed-activities-toggle-icon" class="fas fa-chevron-down text-gray-600 transition-transform duration-300"></i>
                </div>
                <div id="detailed-activities-content" class="collapsible-content overflow-x-auto">
                    <table id="detailed-activities-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Tên Runner</th>
                                <th>CLB</th>
                                <th>Tên hoạt động</th>
                                <th>Loại</th>
                                <th>Ngày</th>
                                <th>Quãng đường (KM)</th>
                                <th>Thời gian</th>
                                <th>Pace</th>
                                <th>Nhịp tim TB</th>
                                <th>Độ cao tăng (m)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Hoạt động sẽ được tải vào đây -->
                        </tbody>
                    </table>
                    <p id="detailed-activities-status" class="mt-4 text-sm text-gray-600 text-center">Không có hoạt động nào để hiển thị.</p>
                </div>
            </div>

            <!-- Biểu đồ thống kê theo tuần -->
            <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-red-700"><i class="fas fa-chart-line"></i> Thống kê quãng đường theo tuần</h3>
                <div id="weekly-distance-chart-container" class="border rounded-md p-2 min-h-[300px] flex items-center justify-center">
                    <p class="text-gray-500 text-sm">Biểu đồ thống kê quãng đường theo tuần sẽ hiển thị ở đây.</p>
                </div>
                <p id="weekly-chart-status" class="mt-4 text-sm text-gray-600 text-center"></p>
            </div>

             <!-- Bảng thống kê chi tiết & Tiền phạt/Thưởng -->
             <div class="card mt-8 p-6">
                <h3 class="text-xl font-semibold mb-4 text-teal-700"><i class="fas fa-calculator"></i> Thống kê tiền phạt/thưởng</h3>
                <div class="mb-4 flex gap-4 items-end">
                    <div class="flex-1">
                        <label for="penalty-per-km-gt10" class="block text-gray-700 text-sm font-bold mb-2">Số tiền nộp cho 1KM (nghìn VNĐ) khi thiếu > 10KM:</label>
                        <input type="number" id="penalty-per-km-gt10" class="form-input bg-yellow-100" value="30" min="0" step="1">
                    </div>
                    <div class="flex-1">
                        <label for="penalty-per-km-lte10" class="block text-gray-700 text-sm font-bold mb-2">Số tiền nộp cho 1KM (nghìn VNĐ) khi thiếu <= 10KM:</label>
                        <input type="number" id="penalty-per-km-lte10" class="form-input bg-yellow-100" value="20" min="0" step="1">
                    </div>
                    <div class="flex-1">
                        <label for="target-km-per-week" class="block text-gray-700 text-sm font-bold mb-2">Số KM một tuần (KM):</label>
                        <input type="number" id="target-km-per-week" class="form-input bg-yellow-100" value="25" min="0" step="1">
                    </div>
                </div>
                <div id="detailed-stats-table-container" class="overflow-x-auto">
                    <table id="penalty-bonus-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Tên Runner</th>
                                <th>CLB</th>
                                <th>Tuần</th>
                                <th>Tổng KM thực hiện</th>
                                <th>Mục tiêu KM</th>
                                <th>KM chênh lệch</th>
                                <th>Số tiền (nghìn VNĐ)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="penalty-bonus-status" class="mt-4 text-sm text-gray-600 text-center">Chưa có dữ liệu để hiển thị.</p>
            </div>


        </section>
    </main>

    <footer class="bg-bidv-green text-white p-4 text-center text-sm" style="background-color: #006B68;">
        <div class="container" style="color: var(--bidv-yellow);">
            &copy; 2025 Trương Hồng Quân - BIDV Running Club. All rights reserved (Dev by AIs - Gemini, GPT) - 📧quantrhvn@gmail.com - 📳+84989073739 - 248064a v2.
            <br>
            <img src="https://placehold.co/80x28/006B68/FFFFFF?text=PowerStrava" alt="PowerStrava Logo" style="height: 28px; margin: 5px auto 0 auto; display: block;">
        </div>
    </footer>

    <!-- Weekly Activities Modal -->
    <div id="weekly-activities-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="close-weekly-activities-modal-btn">&times;</span>
            <h3 id="weekly-activities-title" class="text-2xl font-bold mb-4 text-gray-800">Hoạt động trong tuần:</h3>
            <div class="max-h-96 overflow-y-auto border rounded-md p-2">
                <ul id="weekly-activities-list" class="space-y-2 text-sm">
                    <!-- Activities will be loaded here -->
                </ul>
            </div>
            <p id="weekly-activities-status" class="mt-4 text-sm text-gray-600"></p>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modals -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-content-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="alert-message" class="mb-4 text-lg"></p>
            <button id="alert-ok-btn" class="btn-primary">OK</button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-content-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="mb-4 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button type="button" id="confirm-cancel-btn" class="btn-primary">Hủy</button>
                <button type="button" id="confirm-ok-btn" class="btn-danger">Đồng ý</button>
            </div>
        </div>
    </div>

    <button id="scroll-to-top-btn" title="Go to top">▲</button>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y'; // Replace with your Supabase Anon Key

        // Supabase Edge Function URL to fetch activities (from original report.html)
        const GET_STATS_API_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/get-user-activities';

        let supabaseClientInstance;
        let allRunnerCredentials = []; // Used for filtering and display (from original report.html)
        let allClubs = []; // Used for filtering and display (from original report.html)
        let allActivitiesData = []; // Store all fetched activities for the report (from original report.html)

        // Filter states (from original report.html)
        let selectedRunnerIdReport = 'all'; 
        let selectedClubNameReport = 'all'; 
        let selectedActivityTypesReport = []; 

        // Chart.js instances (from report origin.html)
        let distanceChart, paceDistributionChart, heartRatePaceChart, activityTypeChart;

        // DOM Elements
        const currentUserEmailSpan = document.getElementById('current-user-email');
        const logoutBtn = document.getElementById('logout-btn');

        // Filter elements (from original report.html's filter section)
        const reportRunnerFilter = document.getElementById('report-runner-filter');
        const reportClubFilter = document.getElementById('report-club-filter');
        const multiSelectDisplayReport = document.getElementById('multi-select-display-report');
        const multiSelectOptionsReport = document.getElementById('multi-select-options-report');
        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const applyReportFiltersBtn = document.getElementById('apply-report-filters-btn');
        const reportFilterStatus = document.getElementById('report-filter-status');
        
        // Summary stats elements (from report origin.html, using Chart.js related IDs)
        const totalDistanceSpan = document.getElementById('totalDistance');
        const totalMovingTimeSpan = document.getElementById('totalMovingTime');
        const averageOverallPaceSpan = document.getElementById('averageOverallPace');
        const totalActivitiesSpan = document.getElementById('totalActivities');

        // D3.js chart specific elements (from original report.html)
        const distanceByRunnerChart = document.getElementById('distance-by-runner-chart'); 
        const distanceByClubChart = document.getElementById('distance-by-club-chart'); 

        // Detailed Activities Table elements (from original report.html)
        const detailedActivitiesTableBody = document.querySelector('#detailed-activities-table tbody');
        const detailedActivitiesStatus = document.getElementById('detailed-activities-status');

        // Weekly Distance Chart elements (from original report.html)
        const weeklyDistanceChartContainer = document.getElementById('weekly-distance-chart-container');
        const weeklyChartStatus = document.getElementById('weekly-chart-status');

        // Penalty/Bonus Table elements (from original report.html)
        const penaltyPerKmGt10Input = document.getElementById('penalty-per-km-gt10');
        const penaltyPerKmLte10Input = document.getElementById('penalty-per-km-lte10');
        const targetKmPerWeekInput = document.getElementById('target-km-per-week');
        const penaltyBonusTableBody = document.querySelector('#penalty-bonus-table tbody');
        const penaltyBonusStatus = document.getElementById('penalty-bonus-status');

        // Weekly Activities Modal elements (from original report.html)
        const weeklyActivitiesModal = document.getElementById('weekly-activities-modal');
        const closeWeeklyActivitiesModalBtn = document.getElementById('close-weekly-activities-modal-btn');
        const weeklyActivitiesTitle = document.getElementById('weekly-activities-title');
        const weeklyActivitiesList = document.getElementById('weekly-activities-list');
        const weeklyActivitiesStatus = document.getElementById('weekly-activities-status');

        // Collapsible section elements (for Detailed Activities Table)
        const detailedActivitiesSection = document.getElementById('detailed-activities-section');
        const detailedActivitiesHeader = document.getElementById('detailed-activities-header');
        const detailedActivitiesContent = document.getElementById('detailed-activities-content');
        const detailedActivitiesToggleIcon = document.getElementById('detailed-activities-toggle-icon');
        const DETAILED_ACTIVITIES_STATE_KEY = 'detailedActivitiesCollapsed';


        // All Activity Types for multi-select (from original report.html)
        const ALL_ACTIVITY_TYPES = [
            'Run', 'Walk', 'Ride', 'Swim', 'Hike', 'NordicSki', 'AlpineSki', 'Workout', 'Yoga', 
            'WeightTraining', 'Elliptical', 'StairStepper', 'Rowing', 'Crossfit', 'Canoeing', 
            'Kayaking', 'StandUpPaddling', 'VirtualRide', 'VirtualRun', 'Wheelchair', 'Handcycle', 
            'RollerSki', 'IceSkate', 'Snowboard', 'Snowshoe', 'BackcountrySki', 'EMountainBikeRide', 
            'EBikeRide', 'MountainBikeRide', 'GravelRide', 'Velomobile', 'Kitesurf', 'Windsurf', 
            'RockClimbing', 'Alpinism', 'Badminton', 'Squash', 'TableTennis', 'Tennis', 'Volleyball', 
            'Surfing', 'Pilates', 'Golf', 'WaterSport', 'Soccer', 'Basketball'
        ].sort(); // Sort activity types alphabetically


        // --- Helper Functions ---

        function showAlert(message) {
            const customAlert = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
            customAlert.style.display = 'flex'; // Ensure it's visible

            alertOkBtn.onclick = () => {
                customAlert.classList.add('hidden');
                customAlert.style.display = 'none'; // Ensure it's hidden
            };
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const customConfirm = document.getElementById('custom-confirm-modal');
                const confirmMessage = document.getElementById('confirm-message');
                const confirmOkBtn = document.getElementById('confirm-ok-btn'); 
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                confirmMessage.textContent = message;
                customConfirm.classList.remove('hidden');
                customConfirm.style.display = 'flex'; // Ensure it's visible

                const cleanup = () => {
                    customConfirm.classList.add('hidden');
                    customConfirm.style.display = 'none'; // Ensure it's hidden
                    confirmOkBtn.onclick = null;
                    confirmCancelBtn.onclick = null;
                };

                confirmOkBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                confirmCancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        // Function to convert seconds to HH:MM:SS format (used for total moving time) - from report origin.html
        function formatTime(seconds) {
            if (seconds === null || isNaN(seconds)) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s]
                .map(v => v < 10 ? '0' + v : v)
                .filter((v, i) => v !== '00' || i > 0)
                .join(':') || '00:00';
        }

        // Function to format seconds into MM:SS for pace labels (used for chart axes and tooltips) - from report origin.html
        // This function assumes valid totalSeconds input. The validity check should happen upstream.
        function formatPaceLabel(totalSeconds) {
            console.log('DEBUG: formatPaceLabel input totalSeconds:', totalSeconds);
            if (totalSeconds === null || isNaN(totalSeconds) || totalSeconds < 0) {
                console.log('DEBUG: formatPaceLabel output: N/A (invalid input)');
                return 'N/A';
            }
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);
            console.log(`DEBUG: minutes=${minutes}, seconds=${seconds} for totalSeconds=${totalSeconds}`);
            const formatted = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            console.log('DEBUG: formatPaceLabel output:', formatted);
            return formatted;
        }

        // Function to convert average_speed (m/s) to pace (min/km) formatted as MM:SS /km (used for overall summary)
        function formatPace(speedMs) {
            console.log('DEBUG: formatPace input speedMs (for overall summary):', speedMs);
            if (speedMs === null || isNaN(speedMs) || speedMs <= 0) {
                console.log('DEBUG: formatPace output (overall): N/A (invalid speedMs)');
                return 'N/A';
            }
            // Check for extremely fast pace that would result in 00:00 (less than 0.5 seconds/km)
            const paceSecondsPerKm = 1000 / speedMs; // total seconds per kilometer
            console.log('DEBUG: Calculated paceSecondsPerKm (overall):', paceSecondsPerKm);

            if (paceSecondsPerKm < 0.5) { 
                console.warn('DEBUG: Extremely fast pace detected, returning N/A. Pace seconds/km:', paceSecondsPerKm);
                return 'N/A'; // Revert to plain N/A
            }

            const formatted = `${formatPaceLabel(paceSecondsPerKm)} /km`;
            console.log('DEBUG: formatPace output (overall):', formatted);
            return formatted;
        }
        
        // Original formatPace from initial report.html for detailed table
        function formatPaceForTable(metersPerSecond) {
            console.log('DEBUG: formatPaceForTable input metersPerSecond (for detailed table):', metersPerSecond);
            if (typeof metersPerSecond !== 'number' || isNaN(metersPerSecond) || metersPerSecond <= 0) {
                console.log('DEBUG: formatPaceForTable output (individual): N/A (invalid metersPerSecond)');
                return 'N/A';
            }
            const kmPerHour = (metersPerSecond * 3.6); 
            if (kmPerHour === 0) {
                console.log('DEBUG: formatPaceForTable output (individual): N/A (kmPerHour is 0)');
                return 'N/A';
            }
            const minutesPerKm = 60 / kmPerHour; 
            console.log('DEBUG: Calculated minutesPerKm (individual):', minutesPerKm);

            // Check for extremely fast pace that would result in 00:00 (less than 0.5 seconds)
            if (minutesPerKm < (0.5 / 60)) { 
                console.warn('DEBUG: Extremely fast pace detected for table, returning N/A. Minutes per Km:', minutesPerKm);
                return 'N/A'; // Revert to plain N/A
            }

            const minutes = Math.floor(minutesPerKm);
            const seconds = Math.round((minutesPerKm - minutes) * 60);
            console.log(`DEBUG: minutes (table)=${minutes}, seconds (table)=${seconds} for minutesPerKm=${minutesPerKm}`);
            return `${minutes}:${String(seconds).padStart(2, '0')} /km`;
        }

        // Function to format elevation gain (m)
        function formatElevationGain(meters) {
            if (meters === null || isNaN(meters)) return 'N/A';
            return `${Math.round(meters)} m`;
        }

        /**
         * Populates the multi-select filter dropdowns (from original report.html).
         */
        function populateActivityTypeFilters() {
            multiSelectOptionsReport.innerHTML = ''; 
            ALL_ACTIVITY_TYPES.forEach(type => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.textContent = type;
                optionDiv.dataset.value = type;
                multiSelectOptionsReport.appendChild(optionDiv);
            });
        }

        /**
         * Updates the display of selected items in the multi-select (from original report.html).
         * @param {HTMLElement} displayElement - The element to show selected tags.
         * @param {string[]} selectedTypes - Array of selected activity types.
         * @param {HTMLElement} optionsContainer - The container for options to update their 'selected' class.
         */
        function updateMultiSelectDisplay(displayElement, selectedTypes, optionsContainer) {
            displayElement.innerHTML = '';
            if (selectedTypes.length === 0) {
                displayElement.innerHTML = '<span class="text-gray-500">Chọn loại hoạt động</span>';
            } else {
                selectedTypes.forEach(type => {
                    const itemSpan = document.createElement('span');
                    itemSpan.className = 'multi-select-selected-item';
                    itemSpan.innerHTML = `${type} <span data-value="${type}" class="remove-item-btn">&times;</span>`;
                    displayElement.appendChild(itemSpan);
                });
            }

            Array.from(optionsContainer.children).forEach(optionDiv => {
                if (selectedTypes.includes(optionDiv.dataset.value)) {
                    optionDiv.classList.add('selected');
                } else {
                    optionDiv.classList.remove('selected');
                }
            });
        }

        /**
         * Toggles an activity type in the selected list (from original report.html).
         * @param {string} type - The activity type to toggle.
         * @param {string[]} selectedTypesArray - The array to modify.
         * @param {HTMLElement} displayElement - The display element for this filter.
         * @param {HTMLElement} optionsContainer - The options container for this filter.
         */
        function toggleActivityType(type, selectedTypesArray, displayElement, optionsContainer) {
            const index = selectedTypesArray.indexOf(type);
            if (index > -1) {
                selectedTypesArray.splice(index, 1); // Remove if already exists
            } else {
                selectedTypesArray.push(type); // Add if not exists
                selectedTypesArray.sort(); // Keep sorted alphabetically
            }
            updateMultiSelectDisplay(displayElement, selectedTypesArray, optionsContainer);
        }

        // Event delegation for multi-select options (Report Page specific)
        document.addEventListener('click', (event) => {
            // Toggle options visibility
            if (event.target.closest('#multi-select-display-report')) {
                document.getElementById('multi-select-options-report').classList.toggle('hidden');
            } else {
                // Click outside to close options
                if (!event.target.closest('#multi-select-options-report')) {
                    document.getElementById('multi-select-options-report').classList.add('hidden');
                }
            }

            // Handle option selection/deselection
            if (event.target.classList.contains('multi-select-option')) {
                const type = event.target.dataset.value;
                if (event.target.closest('#multi-select-options-report')) {
                    toggleActivityType(type, selectedActivityTypesReport, multiSelectDisplayReport, multiSelectOptionsReport);
                }
            } else if (event.target.classList.contains('remove-item-btn')) {
                const type = event.target.dataset.value;
                if (event.target.closest('#multi-select-display-report')) {
                    toggleActivityType(type, selectedActivityTypesReport, multiSelectDisplayReport, multiSelectOptionsReport);
                }
            }
        });


        /**
         * Fetches all runner credentials for the logged-in user from Supabase (from original report.html).
         */
        async function fetchAllRunnerCredentials() {
            try {
                const { data, error } = await supabaseClientInstance
                    .from('runner_credentials')
                    .select('*')
                    .order('runner_name', { ascending: true });
                if (error) throw error;
                allRunnerCredentials = data;
                console.log('Fetched all runner credentials for report:', allRunnerCredentials);
            } catch (error) {
                console.error('Error fetching all runner credentials:', error.message);
                showAlert(`Lỗi khi tải thông tin runner: ${error.message}`);
                allRunnerCredentials = [];
            }
        }

        /**
         * Fetches clubs from Supabase and updates the global `allClubs` array (from original report.html).
         */
        async function fetchClubs() {
            try {
                const { data, error } = await supabaseClientInstance
                    .from('clubs')
                    .select('*')
                    .order('name', { ascending: true });
                if (error) throw error;
                allClubs = data;
                console.log('Fetched clubs for report:', allClubs);
            } catch (error) {
                console.error('Error fetching clubs for report:', error.message);
                showAlert(`Lỗi khi tải danh sách câu lạc bộ: ${error.message}`);
                allClubs = [];
            }
        }

        /**
         * Populates the runner and club filter dropdowns (from original report.html).
         */
        function populateFilters() {
            // Populate Runner filter
            reportRunnerFilter.innerHTML = '<option value="all">Tất cả Runner</option>';
            allRunnerCredentials.forEach(cred => {
                const option = document.createElement('option');
                option.value = String(cred.athlete_id); // Use athlete_id for filtering activities
                option.textContent = cred.runner_name;
                reportRunnerFilter.appendChild(option);
            });
            reportRunnerFilter.value = selectedRunnerIdReport; // Restore previous selection

            // Populate Club filter
            reportClubFilter.innerHTML = '<option value="all">Tất cả Câu lạc bộ</option>';
            allClubs.forEach(club => {
                const option = document.createElement('option');
                option.value = club.name;
                option.textContent = club.name;
                reportClubFilter.appendChild(option);
            });
            reportClubFilter.value = selectedClubNameReport; // Restore previous selection

            // Initialize activity type filter
            populateActivityTypeFilters();
            updateMultiSelectDisplay(multiSelectDisplayReport, selectedActivityTypesReport, multiSelectOptionsReport);
        }

        /**
         * Fetches activity data based on current filters from Supabase and then renders all reports.
         * (Adapted from original report.html)
         */
        async function fetchAndRenderReportData() {
            reportFilterStatus.textContent = 'Đang tải dữ liệu báo cáo...';
            allActivitiesData = []; // Clear previous data

            try {
                const { data: { session }, error: sessionError } = await supabaseClientInstance.auth.getSession();
                if (sessionError || !session?.access_token) {
                    throw new Error('Không tìm thấy phiên đăng nhập Supabase. Vui lòng đăng nhập lại.');
                }

                // Prepare filters for the Supabase query
                let queryRunnerIds = [];
                if (selectedRunnerIdReport === 'all') {
                    // If 'All Runners' is selected, get all athlete_ids that exist
                    queryRunnerIds = allRunnerCredentials.filter(c => c.athlete_id).map(c => String(c.athlete_id));
                } else {
                    queryRunnerIds = [selectedRunnerIdReport];
                }

                // If a specific club is selected, narrow down runner IDs further
                if (selectedClubNameReport !== 'all') {
                    const runnersInSelectedClub = allRunnerCredentials.filter(
                        c => c.running_team === selectedClubNameReport && c.athlete_id
                    ).map(c => String(c.athlete_id));
                    queryRunnerIds = queryRunnerIds.filter(id => runnersInSelectedClub.includes(id));
                }

                if (queryRunnerIds.length === 0) {
                    reportFilterStatus.textContent = 'Không có dữ liệu để hiển thị với các bộ lọc đã chọn. Vui lòng điều chỉnh bộ lọc.';
                    renderAllReports(); // Render empty reports
                    return;
                }

                let query = supabaseClientInstance
                    .from('activities')
                    .select('strava_activity_id, name, type, distance, moving_time, total_elevation_gain, start_date, average_speed, average_heartrate, user_id')
                    .in('user_id', queryRunnerIds); // Filter by runner IDs

                if (selectedActivityTypesReport.length > 0) {
                    query = query.in('type', selectedActivityTypesReport);
                }

                if (reportStartDateInput.value) {
                    query = query.gte('start_date', reportStartDateInput.value + 'T00:00:00.000Z');
                }
                if (reportEndDateInput.value) {
                    // Add one day to end date to include activities on that day
                    const endDatePlusOne = new Date(reportEndDateInput.value);
                    endDatePlusOne.setDate(endDatePlusOne.getDate() + 1);
                    query = query.lt('start_date', endDatePlusOne.toISOString());
                }

                query = query.order('start_date', { ascending: false });

                const { data, error } = await query;

                if (error) throw error;
                
                // Process fetched data to include formatted fields for Chart.js and D3.js
                allActivitiesData = data.map(activity => ({
                    ...activity,
                    start_date: new Date(activity.start_date), // Convert date string to Date object
                    distance_km: (activity.distance / 1000).toFixed(2), // Convert meters to km
                    moving_time_formatted: formatTime(activity.moving_time),
                    // Calculate raw pace in seconds/km for sorting/binning (numerical value for Chart.js)
                    pace_seconds_per_km_raw: (activity.average_speed !== null && activity.average_speed > 0) ? (1000 / activity.average_speed) : null,
                    pace_min_per_km_formatted: formatPaceForTable(activity.average_speed) // Formatted pace string for display
                }));

                reportFilterStatus.textContent = `Đã tải ${allActivitiesData.length} hoạt động.`;
                renderAllReports(); // Call a function to render all sections
                
            } catch (error) {
                console.error('Error fetching report data:', error.message);
                reportFilterStatus.textContent = `Lỗi khi tải báo cáo: ${error.message}`;
                showAlert(`Lỗi khi tải báo cáo: ${error.message}`);
                allActivitiesData = []; // Clear data on error
                renderAllReports(); // Render empty reports
            }
        }


        /**
         * Renders all report sections: summary, detailed table, charts.
         * (Adapted from original report.html)
         */
        function renderAllReports() {
            // 1. Render Overall Stats
            let totalActivities = allActivitiesData.length;
            let totalDistance = 0; // in meters
            let totalMovingTime = 0; // in seconds

            allActivitiesData.forEach(activity => {
                totalDistance += activity.distance || 0;
                totalMovingTime += activity.moving_time || 0;
            });

            console.log('DEBUG: Total Distance (m):', totalDistance, 'Total Moving Time (s):', totalMovingTime); // Debugging log

            totalActivitiesSpan.textContent = totalActivities;
            totalDistanceSpan.textContent = `${(totalDistance / 1000).toFixed(2)} KM`;
            totalMovingTimeSpan.textContent = formatTime(totalMovingTime);

            // Calculate overall average pace for summary
            let averageOverallPaceFormatted = 'N/A';
            if (totalDistance > 0 && totalMovingTime > 0) {
                // Corrected: totalDistance is already in meters, no need to multiply by 1000 again.
                const overallAverageSpeedMs = totalDistance / totalMovingTime; 
                console.log('DEBUG: Overall Average Speed (m/s):', overallAverageSpeedMs); // Debugging log
                averageOverallPaceFormatted = formatPace(overallAverageSpeedMs);
            }
            console.log('DEBUG: Average Overall Pace Formatted (before assign):', averageOverallPaceFormatted); // Debugging log
            averageOverallPaceSpan.textContent = averageOverallPaceFormatted;


            // 2. Render Detailed Activities Table
            renderDetailedActivitiesTable(allActivitiesData);

            // 3. Render Weekly Distance Chart (D3.js)
            // Changed to use the generic drawBubbleChart function
            renderWeeklyDistanceChart(allActivitiesData);

            // 4. Render Penalty/Bonus Table
            renderPenaltyBonusTable(allActivitiesData);

            // 5. Render Distance by Runner/Club Chart (D3.js)
            renderDistanceCharts(allActivitiesData);

            // 6. Render Chart.js Charts (re-using functions from report origin.html)
            renderChartJSCharts(allActivitiesData);
        }
        
        /**
         * Renders all Chart.js specific charts.
         * @param {Array} data - Array of activity objects.
         */
        function renderChartJSCharts(data) {
            renderDistanceChart(data);
            renderPaceDistributionChart(data);
            renderHeartRatePaceChart(data);
            renderActivityTypeChart(data);
        }

        /**
         * Renders the detailed activities table (from original report.html).
         * @param {Array} activities - Array of activity objects.
         */
        function renderDetailedActivitiesTable(activities) {
            detailedActivitiesTableBody.innerHTML = '';
            if (activities.length === 0) {
                detailedActivitiesStatus.textContent = 'Không có hoạt động nào để hiển thị.';
                return;
            }
            detailedActivitiesStatus.textContent = '';

            activities.forEach(activity => {
                const row = detailedActivitiesTableBody.insertRow();
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                const runnerName = runner ? runner.runner_name : 'N/A';
                const runnerClub = runner ? runner.running_team : 'N/A';

                row.innerHTML = `
                    <td>${runnerName}</td>
                    <td>${runnerClub}</td>
                    <td>${activity.name}</td>
                    <td>${activity.type}</td>
                    <td>${new Date(activity.start_date).toLocaleDateString('vi-VN')}</td>
                    <td>${(activity.distance / 1000).toFixed(2)}</td>
                    <td>${formatTime(activity.moving_time)}</td>
                    <td>${formatPaceForTable(activity.average_speed)}</td>
                    <td>${activity.average_heartrate ? activity.average_heartrate.toFixed(0) : 'N/A'}</td>
                    <td>${formatElevationGain(activity.total_elevation_gain)}</td>
                `;
            });
        }

        /**
         * Calculates and renders weekly distance chart (D3.js).
         * This version aggregates distance across all runners for each week.
         * @param {Array} activities - Array of activity objects.
         */
        function renderWeeklyDistanceChart(activities) {
            weeklyDistanceChartContainer.innerHTML = '';
            weeklyChartStatus.textContent = '';

            if (activities.length === 0) {
                weeklyDistanceChartContainer.innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu để hiển thị biểu đồ thống kê theo tuần.</p>';
                return;
            }

            const weeklyAggregatedData = new Map(); // Map: ISOWeek -> totalDistance
            const weeklyDetailedActivities = new Map(); // Map: ISOWeek -> array of activities for that week

            activities.forEach(activity => {
                const isoWeek = getISOWeekString(activity.start_date);
                if (isoWeek) {
                    weeklyAggregatedData.set(isoWeek, (weeklyAggregatedData.get(isoWeek) || 0) + activity.distance);

                    if (!weeklyDetailedActivities.has(isoWeek)) {
                        weeklyDetailedActivities.set(isoWeek, []);
                    }
                    // Store the original activity object (or a copy) along with its runner's athlete_id
                    weeklyDetailedActivities.get(isoWeek).push({ ...activity, athlete_id: activity.user_id }); 
                }
            });

            // Convert map to array for D3, then sort by week
            const weeklyStats = Array.from(weeklyAggregatedData.entries()).map(([week, totalDistance]) => ({
                week: week,
                totalDistance: totalDistance, // Total distance for the week across all runners
                // We don't need athlete_id here for drawing the bubble, but for the modal click.
                // We'll pass the whole week's activities to the modal function.
            })).sort((a, b) => a.week.localeCompare(b.week));


            if (weeklyStats.length === 0) {
                weeklyDistanceChartContainer.innerHTML = '<p class="text-gray-500 text-center">Không có dữ liệu để hiển thị biểu đồ thống kê theo tuần.</p>';
                return;
            }

            const container = weeklyDistanceChartContainer;
            const width = container.clientWidth;
            const height = 300; // Fixed height for weekly chart

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxDistance = d3.max(weeklyStats, d => d.totalDistance);
            const minDistance = d3.min(weeklyStats, d => d.totalDistance);

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxDistance || 1])
                .range([10, 40]);

            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([maxDistance || 1, minDistance || 0]);

            const x = d3.scaleBand()
                .domain(weeklyStats.map(d => d.week)) // Use unique week string for X axis
                .range([50, width - 20])
                .paddingInner(0.1);

            const y = d3.scaleLinear()
                .domain([0, maxDistance * 1.2 || 10000]) // Extend y-axis slightly
                .range([height - 50, 20]);

            // Adjust x-axis tick format to show only week number and year
            const xAxis = d3.axisBottom(x).tickFormat(d => {
                const parts = d.split('-W');
                return `W${parts[1]}-${parts[0]}`; // Format as WNN-YYYY
            });
            const yAxis = d3.axisLeft(y).tickFormat(d => `${(d / 1000).toFixed(0)}km`);

            svg.append("g")
                .attr("transform", `translate(0, ${height - 50})`)
                .call(xAxis)
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .attr("transform", `translate(50, 0)`)
                .call(yAxis);

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            svg.selectAll(".bubble")
                .data(weeklyStats)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => x(d.week) + x.bandwidth() / 2) // Center bubble in band
                .attr("cy", d => y(d.totalDistance))
                .attr("r", d => radiusScale(d.totalDistance))
                .attr("fill", d => colorScale(d.totalDistance))
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`Tuần: ${d.week.replace(/-W/, 'W')}<br>Tổng quãng đường: ${(d.totalDistance / 1000).toFixed(2)} km`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                })
                .on("click", function(event, d) {
                    // When clicked, open modal for activities of this week (for ALL runners)
                    const activitiesInWeek = weeklyDetailedActivities.get(d.week) || [];
                    weeklyActivitiesTitle.textContent = `Hoạt động trong tuần ${d.week.replace(/-W/, 'W')}:`;
                    displayActivitiesInModal(activitiesInWeek); // New function to display
                });

            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height - 10})`)
                .style("text-anchor", "middle")
                .text("Tuần");

            svg.append("text")
                .attr("transform", `rotate(-90) translate(-${height / 2}, 15)`)
                .style("text-anchor", "middle")
                .text("Quãng đường (KM)");
        }

        /**
         * Helper to get ISO week string (YYYY-WNN) from a Date object, adjusted for Vietnam timezone.
         * This function ensures that the week calculation aligns with Vietnam local time (UTC+7),
         * regardless of the user's browser timezone settings, by explicitly converting the UTC date
         * to its Vietnam timezone components before calculating the ISO week.
         * @param {Date|string} d - The Date object or ISO 8601 string (assumed to be UTC from Supabase).
         * @returns {string} ISO week string (YYYY-WNN). Returns null if input is invalid.
         */
        function getISOWeekString(d) {
            let activityDateUtc;

            // Ensure we have a valid Date object, assuming string inputs are UTC ISO 8601
            if (typeof d === 'string') {
                activityDateUtc = new Date(d);
            } else if (d instanceof Date) {
                activityDateUtc = d;
            } else {
                console.error("Invalid date input for getISOWeekString:", d);
                return null;
            }

            // Check for invalid date
            if (isNaN(activityDateUtc.getTime())) {
                console.error("Invalid Date object after parsing in getISOWeekString:", d);
                return null;
            }

            // Use Intl.DateTimeFormat to get date components as perceived in 'Asia/Ho_Chi_Minh'
            // This is the most robust way to get timezone-specific date parts in vanilla JS.
            const formatter = new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                timeZone: 'Asia/Ho_Chi_Minh',
                hour12: false // Ensure 24-hour format for consistency
            });

            const parts = formatter.formatToParts(activityDateUtc);
            let year, month, day, hour = 0, minute = 0, second = 0;

            parts.forEach(p => {
                switch (p.type) {
                    case 'year': year = parseInt(p.value); break;
                    case 'month': month = parseInt(p.value); break;
                    case 'day': day = parseInt(p.value); break;
                    case 'hour': hour = parseInt(p.value); break;
                    case 'minute': minute = parseInt(p.value); break;
                    case 'second': second = parseInt(p.value); break;
                }
            });

            // Construct a new Date object using Date.UTC() from the Vietnam-aligned components.
            // This creates a UTC date whose *UTC properties* (like getUTCDay, getUTCFullYear)
            // will now correctly reflect the date and day of the week in Vietnam.
            const vietnamAlignedUtcDate = new Date(Date.UTC(year, month - 1, day, hour, minute, second));

            // Set to the start of the day in UTC for the Vietnam-aligned date
            vietnamAlignedUtcDate.setUTCHours(0, 0, 0, 0);

            // ISO week calculation logic (ISO 8601 defines weeks starting on Monday)
            // getUTCDay() returns 0 for Sunday, 1 for Monday, ..., 6 for Saturday.
            // We map Sunday (0) to 7 for consistent calculation.
            const dayOfVietnamWeekUtc = vietnamAlignedUtcDate.getUTCDay() || 7; 

            // Adjust the date to the nearest Thursday of its week (in Vietnam time).
            // Thursday is chosen because it's always in the same ISO week as the week's Monday.
            vietnamAlignedUtcDate.setUTCDate(vietnamAlignedUtcDate.getUTCDate() + 4 - dayOfVietnamWeekUtc);

            // Get the year of the ISO week. This might be different from the actual year
            // if the first week of the new year falls into the end of the previous year, or vice-versa.
            const isoWeekYear = vietnamAlignedUtcDate.getUTCFullYear();

            // Get the first day of that ISO year (January 1st UTC of the ISO year)
            const yearStart = new Date(Date.UTC(isoWeekYear, 0, 1));

            // Calculate the ISO week number:
            // (Difference in milliseconds between the Vietnam-aligned Thursday and the start of its ISO year + 1 day) / milliseconds in 7 days
            const weekNo = Math.ceil((((vietnamAlignedUtcDate - yearStart) / 86400000) + 1) / 7);

            // Return the ISO week string in YYYY-WNN format
            return `${isoWeekYear}-W${String(weekNo).padStart(2, '0')}`;
        }

        /**
         * Displays detailed activities for a specific week in a modal.
         * This function now takes an array of activity objects directly.
         * @param {Array} activitiesToDisplay - Array of activity objects for the week.
         */
        function displayActivitiesInModal(activitiesToDisplay) {
            weeklyActivitiesList.innerHTML = '';
            weeklyActivitiesStatus.textContent = '';
            weeklyActivitiesModal.style.display = 'flex'; // Show modal

            if (activitiesToDisplay.length > 0) {
                activitiesToDisplay.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
                activitiesToDisplay.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'border-b last:border-b-0 py-2';
                    const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                    const runnerName = runner ? runner.runner_name : 'N/A';

                    li.innerHTML = `
                        <p class="font-semibold">${runnerName}: ${activity.name} (${activity.type})</p>
                        <p class="text-sm text-gray-600">Ngày: ${new Date(activity.start_date).toLocaleDateString('vi-VN')}</p>
                        <p class="text-sm text-gray-600">Quãng đường: ${(activity.distance / 1000).toFixed(2)} km</p>
                        <p class="text-sm text-gray-600">Thời gian: ${formatTime(activity.moving_time)}</p>
                        <p class="text-sm text-gray-600">Pace: ${formatPaceForTable(activity.average_speed)}</p>
                        ${activity.strava_activity_id ? `<button class="btn-primary mt-2 text-xs px-2 py-1 view-map-btn" data-activity-id="${activity.strava_activity_id}">Xem bản đồ</button>` : ''}
                    `;
                    weeklyActivitiesList.appendChild(li);
                });
                weeklyActivitiesStatus.textContent = `Đã tải ${activitiesToDisplay.length} hoạt động cho tuần này.`;
                document.querySelectorAll('#weekly-activities-modal .view-map-btn').forEach(button => {
                    button.onclick = (e) => {
                        const activityId = e.target.dataset.activityId;
                        if (activityId) {
                            window.open(`https://www.strava.com/activities/${activityId}`, '_blank');
                        }
                    };
                });
            } else {
                weeklyActivitiesStatus.textContent = 'Không tìm thấy hoạt động nào cho tuần này.';
            }
        }


        /**
         * Renders the penalty/bonus table (from original report.html).
         * @param {Array} activities - Array of activity objects.
         */
        function renderPenaltyBonusTable(activities) {
            penaltyBonusTableBody.innerHTML = '';
            penaltyBonusStatus.textContent = '';

            if (activities.length === 0) {
                penaltyBonusStatus.textContent = 'Chưa có dữ liệu để hiển thị.';
                return;
            }

            const penaltyPerKmGt10 = parseFloat(penaltyPerKmGt10Input.value) || 0;
            const penaltyPerKmLte10 = parseFloat(penaltyPerKmLte10Input.value) || 0;
            const targetKmPerWeek = parseFloat(targetKmPerWeekInput.value) || 0;

            const weeklyStatsByRunner = {}; // { athlete_id: { isoWeek: { totalDistance: ..., activities: [...] } } }

            activities.forEach(activity => {
                const athleteId = String(activity.user_id);
                const isoWeek = getISOWeekString(activity.start_date); // Sử dụng hàm lấy tuần theo múi giờ VN

                if (!weeklyStatsByRunner[athleteId]) {
                    weeklyStatsByRunner[athleteId] = {};
                }
                if (!weeklyStatsByRunner[athleteId][isoWeek]) {
                    weeklyStatsByRunner[athleteId][isoWeek] = { totalDistance: 0, activities: [] };
                }
                weeklyStatsByRunner[athleteId][isoWeek].totalDistance += (activity.distance / 1000); // Convert to KM
                weeklyStatsByRunner[athleteId][isoWeek].activities.push(activity);
            });

            const sortedAthleteIds = Object.keys(weeklyStatsByRunner).sort((a, b) => {
                const runnerA = allRunnerCredentials.find(rc => String(rc.athlete_id) === a);
                const runnerB = allRunnerCredentials.find(rc => String(rc.athlete_id) === b);
                const nameA = runnerA ? runnerA.runner_name : `Runner ID: ${a}`;
                const nameB = runnerB ? runnerB.runner_name : `Runner ID: ${b}`;
                return nameA.localeCompare(nameB);
            });

            sortedAthleteIds.forEach(athleteId => {
                const runnerName = allRunnerCredentials.find(rc => String(rc.athlete_id) === athleteId)?.runner_name || `Runner ID: ${athleteId}`;
                const runnerClub = allRunnerCredentials.find(rc => String(rc.athlete_id) === athleteId)?.running_team || 'N/A';

                const weeklyData = weeklyStatsByRunner[athleteId];
                const sortedWeeks = Object.keys(weeklyData).sort();

                sortedWeeks.forEach(isoWeek => {
                    const weekData = weeklyData[isoWeek];
                    const totalKm = weekData.totalDistance;
                    const kmDifference = totalKm - targetKmPerWeek;

                    let amount = 0;
                    let amountType = ''; // 'penalty' or 'bonus'

                    if (kmDifference < 0) {
                        const deficitKm = Math.abs(kmDifference);
                        let rate = 0;
                        if (deficitKm <= 10) {
                            rate = penaltyPerKmLte10;
                        } else {
                            rate = penaltyPerKmGt10;
                        }
                        amount = deficitKm * rate;
                        amountType = 'penalty';
                    } else {
                        // Bonus for exceeding target (using penaltyPerKmGt10 for bonus rate)
                        amount = kmDifference * penaltyPerKmGt10;
                        amountType = 'bonus';
                    }

                    const row = penaltyBonusTableBody.insertRow();
                    row.className = amountType === 'penalty' ? 'missing-row' : ''; // Apply red style for penalty

                    row.innerHTML = `
                        <td>${runnerName}</td>
                        <td>${runnerClub}</td>
                        <td>${isoWeek.replace(/-W/, 'W')}</td>
                        <td>${totalKm.toFixed(2)}</td>
                        <td>${targetKmPerWeek.toFixed(0)}</td>
                        <td class="${kmDifference < 0 ? 'text-red-600' : 'text-green-600'} font-bold">
                            ${kmDifference.toFixed(2)}
                        </td>
                        <td class="${amountType === 'penalty' ? 'text-red-600' : 'text-green-600'} font-bold">
                            ${amount.toLocaleString('vi-VN')}
                        </td>
                    `;
                });
            });
        }

        /**
         * Renders bubble charts for distance by runner and distance by club (D3.js - from original report.html).
         * @param {Array} activities - Array of activity objects.
         */
        function renderDistanceCharts(activities) {
            distanceByRunnerChart.innerHTML = '<p class="text-gray-500 text-sm">Biểu đồ quãng đường theo Runner sẽ hiển thị ở đây.</p>';
            distanceByClubChart.innerHTML = '<p class="text-gray-500 text-sm">Biểu đồ quãng đường theo CLB sẽ hiển thị ở đây.</p>';

            if (activities.length === 0) return;

            const distanceByRunner = new Map();
            const distanceByClub = new Map();

            activities.forEach(activity => {
                const distanceKm = activity.distance / 1000;
                const runner = allRunnerCredentials.find(rc => String(rc.athlete_id) === String(activity.user_id));
                const runnerName = runner ? runner.runner_name : `Runner ID: ${activity.user_id || 'Unknown'}`;
                const clubName = runner ? runner.running_team : 'Không rõ CLB';

                distanceByRunner.set(runnerName, (distanceByRunner.get(runnerName) || 0) + distanceKm);
                distanceByClub.set(clubName, (distanceByClub.get(clubName) || 0) + distanceKm);
            });

            const runnerData = Array.from(distanceByRunner.entries()).map(([name, distance]) => ({ name, distance }));
            const clubData = Array.from(distanceByClub.entries()).map(([name, distance]) => ({ name, distance }));

            // Render Runner Chart
            drawBubbleChart(distanceByRunnerChart, runnerData, "Quãng đường (KM) theo Runner", "name", "distance");

            // Render Club Chart
            drawBubbleChart(distanceByClubChart, clubData, "Quãng đường (KM) theo CLB", "name", "distance");
        }

        /**
         * Generic function to draw a bubble chart (D3.js - from original report.html).
         * @param {HTMLElement} container - The DOM element to append the SVG to.
         * @param {Array} data - Array of objects for the chart.
         * @param {string} title - Chart title.
         * @param {string} nameKey - Key for the name/category (e.g., 'runner_name', 'club_name').
         * @param {string} valueKey - Key for the numerical value (e.g., 'totalDistance', 'distance').
         */
        function drawBubbleChart(container, data, title, nameKey, valueKey) {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">${title} - Không có dữ liệu.</p>`;
                return;
            }

            const width = container.clientWidth;
            const height = Math.max(300, data.length * 60); // Adjust height dynamically based on number of items

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            const maxValue = d3.max(data, d => d[valueKey]);
            const minValue = d3.min(data, d => d[valueKey]);

            const maxRadius = width < 768 ? 30 : 60; // Max radius for bubbles
            const minRadius = width < 768 ? 8 : 15; // Min radius for bubbles

            const radiusScale = d3.scaleSqrt()
                .domain([0, maxValue || 1])
                .range([minRadius, maxRadius]); // Adjust range based on desired bubble sizes

            const colorScale = d3.scaleSequential(d3.interpolateYlGnBu)
                .domain([minValue || 0, maxValue || 1]);

            const simulation = d3.forceSimulation(data)
                .force("x", d3.forceX(width / 2).strength(0.05))
                .force("y", d3.forceY(height / 2).strength(0.05))
                .force("collide", d3.forceCollide(d => radiusScale(d[valueKey]) + 2))
                .stop();

            for (let i = 0; i < 120; ++i) simulation.tick(); // Run simulation for a fixed number of ticks

            let tooltip = d3.select("body").select(".tooltip");
            if (tooltip.empty()) {
                tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip");
            }

            const bubbles = svg.selectAll(".bubble")
                .data(data)
                .enter().append("circle")
                .attr("class", "bubble")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => radiusScale(d[valueKey]))
                .attr("fill", d => colorScale(d[valueKey]))
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`${d[nameKey]}<br>${d[valueKey].toFixed(2)} KM`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            svg.selectAll(".bubble-text")
                .data(data)
                .enter().append("text")
                .attr("class", "bubble-text")
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .text(d => d[nameKey])
                .attr("dy", "0.35em")
                .attr("font-size", d => Math.max(8, radiusScale(d[valueKey]) / 3.5)) // Dynamic font size
                .attr("fill", "white")
                .attr("pointer-events", "none");

            svg.append("text")
                .attr("x", width / 2)
                .attr("y", 30)
                .attr("text-anchor", "middle")
                .attr("font-size", "1.2rem")
                .attr("font-weight", "bold")
                .attr("fill", "#333")
                .text(title);
        }

        // --- Chart.js Specific Rendering Functions (from report origin.html) ---

        /**
         * Function to render Distance over Time Chart (Chart.js).
         * @param {Array} data - Array of activity objects.
         */
        function renderDistanceChart(data) {
            const ctx = document.getElementById('distanceChart').getContext('2d');

            // Sort data by date for chronological display
            data.sort((a, b) => a.start_date - b.start_date);

            const labels = data.map(activity => activity.start_date.toLocaleDateString('vi-VN'));
            const distances = data.map(activity => activity.distance_km);

            if (distanceChart) {
                distanceChart.destroy(); // Destroy previous chart instance
            }

            distanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Khoảng cách (km)',
                        data: distances,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: 'rgb(75, 192, 192)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(75, 192, 192)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const activity = data[context.dataIndex];
                                    return `Khoảng cách: ${activity.distance_km} km\nThời gian: ${activity.moving_time_formatted}\nTốc độ TB: ${activity.pace_min_per_km_formatted}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Ngày',
                                color: '#4b5563'
                            },
                            ticks: {
                                color: '#4b5563'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Khoảng cách (km)',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Function to render Pace Distribution Chart (Chart.js).
         * @param {Array} data - Array of activity objects.
         */
        function renderPaceDistributionChart(data) {
            const ctx = document.getElementById('paceDistributionChart').getContext('2d');

            // Filter out activities with null or invalid pace
            const validPaces = data
                .filter(activity => activity.pace_seconds_per_km_raw !== null && activity.pace_seconds_per_km_raw > 0)
                .map(activity => activity.pace_seconds_per_km_raw);

            if (validPaces.length === 0) {
                if (paceDistributionChart) paceDistributionChart.destroy();
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText("Không có dữ liệu tốc độ để hiển thị.", 10, 50);
                return;
            }

            // Create bins for histogram (e.g., 30 seconds/km intervals)
            const minPace = Math.min(...validPaces);
            const maxPace = Math.max(...validPaces);
            const binSize = 30; // seconds/km (e.g., 0.5 min/km)
            const bins = {};

            // Initialize bins
            for (let i = Math.floor(minPace / binSize) * binSize; i <= maxPace + binSize; i += binSize) {
                bins[i.toFixed(0)] = 0;
            }

            validPaces.forEach(pace => {
                const binKey = (Math.floor(pace / binSize) * binSize).toFixed(0);
                if (bins[binKey] !== undefined) {
                    bins[binKey]++;
                }
            });

            // Get raw seconds labels for Chart.js to handle tick generation
            const labels = Object.keys(bins).sort((a, b) => parseFloat(a) - parseFloat(b));
            const counts = labels.map(label => bins[label]);

            if (paceDistributionChart) {
                paceDistributionChart.destroy();
            }

            paceDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, // Use raw seconds values as labels
                    datasets: [{
                        label: 'Số lượng hoạt động',
                        data: counts,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgb(153, 102, 255)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Get the raw seconds value for the bin
                                    const rawSeconds = parseFloat(context[0].label);
                                    const startPace = formatPaceLabel(rawSeconds);
                                    const endPace = formatPaceLabel(rawSeconds + binSize);
                                    return `Tốc độ: ${startPace} - ${endPace} /km`;
                                },
                                label: function(context) {
                                    return `Số lượng hoạt động: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tốc độ trung bình (phút/km)',
                                color: '#4b5563'
                            },
                            ticks: {
                                color: '#4b5563',
                                // Format x-axis ticks as MM:SS pace range using the new formatPaceLabel function
                                callback: function(value, index, values) {
                                    const startSeconds = parseFloat(this.getLabelForValue(value));
                                    const endSeconds = startSeconds + binSize;
                                    return `${formatPaceLabel(startSeconds)} - ${formatPaceLabel(endSeconds)}`;
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Số lượng hoạt động',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0, // Ensure integer ticks for counts
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Function to render Heart Rate vs. Pace Chart (Chart.js).
         * @param {Array} data - Array of activity objects.
         */
        function renderHeartRatePaceChart(data) {
            const ctx = document.getElementById('heartRatePaceChart').getContext('2d');

            const scatterData = data
                .filter(activity => activity.average_heartrate !== null && activity.average_heartrate > 0 && activity.pace_seconds_per_km_raw !== null && activity.pace_seconds_per_km_raw > 0)
                .map(activity => ({
                    x: activity.pace_seconds_per_km_raw, // Raw pace in seconds/km for plotting
                    y: activity.average_heartrate,
                    name: activity.name,
                    distance_km: activity.distance_km,
                    moving_time_formatted: activity.moving_time_formatted,
                    pace_min_per_km_formatted: formatPaceForTable(activity.average_speed) // Formatted pace for tooltip
                }));

            if (scatterData.length === 0) {
                if (heartRatePaceChart) heartRatePaceChart.destroy();
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
                ctx.font = '16px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText("Không có dữ liệu nhịp tim/tốc độ để hiển thị.", 10, 50);
                return;
            }

            if (heartRatePaceChart) {
                heartRatePaceChart.destroy();
            }

            heartRatePaceChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Nhịp tim trung bình vs Tốc độ trung bình',
                        data: scatterData,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgb(255, 99, 132)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = context.raw;
                                    return `Hoạt động: ${item.name}\nTốc độ TB: ${item.pace_min_per_km_formatted}\nNhịp tim TB: ${item.y.toFixed(1)} bpm\nKhoảng cách: ${item.distance_km} km\nThời gian: ${item.moving_time_formatted}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tốc độ trung bình (phút/km)', // Updated label for clarity
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563',
                                callback: function(value, index, values) {
                                    return formatPaceLabel(value); // Format x-axis ticks as MM:SS
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Nhịp tim trung bình (bpm)',
                                color: '#4b5563'
                            },
                            beginAtZero: true,
                            ticks: {
                                color: '#4b5563'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Function to render Activity Type Chart (Doughnut Chart) (Chart.js).
         * @param {Array} data - Array of activity objects.
         */
        function renderActivityTypeChart(data) {
            const ctx = document.getElementById('activityTypeChart').getContext('2d');

            const activityTypes = {};
            data.forEach(activity => {
                activityTypes[activity.type] = (activityTypes[activity.type] || 0) + 1;
            });

            const labels = Object.keys(activityTypes);
            const counts = Object.values(activityTypes);

            const backgroundColors = [
                'rgba(255, 205, 86, 0.8)', // Yellow for Run
                'rgba(54, 162, 235, 0.8)',  // Blue for Walk
                'rgba(75, 192, 192, 0.8)',  // Teal for others
                'rgba(153, 102, 255, 0.8)', // Purple
                'rgba(201, 203, 207, 0.8)'  // Gray
            ];
            const borderColors = [
                'rgb(255, 205, 86)',
                'rgb(54, 162, 235)',
                'rgb(75, 192, 192)',
                'rgb(153, 102, 255)',
                'rgb(201, 203, 207)'
            ];

            if (activityTypeChart) {
                activityTypeChart.destroy();
            }

            activityTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lượng hoạt động',
                        data: counts,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Toggles the visibility of a collapsible content section and rotates its icon.
         * Optionally saves the state to localStorage.
         * @param {HTMLElement} contentElement - The content div to show/hide.
         * @param {HTMLElement} toggleIcon - The icon element to rotate.
         * @param {boolean|null} forceCollapse - If true, forces collapse; if false, forces expand. If null, toggles.
         * @param {string|null} stateKey - Key for localStorage to save the state ('expanded' or 'collapsed').
         */
        function toggleCollapsible(contentElement, toggleIcon, forceCollapse = null, stateKey = null) {
            let isCollapsed;
            if (forceCollapse !== null) {
                isCollapsed = forceCollapse;
            } else {
                // If not forcing, toggle based on current state
                isCollapsed = !contentElement.classList.contains('collapsed');
            }

            if (isCollapsed) {
                contentElement.classList.add('collapsed');
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
                if (stateKey) localStorage.setItem(stateKey, 'collapsed');
            } else {
                contentElement.classList.remove('collapsed');
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
                if (stateKey) localStorage.setItem(stateKey, 'expanded');
            }
        }


        // --- Supabase Authentication Check for Report Page ---
        async function checkAuthAndLoadReport() {
            try {
                const { data: { session }, error } = await supabaseClientInstance.auth.getSession();
                if (error || !session) {
                    console.warn('No active Supabase session found. Redirecting to Index1.html');
                    showAlert('Bạn cần đăng nhập để truy cập trang báo cáo. Đang chuyển hướng về trang đăng nhập...');
                    setTimeout(() => {
                        window.location.href = 'Index1.html';
                    }, 2000); // Redirect after 2 seconds
                    return;
                }
                
                // If session exists, set current user email and proceed to load data
                currentUserEmailSpan.textContent = session.user.email;
                await fetchAllRunnerCredentials(); // Load all runner credentials
                await fetchClubs(); // Load all clubs
                populateFilters(); // Populate dropdowns

                // Set default dates to past 7 days
                const today = new Date();
                const endDate = today.toISOString().split('T')[0];
                reportEndDateInput.value = endDate;

                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                const startDate = sevenDaysAgo.toISOString().split('T')[0];
                reportStartDateInput.value = startDate;

                await fetchAndRenderReportData(); // Initial data load from Supabase
            } catch (authError) {
                console.error('Error during authentication check:', authError.message);
                showAlert(`Lỗi xác thực: ${authError.message}. Đang chuyển hướng về trang đăng nhập...`);
                setTimeout(() => {
                    window.location.href = 'Index1.html';
                }, 2000);
            }
        }

        // --- Event Listeners and Initialization ---
        window.onload = async () => {
            if (typeof window.supabase === 'undefined') {
                showAlert('Lỗi: Thư viện Supabase không được tải. Vui lòng kiểm tra kết nối internet hoặc URL CDN.');
                console.error('Thư viện Supabase không được định nghĩa. Vui lòng kiểm tra thẻ script CDN Supabase.');
                return;
            }
            supabaseClientInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            await checkAuthAndLoadReport();

            logoutBtn.addEventListener('click', async () => {
                const confirmed = await showConfirm('Bạn có chắc chắn muốn đăng xuất không?');
                if (confirmed) {
                    try {
                        const { error } = await supabaseClientInstance.auth.signOut();
                        if (error) throw error;
                        localStorage.removeItem('strava_access_token');
                        localStorage.removeItem('strava_refresh_token');
                        localStorage.removeItem('strava_expires_at');
                        localStorage.removeItem('strava_athlete_id');
                        localStorage.removeItem('strava_runner_name');
                        localStorage.removeItem('strava_runner_credential_id');
                        localStorage.removeItem('strava_authenticated');
                        showAlert('Đăng xuất thành công. Đang chuyển hướng về trang đăng nhập...');
                        setTimeout(() => {
                            window.location.href = 'Index1.html';
                        }, 1500);
                    } catch (error) {
                        console.error('Lỗi đăng xuất:', error.message);
                        showAlert(`Lỗi khi đăng xuất: ${error.message}`);
                    }
                }
            });

            // Event listener for the Apply Filters button (to fetch data from Supabase)
            applyReportFiltersBtn.addEventListener('click', fetchAndRenderReportData);

            // Filter changes don't trigger direct fetch, only update selected values
            reportRunnerFilter.addEventListener('change', (e) => {
                selectedRunnerIdReport = e.target.value;
            });
            reportClubFilter.addEventListener('change', (e) => {
                selectedClubNameReport = e.target.value;
            });
            // Multi-select activity type changes are handled by global click listener
            reportStartDateInput.addEventListener('change', () => { /* value changed */ });
            reportEndDateInput.addEventListener('change', () => { /* value changed */ });

            // Penalty/Bonus calculation inputs trigger re-render of all reports (not a new fetch)
            penaltyPerKmGt10Input.addEventListener('input', renderAllReports);
            penaltyPerKmLte10Input.addEventListener('input', renderAllReports);
            targetKmPerWeekInput.addEventListener('input', renderAllReports);

            closeWeeklyActivitiesModalBtn.addEventListener('click', () => {
                weeklyActivitiesModal.style.display = 'none';
            });

            // Scroll-to-top button logic
            const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
            window.onscroll = function() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollToTopBtn.style.display = "block";
                } else {
                    scrollToTopBtn.style.display = "none";
                }
            };
            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });

            // Re-render charts on window resize
            window.addEventListener('resize', () => {
                if (allActivitiesData.length > 0) {
                    renderDistanceCharts(allActivitiesData); // D3.js charts
                    renderWeeklyDistanceChart(allActivitiesData); // D3.js chart
                    renderChartJSCharts(allActivitiesData); // Chart.js charts
                }
            });

            // Initial state: Clear charts and filter options until data is loaded
            // (Note: Initial rendering is now handled by checkAuthAndLoadReport calling fetchAndRenderReportData)
            document.addEventListener('DOMContentLoaded', () => {
                // Clear charts and set initial filter options, though checkAuthAndLoadReport will ultimately populate
                // and fetch data, so this might be redundant but safe.
                // clearCharts(); // Already handled by fetchAndRenderReportData which calls renderAllReports
                populateFilters(); // Ensure filters are populated even if no data is loaded yet
            });

            // Initialize collapsible detailed activities section
            if (detailedActivitiesHeader && detailedActivitiesContent && detailedActivitiesToggleIcon) {
                const savedState = localStorage.getItem(DETAILED_ACTIVITIES_STATE_KEY);
                // Default to collapsed if no state saved or if it was explicitly collapsed
                const initialStateCollapsed = (savedState === null || savedState === 'collapsed');
                toggleCollapsible(detailedActivitiesContent, detailedActivitiesToggleIcon, initialStateCollapsed, DETAILED_ACTIVITIES_STATE_KEY);

                detailedActivitiesHeader.addEventListener('click', () => {
                    toggleCollapsible(detailedActivitiesContent, detailedActivitiesToggleIcon, null, DETAILED_ACTIVITIES_STATE_KEY);
                });
            }
        };
    </script>
</body>
</html>
