<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng Th∆∞ k√Ω Cu·ªôc h·ªçp</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js cho vi·ªác ƒë·ªçc PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // C·∫•u h√¨nh worker cho PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Mammoth.js cho vi·ªác ƒë·ªçc Word (.docx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        /* Custom styles for Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide default file input */
        input[type="file"] {
            display: none;
        }
        /* Style for custom file input button */
        .custom-file-upload {
            border: 2px dashed #006B68;
            background-color: #E6F3E6;
            color: #006B68;
            padding: 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.2s ease-in-out;
            text-align: center;
        }
        .custom-file-upload:hover {
            border-color: #005A58;
            background-color: #D0E6D0;
        }
        .custom-file-upload.has-file {
            border-color: #FFC62F;
            background-color: #FFFBEB;
            color: #D97706;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #006B68;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-bidv-primary {
            background-color: #006B68;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: background-color 300ms ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-bidv-primary:hover:not(:disabled) {
            background-color: #005A58;
        }
        .btn-bidv-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-3xl space-y-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">T·∫°o L·ªãch H·ªçp t·ª´ T√†i li·ªáu</h1>

        <!-- PIN Authentication Section -->
        <div id="pin-section" class="flex flex-col items-center justify-center space-y-4 py-8 border-b border-gray-100">
            <h2 class="text-lg font-medium text-gray-700">Vui l√≤ng nh·∫≠p m√£ PIN ƒë·ªÉ s·ª≠ d·ª•ng ·ª©ng d·ª•ng</h2>
            <div class="flex items-center gap-2">
                <input type="password" id="pin-input" class="border border-gray-300 rounded-lg px-4 py-2 text-center focus:outline-none focus:border-[#006B68] focus:ring-1 focus:ring-[#006B68]" placeholder="Nh·∫≠p m√£ PIN">
                <button id="pin-submit" class="btn-bidv-primary px-4 py-2 !shadow-none">X√°c nh·∫≠n</button>
            </div>
            <p id="pin-error" class="text-red-500 text-sm hidden">M√£ PIN kh√¥ng ch√≠nh x√°c!</p>
        </div>

        <!-- Main App Section (Hidden by default) -->
        <div id="main-app-section" class="hidden space-y-6">

        <!-- File Upload Section -->
        <div class="border-b pb-6 mb-6">
            <label for="file-upload" class="custom-file-upload" id="file-upload-label">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
                <div>
                    <span id="file-upload-text" class="block font-semibold">T·∫£i l√™n t√†i li·ªáu cu·ªôc h·ªçp</span>
                    <span class="text-xs mt-1 block opacity-80">(H·ªó tr·ª£: ·∫¢nh JPG/PNG, File PDF, Word DOCX)</span>
                </div>
                <div id="file-upload-spinner" class="loading-spinner hidden mt-2"></div>
            </label>
            <input id="file-upload" type="file" accept=".jpg,.jpeg,.png,.pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
            
            <!-- Preview cho ·∫¢nh -->
            <div id="image-preview-container" class="mt-4 hidden">
                <img id="image-preview" class="max-w-full h-auto rounded-lg shadow-md mx-auto max-h-64 object-contain" src="#" alt="Xem tr∆∞·ªõc ·∫£nh" />
            </div>

            <!-- Preview cho T√†i li·ªáu (PDF/Word) -->
            <div id="doc-preview-container" class="mt-4 hidden bg-blue-50 border border-blue-200 rounded-lg p-6 flex-col items-center justify-center text-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-blue-500 mb-2 mx-auto">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
                <span id="doc-preview-name" class="font-medium text-blue-700 block break-all"></span>
                <span id="doc-preview-meta" class="text-xs text-blue-500 mt-1 block"></span>
            </div>

            <p id="file-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
        </div>

        <!-- Process Button -->
        <div class="flex justify-center">
            <button id="process-button" class="btn-bidv-primary" disabled>
                <span id="button-text">Tr√≠ch xu·∫•t th√¥ng tin & T·∫°o l·ªãch</span>
                <div id="loading-spinner" class="loading-spinner hidden"></div>
            </button>
        </div>

        <!-- Extracted Information Display -->
        <div id="extracted-info-section" class="mt-8 border-t pt-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Th√¥ng tin cu·ªôc h·ªçp ƒë√£ tr√≠ch xu·∫•t:</h2>
            <div id="extracted-info" class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-gray-800 text-sm overflow-x-auto">
                <!-- Extracted JSON will be displayed here -->
            </div>
            <div class="flex justify-center mt-6">
                <a id="download-ics" class="btn-bidv-primary" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    T·∫£i xu·ªëng t·ªáp ICS
                </a>
            </div>
        </div>

        <!-- Error Message Display -->
        <div id="error-message" class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
            <p class="font-semibold">ƒê√£ x·∫£y ra l·ªói:</p>
            <p id="error-text"></p>
        </div>

        <!-- Instructions Section -->
        <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200 text-blue-800">
            <h2 class="text-xl font-semibold mb-2">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</h2>
            <ol class="list-decimal list-inside space-y-1 text-sm">
                <li>Nh·∫≠p m√£ PIN ƒë·ªÉ truy c·∫≠p h·ªá th·ªëng.</li>
                <li>Nh·∫•p v√†o khu v·ª±c t·∫£i l√™n ƒë·ªÉ ch·ªçn t·ªáp (H·ªó tr·ª£ ·∫¢nh JPG/PNG, t·ªáp PDF, t·ªáp Word .docx).</li>
                <li>V·ªõi PDF, ·ª©ng d·ª•ng s·∫Ω qu√©t t·ª± ƒë·ªông (t·ªëi ƒëa 10 trang ƒë·∫ßu ti√™n) ƒë·ªÉ t√¨m th√¥ng tin l·ªãch h·ªçp.</li>
                <li>H·ªá th·ªëng s·ª≠ d·ª•ng AI th√¥ng qua Supabase ƒë·ªÉ ƒë·ªçc v√† ph√¢n t√≠ch ng√¥n ng·ªØ t·ª± nhi√™n th√†nh l·ªãch tr√¨nh.</li>
                <li>Xem l·∫°i th√¥ng tin v√† t·∫£i xu·ªëng t·ªáp ICS ƒë·ªÉ th√™m v√†o l·ªãch c√° nh√¢n (Google Calendar, Outlook,...).</li>
            </ol>
        </div>
        
        </div> <!-- End of Main App Section -->
    </div>

    <script>
        // C·∫§U H√åNH SUPABASE
        const SUPABASE_EDGE_FUNCTION_URL = "https://rmbsxccrwrktbjlnezpu.supabase.co/functions/v1/gemini-proxy"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y"; 

        // M√£ PIN b·∫£o m·∫≠t
        const SECRET_PIN = "123a";

        // UI elements cho PIN
        const pinSection = document.getElementById('pin-section');
        const mainAppSection = document.getElementById('main-app-section');
        const pinInput = document.getElementById('pin-input');
        const pinSubmit = document.getElementById('pin-submit');
        const pinError = document.getElementById('pin-error');

        // Logic ki·ªÉm tra m√£ PIN
        function verifyPin() {
            if (pinInput.value === SECRET_PIN) {
                pinSection.classList.add('hidden');
                mainAppSection.classList.remove('hidden');
            } else {
                pinError.classList.remove('hidden');
                pinInput.focus();
            }
        }

        pinSubmit.addEventListener('click', verifyPin);
        pinInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyPin();
            }
        });

        // H·ªßy th√¥ng b√°o l·ªói khi ng∆∞·ªùi d√πng b·∫Øt ƒë·∫ßu nh·∫≠p l·∫°i
        pinInput.addEventListener('input', function() {
            pinError.classList.add('hidden');
        });

        // UI elements ch√≠nh
        const fileUpload = document.getElementById('file-upload');
        const fileUploadLabel = document.getElementById('file-upload-label');
        const fileUploadText = document.getElementById('file-upload-text');
        const fileUploadSpinner = document.getElementById('file-upload-spinner');
        
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        
        const docPreviewContainer = document.getElementById('doc-preview-container');
        const docPreviewName = document.getElementById('doc-preview-name');
        const docPreviewMeta = document.getElementById('doc-preview-meta');

        const fileError = document.getElementById('file-error');
        const processButton = document.getElementById('process-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const extractedInfoSection = document.getElementById('extracted-info-section');
        const extractedInfoDiv = document.getElementById('extracted-info');
        const downloadIcsLink = document.getElementById('download-ics');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextP = document.getElementById('error-text');

        // State l∆∞u tr·ªØ d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω ƒë·ªÉ g·ª≠i ƒëi
        let documentPayload = null; 

        // H√†m n√©n ·∫£nh gi·ªØ nguy√™n nh∆∞ c≈©
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width;
                        let height = img.height;
                        const MAX_DIMENSION = 2000;

                        if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
                            if (width > height) {
                                height = Math.round(height * (MAX_DIMENSION / width));
                                width = MAX_DIMENSION;
                            } else {
                                width = Math.round(width * (MAX_DIMENSION / height));
                                height = MAX_DIMENSION;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        let quality = 0.9;
                        let outputMimeType = 'image/jpeg';
                        if (file.type === 'image/png' && file.size > 4 * 1024 * 1024) outputMimeType = 'image/jpeg';
                        else if (file.type === 'image/jpeg') outputMimeType = 'image/jpeg';

                        const attemptCompression = () => {
                            let compressedDataUrl = canvas.toDataURL(outputMimeType, quality);
                            let compressedBase64 = compressedDataUrl.split(',')[1];
                            const sizeInBytes = (compressedBase64.length * 0.75);

                            if (sizeInBytes <= 4 * 1024 * 1024 || quality <= 0.1) {
                                resolve({ base64: compressedBase64, mimeType: outputMimeType });
                            } else {
                                quality -= 0.1;
                                if (quality < 0.1) quality = 0.1;
                                setTimeout(attemptCompression, 0);
                            }
                        };
                        attemptCompression();
                    };
                    img.onerror = () => reject(new Error("Kh√¥ng th·ªÉ t·∫£i ·∫£nh ƒë·ªÉ n√©n."));
                    img.src = event.target.result;
                };
                reader.onerror = () => reject(new Error("Kh√¥ng th·ªÉ ƒë·ªçc t·ªáp ·∫£nh."));
                reader.readAsDataURL(file);
            });
        }

        // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn file
        fileUpload.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) {
                resetUI();
                return;
            }

            // Giao di·ªán loading
            fileUploadLabel.classList.add('has-file');
            fileUploadText.textContent = `ƒêang x·ª≠ l√Ω: ${file.name}`;
            fileUploadSpinner.classList.remove('hidden');
            processButton.disabled = true;
            hideResults();
            hideError();
            fileError.classList.add('hidden');
            imagePreviewContainer.classList.add('hidden');
            docPreviewContainer.classList.add('hidden');

            try {
                const fileNameLower = file.name.toLowerCase();

                // 1. X·ª¨ L√ù FILE PDF
                if (file.type === 'application/pdf' || fileNameLower.endsWith('.pdf')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(arrayBuffer)).promise;
                    
                    // Ch·ªâ render t·ªëi ƒëa 10 trang ƒë·ªÉ tr√°nh qu√° t·∫£i API v√† chi ph√≠
                    const numPages = Math.min(pdf.numPages, 10);
                    let images = [];

                    for (let i = 1; i <= numPages; i++) {
                        const page = await pdf.getPage(i);
                        // Scale 1.5 l√† ƒë·ªß ƒë·ªÉ AI ƒë·ªçc ch·ªØ n√©t
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                        const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                        images.push({ mimeType: 'image/jpeg', data: base64 });
                    }

                    documentPayload = { type: 'images', data: images };
                    showDocPreview(file.name, `PDF - ƒê√£ tr√≠ch xu·∫•t ${numPages} trang`);
                } 
                // 2. X·ª¨ L√ù FILE WORD (DOCX)
                else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || fileNameLower.endsWith('.docx')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    
                    if (!result.value || result.value.trim() === '') {
                        throw new Error("Kh√¥ng t√¨m th·∫•y ch·ªØ trong file Word n√†y ho·∫∑c file b·ªã l·ªói.");
                    }
                    
                    documentPayload = { type: 'text', data: result.value };
                    showDocPreview(file.name, `Word Document - ƒê√£ tr√≠ch xu·∫•t vƒÉn b·∫£n`);
                } 
                // 3. X·ª¨ L√ù FILE ·∫¢NH
                else if (file.type.startsWith('image/')) {
                    let finalBase64 = null;
                    let finalMimeType = file.type || 'image/jpeg'; 
                    if (finalMimeType === 'image/jpg') finalMimeType = 'image/jpeg';
                    else if (!['image/jpeg', 'image/png', 'image/webp', 'image/gif'].includes(finalMimeType)) finalMimeType = 'image/jpeg';

                    if (file.size <= 4 * 1024 * 1024) {
                        const reader = new FileReader();
                        await new Promise((resolve) => {
                            reader.onload = (e) => {
                                finalBase64 = e.target.result.split(',')[1];
                                resolve();
                            };
                            reader.readAsDataURL(file);
                        });
                    } else {
                        fileUploadText.textContent = `ƒêang n√©n ·∫£nh...`;
                        const compressedResult = await compressImage(file);
                        finalBase64 = compressedResult.base64;
                        finalMimeType = compressedResult.mimeType;

                        if ((finalBase64.length * 0.75) > 4 * 1024 * 1024) {
                            throw new Error('K√≠ch th∆∞·ªõc ·∫£nh sau n√©n v·∫´n qu√° l·ªõn (>4MB).');
                        }
                    }

                    documentPayload = { type: 'images', data: [{ mimeType: finalMimeType, data: finalBase64 }] };
                    imagePreview.src = `data:${finalMimeType};base64,${finalBase64}`;
                    imagePreviewContainer.classList.remove('hidden');
                } else {
                    throw new Error('ƒê·ªãnh d·∫°ng t·ªáp kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. Vui l√≤ng ch·ªçn JPG, PNG, PDF ho·∫∑c DOCX.');
                }

                processButton.disabled = false;
                fileUploadText.textContent = "T·∫£i t√†i li·ªáu th√†nh c√¥ng";

            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω t·ªáp:', error);
                fileError.textContent = `L·ªói: ${error.message}`;
                fileError.classList.remove('hidden');
                resetUI();
            } finally {
                fileUploadSpinner.classList.add('hidden');
            }
        });

        function showDocPreview(filename, meta) {
            docPreviewContainer.classList.remove('hidden');
            docPreviewContainer.classList.add('flex');
            docPreviewName.textContent = filename;
            docPreviewMeta.textContent = meta;
        }

        function resetUI() {
            documentPayload = null;
            processButton.disabled = true;
            fileUploadLabel.classList.remove('has-file');
            fileUploadText.innerHTML = 'T·∫£i l√™n t√†i li·ªáu cu·ªôc h·ªçp<br><span class="text-xs opacity-80 font-normal">(H·ªó tr·ª£: ·∫¢nh JPG/PNG, File PDF, Word DOCX)</span>';
            imagePreviewContainer.classList.add('hidden');
            docPreviewContainer.classList.add('hidden');
        }

        processButton.addEventListener('click', async () => {
            if (!documentPayload) {
                showError('Vui l√≤ng t·∫£i l√™n t√†i li·ªáu h·ª£p l·ªá tr∆∞·ªõc.');
                return;
            }

            buttonText.textContent = 'ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...';
            loadingSpinner.classList.remove('hidden');
            processButton.disabled = true;
            hideResults();
            hideError();

            try {
                const meetingData = await sendDataToSupabaseFunction();
                displayMeetingInfo(meetingData);
                generateIcsFile(meetingData);
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω API:', error);
                showError(`${error.message || 'Kh√¥ng th·ªÉ tr√≠ch xu·∫•t th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i.'}`);
            } finally {
                buttonText.textContent = 'Tr√≠ch xu·∫•t th√¥ng tin & T·∫°o l·ªãch';
                loadingSpinner.classList.add('hidden');
                processButton.disabled = false;
            }
        });

        /**
         * X√¢y d·ª±ng payload linh ho·∫°t cho OpenAI (Image Array ho·∫∑c Text) g·ª≠i qua Supabase Proxy
         */
        async function sendDataToSupabaseFunction() {
            const prompt = `B·∫°n l√† tr·ª£ l√Ω AI chuy√™n h·ªó tr·ª£ t·∫°o v√† qu·∫£n l√Ω l·ªãch h·ªçp, c√≥ kh·∫£ nƒÉng ƒë·ªçc hi·ªÉu t√†i li·ªáu v√† tr√≠ch xu·∫•t th√¥ng tin ch√≠nh x√°c ƒë·ªÉ x√¢y d·ª±ng l·ªãch h·ªçp chuy√™n nghi·ªáp.
            
            D·ª±a tr√™n n·ªôi dung t√†i li·ªáu (vƒÉn b·∫£n ho·∫∑c h√¨nh ·∫£nh) ƒë∆∞·ª£c cung c·∫•p, h√£y tr√≠ch xu·∫•t c√°c th√¥ng tin sau v√† b·∫Øt bu·ªôc tr·∫£ v·ªÅ d∆∞·ªõi d·∫°ng JSON h·ª£p l·ªá (kh√¥ng k√®m theo code block markdown n√†o, ch·ªâ output JSON g·ªëc). N·∫øu th√¥ng tin kh√¥ng c√≥, h√£y ƒë·ªÉ tr·ªëng ho·∫∑c s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh theo quy t·∫Øc.

            Quy t·∫Øc tr√≠ch xu·∫•t:
            - "Ch·ªß ƒë·ªÅ cu·ªôc h·ªçp": Ti√™u ƒë·ªÅ cu·ªôc h·ªçp. **B·∫Øt bu·ªôc k√®m theo s·ªë c√¥ng vƒÉn ho·∫∑c s·ªë th√¥ng b√°o (n·∫øu c√≥) v√†o cu·ªëi ti√™u ƒë·ªÅ, trong d·∫•u ngo·∫∑c ƒë∆°n (V√≠ d·ª•: "Ti√™u ƒë·ªÅ cu·ªôc h·ªçp (CV-2024/001)"). N·∫øu kh√¥ng c√≥ s·ªë, ch·ªâ ghi ti√™u ƒë·ªÅ.**
            - "ƒê·ªãa ƒëi·ªÉm h·ªçp": L·∫•y theo n·ªôi dung t√†i li·ªáu. N·∫øu kh√¥ng c√≥, ƒë√°nh d·∫•u l√† "Ch∆∞a r√µ ‚Äì c·∫ßn x√°c minh".
            - "Th·ªùi gian b·∫Øt ƒë·∫ßu": Th·ªùi gian b·∫Øt ƒë·∫ßu cu·ªôc h·ªçp (ƒë·ªãnh d·∫°ng: YYYY-MM-DD HH:MM).
            - "Th·ªùi gian k·∫øt th√∫c": Th·ªùi gian k·∫øt th√∫c cu·ªôc h·ªçp (ƒë·ªãnh d·∫°ng: YYYY-MM-DD HH:MM). N·∫øu kh√¥ng ƒë∆∞·ª£c n√™u r√µ, m·∫∑c ƒë·ªãnh = Th·ªùi gian b·∫Øt ƒë·∫ßu + 2 gi·ªù.
            - "Th√†nh ph·∫ßn tham d·ª±": Li·ªát k√™ c√°c ƒë∆°n v·ªã/c√° nh√¢n theo t√†i li·ªáu d∆∞·ªõi d·∫°ng m·∫£ng c√°c chu·ªói. **Ch·ªâ tr√≠ch xu·∫•t t√™n/ƒë∆°n v·ªã, kh√¥ng th√™m k√Ω hi·ªáu hay ƒë·ªãnh d·∫°ng ƒë·∫∑c bi·ªát.**
            - "N·ªôi dung l√†m vi·ªác ch√≠nh": T√≥m t·∫Øt ng·∫Øn g·ªçn, r√µ r√†ng n·ªôi dung l√†m vi·ªác ch√≠nh. **Ch·ªâ tr√≠ch xu·∫•t n·ªôi dung, kh√¥ng th√™m k√Ω hi·ªáu hay ƒë·ªãnh d·∫°ng ƒë·∫∑c bi·ªát nh∆∞ g·∫°ch ƒë·∫ßu d√≤ng. N·∫øu c√≥ nhi·ªÅu m·ª•c, m·ªói m·ª•c tr√™n m·ªôt d√≤ng m·ªõi.**
            - "ƒê∆°n v·ªã ch·ªß tr√¨ ho·∫∑c t·ªï ch·ª©c th·ª±c hi·ªán": ƒê∆°n v·ªã ch·ªß tr√¨ ho·∫∑c t·ªï ch·ª©c th·ª±c hi·ªán. **Ch·ªâ tr√≠ch xu·∫•t t√™n ƒë∆°n v·ªã, kh√¥ng th√™m k√Ω hi·ªáu hay ƒë·ªãnh d·∫°ng ƒë·∫∑c bi·ªát.**
            - "Ng∆∞·ªùi ch·ªß tr√¨ cu·ªôc h·ªçp": (T√πy ch·ªçn) Ng∆∞·ªùi ch·ªß tr√¨ cu·ªôc h·ªçp. **Ch·ªâ tr√≠ch xu·∫•t t√™n ng∆∞·ªùi, kh√¥ng th√™m k√Ω hi·ªáu hay ƒë·ªãnh d·∫°ng ƒë·∫∑c bi·ªát.**
            - "ƒê∆∞·ªùng d·∫´n h·ªçp tr·ª±c tuy·∫øn (Zoom/Teams/Meet)": (T√πy ch·ªçn) ƒê∆∞·ªùng d·∫´n h·ªçp tr·ª±c tuy·∫øn (Zoom/Teams/Meet).
            - "Y√™u c·∫ßu nh·∫Øc l·ªãch tr∆∞·ªõc": (T√πy ch·ªçn) Y√™u c·∫ßu nh·∫Øc l·ªãch tr∆∞·ªõc (v√≠ d·ª•: "1 NG√ÄY", "30 PH√öT"). N·∫øu kh√¥ng c√≥, m·∫∑c ƒë·ªãnh l√† "1 NG√ÄY".

            JSON Schema mong ƒë·ª£i:
            {
              "Ch·ªß ƒë·ªÅ cu·ªôc h·ªçp": "string",
              "ƒê·ªãa ƒëi·ªÉm h·ªçp": "string",
              "Th·ªùi gian b·∫Øt ƒë·∫ßu": "string",
              "Th·ªùi gian k·∫øt th√∫c": "string",
              "Th√†nh ph·∫ßn tham d·ª±": ["string"],
              "N·ªôi dung l√†m vi·ªác ch√≠nh": "string",
              "ƒê∆°n v·ªã ch·ªß tr√¨ ho·∫∑c t·ªï ch·ª©c th·ª±c hi·ªán": "string",
              "Ng∆∞·ªùi ch·ªß tr√¨ cu·ªôc h·ªçp": "string | null",
              "ƒê∆∞·ªùng d·∫´n h·ªçp tr·ª±c tuy·∫øn (Zoom/Teams/Meet)": "string | null",
              "Y√™u c·∫ßu nh·∫Øc l·ªãch tr∆∞·ªõc": "string | null"
            }
            `;

            let contentArray = [{ type: "text", text: prompt }];
            let selectedModel = "gpt-4o"; // M·∫∑c ƒë·ªãnh

            if (documentPayload.type === 'images') {
                // V·ªõi ·∫£nh v√† PDF (chuy·ªÉn th√†nh ·∫£nh), d√πng gpt-4o ƒë·ªÉ t·ªëi ∆∞u chi ph√≠ token h√¨nh ·∫£nh
                selectedModel = "gpt-4o";
                documentPayload.data.forEach(img => {
                    contentArray.push({
                        type: "image_url",
                        image_url: { url: `data:${img.mimeType};base64,${img.data}` }
                    });
                });
            } else if (documentPayload.type === 'text') {
                // V·ªõi vƒÉn b·∫£n thu·∫ßn t√∫y (Word), d√πng gpt-4o-mini v√¨ gi√° text c·ª±c k·ª≥ r·∫ª
                selectedModel = "gpt-4o";
                contentArray[0].text = prompt + "\n\n--- N·ªòI DUNG T√ÄI LI·ªÜU C·∫¶N ƒê·ªåC ---\n" + documentPayload.data;
            }

            const payload = {
                model: selectedModel, // T·ª± ƒë·ªông ch·ªçn model d·ª±a v√†o ƒë·ªãnh d·∫°ng file t·∫£i l√™n
                messages: [
                    {
                        role: "user",
                        content: contentArray
                    }
                ],
                response_format: { type: "json_object" },
                temperature: 0.2
            };

            const headers = { 'Content-Type': 'application/json' };
            if (SUPABASE_ANON_KEY) {
                 headers['Authorization'] = `Bearer ${SUPABASE_ANON_KEY}`;
            }

            const response = await fetch(SUPABASE_EDGE_FUNCTION_URL, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });

            // L·∫•y d·ªØ li·ªáu d·∫°ng th√¥ (text) tr∆∞·ªõc ƒë·ªÉ b·∫Øt l·ªói HTML 5xx g√¢y ra crash
            const responseText = await response.text();

            if (!response.ok) {
                let errorMessage = 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ Server Proxy';
                try {
                    const errorData = JSON.parse(responseText);
                    if (errorData.error && errorData.error.message) errorMessage = errorData.error.message;
                    else if (errorData.error && typeof errorData.error === 'string') errorMessage = errorData.error;
                    else errorMessage = JSON.stringify(errorData);
                } catch (e) {
                    // N·∫øu l·ªói tr·∫£ v·ªÅ l√† m√£ HTML (L·ªói m·∫°ng Supabase/OpenAI 500, 502)
                    errorMessage = `L·ªói m√°y ch·ªß (${response.status} ${response.statusText}). Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh Supabase Edge Function ho·∫∑c m·∫°ng c·ªßa b·∫°n.`;
                    console.error("HTML Error Response:", responseText);
                }

                if (response.status === 429) throw new Error(`B·∫°n ƒë√£ v∆∞·ª£t qu√° h·∫°n m·ª©c s·ª≠ d·ª•ng (L·ªói 429).`);
                else if (response.status === 401) throw new Error(`L·ªói x√°c th·ª±c (401). Vui l√≤ng ki·ªÉm tra l·∫°i thi·∫øt l·∫≠p kh√≥a ANON KEY.`);
                else if (response.status === 400) throw new Error(`L·ªói d·ªØ li·ªáu (400): ${errorMessage}`);
                
                throw new Error(errorMessage);
            }

            // Parsing c·∫©n th·∫≠n d·ªØ li·ªáu tr·∫£ v·ªÅ ƒë·ªÉ tr√°nh l·ªói 'Unexpected token <'
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (parseError) {
                console.error("L·ªói parse ph·∫£n h·ªìi (Kh√¥ng ph·∫£i JSON):", responseText);
                throw new Error("H·ªá th·ªëng tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng l·∫° (kh√¥ng ph·∫£i JSON). Vui l√≤ng th·ª≠ l·∫°i sau.");
            }

            if (result.choices && result.choices.length > 0 && result.choices[0].message) {
                const jsonString = result.choices[0].message.content;
                try {
                    return JSON.parse(jsonString);
                } catch (parseError) {
                    throw new Error("Ph·∫£n h·ªìi t·ª´ AI kh√¥ng ƒë√∫ng c·∫•u tr√∫c y√™u c·∫ßu.");
                }
            } else {
                throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ m√°y ch·ªß AI.");
            }
        }

        function displayMeetingInfo(meetingData) {
            extractedInfoDiv.innerHTML = `<pre class="whitespace-pre-wrap">${JSON.stringify(meetingData, null, 2)}</pre>`;
            extractedInfoSection.classList.remove('hidden');
        }

        function generateIcsFile(meetingData) {
            const subjectRaw = meetingData["Ch·ªß ƒë·ªÅ cu·ªôc h·ªçp"] || "Cu·ªôc h·ªçp";
            const location = meetingData["ƒê·ªãa ƒëi·ªÉm h·ªçp"] || "Ch∆∞a r√µ ‚Äì c·∫ßn x√°c minh";
            const attendees = meetingData["Th√†nh ph·∫ßn tham d·ª±"] || [];
            const mainContent = meetingData["N·ªôi dung l√†m vi·ªác ch√≠nh"] || "";
            const organizer = meetingData["ƒê∆°n v·ªã ch·ªß tr√¨ ho·∫∑c t·ªï ch·ª©c th·ª±c hi·ªán"] || "";
            const chair = meetingData["Ng∆∞·ªùi ch·ªß tr√¨ cu·ªôc h·ªçp"] || "";
            const onlineLink = meetingData["ƒê∆∞·ªùng d·∫´n h·ªçp tr·ª±c tuy·∫øn (Zoom/Teams/Meet)"] || "";
            const reminder = meetingData["Y√™u c·∫ßu nh·∫Øc l·ªãch tr∆∞·ªõc"] || "1 NG√ÄY";

            let startTime = null;
            let endTime = null;
            let timeWarning = "";

            // ƒê·∫£m b·∫£o an to√†n ki·ªÉu d·ªØ li·ªáu v√† ƒë·ªïi kho·∫£ng tr·∫Øng th√†nh ch·ªØ T theo chu·∫©n ISO ƒë·ªÉ tr√¨nh duy·ªát d·ªÖ ƒë·ªçc
            let startStr = String(meetingData["Th·ªùi gian b·∫Øt ƒë·∫ßu"] || "").trim().replace(' ', 'T');
            startTime = new Date(startStr);

            // X·ª≠ l√Ω ngo·∫°i l·ªá: N·∫øu AI kh√¥ng t√¨m th·∫•y th·ªùi gian ho·∫∑c tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng l·∫° ("Ch∆∞a r√µ")
            if (isNaN(startTime.getTime())) {
                startTime = new Date();
                startTime.setDate(startTime.getDate() + 1); // M·∫∑c ƒë·ªãnh l√† ng√†y mai
                startTime.setHours(8, 0, 0, 0); // 8:00 S√°ng
                timeWarning = "\\n‚ö†Ô∏è L∆ØU √ù: AI kh√¥ng ƒë·ªçc ƒë∆∞·ª£c th·ªùi gian ch√≠nh x√°c t·ª´ t√†i li·ªáu. H·ªá th·ªëng t·ª± ƒë·ªông ƒë·∫∑t l·ªãch t·∫°m v√†o 8:00 s√°ng ng√†y mai. B·∫°n h√£y t·ª± ƒëi·ªÅu ch·ªânh l·∫°i gi·ªù nh√©!";
            }

            let endStr = String(meetingData["Th·ªùi gian k·∫øt th√∫c"] || "").trim().replace(' ', 'T');
            endTime = new Date(endStr);

            if (isNaN(endTime.getTime())) {
                endTime = new Date(startTime.getTime() + 2 * 60 * 60 * 1000); // M·∫∑c ƒë·ªãnh k√©o d√†i 2 ti·∫øng
            }

            const formatIcsDateTime = (date) => {
                const pad = n => String(n).padStart(2, '0');
                return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}T${pad(date.getHours())}${pad(date.getMinutes())}${pad(date.getSeconds())}`;
            };

            const dtStartIcs = formatIcsDateTime(startTime);
            const dtEndIcs = formatIcsDateTime(endTime);
            const dtStampIcs = formatIcsDateTime(new Date());
            const uid = `${dtStampIcs}-${Math.random().toString(36).substring(2, 15)}@meeting-secretary`;

            let descriptionParts = [];
            if (mainContent) {
                descriptionParts.push('üìå N·ªôi dung l√†m vi·ªác:');
                descriptionParts.push(mainContent.split('\n').map(line => `- ${line.trim()}`).join('\\n'));
            } else {
                descriptionParts.push('üìå N·ªôi dung l√†m vi·ªác:\\n- Kh√¥ng c√≥ n·ªôi dung ch√≠nh.');
            }
            descriptionParts.push(`\\nüë§ Ch·ªß tr√¨: ${chair || 'Ch∆∞a r√µ'}`);
            descriptionParts.push(`\\nüë• Th√†nh ph·∫ßn:`);
            if (attendees.length > 0) descriptionParts.push(attendees.map(att => `- ${att.trim()}`).join('\\n'));
            else descriptionParts.push(`- Kh√¥ng c√≥ th√†nh ph·∫ßn c·ª• th·ªÉ.`);
            descriptionParts.push(`\\nüè¢ ƒê∆°n v·ªã t·ªï ch·ª©c: ${organizer || 'Ch∆∞a r√µ'}`);
            if (onlineLink) descriptionParts.push(`\\nƒê∆∞·ªùng d·∫´n tr·ª±c tuy·∫øn: ${onlineLink}`);
            descriptionParts.push(`\\nƒê·ªãa ƒëi·ªÉm: ${location}`);
            
            // Ghi l·∫°i th·ªùi gian g·ªëc m√† AI ƒë·ªçc ƒë∆∞·ª£c ƒë·ªÉ ng∆∞·ªùi d√πng ƒë·ªëi chi·∫øu
            descriptionParts.push(`Th·ªùi gian g·ªëc theo t√†i li·ªáu: T·ª´ ${meetingData["Th·ªùi gian b·∫Øt ƒë·∫ßu"] || 'Kh√¥ng r√µ'} ƒë·∫øn ${meetingData["Th·ªùi gian k·∫øt th√∫c"] || 'Kh√¥ng r√µ'}`);
            
            // Ch√®n c·∫£nh b√°o n·∫øu ph·∫£i d√πng th·ªùi gian m∆∞·ª£n t·∫°m
            if (timeWarning) {
                descriptionParts.push(timeWarning);
            }

            const icsDescription = descriptionParts.join('\\n');

            let alarmTrigger = '-P1D';
            const reminderMatch = reminder.match(/(\d+)\s*(NG√ÄY|GI·ªú|PH√öT)/i);
            if (reminderMatch) {
                const val = parseInt(reminderMatch[1]);
                const unit = reminderMatch[2].toUpperCase();
                if (unit === 'NG√ÄY') alarmTrigger = `-P${val}D`;
                else if (unit === 'GI·ªú') alarmTrigger = `-PT${val}H`;
                else if (unit === 'PH√öT') alarmTrigger = `-PT${val}M`;
            }

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Meeting Secretary App//NONSGML v1.0//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VTIMEZONE
TZID:Asia/Ho_Chi_Minh
X-LIC-LOCATION:Asia/Ho_Chi_Minh
BEGIN:STANDARD
TZOFFSETFROM:+0700
TZOFFSETTO:+0700
TZNAME:ICT
DTSTART:19700101T000000
END:STANDARD
END:VTIMEZONE
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtStampIcs}
DTSTART;TZID=Asia/Ho_Chi_Minh:${dtStartIcs}
DTEND;TZID=Asia/Ho_Chi_Minh:${dtEndIcs}
SUMMARY:${subjectRaw}
LOCATION:${location}
DESCRIPTION:${icsDescription}
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Nh·∫Øc nh·ªü cu·ªôc h·ªçp: ${subjectRaw}
TRIGGER:${alarmTrigger}
END:VALARM
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            downloadIcsLink.href = url;
            downloadIcsLink.download = `${subjectRaw.replace(/[^a-z0-9]/gi, '_')}.ics`;
            downloadIcsLink.style.display = 'flex';
        }

        function showError(message) {
            errorTextP.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        function hideError() {
            errorMessageDiv.classList.add('hidden');
            errorTextP.textContent = '';
        }

        function hideResults() {
            extractedInfoSection.classList.add('hidden');
            extractedInfoDiv.innerHTML = '';
            downloadIcsLink.style.display = 'none';
        }

        hideResults();
        hideError();
    </script>
</body>
</html>
